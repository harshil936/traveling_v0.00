import { core } from './core';
import { MetadataStore, EntityType, ComplexType, DataProperty, NavigationProperty, AutoGeneratedKeyType } from './entity-metadata';
import { DataType } from './data-type';
import { Validator } from './validate';
function parse(metadataStore, schemas, altMetadata) {
    metadataStore._entityTypeResourceMap = {};
    schemas = core.toArray(schemas);
    schemas.forEach(function (schema) {
        if (schema.cSpaceOSpaceMapping) {
            // Web api only - not avail in OData.
            // TODO throw informative error if already parsed and converted to map on a previous pass
            let mappings = JSON.parse(schema.cSpaceOSpaceMapping);
            let newMap = {};
            mappings.forEach(function (mapping) {
                newMap[mapping[0]] = mapping[1];
            });
            schema.cSpaceOSpaceMapping = newMap;
        }
        if (schema.entityContainer) {
            core.toArray(schema.entityContainer).forEach(function (container) {
                core.toArray(container.entitySet).forEach(function (entitySet) {
                    let entityTypeName = parseTypeNameWithSchema(entitySet.entityType, schema).typeName;
                    metadataStore.setEntityTypeForResourceName(entitySet.name, entityTypeName);
                    metadataStore._entityTypeResourceMap[entityTypeName] = entitySet.name;
                });
            });
        }
        // process complextypes before entity types.
        if (schema.complexType) {
            core.toArray(schema.complexType).forEach(function (ct) {
                parseCsdlComplexType(ct, schema, metadataStore);
            });
        }
        if (schema.entityType) {
            core.toArray(schema.entityType).forEach(function (et) {
                parseCsdlEntityType(et, schema, schemas, metadataStore);
            });
        }
    });
    let badNavProps = metadataStore.getIncompleteNavigationProperties();
    if (badNavProps.length > 0) {
        let msg = badNavProps.map(function (npa) {
            if (Array.isArray(npa)) {
                return npa.map(function (np) {
                    return np.parentType.name + ":" + np.name;
                }).join(', ');
            }
            return npa.parentType.name + ":" + npa.name;
        }).join(', ');
        throw new Error("Incomplete navigation properties: " + msg);
    }
    if (altMetadata) {
        metadataStore.importMetadata(altMetadata, true);
    }
    return metadataStore;
}
function parseCsdlEntityType(csdlEntityType, schema, schemas, metadataStore) {
    let shortName = csdlEntityType.name;
    let ns = getNamespaceFor(shortName, schema);
    let entityType = new EntityType({
        shortName: shortName,
        namespace: ns,
        isAbstract: csdlEntityType.abstract && csdlEntityType.abstract === 'true'
    });
    if (csdlEntityType.baseType) {
        let baseTypeName = parseTypeNameWithSchema(csdlEntityType.baseType, schema).typeName;
        entityType.baseTypeName = baseTypeName;
        let baseEntityType = metadataStore._getStructuralType(baseTypeName, true);
        if (baseEntityType) {
            completeParseCsdlEntityType(entityType, csdlEntityType, schema, schemas, metadataStore);
        }
        else {
            let deferrals = metadataStore._deferredTypes[baseTypeName];
            if (!deferrals) {
                deferrals = [];
                metadataStore._deferredTypes[baseTypeName] = deferrals;
            }
            deferrals.push({ entityType: entityType, csdlEntityType: csdlEntityType });
        }
    }
    else {
        completeParseCsdlEntityType(entityType, csdlEntityType, schema, schemas, metadataStore);
    }
    // entityType may or may not have been added to the metadataStore at this point.
    return entityType;
}
function completeParseCsdlEntityType(entityType, csdlEntityType, schema, schemas, metadataStore) {
    let keyNamesOnServer = csdlEntityType.key ? core.toArray(csdlEntityType.key.propertyRef).map(core.pluck("name")) : [];
    core.toArray(csdlEntityType.property).forEach(function (prop) {
        parseCsdlDataProperty(entityType, prop, schema, keyNamesOnServer);
    });
    core.toArray(csdlEntityType.navigationProperty).forEach(function (prop) {
        parseCsdlNavProperty(entityType, prop, schema, schemas);
    });
    metadataStore.addEntityType(entityType);
    entityType.defaultResourceName = metadataStore._entityTypeResourceMap[entityType.name];
    let deferredTypes = metadataStore._deferredTypes;
    let deferrals = deferredTypes[entityType.name];
    if (deferrals) {
        deferrals.forEach(function (d) {
            completeParseCsdlEntityType(d.entityType, d.csdlEntityType, schema, schemas, metadataStore);
        });
        delete deferredTypes[entityType.name];
    }
}
function parseCsdlComplexType(csdlComplexType, schema, metadataStore) {
    let shortName = csdlComplexType.name;
    let ns = getNamespaceFor(shortName, schema);
    let complexType = new ComplexType({
        shortName: shortName,
        namespace: ns
    });
    core.toArray(csdlComplexType.property).forEach(function (prop) {
        parseCsdlDataProperty(complexType, prop, schema);
    });
    metadataStore.addEntityType(complexType);
    return complexType;
}
function parseCsdlDataProperty(parentType, csdlProperty, schema, keyNamesOnServer) {
    let dp;
    let typeParts = csdlProperty.type.split(".");
    // Both tests on typeParts are necessary because of differing metadata conventions for OData and Edmx feeds.
    if (typeParts[0] === "Edm" && typeParts.length === 2) {
        dp = parseCsdlSimpleProperty(parentType, csdlProperty, keyNamesOnServer);
    }
    else {
        if (isEnumType(csdlProperty, schema)) {
            dp = parseCsdlSimpleProperty(parentType, csdlProperty, keyNamesOnServer);
            if (dp) {
                dp.enumType = csdlProperty.type;
            }
        }
        else {
            dp = parseCsdlComplexProperty(parentType, csdlProperty, schema);
        }
    }
    if (dp) {
        parentType._addPropertyCore(dp);
        addValidators(dp);
    }
    return dp;
}
function parseCsdlSimpleProperty(parentType, csdlProperty, keyNamesOnServer) {
    let dataType = DataType.fromEdmDataType(csdlProperty.type);
    if (dataType == null) {
        parentType.warnings.push("Unable to recognize DataType for property: " + csdlProperty.name + " DateType: " + csdlProperty.type);
        return undefined;
    }
    let isNullable = csdlProperty.nullable === 'true' || csdlProperty.nullable == null;
    // let fixedLength = csdlProperty.fixedLength ? csdlProperty.fixedLength === true : undefined;
    let isPartOfKey = keyNamesOnServer != null && keyNamesOnServer.indexOf(csdlProperty.name) >= 0;
    if (isPartOfKey && parentType instanceof EntityType && parentType.autoGeneratedKeyType === AutoGeneratedKeyType.None) {
        if (isIdentityProperty(csdlProperty)) {
            parentType.autoGeneratedKeyType = AutoGeneratedKeyType.Identity;
        }
    }
    // TODO: nit - don't set maxLength if null;
    let maxLength = csdlProperty.maxLength;
    maxLength = (maxLength == null || maxLength === "Max") ? null : parseInt(maxLength, 10);
    // can't set the name until we go thru namingConventions and these need the dp.
    let dp = new DataProperty({
        nameOnServer: csdlProperty.name,
        dataType: dataType,
        isNullable: isNullable,
        isPartOfKey: isPartOfKey,
        maxLength: maxLength,
        defaultValue: csdlProperty.defaultValue,
        // fixedLength: fixedLength,
        concurrencyMode: csdlProperty.concurrencyMode
    });
    if (dataType === DataType.Undefined) {
        dp.rawTypeName = csdlProperty.type;
    }
    return dp;
}
function parseCsdlComplexProperty(parentType, csdlProperty, schema) {
    // Complex properties are never nullable ( per EF specs)
    // let isNullable = csdlProperty.nullable === 'true' || csdlProperty.nullable == null;
    // let complexTypeName = csdlProperty.type.split("Edm.")[1];
    let complexTypeName = parseTypeNameWithSchema(csdlProperty.type, schema).typeName;
    // can't set the name until we go thru namingConventions and these need the dp.
    let dp = new DataProperty({
        nameOnServer: csdlProperty.name,
        complexTypeName: complexTypeName,
        isNullable: false
    });
    return dp;
}
function parseCsdlNavProperty(entityType, csdlProperty, schema, schemas) {
    let association = getAssociation(csdlProperty, schema, schemas);
    if (!association) {
        throw new Error("Unable to resolve Foreign Key Association: " + csdlProperty.relationship);
    }
    let toEnd = core.arrayFirst(association.end, (assocEnd) => {
        return assocEnd.role === csdlProperty.toRole;
    });
    let isScalar = toEnd.multiplicity !== "*";
    let dataType = parseTypeNameWithSchema(toEnd.type, schema).typeName;
    let constraint = association.referentialConstraint;
    if (!constraint) {
        // TODO: Revisit this later - right now we just ignore many-many and assocs with missing constraints.
        // Think about adding this back later.
        if (association.end[0].multiplicity === "*" && association.end[1].multiplicity === "*") {
            // ignore many to many relations for now
            return;
        }
        else {
            // For now assume it will be set later directly on the client.
            // other alternative is to throw an error:
            // throw new Error("Foreign Key Associations must be turned on for this model");
        }
    }
    let cfg = {
        nameOnServer: csdlProperty.name,
        entityTypeName: dataType,
        isScalar: isScalar,
        associationName: association.name,
    };
    if (constraint) {
        let principal = constraint.principal;
        let dependent = constraint.dependent;
        let propRefs = core.toArray(dependent.propertyRef);
        let fkNames = propRefs.map(core.pluck("name"));
        if (csdlProperty.fromRole === principal.role) {
            cfg.invForeignKeyNamesOnServer = fkNames;
        }
        else {
            // will be used later by np._update
            cfg.foreignKeyNamesOnServer = fkNames;
        }
    }
    let np = new NavigationProperty(cfg);
    entityType._addPropertyCore(np);
    return np;
}
function isEnumType(csdlProperty, schema) {
    if (schema.enumType)
        return isEdmxEnumType(csdlProperty, schema);
    else if (schema.extensions)
        return isODataEnumType(csdlProperty, schema);
    else
        return false;
}
function isEdmxEnumType(csdlProperty, schema) {
    let enumTypes = core.toArray(schema.enumType);
    let typeParts = csdlProperty.type.split(".");
    let baseTypeName = typeParts[typeParts.length - 1];
    return enumTypes.some(function (enumType) {
        return enumType.name === baseTypeName;
    });
}
function isODataEnumType(csdlProperty, schema) {
    let enumTypes = schema.extensions.filter((ext) => {
        return ext.name === "EnumType";
    });
    let typeParts = csdlProperty.type.split(".");
    let baseTypeName = typeParts[typeParts.length - 1];
    return enumTypes.some((enumType) => {
        return enumType.attributes.some((attr) => {
            return attr.name === "Name" && attr.value === baseTypeName;
        });
    });
}
function addValidators(dataProperty) {
    let typeValidator;
    if (!dataProperty.isNullable) {
        dataProperty.validators.push(Validator.required());
    }
    if (dataProperty.isComplexProperty)
        return;
    if (dataProperty.dataType === DataType.String) {
        if (dataProperty.maxLength) {
            let validatorArgs = { maxLength: dataProperty.maxLength };
            typeValidator = Validator.maxLength(validatorArgs);
        }
        else {
            typeValidator = Validator.string();
        }
    }
    else {
        let validatorCtor = dataProperty.dataType.validatorCtor;
        if (!validatorCtor)
            return;
        typeValidator = validatorCtor();
    }
    dataProperty.validators.push(typeValidator);
}
function isIdentityProperty(csdlProperty) {
    // see if web api feed
    let propName = core.arrayFirst(Object.keys(csdlProperty), (pn) => {
        return pn.indexOf("StoreGeneratedPattern") >= 0;
    });
    if (propName) {
        return (csdlProperty[propName] === "Identity");
    }
    else {
        // see if Odata feed
        let extensions = csdlProperty.extensions;
        if (!extensions) {
            return false;
        }
        let identityExtn = core.arrayFirst(extensions, (extension) => {
            return extension.name === "StoreGeneratedPattern" && extension.value === "Identity";
        });
        return !!identityExtn;
    }
}
// Fast version
// np: schema.entityType[].navigationProperty.relationship -> schema.association
//   match( shortName(np.relationship) == schema.association[].name
//      --> association__
// Correct version
// np: schema.entityType[].navigationProperty.relationship -> schema.association
//   match( np.relationship == schema.entityContainer[0].associationSet[].association )
//      -> associationSet.name
//   match ( associationSet.name == schema.association[].name )
//      -> association
function getAssociation(csdlNavProperty, containingSchema, schemas) {
    let assocFullName = parseTypeNameWithSchema(csdlNavProperty.relationship, containingSchema);
    let assocNamespace = assocFullName.namespace;
    let assocSchema = core.arrayFirst(schemas, (schema) => {
        return schema.namespace === assocNamespace;
    });
    if (!assocSchema)
        return null;
    let assocName = assocFullName.shortTypeName;
    let assocs = assocSchema.association;
    if (!assocs)
        return null;
    if (!Array.isArray(assocs)) {
        assocs = [assocs];
    }
    let association = core.arrayFirst(assocs, (assoc) => {
        return assoc.name === assocName;
    });
    return association;
}
// schema is only needed for navProperty type name
function parseTypeNameWithSchema(entityTypeName, schema) {
    let result = MetadataStore.parseTypeName(entityTypeName);
    if (schema && schema.cSpaceOSpaceMapping) {
        let ns = getNamespaceFor(result.shortTypeName, schema);
        if (ns) {
            result = MetadataStore.makeTypeHash(result.shortTypeName, ns);
        }
    }
    return result;
}
function getNamespaceFor(shortName, schema) {
    let ns;
    let mapping = schema.cSpaceOSpaceMapping;
    if (mapping) {
        let fullName = mapping[schema.namespace + "." + shortName];
        ns = fullName && fullName.substr(0, fullName.length - (shortName.length + 1));
        if (ns)
            return ns;
    }
    // if schema does not also have an entityType node then
    // this is an WebApi2 OData schema which is usually equal to 'Default'; which is useless.
    if (schema.entityType || schema.namespace !== 'Default') {
        return schema.namespace;
    }
    return null;
}
/** @hidden @internal */
export const CsdlMetadataParser = {
    parse: parse
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY3NkbC1tZXRhZGF0YS1wYXJzZXIuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9icmVlemUtY2xpZW50LyIsInNvdXJjZXMiOlsic3JjL2NzZGwtbWV0YWRhdGEtcGFyc2VyLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBRSxJQUFJLEVBQUUsTUFBTSxRQUFRLENBQUM7QUFDOUIsT0FBTyxFQUFFLGFBQWEsRUFBRSxVQUFVLEVBQUUsV0FBVyxFQUFFLFlBQVksRUFBRSxrQkFBa0IsRUFBRSxvQkFBb0IsRUFBRSxNQUFNLG1CQUFtQixDQUFDO0FBQ25JLE9BQU8sRUFBRSxRQUFRLEVBQUcsTUFBTSxhQUFhLENBQUM7QUFDeEMsT0FBTyxFQUFFLFNBQVMsRUFBRSxNQUFNLFlBQVksQ0FBQztBQWN2QyxTQUFTLEtBQUssQ0FBQyxhQUE0QixFQUFFLE9BQVksRUFBRSxXQUFnQjtJQUV6RSxhQUFhLENBQUMsc0JBQXNCLEdBQUcsRUFBRSxDQUFDO0lBQzFDLE9BQU8sR0FBRyxJQUFJLENBQUMsT0FBTyxDQUFDLE9BQU8sQ0FBQyxDQUFDO0lBQ2hDLE9BQU8sQ0FBQyxPQUFPLENBQUMsVUFBVSxNQUFXO1FBQ25DLElBQUksTUFBTSxDQUFDLG1CQUFtQixFQUFFO1lBQzlCLHFDQUFxQztZQUNyQyx5RkFBeUY7WUFDekYsSUFBSSxRQUFRLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQyxNQUFNLENBQUMsbUJBQW1CLENBQUMsQ0FBQztZQUN0RCxJQUFJLE1BQU0sR0FBRyxFQUFFLENBQUM7WUFDaEIsUUFBUSxDQUFDLE9BQU8sQ0FBQyxVQUFVLE9BQVk7Z0JBQ3JDLE1BQU0sQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDLENBQUMsR0FBRyxPQUFPLENBQUMsQ0FBQyxDQUFDLENBQUM7WUFDbEMsQ0FBQyxDQUFDLENBQUM7WUFDSCxNQUFNLENBQUMsbUJBQW1CLEdBQUcsTUFBTSxDQUFDO1NBQ3JDO1FBRUQsSUFBSSxNQUFNLENBQUMsZUFBZSxFQUFFO1lB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a0JBQWtCLEdBQUc7SUFDaEMsS0FBSyxFQUFFLEtBQUs7Q0FDYixDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgY29yZSB9IGZyb20gJy4vY29yZSc7XHJcbmltcG9ydCB7IE1ldGFkYXRhU3RvcmUsIEVudGl0eVR5cGUsIENvbXBsZXhUeXBlLCBEYXRhUHJvcGVydHksIE5hdmlnYXRpb25Qcm9wZXJ0eSwgQXV0b0dlbmVyYXRlZEtleVR5cGUgfSBmcm9tICcuL2VudGl0eS1tZXRhZGF0YSc7XHJcbmltcG9ydCB7IERhdGFUeXBlICB9IGZyb20gJy4vZGF0YS10eXBlJztcclxuaW1wb3J0IHsgVmFsaWRhdG9yIH0gZnJvbSAnLi92YWxpZGF0ZSc7XHJcblxyXG5pbnRlcmZhY2UgSUFzc29jaWF0aW9uIHtcclxuICBuYW1lOiBzdHJpbmc7XHJcbiAgZW5kOiBJRW5kW107XHJcbiAgcmVmZXJlbnRpYWxDb25zdHJhaW50OiBhbnk7XHJcbn1cclxuXHJcbmludGVyZmFjZSBJRW5kIHtcclxuICBtdWx0aXBsaWNpdHk6IHN0cmluZztcclxuICB0eXBlOiBzdHJpbmc7XHJcbiAgcm9sZTogc3RyaW5nO1xyXG59XHJcblxyXG5mdW5jdGlvbiBwYXJzZShtZXRhZGF0YVN0b3JlOiBNZXRhZGF0YVN0b3JlLCBzY2hlbWFzOiBhbnksIGFsdE1ldGFkYXRhOiBhbnkpIHtcclxuXHJcbiAgbWV0YWRhdGFTdG9yZS5fZW50aXR5VHlwZVJlc291cmNlTWFwID0ge307XHJcbiAgc2NoZW1hcyA9IGNvcmUudG9BcnJheShzY2hlbWFzKTtcclxuICBzY2hlbWFzLmZvckVhY2goZnVuY3Rpb24gKHNjaGVtYTogYW55KSB7XHJcbiAgICBpZiAoc2NoZW1hLmNTcGFjZU9TcGFjZU1hcHBpbmcpIHtcclxuICAgICAgLy8gV2ViIGFwaSBvbmx5IC0gbm90IGF2YWlsIGluIE9EYXRhLlxyXG4gICAgICAvLyBUT0RPIHRocm93IGluZm9ybWF0aXZlIGVycm9yIGlmIGFscmVhZHkgcGFyc2VkIGFuZCBjb252ZXJ0ZWQgdG8gbWFwIG9uIGEgcHJldmlvdXMgcGFzc1xyXG4gICAgICBsZXQgbWFwcGluZ3MgPSBKU09OLnBhcnNlKHNjaGVtYS5jU3BhY2VPU3BhY2VNYXBwaW5nKTtcclxuICAgICAgbGV0IG5ld01hcCA9IHt9O1xyXG4gICAgICBtYXBwaW5ncy5mb3JFYWNoKGZ1bmN0aW9uIChtYXBwaW5nOiBhbnkpIHtcclxuICAgICAgICBuZXdNYXBbbWFwcGluZ1swXV0gPSBtYXBwaW5nWzFdO1xyXG4gICAgICB9KTtcclxuICAgICAgc2NoZW1hLmNTcGFjZU9TcGFjZU1hcHBpbmcgPSBuZXdNYXA7XHJcbiAgICB9XHJcblxyXG4gICAgaWYgKHNjaGVtYS5lbnRpdHlDb250YWluZXIpIHtcclxuICAgICAgY29yZS50b0FycmF5KHNjaGVtYS5lbnRpdHlDb250YWluZXIpLmZvckVhY2goZnVuY3Rpb24gKGNvbnRhaW5lcikge1xyXG4gICAgICAgIGNvcmUudG9BcnJheShjb250YWluZXIuZW50aXR5U2V0KS5mb3JFYWNoKGZ1bmN0aW9uIChlbnRpdHlTZXQpIHtcclxuICAgICAgICAgIGxldCBlbnRpdHlUeXBlTmFtZSA9IHBhcnNlVHlwZU5hbWVXaXRoU2NoZW1hKGVudGl0eVNldC5lbnRpdHlUeXBlLCBzY2hlbWEpLnR5cGVOYW1lO1xyXG4gICAgICAgICAgbWV0YWRhdGFTdG9yZS5zZXRFbnRpdHlUeXBlRm9yUmVzb3VyY2VOYW1lKGVudGl0eVNldC5uYW1lLCBlbnRpdHlUeXBlTmFtZSk7XHJcbiAgICAgICAgICBtZXRhZGF0YVN0b3JlLl9lbnRpdHlUeXBlUmVzb3VyY2VNYXBbZW50aXR5VHlwZU5hbWVdID0gZW50aXR5U2V0Lm5hbWU7XHJcbiAgICAgICAgfSk7XHJcbiAgICAgIH0pO1xyXG4gICAgfVxyXG5cclxuICAgIC8vIHByb2Nlc3MgY29tcGxleHR5cGVzIGJlZm9yZSBlbnRpdHkgdHlwZXMuXHJcbiAgICBpZiAoc2NoZW1hLmNvbXBsZXhUeXBlKSB7XHJcbiAgICAgIGNvcmUudG9BcnJheShzY2hlbWEuY29tcGxleFR5cGUpLmZvckVhY2goZnVuY3Rpb24gKGN0KSB7XHJcbiAgICAgICAgcGFyc2VDc2RsQ29tcGxleFR5cGUoY3QsIHNjaGVtYSwgbWV0YWRhdGFTdG9yZSk7XHJcbiAgICAgIH0pO1xyXG4gICAgfVxyXG4gICAgaWYgKHNjaGVtYS5lbnRpdHlUeXBlKSB7XHJcbiAgICAgIGNvcmUudG9BcnJheShzY2hlbWEuZW50aXR5VHlwZSkuZm9yRWFjaChmdW5jdGlvbiAoZXQpIHtcclxuICAgICAgICBwYXJzZUNzZGxFbnRpdHlUeXBlKGV0LCBzY2hlbWEsIHNjaGVtYXMsIG1ldGFkYXRhU3RvcmUpO1xyXG5cclxuICAgICAgfSk7XHJcbiAgICB9XHJcblxyXG4gIH0pO1xyXG4gIGxldCBiYWROYXZQcm9wcyA9IG1ldGFkYXRhU3RvcmUuZ2V0SW5jb21wbGV0ZU5hdmlnYXRpb25Qcm9wZXJ0aWVzKCk7XHJcbiAgaWYgKGJhZE5hdlByb3BzLmxlbmd0aCA+IDApIHtcclxuICAgIGxldCBtc2cgPSBiYWROYXZQcm9wcy5tYXAoZnVuY3Rpb24gKG5wYSkge1xyXG4gICAgICBpZiAoQXJyYXkuaXNBcnJheShucGEpKSB7XHJcbiAgICAgICAgcmV0dXJuIG5wYS5tYXAoZnVuY3Rpb24gKG5wKSB7XHJcbiAgICAgICAgICByZXR1cm4gbnAucGFyZW50VHlwZS5uYW1lICsgXCI6XCIgKyBucC5uYW1lO1xyXG4gICAgICAgIH0pLmpvaW4oJywgJyk7XHJcbiAgICAgIH1cclxuICAgICAgcmV0dXJuIG5wYS5wYXJlbnRUeXBlLm5hbWUgKyBcIjpcIiArIG5wYS5uYW1lO1xyXG4gICAgfSkuam9pbignLCAnKTtcclxuICAgIHRocm93IG5ldyBFcnJvcihcIkluY29tcGxldGUgbmF2aWdhdGlvbiBwcm9wZXJ0aWVzOiBcIiArIG1zZyk7XHJcbiAgfVxyXG4gIGlmIChhbHRNZXRhZGF0YSkge1xyXG4gICAgbWV0YWRhdGFTdG9yZS5pbXBvcnRNZXRhZGF0YShhbHRNZXRhZGF0YSwgdHJ1ZSk7XHJcbiAgfVxyXG4gIHJldHVybiBtZXRhZGF0YVN0b3JlO1xyXG59XHJcblxyXG5mdW5jdGlvbiBwYXJzZUNzZGxFbnRpdHlUeXBlKGNzZGxFbnRpdHlUeXBlOiBhbnksIHNjaGVtYTogYW55LCBzY2hlbWFzOiBhbnksIG1ldGFkYXRhU3RvcmU6IE1ldGFkYXRhU3RvcmUpIHtcclxuICBsZXQgc2hvcnROYW1lID0gY3NkbEVudGl0eVR5cGUubmFtZTtcclxuICBsZXQgbnMgPSBnZXROYW1lc3BhY2VGb3Ioc2hvcnROYW1lLCBzY2hlbWEpO1xyXG4gIGxldCBlbnRpdHlUeXBlID0gbmV3IEVudGl0eVR5cGUoe1xyXG4gICAgc2hvcnROYW1lOiBzaG9ydE5hbWUsXHJcbiAgICBuYW1lc3BhY2U6IG5zLFxyXG4gICAgaXNBYnN0cmFjdDogY3NkbEVudGl0eVR5cGUuYWJzdHJhY3QgJiYgY3NkbEVudGl0eVR5cGUuYWJzdHJhY3QgPT09ICd0cnVlJ1xyXG4gIH0pO1xyXG4gIGlmIChjc2RsRW50aXR5VHlwZS5iYXNlVHlwZSkge1xyXG4gICAgbGV0IGJhc2VUeXBlTmFtZSA9IHBhcnNlVHlwZU5hbWVXaXRoU2NoZW1hKGNzZGxFbnRpdHlUeXBlLmJhc2VUeXBlLCBzY2hlbWEpLnR5cGVOYW1lO1xyXG4gICAgZW50aXR5VHlwZS5iYXNlVHlwZU5hbWUgPSBiYXNlVHlwZU5hbWU7XHJcbiAgICBsZXQgYmFzZUVudGl0eVR5cGUgPSBtZXRhZGF0YVN0b3JlLl9nZXRTdHJ1Y3R1cmFsVHlwZShiYXNlVHlwZU5hbWUsIHRydWUpO1xyXG4gICAgaWYgKGJhc2VFbnRpdHlUeXBlKSB7XHJcbiAgICAgIGNvbXBsZXRlUGFyc2VDc2RsRW50aXR5VHlwZShlbnRpdHlUeXBlLCBjc2RsRW50aXR5VHlwZSwgc2NoZW1hLCBzY2hlbWFzLCBtZXRhZGF0YVN0b3JlKTtcclxuICAgIH0gZWxzZSB7XHJcbiAgICAgIGxldCBkZWZlcnJhbHMgPSBtZXRhZGF0YVN0b3JlLl9kZWZlcnJlZFR5cGVzW2Jhc2VUeXBlTmFtZV07XHJcbiAgICAgIGlmICghZGVmZXJyYWxzKSB7XHJcbiAgICAgICAgZGVmZXJyYWxzID0gW107XHJcbiAgICAgICAgbWV0YWRhdGFTdG9yZS5fZGVmZXJyZWRUeXBlc1tiYXNlVHlwZU5hbWVdID0gZGVmZXJyYWxzO1xyXG4gICAgICB9XHJcbiAgICAgIGRlZmVycmFscy5wdXNoKHsgZW50aXR5VHlwZTogZW50aXR5VHlwZSwgY3NkbEVudGl0eVR5cGU6IGNzZGxFbnRpdHlUeXBlIH0pO1xyXG4gICAgfVxyXG4gIH0gZWxzZSB7XHJcbiAgICBjb21wbGV0ZVBhcnNlQ3NkbEVudGl0eVR5cGUoZW50aXR5VHlwZSwgY3NkbEVudGl0eVR5cGUsIHNjaGVtYSwgc2NoZW1hcywgbWV0YWRhdGFTdG9yZSk7XHJcbiAgfVxyXG4gIC8vIGVudGl0eVR5cGUgbWF5IG9yIG1heSBub3QgaGF2ZSBiZWVuIGFkZGVkIHRvIHRoZSBtZXRhZGF0YVN0b3JlIGF0IHRoaXMgcG9pbnQuXHJcbiAgcmV0dXJuIGVudGl0eVR5cGU7XHJcblxyXG59XHJcblxyXG5mdW5jdGlvbiBjb21wbGV0ZVBhcnNlQ3NkbEVudGl0eVR5cGUoZW50aXR5VHlwZTogRW50aXR5VHlwZSwgY3NkbEVudGl0eVR5cGU6IGFueSwgc2NoZW1hOiBhbnksIHNjaGVtYXM6IGFueSwgbWV0YWRhdGFTdG9yZTogTWV0YWRhdGFTdG9yZSkge1xyXG4gIGxldCBrZXlOYW1lc09uU2VydmVyID0gY3NkbEVudGl0eVR5cGUua2V5ID8gY29yZS50b0FycmF5KGNzZGxFbnRpdHlUeXBlLmtleS5wcm9wZXJ0eVJlZikubWFwKGNvcmUucGx1Y2soXCJuYW1lXCIpKSA6IFtdO1xyXG5cclxuICBjb3JlLnRvQXJyYXkoY3NkbEVudGl0eVR5cGUucHJvcGVydHkpLmZvckVhY2goZnVuY3Rpb24gKHByb3ApIHtcclxuICAgIHBhcnNlQ3NkbERhdGFQcm9wZXJ0eShlbnRpdHlUeXBlLCBwcm9wLCBzY2hlbWEsIGtleU5hbWVzT25TZXJ2ZXIpO1xyXG4gIH0pO1xyXG5cclxuICBjb3JlLnRvQXJyYXkoY3NkbEVudGl0eVR5cGUubmF2aWdhdGlvblByb3BlcnR5KS5mb3JFYWNoKGZ1bmN0aW9uIChwcm9wKSB7XHJcbiAgICBwYXJzZUNzZGxOYXZQcm9wZXJ0eShlbnRpdHlUeXBlLCBwcm9wLCBzY2hlbWEsIHNjaGVtYXMpO1xyXG4gIH0pO1xyXG5cclxuICBtZXRhZGF0YVN0b3JlLmFkZEVudGl0eVR5cGUoZW50aXR5VHlwZSk7XHJcbiAgZW50aXR5VHlwZS5kZWZhdWx0UmVzb3VyY2VOYW1lID0gbWV0YWRhdGFTdG9yZS5fZW50aXR5VHlwZVJlc291cmNlTWFwW2VudGl0eVR5cGUubmFtZV07XHJcblxyXG4gIGxldCBkZWZlcnJlZFR5cGVzID0gbWV0YWRhdGFTdG9yZS5fZGVmZXJyZWRUeXBlcztcclxuICBsZXQgZGVmZXJyYWxzID0gZGVmZXJyZWRUeXBlc1tlbnRpdHlUeXBlLm5hbWVdO1xyXG4gIGlmIChkZWZlcnJhbHMpIHtcclxuICAgIGRlZmVycmFscy5mb3JFYWNoKGZ1bmN0aW9uIChkOiBhbnkpIHtcclxuICAgICAgY29tcGxldGVQYXJzZUNzZGxFbnRpdHlUeXBlKGQuZW50aXR5VHlwZSwgZC5jc2RsRW50aXR5VHlwZSwgc2NoZW1hLCBzY2hlbWFzLCBtZXRhZGF0YVN0b3JlKTtcclxuICAgIH0pO1xyXG4gICAgZGVsZXRlIGRlZmVycmVkVHlwZXNbZW50aXR5VHlwZS5uYW1lXTtcclxuICB9XHJcblxyXG59XHJcblxyXG5mdW5jdGlvbiBwYXJzZUNzZGxDb21wbGV4VHlwZShjc2RsQ29tcGxleFR5cGU6IGFueSwgc2NoZW1hOiBhbnksIG1ldGFkYXRhU3RvcmU6IE1ldGFkYXRhU3RvcmUpIHtcclxuICBsZXQgc2hvcnROYW1lID0gY3NkbENvbXBsZXhUeXBlLm5hbWU7XHJcbiAgbGV0IG5zID0gZ2V0TmFtZXNwYWNlRm9yKHNob3J0TmFtZSwgc2NoZW1hKTtcclxuICBsZXQgY29tcGxleFR5cGUgPSBuZXcgQ29tcGxleFR5cGUoe1xyXG4gICAgc2hvcnROYW1lOiBzaG9ydE5hbWUsXHJcbiAgICBuYW1lc3BhY2U6IG5zXHJcbiAgfSk7XHJcblxyXG4gIGNvcmUudG9BcnJheShjc2RsQ29tcGxleFR5cGUucHJvcGVydHkpLmZvckVhY2goZnVuY3Rpb24gKHByb3ApIHtcclxuICAgIHBhcnNlQ3NkbERhdGFQcm9wZXJ0eShjb21wbGV4VHlwZSwgcHJvcCwgc2NoZW1hKTtcclxuICB9KTtcclxuXHJcbiAgbWV0YWRhdGFTdG9yZS5hZGRFbnRpdHlUeXBlKGNvbXBsZXhUeXBlKTtcclxuICByZXR1cm4gY29tcGxleFR5cGU7XHJcbn1cclxuXHJcbmZ1bmN0aW9uIHBhcnNlQ3NkbERhdGFQcm9wZXJ0eShwYXJlbnRUeXBlOiBFbnRpdHlUeXBlIHwgQ29tcGxleFR5cGUsIGNzZGxQcm9wZXJ0eTogYW55LCBzY2hlbWE6IGFueSwga2V5TmFtZXNPblNlcnZlcj86IHN0cmluZ1tdKSB7XHJcbiAgbGV0IGRwOiBEYXRhUHJvcGVydHkgfCB1bmRlZmluZWQ7XHJcbiAgbGV0IHR5cGVQYXJ0cyA9IGNzZGxQcm9wZXJ0eS50eXBlLnNwbGl0KFwiLlwiKTtcclxuICAvLyBCb3RoIHRlc3RzIG9uIHR5cGVQYXJ0cyBhcmUgbmVjZXNzYXJ5IGJlY2F1c2Ugb2YgZGlmZmVyaW5nIG1ldGFkYXRhIGNvbnZlbnRpb25zIGZvciBPRGF0YSBhbmQgRWRteCBmZWVkcy5cclxuICBpZiAodHlwZVBhcnRzWzBdID09PSBcIkVkbVwiICYmIHR5cGVQYXJ0cy5sZW5ndGggPT09IDIpIHtcclxuICAgIGRwID0gcGFyc2VDc2RsU2ltcGxlUHJvcGVydHkocGFyZW50VHlwZSwgY3NkbFByb3BlcnR5LCBrZXlOYW1lc09uU2VydmVyKTtcclxuICB9IGVsc2Uge1xyXG4gICAgaWYgKGlzRW51bVR5cGUoY3NkbFByb3BlcnR5LCBzY2hlbWEpKSB7XHJcbiAgICAgIGRwID0gcGFyc2VDc2RsU2ltcGxlUHJvcGVydHkocGFyZW50VHlwZSwgY3NkbFByb3BlcnR5LCBrZXlOYW1lc09uU2VydmVyKTtcclxuICAgICAgaWYgKGRwKSB7XHJcbiAgICAgICAgZHAuZW51bVR5cGUgPSBjc2RsUHJvcGVydHkudHlwZTtcclxuICAgICAgfVxyXG4gICAgfSBlbHNlIHtcclxuICAgICAgZHAgPSBwYXJzZUNzZGxDb21wbGV4UHJvcGVydHkocGFyZW50VHlwZSwgY3NkbFByb3BlcnR5LCBzY2hlbWEpO1xyXG4gICAgfVxyXG4gIH1cclxuICBpZiAoZHApIHtcclxuICAgIHBhcmVudFR5cGUuX2FkZFByb3BlcnR5Q29yZShkcCk7XHJcbiAgICBhZGRWYWxpZGF0b3JzKGRwKTtcclxuICB9XHJcbiAgcmV0dXJuIGRwO1xyXG59XHJcblxyXG5mdW5jdGlvbiBwYXJzZUNzZGxTaW1wbGVQcm9wZXJ0eShwYXJlbnRUeXBlOiBFbnRpdHlUeXBlIHwgQ29tcGxleFR5cGUsIGNzZGxQcm9wZXJ0eTogYW55LCBrZXlOYW1lc09uU2VydmVyPzogc3RyaW5nW10pIHtcclxuICBsZXQgZGF0YVR5cGUgPSBEYXRhVHlwZS5mcm9tRWRtRGF0YVR5cGUoY3NkbFByb3BlcnR5LnR5cGUpO1xyXG4gIGlmIChkYXRhVHlwZSA9PSBudWxsKSB7XHJcbiAgICBwYXJlbnRUeXBlLndhcm5pbmdzLnB1c2goXCJVbmFibGUgdG8gcmVjb2duaXplIERhdGFUeXBlIGZvciBwcm9wZXJ0eTogXCIgKyBjc2RsUHJvcGVydHkubmFtZSArIFwiIERhdGVUeXBlOiBcIiArIGNzZGxQcm9wZXJ0eS50eXBlKTtcclxuICAgIHJldHVybiB1bmRlZmluZWQ7XHJcbiAgfVxyXG4gIGxldCBpc051bGxhYmxlID0gY3NkbFByb3BlcnR5Lm51bGxhYmxlID09PSAndHJ1ZScgfHwgY3NkbFByb3BlcnR5Lm51bGxhYmxlID09IG51bGw7XHJcbiAgLy8gbGV0IGZpeGVkTGVuZ3RoID0gY3NkbFByb3BlcnR5LmZpeGVkTGVuZ3RoID8gY3NkbFByb3BlcnR5LmZpeGVkTGVuZ3RoID09PSB0cnVlIDogdW5kZWZpbmVkO1xyXG4gIGxldCBpc1BhcnRPZktleSA9IGtleU5hbWVzT25TZXJ2ZXIgIT0gbnVsbCAmJiBrZXlOYW1lc09uU2VydmVyLmluZGV4T2YoY3NkbFByb3BlcnR5Lm5hbWUpID49IDA7XHJcbiAgaWYgKGlzUGFydE9mS2V5ICYmIHBhcmVudFR5cGUgaW5zdGFuY2VvZiBFbnRpdHlUeXBlICYmIHBhcmVudFR5cGUuYXV0b0dlbmVyYXRlZEtleVR5cGUgPT09IEF1dG9HZW5lcmF0ZWRLZXlUeXBlLk5vbmUpIHtcclxuICAgIGlmIChpc0lkZW50aXR5UHJvcGVydHkoY3NkbFByb3BlcnR5KSkge1xyXG4gICAgICBwYXJlbnRUeXBlLmF1dG9HZW5lcmF0ZWRLZXlUeXBlID0gQXV0b0dlbmVyYXRlZEtleVR5cGUuSWRlbnRpdHk7XHJcbiAgICB9XHJcbiAgfVxyXG4gIC8vIFRPRE86IG5pdCAtIGRvbid0IHNldCBtYXhMZW5ndGggaWYgbnVsbDtcclxuICBsZXQgbWF4TGVuZ3RoID0gY3NkbFByb3BlcnR5Lm1heExlbmd0aDtcclxuICBtYXhMZW5ndGggPSAobWF4TGVuZ3RoID09IG51bGwgfHwgbWF4TGVuZ3RoID09PSBcIk1heFwiKSA/IG51bGwgOiBwYXJzZUludChtYXhMZW5ndGgsIDEwKTtcclxuICAvLyBjYW4ndCBzZXQgdGhlIG5hbWUgdW50aWwgd2UgZ28gdGhydSBuYW1pbmdDb252ZW50aW9ucyBhbmQgdGhlc2UgbmVlZCB0aGUgZHAuXHJcblxyXG4gIGxldCBkcCA9IG5ldyBEYXRhUHJvcGVydHkoe1xyXG4gICAgbmFtZU9uU2VydmVyOiBjc2RsUHJvcGVydHkubmFtZSxcclxuICAgIGRhdGFUeXBlOiBkYXRhVHlwZSxcclxuICAgIGlzTnVsbGFibGU6IGlzTnVsbGFibGUsXHJcbiAgICBpc1BhcnRPZktleTogaXNQYXJ0T2ZLZXksXHJcbiAgICBtYXhMZW5ndGg6IG1heExlbmd0aCxcclxuICAgIGRlZmF1bHRWYWx1ZTogY3NkbFByb3BlcnR5LmRlZmF1bHRWYWx1ZSxcclxuICAgIC8vIGZpeGVkTGVuZ3RoOiBmaXhlZExlbmd0aCxcclxuICAgIGNvbmN1cnJlbmN5TW9kZTogY3NkbFByb3BlcnR5LmNvbmN1cnJlbmN5TW9kZVxyXG4gIH0pO1xyXG5cclxuICBpZiAoZGF0YVR5cGUgPT09IERhdGFUeXBlLlVuZGVmaW5lZCkge1xyXG4gICAgZHAucmF3VHlwZU5hbWUgPSBjc2RsUHJvcGVydHkudHlwZTtcclxuICB9XHJcbiAgcmV0dXJuIGRwO1xyXG59XHJcblxyXG5mdW5jdGlvbiBwYXJzZUNzZGxDb21wbGV4UHJvcGVydHkocGFyZW50VHlwZTogRW50aXR5VHlwZSB8IENvbXBsZXhUeXBlLCBjc2RsUHJvcGVydHk6IGFueSwgc2NoZW1hOiBhbnkpIHtcclxuXHJcbiAgLy8gQ29tcGxleCBwcm9wZXJ0aWVzIGFyZSBuZXZlciBudWxsYWJsZSAoIHBlciBFRiBzcGVjcylcclxuICAvLyBsZXQgaXNOdWxsYWJsZSA9IGNzZGxQcm9wZXJ0eS5udWxsYWJsZSA9PT0gJ3RydWUnIHx8IGNzZGxQcm9wZXJ0eS5udWxsYWJsZSA9PSBudWxsO1xyXG4gIC8vIGxldCBjb21wbGV4VHlwZU5hbWUgPSBjc2RsUHJvcGVydHkudHlwZS5zcGxpdChcIkVkbS5cIilbMV07XHJcbiAgbGV0IGNvbXBsZXhUeXBlTmFtZSA9IHBhcnNlVHlwZU5hbWVXaXRoU2NoZW1hKGNzZGxQcm9wZXJ0eS50eXBlLCBzY2hlbWEpLnR5cGVOYW1lO1xyXG4gIC8vIGNhbid0IHNldCB0aGUgbmFtZSB1bnRpbCB3ZSBnbyB0aHJ1IG5hbWluZ0NvbnZlbnRpb25zIGFuZCB0aGVzZSBuZWVkIHRoZSBkcC5cclxuICBsZXQgZHAgPSBuZXcgRGF0YVByb3BlcnR5KHtcclxuICAgIG5hbWVPblNlcnZlcjogY3NkbFByb3BlcnR5Lm5hbWUsXHJcbiAgICBjb21wbGV4VHlwZU5hbWU6IGNvbXBsZXhUeXBlTmFtZSxcclxuICAgIGlzTnVsbGFibGU6IGZhbHNlXHJcbiAgfSk7XHJcblxyXG4gIHJldHVybiBkcDtcclxufVxyXG5cclxuZnVuY3Rpb24gcGFyc2VDc2RsTmF2UHJvcGVydHkoZW50aXR5VHlwZTogRW50aXR5VHlwZSwgY3NkbFByb3BlcnR5OiBhbnksIHNjaGVtYTogYW55LCBzY2hlbWFzOiBhbnlbXSkge1xyXG4gIGxldCBhc3NvY2lhdGlvbiA9IGdldEFzc29jaWF0aW9uKGNzZGxQcm9wZXJ0eSwgc2NoZW1hLCBzY2hlbWFzKTtcclxuICBpZiAoIWFzc29jaWF0aW9uKSB7XHJcbiAgICB0aHJvdyBuZXcgRXJyb3IoXCJVbmFibGUgdG8gcmVzb2x2ZSBGb3JlaWduIEtleSBBc3NvY2lhdGlvbjogXCIgKyBjc2RsUHJvcGVydHkucmVsYXRpb25zaGlwKTtcclxuICB9XHJcbiAgbGV0IHRvRW5kID0gY29yZS5hcnJheUZpcnN0KGFzc29jaWF0aW9uLmVuZCwgKGFzc29jRW5kKSA9PiB7XHJcbiAgICByZXR1cm4gYXNzb2NFbmQucm9sZSA9PT0gY3NkbFByb3BlcnR5LnRvUm9sZTtcclxuICB9KTtcclxuXHJcbiAgbGV0IGlzU2NhbGFyID0gdG9FbmQhLm11bHRpcGxpY2l0eSAhPT0gXCIqXCI7XHJcbiAgbGV0IGRhdGFUeXBlID0gcGFyc2VUeXBlTmFtZVdpdGhTY2hlbWEodG9FbmQhLnR5cGUsIHNjaGVtYSkudHlwZU5hbWU7XHJcblxyXG4gIGxldCBjb25zdHJhaW50ID0gYXNzb2NpYXRpb24ucmVmZXJlbnRpYWxDb25zdHJhaW50O1xyXG4gIGlmICghY29uc3RyYWludCkge1xyXG4gICAgLy8gVE9ETzogUmV2aXNpdCB0aGlzIGxhdGVyIC0gcmlnaHQgbm93IHdlIGp1c3QgaWdub3JlIG1hbnktbWFueSBhbmQgYXNzb2NzIHdpdGggbWlzc2luZyBjb25zdHJhaW50cy5cclxuXHJcbiAgICAvLyBUaGluayBhYm91dCBhZGRpbmcgdGhpcyBiYWNrIGxhdGVyLlxyXG4gICAgaWYgKGFzc29jaWF0aW9uLmVuZFswXS5tdWx0aXBsaWNpdHkgPT09IFwiKlwiICYmIGFzc29jaWF0aW9uLmVuZFsxXS5tdWx0aXBsaWNpdHkgPT09IFwiKlwiKSB7XHJcbiAgICAgIC8vIGlnbm9yZSBtYW55IHRvIG1hbnkgcmVsYXRpb25zIGZvciBub3dcclxuICAgICAgcmV0dXJuO1xyXG4gICAgfSBlbHNlIHtcclxuICAgICAgLy8gRm9yIG5vdyBhc3N1bWUgaXQgd2lsbCBiZSBzZXQgbGF0ZXIgZGlyZWN0bHkgb24gdGhlIGNsaWVudC5cclxuICAgICAgLy8gb3RoZXIgYWx0ZXJuYXRpdmUgaXMgdG8gdGhyb3cgYW4gZXJyb3I6XHJcbiAgICAgIC8vIHRocm93IG5ldyBFcnJvcihcIkZvcmVpZ24gS2V5IEFzc29jaWF0aW9ucyBtdXN0IGJlIHR1cm5lZCBvbiBmb3IgdGhpcyBtb2RlbFwiKTtcclxuICAgIH1cclxuICB9XHJcblxyXG5cclxuXHJcbiAgbGV0IGNmZyA9IHtcclxuICAgIG5hbWVPblNlcnZlcjogY3NkbFByb3BlcnR5Lm5hbWUsXHJcbiAgICBlbnRpdHlUeXBlTmFtZTogZGF0YVR5cGUsXHJcbiAgICBpc1NjYWxhcjogaXNTY2FsYXIsXHJcbiAgICBhc3NvY2lhdGlvbk5hbWU6IGFzc29jaWF0aW9uLm5hbWUsXHJcbiAgfTtcclxuXHJcbiAgaWYgKGNvbnN0cmFpbnQpIHtcclxuICAgIGxldCBwcmluY2lwYWwgPSBjb25zdHJhaW50LnByaW5jaXBhbDtcclxuICAgIGxldCBkZXBlbmRlbnQgPSBjb25zdHJhaW50LmRlcGVuZGVudDtcclxuXHJcbiAgICBsZXQgcHJvcFJlZnMgPSBjb3JlLnRvQXJyYXkoZGVwZW5kZW50LnByb3BlcnR5UmVmKTtcclxuICAgIGxldCBma05hbWVzID0gcHJvcFJlZnMubWFwKGNvcmUucGx1Y2soXCJuYW1lXCIpKTtcclxuICAgIGlmIChjc2RsUHJvcGVydHkuZnJvbVJvbGUgPT09IHByaW5jaXBhbC5yb2xlKSB7XHJcbiAgICAgIChjZmcgYXMgYW55KS5pbnZGb3JlaWduS2V5TmFtZXNPblNlcnZlciA9IGZrTmFtZXM7XHJcbiAgICB9IGVsc2Uge1xyXG4gICAgICAvLyB3aWxsIGJlIHVzZWQgbGF0ZXIgYnkgbnAuX3VwZGF0ZVxyXG4gICAgICAoY2ZnIGFzIGFueSkuZm9yZWlnbktleU5hbWVzT25TZXJ2ZXIgPSBma05hbWVzO1xyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgbGV0IG5wID0gbmV3IE5hdmlnYXRpb25Qcm9wZXJ0eShjZmcpO1xyXG4gIGVudGl0eVR5cGUuX2FkZFByb3BlcnR5Q29yZShucCk7XHJcbiAgcmV0dXJuIG5wO1xyXG59XHJcblxyXG5cclxuZnVuY3Rpb24gaXNFbnVtVHlwZShjc2RsUHJvcGVydHk6IGFueSwgc2NoZW1hOiBhbnkpIHtcclxuICBpZiAoc2NoZW1hLmVudW1UeXBlKSByZXR1cm4gaXNFZG14RW51bVR5cGUoY3NkbFByb3BlcnR5LCBzY2hlbWEpO1xyXG4gIGVsc2UgaWYgKHNjaGVtYS5leHRlbnNpb25zKSByZXR1cm4gaXNPRGF0YUVudW1UeXBlKGNzZGxQcm9wZXJ0eSwgc2NoZW1hKTtcclxuICBlbHNlIHJldHVybiBmYWxzZTtcclxufVxyXG5cclxuZnVuY3Rpb24gaXNFZG14RW51bVR5cGUoY3NkbFByb3BlcnR5OiBhbnksIHNjaGVtYTogYW55KSB7XHJcbiAgbGV0IGVudW1UeXBlcyA9IGNvcmUudG9BcnJheShzY2hlbWEuZW51bVR5cGUpO1xyXG4gIGxldCB0eXBlUGFydHMgPSBjc2RsUHJvcGVydHkudHlwZS5zcGxpdChcIi5cIik7XHJcbiAgbGV0IGJhc2VUeXBlTmFtZSA9IHR5cGVQYXJ0c1t0eXBlUGFydHMubGVuZ3RoIC0gMV07XHJcbiAgcmV0dXJuIGVudW1UeXBlcy5zb21lKGZ1bmN0aW9uIChlbnVtVHlwZSkge1xyXG4gICAgcmV0dXJuIGVudW1UeXBlLm5hbWUgPT09IGJhc2VUeXBlTmFtZTtcclxuICB9KTtcclxufVxyXG5cclxuZnVuY3Rpb24gaXNPRGF0YUVudW1UeXBlKGNzZGxQcm9wZXJ0eTogYW55LCBzY2hlbWE6IGFueSkge1xyXG4gIGxldCBlbnVtVHlwZXMgPSBzY2hlbWEuZXh0ZW5zaW9ucy5maWx0ZXIoKGV4dDogYW55KSA9PiB7XHJcbiAgICByZXR1cm4gZXh0Lm5hbWUgPT09IFwiRW51bVR5cGVcIjtcclxuICB9KTtcclxuICBsZXQgdHlwZVBhcnRzID0gY3NkbFByb3BlcnR5LnR5cGUuc3BsaXQoXCIuXCIpO1xyXG4gIGxldCBiYXNlVHlwZU5hbWUgPSB0eXBlUGFydHNbdHlwZVBhcnRzLmxlbmd0aCAtIDFdO1xyXG4gIHJldHVybiBlbnVtVHlwZXMuc29tZSgoZW51bVR5cGU6IGFueSkgPT4ge1xyXG4gICAgcmV0dXJuIGVudW1UeXBlLmF0dHJpYnV0ZXMuc29tZSgoYXR0cjogYW55KSA9PiB7XHJcbiAgICAgIHJldHVybiBhdHRyLm5hbWUgPT09IFwiTmFtZVwiICYmIGF0dHIudmFsdWUgPT09IGJhc2VUeXBlTmFtZTtcclxuICAgIH0pO1xyXG4gIH0pO1xyXG59XHJcblxyXG5mdW5jdGlvbiBhZGRWYWxpZGF0b3JzKGRhdGFQcm9wZXJ0eTogRGF0YVByb3BlcnR5KSB7XHJcbiAgbGV0IHR5cGVWYWxpZGF0b3I6IFZhbGlkYXRvcjtcclxuICBpZiAoIWRhdGFQcm9wZXJ0eS5pc051bGxhYmxlKSB7XHJcbiAgICBkYXRhUHJvcGVydHkudmFsaWRhdG9ycy5wdXNoKFZhbGlkYXRvci5yZXF1aXJlZCgpKTtcclxuICB9XHJcblxyXG4gIGlmIChkYXRhUHJvcGVydHkuaXNDb21wbGV4UHJvcGVydHkpIHJldHVybjtcclxuXHJcbiAgaWYgKGRhdGFQcm9wZXJ0eS5kYXRhVHlwZSA9PT0gRGF0YVR5cGUuU3RyaW5nKSB7XHJcbiAgICBpZiAoZGF0YVByb3BlcnR5Lm1heExlbmd0aCkge1xyXG4gICAgICBsZXQgdmFsaWRhdG9yQXJncyA9IHsgbWF4TGVuZ3RoOiBkYXRhUHJvcGVydHkubWF4TGVuZ3RoIH07XHJcbiAgICAgIHR5cGVWYWxpZGF0b3IgPSBWYWxpZGF0b3IubWF4TGVuZ3RoKHZhbGlkYXRvckFyZ3MpO1xyXG4gICAgfSBlbHNlIHtcclxuICAgICAgdHlwZVZhbGlkYXRvciA9IFZhbGlkYXRvci5zdHJpbmcoKTtcclxuICAgIH1cclxuICB9IGVsc2Uge1xyXG4gICAgICBsZXQgdmFsaWRhdG9yQ3RvciA9IChkYXRhUHJvcGVydHkuZGF0YVR5cGUgYXMgYW55KS52YWxpZGF0b3JDdG9yO1xyXG4gICAgICBpZiAoIXZhbGlkYXRvckN0b3IpIHJldHVybjtcclxuICAgICAgdHlwZVZhbGlkYXRvciA9IHZhbGlkYXRvckN0b3IoKTtcclxuICB9XHJcblxyXG4gIGRhdGFQcm9wZXJ0eS52YWxpZGF0b3JzLnB1c2godHlwZVZhbGlkYXRvcik7XHJcblxyXG59XHJcblxyXG5mdW5jdGlvbiBpc0lkZW50aXR5UHJvcGVydHkoY3NkbFByb3BlcnR5OiBhbnkpIHtcclxuICAvLyBzZWUgaWYgd2ViIGFwaSBmZWVkXHJcbiAgbGV0IHByb3BOYW1lID0gY29yZS5hcnJheUZpcnN0KE9iamVjdC5rZXlzKGNzZGxQcm9wZXJ0eSksIChwbikgPT4ge1xyXG4gICAgcmV0dXJuIHBuLmluZGV4T2YoXCJTdG9yZUdlbmVyYXRlZFBhdHRlcm5cIikgPj0gMDtcclxuICB9KTtcclxuICBpZiAocHJvcE5hbWUpIHtcclxuICAgIHJldHVybiAoY3NkbFByb3BlcnR5W3Byb3BOYW1lXSA9PT0gXCJJZGVudGl0eVwiKTtcclxuICB9IGVsc2Uge1xyXG4gICAgLy8gc2VlIGlmIE9kYXRhIGZlZWRcclxuICAgIGxldCBleHRlbnNpb25zID0gY3NkbFByb3BlcnR5LmV4dGVuc2lvbnM7XHJcbiAgICBpZiAoIWV4dGVuc2lvbnMpIHtcclxuICAgICAgcmV0dXJuIGZhbHNlO1xyXG4gICAgfVxyXG4gICAgbGV0IGlkZW50aXR5RXh0biA9IGNvcmUuYXJyYXlGaXJzdChleHRlbnNpb25zLCAoZXh0ZW5zaW9uKSA9PiB7XHJcbiAgICAgIHJldHVybiBleHRlbnNpb24ubmFtZSA9PT0gXCJTdG9yZUdlbmVyYXRlZFBhdHRlcm5cIiAmJiBleHRlbnNpb24udmFsdWUgPT09IFwiSWRlbnRpdHlcIjtcclxuICAgIH0pO1xyXG4gICAgcmV0dXJuICEhaWRlbnRpdHlFeHRuO1xyXG4gIH1cclxufVxyXG5cclxuLy8gRmFzdCB2ZXJzaW9uXHJcbi8vIG5wOiBzY2hlbWEuZW50aXR5VHlwZVtdLm5hdmlnYXRpb25Qcm9wZXJ0eS5yZWxhdGlvbnNoaXAgLT4gc2NoZW1hLmFzc29jaWF0aW9uXHJcbi8vICAgbWF0Y2goIHNob3J0TmFtZShucC5yZWxhdGlvbnNoaXApID09IHNjaGVtYS5hc3NvY2lhdGlvbltdLm5hbWVcclxuLy8gICAgICAtLT4gYXNzb2NpYXRpb25fX1xyXG5cclxuLy8gQ29ycmVjdCB2ZXJzaW9uXHJcbi8vIG5wOiBzY2hlbWEuZW50aXR5VHlwZVtdLm5hdmlnYXRpb25Qcm9wZXJ0eS5yZWxhdGlvbnNoaXAgLT4gc2NoZW1hLmFzc29jaWF0aW9uXHJcbi8vICAgbWF0Y2goIG5wLnJlbGF0aW9uc2hpcCA9PSBzY2hlbWEuZW50aXR5Q29udGFpbmVyWzBdLmFzc29jaWF0aW9uU2V0W10uYXNzb2NpYXRpb24gKVxyXG4vLyAgICAgIC0+IGFzc29jaWF0aW9uU2V0Lm5hbWVcclxuLy8gICBtYXRjaCAoIGFzc29jaWF0aW9uU2V0Lm5hbWUgPT0gc2NoZW1hLmFzc29jaWF0aW9uW10ubmFtZSApXHJcbi8vICAgICAgLT4gYXNzb2NpYXRpb25cclxuXHJcbmZ1bmN0aW9uIGdldEFzc29jaWF0aW9uKGNzZGxOYXZQcm9wZXJ0eTogYW55LCBjb250YWluaW5nU2NoZW1hOiBhbnksIHNjaGVtYXM6IGFueVtdKSB7XHJcbiAgbGV0IGFzc29jRnVsbE5hbWUgPSBwYXJzZVR5cGVOYW1lV2l0aFNjaGVtYShjc2RsTmF2UHJvcGVydHkucmVsYXRpb25zaGlwLCBjb250YWluaW5nU2NoZW1hKTtcclxuICBsZXQgYXNzb2NOYW1lc3BhY2UgPSBhc3NvY0Z1bGxOYW1lLm5hbWVzcGFjZTtcclxuICBsZXQgYXNzb2NTY2hlbWEgPSBjb3JlLmFycmF5Rmlyc3Qoc2NoZW1hcywgKHNjaGVtYSkgPT4ge1xyXG4gICAgcmV0dXJuIHNjaGVtYS5uYW1lc3BhY2UgPT09IGFzc29jTmFtZXNwYWNlO1xyXG4gIH0pO1xyXG4gIGlmICghYXNzb2NTY2hlbWEpIHJldHVybiBudWxsO1xyXG5cclxuICBsZXQgYXNzb2NOYW1lID0gYXNzb2NGdWxsTmFtZS5zaG9ydFR5cGVOYW1lO1xyXG4gIGxldCBhc3NvY3MgPSBhc3NvY1NjaGVtYS5hc3NvY2lhdGlvbjtcclxuICBpZiAoIWFzc29jcykgcmV0dXJuIG51bGw7XHJcbiAgaWYgKCFBcnJheS5pc0FycmF5KGFzc29jcykpIHtcclxuICAgIGFzc29jcyA9IFthc3NvY3NdO1xyXG4gIH1cclxuICBsZXQgYXNzb2NpYXRpb24gPSBjb3JlLmFycmF5Rmlyc3QoYXNzb2NzLCAoYXNzb2MpID0+IHtcclxuICAgIHJldHVybiBhc3NvYy5uYW1lID09PSBhc3NvY05hbWU7XHJcbiAgfSk7XHJcbiAgcmV0dXJuIGFzc29jaWF0aW9uIGFzIElBc3NvY2lhdGlvbjtcclxufVxyXG5cclxuLy8gc2NoZW1hIGlzIG9ubHkgbmVlZGVkIGZvciBuYXZQcm9wZXJ0eSB0eXBlIG5hbWVcclxuZnVuY3Rpb24gcGFyc2VUeXBlTmFtZVdpdGhTY2hlbWEoZW50aXR5VHlwZU5hbWU6IHN0cmluZywgc2NoZW1hOiBhbnkpIHtcclxuICBsZXQgcmVzdWx0ID0gTWV0YWRhdGFTdG9yZS5wYXJzZVR5cGVOYW1lKGVudGl0eVR5cGVOYW1lKTtcclxuICBpZiAoc2NoZW1hICYmIHNjaGVtYS5jU3BhY2VPU3BhY2VNYXBwaW5nKSB7XHJcbiAgICBsZXQgbnMgPSBnZXROYW1lc3BhY2VGb3IocmVzdWx0IS5zaG9ydFR5cGVOYW1lLCBzY2hlbWEpO1xyXG4gICAgaWYgKG5zKSB7XHJcbiAgICAgIHJlc3VsdCA9IE1ldGFkYXRhU3RvcmUubWFrZVR5cGVIYXNoKHJlc3VsdCEuc2hvcnRUeXBlTmFtZSwgbnMpO1xyXG4gICAgfVxyXG4gIH1cclxuICByZXR1cm4gcmVzdWx0O1xyXG59XHJcblxyXG5mdW5jdGlvbiBnZXROYW1lc3BhY2VGb3Ioc2hvcnROYW1lOiBzdHJpbmcsIHNjaGVtYTogYW55KSB7XHJcbiAgbGV0IG5zOiBzdHJpbmc7XHJcbiAgbGV0IG1hcHBpbmcgPSBzY2hlbWEuY1NwYWNlT1NwYWNlTWFwcGluZztcclxuICBpZiAobWFwcGluZykge1xyXG4gICAgbGV0IGZ1bGxOYW1lID0gbWFwcGluZ1tzY2hlbWEubmFtZXNwYWNlICsgXCIuXCIgKyBzaG9ydE5hbWVdO1xyXG4gICAgbnMgPSBmdWxsTmFtZSAmJiBmdWxsTmFtZS5zdWJzdHIoMCwgZnVsbE5hbWUubGVuZ3RoIC0gKHNob3J0TmFtZS5sZW5ndGggKyAxKSk7XHJcbiAgICBpZiAobnMpIHJldHVybiBucztcclxuICB9XHJcbiAgLy8gaWYgc2NoZW1hIGRvZXMgbm90IGFsc28gaGF2ZSBhbiBlbnRpdHlUeXBlIG5vZGUgdGhlblxyXG4gIC8vIHRoaXMgaXMgYW4gV2ViQXBpMiBPRGF0YSBzY2hlbWEgd2hpY2ggaXMgdXN1YWxseSBlcXVhbCB0byAnRGVmYXVsdCc7IHdoaWNoIGlzIHVzZWxlc3MuXHJcbiAgaWYgKHNjaGVtYS5lbnRpdHlUeXBlIHx8IHNjaGVtYS5uYW1lc3BhY2UgIT09ICdEZWZhdWx0Jykge1xyXG4gICAgcmV0dXJuIHNjaGVtYS5uYW1lc3BhY2U7XHJcbiAgfVxyXG4gIHJldHVybiBudWxsO1xyXG59XHJcblxyXG4vKiogQGhpZGRlbiBAaW50ZXJuYWwgKi9cclxuZXhwb3J0IGNvbnN0IENzZGxNZXRhZGF0YVBhcnNlciA9IHtcclxuICBwYXJzZTogcGFyc2VcclxufTtcclxuIl19