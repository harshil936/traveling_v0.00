import { assertConfig } from './assert-param';
import { config } from './config';
import { core } from './core';
/**
A DataService instance is used to encapsulate the details of a single 'service'; this includes a serviceName, a dataService adapterInstance,
and whether the service has server side metadata.

You can construct an EntityManager with either a serviceName or a DataService instance, if you use a serviceName then a DataService
is constructed for you.  (It can also be set via the EntityManager.setProperties method).

The same applies to the MetadataStore.fetchMetadata method, i.e. it takes either a serviceName or a DataService instance.

Each metadataStore contains a list of DataServices, each accessible via its ‘serviceName’.
( see MetadataStore.getDataService and MetadataStore.addDataService).  The ‘addDataService’ method is called internally
anytime a MetadataStore.fetchMetadata call occurs with a new dataService ( or service name).

**/
export class DataService {
    /**   DataService constructor
    >     var dataService = new DataService({
    >         serviceName: altServiceName,
    >         hasServerMetadata: false
    >     });
  
    >     var metadataStore = new MetadataStore({
    >         namingConvention: NamingConvention.camelCase
    >     });
  
    >     return new EntityManager({
    >         dataService: dataService,
    >         metadataStore: metadataStore
    >     });
    @param config - A configuration object.
    **/
    constructor(config) {
        updateWithConfig(this, config);
    }
    /**
    Returns a copy of this DataService with the specified properties applied.
    @param config - The configuration object to apply to create a new DataService.
    **/
    using(config) {
        if (!config)
            return this;
        let result = new DataService(this);
        return updateWithConfig(result, config);
    }
    static resolve(dataServices) {
        // final defaults
        // Deliberate use of 'as any' below.
        dataServices.push({
            hasServerMetadata: true,
            useJsonp: false
        });
        let ds = new DataService(core.resolveProperties(dataServices, ["serviceName", "adapterName", "uriBuilderName", "hasServerMetadata", "jsonResultsAdapter", "useJsonp"]));
        if (!ds.serviceName) {
            throw new Error("Unable to resolve a 'serviceName' for this dataService");
        }
        ds.adapterInstance = ds.adapterInstance || config.getAdapterInstance("dataService", ds.adapterName);
        ds.jsonResultsAdapter = ds.jsonResultsAdapter || ds.adapterInstance.jsonResultsAdapter;
        ds.uriBuilder = ds.uriBuilder || config.getAdapterInstance("uriBuilder", ds.uriBuilderName);
        return ds;
    }
    /** @hidden @internal */
    static _normalizeServiceName(serviceName) {
        serviceName = serviceName.trim();
        if (serviceName.substr(-1) !== "/") {
            return serviceName + '/';
        }
        else {
            return serviceName;
        }
    }
    /**  */
    toJSON() {
        // don't use default value here - because we want to be able to distinguish undefined props for inheritence purposes.
        return core.toJson(this, {
            serviceName: null,
            adapterName: null,
            uriBuilderName: null,
            hasServerMetadata: null,
            jsonResultsAdapter: function (v) {
                return v && v.name;
            },
            useJsonp: null
        });
    }
    static fromJSON(json) {
        json.jsonResultsAdapter = config._fetchObject(JsonResultsAdapter, json.jsonResultsAdapter);
        return new DataService(json);
    }
    /**
     Returns a url for this dataService with the specified suffix. This method handles dataService names either
     with or without trailing '/'s.  If the suffix starts with "http" then it will be returned as-is.
     @method qualifyUrl
     @param suffix {String} The resulting url.
     @return {a Url string}
     **/
    qualifyUrl(suffix) {
        if (suffix && suffix.startsWith("http")) {
            return suffix;
        }
        let url = this.serviceName;
        // remove any trailing "/"
        if (core.stringEndsWith(url, "/")) {
            url = url.substr(0, url.length - 1);
        }
        // ensure that it ends with "/" + suffix
        suffix = "/" + suffix;
        if (!core.stringEndsWith(url, suffix)) {
            url = url + suffix;
        }
        return url;
    }
}
DataService.prototype._$typeName = "DataService";
function updateWithConfig(obj, dsConfig) {
    if (dsConfig) {
        assertConfig(dsConfig)
            .whereParam("serviceName").isOptional()
            .whereParam("adapterName").isString().isOptional()
            .whereParam("uriBuilderName").isString().isOptional()
            .whereParam("hasServerMetadata").isBoolean().isOptional()
            .whereParam("jsonResultsAdapter").isInstanceOf(JsonResultsAdapter).isOptional()
            .whereParam("useJsonp").isBoolean().isOptional()
            .applyAll(obj);
        obj.serviceName = obj.serviceName && DataService._normalizeServiceName(obj.serviceName);
        obj.adapterInstance = obj.adapterName ? config.getAdapterInstance("dataService", obj.adapterName) : undefined;
        obj.uriBuilder = obj.uriBuilderName ? config.getAdapterInstance("uriBuilder", obj.uriBuilderName) : undefined;
    }
    return obj;
}
/**
A JsonResultsAdapter instance is used to provide custom extraction and parsing logic on the json results returned by any web service.
This facility makes it possible for breeze to talk to virtually any web service and return objects that will be first class 'breeze' citizens.
**/
export class JsonResultsAdapter {
    /**
    JsonResultsAdapter constructor
  
    @example
        //
        var jsonResultsAdapter = new JsonResultsAdapter({
            name: "test1e",
            extractResults: function(json) {
                return json.results;
            },
            visitNode: function(node, mappingContext, nodeContext) {
                var entityType = normalizeTypeName(node.$type);
                var propertyName = nodeContext.propertyName;
                var ignore = propertyName && propertyName.substr(0, 1) === "$";
  
                return {
                    entityType: entityType,
                    nodeId: node.$id,
                    nodeRefId: node.$ref,
                    ignore: ignore,
                    passThru: false // default
                };
            }
        });
  
        var dataService = new DataService( {
                serviceName: "breeze/foo",
                jsonResultsAdapter: jsonResultsAdapter
        });
  
        var entityManager = new EntityManager( {
            dataService: dataService
        });
  
    @param config - A configuration object.
  
    **/
    constructor(jsConfig) {
        if (arguments.length !== 1) {
            throw new Error("The JsonResultsAdapter ctor should be called with a single argument that is a configuration object.");
        }
        assertConfig(jsConfig)
            .whereParam("name").isNonEmptyString()
            .whereParam("extractResults").isFunction().isOptional().withDefault(extractResultsDefault)
            .whereParam("extractSaveResults").isFunction().isOptional().withDefault(extractSaveResultsDefault)
            .whereParam("extractKeyMappings").isFunction().isOptional().withDefault(extractKeyMappingsDefault)
            .whereParam("extractDeletedKeys").isFunction().isOptional().withDefault(extractDeletedKeysDefault)
            .whereParam("visitNode").isFunction()
            .applyAll(this);
        config._storeObject(this, "JsonResultsAdapter", this.name);
    }
}
JsonResultsAdapter.prototype._$typeName = "JsonResultsAdapter";
function extractResultsDefault(data) {
    return data.results;
}
function extractSaveResultsDefault(data) {
    return data.entities || data.Entities || [];
}
function extractKeyMappingsDefault(data) {
    return data.keyMappings || data.KeyMappings || [];
}
function extractDeletedKeysDefault(data) {
    return data.deletedKeys || data.DeletedKeys || [];
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZGF0YS1zZXJ2aWNlLmpzIiwic291cmNlUm9vdCI6Im5nOi8vYnJlZXplLWNsaWVudC8iLCJzb3VyY2VzIjpbInNyYy9kYXRhLXNlcnZpY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBSUEsT0FBTyxFQUFFLFlBQVksRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBQzlDLE9BQU8sRUFBRSxNQUFNLEVBQUUsTUFBTSxVQUFVLENBQUM7QUFDbEMsT0FBTyxFQUFFLElBQUksRUFBRSxNQUFNLFFBQVEsQ0FBQztBQWlCOUI7Ozs7Ozs7Ozs7Ozs7R0FhRztBQUNILE1BQU0sT0FBTyxXQUFXO0lBb0J0Qjs7Ozs7Ozs7Ozs7Ozs7O09BZUc7SUFDSCxZQUFZLE1BQTBCO1FBQ3BDLGdCQUFnQixDQUFDLElBQUksRUFBRSxNQUFNLENBQUMsQ0FBQztJQUNqQyxDQUFDO0lBR0Q7OztPQUdHO0lBQ0gsS0FBSyxDQUFDLE1BQXlCO1FBQzdCLElBQUksQ0FBQyxNQUFNO1lBQUUsT0FBTyxJQUFJLENBQUM7UUFDekIsSUFBSSxNQUFNLEdBQUcsSUFBSSxXQUFXLENBQUMsSUFBSSxDQUFDLENBQUM7UUFDbkMsT0FBTyxnQkFBZ0IsQ0FBQyxNQUFNLEVBQUUsTUFBTSxDQUFDLENBQUM7SUFDMUMsQ0FBQztJQUVELE1BQU0sQ0FBQyxPQUFPLENBQUMsWUFBMkI7UUFDeEMsaUJBQWlCO1FBQ2pCLG9DQUFvQztRQUNuQyxZQUFvQixDQUFDLElBQUksQ0FBQztZQUN6QixpQkFBaUIsRUFBRSxJQUFJO1lBQ3ZCLFFBQVEsRUFBRSxLQUFLO1NBQ2hCLENBQUMsQ0FBQztRQUNILElBQUksRUFBRSxHQUFHLElBQUksV0FBVyxDQUFDLElBQUksQ0FBQyxpQkFBaUIsQ0FBQyxZQUFZLEVBQ3hELENBQUMsYUFBYSxFQUFFLGFBQWEsRUFBRSxnQkFBZ0IsRUFBRSxtQkFBbUIsRUFBRSxvQkFBb0IsRUFBRSxVQUFVLENBQUMsQ0FBQyxDQUFDLENBQUM7UUFFOUcsSUFBSSxDQUFDLEVBQUUsQ0FB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QyxXQUFXLElBQUksRUFBRSxDQUFDO0FBQ3BELENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBFbnRpdHlUeXBlLCBOYXZpZ2F0aW9uUHJvcGVydHkgfSBmcm9tICcuL2VudGl0eS1tZXRhZGF0YSc7XHJcbmltcG9ydCB7IERhdGFTZXJ2aWNlQWRhcHRlciwgVXJpQnVpbGRlckFkYXB0ZXIgfSBmcm9tICcuL2ludGVyZmFjZS1yZWdpc3RyeSc7XHJcbmltcG9ydCB7IEtleU1hcHBpbmcgfSBmcm9tICcuL2VudGl0eS1tYW5hZ2VyJztcclxuaW1wb3J0IHsgTWFwcGluZ0NvbnRleHQgfSBmcm9tICcuL21hcHBpbmctY29udGV4dCc7XHJcbmltcG9ydCB7IGFzc2VydENvbmZpZyB9IGZyb20gJy4vYXNzZXJ0LXBhcmFtJztcclxuaW1wb3J0IHsgY29uZmlnIH0gZnJvbSAnLi9jb25maWcnO1xyXG5pbXBvcnQgeyBjb3JlIH0gZnJvbSAnLi9jb3JlJztcclxuXHJcbi8qKiBDb25maWd1cmF0aW9uIGluZm8gdG8gYmUgcGFzc2VkIHRvIHRoZSBbW0RhdGFTZXJ2aWNlXV0gY29uc3RydWN0b3IgKi9cclxuZXhwb3J0IGludGVyZmFjZSBEYXRhU2VydmljZUNvbmZpZyB7XHJcbiAgLyoqIFRoZSBzZXJ2aWNlTmFtZSBmb3IgdGhpcyBEYXRhU2VydmljZS4gICoqL1xyXG4gIHNlcnZpY2VOYW1lPzogc3RyaW5nO1xyXG4gIC8qKiBUaGUgYWRhcHRlciBuYW1lIGZvciB0aGUgW1tJRGF0YVNlcnZpY2VBZGFwdGVyXV0gdG8gYmUgdXNlZCB3aXRoIHRoaXMgc2VydmljZS4gICoqL1xyXG4gIGFkYXB0ZXJOYW1lPzogc3RyaW5nO1xyXG4gIC8qKiBUaGUgYWRhcHRlciBuYW1lIGZvciB0aGUgW1tJVXJpQnVpbGRlckFkYXB0ZXJdXSB0byBiZSB1c2VkIHdpdGggdGhpcyBzZXJ2aWNlLiAgKiovXHJcbiAgdXJpQnVpbGRlck5hbWU/OiBzdHJpbmc7XHJcbiAgLyoqIFdoZXRoZXIgdGhlIHNlcnZlciBjYW4gcHJvdmlkZSBtZXRhZGF0YSBmb3IgdGhpcyBzZXJ2aWNlLiAgKiovXHJcbiAgaGFzU2VydmVyTWV0YWRhdGE/OiBib29sZWFuO1xyXG4gIC8qKiBUaGUgW1tKc29uUmVzdWx0c0FkYXB0ZXJdXSB1c2VkIHRvIHByb2Nlc3MgdGhlIHJlc3VsdHMgb2YgYW55IHF1ZXJ5IGFnYWluc3QgdGhpcyBEYXRhU2VydmljZS4gICoqL1xyXG4gIGpzb25SZXN1bHRzQWRhcHRlcj86IEpzb25SZXN1bHRzQWRhcHRlcjtcclxuICAvKiogV2hldGhlciB0byB1c2UgSlNPTlAgd2hlbiBwZXJmb3JtaW5nIGEgJ0dFVCcgcmVxdWVzdCBhZ2FpbnN0IHRoaXMgc2VydmljZS4gICoqL1xyXG4gIHVzZUpzb25wPzogYm9vbGVhbjtcclxufVxyXG4vKipcclxuQSBEYXRhU2VydmljZSBpbnN0YW5jZSBpcyB1c2VkIHRvIGVuY2Fwc3VsYXRlIHRoZSBkZXRhaWxzIG9mIGEgc2luZ2xlICdzZXJ2aWNlJzsgdGhpcyBpbmNsdWRlcyBhIHNlcnZpY2VOYW1lLCBhIGRhdGFTZXJ2aWNlIGFkYXB0ZXJJbnN0YW5jZSxcclxuYW5kIHdoZXRoZXIgdGhlIHNlcnZpY2UgaGFzIHNlcnZlciBzaWRlIG1ldGFkYXRhLlxyXG5cclxuWW91IGNhbiBjb25zdHJ1Y3QgYW4gRW50aXR5TWFuYWdlciB3aXRoIGVpdGhlciBhIHNlcnZpY2VOYW1lIG9yIGEgRGF0YVNlcnZpY2UgaW5zdGFuY2UsIGlmIHlvdSB1c2UgYSBzZXJ2aWNlTmFtZSB0aGVuIGEgRGF0YVNlcnZpY2VcclxuaXMgY29uc3RydWN0ZWQgZm9yIHlvdS4gIChJdCBjYW4gYWxzbyBiZSBzZXQgdmlhIHRoZSBFbnRpdHlNYW5hZ2VyLnNldFByb3BlcnRpZXMgbWV0aG9kKS5cclxuXHJcblRoZSBzYW1lIGFwcGxpZXMgdG8gdGhlIE1ldGFkYXRhU3RvcmUuZmV0Y2hNZXRhZGF0YSBtZXRob2QsIGkuZS4gaXQgdGFrZXMgZWl0aGVyIGEgc2VydmljZU5hbWUgb3IgYSBEYXRhU2VydmljZSBpbnN0YW5jZS5cclxuXHJcbkVhY2ggbWV0YWRhdGFTdG9yZSBjb250YWlucyBhIGxpc3Qgb2YgRGF0YVNlcnZpY2VzLCBlYWNoIGFjY2Vzc2libGUgdmlhIGl0cyDigJhzZXJ2aWNlTmFtZeKAmS5cclxuKCBzZWUgTWV0YWRhdGFTdG9yZS5nZXREYXRhU2VydmljZSBhbmQgTWV0YWRhdGFTdG9yZS5hZGREYXRhU2VydmljZSkuICBUaGUg4oCYYWRkRGF0YVNlcnZpY2XigJkgbWV0aG9kIGlzIGNhbGxlZCBpbnRlcm5hbGx5XHJcbmFueXRpbWUgYSBNZXRhZGF0YVN0b3JlLmZldGNoTWV0YWRhdGEgY2FsbCBvY2N1cnMgd2l0aCBhIG5ldyBkYXRhU2VydmljZSAoIG9yIHNlcnZpY2UgbmFtZSkuXHJcblxyXG4qKi9cclxuZXhwb3J0IGNsYXNzIERhdGFTZXJ2aWNlIHtcclxuICAvKiogQGhpZGRlbiBAaW50ZXJuYWwgKi9cclxuICBfJHR5cGVOYW1lOiBzdHJpbmc7IC8vIGFjdHVhbGx5IHB1dCBvbiBwcm90b3R5cGUuXHJcbiAgLyoqIFRoZSBzZXJ2aWNlTmFtZSBmb3IgdGhpcyBEYXRhU2VydmljZS4gX19SZWFkIE9ubHlfXyAqKi9cclxuICBzZXJ2aWNlTmFtZTogc3RyaW5nO1xyXG4gIC8qKiBUaGUgYWRhcHRlciBuYW1lIGZvciB0aGUgW1tJRGF0YVNlcnZpY2VBZGFwdGVyXV0gdG8gYmUgdXNlZCB3aXRoIHRoaXMgc2VydmljZS4gX19SZWFkIE9ubHlfXyAgKiovXHJcbiAgYWRhcHRlck5hbWU6IHN0cmluZztcclxuICAvKiogIFRoZSBbW0lEYXRhU2VydmljZUFkYXB0ZXJdXSBpbXBsZW1lbnRhdGlvbiBpbnN0YW5jZSBhc3NvY2lhdGVkIHdpdGggdGhpcyBFbnRpdHlNYW5hZ2VyLiBfX1JlYWQgT25seV9fICAqKi9cclxuICBhZGFwdGVySW5zdGFuY2U/OiBEYXRhU2VydmljZUFkYXB0ZXI7XHJcbiAgLyoqIFRoZSBhZGFwdGVyIG5hbWUgZm9yIHRoZSBbW0lVcmlCdWlsZGVyQWRhcHRlcl1dIHRvIGJlIHVzZWQgd2l0aCB0aGlzIHNlcnZpY2UuIF9fUmVhZCBPbmx5X18gICoqL1xyXG4gIHVyaUJ1aWxkZXJOYW1lOiBzdHJpbmc7XHJcbiAgLyoqICBUaGUgW1tJVXJpQnVpbGRlckFkYXB0ZXJdXSBpbXBsZW1lbnRhdGlvbiBpbnN0YW5jZSBhc3NvY2lhdGVkIHdpdGggdGhpcyBFbnRpdHlNYW5hZ2VyLiBfX1JlYWQgT25seV9fICAqKi9cclxuICB1cmlCdWlsZGVyPzogVXJpQnVpbGRlckFkYXB0ZXI7XHJcbiAgLyoqIFdoZXRoZXIgdGhlIHNlcnZlciBjYW4gcHJvdmlkZSBtZXRhZGF0YSBmb3IgdGhpcyBzZXJ2aWNlLiBfX1JlYWQgT25seV9fICAgKiovXHJcbiAgaGFzU2VydmVyTWV0YWRhdGE6IGJvb2xlYW47XHJcbiAgLyoqIFRoZSBbW0pzb25SZXN1bHRzQWRhcHRlcl1dIHVzZWQgdG8gcHJvY2VzcyB0aGUgcmVzdWx0cyBvZiBhbnkgcXVlcnkgYWdhaW5zdCB0aGlzIERhdGFTZXJ2aWNlLiBfX1JlYWQgT25seV9fICoqL1xyXG4gIGpzb25SZXN1bHRzQWRhcHRlcjogSnNvblJlc3VsdHNBZGFwdGVyO1xyXG4gIC8qKiBXaGV0aGVyIHRvIHVzZSBKU09OUCB3aGVuIHBlcmZvcm1pbmcgYSAnR0VUJyByZXF1ZXN0IGFnYWluc3QgdGhpcyBzZXJ2aWNlLiBfX1JlYWQgT25seV9fICAqKi9cclxuICB1c2VKc29ucDogYm9vbGVhbjtcclxuXHJcbiAgLyoqICAgRGF0YVNlcnZpY2UgY29uc3RydWN0b3JcclxuICA+ICAgICB2YXIgZGF0YVNlcnZpY2UgPSBuZXcgRGF0YVNlcnZpY2Uoe1xyXG4gID4gICAgICAgICBzZXJ2aWNlTmFtZTogYWx0U2VydmljZU5hbWUsXHJcbiAgPiAgICAgICAgIGhhc1NlcnZlck1ldGFkYXRhOiBmYWxzZVxyXG4gID4gICAgIH0pO1xyXG5cclxuICA+ICAgICB2YXIgbWV0YWRhdGFTdG9yZSA9IG5ldyBNZXRhZGF0YVN0b3JlKHtcclxuICA+ICAgICAgICAgbmFtaW5nQ29udmVudGlvbjogTmFtaW5nQ29udmVudGlvbi5jYW1lbENhc2VcclxuICA+ICAgICB9KTtcclxuXHJcbiAgPiAgICAgcmV0dXJuIG5ldyBFbnRpdHlNYW5hZ2VyKHtcclxuICA+ICAgICAgICAgZGF0YVNlcnZpY2U6IGRhdGFTZXJ2aWNlLFxyXG4gID4gICAgICAgICBtZXRhZGF0YVN0b3JlOiBtZXRhZGF0YVN0b3JlXHJcbiAgPiAgICAgfSk7XHJcbiAgQHBhcmFtIGNvbmZpZyAtIEEgY29uZmlndXJhdGlvbiBvYmplY3QuXHJcbiAgKiovXHJcbiAgY29uc3RydWN0b3IoY29uZmlnPzogRGF0YVNlcnZpY2VDb25maWcpIHtcclxuICAgIHVwZGF0ZVdpdGhDb25maWcodGhpcywgY29uZmlnKTtcclxuICB9XHJcblxyXG5cclxuICAvKipcclxuICBSZXR1cm5zIGEgY29weSBvZiB0aGlzIERhdGFTZXJ2aWNlIHdpdGggdGhlIHNwZWNpZmllZCBwcm9wZXJ0aWVzIGFwcGxpZWQuXHJcbiAgQHBhcmFtIGNvbmZpZyAtIFRoZSBjb25maWd1cmF0aW9uIG9iamVjdCB0byBhcHBseSB0byBjcmVhdGUgYSBuZXcgRGF0YVNlcnZpY2UuXHJcbiAgKiovXHJcbiAgdXNpbmcoY29uZmlnOiBEYXRhU2VydmljZUNvbmZpZykge1xyXG4gICAgaWYgKCFjb25maWcpIHJldHVybiB0aGlzO1xyXG4gICAgbGV0IHJlc3VsdCA9IG5ldyBEYXRhU2VydmljZSh0aGlzKTtcclxuICAgIHJldHVybiB1cGRhdGVXaXRoQ29uZmlnKHJlc3VsdCwgY29uZmlnKTtcclxuICB9XHJcblxyXG4gIHN0YXRpYyByZXNvbHZlKGRhdGFTZXJ2aWNlczogRGF0YVNlcnZpY2VbXSkge1xyXG4gICAgLy8gZmluYWwgZGVmYXVsdHNcclxuICAgIC8vIERlbGliZXJhdGUgdXNlIG9mICdhcyBhbnknIGJlbG93LlxyXG4gICAgKGRhdGFTZXJ2aWNlcyBhcyBhbnkpLnB1c2goe1xyXG4gICAgICBoYXNTZXJ2ZXJNZXRhZGF0YTogdHJ1ZSxcclxuICAgICAgdXNlSnNvbnA6IGZhbHNlXHJcbiAgICB9KTtcclxuICAgIGxldCBkcyA9IG5ldyBEYXRhU2VydmljZShjb3JlLnJlc29sdmVQcm9wZXJ0aWVzKGRhdGFTZXJ2aWNlcyxcclxuICAgICAgICBbXCJzZXJ2aWNlTmFtZVwiLCBcImFkYXB0ZXJOYW1lXCIsIFwidXJpQnVpbGRlck5hbWVcIiwgXCJoYXNTZXJ2ZXJNZXRhZGF0YVwiLCBcImpzb25SZXN1bHRzQWRhcHRlclwiLCBcInVzZUpzb25wXCJdKSk7XHJcblxyXG4gICAgaWYgKCFkcy5zZXJ2aWNlTmFtZSkge1xyXG4gICAgICB0aHJvdyBuZXcgRXJyb3IoXCJVbmFibGUgdG8gcmVzb2x2ZSBhICdzZXJ2aWNlTmFtZScgZm9yIHRoaXMgZGF0YVNlcnZpY2VcIik7XHJcbiAgICB9XHJcbiAgICBkcy5hZGFwdGVySW5zdGFuY2UgPSBkcy5hZGFwdGVySW5zdGFuY2UgfHwgY29uZmlnLmdldEFkYXB0ZXJJbnN0YW5jZTxEYXRhU2VydmljZUFkYXB0ZXI+KFwiZGF0YVNlcnZpY2VcIiwgZHMuYWRhcHRlck5hbWUpO1xyXG4gICAgZHMuanNvblJlc3VsdHNBZGFwdGVyID0gZHMuanNvblJlc3VsdHNBZGFwdGVyIHx8IGRzLmFkYXB0ZXJJbnN0YW5jZSEuanNvblJlc3VsdHNBZGFwdGVyO1xyXG4gICAgZHMudXJpQnVpbGRlciA9IGRzLnVyaUJ1aWxkZXIgfHwgY29uZmlnLmdldEFkYXB0ZXJJbnN0YW5jZTxVcmlCdWlsZGVyQWRhcHRlcj4oXCJ1cmlCdWlsZGVyXCIsIGRzLnVyaUJ1aWxkZXJOYW1lKTtcclxuICAgIHJldHVybiBkcztcclxuICB9XHJcblxyXG4gIC8qKiBAaGlkZGVuIEBpbnRlcm5hbCAqL1xyXG4gIHN0YXRpYyBfbm9ybWFsaXplU2VydmljZU5hbWUoc2VydmljZU5hbWU6IHN0cmluZykge1xyXG4gICAgc2VydmljZU5hbWUgPSBzZXJ2aWNlTmFtZS50cmltKCk7XHJcbiAgICBpZiAoc2VydmljZU5hbWUuc3Vic3RyKC0xKSAhPT0gXCIvXCIpIHtcclxuICAgICAgcmV0dXJuIHNlcnZpY2VOYW1lICsgJy8nO1xyXG4gICAgfSBlbHNlIHtcclxuICAgICAgcmV0dXJuIHNlcnZpY2VOYW1lO1xyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgLyoqICAqL1xyXG4gIHRvSlNPTigpIHtcclxuICAgIC8vIGRvbid0IHVzZSBkZWZhdWx0IHZhbHVlIGhlcmUgLSBiZWNhdXNlIHdlIHdhbnQgdG8gYmUgYWJsZSB0byBkaXN0aW5ndWlzaCB1bmRlZmluZWQgcHJvcHMgZm9yIGluaGVyaXRlbmNlIHB1cnBvc2VzLlxyXG4gICAgcmV0dXJuIGNvcmUudG9Kc29uKHRoaXMsIHtcclxuICAgICAgc2VydmljZU5hbWU6IG51bGwsXHJcbiAgICAgIGFkYXB0ZXJOYW1lOiBudWxsLFxyXG4gICAgICB1cmlCdWlsZGVyTmFtZTogbnVsbCxcclxuICAgICAgaGFzU2VydmVyTWV0YWRhdGE6IG51bGwsXHJcbiAgICAgIGpzb25SZXN1bHRzQWRhcHRlcjogZnVuY3Rpb24gKHY6IGFueSkge1xyXG4gICAgICAgIHJldHVybiB2ICYmIHYubmFtZTtcclxuICAgICAgfSxcclxuICAgICAgdXNlSnNvbnA6IG51bGxcclxuICAgIH0pO1xyXG4gIH1cclxuXHJcbiAgc3RhdGljIGZyb21KU09OKGpzb246IGFueSkge1xyXG4gICAganNvbi5qc29uUmVzdWx0c0FkYXB0ZXIgPSBjb25maWcuX2ZldGNoT2JqZWN0KEpzb25SZXN1bHRzQWRhcHRlciwganNvbi5qc29uUmVzdWx0c0FkYXB0ZXIpO1xyXG4gICAgcmV0dXJuIG5ldyBEYXRhU2VydmljZShqc29uKTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICBSZXR1cm5zIGEgdXJsIGZvciB0aGlzIGRhdGFTZXJ2aWNlIHdpdGggdGhlIHNwZWNpZmllZCBzdWZmaXguIFRoaXMgbWV0aG9kIGhhbmRsZXMgZGF0YVNlcnZpY2UgbmFtZXMgZWl0aGVyXHJcbiAgIHdpdGggb3Igd2l0aG91dCB0cmFpbGluZyAnLydzLiAgSWYgdGhlIHN1ZmZpeCBzdGFydHMgd2l0aCBcImh0dHBcIiB0aGVuIGl0IHdpbGwgYmUgcmV0dXJuZWQgYXMtaXMuXHJcbiAgIEBtZXRob2QgcXVhbGlmeVVybFxyXG4gICBAcGFyYW0gc3VmZml4IHtTdHJpbmd9IFRoZSByZXN1bHRpbmcgdXJsLlxyXG4gICBAcmV0dXJuIHthIFVybCBzdHJpbmd9XHJcbiAgICoqL1xyXG4gIHF1YWxpZnlVcmwoc3VmZml4OiBzdHJpbmcpIHtcclxuICAgIGlmIChzdWZmaXggJiYgc3VmZml4LnN0YXJ0c1dpdGgoXCJodHRwXCIpKSB7XHJcbiAgICAgIHJldHVybiBzdWZmaXg7XHJcbiAgICB9XHJcbiAgICBsZXQgdXJsID0gdGhpcy5zZXJ2aWNlTmFtZTtcclxuICAgIC8vIHJlbW92ZSBhbnkgdHJhaWxpbmcgXCIvXCJcclxuICAgIGlmIChjb3JlLnN0cmluZ0VuZHNXaXRoKHVybCwgXCIvXCIpKSB7XHJcbiAgICAgIHVybCA9IHVybC5zdWJzdHIoMCwgdXJsLmxlbmd0aCAtIDEpO1xyXG4gICAgfVxyXG4gICAgLy8gZW5zdXJlIHRoYXQgaXQgZW5kcyB3aXRoIFwiL1wiICsgc3VmZml4XHJcbiAgICBzdWZmaXggPSBcIi9cIiArIHN1ZmZpeDtcclxuICAgIGlmICghY29yZS5zdHJpbmdFbmRzV2l0aCh1cmwsIHN1ZmZpeCkpIHtcclxuICAgICAgdXJsID0gdXJsICsgc3VmZml4O1xyXG4gICAgfVxyXG4gICAgcmV0dXJuIHVybDtcclxuICB9XHJcblxyXG59XHJcbkRhdGFTZXJ2aWNlLnByb3RvdHlwZS5fJHR5cGVOYW1lID0gXCJEYXRhU2VydmljZVwiO1xyXG5cclxuZnVuY3Rpb24gdXBkYXRlV2l0aENvbmZpZyhvYmo6IERhdGFTZXJ2aWNlLCBkc0NvbmZpZz86IERhdGFTZXJ2aWNlQ29uZmlnKSB7XHJcbiAgaWYgKGRzQ29uZmlnKSB7XHJcbiAgICBhc3NlcnRDb25maWcoZHNDb25maWcpXHJcbiAgICAgICAgLndoZXJlUGFyYW0oXCJzZXJ2aWNlTmFtZVwiKS5pc09wdGlvbmFsKClcclxuICAgICAgICAud2hlcmVQYXJhbShcImFkYXB0ZXJOYW1lXCIpLmlzU3RyaW5nKCkuaXNPcHRpb25hbCgpXHJcbiAgICAgICAgLndoZXJlUGFyYW0oXCJ1cmlCdWlsZGVyTmFtZVwiKS5pc1N0cmluZygpLmlzT3B0aW9uYWwoKVxyXG4gICAgICAgIC53aGVyZVBhcmFtKFwiaGFzU2VydmVyTWV0YWRhdGFcIikuaXNCb29sZWFuKCkuaXNPcHRpb25hbCgpXHJcbiAgICAgICAgLndoZXJlUGFyYW0oXCJqc29uUmVzdWx0c0FkYXB0ZXJcIikuaXNJbnN0YW5jZU9mKEpzb25SZXN1bHRzQWRhcHRlcikuaXNPcHRpb25hbCgpXHJcbiAgICAgICAgLndoZXJlUGFyYW0oXCJ1c2VKc29ucFwiKS5pc0Jvb2xlYW4oKS5pc09wdGlvbmFsKClcclxuICAgICAgICAuYXBwbHlBbGwob2JqKTtcclxuICAgIG9iai5zZXJ2aWNlTmFtZSA9IG9iai5zZXJ2aWNlTmFtZSAmJiBEYXRhU2VydmljZS5fbm9ybWFsaXplU2VydmljZU5hbWUob2JqLnNlcnZpY2VOYW1lKTtcclxuICAgIG9iai5hZGFwdGVySW5zdGFuY2UgPSBvYmouYWRhcHRlck5hbWUgPyAgY29uZmlnLmdldEFkYXB0ZXJJbnN0YW5jZTxEYXRhU2VydmljZUFkYXB0ZXI+KFwiZGF0YVNlcnZpY2VcIiwgb2JqLmFkYXB0ZXJOYW1lKSA6IHVuZGVmaW5lZDtcclxuICAgIG9iai51cmlCdWlsZGVyID0gb2JqLnVyaUJ1aWxkZXJOYW1lID8gY29uZmlnLmdldEFkYXB0ZXJJbnN0YW5jZTxVcmlCdWlsZGVyQWRhcHRlcj4oXCJ1cmlCdWlsZGVyXCIsIG9iai51cmlCdWlsZGVyTmFtZSkgOiB1bmRlZmluZWQ7XHJcbiAgfVxyXG4gIHJldHVybiBvYmo7XHJcbn1cclxuXHJcbmV4cG9ydCBpbnRlcmZhY2UgTm9kZU1ldGEge1xyXG4gIGVudGl0eVR5cGU/OiBFbnRpdHlUeXBlO1xyXG4gIG5vZGVJZD86IHN0cmluZztcclxuICBub2RlUmVmSWQ/OiBzdHJpbmc7XHJcbiAgaWdub3JlPzogYm9vbGVhbjtcclxuICBwYXNzVGhydT86IGJvb2xlYW47XHJcbiAgZXh0cmFNZXRhZGF0YT86IGFueTtcclxufVxyXG5cclxuZXhwb3J0IGludGVyZmFjZSBOb2RlQ29udGV4dCB7XHJcbiAgbm9kZVR5cGU6IHN0cmluZztcclxuICBwcm9wZXJ0eU5hbWU/OiBzdHJpbmc7XHJcbiAgbmF2aWdhdGlvblByb3BlcnR5PzogTmF2aWdhdGlvblByb3BlcnR5O1xyXG59XHJcblxyXG4vKiogQ29uZmlndXJhdGlvbiBpbmZvIHRvIGJlIHBhc3NlZCB0byB0aGUgW1tKc29uUmVzdWx0c0FkYXB0ZXJdXSBjb25zdHJ1Y3RvciAqL1xyXG5leHBvcnQgaW50ZXJmYWNlIEpzb25SZXN1bHRzQWRhcHRlckNvbmZpZyB7XHJcbiAgLyoqIFRoZSBuYW1lIG9mIHRoaXMgYWRhcHRlci4gIFRoaXMgbmFtZSBpcyB1c2VkIHRvIHVuaXF1ZWx5IGlkZW50aWZ5IGFuZCBsb2NhdGUgdGhpcyBpbnN0YW5jZSB3aGVuIGFuICdleHBvcnRlZCcgSnNvblJlc3VsdHNBZGFwdGVyIGlzIGxhdGVyIGltcG9ydGVkLiAqL1xyXG4gIG5hbWU6IHN0cmluZztcclxuICAvKiogQSBGdW5jdGlvbiB0aGF0IGlzIGNhbGxlZCBvbmNlIHBlciBxdWVyeSBvcGVyYXRpb24gdG8gZXh0cmFjdCB0aGUgJ3BheWxvYWQnIGZyb20gYW55IGpzb24gcmVjZWl2ZWQgb3ZlciB0aGUgd2lyZS4gXHJcbiAgVGhpcyBtZXRob2QgaGFzIGEgZGVmYXVsdCBpbXBsZW1lbnRhdGlvbiB3aGljaCB0byBzaW1wbHkgcmV0dXJuIHRoZSBcInJlc3VsdHNcIiBwcm9wZXJ0eSBmcm9tIGFueSBqc29uIHJldHVybmVkIGFzIGEgcmVzdWx0IG9mIGV4ZWN1dGluZyB0aGUgcXVlcnkuIFxyXG4gICovXHJcbiAgZXh0cmFjdFJlc3VsdHM/OiBGdW5jdGlvbjtcclxuICAvKiogQSBmdW5jdGlvbiB0aGF0IGlzIGNhbGxlZCBvbmNlIHBlciBzYXZlIG9wZXJhdGlvbiB0byBleHRyYWN0IHRoZSBlbnRpdGllcyBmcm9tIGFueSBqc29uIHJlY2VpdmVkIG92ZXIgdGhlIHdpcmUuICBNdXN0IHJldHVybiBhbiBhcnJheS5cclxuICBUaGlzIG1ldGhvZCBoYXMgYSBkZWZhdWx0IGltcGxlbWVudGF0aW9uIHdoaWNoIHNpbXBseSByZXR1cm5zIHRoZSBcImVudGl0aWVzXCIgcHJvcGVydHkgZnJvbSBhbnkganNvbiByZXR1cm5lZCBhcyBhIHJlc3VsdCBvZiBleGVjdXRpbmcgdGhlIHNhdmUuICovXHJcbiAgZXh0cmFjdFNhdmVSZXN1bHRzPzogRnVuY3Rpb247XHJcbiAgLyoqIEEgZnVuY3Rpb24gdGhhdCBpcyBjYWxsZWQgb25jZSBwZXIgc2F2ZSBvcGVyYXRpb24gdG8gZXh0cmFjdCB0aGUga2V5IG1hcHBpbmdzIGZyb20gYW55IGpzb24gcmVjZWl2ZWQgb3ZlciB0aGUgd2lyZS4gIE11c3QgcmV0dXJuIGFuIGFycmF5LlxyXG4gIFRoaXMgbWV0aG9kIGhhcyBhIGRlZmF1bHQgaW1wbGVtZW50YXRpb24gd2hpY2ggc2ltcGx5IHJldHVybnMgdGhlIFwia2V5TWFwcGluZ3NcIiBwcm9wZXJ0eSBmcm9tIGFueSBqc29uIHJldHVybmVkIGFzIGEgcmVzdWx0IG9mIGV4ZWN1dGluZyB0aGUgc2F2ZS4gKi9cclxuICBleHRyYWN0S2V5TWFwcGluZ3M/OiAoZGF0YToge30pID0+IEtleU1hcHBpbmdbXTtcclxuICAvKiogQSBmdW5jdGlvbiB0aGF0IGlzIGNhbGxlZCBvbmNlIHBlciBzYXZlIG9wZXJhdGlvbiB0byBleHRyYWN0IGFueSBkZWxldGVkIGtleXMgZnJvbSBhbnkganNvbiByZWNlaXZlZCBvdmVyIHRoZSB3aXJlLiAgTXVzdCByZXR1cm4gYW4gYXJyYXkuXHJcbiAgVGhpcyBtZXRob2QgaGFzIGEgZGVmYXVsdCBpbXBsZW1lbnRhdGlvbiB3aGljaCBzaW1wbHkgcmV0dXJucyBhbiBlbXB0eSBhcnJheS4gKi9cclxuICBleHRyYWN0RGVsZXRlZEtleXM/OiAoZGF0YToge30pID0+IGFueVtdOyAvLyBUT0RPOiByZWZpbmVcclxuICAvKiogQSB2aXNpdG9yIG1ldGhvZCB0aGF0IHdpbGwgYmUgY2FsbGVkIG9uIGVhY2ggbm9kZSBvZiB0aGUgcmV0dXJuZWQgcGF5bG9hZC4gKi9cclxuICB2aXNpdE5vZGU/OiAodjogYW55LCBtYz86IE1hcHBpbmdDb250ZXh0LCBub2RlQ29udGV4dD86IE5vZGVDb250ZXh0KSA9PiBOb2RlTWV0YTtcclxuXHJcbn1cclxuXHJcbi8qKlxyXG5BIEpzb25SZXN1bHRzQWRhcHRlciBpbnN0YW5jZSBpcyB1c2VkIHRvIHByb3ZpZGUgY3VzdG9tIGV4dHJhY3Rpb24gYW5kIHBhcnNpbmcgbG9naWMgb24gdGhlIGpzb24gcmVzdWx0cyByZXR1cm5lZCBieSBhbnkgd2ViIHNlcnZpY2UuXHJcblRoaXMgZmFjaWxpdHkgbWFrZXMgaXQgcG9zc2libGUgZm9yIGJyZWV6ZSB0byB0YWxrIHRvIHZpcnR1YWxseSBhbnkgd2ViIHNlcnZpY2UgYW5kIHJldHVybiBvYmplY3RzIHRoYXQgd2lsbCBiZSBmaXJzdCBjbGFzcyAnYnJlZXplJyBjaXRpemVucy5cclxuKiovXHJcbmV4cG9ydCBjbGFzcyBKc29uUmVzdWx0c0FkYXB0ZXIge1xyXG4gIC8qKiBAaGlkZGVuIEBpbnRlcm5hbCAqL1xyXG4gIF8kdHlwZU5hbWU6IHN0cmluZzsgLy8gYWN0dWFsbHkgcHV0IG9uIHByb3RvdHlwZS5cclxuICAvKiogVGhlIG5hbWUgb2YgdGhpcyBhZGFwdGVyLiAgVGhpcyBuYW1lIGlzIHVzZWQgdG8gdW5pcXVlbHkgaWRlbnRpZnkgYW5kIGxvY2F0ZSB0aGlzIGluc3RhbmNlIHdoZW4gYW4gJ2V4cG9ydGVkJyBKc29uUmVzdWx0c0FkYXB0ZXIgaXMgbGF0ZXIgaW1wb3J0ZWQuICovXHJcbiAgbmFtZTogc3RyaW5nO1xyXG4gIC8qKiBBIEZ1bmN0aW9uIHRoYXQgaXMgY2FsbGVkIG9uY2UgcGVyIHF1ZXJ5IG9wZXJhdGlvbiB0byBleHRyYWN0IHRoZSAncGF5bG9hZCcgZnJvbSBhbnkganNvbiByZWNlaXZlZCBvdmVyIHRoZSB3aXJlLiBcclxuICBUaGlzIG1ldGhvZCBoYXMgYSBkZWZhdWx0IGltcGxlbWVudGF0aW9uIHdoaWNoIHNpbXBseSByZXR1cm5zIHRoZSBcInJlc3VsdHNcIiBwcm9wZXJ0eSBmcm9tIGFueSBqc29uIHJldHVybmVkIGFzIGEgcmVzdWx0IG9mIGV4ZWN1dGluZyB0aGUgcXVlcnkuICovXHJcbiAgZXh0cmFjdFJlc3VsdHM6IEZ1bmN0aW9uOyAvLyBUT0RPIC0gcmVmaW5lXHJcbiAgLyoqIEEgZnVuY3Rpb24gdGhhdCBpcyBjYWxsZWQgb25jZSBwZXIgc2F2ZSBvcGVyYXRpb24gdG8gZXh0cmFjdCB0aGUgZW50aXRpZXMgZnJvbSBhbnkganNvbiByZWNlaXZlZCBvdmVyIHRoZSB3aXJlLiAgTXVzdCByZXR1cm4gYW4gYXJyYXkuXHJcbiAgVGhpcyBtZXRob2QgaGFzIGEgZGVmYXVsdCBpbXBsZW1lbnRhdGlvbiB3aGljaCBzaW1wbHkgcmV0dXJucyB0aGUgXCJlbnRpdGllc1wiIHByb3BlcnR5IGZyb20gYW55IGpzb24gcmV0dXJuZWQgYXMgYSByZXN1bHQgb2YgZXhlY3V0aW5nIHRoZSBzYXZlLiAqL1xyXG4gIGV4dHJhY3RTYXZlUmVzdWx0czogRnVuY3Rpb247XHJcbiAgICAvKiogQSBmdW5jdGlvbiB0aGF0IGlzIGNhbGxlZCBvbmNlIHBlciBzYXZlIG9wZXJhdGlvbiB0byBleHRyYWN0IHRoZSBrZXkgbWFwcGluZ3MgZnJvbSBhbnkganNvbiByZWNlaXZlZCBvdmVyIHRoZSB3aXJlLiAgTXVzdCByZXR1cm4gYW4gYXJyYXkuXHJcbiAgVGhpcyBtZXRob2QgaGFzIGEgZGVmYXVsdCBpbXBsZW1lbnRhdGlvbiB3aGljaCBzaW1wbHkgcmV0dXJucyB0aGUgXCJrZXlNYXBwaW5nc1wiIHByb3BlcnR5IGZyb20gYW55IGpzb24gcmV0dXJuZWQgYXMgYSByZXN1bHQgb2YgZXhlY3V0aW5nIHRoZSBzYXZlLiAqL1xyXG4gIGV4dHJhY3RLZXlNYXBwaW5nczogIChkYXRhOiB7fSkgPT4gS2V5TWFwcGluZ1tdO1xyXG4gIC8qKiBBIGZ1bmN0aW9uIHRoYXQgaXMgY2FsbGVkIG9uY2UgcGVyIHNhdmUgb3BlcmF0aW9uIHRvIGV4dHJhY3QgYW55IGRlbGV0ZWQga2V5cyBmcm9tIGFueSBqc29uIHJlY2VpdmVkIG92ZXIgdGhlIHdpcmUuICBNdXN0IHJldHVybiBhbiBhcnJheS5cclxuICBUaGlzIG1ldGhvZCBoYXMgYSBkZWZhdWx0IGltcGxlbWVudGF0aW9uIHdoaWNoIGlzIHRvIHNpbXBseSByZXR1cm5zIHRoZSBcImRlbGV0ZWRLZXlzXCIgcHJvcGVydHkgZnJvbSBhbnkganNvbiByZXR1cm5lZCBhcyBhIHJlc3VsdCBvZiBleGVjdXRpbmcgdGhlIHNhdmUuICovXHJcbiAgZXh0cmFjdERlbGV0ZWRLZXlzPzogKGRhdGE6IHt9KSA9PiBhbnlbXTsgLy8gVE9ETzogcmVmaW5lXHJcbiAgLyoqIEEgdmlzaXRvciBtZXRob2QgdGhhdCB3aWxsIGJlIGNhbGxlZCBvbiBlYWNoIG5vZGUgb2YgdGhlIHJldHVybmVkIHBheWxvYWQuICovXHJcbiAgdmlzaXROb2RlOiBGdW5jdGlvbjtcclxuXHJcbiAgLyoqXHJcbiAgSnNvblJlc3VsdHNBZGFwdGVyIGNvbnN0cnVjdG9yXHJcblxyXG4gIEBleGFtcGxlXHJcbiAgICAgIC8vXHJcbiAgICAgIHZhciBqc29uUmVzdWx0c0FkYXB0ZXIgPSBuZXcgSnNvblJlc3VsdHNBZGFwdGVyKHtcclxuICAgICAgICAgIG5hbWU6IFwidGVzdDFlXCIsXHJcbiAgICAgICAgICBleHRyYWN0UmVzdWx0czogZnVuY3Rpb24oanNvbikge1xyXG4gICAgICAgICAgICAgIHJldHVybiBqc29uLnJlc3VsdHM7XHJcbiAgICAgICAgICB9LFxyXG4gICAgICAgICAgdmlzaXROb2RlOiBmdW5jdGlvbihub2RlLCBtYXBwaW5nQ29udGV4dCwgbm9kZUNvbnRleHQpIHtcclxuICAgICAgICAgICAgICB2YXIgZW50aXR5VHlwZSA9IG5vcm1hbGl6ZVR5cGVOYW1lKG5vZGUuJHR5cGUpO1xyXG4gICAgICAgICAgICAgIHZhciBwcm9wZXJ0eU5hbWUgPSBub2RlQ29udGV4dC5wcm9wZXJ0eU5hbWU7XHJcbiAgICAgICAgICAgICAgdmFyIGlnbm9yZSA9IHByb3BlcnR5TmFtZSAmJiBwcm9wZXJ0eU5hbWUuc3Vic3RyKDAsIDEpID09PSBcIiRcIjtcclxuXHJcbiAgICAgICAgICAgICAgcmV0dXJuIHtcclxuICAgICAgICAgICAgICAgICAgZW50aXR5VHlwZTogZW50aXR5VHlwZSxcclxuICAgICAgICAgICAgICAgICAgbm9kZUlkOiBub2RlLiRpZCxcclxuICAgICAgICAgICAgICAgICAgbm9kZVJlZklkOiBub2RlLiRyZWYsXHJcbiAgICAgICAgICAgICAgICAgIGlnbm9yZTogaWdub3JlLFxyXG4gICAgICAgICAgICAgICAgICBwYXNzVGhydTogZmFsc2UgLy8gZGVmYXVsdFxyXG4gICAgICAgICAgICAgIH07XHJcbiAgICAgICAgICB9XHJcbiAgICAgIH0pO1xyXG5cclxuICAgICAgdmFyIGRhdGFTZXJ2aWNlID0gbmV3IERhdGFTZXJ2aWNlKCB7XHJcbiAgICAgICAgICAgICAgc2VydmljZU5hbWU6IFwiYnJlZXplL2Zvb1wiLFxyXG4gICAgICAgICAgICAgIGpzb25SZXN1bHRzQWRhcHRlcjoganNvblJlc3VsdHNBZGFwdGVyXHJcbiAgICAgIH0pO1xyXG5cclxuICAgICAgdmFyIGVudGl0eU1hbmFnZXIgPSBuZXcgRW50aXR5TWFuYWdlcigge1xyXG4gICAgICAgICAgZGF0YVNlcnZpY2U6IGRhdGFTZXJ2aWNlXHJcbiAgICAgIH0pO1xyXG5cclxuICBAcGFyYW0gY29uZmlnIC0gQSBjb25maWd1cmF0aW9uIG9iamVjdC5cclxuXHJcbiAgKiovXHJcbiAgY29uc3RydWN0b3IoanNDb25maWc6IEpzb25SZXN1bHRzQWRhcHRlckNvbmZpZykge1xyXG4gICAgaWYgKGFyZ3VtZW50cy5sZW5ndGggIT09IDEpIHtcclxuICAgICAgdGhyb3cgbmV3IEVycm9yKFwiVGhlIEpzb25SZXN1bHRzQWRhcHRlciBjdG9yIHNob3VsZCBiZSBjYWxsZWQgd2l0aCBhIHNpbmdsZSBhcmd1bWVudCB0aGF0IGlzIGEgY29uZmlndXJhdGlvbiBvYmplY3QuXCIpO1xyXG4gICAgfVxyXG5cclxuICAgIGFzc2VydENvbmZpZyhqc0NvbmZpZylcclxuICAgICAgICAud2hlcmVQYXJhbShcIm5hbWVcIikuaXNOb25FbXB0eVN0cmluZygpXHJcbiAgICAgICAgLndoZXJlUGFyYW0oXCJleHRyYWN0UmVzdWx0c1wiKS5pc0Z1bmN0aW9uKCkuaXNPcHRpb25hbCgpLndpdGhEZWZhdWx0KGV4dHJhY3RSZXN1bHRzRGVmYXVsdClcclxuICAgICAgICAud2hlcmVQYXJhbShcImV4dHJhY3RTYXZlUmVzdWx0c1wiKS5pc0Z1bmN0aW9uKCkuaXNPcHRpb25hbCgpLndpdGhEZWZhdWx0KGV4dHJhY3RTYXZlUmVzdWx0c0RlZmF1bHQpXHJcbiAgICAgICAgLndoZXJlUGFyYW0oXCJleHRyYWN0S2V5TWFwcGluZ3NcIikuaXNGdW5jdGlvbigpLmlzT3B0aW9uYWwoKS53aXRoRGVmYXVsdChleHRyYWN0S2V5TWFwcGluZ3NEZWZhdWx0KVxyXG4gICAgICAgIC53aGVyZVBhcmFtKFwiZXh0cmFjdERlbGV0ZWRLZXlzXCIpLmlzRnVuY3Rpb24oKS5pc09wdGlvbmFsKCkud2l0aERlZmF1bHQoZXh0cmFjdERlbGV0ZWRLZXlzRGVmYXVsdClcclxuICAgICAgICAud2hlcmVQYXJhbShcInZpc2l0Tm9kZVwiKS5pc0Z1bmN0aW9uKClcclxuICAgICAgICAuYXBwbHlBbGwodGhpcyk7XHJcbiAgICBjb25maWcuX3N0b3JlT2JqZWN0KHRoaXMsIFwiSnNvblJlc3VsdHNBZGFwdGVyXCIsIHRoaXMubmFtZSk7XHJcbiAgfVxyXG5cclxufVxyXG5Kc29uUmVzdWx0c0FkYXB0ZXIucHJvdG90eXBlLl8kdHlwZU5hbWUgPSBcIkpzb25SZXN1bHRzQWRhcHRlclwiO1xyXG5cclxuZnVuY3Rpb24gZXh0cmFjdFJlc3VsdHNEZWZhdWx0KGRhdGE6IGFueSkge1xyXG4gIHJldHVybiBkYXRhLnJlc3VsdHM7XHJcbn1cclxuXHJcbmZ1bmN0aW9uIGV4dHJhY3RTYXZlUmVzdWx0c0RlZmF1bHQoZGF0YTogYW55KSB7XHJcbiAgcmV0dXJuIGRhdGEuZW50aXRpZXMgfHwgZGF0YS5FbnRpdGllcyB8fCBbXTtcclxufVxyXG5cclxuZnVuY3Rpb24gZXh0cmFjdEtleU1hcHBpbmdzRGVmYXVsdChkYXRhOiBhbnkpIHtcclxuICByZXR1cm4gZGF0YS5rZXlNYXBwaW5ncyB8fCBkYXRhLktleU1hcHBpbmdzIHx8IFtdO1xyXG59XHJcblxyXG5mdW5jdGlvbiBleHRyYWN0RGVsZXRlZEtleXNEZWZhdWx0KGRhdGE6IGFueSkge1xyXG4gIHJldHVybiBkYXRhLmRlbGV0ZWRLZXlzIHx8IGRhdGEuRGVsZXRlZEtleXMgfHwgW107XHJcbn1cclxuXHJcbiJdfQ==