import { DataProperty } from './entity-metadata';
import { EntityKey } from './entity-key';
import { EntityState } from './entity-state';
import { MergeStrategy } from './query-options';
/** @hidden @internal */
export class EntityGroup {
    constructor(entityManager, entityType) {
        this.entityManager = entityManager;
        this.entityType = entityType;
        // freeze the entityType after the first instance of this type is either created or queried.
        this.entityType.isFrozen = true;
        this._indexMap = {};
        this._entities = [];
        this._emptyIndexes = [];
    }
    attachEntity(entity, entityState, mergeStrategy) {
        // entity should already have an aspect.
        let aspect = entity.entityAspect;
        if (!aspect._initialized) {
            this.entityType._initializeInstance(entity);
        }
        delete aspect._initialized;
        let keyInGroup = aspect.getKey()._keyInGroup;
        let ix = this._indexMap[keyInGroup];
        if (ix >= 0) {
            // safecast because key was found not ix will not return a null
            let targetEntity = this._entities[ix];
            let targetEntityState = targetEntity.entityAspect.entityState;
            let wasUnchanged = targetEntityState.isUnchanged();
            if (targetEntity === entity) {
                aspect.entityState = entityState;
            }
            else if (mergeStrategy === MergeStrategy.Disallowed) {
                throw new Error("A MergeStrategy of 'Disallowed' does not allow you to attach an entity when an entity with the same key is already attached: " + aspect.getKey());
            }
            else if (mergeStrategy === MergeStrategy.OverwriteChanges || (mergeStrategy === MergeStrategy.PreserveChanges && wasUnchanged)) {
                // unwrapInstance returns an entity with server side property names - so we need to use DataProperty.getRawValueFromServer these when we apply
                // the property values back to the target.
                let rawServerEntity = this.entityManager.helper.unwrapInstance(entity);
                this.entityType._updateTargetFromRaw(targetEntity, rawServerEntity, DataProperty.getRawValueFromServer);
                targetEntity.entityAspect.setEntityState(entityState);
            }
            return targetEntity;
        }
        else {
            if (this._emptyIndexes.length === 0) {
                ix = this._entities.push(entity) - 1;
            }
            else {
                ix = this._emptyIndexes.pop();
                this._entities[ix] = entity;
            }
            this._indexMap[keyInGroup] = ix;
            aspect.entityState = entityState;
            aspect.entityGroup = this;
            aspect.entityManager = this.entityManager;
            return entity;
        }
    }
    detachEntity(entity) {
        // by this point we have already determined that this entity
        // belongs to this group.
        let aspect = entity.entityAspect;
        let keyInGroup = aspect.getKey()._keyInGroup;
        let ix = this._indexMap[keyInGroup];
        if (ix === undefined) {
            // shouldn't happen.
            throw new Error("internal error - entity cannot be found in group");
        }
        delete this._indexMap[keyInGroup];
        this._emptyIndexes.push(ix);
        this._entities[ix] = null;
        return entity;
    }
    // returns entity based on an entity key defined either as an array of key values or an EntityKey
    findEntityByKey(entityKey) {
        let keyInGroup;
        if (entityKey instanceof EntityKey) {
            keyInGroup = entityKey._keyInGroup;
        }
        else {
            keyInGroup = EntityKey.createKeyString(entityKey);
        }
        let ix = this._indexMap[keyInGroup];
        // can't use just (ix) below because 0 is valid
        let r = (ix !== undefined) ? this._entities[ix] : undefined;
        // coerce null to undefined
        return r == null ? undefined : r;
    }
    hasChanges() {
        let entities = this._entities;
        let unchanged = EntityState.Unchanged;
        for (let i = 0, len = entities.length; i < len; i++) {
            let e = entities[i];
            if (e && e.entityAspect.entityState !== unchanged) {
                return true;
            }
        }
        return false;
    }
    getChanges() {
        let entities = this._entities;
        let unchanged = EntityState.Unchanged;
        let changes = [];
        for (let i = 0, len = entities.length; i < len; i++) {
            let e = entities[i];
            if (e && e.entityAspect.entityState !== unchanged) {
                changes.push(e);
            }
        }
        return changes;
    }
    getEntities(entityStates) {
        let filter = getFilter(entityStates);
        return this._entities.filter(filter);
    }
    _checkOperation(operationName) {
        this._entities.forEach(function (entity) {
            entity && entity.entityAspect._checkOperation(operationName);
        });
        // for chaining;
        return this;
    }
    // do not expose this method. It is doing a special purpose INCOMPLETE fast detach operation
    // just for the entityManager clear method - the entityGroup will be in an inconsistent state
    // after this op, which is ok because it will be thrown away.
    // TODO: rename this to be clear that it is UNSAFE...
    _clear() {
        this._entities.forEach(function (entity) {
            if (entity != null) {
                entity.entityAspect._detach();
            }
        });
        this._entities = null;
        this._indexMap = null;
        this._emptyIndexes = null;
    }
    _updateFkVal(fkProp, oldValue, newValue) {
        let fkPropName = fkProp.name;
        this._entities.forEach(function (entity) {
            if (entity != null) {
                if (entity.getProperty(fkPropName) === oldValue) {
                    entity.setProperty(fkPropName, newValue);
                }
            }
        });
    }
    _fixupKey(tempValue, realValue) {
        // single part keys appear directly in map
        let ix = this._indexMap[tempValue];
        if (ix === undefined) {
            throw new Error("Internal Error in key fixup - unable to locate entity");
        }
        let entity = this._entities[ix];
        let keyPropName = entity.entityType.keyProperties[0].name;
        // fks on related entities will automatically get updated by this as well
        entity.setProperty(keyPropName, realValue);
        delete entity.entityAspect.hasTempKey;
        delete this._indexMap[tempValue];
        this._indexMap[realValue] = ix;
    }
    _replaceKey(oldKey, newKey) {
        let ix = this._indexMap[oldKey._keyInGroup];
        delete this._indexMap[oldKey._keyInGroup];
        this._indexMap[newKey._keyInGroup] = ix;
    }
}
function getFilter(entityStates) {
    if (entityStates.length === 0) {
        return function (e) {
            return !!e;
        };
    }
    else if (entityStates.length === 1) {
        let entityState = entityStates[0];
        return function (e) {
            return !!e && e.entityAspect.entityState === entityState;
        };
    }
    else {
        return function (e) {
            return !!e && -1 !== entityStates.indexOf(e.entityAspect.entityState);
        };
    }
}
// do not expose EntityGroup - internal only
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZW50aXR5LWdyb3VwLmpzIiwic291cmNlUm9vdCI6Im5nOi8vYnJlZXplLWNsaWVudC8iLCJzb3VyY2VzIjpbInNyYy9lbnRpdHktZ3JvdXAudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQ0EsT0FBTyxFQUFjLFlBQVksRUFBRyxNQUFNLG1CQUFtQixDQUFDO0FBQzlELE9BQU8sRUFBRSxTQUFTLEVBQUUsTUFBTSxjQUFjLENBQUM7QUFDekMsT0FBTyxFQUFFLFdBQVcsRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBRTdDLE9BQU8sRUFBRSxhQUFhLEVBQUUsTUFBTSxpQkFBaUIsQ0FBQztBQUVoRCx3QkFBd0I7QUFDeEIsTUFBTSxPQUFPLFdBQVc7SUFPdEIsWUFBWSxhQUE0QixFQUFFLFVBQXNCO1FBQzlELElBQUksQ0FBQyxhQUFhLEdBQUcsYUFBYSxDQUFDO1FBQ25DLElBQUksQ0FBQyxVQUFVLEdBQUcsVUFBVSxDQUFDO1FBQzdCLDRGQUE0RjtRQUM1RixJQUFJLENBQUMsVUFBVSxDQUFDLFFBQVEsR0FBRyxJQUFJLENBQUM7UUFDaEMsSUFBSSxDQUFDLFNBQVMsR0FBRyxFQUFFLENBQUM7UUFDcEIsSUFBSSxDQUFDLFNBQVMsR0FBRyxFQUFFLENBQUM7UUFDcEIsSUFBSSxDQUFDLGFBQWEsR0FBRyxFQUFFLENBQUM7SUFDMUIsQ0FBQztJQUdELFlBQVksQ0FBQyxNQUFjLEVBQUUsV0FBd0IsRUFBRSxhQUE2QjtRQUNsRix3Q0FBd0M7UUFDeEMsSUFBSSxNQUFNLEdBQUcsTUFBTSxDQUFDLFlBQVksQ0FBQztRQUVqQyxJQUFJLENBQUMsTUFBTSxDQUFDLFlBQVksRUFBRTtZQUN4QixJQUFJLENBQUMsVUFBVSxDQUFDLG1CQUFtQixDQUFDLE1BQU0sQ0FBQyxDQUFDO1NBQzdDO1FBQ0QsT0FBTyxNQUFNLENBQUMsWUFBWSxDQUFDO1FBRTNCLElBQUksVUFBVSxHQUFHLE1BQU0sQ0FBQyxNQUFNLEVBQUUsQ0FBQyxXQUFXLENBQUM7UUFDN0MsSUFBSSxF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R0FBRyxJQUFJLENBQUMsU0FBUyxDQUFDLE1BQU0sQ0FBQyxXQUFXLENBQUMsQ0FBQztRQUM1QyxPQUFPLElBQUksQ0FBQyxTQUFTLENBQUMsTUFBTSxDQUFDLFdBQVcsQ0FBQyxDQUFDO1FBQzFDLElBQUksQ0FBQyxTQUFTLENBQUMsTUFBTSxDQUFDLFdBQVcsQ0FBQyxHQUFHLEVBQUUsQ0FBQztJQUMxQyxDQUFDO0NBRUY7QUFFRCxTQUFTLFNBQVMsQ0FBQyxZQUEyQjtJQUM1QyxJQUFJLFlBQVksQ0FBQyxNQUFNLEtBQUssQ0FBQyxFQUFFO1FBQzdCLE9BQU8sVUFBVSxDQUFTO1lBQ3hCLE9BQU8sQ0FBQyxDQUFDLENBQUMsQ0FBQztRQUNiLENBQUMsQ0FBQztLQUNIO1NBQU0sSUFBSSxZQUFZLENBQUMsTUFBTSxLQUFLLENBQUMsRUFBRTtRQUNwQyxJQUFJLFdBQVcsR0FBRyxZQUFZLENBQUMsQ0FBQyxDQUFDLENBQUM7UUFDbEMsT0FBTyxVQUFVLENBQVM7WUFDeEIsT0FBTyxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsQ0FBQyxZQUFZLENBQUMsV0FBVyxLQUFLLFdBQVcsQ0FBQztRQUMzRCxDQUFDLENBQUM7S0FDSDtTQUFNO1FBQ0wsT0FBTyxVQUFVLENBQVM7WUFDeEIsT0FBTyxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsQ0FBQyxLQUFLLFlBQVksQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDLFlBQVksQ0FBQyxXQUFXLENBQUMsQ0FBQztRQUN4RSxDQUFDLENBQUM7S0FDSDtBQUNILENBQUM7QUFHRCw0Q0FBNEMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBFbnRpdHkgfSBmcm9tICcuL2VudGl0eS1hc3BlY3QnO1xyXG5pbXBvcnQgeyBFbnRpdHlUeXBlLCBEYXRhUHJvcGVydHkgIH0gZnJvbSAnLi9lbnRpdHktbWV0YWRhdGEnO1xyXG5pbXBvcnQgeyBFbnRpdHlLZXkgfSBmcm9tICcuL2VudGl0eS1rZXknO1xyXG5pbXBvcnQgeyBFbnRpdHlTdGF0ZSB9IGZyb20gJy4vZW50aXR5LXN0YXRlJztcclxuaW1wb3J0IHsgRW50aXR5TWFuYWdlciB9IGZyb20gJy4vZW50aXR5LW1hbmFnZXInO1xyXG5pbXBvcnQgeyBNZXJnZVN0cmF0ZWd5IH0gZnJvbSAnLi9xdWVyeS1vcHRpb25zJztcclxuXHJcbi8qKiBAaGlkZGVuIEBpbnRlcm5hbCAqL1xyXG5leHBvcnQgY2xhc3MgRW50aXR5R3JvdXAge1xyXG4gIGVudGl0eU1hbmFnZXI6IEVudGl0eU1hbmFnZXI7XHJcbiAgZW50aXR5VHlwZTogRW50aXR5VHlwZTtcclxuICBfaW5kZXhNYXA6IHsgW2luZGV4OiBzdHJpbmddOiBudW1iZXIgfTtcclxuICBfZW50aXRpZXM6IChFbnRpdHkgfCBudWxsKVtdO1xyXG4gIF9lbXB0eUluZGV4ZXM6IG51bWJlcltdO1xyXG5cclxuICBjb25zdHJ1Y3RvcihlbnRpdHlNYW5hZ2VyOiBFbnRpdHlNYW5hZ2VyLCBlbnRpdHlUeXBlOiBFbnRpdHlUeXBlKSB7XHJcbiAgICB0aGlzLmVudGl0eU1hbmFnZXIgPSBlbnRpdHlNYW5hZ2VyO1xyXG4gICAgdGhpcy5lbnRpdHlUeXBlID0gZW50aXR5VHlwZTtcclxuICAgIC8vIGZyZWV6ZSB0aGUgZW50aXR5VHlwZSBhZnRlciB0aGUgZmlyc3QgaW5zdGFuY2Ugb2YgdGhpcyB0eXBlIGlzIGVpdGhlciBjcmVhdGVkIG9yIHF1ZXJpZWQuXHJcbiAgICB0aGlzLmVudGl0eVR5cGUuaXNGcm96ZW4gPSB0cnVlO1xyXG4gICAgdGhpcy5faW5kZXhNYXAgPSB7fTtcclxuICAgIHRoaXMuX2VudGl0aWVzID0gW107XHJcbiAgICB0aGlzLl9lbXB0eUluZGV4ZXMgPSBbXTtcclxuICB9XHJcblxyXG5cclxuICBhdHRhY2hFbnRpdHkoZW50aXR5OiBFbnRpdHksIGVudGl0eVN0YXRlOiBFbnRpdHlTdGF0ZSwgbWVyZ2VTdHJhdGVneT86IE1lcmdlU3RyYXRlZ3kpIHtcclxuICAgIC8vIGVudGl0eSBzaG91bGQgYWxyZWFkeSBoYXZlIGFuIGFzcGVjdC5cclxuICAgIGxldCBhc3BlY3QgPSBlbnRpdHkuZW50aXR5QXNwZWN0O1xyXG5cclxuICAgIGlmICghYXNwZWN0Ll9pbml0aWFsaXplZCkge1xyXG4gICAgICB0aGlzLmVudGl0eVR5cGUuX2luaXRpYWxpemVJbnN0YW5jZShlbnRpdHkpO1xyXG4gICAgfVxyXG4gICAgZGVsZXRlIGFzcGVjdC5faW5pdGlhbGl6ZWQ7XHJcblxyXG4gICAgbGV0IGtleUluR3JvdXAgPSBhc3BlY3QuZ2V0S2V5KCkuX2tleUluR3JvdXA7XHJcbiAgICBsZXQgaXggPSB0aGlzLl9pbmRleE1hcFtrZXlJbkdyb3VwXTtcclxuICAgIGlmIChpeCA+PSAwKSB7XHJcbiAgICAgIC8vIHNhZmVjYXN0IGJlY2F1c2Uga2V5IHdhcyBmb3VuZCBub3QgaXggd2lsbCBub3QgcmV0dXJuIGEgbnVsbFxyXG4gICAgICBsZXQgdGFyZ2V0RW50aXR5ID0gdGhpcy5fZW50aXRpZXNbaXhdIGFzIEVudGl0eTtcclxuICAgICAgbGV0IHRhcmdldEVudGl0eVN0YXRlID0gdGFyZ2V0RW50aXR5LmVudGl0eUFzcGVjdC5lbnRpdHlTdGF0ZTtcclxuICAgICAgbGV0IHdhc1VuY2hhbmdlZCA9IHRhcmdldEVudGl0eVN0YXRlLmlzVW5jaGFuZ2VkKCk7XHJcbiAgICAgIGlmICh0YXJnZXRFbnRpdHkgPT09IGVudGl0eSkge1xyXG4gICAgICAgIGFzcGVjdC5lbnRpdHlTdGF0ZSA9IGVudGl0eVN0YXRlO1xyXG4gICAgICB9IGVsc2UgaWYgKG1lcmdlU3RyYXRlZ3kgPT09IE1lcmdlU3RyYXRlZ3kuRGlzYWxsb3dlZCkge1xyXG4gICAgICAgIHRocm93IG5ldyBFcnJvcihcIkEgTWVyZ2VTdHJhdGVneSBvZiAnRGlzYWxsb3dlZCcgZG9lcyBub3QgYWxsb3cgeW91IHRvIGF0dGFjaCBhbiBlbnRpdHkgd2hlbiBhbiBlbnRpdHkgd2l0aCB0aGUgc2FtZSBrZXkgaXMgYWxyZWFkeSBhdHRhY2hlZDogXCIgKyBhc3BlY3QuZ2V0S2V5KCkpO1xyXG4gICAgICB9IGVsc2UgaWYgKG1lcmdlU3RyYXRlZ3kgPT09IE1lcmdlU3RyYXRlZ3kuT3ZlcndyaXRlQ2hhbmdlcyB8fCAobWVyZ2VTdHJhdGVneSA9PT0gTWVyZ2VTdHJhdGVneS5QcmVzZXJ2ZUNoYW5nZXMgJiYgd2FzVW5jaGFuZ2VkKSkge1xyXG4gICAgICAgIC8vIHVud3JhcEluc3RhbmNlIHJldHVybnMgYW4gZW50aXR5IHdpdGggc2VydmVyIHNpZGUgcHJvcGVydHkgbmFtZXMgLSBzbyB3ZSBuZWVkIHRvIHVzZSBEYXRhUHJvcGVydHkuZ2V0UmF3VmFsdWVGcm9tU2VydmVyIHRoZXNlIHdoZW4gd2UgYXBwbHlcclxuICAgICAgICAvLyB0aGUgcHJvcGVydHkgdmFsdWVzIGJhY2sgdG8gdGhlIHRhcmdldC5cclxuICAgICAgICBsZXQgcmF3U2VydmVyRW50aXR5ID0gdGhpcy5lbnRpdHlNYW5hZ2VyLmhlbHBlci51bndyYXBJbnN0YW5jZShlbnRpdHkpO1xyXG4gICAgICAgIHRoaXMuZW50aXR5VHlwZS5fdXBkYXRlVGFyZ2V0RnJvbVJhdyh0YXJnZXRFbnRpdHksIHJhd1NlcnZlckVudGl0eSwgRGF0YVByb3BlcnR5LmdldFJhd1ZhbHVlRnJvbVNlcnZlcik7XHJcbiAgICAgICAgdGFyZ2V0RW50aXR5LmVudGl0eUFzcGVjdC5zZXRFbnRpdHlTdGF0ZShlbnRpdHlTdGF0ZSk7XHJcbiAgICAgIH1cclxuICAgICAgcmV0dXJuIHRhcmdldEVudGl0eTtcclxuICAgIH0gZWxzZSB7XHJcbiAgICAgIGlmICh0aGlzLl9lbXB0eUluZGV4ZXMubGVuZ3RoID09PSAwKSB7XHJcbiAgICAgICAgaXggPSB0aGlzLl9lbnRpdGllcy5wdXNoKGVudGl0eSkgLSAxO1xyXG4gICAgICB9IGVsc2Uge1xyXG4gICAgICAgIGl4ID0gdGhpcy5fZW1wdHlJbmRleGVzLnBvcCgpO1xyXG4gICAgICAgIHRoaXMuX2VudGl0aWVzW2l4XSA9IGVudGl0eTtcclxuICAgICAgfVxyXG4gICAgICB0aGlzLl9pbmRleE1hcFtrZXlJbkdyb3VwXSA9IGl4O1xyXG4gICAgICBhc3BlY3QuZW50aXR5U3RhdGUgPSBlbnRpdHlTdGF0ZTtcclxuICAgICAgYXNwZWN0LmVudGl0eUdyb3VwID0gdGhpcztcclxuICAgICAgYXNwZWN0LmVudGl0eU1hbmFnZXIgPSB0aGlzLmVudGl0eU1hbmFnZXI7XHJcbiAgICAgIHJldHVybiBlbnRpdHk7XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICBkZXRhY2hFbnRpdHkoZW50aXR5OiBFbnRpdHkpIHtcclxuICAgIC8vIGJ5IHRoaXMgcG9pbnQgd2UgaGF2ZSBhbHJlYWR5IGRldGVybWluZWQgdGhhdCB0aGlzIGVudGl0eVxyXG4gICAgLy8gYmVsb25ncyB0byB0aGlzIGdyb3VwLlxyXG4gICAgbGV0IGFzcGVjdCA9IGVudGl0eS5lbnRpdHlBc3BlY3Q7XHJcbiAgICBsZXQga2V5SW5Hcm91cCA9IGFzcGVjdC5nZXRLZXkoKS5fa2V5SW5Hcm91cDtcclxuICAgIGxldCBpeCA9IHRoaXMuX2luZGV4TWFwW2tleUluR3JvdXBdO1xyXG4gICAgaWYgKGl4ID09PSB1bmRlZmluZWQpIHtcclxuICAgICAgLy8gc2hvdWxkbid0IGhhcHBlbi5cclxuICAgICAgdGhyb3cgbmV3IEVycm9yKFwiaW50ZXJuYWwgZXJyb3IgLSBlbnRpdHkgY2Fubm90IGJlIGZvdW5kIGluIGdyb3VwXCIpO1xyXG4gICAgfVxyXG4gICAgZGVsZXRlIHRoaXMuX2luZGV4TWFwW2tleUluR3JvdXBdO1xyXG4gICAgdGhpcy5fZW1wdHlJbmRleGVzLnB1c2goaXgpO1xyXG4gICAgdGhpcy5fZW50aXRpZXNbaXhdID0gbnVsbDtcclxuICAgIHJldHVybiBlbnRpdHk7XHJcbiAgfVxyXG5cclxuXHJcbiAgLy8gcmV0dXJucyBlbnRpdHkgYmFzZWQgb24gYW4gZW50aXR5IGtleSBkZWZpbmVkIGVpdGhlciBhcyBhbiBhcnJheSBvZiBrZXkgdmFsdWVzIG9yIGFuIEVudGl0eUtleVxyXG4gIGZpbmRFbnRpdHlCeUtleShlbnRpdHlLZXk6IEVudGl0eUtleSkge1xyXG4gICAgbGV0IGtleUluR3JvdXA6IHN0cmluZztcclxuICAgIGlmIChlbnRpdHlLZXkgaW5zdGFuY2VvZiBFbnRpdHlLZXkpIHtcclxuICAgICAga2V5SW5Hcm91cCA9IGVudGl0eUtleS5fa2V5SW5Hcm91cDtcclxuICAgIH0gZWxzZSB7XHJcbiAgICAgIGtleUluR3JvdXAgPSBFbnRpdHlLZXkuY3JlYXRlS2V5U3RyaW5nKGVudGl0eUtleSk7XHJcbiAgICB9XHJcbiAgICBsZXQgaXggPSB0aGlzLl9pbmRleE1hcFtrZXlJbkdyb3VwXTtcclxuICAgIC8vIGNhbid0IHVzZSBqdXN0IChpeCkgYmVsb3cgYmVjYXVzZSAwIGlzIHZhbGlkXHJcbiAgICBsZXQgciA9IChpeCAhPT0gdW5kZWZpbmVkKSA/IHRoaXMuX2VudGl0aWVzW2l4XSA6IHVuZGVmaW5lZDtcclxuICAgIC8vIGNvZXJjZSBudWxsIHRvIHVuZGVmaW5lZFxyXG4gICAgcmV0dXJuIHIgPT0gbnVsbCA/IHVuZGVmaW5lZCA6IHI7XHJcbiAgfVxyXG5cclxuICBoYXNDaGFuZ2VzKCkge1xyXG4gICAgbGV0IGVudGl0aWVzID0gdGhpcy5fZW50aXRpZXM7XHJcbiAgICBsZXQgdW5jaGFuZ2VkID0gRW50aXR5U3RhdGUuVW5jaGFuZ2VkO1xyXG4gICAgZm9yIChsZXQgaSA9IDAsIGxlbiA9IGVudGl0aWVzLmxlbmd0aDsgaSA8IGxlbjsgaSsrKSB7XHJcbiAgICAgIGxldCBlID0gZW50aXRpZXNbaV07XHJcbiAgICAgIGlmIChlICYmIGUuZW50aXR5QXNwZWN0LmVudGl0eVN0YXRlICE9PSB1bmNoYW5nZWQpIHtcclxuICAgICAgICByZXR1cm4gdHJ1ZTtcclxuICAgICAgfVxyXG4gICAgfVxyXG4gICAgcmV0dXJuIGZhbHNlO1xyXG4gIH1cclxuXHJcbiAgZ2V0Q2hhbmdlcygpIHtcclxuICAgIGxldCBlbnRpdGllcyA9IHRoaXMuX2VudGl0aWVzO1xyXG4gICAgbGV0IHVuY2hhbmdlZCA9IEVudGl0eVN0YXRlLlVuY2hhbmdlZDtcclxuICAgIGxldCBjaGFuZ2VzOiBFbnRpdHlbXSA9IFtdO1xyXG4gICAgZm9yIChsZXQgaSA9IDAsIGxlbiA9IGVudGl0aWVzLmxlbmd0aDsgaSA8IGxlbjsgaSsrKSB7XHJcbiAgICAgIGxldCBlID0gZW50aXRpZXNbaV07XHJcbiAgICAgIGlmIChlICYmIGUuZW50aXR5QXNwZWN0LmVudGl0eVN0YXRlICE9PSB1bmNoYW5nZWQpIHtcclxuICAgICAgICBjaGFuZ2VzLnB1c2goZSk7XHJcbiAgICAgIH1cclxuICAgIH1cclxuICAgIHJldHVybiBjaGFuZ2VzO1xyXG4gIH1cclxuXHJcbiAgZ2V0RW50aXRpZXMoZW50aXR5U3RhdGVzOiBFbnRpdHlTdGF0ZVtdKSB7XHJcbiAgICBsZXQgZmlsdGVyID0gZ2V0RmlsdGVyKGVudGl0eVN0YXRlcyk7XHJcbiAgICByZXR1cm4gdGhpcy5fZW50aXRpZXMuZmlsdGVyKGZpbHRlcikgYXMgRW50aXR5W107XHJcbiAgfVxyXG5cclxuICBfY2hlY2tPcGVyYXRpb24ob3BlcmF0aW9uTmFtZTogc3RyaW5nKSB7XHJcbiAgICB0aGlzLl9lbnRpdGllcy5mb3JFYWNoKGZ1bmN0aW9uIChlbnRpdHkpIHtcclxuICAgICAgZW50aXR5ICYmIGVudGl0eS5lbnRpdHlBc3BlY3QuX2NoZWNrT3BlcmF0aW9uKG9wZXJhdGlvbk5hbWUpO1xyXG4gICAgfSk7XHJcbiAgICAvLyBmb3IgY2hhaW5pbmc7XHJcbiAgICByZXR1cm4gdGhpcztcclxuICB9XHJcblxyXG4gIC8vIGRvIG5vdCBleHBvc2UgdGhpcyBtZXRob2QuIEl0IGlzIGRvaW5nIGEgc3BlY2lhbCBwdXJwb3NlIElOQ09NUExFVEUgZmFzdCBkZXRhY2ggb3BlcmF0aW9uXHJcbiAgLy8ganVzdCBmb3IgdGhlIGVudGl0eU1hbmFnZXIgY2xlYXIgbWV0aG9kIC0gdGhlIGVudGl0eUdyb3VwIHdpbGwgYmUgaW4gYW4gaW5jb25zaXN0ZW50IHN0YXRlXHJcbiAgLy8gYWZ0ZXIgdGhpcyBvcCwgd2hpY2ggaXMgb2sgYmVjYXVzZSBpdCB3aWxsIGJlIHRocm93biBhd2F5LlxyXG4gIC8vIFRPRE86IHJlbmFtZSB0aGlzIHRvIGJlIGNsZWFyIHRoYXQgaXQgaXMgVU5TQUZFLi4uXHJcbiAgX2NsZWFyKCkge1xyXG4gICAgdGhpcy5fZW50aXRpZXMuZm9yRWFjaChmdW5jdGlvbiAoZW50aXR5KSB7XHJcbiAgICAgIGlmIChlbnRpdHkgIT0gbnVsbCkge1xyXG4gICAgICAgIGVudGl0eS5lbnRpdHlBc3BlY3QuX2RldGFjaCgpO1xyXG4gICAgICB9XHJcbiAgICB9KTtcclxuICAgICh0aGlzIGFzIGFueSkuX2VudGl0aWVzID0gbnVsbDtcclxuICAgICh0aGlzIGFzIGFueSkuX2luZGV4TWFwID0gbnVsbDtcclxuICAgICh0aGlzIGFzIGFueSkuX2VtcHR5SW5kZXhlcyA9IG51bGw7XHJcbiAgfVxyXG5cclxuICBfdXBkYXRlRmtWYWwoZmtQcm9wOiBEYXRhUHJvcGVydHksIG9sZFZhbHVlOiBhbnksIG5ld1ZhbHVlOiBhbnkpIHtcclxuICAgIGxldCBma1Byb3BOYW1lID0gZmtQcm9wLm5hbWU7XHJcbiAgICB0aGlzLl9lbnRpdGllcy5mb3JFYWNoKGZ1bmN0aW9uIChlbnRpdHkpIHtcclxuICAgICAgaWYgKGVudGl0eSAhPSBudWxsKSB7XHJcbiAgICAgICAgaWYgKGVudGl0eS5nZXRQcm9wZXJ0eShma1Byb3BOYW1lKSA9PT0gb2xkVmFsdWUpIHtcclxuICAgICAgICAgIGVudGl0eS5zZXRQcm9wZXJ0eShma1Byb3BOYW1lLCBuZXdWYWx1ZSk7XHJcbiAgICAgICAgfVxyXG4gICAgICB9XHJcbiAgICB9KTtcclxuICB9XHJcblxyXG4gIF9maXh1cEtleSh0ZW1wVmFsdWU6IGFueSwgcmVhbFZhbHVlOiBhbnkpIHtcclxuICAgIC8vIHNpbmdsZSBwYXJ0IGtleXMgYXBwZWFyIGRpcmVjdGx5IGluIG1hcFxyXG4gICAgbGV0IGl4ID0gdGhpcy5faW5kZXhNYXBbdGVtcFZhbHVlXTtcclxuICAgIGlmIChpeCA9PT0gdW5kZWZpbmVkKSB7XHJcbiAgICAgIHRocm93IG5ldyBFcnJvcihcIkludGVybmFsIEVycm9yIGluIGtleSBmaXh1cCAtIHVuYWJsZSB0byBsb2NhdGUgZW50aXR5XCIpO1xyXG4gICAgfVxyXG4gICAgbGV0IGVudGl0eSA9IHRoaXMuX2VudGl0aWVzW2l4XSBhcyBFbnRpdHk7XHJcbiAgICBsZXQga2V5UHJvcE5hbWUgPSBlbnRpdHkuZW50aXR5VHlwZS5rZXlQcm9wZXJ0aWVzWzBdLm5hbWU7XHJcbiAgICAvLyBma3Mgb24gcmVsYXRlZCBlbnRpdGllcyB3aWxsIGF1dG9tYXRpY2FsbHkgZ2V0IHVwZGF0ZWQgYnkgdGhpcyBhcyB3ZWxsXHJcbiAgICBlbnRpdHkuc2V0UHJvcGVydHkoa2V5UHJvcE5hbWUsIHJlYWxWYWx1ZSk7XHJcbiAgICBkZWxldGUgZW50aXR5LmVudGl0eUFzcGVjdC5oYXNUZW1wS2V5O1xyXG4gICAgZGVsZXRlIHRoaXMuX2luZGV4TWFwW3RlbXBWYWx1ZV07XHJcbiAgICB0aGlzLl9pbmRleE1hcFtyZWFsVmFsdWVdID0gaXg7XHJcbiAgfVxyXG5cclxuICBfcmVwbGFjZUtleShvbGRLZXk6IEVudGl0eUtleSwgbmV3S2V5OiBFbnRpdHlLZXkpIHtcclxuICAgIGxldCBpeCA9IHRoaXMuX2luZGV4TWFwW29sZEtleS5fa2V5SW5Hcm91cF07XHJcbiAgICBkZWxldGUgdGhpcy5faW5kZXhNYXBbb2xkS2V5Ll9rZXlJbkdyb3VwXTtcclxuICAgIHRoaXMuX2luZGV4TWFwW25ld0tleS5fa2V5SW5Hcm91cF0gPSBpeDtcclxuICB9XHJcblxyXG59XHJcblxyXG5mdW5jdGlvbiBnZXRGaWx0ZXIoZW50aXR5U3RhdGVzOiBFbnRpdHlTdGF0ZVtdKSB7XHJcbiAgaWYgKGVudGl0eVN0YXRlcy5sZW5ndGggPT09IDApIHtcclxuICAgIHJldHVybiBmdW5jdGlvbiAoZTogRW50aXR5KSB7XHJcbiAgICAgIHJldHVybiAhIWU7XHJcbiAgICB9O1xyXG4gIH0gZWxzZSBpZiAoZW50aXR5U3RhdGVzLmxlbmd0aCA9PT0gMSkge1xyXG4gICAgbGV0IGVudGl0eVN0YXRlID0gZW50aXR5U3RhdGVzWzBdO1xyXG4gICAgcmV0dXJuIGZ1bmN0aW9uIChlOiBFbnRpdHkpIHtcclxuICAgICAgcmV0dXJuICEhZSAmJiBlLmVudGl0eUFzcGVjdC5lbnRpdHlTdGF0ZSA9PT0gZW50aXR5U3RhdGU7XHJcbiAgICB9O1xyXG4gIH0gZWxzZSB7XHJcbiAgICByZXR1cm4gZnVuY3Rpb24gKGU6IEVudGl0eSkge1xyXG4gICAgICByZXR1cm4gISFlICYmIC0xICE9PSBlbnRpdHlTdGF0ZXMuaW5kZXhPZihlLmVudGl0eUFzcGVjdC5lbnRpdHlTdGF0ZSk7XHJcbiAgICB9O1xyXG4gIH1cclxufVxyXG5cclxuXHJcbi8vIGRvIG5vdCBleHBvc2UgRW50aXR5R3JvdXAgLSBpbnRlcm5hbCBvbmx5XHJcblxyXG5cclxuIl19