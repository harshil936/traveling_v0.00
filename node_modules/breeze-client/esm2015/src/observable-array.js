import { core } from './core';
const ɵ0 = function (...args) {
    if (this._inProgress) {
        return -1;
    }
    let goodAdds = this._getGoodAdds(args);
    if (!goodAdds.length) {
        return this.length;
    }
    this._beforeChange();
    let result;
    let objPrototype = Object.getPrototypeOf(this);
    if (objPrototype.push) {
        result = objPrototype.push.apply(this, goodAdds);
    }
    else {
        result = Array.prototype.push.apply(this, goodAdds);
    }
    processAdds(this, goodAdds);
    return result;
}, ɵ1 = function (...args) {
    if (this._inProgress) {
        return -1;
    }
    let goodAdds = args;
    this._beforeChange();
    let result;
    let objPrototype = Object.getPrototypeOf(this);
    if (objPrototype.push) {
        result = objPrototype.push.apply(this, goodAdds);
    }
    else {
        result = Array.prototype.push.apply(this, goodAdds);
    }
    processAdds(this, goodAdds);
    return result;
}, ɵ2 = function (...args) {
    let goodAdds = this._getGoodAdds(args);
    if (!goodAdds.length) {
        return this.length;
    }
    this._beforeChange();
    let result;
    let objPrototype = Object.getPrototypeOf(this);
    if (objPrototype.unshift) {
        result = objPrototype.unshift.apply(this, goodAdds);
    }
    else {
        result = Array.prototype.unshift.apply(this, goodAdds);
    }
    processAdds(this, goodAdds);
    return result;
}, ɵ3 = function () {
    this._beforeChange();
    let result;
    let objPrototype = Object.getPrototypeOf(this);
    if (objPrototype.pop) {
        result = objPrototype.pop.apply(this);
    }
    else {
        result = Array.prototype.pop.apply(this);
    }
    processRemoves(this, [result]);
    return result;
}, ɵ4 = function () {
    this._beforeChange();
    let result;
    let objPrototype = Object.getPrototypeOf(this);
    if (objPrototype.shift) {
        result = objPrototype.shift.apply(this);
    }
    else {
        result = Array.prototype.shift.apply(this);
    }
    processRemoves(this, [result]);
    return result;
}, ɵ5 = function (...args) {
    let goodAdds = this._getGoodAdds(core.arraySlice(args, 2));
    let newArgs = core.arraySlice(args, 0, 2).concat(goodAdds);
    this._beforeChange();
    let result;
    let objPrototype = Object.getPrototypeOf(this);
    if (objPrototype.splice) {
        result = objPrototype.splice.apply(this, newArgs);
    }
    else {
        result = Array.prototype.splice.apply(this, newArgs);
    }
    processRemoves(this, result);
    if (goodAdds.length) {
        processAdds(this, goodAdds);
    }
    return result;
}, ɵ6 = function () {
    return this.parent.entityAspect || this.parent.complexAspect.getEntityAspect();
}, ɵ7 = function () {
    return this.getEntityAspect();
}, ɵ8 = function () {
    let em = this.getEntityAspect().entityManager;
    return em && em._pendingPubs;
}, ɵ9 = function () {
    // default is to do nothing
};
let mixin = {
    push: ɵ0,
    _push: ɵ1,
    unshift: ɵ2,
    pop: ɵ3,
    shift: ɵ4,
    splice: ɵ5,
    getEntityAspect: ɵ6,
    _getEventParent: ɵ7,
    _getPendingPubs: ɵ8,
    _beforeChange: ɵ9
};
function updateEntityState(obsArray) {
    let entityAspect = obsArray.getEntityAspect();
    if (entityAspect.entityState.isUnchanged()) {
        entityAspect.setModified();
    }
    if (entityAspect.entityState.isModified() && !obsArray._origValues) {
        obsArray._origValues = obsArray.slice(0);
    }
}
function publish(publisher, eventName, eventArgs) {
    let pendingPubs = publisher._getPendingPubs();
    if (pendingPubs) {
        if (!publisher._pendingArgs) {
            publisher._pendingArgs = eventArgs;
            pendingPubs.push(function () {
                publisher[eventName].publish(publisher._pendingArgs);
                publisher._pendingArgs = null;
            });
        }
        else {
            combineArgs(publisher._pendingArgs, eventArgs);
        }
    }
    else {
        publisher[eventName].publish(eventArgs);
    }
}
function initializeParent(obsArray, parent, parentProperty) {
    obsArray.parent = parent;
    obsArray.parentProperty = parentProperty;
}
function processAdds(obsArray, adds) {
    obsArray._processAdds(adds);
    // this is referencing the name of the method on the complexArray not the name of the event
    //var args = { added: adds };
    //args[obsArray._typeName] = obsArray;
    publish(obsArray, "arrayChanged", { array: obsArray, added: adds });
}
function processRemoves(obsArray, removes) {
    obsArray._processRemoves(removes);
    // this is referencing the name of the method on the array not the name of the event
    publish(obsArray, "arrayChanged", { array: obsArray, removed: removes });
}
// TODO: see if this function already exists in core and can be imported.
function combineArgs(target, source) {
    for (let key in source) {
        if (key !== "array" && target.hasOwnProperty(key)) {
            let sourceValue = source[key];
            let targetValue = target[key];
            if (targetValue) {
                if (!Array.isArray(targetValue)) {
                    throw new Error("Cannot combine non array args");
                }
                Array.prototype.push.apply(targetValue, sourceValue);
            }
            else {
                target[key] = sourceValue;
            }
        }
    }
}
/** @hidden @internal */
export const observableArray = {
    mixin: mixin,
    updateEntityState: updateEntityState,
    publish: publish,
    initializeParent: initializeParent
};
export { ɵ0, ɵ1, ɵ2, ɵ3, ɵ4, ɵ5, ɵ6, ɵ7, ɵ8, ɵ9 };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoib2JzZXJ2YWJsZS1hcnJheS5qcyIsInNvdXJjZVJvb3QiOiJuZzovL2JyZWV6ZS1jbGllbnQvIiwic291cmNlcyI6WyJzcmMvb2JzZXJ2YWJsZS1hcnJheS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQUUsSUFBSSxFQUFFLE1BQU0sUUFBUSxDQUFDO1dBb0N0QixVQUFTLEdBQUcsSUFBVztJQUMzQixJQUFJLElBQUksQ0FBQyxXQUFXLEVBQUU7UUFDcEIsT0FBTyxDQUFDLENBQUMsQ0FBQztLQUNYO0lBRUQsSUFBSSxRQUFRLEdBQUcsSUFBSSxDQUFDLFlBQVksQ0FBQyxJQUFJLENBQUMsQ0FBQztJQUN2QyxJQUFJLENBQUMsUUFBUSxDQUFDLE1BQU0sRUFBRTtRQUNwQixPQUFPLElBQUksQ0FBQyxNQUFNLENBQUM7S0FDcEI7SUFDRCxJQUFJLENBQUMsYUFBYSxFQUFFLENBQUM7SUFDckIsSUFBSSxNQUFNLENBQUM7SUFDWCxJQUFJLFlBQVksR0FBRyxNQUFNLENBQUMsY0FBYyxDQUFDLElBQUksQ0FBQyxDQUFDO0lBQy9DLElBQUksWUFBWSxDQUFDLElBQUksRUFBRTtRQUNuQixNQUFNLEdBQUcsWUFBWSxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsSUFBSSxFQUFFLFFBQVEsQ0FBQyxDQUFDO0tBQ3BEO1NBQU07UUFDSCxNQUFNLEdBQUcsS0FBSyxDQUFDLFNBQVMsQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLElBQUksRUFBRSxRQUFRLENBQUMsQ0FBQztLQUN2RDtJQUNELFdBQVcsQ0FBQyxJQUFJLEVBQUUsUUFBUSxDQUFDLENBQUM7SUFDNUIsT0FBTyxNQUFNLENBQUM7QUFDaEIsQ0FBQyxPQUVNLFVBQVMsR0FBRyxJQUFXO0lBQzVCLElBQUksSUFBSSxDQUFDLFdBQVcsRUFBRTtRQUNwQixPQUFPLENBQUMsQ0FBQyxDQUFDO0tBQ1g7SUFDRCxJQUFJLFFBQVEsR0FBRyxJQUFJLENBQUM7SUFDcEIsSUFBSSxDQUFDLGFBQWEsRUFBRSxDQUFDO0lBQ3JCLElBQUksTUFBTSxDQUFDO0lBQ1gsSUFBSSxZQUFZLEdBQUcsTUFBTSxDQUFDLGNBQWMsQ0FBQyxJQUFJLENBQUMsQ0FBQztJQUMvQyxJQUFJLFlBQVksQ0FBQyxJQUFJLEVBQUU7UUFDbkIsTUFBTSxHQUFHLFlBQVksQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLElBQUksRUFBRSxRQUFRLENBQUMsQ0FBQztLQUNwRDtTQUFNO1FBQ0gsTUFBTSxHQUFHLEtBQUssQ0FBQyxTQUFTLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxJQUFJLEVBQUUsUUFBUSxDQUFDLENBQUM7S0FDdkQ7SUFDRCxXQUFXLENBQUMsSUFBSSxFQUFFLFFBQVEsQ0FBQyxDQUFDO0lBQzVCLE9BQU8sTUFBTSxDQUFDO0FBQ2hCLENBQUMsT0FFUSxVQUFTLEdBQUcsSUFBVztJQUM5QixJQUFJLFFBQVEsR0FBRyxJQUFJLENBQUMsWUFBWSxDQUFDLElBQUksQ0FBQyxDQUFDO0lBQ3ZDLElBQUksQ0FBQyxRQUFRLENBQUMsTUFBTSxFQUFFO1FBQ3BCLE9BQU8sSUFBSSxDQUFDLE1BQU0sQ0FBQztLQUNwQjtJQUNELElBQUksQ0FBQyxhQUFhLEVBQUUsQ0FBQztJQUNyQixJQUFJLE1BQU0sQ0FBQztJQUNYLElBQUksWUFBWSxHQUFHLE1BQU0sQ0FBQyxjQUFjLENBQUMsSUFBSSxDQUFDLENBQUM7SUFDL0MsSUFBSSxZQUFZLENBQUMsT0FBTyxFQUFFO1FBQ3RCLE1BQU0sR0FBRyxZQUFZLENBQUMsT0FBTyxDQUFDLEtBQUssQ0FBQyxJQUFJLEVBQUUsUUFBUSxDQUFDLENBQUM7S0FDdkQ7U0FBTTtRQUNILE1BQU0sR0FBRyxLQUFLLENBQUMsU0FBUyxDQUFDLE9BQU8sQ0FBQyxLQUFLLENBQUMsSUFBSSxFQUFFLFFBQVEsQ0FBQyxDQUFDO0tBQzFEO0lBQ0QsV0FBVyxDQUFDLElBQUksRUFBRSxRQUFRLENBQUMsQ0FBQztJQUM1QixPQUFPLE1BQU0sQ0FBQztBQUNoQixDQUFDLE9BRUk7SUFDSCxJQUFJLENBQUMsYUFBYSxFQUFFLENBQUM7SUFDckIsSUFBSSxNQUFNLENBQUM7SUFDWCxJQUFJLFlBQVksR0FBRyxNQUFNLENBQUMsY0FBYyxDQUFDLElBQUksQ0FBQyxDQUFDO0lBQy9DLElBQUksWUFBWSxDQUFDLEdBQUcsRUFBRTtRQUNsQixNQUFNLEdBQUcsWUFBWSxDQUFDLEdBQUcsQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLENBQUM7S0FDekM7U0FBTTtRQUNILE1BQU0sR0FBRyxLQUFLLENBQUMsU0FBUyxDQUFDLEdBQUcsQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLENBQUM7S0FDNUM7SUFDRCxjQUFjLENBQUMsSUFBSSxFQUFFLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQztJQUMvQixPQUFPLE1BQU0sQ0FBQztBQUNoQixDQUFDLE9BRU07SUFDTCxJQUFJLENBQUMsYUFBYSxFQUFFLENBQUM7SUFDckIsSUFBSSxNQUFNLENBQUM7SUFDWCxJQUFJLFlBQVksR0FBRyxNQUFNLENBQUMsY0FBYyxDQUFDLElBQUksQ0FBQyxDQUFDO0lBQy9DLElBQUksWUFBWSxDQUFDLEtBQUssRUFBRTtRQUNwQixNQUFNLEdBQUcsWUFBWSxDQUFDLEtBQUssQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLENBQUM7S0FDM0M7U0FBTTtRQUNILE1BQU0sR0FBRyxLQUFLLENBQUMsU0FBUyxDQUFDLEtBQUssQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLENBQUM7S0FDOUM7SUFDRCxjQUFjLENBQUMsSUFBSSxFQUFFLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQztJQUMvQixPQUFPLE1BQU0sQ0FBQztBQUNoQixDQUFDLE9BRU8sVUFBUyxHQUFHLElBQVc7SUFDN0IsSUFBSSxRQUFRLEdBQUcsSUFBSSxDQUFDLFlBQVksQ0FBQyxJQUFJLENBQUMsVUFBVSxDQUFDLElBQUksRUFBRSxDQUFDLENBQUMsQ0FBQyxDQUFDO0lBQzNELElBQUksT0FBTyxHQUFHLElBQUksQ0FBQyxVQUFVLENBQUMsSUFBSSxFQUFFLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQyxNQUFNLENBQUMsUUFBUSxDQUFDLENBQUM7SUFDM0QsSUFBSSxDQUFDLGFBQWEsRUFBRSxDQUFDO0lBQ3JCLElBQUksTUFBTSxDQUFDO0lBQ1gsSUFBSSxZQUFZLEdBQUcsTUFBTSxDQUFDLGNBQWMsQ0FBQyxJQUFJLENBQUMsQ0FBQztJQUMvQyxJQUFJLFlBQVksQ0FBQyxNQUFNLEVBQUU7UUFDckIsTUFBTSxHQUFHLFlBQVksQ0FBQyxNQUFNLENBQUMsS0FBSyxDQUFDLElBQUksRUFBRSxPQUFPLENBQUMsQ0FBQztLQUNyRDtTQUFNO1FBQ0gsTUFBTSxHQUFHLEtBQUssQ0FBQyxTQUFTLENBQUMsTUFBTSxDQUFDLEtBQUssQ0FBQyxJQUFJLEVBQUUsT0FBTyxDQUFDLENBQUM7S0FDeEQ7SUFDRCxjQUFjLENBQUMsSUFBSSxFQUFFLE1BQU0sQ0FBQyxDQUFDO0lBRTdCLElBQUksUUFBUSxDQUFDLE1BQU0sRUFBRTtRQUNuQixXQUFXLENBQUMsSUFBSSxFQUFFLFFBQVEsQ0FBQyxDQUFDO0tBQzdCO0lBQ0QsT0FBTyxNQUFNLENBQUM7QUFDaEIsQ0FBQyxPQUVnQjtJQUNmLE9BQU8sSUFBSSxDQUFDLE1BQU0sQ0FBQyxZQUFZLElBQUksSUFBSSxDQUFDLE1BQU0sQ0FBQyxhQUFhLENBQUMsZUFBZSxFQUFFLENBQUM7QUFDakYsQ0FBQyxPQUVnQjtJQUNmLE9BQU8sSUFBSSxDQUFDLGVBQWUsRUFBRSxDQUFDO0FBQ2hDLENBQUMsT0FFZ0I7SUFDZixJQUFJLEVBQUUsR0FBRyxJQUFJLENBQUMsZUFBZSxFQUFFLENBQUMsYUFBYSxDQUFDO0lBQzlDLE9BQU8sRUFBRSxJQUFJLEVBQUUsQ0FBQyxZQUFZLENBQUM7QUFDL0IsQ0FBQyxPQUVlO0lBQ2QsMkJBQTJCO0FBQzdCLENBQUM7QUFwSEgsSUFBSSxLQUFLLEdBQUc7SUFDVixJQUFJLElBbUJIO0lBRUQsS0FBSyxJQWVKO0lBRUQsT0FBTyxJQWVOO0lBRUQsR0FBRyxJQVdGO0lBRUQsS0FBSyxJQVdKO0lBRUQsTUFBTSxJQWlCTDtJQUVELGVBQWUsSUFFZDtJQUVELGVBQWUsSUFFZDtJQUVELGVBQWUsSUFHZDtJQUVELGFBQWEsSUFFWjtDQUNGLENBQUM7QUFFRixTQUFTLGlCQUFpQixDQUFDLFFBQXlCO0lBQ2xELElBQUksWUFBWSxHQUFHLFFBQVEsQ0FBQyxlQUFlLEVBQUUsQ0FBQztJQUM5QyxJQUFJLFlBQVksQ0FBQyxXQUFXLENBQUMsV0FBVyxFQUFFLEVBQUU7UUFDMUMsWUFBWSxDQUFDLFdBQVcsRUFBRSxDQUFDO0tBQzVCO0lBQ0QsSUFBSSxZQUFZLENBQUMsV0FBVyxDQUFDLFVBQVUsRUFBRSxJQUFJLENBQUMsUUFBUSxDQUFDLFdBQVcsRUFBRTtRQUNsRSxRQUFRLENBQUMsV0FBVyxHQUFHLFFBQVEsQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLENBQUM7S0FDMUM7QUFDSCxDQUFDO0FBRUQsU0FBUyxPQUFPLENBQUMsU0FBMEIsRUFBRSxTQUFpQixFQUFFLFNBQWM7SUFDNUUsSUFBSSxXQUFXLEdBQUcsU0FBUyxDQUFDLGVBQWUsRUFBRSxDQUFDO0lBQzlDLElBQUksV0FBVyxFQUFFO1FBQ2YsSUFBSSxDQUFDLFNBQVMsQ0FBQyxZQUFZLEVBQUU7WUFDM0IsU0FBUyxDQUFDLFlBQVksR0FBRyxTQUFTLENBQUM7WUFDbkMsV0FBVyxDQUFDLElBQUksQ0FBQztnQkFDZixTQUFTLENBQUMsU0FBUyxDQUFDLENBQUMsT0FBTyxDQUFDLFNBQVMsQ0FBQyxZQUFZLENBQUMsQ0FBQztnQkFDckQsU0FBUyxDQUFDLFlBQVksR0FBRyxJQUFJLENBQUM7WUFDaEMsQ0FBQyxDQUFDLENBQUM7U0FDSjthQUFNO1lBQ0wsV0FBVyxDQUFDLFNBQVMsQ0FBQyxZQUFZLEVBQUUsU0FBUyxDQUFDLENBQUM7U0FDaEQ7S0FDRjtTQUFNO1FBQ0wsU0FBUyxDQUFDLFNBQVMsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxTQUFTLENBQUMsQ0FBQztLQUN6QztBQUNILENBQUM7QUFFRCxTQUFTLGdCQUFnQixDQUFDLFFBQWEsRUFBRSxNQUFjLEVBQUUsY0FBNEI7SUFDbkYsUUFBUSxDQUFDLE1BQU0sR0FBRyxNQUFNLENBQUM7SUFDekIsUUFBUSxDQUFDLGNBQWMsR0FBRyxjQUFjLENBQUM7QUFDM0MsQ0FBQztBQUVELFNBQVMsV0FBVyxDQUFDLFFBQXlCLEVBQUUsSUFBVztJQUN6RCxRQUFRLENBQUMsWUFBWSxDQUFDLElBQUksQ0FBQyxDQUFDO0lBQzVCLDJGQUEyRjtJQUMzRiw2QkFBNkI7SUFDN0Isc0NBQXNDO0lBQ3RDLE9BQU8sQ0FBQyxRQUFRLEVBQUUsY0FBYyxFQUFFLEVBQUUsS0FBSyxFQUFFLFFBQVEsRUFBRSxLQUFLLEVBQUUsSUFBSSxFQUFFLENBQUMsQ0FBQztBQUN0RSxDQUFDO0FBRUQsU0FBUyxjQUFjLENBQUMsUUFBeUIsRUFBRSxPQUFjO0lBQy9ELFFBQVEsQ0FBQyxlQUFlLENBQUMsT0FBTyxDQUFDLENBQUM7SUFDbEMsb0ZBQW9GO0lBQ3BGLE9BQU8sQ0FBQyxRQUFRLEVBQUUsY0FBYyxFQUFFLEVBQUUsS0FBSyxFQUFFLFFBQVEsRUFBRSxPQUFPLEVBQUUsT0FBTyxFQUFFLENBQUMsQ0FBQztBQUMzRSxDQUFDO0FBRUQseUVBQXlFO0FBQ3pFLFNBQVMsV0FBVyxDQUFDLE1BQWMsRUFBRSxNQUFjO0lBQ2pELEtBQUssSUFBSSxHQUFHLElBQUksTUFBTSxFQUFFO1FBQ3RCLElBQUksR0FBRyxLQUFLLE9BQU8sSUFBSSxNQUFNLENBQUMsY0FBYyxDQUFDLEdBQUcsQ0FBQyxFQUFFO1lBQ2pELElBQUksV0FBVyxHQUFHLE1BQU0sQ0FBQyxHQUFHLENBQUMsQ0FBQztZQUM5QixJQUFJLFdBQVcsR0FBRyxNQUFNLENBQUMsR0FBRyxDQUFDLENBQUM7WUFDOUIsSUFBSSxXQUFXLEVBQUU7Z0JBQ2YsSUFBSSxDQUFDLEtBQUssQ0FBQyxPQUFPLENBQUMsV0FBVyxDQUFDLEVBQUU7b0JBQy9CLE1BQU0sSUFBSSxLQUFLLENBQUMsK0JBQStCLENBQUMsQ0FBQztpQkFDbEQ7Z0JBQ0QsS0FBSyxDQUFDLFNBQVMsQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLFdBQVcsRUFBRSxXQUFXLENBQUMsQ0FBQzthQUN0RDtpQkFBTTtnQkFDTCxNQUFNLENBQUMsR0FBRyxDQUFDLEdBQUcsV0FBVyxDQUFDO2FBQzNCO1NBQ0Y7S0FDRjtBQUNILENBQUM7QUFDRCx3QkFBd0I7QUFDeEIsTUFBTSxDQUFDLE1BQU0sZUFBZSxHQUFHO0lBQzdCLEtBQUssRUFBRSxLQUFLO0lBQ1osaUJBQWlCLEVBQUUsaUJBQWlCO0lBQ3BDLE9BQU8sRUFBRSxPQUFPO0lBQ2hCLGdCQUFnQixFQUFFLGdCQUFnQjtDQUNuQyxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgY29yZSB9IGZyb20gJy4vY29yZSc7XHJcbmltcG9ydCB7IEJyZWV6ZUV2ZW50IH0gZnJvbSAnLi9ldmVudCc7XHJcbmltcG9ydCB7IEVudGl0eUFzcGVjdCB9IGZyb20gJy4vZW50aXR5LWFzcGVjdCc7XHJcbmltcG9ydCB7IERhdGFQcm9wZXJ0eSB9IGZyb20gJy4vZW50aXR5LW1ldGFkYXRhJztcclxuXHJcbi8qKiBAaGlkZGVuICovXHJcbmV4cG9ydCBpbnRlcmZhY2UgT2JzZXJ2YWJsZUFycmF5IHtcclxuICBwdXNoOiAoLi4uYXJnczogYW55W10pID0+IG51bWJlcjtcclxuICBfcHVzaDogKC4uLmFyZ3M6IGFueVtdKSA9PiBudW1iZXI7XHJcbiAgdW5zaGlmdDogKC4uLmFyZ3M6IGFueVtdKSA9PiAgbnVtYmVyO1xyXG4gIHBvcDogKCkgPT4gYW55O1xyXG4gIHNoaWZ0OiAoKSA9PiBhbnk7XHJcbiAgc3BsaWNlOiAoLi4uYXJnczogYW55W10pID0+IGFueVtdO1xyXG4gIHNsaWNlOiAoYTogbnVtYmVyLCBiPzogbnVtYmVyKSA9PiBhbnlbXTsgLy8gaW1wbGVtZW50ZWQgb24gdGhlIG5hdGl2ZSBhcnJheVxyXG4gIGxlbmd0aDogbnVtYmVyO1xyXG4gIFxyXG4gIGdldEVudGl0eUFzcGVjdDogKCkgPT4gRW50aXR5QXNwZWN0O1xyXG4gIGFycmF5Q2hhbmdlZDogQnJlZXplRXZlbnQ8QXJyYXlDaGFuZ2VkQXJncz47XHJcbiAgcGFyZW50PzogT2JqZWN0O1xyXG4gIHBhcmVudFByb3BlcnR5PzogRGF0YVByb3BlcnR5O1xyXG4gIF9nZXRFdmVudFBhcmVudDogKCkgPT4gT2JqZWN0O1xyXG4gIF9nZXRQZW5kaW5nUHViczogKCkgPT4gYW55W107IC8vIFRPRE86IFB1YltdXHJcbiAgX2JlZm9yZUNoYW5nZTogKCkgPT4gdm9pZDtcclxuICBfcHJvY2Vzc0FkZHMoaXRlbXM6IGFueVtdKTogdm9pZDtcclxuICBfcHJvY2Vzc1JlbW92ZXMoaXRlbXM6IGFueVtdKTogdm9pZDtcclxuICBfb3JpZ1ZhbHVlczogYW55W107XHJcbiAgX3BlbmRpbmdBcmdzOiBhbnk7XHJcbn1cclxuXHJcbmV4cG9ydCBpbnRlcmZhY2UgQXJyYXlDaGFuZ2VkQXJncyB7XHJcbiAgYXJyYXk6IGFueVtdO1xyXG4gIGFkZGVkPzogYW55W107IFxyXG4gIHJlbW92ZWQ/OiBhbnlbXTtcclxufVxyXG5cclxubGV0IG1peGluID0ge1xyXG4gIHB1c2g6IGZ1bmN0aW9uKC4uLmFyZ3M6IGFueVtdKSB7XHJcbiAgICBpZiAodGhpcy5faW5Qcm9ncmVzcykge1xyXG4gICAgICByZXR1cm4gLTE7XHJcbiAgICB9XHJcblxyXG4gICAgbGV0IGdvb2RBZGRzID0gdGhpcy5fZ2V0R29vZEFkZHMoYXJncyk7XHJcbiAgICBpZiAoIWdvb2RBZGRzLmxlbmd0aCkge1xyXG4gICAgICByZXR1cm4gdGhpcy5sZW5ndGg7XHJcbiAgICB9XHJcbiAgICB0aGlzLl9iZWZvcmVDaGFuZ2UoKTtcclxuICAgIGxldCByZXN1bHQ7XHJcbiAgICBsZXQgb2JqUHJvdG90eXBlID0gT2JqZWN0LmdldFByb3RvdHlwZU9mKHRoaXMpO1xyXG4gICAgaWYgKG9ialByb3RvdHlwZS5wdXNoKSB7XHJcbiAgICAgICAgcmVzdWx0ID0gb2JqUHJvdG90eXBlLnB1c2guYXBwbHkodGhpcywgZ29vZEFkZHMpO1xyXG4gICAgfSBlbHNlIHtcclxuICAgICAgICByZXN1bHQgPSBBcnJheS5wcm90b3R5cGUucHVzaC5hcHBseSh0aGlzLCBnb29kQWRkcyk7XHJcbiAgICB9XHJcbiAgICBwcm9jZXNzQWRkcyh0aGlzLCBnb29kQWRkcyk7XHJcbiAgICByZXR1cm4gcmVzdWx0O1xyXG4gIH0sXHJcblxyXG4gIF9wdXNoOiBmdW5jdGlvbiguLi5hcmdzOiBhbnlbXSkge1xyXG4gICAgaWYgKHRoaXMuX2luUHJvZ3Jlc3MpIHtcclxuICAgICAgcmV0dXJuIC0xO1xyXG4gICAgfVxyXG4gICAgbGV0IGdvb2RBZGRzID0gYXJncztcclxuICAgIHRoaXMuX2JlZm9yZUNoYW5nZSgpO1xyXG4gICAgbGV0IHJlc3VsdDtcclxuICAgIGxldCBvYmpQcm90b3R5cGUgPSBPYmplY3QuZ2V0UHJvdG90eXBlT2YodGhpcyk7XHJcbiAgICBpZiAob2JqUHJvdG90eXBlLnB1c2gpIHtcclxuICAgICAgICByZXN1bHQgPSBvYmpQcm90b3R5cGUucHVzaC5hcHBseSh0aGlzLCBnb29kQWRkcyk7XHJcbiAgICB9IGVsc2Uge1xyXG4gICAgICAgIHJlc3VsdCA9IEFycmF5LnByb3RvdHlwZS5wdXNoLmFwcGx5KHRoaXMsIGdvb2RBZGRzKTtcclxuICAgIH1cclxuICAgIHByb2Nlc3NBZGRzKHRoaXMsIGdvb2RBZGRzKTtcclxuICAgIHJldHVybiByZXN1bHQ7XHJcbiAgfSxcclxuXHJcbiAgdW5zaGlmdDogZnVuY3Rpb24oLi4uYXJnczogYW55W10pIHtcclxuICAgIGxldCBnb29kQWRkcyA9IHRoaXMuX2dldEdvb2RBZGRzKGFyZ3MpO1xyXG4gICAgaWYgKCFnb29kQWRkcy5sZW5ndGgpIHtcclxuICAgICAgcmV0dXJuIHRoaXMubGVuZ3RoO1xyXG4gICAgfVxyXG4gICAgdGhpcy5fYmVmb3JlQ2hhbmdlKCk7XHJcbiAgICBsZXQgcmVzdWx0O1xyXG4gICAgbGV0IG9ialByb3RvdHlwZSA9IE9iamVjdC5nZXRQcm90b3R5cGVPZih0aGlzKTtcclxuICAgIGlmIChvYmpQcm90b3R5cGUudW5zaGlmdCkge1xyXG4gICAgICAgIHJlc3VsdCA9IG9ialByb3RvdHlwZS51bnNoaWZ0LmFwcGx5KHRoaXMsIGdvb2RBZGRzKTtcclxuICAgIH0gZWxzZSB7XHJcbiAgICAgICAgcmVzdWx0ID0gQXJyYXkucHJvdG90eXBlLnVuc2hpZnQuYXBwbHkodGhpcywgZ29vZEFkZHMpO1xyXG4gICAgfVxyXG4gICAgcHJvY2Vzc0FkZHModGhpcywgZ29vZEFkZHMpO1xyXG4gICAgcmV0dXJuIHJlc3VsdDtcclxuICB9LFxyXG5cclxuICBwb3A6IGZ1bmN0aW9uKCkge1xyXG4gICAgdGhpcy5fYmVmb3JlQ2hhbmdlKCk7XHJcbiAgICBsZXQgcmVzdWx0O1xyXG4gICAgbGV0IG9ialByb3RvdHlwZSA9IE9iamVjdC5nZXRQcm90b3R5cGVPZih0aGlzKTtcclxuICAgIGlmIChvYmpQcm90b3R5cGUucG9wKSB7XHJcbiAgICAgICAgcmVzdWx0ID0gb2JqUHJvdG90eXBlLnBvcC5hcHBseSh0aGlzKTtcclxuICAgIH0gZWxzZSB7XHJcbiAgICAgICAgcmVzdWx0ID0gQXJyYXkucHJvdG90eXBlLnBvcC5hcHBseSh0aGlzKTtcclxuICAgIH1cclxuICAgIHByb2Nlc3NSZW1vdmVzKHRoaXMsIFtyZXN1bHRdKTtcclxuICAgIHJldHVybiByZXN1bHQ7XHJcbiAgfSxcclxuXHJcbiAgc2hpZnQ6IGZ1bmN0aW9uKCkge1xyXG4gICAgdGhpcy5fYmVmb3JlQ2hhbmdlKCk7XHJcbiAgICBsZXQgcmVzdWx0O1xyXG4gICAgbGV0IG9ialByb3RvdHlwZSA9IE9iamVjdC5nZXRQcm90b3R5cGVPZih0aGlzKTtcclxuICAgIGlmIChvYmpQcm90b3R5cGUuc2hpZnQpIHtcclxuICAgICAgICByZXN1bHQgPSBvYmpQcm90b3R5cGUuc2hpZnQuYXBwbHkodGhpcyk7XHJcbiAgICB9IGVsc2Uge1xyXG4gICAgICAgIHJlc3VsdCA9IEFycmF5LnByb3RvdHlwZS5zaGlmdC5hcHBseSh0aGlzKTtcclxuICAgIH0gICAgXHJcbiAgICBwcm9jZXNzUmVtb3Zlcyh0aGlzLCBbcmVzdWx0XSk7XHJcbiAgICByZXR1cm4gcmVzdWx0O1xyXG4gIH0sXHJcblxyXG4gIHNwbGljZTogZnVuY3Rpb24oLi4uYXJnczogYW55W10pIHtcclxuICAgIGxldCBnb29kQWRkcyA9IHRoaXMuX2dldEdvb2RBZGRzKGNvcmUuYXJyYXlTbGljZShhcmdzLCAyKSk7XHJcbiAgICBsZXQgbmV3QXJncyA9IGNvcmUuYXJyYXlTbGljZShhcmdzLCAwLCAyKS5jb25jYXQoZ29vZEFkZHMpO1xyXG4gICAgdGhpcy5fYmVmb3JlQ2hhbmdlKCk7XHJcbiAgICBsZXQgcmVzdWx0O1xyXG4gICAgbGV0IG9ialByb3RvdHlwZSA9IE9iamVjdC5nZXRQcm90b3R5cGVPZih0aGlzKTtcclxuICAgIGlmIChvYmpQcm90b3R5cGUuc3BsaWNlKSB7XHJcbiAgICAgICAgcmVzdWx0ID0gb2JqUHJvdG90eXBlLnNwbGljZS5hcHBseSh0aGlzLCBuZXdBcmdzKTtcclxuICAgIH0gZWxzZSB7XHJcbiAgICAgICAgcmVzdWx0ID0gQXJyYXkucHJvdG90eXBlLnNwbGljZS5hcHBseSh0aGlzLCBuZXdBcmdzKTtcclxuICAgIH1cclxuICAgIHByb2Nlc3NSZW1vdmVzKHRoaXMsIHJlc3VsdCk7XHJcblxyXG4gICAgaWYgKGdvb2RBZGRzLmxlbmd0aCkge1xyXG4gICAgICBwcm9jZXNzQWRkcyh0aGlzLCBnb29kQWRkcyk7XHJcbiAgICB9XHJcbiAgICByZXR1cm4gcmVzdWx0O1xyXG4gIH0sXHJcblxyXG4gIGdldEVudGl0eUFzcGVjdDogZnVuY3Rpb24oKSB7XHJcbiAgICByZXR1cm4gdGhpcy5wYXJlbnQuZW50aXR5QXNwZWN0IHx8IHRoaXMucGFyZW50LmNvbXBsZXhBc3BlY3QuZ2V0RW50aXR5QXNwZWN0KCk7XHJcbiAgfSxcclxuXHJcbiAgX2dldEV2ZW50UGFyZW50OiBmdW5jdGlvbigpIHtcclxuICAgIHJldHVybiB0aGlzLmdldEVudGl0eUFzcGVjdCgpO1xyXG4gIH0sXHJcblxyXG4gIF9nZXRQZW5kaW5nUHViczogZnVuY3Rpb24gKCkge1xyXG4gICAgbGV0IGVtID0gdGhpcy5nZXRFbnRpdHlBc3BlY3QoKS5lbnRpdHlNYW5hZ2VyO1xyXG4gICAgcmV0dXJuIGVtICYmIGVtLl9wZW5kaW5nUHVicztcclxuICB9LFxyXG5cclxuICBfYmVmb3JlQ2hhbmdlOiAgZnVuY3Rpb24gKCkge1xyXG4gICAgLy8gZGVmYXVsdCBpcyB0byBkbyBub3RoaW5nXHJcbiAgfVxyXG59O1xyXG5cclxuZnVuY3Rpb24gdXBkYXRlRW50aXR5U3RhdGUob2JzQXJyYXk6IE9ic2VydmFibGVBcnJheSkge1xyXG4gIGxldCBlbnRpdHlBc3BlY3QgPSBvYnNBcnJheS5nZXRFbnRpdHlBc3BlY3QoKTtcclxuICBpZiAoZW50aXR5QXNwZWN0LmVudGl0eVN0YXRlLmlzVW5jaGFuZ2VkKCkpIHtcclxuICAgIGVudGl0eUFzcGVjdC5zZXRNb2RpZmllZCgpO1xyXG4gIH1cclxuICBpZiAoZW50aXR5QXNwZWN0LmVudGl0eVN0YXRlLmlzTW9kaWZpZWQoKSAmJiAhb2JzQXJyYXkuX29yaWdWYWx1ZXMpIHtcclxuICAgIG9ic0FycmF5Ll9vcmlnVmFsdWVzID0gb2JzQXJyYXkuc2xpY2UoMCk7XHJcbiAgfVxyXG59XHJcblxyXG5mdW5jdGlvbiBwdWJsaXNoKHB1Ymxpc2hlcjogT2JzZXJ2YWJsZUFycmF5LCBldmVudE5hbWU6IHN0cmluZywgZXZlbnRBcmdzOiBhbnkpIHtcclxuICBsZXQgcGVuZGluZ1B1YnMgPSBwdWJsaXNoZXIuX2dldFBlbmRpbmdQdWJzKCk7XHJcbiAgaWYgKHBlbmRpbmdQdWJzKSB7XHJcbiAgICBpZiAoIXB1Ymxpc2hlci5fcGVuZGluZ0FyZ3MpIHtcclxuICAgICAgcHVibGlzaGVyLl9wZW5kaW5nQXJncyA9IGV2ZW50QXJncztcclxuICAgICAgcGVuZGluZ1B1YnMucHVzaChmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgcHVibGlzaGVyW2V2ZW50TmFtZV0ucHVibGlzaChwdWJsaXNoZXIuX3BlbmRpbmdBcmdzKTtcclxuICAgICAgICBwdWJsaXNoZXIuX3BlbmRpbmdBcmdzID0gbnVsbDtcclxuICAgICAgfSk7XHJcbiAgICB9IGVsc2Uge1xyXG4gICAgICBjb21iaW5lQXJncyhwdWJsaXNoZXIuX3BlbmRpbmdBcmdzLCBldmVudEFyZ3MpO1xyXG4gICAgfVxyXG4gIH0gZWxzZSB7XHJcbiAgICBwdWJsaXNoZXJbZXZlbnROYW1lXS5wdWJsaXNoKGV2ZW50QXJncyk7XHJcbiAgfVxyXG59XHJcblxyXG5mdW5jdGlvbiBpbml0aWFsaXplUGFyZW50KG9ic0FycmF5OiBhbnksIHBhcmVudDogT2JqZWN0LCBwYXJlbnRQcm9wZXJ0eTogRGF0YVByb3BlcnR5KSB7XHJcbiAgb2JzQXJyYXkucGFyZW50ID0gcGFyZW50O1xyXG4gIG9ic0FycmF5LnBhcmVudFByb3BlcnR5ID0gcGFyZW50UHJvcGVydHk7XHJcbn1cclxuXHJcbmZ1bmN0aW9uIHByb2Nlc3NBZGRzKG9ic0FycmF5OiBPYnNlcnZhYmxlQXJyYXksIGFkZHM6IGFueVtdKSB7XHJcbiAgb2JzQXJyYXkuX3Byb2Nlc3NBZGRzKGFkZHMpO1xyXG4gIC8vIHRoaXMgaXMgcmVmZXJlbmNpbmcgdGhlIG5hbWUgb2YgdGhlIG1ldGhvZCBvbiB0aGUgY29tcGxleEFycmF5IG5vdCB0aGUgbmFtZSBvZiB0aGUgZXZlbnRcclxuICAvL3ZhciBhcmdzID0geyBhZGRlZDogYWRkcyB9O1xyXG4gIC8vYXJnc1tvYnNBcnJheS5fdHlwZU5hbWVdID0gb2JzQXJyYXk7XHJcbiAgcHVibGlzaChvYnNBcnJheSwgXCJhcnJheUNoYW5nZWRcIiwgeyBhcnJheTogb2JzQXJyYXksIGFkZGVkOiBhZGRzIH0pO1xyXG59XHJcblxyXG5mdW5jdGlvbiBwcm9jZXNzUmVtb3ZlcyhvYnNBcnJheTogT2JzZXJ2YWJsZUFycmF5LCByZW1vdmVzOiBhbnlbXSkge1xyXG4gIG9ic0FycmF5Ll9wcm9jZXNzUmVtb3ZlcyhyZW1vdmVzKTtcclxuICAvLyB0aGlzIGlzIHJlZmVyZW5jaW5nIHRoZSBuYW1lIG9mIHRoZSBtZXRob2Qgb24gdGhlIGFycmF5IG5vdCB0aGUgbmFtZSBvZiB0aGUgZXZlbnRcclxuICBwdWJsaXNoKG9ic0FycmF5LCBcImFycmF5Q2hhbmdlZFwiLCB7IGFycmF5OiBvYnNBcnJheSwgcmVtb3ZlZDogcmVtb3ZlcyB9KTtcclxufVxyXG5cclxuLy8gVE9ETzogc2VlIGlmIHRoaXMgZnVuY3Rpb24gYWxyZWFkeSBleGlzdHMgaW4gY29yZSBhbmQgY2FuIGJlIGltcG9ydGVkLlxyXG5mdW5jdGlvbiBjb21iaW5lQXJncyh0YXJnZXQ6IE9iamVjdCwgc291cmNlOiBPYmplY3QpIHtcclxuICBmb3IgKGxldCBrZXkgaW4gc291cmNlKSB7XHJcbiAgICBpZiAoa2V5ICE9PSBcImFycmF5XCIgJiYgdGFyZ2V0Lmhhc093blByb3BlcnR5KGtleSkpIHtcclxuICAgICAgbGV0IHNvdXJjZVZhbHVlID0gc291cmNlW2tleV07XHJcbiAgICAgIGxldCB0YXJnZXRWYWx1ZSA9IHRhcmdldFtrZXldO1xyXG4gICAgICBpZiAodGFyZ2V0VmFsdWUpIHtcclxuICAgICAgICBpZiAoIUFycmF5LmlzQXJyYXkodGFyZ2V0VmFsdWUpKSB7XHJcbiAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoXCJDYW5ub3QgY29tYmluZSBub24gYXJyYXkgYXJnc1wiKTtcclxuICAgICAgICB9XHJcbiAgICAgICAgQXJyYXkucHJvdG90eXBlLnB1c2guYXBwbHkodGFyZ2V0VmFsdWUsIHNvdXJjZVZhbHVlKTtcclxuICAgICAgfSBlbHNlIHtcclxuICAgICAgICB0YXJnZXRba2V5XSA9IHNvdXJjZVZhbHVlO1xyXG4gICAgICB9XHJcbiAgICB9XHJcbiAgfVxyXG59XHJcbi8qKiBAaGlkZGVuIEBpbnRlcm5hbCAqL1xyXG5leHBvcnQgY29uc3Qgb2JzZXJ2YWJsZUFycmF5ID0ge1xyXG4gIG1peGluOiBtaXhpbixcclxuICB1cGRhdGVFbnRpdHlTdGF0ZTogdXBkYXRlRW50aXR5U3RhdGUsXHJcbiAgcHVibGlzaDogcHVibGlzaCxcclxuICBpbml0aWFsaXplUGFyZW50OiBpbml0aWFsaXplUGFyZW50XHJcbn07XHJcbiJdfQ==