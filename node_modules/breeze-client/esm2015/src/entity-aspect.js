import { core } from './core';
import { config } from './config';
import { BreezeEvent } from './event';
import { assertParam } from './assert-param';
import { EntityState } from './entity-state';
import { EntityAction } from './entity-action';
import { EntityType } from './entity-metadata';
import { EntityKey } from './entity-key';
import { Validator, ValidationError } from './validate';
import { EntityQuery } from './entity-query';
/**
An EntityAspect instance is associated with every attached entity and is accessed via the entity's 'entityAspect' property.

The EntityAspect itself provides properties to determine and modify the EntityState of the entity and has methods
that provide a variety of services including validation and change tracking.

An EntityAspect will almost never need to be constructed directly. You will usually get an EntityAspect by accessing
an entities 'entityAspect' property.  This property will be automatically attached when an entity is created via either
a query, import or [[EntityManager.createEntity]] call.
>      // assume order is an order entity attached to an EntityManager.
>      var aspect = order.entityAspect;
>      var currentState = aspect.entityState;

**/
export class EntityAspect {
    /** @hidden @internal */
    constructor(entity) {
        // if called without new
        // if (!(this instanceof EntityAspect)) {
        //   return new EntityAspect(entity);
        // }
        /**
        Sets the entity to an EntityState of 'Unchanged'.  This is also the equivalent of calling [[EntityAspect.acceptChanges]].
        The same operation can be performed by calling [[EntityAspect.setEntityState]].
        >      // assume order is an order entity attached to an EntityManager.
        >      order.entityAspect.setUnchanged();
        >      // The 'order' entity will now be in an 'Unchanged' state with any changes committed.
        **/
        this.setUnchanged = function () {
            return this.setEntityState(EntityState.Unchanged);
        };
        /**
        Sets the entity to an EntityState of 'Modified'.  This can also be achieved by changing the value of any property on an 'Unchanged' entity.
        The same operation can be performed by calling [[EntityAspect.setEntityState]].
        >      // assume order is an order entity attached to an EntityManager.
        >      order.entityAspect.setModified();
        >      // The 'order' entity will now be in a 'Modified' state.
        **/
        this.setModified = function () {
            return this.setEntityState(EntityState.Modified);
        };
        /**
        Sets the entity to an EntityState of 'Deleted'.  This both marks the entity as being scheduled for deletion during the next 'Save' call
        but also removes the entity from all of its related entities.
        The same operation can be performed by calling [[EntityAspect.setEntityState]].
        >      // assume order is an order entity attached to an EntityManager.
        >      order.entityAspect.setDeleted();
        >      // The 'order' entity will now be in a 'Deleted' state and it will no longer have any 'related' entities.
        **/
        this.setDeleted = function () {
            return this.setEntityState(EntityState.Deleted);
        };
        /**
        Sets the entity to an EntityState of 'Detached'.  This removes the entity from all of its related entities, but does NOT change the EntityState of any existing entities.
        The same operation can be performed by calling [[EntityAspect.setEntityState]].
        >      // assume order is an order entity attached to an EntityManager.
        >      order.entityAspect.setDetached();
        >      // The 'order' entity will now be in a 'Detached' state and it will no longer have any 'related' entities.
        **/
        this.setDetached = function () {
            return this.setEntityState(EntityState.Detached);
        };
        this.entity = entity;
        // TODO: keep public or not?
        this.entityGroup = undefined;
        this.entityManager = undefined;
        this.entityState = EntityState.Detached;
        this.isBeingSaved = false;
        this.originalValues = {};
        this.hasValidationErrors = false;
        this._validationErrors = {};
        // Uncomment when we implement entityAspect.isNavigationPropertyLoaded method
        // this._loadedNavPropMap = {};
        this.validationErrorsChanged = new BreezeEvent("validationErrorsChanged", this);
        this.propertyChanged = new BreezeEvent("propertyChanged", this);
        // in case this is the NULL entityAspect. - used with ComplexAspects that have no parent.
        if (entity != null) {
            // remove properties that should be on prototype but placed on class by Babel
            if (!entity.entityType) {
                delete (entity.entityType);
            }
            if (!entity.entityAspect) {
                delete (entity.entityAspect);
            }
            entity.entityAspect = this;
            // entityType should already be on the entity from 'watch'
            let entityType = entity.entityType || entity._$entityType;
            if (!entityType) {
                let typeName = entity.prototype._$typeName;
                if (!typeName) {
                    throw new Error("This entity is not registered as a valid EntityType");
                }
                else {
                    throw new Error("Metadata for this entityType has not yet been resolved: " + typeName);
                }
            }
            let entityCtor = entityType.getEntityCtor();
            config.interfaceRegistry.modelLibrary.getDefaultInstance().startTracking(entity, entityCtor.prototype);
        }
    }
    /** @hidden */
    // type-guard
    static isEntity(obj) {
        return obj.entityAspect != null;
    }
    // No longer used
    // static createFrom(entity: Entity): EntityAspect {
    //   if (entity == null) {
    //     return EntityAspect._nullInstance;
    //   } else if (entity.entityAspect) {
    //     return entity.entityAspect;
    //   }
    //   return new EntityAspect(entity);
    // }
    // TODO: refactor this and the instance getPropertyValue method.
    /**
    Returns the value of a specified 'property path' for a specified entity.
  
    The propertyPath can be either a string delimited with '.' or a string array.
    **/
    // used by EntityQuery and Predicate
    static getPropertyPathValue(obj, propertyPath) {
        let properties = Array.isArray(propertyPath) ? propertyPath : propertyPath.split(".");
        if (properties.length === 1) {
            return obj.getProperty(propertyPath);
        }
        else {
            let nextValue = obj;
            // hack use of some to perform mapFirst operation.
            properties.some((prop) => {
                nextValue = nextValue.getProperty(prop);
                return nextValue == null;
            });
            return nextValue;
        }
    }
    /**
    Returns the [[EntityKey]] for this Entity.
    >      // assume order is an order entity attached to an EntityManager.
    >      var entityKey = order.entityAspect.getKey();
    @param forceRefresh - (boolean=false) Forces the recalculation of the key.  This should normally be unnecessary.
    @return The [[EntityKey]] associated with this Entity.
    **/
    getKey(forceRefresh = false) {
        forceRefresh = assertParam(forceRefresh, "forceRefresh").isBoolean().isOptional().check(false);
        if (forceRefresh || !this._entityKey) {
            let entityType = this.entity.entityType;
            let keyProps = entityType.keyProperties;
            let values = keyProps.map(function (p) {
                return this.entity.getProperty(p.name);
            }, this);
            this._entityKey = new EntityKey(entityType, values);
        }
        return this._entityKey;
    }
    /**
    Returns the entity to an [[EntityState]] of 'Unchanged' by committing all changes made since the entity was last queried
    had 'acceptChanges' called on it.
    >      // assume order is an order entity attached to an EntityManager.
    >      order.entityAspect.acceptChanges();
    >      // The 'order' entity will now be in an 'Unchanged' state with any changes committed.
    **/
    acceptChanges() {
        if (!this.entity)
            return;
        this._checkOperation("acceptChanges");
        let em = this.entityManager;
        if (this.entityState.isDeleted()) {
            em.detachEntity(this.entity);
        }
        else {
            this.setUnchanged();
        }
        em.entityChanged.publish({ entityAction: EntityAction.AcceptChanges, entity: this.entity });
    }
    /**
    Returns the entity to an [[EntityState]] of 'Unchanged' by rejecting all changes made to it since the entity was last queried
    had 'rejectChanges' called on it.
    >      // assume order is an order entity attached to an EntityManager.
    >      order.entityAspect.rejectChanges();
    >      // The 'order' entity will now be in an 'Unchanged' state with any changes rejected.
    **/
    rejectChanges() {
        this._checkOperation("rejectChanges");
        let entity = this.entity;
        let entityManager = this.entityManager;
        // we do not want PropertyChange or EntityChange events to occur here
        core.using(entityManager, "isRejectingChanges", true, function () {
            rejectChangesCore(entity);
        });
        if (this.entityState.isAdded()) {
            // next line is needed because the following line will cause this.entityManager -> null;
            entityManager.detachEntity(entity);
            // need to tell em that an entity that needed to be saved no longer does.
            entityManager._notifyStateChange(entity, false);
        }
        else {
            if (this.entityState.isDeleted()) {
                entityManager._linkRelatedEntities(entity);
            }
            this.setUnchanged();
            // propertyChanged propertyName is not specified because more than one property may have changed.
            this.propertyChanged.publish({ entity: entity, propertyName: null });
            entityManager.entityChanged.publish({ entityAction: EntityAction.RejectChanges, entity: entity });
        }
    }
    /**  @hidden @internal */
    // TODO: rename - and use '_'; used on both EntityAspect and ComplexAspect for polymorphic reasons.
    getPropertyPath(propName) {
        return propName;
    }
    /**
    Sets the entity to an EntityState of 'Added'.  This is NOT the equivalent of calling [[EntityManager.addEntity]]
    because no key generation will occur for autogenerated keys as a result of this operation. As a result this operation can be problematic
    unless you are certain that the entity being marked 'Added' does not already exist in the database and does not have an autogenerated key.
    The same operation can be performed by calling [[EntityAspect.setEntityState]].
    >      // assume order is an order entity attached to an EntityManager.
    >      order.entityAspect.setAdded();
    >      // The 'order' entity will now be in an 'Added' state.
    **/
    setAdded() {
        return this.setEntityState(EntityState.Added);
    }
    /**
    Sets the entity to the specified EntityState. See also 'setUnchanged', 'setModified', 'setDetached', etc.
    >      // assume order is an order entity attached to an EntityManager.
    >      order.entityAspect.setEntityState(EntityState.Unchanged);
    >      // The 'order' entity will now be in a 'Unchanged' state.
    **/
    setEntityState(entityState) {
        if (this.entityState === entityState)
            return false;
        this._checkOperation("setEntityState");
        if (this.entityState.isDetached()) {
            throw new Error("You cannot set the 'entityState' of an entity when it is detached - except by first attaching it to an EntityManager");
        }
        let entity = this.entity;
        let em = this.entityManager;
        let needsSave = true;
        if (entityState === EntityState.Unchanged) {
            clearOriginalValues(entity);
            delete this.hasTempKey;
            needsSave = false;
        }
        else if (entityState === EntityState.Added) {
            clearOriginalValues(entity);
            // TODO: more to do here... like regenerating key ???
        }
        else if (entityState === EntityState.Deleted) {
            if (this.entityState.isAdded()) {
                // turn it into a detach and exit early
                this.setEntityState(EntityState.Detached);
                return true;
            }
            else {
                // TODO: think about cascade deletes
                // entityState needs to be set it early in this one case to insure that fk's are not cleared.
                this.entityState = EntityState.Deleted;
                removeFromRelations(entity, EntityState.Deleted);
            }
        }
        else if (entityState === EntityState.Modified) {
            // nothing extra needed
        }
        else if (entityState === EntityState.Detached) {
            let group = this.entityGroup;
            // no group === already detached.
            if (!group)
                return false;
            group.detachEntity(entity);
            // needs to occur early here - so this IS deliberately redundent with the same code later in this method.
            this.entityState = entityState;
            removeFromRelations(entity, EntityState.Detached);
            this._detach();
            em.entityChanged.publish({ entityAction: EntityAction.Detach, entity: entity });
            needsSave = false;
        }
        this.entityState = entityState;
        em._notifyStateChange(entity, needsSave);
        return true;
    }
    /**
    Performs a query for the value of a specified [[NavigationProperty]]. __Async__
    >      emp.entityAspect.loadNavigationProperty("Orders").then(function (data) {
    >          var orders = data.results;
    >      }).catch(function (exception) {
    >          // handle exception here;
    >      });
    @param navigationProperty - The NavigationProperty or the name of the NavigationProperty to 'load'.
    @param callback - Function to call on success.
    @param errorCallback - Function to call on failure.
    @return Promise with shape
      - results {Array of Entity}
      - query {EntityQuery} The original query
      - httpResponse {httpResponse} The HttpResponse returned from the server.
    **/
    loadNavigationProperty(navigationProperty, callback, errorCallback) {
        let entity = this.entity;
        let navProperty = entity.entityType._checkNavProperty(navigationProperty);
        let query = EntityQuery.fromEntityNavigation(entity, navProperty);
        // return entity.entityAspect.entityManager.executeQuery(query, callback, errorCallback);
        let promise = entity.entityAspect.entityManager.executeQuery(query);
        return promise.then((data) => {
            this._markAsLoaded(navProperty.name);
            if (callback)
                callback(data);
            return Promise.resolve(data);
        }, (error) => {
            if (errorCallback)
                errorCallback(error);
            return Promise.reject(error);
        });
    }
    /**
    Marks this navigationProperty on this entity as already having been loaded.
    >      emp.entityAspect.markNavigationPropertyAsLoaded("Orders");
    @param navigationProperty - The NavigationProperty or name of NavigationProperty to 'load'.
    **/
    markNavigationPropertyAsLoaded(navigationProperty) {
        if (!this.entity)
            return;
        let navProperty = this.entity.entityType._checkNavProperty(navigationProperty);
        this._markAsLoaded(navProperty.name);
    }
    /**
    Determines whether a navigationProperty on this entity has already been loaded.
  
    A navigation property is considered loaded when any of the following three conditions applies:
  
      1. It was fetched from the backend server.
          <br/>   This can be the result of an expand query or a call to the [[EntityAspect.loadNavigationProperty]] method.
          <br/>   Note that even if the fetch returns nothing the property is still marked as loaded in this case.
      1. The property is scalar and has been set to a nonnull value.
      1. The [[EntityAspect.markNavigationPropertyAsLoaded]] was called.
    
    >     var wasLoaded = emp.entityAspect.isNavigationPropertyLoaded("Orders");
    @param navigationProperty - The NavigationProperty or name of NavigationProperty to 'load'.
    **/
    isNavigationPropertyLoaded(navigationProperty) {
        if (!this.entity)
            return;
        let navProperty = this.entity.entityType._checkNavProperty(navigationProperty);
        if (navProperty.isScalar && this.entity.getProperty(navProperty.name) != null) {
            return true;
        }
        return this._loadedNps && this._loadedNps.indexOf(navProperty.name) >= 0;
    }
    /** @hidden @internal */
    _markAsLoaded(navPropName) {
        this._loadedNps = this._loadedNps || [];
        core.arrayAddItemUnique(this._loadedNps, navPropName);
    }
    /**
    Performs validation on the entity, any errors encountered during the validation are available via the
    [[EntityAspect.getValidationErrors]] method. Validating an entity means executing
    all of the validators on both the entity itself as well as those on each of its properties.
    >      // assume order is an order entity attached to an EntityManager.
    >      var isOk = order.entityAspect.validateEntity();
    >      // isOk will be 'true' if there are no errors on the entity.
    >      if (!isOk) {
    >          var errors = order.entityAspect.getValidationErrors();
    >      }
    @return Whether the entity passed validation.
    **/
    validateEntity() {
        let ok = true;
        this._processValidationOpAndPublish(function (that) {
            ok = validateTarget(that.entity);
        });
        return ok;
    }
    /**
    Performs validation on a specific property of this entity, any errors encountered during the validation are available via the
    [[EntityAspect.getValidationErrors]] method. Validating a property means executing
    all of the validators on the specified property.  This call is also made automatically anytime a property
    of an entity is changed.
    >      // assume order is an order entity attached to an EntityManager.
    >      var isOk = order.entityAspect.validateProperty("Order");
  
    or
    >      var orderDateProperty = order.entityType.getProperty("OrderDate");
    >      var isOk = order.entityAspect.validateProperty(OrderDateProperty);
    @param property - The [[DataProperty]] or [[NavigationProperty]] to validate or a string
    with the name of the property or a property path with the path to a property of a complex object.
    @param context -  A context object used to pass additional information to each [[Validator]].
    @return Whether the entity passed validation.
    **/
    validateProperty(property, context) {
        let value = this.getPropertyValue(property); // performs validations
        if (value && value.complexAspect) {
            return validateTarget(value);
        }
        context = context || {};
        context.entity = this.entity;
        if (typeof property === "string") {
            context.property = this.entity.entityType.getProperty(property, true);
            context.propertyName = property;
        }
        else {
            context.property = property;
            context.propertyName = property.name;
        }
        return this._validateProperty(value, context);
    }
    /**
    Returns the validation errors associated with either the entire entity or any specified property.
    
    This method can return all of the errors for an Entity
    >      // assume order is an order entity attached to an EntityManager.
    >      var valErrors = order.entityAspect.getValidationErrors();
  
    as well as those for just a specific property.
    >      // assume order is an order entity attached to an EntityManager.
    >      var orderDateErrors = order.entityAspect.getValidationErrors("OrderDate");
  
    which can also be expressed as
    >      // assume order is an order entity attached to an EntityManager.
    >      var orderDateProperty = order.entityType.getProperty("OrderDate");
    >      var orderDateErrors = order.entityAspect.getValidationErrors(orderDateProperty);
    @param property - The property for which validation errors should be retrieved.
    If omitted, all of the validation errors for this entity will be returned.
    @return A array of validation errors.
    **/
    getValidationErrors(property) {
        assertParam(property, "property").isOptional().isEntityProperty().or().isString().check();
        let result = core.getOwnPropertyValues(this._validationErrors);
        if (property) {
            let propertyName = typeof (property) === 'string' ? property : property.name;
            result = result.filter(function (ve) {
                return ve.property && (ve.property.name === propertyName || (propertyName.indexOf(".") !== -1 && ve.propertyName === propertyName));
            });
        }
        return result;
    }
    /**
    Adds a validation error.
    **/
    addValidationError(validationError) {
        assertParam(validationError, "validationError").isInstanceOf(ValidationError).check();
        this._processValidationOpAndPublish(function (that) {
            that._addValidationError(validationError);
        });
    }
    /**
    Removes a validation error.
    @param validationErrorOrKey - Either a ValidationError or a ValidationError 'key' value
    **/
    removeValidationError(validationErrorOrKey) {
        assertParam(validationErrorOrKey, "validationErrorOrKey").isString().or().isInstanceOf(ValidationError).or().isInstanceOf(Validator).check();
        let key = (typeof (validationErrorOrKey) === "string") ? validationErrorOrKey : validationErrorOrKey.key;
        this._processValidationOpAndPublish(function (that) {
            that._removeValidationError(key);
        });
    }
    /**
    Removes all of the validation errors for a specified entity
    **/
    clearValidationErrors() {
        this._processValidationOpAndPublish(function (that) {
            core.objectForEach(that._validationErrors, function (key, valError) {
                if (valError) {
                    delete that._validationErrors[key];
                    that._pendingValidationResult.removed.push(valError);
                }
            });
            that.hasValidationErrors = !core.isEmpty(that._validationErrors);
        });
    }
    /**
    Returns an [[EntityKey]] for the entity pointed to by the specified scalar NavigationProperty.
    This only returns an EntityKey if the current entity is a 'child' entity along the specified NavigationProperty.
    i.e. has a single parent.
  
    @param navigationProperty - The [[NavigationProperty]] ( pointing to a parent).
    @returns Either a parent EntityKey if this is a 'child' entity or null;
    */
    getParentKey(navigationProperty) {
        if (!this.entity)
            return null;
        // TODO: review this - not sure about the comment.
        // NavigationProperty doesn't yet exist
        // assertParam(navigationProperty, "navigationProperty").isInstanceOf(NavigationProperty).check();
        let fkNames = navigationProperty.foreignKeyNames;
        if (fkNames.length === 0)
            return null;
        let that = this;
        let fkValues = fkNames.map(function (fkn) {
            return that.entity.getProperty(fkn);
        });
        return new EntityKey(navigationProperty.entityType, fkValues);
    }
    // TODO: refactor this and the static getPropertyPathValue.
    /**
    Returns the value of a specified DataProperty or NavigationProperty or 'property path'.
    **/
    getPropertyValue(property) {
        assertParam(property, "property").isString().or().isEntityProperty().check();
        let value;
        if (typeof (property) === 'string') {
            let propNames = property.trim().split(".");
            let propName = propNames.shift();
            value = this.entity;
            value = value.getProperty(propName);
            while (propNames.length > 0) {
                propName = propNames.shift();
                value = value.getProperty(propName);
            }
        }
        else {
            if (!(property.parentType instanceof EntityType)) {
                throw new Error("The validateProperty method does not accept a 'property' parameter whose parentType is a ComplexType; " +
                    "Pass a 'property path' string as the 'property' parameter instead ");
            }
            value = this.entity.getProperty(property.name);
        }
        return value;
    }
    // internal methods
    /** @hidden @internal */
    _checkOperation(operationName) {
        if (this.isBeingSaved) {
            throw new Error("Cannot perform a '" + operationName + "' on an entity that is in the process of being saved");
        }
        // allows chaining
        return this;
    }
    /** @hidden @internal */
    _detach() {
        this.entityGroup = undefined;
        this.entityManager = undefined;
        this.entityState = EntityState.Detached;
        this.originalValues = {};
        this._validationErrors = {};
        this.hasValidationErrors = false;
        this.validationErrorsChanged.clear();
        this.propertyChanged.clear();
    }
    // called from defaultInterceptor.
    /** @hidden @internal */
    _validateProperty(value, context) {
        let ok = true;
        this._processValidationOpAndPublish(function (that) {
            context.property.getAllValidators().forEach(function (validator) {
                ok = validate(that, validator, value, context) && ok;
            });
        });
        return ok;
    }
    /** @hidden @internal */
    _processValidationOpAndPublish(validationFn) {
        if (this._pendingValidationResult) {
            // only top level processValidations call publishes
            validationFn(this);
        }
        else {
            try {
                this._pendingValidationResult = { entity: this.entity, added: [], removed: [] };
                validationFn(this);
                if (this._pendingValidationResult.added.length > 0 || this._pendingValidationResult.removed.length > 0) {
                    this.validationErrorsChanged.publish(this._pendingValidationResult);
                    // this might be a detached entity hence the guard below.
                    this.entityManager && this.entityManager.validationErrorsChanged.publish(this._pendingValidationResult);
                }
            }
            finally {
                this._pendingValidationResult = undefined;
            }
        }
    }
    /** @hidden @internal */
    // TODO: add/use a ValidationError type
    _addValidationError(validationError) {
        this._validationErrors[validationError.key] = validationError;
        this.hasValidationErrors = true;
        this._pendingValidationResult.added.push(validationError);
    }
    /** @hidden @internal */
    _removeValidationError(key) {
        let valError = this._validationErrors[key];
        if (valError) {
            delete this._validationErrors[key];
            this.hasValidationErrors = !core.isEmpty(this._validationErrors);
            this._pendingValidationResult.removed.push(valError);
        }
    }
}
/** @hidden @internal */
EntityAspect._nullInstance = new EntityAspect(); // TODO: determine if this works
BreezeEvent.bubbleEvent(EntityAspect.prototype, function () {
    return this.entityManager;
});
function rejectChangesCore(target) {
    let aspect = target.entityAspect || target.complexAspect;
    let stype = target.entityType || target.complexType;
    let originalValues = aspect.originalValues;
    for (let propName in originalValues) {
        target.setProperty(propName, originalValues[propName]);
    }
    stype.complexProperties.forEach(function (cp) {
        let cos = target.getProperty(cp.name);
        if (cp.isScalar) {
            rejectChangesCore(cos);
        }
        else {
            cos._rejectChanges();
            cos.forEach(rejectChangesCore);
        }
    });
}
function removeFromRelations(entity, entityState) {
    // remove this entity from any collections.
    // mark the entity deleted or detached
    let isDeleted = entityState.isDeleted();
    if (isDeleted) {
        removeFromRelationsCore(entity);
    }
    else {
        core.using(entity.entityAspect.entityManager, "isLoading", true, function () {
            removeFromRelationsCore(entity);
        });
    }
}
function removeFromRelationsCore(entity) {
    entity.entityType.navigationProperties.forEach(function (np) {
        let inverseNp = np.inverse;
        let npValue = entity.getProperty(np.name);
        if (np.isScalar) {
            if (npValue) {
                if (inverseNp) {
                    if (inverseNp.isScalar) {
                        npValue.setProperty(inverseNp.name, null);
                    }
                    else {
                        let collection = npValue.getProperty(inverseNp.name);
                        if (collection.length) {
                            core.arrayRemoveItem(collection, entity);
                        }
                    }
                }
                entity.setProperty(np.name, null);
            }
        }
        else {
            if (inverseNp != null) {
                // npValue is a live list so we need to copy it first.
                npValue.slice(0).forEach((v) => {
                    if (inverseNp.isScalar) {
                        v.setProperty(inverseNp.name, null);
                    }
                    else {
                        // TODO: many to many - not yet handled.
                    }
                });
            }
            // now clear it.
            npValue.length = 0;
        }
    });
}
// note entityAspect only - ( no complex aspect allowed on the call).
function validate(entityAspect, validator, value, context) {
    let ve = validator.validate(value, context);
    if (ve) {
        entityAspect._addValidationError(ve);
        return false;
    }
    else {
        let key = ValidationError.getKey(validator, context ? context.propertyName : null);
        entityAspect._removeValidationError(key);
        return true;
    }
}
// coIndex is only used where target is a complex object that is part of an array of complex objects
// in which case ctIndex is the index of the target within the array.
function validateTarget(target, coIndex) {
    let ok = true;
    let stype = target.entityType || target.complexType;
    let aspect = target.entityAspect || target.complexAspect;
    let entityAspect = target.entityAspect || target.complexAspect.getEntityAspect();
    let context = { entity: entityAspect.entity };
    if (coIndex !== undefined) {
        context.index = coIndex;
    }
    stype.getProperties().forEach(function (p) {
        let value = target.getProperty(p.name);
        let validators = p.getAllValidators();
        if (validators.length > 0) {
            context.property = p;
            context.propertyName = aspect.getPropertyPath(p.name);
            ok = entityAspect._validateProperty(value, context) && ok;
        }
        if (p.isComplexProperty) {
            if (p.isScalar) {
                ok = validateTarget(value) && ok;
            }
            else {
                ok = value.reduce(function (pv, cv, ix) {
                    return validateTarget(cv, ix) && pv;
                }, ok);
            }
        }
    });
    // then target level
    stype.getAllValidators().forEach(function (validator) {
        ok = validate(entityAspect, validator, target) && ok;
    });
    return ok;
}
/**
An ComplexAspect instance is associated with every complex object instance and is accessed via the complex object's 'complexAspect' property.

The ComplexAspect itself provides properties to determine the parent object, parent property and original values for the complex object.

A ComplexAspect will almost never need to be constructed directly. You will usually get an ComplexAspect by accessing
an entities 'complexAspect' property.  This property will be automatically attached when an complex object is created as part of an
entity via either a query, import or EntityManager.createEntity call.
>      // assume address is a complex property on the 'Customer' type
>      var aspect = aCustomer.address.complexAspect;
>      // aCustomer === aspect.parent;
**/
export class ComplexAspect {
    /** You will rarely, if ever, create a ComplexAspect directly. */
    constructor(complexObject, parent, parentProperty) {
        if (!complexObject) {
            throw new Error("The  ComplexAspect ctor requires an entity as its only argument.");
        }
        if (complexObject.complexAspect) {
            return complexObject.complexAspect;
        }
        // if called without new
        if (!(this instanceof ComplexAspect)) {
            return new ComplexAspect(complexObject, parent, parentProperty);
        }
        // entityType should already be on the entity from 'watch'
        this.complexObject = complexObject;
        complexObject.complexAspect = this;
        // TODO: keep public or not?
        this.originalValues = {};
        // if a standalone complexObject
        if (parent != null) {
            this.parent = parent;
            this.parentProperty = parentProperty;
        }
        let complexType = complexObject.complexType;
        if (!complexType) {
            let typeName = complexObject.prototype._$typeName;
            if (!typeName) {
                throw new Error("This entity is not registered as a valid ComplexType");
            }
            else {
                throw new Error("Metadata for this complexType has not yet been resolved: " + typeName);
            }
        }
        let complexCtor = complexType.getCtor();
        config.interfaceRegistry.modelLibrary.getDefaultInstance().startTracking(complexObject, complexCtor.prototype);
    }
    /**
    Returns the EntityAspect for the top level entity that contains this complex object.
    **/
    getEntityAspect() {
        let parent = this.parent;
        if (!parent)
            return new EntityAspect();
        let entityAspect = parent.entityAspect;
        while (parent && !entityAspect) {
            parent = parent.complexAspect && parent.complexAspect.parent;
            entityAspect = parent && parent.entityAspect;
        }
        return entityAspect || new EntityAspect();
    }
    /**  @hidden @internal */
    // TODO: rename - and use '_'; used on both EntityAspect and ComplexAspect for polymorphic reasons.
    getPropertyPath(propName) {
        let parent = this.parent;
        if (!parent)
            return null;
        let aspect = parent.complexAspect || parent.entityAspect;
        return aspect.getPropertyPath(this.parentProperty.name + "." + propName);
    }
}
function clearOriginalValues(target) {
    let aspect = target.entityAspect || target.complexAspect;
    aspect.originalValues = {};
    let stype = target.entityType || target.complexType;
    stype.complexProperties.forEach(function (cp) {
        let cos = target.getProperty(cp.name);
        if (cp.isScalar) {
            clearOriginalValues(cos);
        }
        else {
            cos._acceptChanges();
            cos.forEach(clearOriginalValues);
        }
    });
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZW50aXR5LWFzcGVjdC5qcyIsInNvdXJjZVJvb3QiOiJuZzovL2JyZWV6ZS1jbGllbnQvIiwic291cmNlcyI6WyJzcmMvZW50aXR5LWFzcGVjdC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQUUsSUFBSSxFQUFFLE1BQU0sUUFBUSxDQUFDO0FBQzlCLE9BQU8sRUFBRSxNQUFNLEVBQUUsTUFBTSxVQUFVLENBQUM7QUFDbEMsT0FBTyxFQUFFLFdBQVcsRUFBRSxNQUFNLFNBQVMsQ0FBQztBQUN0QyxPQUFPLEVBQUUsV0FBVyxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFDN0MsT0FBTyxFQUFFLFdBQVcsRUFBRyxNQUFNLGdCQUFnQixDQUFDO0FBQzlDLE9BQU8sRUFBRSxZQUFZLEVBQUUsTUFBTSxpQkFBaUIsQ0FBQztBQUMvQyxPQUFPLEVBQUUsVUFBVSxFQUFpRSxNQUFNLG1CQUFtQixDQUFDO0FBQzlHLE9BQU8sRUFBRSxTQUFTLEVBQUUsTUFBTSxjQUFjLENBQUM7QUFHekMsT0FBTyxFQUFFLFNBQVMsRUFBRSxlQUFlLEVBQUUsTUFBTSxZQUFZLENBQUM7QUFDeEQsT0FBTyxFQUFFLFdBQVcsRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBeUM3Qzs7Ozs7Ozs7Ozs7OztHQWFHO0FBQ0gsTUFBTSxPQUFPLFlBQVk7SUFzRnZCLHdCQUF3QjtJQUN4QixZQUFZLE1BQWU7UUFFekIsd0JBQXdCO1FBQ3hCLHlDQUF5QztRQUN6QyxxQ0FBcUM7UUFDckMsSUFBSTtRQXVLTjs7Ozs7O1dBTUc7UUFDSCxpQkFBWSxHQUFHO1lBQ2IsT0FBTyxJQUFJLENBQUMsY0FBYyxDQUFDLFdBQVcsQ0FBQyxTQUFTLENBQUMsQ0FBQztRQUNwRCxDQUFDLENBQUM7UUFHRjs7Ozs7O1dBTUc7UUFDSCxnQkFBVyxHQUFHO1lBQ1osT0FBTyxJQUFJLENBQUMsY0FBYyxDQUFDLFdBQVcsQ0FBQyxRQUFRLENBQUMsQ0FBQztRQUNuRCxDQUFDLENBQUM7UUFFRjs7Ozs7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ZyB9IGZyb20gJy4vY29uZmlnJztcclxuaW1wb3J0IHsgQnJlZXplRXZlbnQgfSBmcm9tICcuL2V2ZW50JztcclxuaW1wb3J0IHsgYXNzZXJ0UGFyYW0gfSBmcm9tICcuL2Fzc2VydC1wYXJhbSc7XHJcbmltcG9ydCB7IEVudGl0eVN0YXRlICB9IGZyb20gJy4vZW50aXR5LXN0YXRlJztcclxuaW1wb3J0IHsgRW50aXR5QWN0aW9uIH0gZnJvbSAnLi9lbnRpdHktYWN0aW9uJztcclxuaW1wb3J0IHsgRW50aXR5VHlwZSwgQ29tcGxleFR5cGUsIERhdGFQcm9wZXJ0eSwgTmF2aWdhdGlvblByb3BlcnR5LCBFbnRpdHlQcm9wZXJ0eSB9IGZyb20gJy4vZW50aXR5LW1ldGFkYXRhJztcclxuaW1wb3J0IHsgRW50aXR5S2V5IH0gZnJvbSAnLi9lbnRpdHkta2V5JztcclxuaW1wb3J0IHsgRW50aXR5R3JvdXAgfSBmcm9tICcuL2VudGl0eS1ncm91cCc7XHJcbmltcG9ydCB7IEVudGl0eU1hbmFnZXIsIFF1ZXJ5UmVzdWx0LCBRdWVyeUVycm9yQ2FsbGJhY2ssIFF1ZXJ5U3VjY2Vzc0NhbGxiYWNrIH0gZnJvbSAnLi9lbnRpdHktbWFuYWdlcic7XHJcbmltcG9ydCB7IFZhbGlkYXRvciwgVmFsaWRhdGlvbkVycm9yIH0gZnJvbSAnLi92YWxpZGF0ZSc7XHJcbmltcG9ydCB7IEVudGl0eVF1ZXJ5IH0gZnJvbSAnLi9lbnRpdHktcXVlcnknO1xyXG5cclxuZXhwb3J0IGludGVyZmFjZSBFbnRpdHkge1xyXG4gIGVudGl0eUFzcGVjdDogRW50aXR5QXNwZWN0O1xyXG4gIGVudGl0eVR5cGU6IEVudGl0eVR5cGU7XHJcbiAgLyoqIEBpbnRlcm5hbCAqL1xyXG4gIGdldFByb3BlcnR5Pyhwcm9wOiBzdHJpbmcpOiBhbnk7XHJcbiAgLyoqIEBpbnRlcm5hbCAqL1xyXG4gIHNldFByb3BlcnR5Pyhwcm9wOiBhbnksIHZhbHVlOiBhbnkpOiB2b2lkO1xyXG4gIC8qKiBAaGlkZGVuIEBpbnRlcm5hbCAqL1xyXG4gIHByb3RvdHlwZT86IHsgXyR0eXBlTmFtZTogc3RyaW5nIH07XHJcbiAgLyoqIEBoaWRkZW4gQGludGVybmFsICovXHJcbiAgXyRlbnRpdHlUeXBlPzogRW50aXR5VHlwZTtcclxufVxyXG5cclxuZXhwb3J0IGludGVyZmFjZSBDb21wbGV4T2JqZWN0IHtcclxuICBjb21wbGV4QXNwZWN0OiBDb21wbGV4QXNwZWN0O1xyXG4gIGNvbXBsZXhUeXBlOiBDb21wbGV4VHlwZTtcclxuICBnZXRQcm9wZXJ0eShwcm9wOiBzdHJpbmcpOiBhbnk7XHJcbiAgc2V0UHJvcGVydHkocHJvcDogYW55LCB2YWx1ZTogYW55KTogdm9pZDtcclxuICAvKiogQGhpZGRlbiBAaW50ZXJuYWwgKi9cclxuICBwcm90b3R5cGU/OiB7IF8kdHlwZU5hbWU6IHN0cmluZyB9O1xyXG59XHJcblxyXG5leHBvcnQgdHlwZSBTdHJ1Y3R1cmFsT2JqZWN0ID0gRW50aXR5IHwgQ29tcGxleE9iamVjdDtcclxuXHJcbmV4cG9ydCBpbnRlcmZhY2UgUHJvcGVydHlDaGFuZ2VkRXZlbnRBcmdzIHtcclxuICBlbnRpdHk6IEVudGl0eTtcclxuICBwcm9wZXJ0eU5hbWU6IHN0cmluZyB8IG51bGw7XHJcbiAgcGFyZW50PzogU3RydWN0dXJhbE9iamVjdDtcclxuICBwcm9wZXJ0eT86IEVudGl0eVByb3BlcnR5O1xyXG4gIG9sZFZhbHVlPzogYW55O1xyXG4gIG5ld1ZhbHVlPzogYW55O1xyXG59XHJcblxyXG5leHBvcnQgaW50ZXJmYWNlIFZhbGlkYXRpb25FcnJvcnNDaGFuZ2VkRXZlbnRBcmdzIHtcclxuICBlbnRpdHk6IEVudGl0eTtcclxuICBhZGRlZDogVmFsaWRhdGlvbkVycm9yW107XHJcbiAgcmVtb3ZlZDogVmFsaWRhdGlvbkVycm9yW107XHJcbn1cclxuXHJcbi8qKlxyXG5BbiBFbnRpdHlBc3BlY3QgaW5zdGFuY2UgaXMgYXNzb2NpYXRlZCB3aXRoIGV2ZXJ5IGF0dGFjaGVkIGVudGl0eSBhbmQgaXMgYWNjZXNzZWQgdmlhIHRoZSBlbnRpdHkncyAnZW50aXR5QXNwZWN0JyBwcm9wZXJ0eS5cclxuXHJcblRoZSBFbnRpdHlBc3BlY3QgaXRzZWxmIHByb3ZpZGVzIHByb3BlcnRpZXMgdG8gZGV0ZXJtaW5lIGFuZCBtb2RpZnkgdGhlIEVudGl0eVN0YXRlIG9mIHRoZSBlbnRpdHkgYW5kIGhhcyBtZXRob2RzXHJcbnRoYXQgcHJvdmlkZSBhIHZhcmlldHkgb2Ygc2VydmljZXMgaW5jbHVkaW5nIHZhbGlkYXRpb24gYW5kIGNoYW5nZSB0cmFja2luZy5cclxuXHJcbkFuIEVudGl0eUFzcGVjdCB3aWxsIGFsbW9zdCBuZXZlciBuZWVkIHRvIGJlIGNvbnN0cnVjdGVkIGRpcmVjdGx5LiBZb3Ugd2lsbCB1c3VhbGx5IGdldCBhbiBFbnRpdHlBc3BlY3QgYnkgYWNjZXNzaW5nXHJcbmFuIGVudGl0aWVzICdlbnRpdHlBc3BlY3QnIHByb3BlcnR5LiAgVGhpcyBwcm9wZXJ0eSB3aWxsIGJlIGF1dG9tYXRpY2FsbHkgYXR0YWNoZWQgd2hlbiBhbiBlbnRpdHkgaXMgY3JlYXRlZCB2aWEgZWl0aGVyXHJcbmEgcXVlcnksIGltcG9ydCBvciBbW0VudGl0eU1hbmFnZXIuY3JlYXRlRW50aXR5XV0gY2FsbC5cclxuPiAgICAgIC8vIGFzc3VtZSBvcmRlciBpcyBhbiBvcmRlciBlbnRpdHkgYXR0YWNoZWQgdG8gYW4gRW50aXR5TWFuYWdlci5cclxuPiAgICAgIHZhciBhc3BlY3QgPSBvcmRlci5lbnRpdHlBc3BlY3Q7XHJcbj4gICAgICB2YXIgY3VycmVudFN0YXRlID0gYXNwZWN0LmVudGl0eVN0YXRlO1xyXG5cclxuKiovXHJcbmV4cG9ydCBjbGFzcyBFbnRpdHlBc3BlY3Qge1xyXG4gIC8qKiBUaGUgRW50aXR5IHRoYXQgdGhpcyBhc3BlY3QgaXMgYXNzb2NpYXRlZCB3aXRoLiBfX1JlYWQgT25seV9fICAqKi9cclxuICBlbnRpdHk/OiBFbnRpdHk7XHJcbiAgLyoqIFRoZSBbW0VudGl0eU1hbmFnZXJdXSB0aGF0IGNvbnRhaW5zIHRoaXMgZW50aXR5LiBfX1JlYWQgT25seV9fICoqL1xyXG4gIGVudGl0eU1hbmFnZXI/OiBFbnRpdHlNYW5hZ2VyO1xyXG4gIC8qKiAgQGhpZGRlbiBAaW50ZXJuYWwgKi9cclxuICBlbnRpdHlHcm91cD86IEVudGl0eUdyb3VwO1xyXG4gIC8qKiBUaGUgW1tFbnRpdHlTdGF0ZV1dIG9mIHRoaXMgZW50aXR5LiBfX1JlYWQgT25seV9fICoqL1xyXG4gIGVudGl0eVN0YXRlOiBFbnRpdHlTdGF0ZTtcclxuICAvKiogICBXaGV0aGVyIHRoaXMgZW50aXR5IGlzIGluIHRoZSBwcm9jZXNzIG9mIGJlaW5nIHNhdmVkLiBfX1JlYWQgT25seV9fICovXHJcbiAgaXNCZWluZ1NhdmVkOiBib29sZWFuO1xyXG4gIC8qKiBUaGUgJ29yaWdpbmFsIHZhbHVlcycgb2YgdGhpcyBlbnRpdHkgd2hlcmUgdGhleSBhcmUgZGlmZmVyZW50IGZyb20gdGhlICdjdXJyZW50IHZhbHVlcycuXHJcbiAgVGhpcyBpcyBhIG1hcCB3aGVyZSB0aGUga2V5IGlzIGEgcHJvcGVydHkgbmFtZSBhbmQgdGhlIHZhbHVlIGlzIHRoZSAnb3JpZ2luYWwgdmFsdWUnIG9mIHRoZSBwcm9wZXJ0eS4gKi9cclxuICBvcmlnaW5hbFZhbHVlczoge307XHJcbiAgLyoqICBXaGV0aGVyIHRoaXMgZW50aXR5IGhhcyBhbnkgdmFsaWRhdGlvbiBlcnJvcnMuIF9fUmVhZCBPbmx5X18gKi9cclxuICBoYXNWYWxpZGF0aW9uRXJyb3JzOiBib29sZWFuO1xyXG4gIC8qKiBXaGV0aGVyIHRoaXMgZW50aXR5IGhhcyBhIHRlbXBvcmFyeSBbW0VudGl0eUtleV1dLiAqL1xyXG4gIGhhc1RlbXBLZXk6IGJvb2xlYW47XHJcbiAgLyoqIFdoZXRoZXIgdGhpcyBlbnRpdHkgd2FzIGNyZWF0ZWQgYnkgYmVpbmcgbG9hZGVkIGZyb20gdGhlIGRhdGFiYXNlICovXHJcbiAgd2FzTG9hZGVkPzogYm9vbGVhbjtcclxuICAvKiogRXh0cmEgbWV0YWRhdGEgYWJvdXQgdGhpcyBlbnRpdHkgc3VjaCBhcyB0aGUgZW50aXR5J3MgZXRhZy5cclxuICBZb3UgbWF5IGV4dGVuZCB0aGlzIG9iamVjdCB3aXRoIHlvdXIgb3duIG1ldGFkYXRhIGluZm9ybWF0aW9uLlxyXG4gIEJyZWV6ZSAoZGUpc2VyaWFsaXplcyB0aGlzIG9iamVjdCB3aGVuIGltcG9ydGluZy9leHBvcnRpbmcgdGhlIGVudGl0eS4gKiovXHJcbiAgZXh0cmFNZXRhZGF0YT86IGFueTtcclxuICAvKipcclxuICBBIFtbQnJlZXplRXZlbnRdXSB0aGF0IGZpcmVzIHdoZW5ldmVyIGFueSBvZiB0aGUgdmFsaWRhdGlvbiBlcnJvcnMgb24gdGhpcyBlbnRpdHkgY2hhbmdlLlxyXG4gIE5vdGUgdGhhdCB0aGlzIG1pZ2h0IGJlIHRoZSByZW1vdmFsIG9mIGFuIGVycm9yIHdoZW4gc29tZSBkYXRhIG9uIHRoZSBlbnRpdHkgaXMgZml4ZWQuXHJcbiAgQGV2ZW50QXJncyAtIFxyXG4gICAgLSBlbnRpdHkgLSBUaGUgZW50aXR5IG9uIHdoaWNoIHRoZSB2YWxpZGF0aW9uIGVycm9ycyBhcmUgYmVpbmcgYWRkZWQgb3IgcmVtb3ZlZC5cclxuICAgIC0gYWRkZWQgLSBBbiBhcnJheSBjb250YWluaW5nIGFueSBuZXdseSBhZGRlZCBbW1ZhbGlkYXRpb25FcnJvcl1dc1xyXG4gICAgLSByZW1vdmVkIC0gQW4gYXJyYXkgY29udGFpbmluZyBhbnkgbmV3bHkgcmVtb3ZlZCBbW1ZhbGlkYXRpb25FcnJvcl1dcy4gVGhpcyBpcyB0aG9zZVxyXG4gICAgICBlcnJvcnMgdGhhdCBoYXZlIGJlZW4gJ2ZpeGVkJy5cclxuXHJcbj4gICAgICAvLyBhc3N1bWUgb3JkZXIgaXMgYW4gb3JkZXIgZW50aXR5IGF0dGFjaGVkIHRvIGFuIEVudGl0eU1hbmFnZXIuXHJcbj4gICAgICBvcmRlci5lbnRpdHlBc3BlY3QudmFsaWRhdGlvbkVycm9yc0NoYW5nZWQuc3Vic2NyaWJlKFxyXG4+ICAgICAgZnVuY3Rpb24gKHZhbGlkYXRpb25DaGFuZ2VBcmdzKSB7XHJcbj4gICAgICAgICAgLy8gdGhpcyBjb2RlIHdpbGwgYmUgZXhlY3V0ZWQgYW55dGltZSBhIHByb3BlcnR5IHZhbHVlIGNoYW5nZXMgb24gdGhlICdvcmRlcicgZW50aXR5LlxyXG4+ICAgICAgICAgIHZhciBlbnRpdHkgPT0gdmFsaWRhdGlvbkNoYW5nZUFyZ3MuZW50aXR5OyAvLyBOb3RlOiBlbnRpdHkgPT09IG9yZGVyXHJcbj4gICAgICAgICAgdmFyIGVycm9yc0FkZGVkID0gdmFsaWRhdGlvbkNoYW5nZUFyZ3MuYWRkZWQ7XHJcbj4gICAgICAgICAgdmFyIGVycm9yc0NsZWFyZWQgPSB2YWxpZGF0aW9uQ2hhbmdlQXJncy5yZW1vdmVkO1xyXG4+ICAgICAgfSk7XHJcbiAgQGV2ZW50XHJcbiAgKiovXHJcbiAgdmFsaWRhdGlvbkVycm9yc0NoYW5nZWQ6IEJyZWV6ZUV2ZW50PFZhbGlkYXRpb25FcnJvcnNDaGFuZ2VkRXZlbnRBcmdzPjtcclxuICAvKipcclxuICBBIFtbQnJlZXplRXZlbnRdXSB0aGF0IGZpcmVzIHdoZW5ldmVyIGEgdmFsdWUgb2Ygb25lIG9mIHRoaXMgZW50aXR5J3MgcHJvcGVydGllcyBjaGFuZ2UuXHJcbiAgQGV2ZW50QXJncyAtXHJcbiAgICAtIGVudGl0eSAtIFRoZSBlbnRpdHkgd2hvc2UgcHJvcGVydHkgaGFzIGNoYW5nZWQuXHJcbiAgICAtIHByb3BlcnR5IC0gVGhlIFtbRGF0YVByb3BlcnR5XV0gdGhhdCBjaGFuZ2VkLlxyXG4gICAgLSBwcm9wZXJ0eU5hbWUgLSBUaGUgbmFtZSBvZiB0aGUgcHJvcGVydHkgdGhhdCBjaGFuZ2VkLiBUaGlzIHZhbHVlIHdpbGwgYmUgJ251bGwnIGZvciBvcGVyYXRpb25zIHRoYXQgcmVwbGFjZSB0aGUgZW50aXJlIGVudGl0eS4gIFRoaXMgaW5jbHVkZXNcclxuICAgICAgcXVlcmllcywgaW1wb3J0cyBhbmQgc2F2ZXMgdGhhdCByZXF1aXJlIGEgbWVyZ2UuIFRoZSByZW1haW5pbmcgcGFyYW1ldGVycyB3aWxsIG5vdCBleGlzdCBpbiB0aGlzIGNhc2UgZWl0aGVyLiBUaGlzIHdpbGwgYWN0dWFsbHkgYmUgYSBcInByb3BlcnR5IHBhdGhcIlxyXG4gICAgICBmb3IgYW55IHByb3BlcnRpZXMgb2YgYSBjb21wbGV4IHR5cGUuXHJcbiAgICAtIG9sZFZhbHVlIC0gVGhlIG9sZCB2YWx1ZSBvZiB0aGlzIHByb3BlcnR5IGJlZm9yZSB0aGUgY2hhbmdlLlxyXG4gICAgLSBuZXdWYWx1ZSAtIFRoZSBuZXcgdmFsdWUgb2YgdGhpcyBwcm9wZXJ0eSBhZnRlciB0aGUgY2hhbmdlLlxyXG4gICAgLSBwYXJlbnQgLSBUaGUgaW1tZWRpYXRlIHBhcmVudCBvYmplY3QgZm9yIHRoZSBjaGFuZ2VkIHByb3BlcnR5LiAgVGhpcyB3aWxsIGJlIGEgQ29tcGxleFR5cGUgaW5zdGFuY2UgYXMgb3Bwb3NlZCB0byBhbiBFbnRpdHkgXHJcbiAgICAgIGZvciBhbnkgY29tcGxleCB0eXBlIG9yIG5lc3RlZCBjb21wbGV4IHR5cGUgcHJvcGVydGllcy5cclxuXHJcbiAgPiAgICAgIC8vIGFzc3VtZSBvcmRlciBpcyBhbiBvcmRlciBlbnRpdHkgYXR0YWNoZWQgdG8gYW4gRW50aXR5TWFuYWdlci5cclxuICA+ICAgICAgb3JkZXIuZW50aXR5QXNwZWN0LnByb3BlcnR5Q2hhbmdlZC5zdWJzY3JpYmUoXHJcbiAgPiAgICAgIGZ1bmN0aW9uIChwcm9wZXJ0eUNoYW5nZWRBcmdzKSB7XHJcbiAgPiAgICAgICAgICAvLyB0aGlzIGNvZGUgd2lsbCBiZSBleGVjdXRlZCBhbnl0aW1lIGEgcHJvcGVydHkgdmFsdWUgY2hhbmdlcyBvbiB0aGUgJ29yZGVyJyBlbnRpdHkuXHJcbiAgPiAgICAgICAgICB2YXIgZW50aXR5ID0gcHJvcGVydHlDaGFuZ2VkQXJncy5lbnRpdHk7IC8vIE5vdGU6IGVudGl0eSA9PT0gb3JkZXJcclxuICA+ICAgICAgICAgIHZhciBwcm9wZXJ0eU5hbWVDaGFuZ2VkID0gcHJvcGVydHlDaGFuZ2VkQXJncy5wcm9wZXJ0eU5hbWU7XHJcbiAgPiAgICAgICAgICB2YXIgb2xkVmFsdWUgPSBwcm9wZXJ0eUNoYW5nZWRBcmdzLm9sZFZhbHVlO1xyXG4gID4gICAgICAgICAgdmFyIG5ld1ZhbHVlID0gcHJvcGVydHlDaGFuZ2VkQXJncy5uZXdWYWx1ZTtcclxuICA+ICAgICAgfSk7XHJcbiAgQGV2ZW50XHJcbiAgKiovXHJcbiAgcHJvcGVydHlDaGFuZ2VkOiBCcmVlemVFdmVudDxQcm9wZXJ0eUNoYW5nZWRFdmVudEFyZ3M+O1xyXG5cclxuICAvKiogQGhpZGRlbiBAaW50ZXJuYWwgKi9cclxuICBfdmFsaWRhdGlvbkVycm9yczogeyBbaW5kZXg6IHN0cmluZ106IFZhbGlkYXRpb25FcnJvciB9O1xyXG4gIC8qKiBAaGlkZGVuIEBpbnRlcm5hbCAqL1xyXG4gIF9wZW5kaW5nVmFsaWRhdGlvblJlc3VsdDogYW55O1xyXG4gIC8qKiBAaGlkZGVuIEBpbnRlcm5hbCAqL1xyXG4gIF9lbnRpdHlLZXk6IEVudGl0eUtleTtcclxuICAvKiogQGhpZGRlbiBAaW50ZXJuYWwgKi9cclxuICBfbG9hZGVkTnBzOiBhbnlbXTtcclxuICAvKiogQGhpZGRlbiBAaW50ZXJuYWwgKi9cclxuICBfaW5pdGlhbGl6ZWQ/OiBib29sZWFuO1xyXG4gIC8qKiBAaGlkZGVuIEBpbnRlcm5hbCAqL1xyXG4gIF9pblByb2Nlc3M6IGFueVtdOyAvLyB1c2VkIGluIGRlZmF1bHRQcm9wZXJ0eUludGVyY2VwdG9yIGZvciB0ZW1wIHN0b3JhZ2UuXHJcbiAgLyoqIEBoaWRkZW4gQGludGVybmFsICovXHJcbiAgX2luUHJvY2Vzc0VudGl0eT86IEVudGl0eTsgLy8gdXNlZCBpbiBFbnRpdHlNYW5hZ2VyXHJcbiAgLyoqIEBoaWRkZW4gQGludGVybmFsICovXHJcbiAgc3RhdGljIF9udWxsSW5zdGFuY2UgPSBuZXcgRW50aXR5QXNwZWN0KCk7IC8vIFRPRE86IGRldGVybWluZSBpZiB0aGlzIHdvcmtzXHJcbiAgLyoqIEBoaWRkZW4gQGludGVybmFsICovXHJcbiAgY29uc3RydWN0b3IoZW50aXR5PzogRW50aXR5KSB7XHJcblxyXG4gICAgLy8gaWYgY2FsbGVkIHdpdGhvdXQgbmV3XHJcbiAgICAvLyBpZiAoISh0aGlzIGluc3RhbmNlb2YgRW50aXR5QXNwZWN0KSkge1xyXG4gICAgLy8gICByZXR1cm4gbmV3IEVudGl0eUFzcGVjdChlbnRpdHkpO1xyXG4gICAgLy8gfVxyXG5cclxuICAgIHRoaXMuZW50aXR5ID0gZW50aXR5O1xyXG4gICAgLy8gVE9ETzoga2VlcCBwdWJsaWMgb3Igbm90P1xyXG4gICAgdGhpcy5lbnRpdHlHcm91cCA9IHVuZGVmaW5lZDtcclxuICAgIHRoaXMuZW50aXR5TWFuYWdlciA9IHVuZGVmaW5lZDtcclxuICAgIHRoaXMuZW50aXR5U3RhdGUgPSBFbnRpdHlTdGF0ZS5EZXRhY2hlZDtcclxuICAgIHRoaXMuaXNCZWluZ1NhdmVkID0gZmFsc2U7XHJcbiAgICB0aGlzLm9yaWdpbmFsVmFsdWVzID0ge307XHJcbiAgICB0aGlzLmhhc1ZhbGlkYXRpb25FcnJvcnMgPSBmYWxzZTtcclxuICAgIHRoaXMuX3ZhbGlkYXRpb25FcnJvcnMgPSB7fTtcclxuXHJcbiAgICAvLyBVbmNvbW1lbnQgd2hlbiB3ZSBpbXBsZW1lbnQgZW50aXR5QXNwZWN0LmlzTmF2aWdhdGlvblByb3BlcnR5TG9hZGVkIG1ldGhvZFxyXG4gICAgLy8gdGhpcy5fbG9hZGVkTmF2UHJvcE1hcCA9IHt9O1xyXG5cclxuICAgIHRoaXMudmFsaWRhdGlvbkVycm9yc0NoYW5nZWQgPSBuZXcgQnJlZXplRXZlbnQoXCJ2YWxpZGF0aW9uRXJyb3JzQ2hhbmdlZFwiLCB0aGlzKTtcclxuICAgIHRoaXMucHJvcGVydHlDaGFuZ2VkID0gbmV3IEJyZWV6ZUV2ZW50KFwicHJvcGVydHlDaGFuZ2VkXCIsIHRoaXMpO1xyXG4gICAgLy8gaW4gY2FzZSB0aGlzIGlzIHRoZSBOVUxMIGVudGl0eUFzcGVjdC4gLSB1c2VkIHdpdGggQ29tcGxleEFzcGVjdHMgdGhhdCBoYXZlIG5vIHBhcmVudC5cclxuXHJcbiAgICBpZiAoZW50aXR5ICE9IG51bGwpIHtcclxuICAgICAgLy8gcmVtb3ZlIHByb3BlcnRpZXMgdGhhdCBzaG91bGQgYmUgb24gcHJvdG90eXBlIGJ1dCBwbGFjZWQgb24gY2xhc3MgYnkgQmFiZWxcclxuICAgICAgaWYgKCFlbnRpdHkuZW50aXR5VHlwZSkgeyBkZWxldGUoZW50aXR5LmVudGl0eVR5cGUpOyB9XHJcbiAgICAgIGlmICghZW50aXR5LmVudGl0eUFzcGVjdCkgeyBkZWxldGUoZW50aXR5LmVudGl0eUFzcGVjdCk7IH1cclxuICAgICAgZW50aXR5LmVudGl0eUFzcGVjdCA9IHRoaXM7XHJcblxyXG4gICAgICAvLyBlbnRpdHlUeXBlIHNob3VsZCBhbHJlYWR5IGJlIG9uIHRoZSBlbnRpdHkgZnJvbSAnd2F0Y2gnXHJcbiAgICAgIGxldCBlbnRpdHlUeXBlID0gZW50aXR5LmVudGl0eVR5cGUgfHwgZW50aXR5Ll8kZW50aXR5VHlwZTtcclxuICAgICAgaWYgKCFlbnRpdHlUeXBlKSB7XHJcbiAgICAgICAgbGV0IHR5cGVOYW1lID0gZW50aXR5LnByb3RvdHlwZS5fJHR5cGVOYW1lO1xyXG4gICAgICAgIGlmICghdHlwZU5hbWUpIHtcclxuICAgICAgICAgIHRocm93IG5ldyBFcnJvcihcIlRoaXMgZW50aXR5IGlzIG5vdCByZWdpc3RlcmVkIGFzIGEgdmFsaWQgRW50aXR5VHlwZVwiKTtcclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgdGhyb3cgbmV3IEVycm9yKFwiTWV0YWRhdGEgZm9yIHRoaXMgZW50aXR5VHlwZSBoYXMgbm90IHlldCBiZWVuIHJlc29sdmVkOiBcIiArIHR5cGVOYW1lKTtcclxuICAgICAgICB9XHJcbiAgICAgIH1cclxuICAgICAgbGV0IGVudGl0eUN0b3IgPSBlbnRpdHlUeXBlLmdldEVudGl0eUN0b3IoKTtcclxuICAgICAgY29uZmlnLmludGVyZmFjZVJlZ2lzdHJ5Lm1vZGVsTGlicmFyeS5nZXREZWZhdWx0SW5zdGFuY2UoKS5zdGFydFRyYWNraW5nKGVudGl0eSwgZW50aXR5Q3Rvci5wcm90b3R5cGUpO1xyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgLyoqIEBoaWRkZW4gKi9cclxuICAvLyB0eXBlLWd1YXJkXHJcbiAgc3RhdGljIGlzRW50aXR5KG9iajogU3RydWN0dXJhbE9iamVjdCk6IG9iaiBpcyBFbnRpdHkge1xyXG4gICAgcmV0dXJuIChvYmogYXMgYW55KS5lbnRpdHlBc3BlY3QgIT0gbnVsbDtcclxuICB9XHJcblxyXG4gIC8vIE5vIGxvbmdlciB1c2VkXHJcbiAgLy8gc3RhdGljIGNyZWF0ZUZyb20oZW50aXR5OiBFbnRpdHkpOiBFbnRpdHlBc3BlY3Qge1xyXG4gIC8vICAgaWYgKGVudGl0eSA9PSBudWxsKSB7XHJcbiAgLy8gICAgIHJldHVybiBFbnRpdHlBc3BlY3QuX251bGxJbnN0YW5jZTtcclxuICAvLyAgIH0gZWxzZSBpZiAoZW50aXR5LmVudGl0eUFzcGVjdCkge1xyXG4gIC8vICAgICByZXR1cm4gZW50aXR5LmVudGl0eUFzcGVjdDtcclxuICAvLyAgIH1cclxuICAvLyAgIHJldHVybiBuZXcgRW50aXR5QXNwZWN0KGVudGl0eSk7XHJcbiAgLy8gfVxyXG5cclxuICAvLyBUT0RPOiByZWZhY3RvciB0aGlzIGFuZCB0aGUgaW5zdGFuY2UgZ2V0UHJvcGVydHlWYWx1ZSBtZXRob2QuXHJcbiAgLyoqXHJcbiAgUmV0dXJucyB0aGUgdmFsdWUgb2YgYSBzcGVjaWZpZWQgJ3Byb3BlcnR5IHBhdGgnIGZvciBhIHNwZWNpZmllZCBlbnRpdHkuXHJcblxyXG4gIFRoZSBwcm9wZXJ0eVBhdGggY2FuIGJlIGVpdGhlciBhIHN0cmluZyBkZWxpbWl0ZWQgd2l0aCAnLicgb3IgYSBzdHJpbmcgYXJyYXkuICBcclxuICAqKi9cclxuICAvLyB1c2VkIGJ5IEVudGl0eVF1ZXJ5IGFuZCBQcmVkaWNhdGVcclxuICBzdGF0aWMgZ2V0UHJvcGVydHlQYXRoVmFsdWUob2JqOiBFbnRpdHksIHByb3BlcnR5UGF0aDogc3RyaW5nIHwgc3RyaW5nW10pIHtcclxuICAgIGxldCBwcm9wZXJ0aWVzID0gQXJyYXkuaXNBcnJheShwcm9wZXJ0eVBhdGgpID8gcHJvcGVydHlQYXRoIDogcHJvcGVydHlQYXRoLnNwbGl0KFwiLlwiKTtcclxuICAgIGlmIChwcm9wZXJ0aWVzLmxlbmd0aCA9PT0gMSkge1xyXG4gICAgICByZXR1cm4gb2JqLmdldFByb3BlcnR5KHByb3BlcnR5UGF0aCBhcyBzdHJpbmcpO1xyXG4gICAgfSBlbHNlIHtcclxuICAgICAgbGV0IG5leHRWYWx1ZSA9IG9iajtcclxuICAgICAgLy8gaGFjayB1c2Ugb2Ygc29tZSB0byBwZXJmb3JtIG1hcEZpcnN0IG9wZXJhdGlvbi5cclxuICAgICAgcHJvcGVydGllcy5zb21lKChwcm9wKSA9PiB7XHJcbiAgICAgICAgbmV4dFZhbHVlID0gbmV4dFZhbHVlLmdldFByb3BlcnR5KHByb3ApO1xyXG4gICAgICAgIHJldHVybiBuZXh0VmFsdWUgPT0gbnVsbDtcclxuICAgICAgfSk7XHJcbiAgICAgIHJldHVybiBuZXh0VmFsdWU7XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICAvKipcclxuICBSZXR1cm5zIHRoZSBbW0VudGl0eUtleV1dIGZvciB0aGlzIEVudGl0eS5cclxuICA+ICAgICAgLy8gYXNzdW1lIG9yZGVyIGlzIGFuIG9yZGVyIGVudGl0eSBhdHRhY2hlZCB0byBhbiBFbnRpdHlNYW5hZ2VyLlxyXG4gID4gICAgICB2YXIgZW50aXR5S2V5ID0gb3JkZXIuZW50aXR5QXNwZWN0LmdldEtleSgpO1xyXG4gIEBwYXJhbSBmb3JjZVJlZnJlc2ggLSAoYm9vbGVhbj1mYWxzZSkgRm9yY2VzIHRoZSByZWNhbGN1bGF0aW9uIG9mIHRoZSBrZXkuICBUaGlzIHNob3VsZCBub3JtYWxseSBiZSB1bm5lY2Vzc2FyeS5cclxuICBAcmV0dXJuIFRoZSBbW0VudGl0eUtleV1dIGFzc29jaWF0ZWQgd2l0aCB0aGlzIEVudGl0eS5cclxuICAqKi9cclxuICBnZXRLZXkoZm9yY2VSZWZyZXNoOiBib29sZWFuID0gZmFsc2UpIHtcclxuICAgIGZvcmNlUmVmcmVzaCA9IGFzc2VydFBhcmFtKGZvcmNlUmVmcmVzaCwgXCJmb3JjZVJlZnJlc2hcIikuaXNCb29sZWFuKCkuaXNPcHRpb25hbCgpLmNoZWNrKGZhbHNlKTtcclxuICAgIGlmIChmb3JjZVJlZnJlc2ggfHwgIXRoaXMuX2VudGl0eUtleSkge1xyXG4gICAgICBsZXQgZW50aXR5VHlwZSA9IHRoaXMuZW50aXR5IS5lbnRpdHlUeXBlO1xyXG4gICAgICBsZXQga2V5UHJvcHMgPSBlbnRpdHlUeXBlLmtleVByb3BlcnRpZXM7XHJcbiAgICAgIGxldCB2YWx1ZXMgPSBrZXlQcm9wcy5tYXAoZnVuY3Rpb24gKHApIHtcclxuICAgICAgICByZXR1cm4gdGhpcy5lbnRpdHkuZ2V0UHJvcGVydHkocC5uYW1lKTtcclxuICAgICAgfSwgdGhpcyk7XHJcbiAgICAgIHRoaXMuX2VudGl0eUtleSA9IG5ldyBFbnRpdHlLZXkoZW50aXR5VHlwZSwgdmFsdWVzKTtcclxuICAgIH1cclxuICAgIHJldHVybiB0aGlzLl9lbnRpdHlLZXk7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICBSZXR1cm5zIHRoZSBlbnRpdHkgdG8gYW4gW1tFbnRpdHlTdGF0ZV1dIG9mICdVbmNoYW5nZWQnIGJ5IGNvbW1pdHRpbmcgYWxsIGNoYW5nZXMgbWFkZSBzaW5jZSB0aGUgZW50aXR5IHdhcyBsYXN0IHF1ZXJpZWRcclxuICBoYWQgJ2FjY2VwdENoYW5nZXMnIGNhbGxlZCBvbiBpdC5cclxuICA+ICAgICAgLy8gYXNzdW1lIG9yZGVyIGlzIGFuIG9yZGVyIGVudGl0eSBhdHRhY2hlZCB0byBhbiBFbnRpdHlNYW5hZ2VyLlxyXG4gID4gICAgICBvcmRlci5lbnRpdHlBc3BlY3QuYWNjZXB0Q2hhbmdlcygpO1xyXG4gID4gICAgICAvLyBUaGUgJ29yZGVyJyBlbnRpdHkgd2lsbCBub3cgYmUgaW4gYW4gJ1VuY2hhbmdlZCcgc3RhdGUgd2l0aCBhbnkgY2hhbmdlcyBjb21taXR0ZWQuXHJcbiAgKiovXHJcbiAgYWNjZXB0Q2hhbmdlcygpIHtcclxuICAgIGlmICghdGhpcy5lbnRpdHkpIHJldHVybjtcclxuICAgIHRoaXMuX2NoZWNrT3BlcmF0aW9uKFwiYWNjZXB0Q2hhbmdlc1wiKTtcclxuICAgIGxldCBlbSA9IHRoaXMuZW50aXR5TWFuYWdlciE7XHJcbiAgICBpZiAodGhpcy5lbnRpdHlTdGF0ZS5pc0RlbGV0ZWQoKSkge1xyXG4gICAgICBlbS5kZXRhY2hFbnRpdHkodGhpcy5lbnRpdHkpO1xyXG4gICAgfSBlbHNlIHtcclxuICAgICAgdGhpcy5zZXRVbmNoYW5nZWQoKTtcclxuICAgIH1cclxuICAgIGVtLmVudGl0eUNoYW5nZWQucHVibGlzaCh7IGVudGl0eUFjdGlvbjogRW50aXR5QWN0aW9uLkFjY2VwdENoYW5nZXMsIGVudGl0eTogdGhpcy5lbnRpdHkgfSk7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICBSZXR1cm5zIHRoZSBlbnRpdHkgdG8gYW4gW1tFbnRpdHlTdGF0ZV1dIG9mICdVbmNoYW5nZWQnIGJ5IHJlamVjdGluZyBhbGwgY2hhbmdlcyBtYWRlIHRvIGl0IHNpbmNlIHRoZSBlbnRpdHkgd2FzIGxhc3QgcXVlcmllZFxyXG4gIGhhZCAncmVqZWN0Q2hhbmdlcycgY2FsbGVkIG9uIGl0LlxyXG4gID4gICAgICAvLyBhc3N1bWUgb3JkZXIgaXMgYW4gb3JkZXIgZW50aXR5IGF0dGFjaGVkIHRvIGFuIEVudGl0eU1hbmFnZXIuXHJcbiAgPiAgICAgIG9yZGVyLmVudGl0eUFzcGVjdC5yZWplY3RDaGFuZ2VzKCk7XHJcbiAgPiAgICAgIC8vIFRoZSAnb3JkZXInIGVudGl0eSB3aWxsIG5vdyBiZSBpbiBhbiAnVW5jaGFuZ2VkJyBzdGF0ZSB3aXRoIGFueSBjaGFuZ2VzIHJlamVjdGVkLlxyXG4gICoqL1xyXG4gIHJlamVjdENoYW5nZXMoKSB7XHJcbiAgICB0aGlzLl9jaGVja09wZXJhdGlvbihcInJlamVjdENoYW5nZXNcIik7XHJcbiAgICBsZXQgZW50aXR5ID0gdGhpcy5lbnRpdHkhO1xyXG4gICAgbGV0IGVudGl0eU1hbmFnZXIgPSB0aGlzLmVudGl0eU1hbmFnZXIhO1xyXG4gICAgLy8gd2UgZG8gbm90IHdhbnQgUHJvcGVydHlDaGFuZ2Ugb3IgRW50aXR5Q2hhbmdlIGV2ZW50cyB0byBvY2N1ciBoZXJlXHJcbiAgICBjb3JlLnVzaW5nKGVudGl0eU1hbmFnZXIsIFwiaXNSZWplY3RpbmdDaGFuZ2VzXCIsIHRydWUsIGZ1bmN0aW9uICgpIHtcclxuICAgICAgcmVqZWN0Q2hhbmdlc0NvcmUoZW50aXR5KTtcclxuICAgIH0pO1xyXG4gICAgaWYgKHRoaXMuZW50aXR5U3RhdGUuaXNBZGRlZCgpKSB7XHJcbiAgICAgIC8vIG5leHQgbGluZSBpcyBuZWVkZWQgYmVjYXVzZSB0aGUgZm9sbG93aW5nIGxpbmUgd2lsbCBjYXVzZSB0aGlzLmVudGl0eU1hbmFnZXIgLT4gbnVsbDtcclxuICAgICAgZW50aXR5TWFuYWdlci5kZXRhY2hFbnRpdHkoZW50aXR5KTtcclxuICAgICAgLy8gbmVlZCB0byB0ZWxsIGVtIHRoYXQgYW4gZW50aXR5IHRoYXQgbmVlZGVkIHRvIGJlIHNhdmVkIG5vIGxvbmdlciBkb2VzLlxyXG4gICAgICBlbnRpdHlNYW5hZ2VyLl9ub3RpZnlTdGF0ZUNoYW5nZShlbnRpdHksIGZhbHNlKTtcclxuICAgIH0gZWxzZSB7XHJcbiAgICAgIGlmICh0aGlzLmVudGl0eVN0YXRlLmlzRGVsZXRlZCgpKSB7XHJcbiAgICAgICAgZW50aXR5TWFuYWdlci5fbGlua1JlbGF0ZWRFbnRpdGllcyhlbnRpdHkpO1xyXG4gICAgICB9XHJcbiAgICAgIHRoaXMuc2V0VW5jaGFuZ2VkKCk7XHJcbiAgICAgIC8vIHByb3BlcnR5Q2hhbmdlZCBwcm9wZXJ0eU5hbWUgaXMgbm90IHNwZWNpZmllZCBiZWNhdXNlIG1vcmUgdGhhbiBvbmUgcHJvcGVydHkgbWF5IGhhdmUgY2hhbmdlZC5cclxuICAgICAgdGhpcy5wcm9wZXJ0eUNoYW5nZWQucHVibGlzaCh7IGVudGl0eTogZW50aXR5LCBwcm9wZXJ0eU5hbWU6IG51bGwgfSk7XHJcbiAgICAgIGVudGl0eU1hbmFnZXIuZW50aXR5Q2hhbmdlZC5wdWJsaXNoKHsgZW50aXR5QWN0aW9uOiBFbnRpdHlBY3Rpb24uUmVqZWN0Q2hhbmdlcywgZW50aXR5OiBlbnRpdHkgfSk7XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICAvKiogIEBoaWRkZW4gQGludGVybmFsICovXHJcbiAgLy8gVE9ETzogcmVuYW1lIC0gYW5kIHVzZSAnXyc7IHVzZWQgb24gYm90aCBFbnRpdHlBc3BlY3QgYW5kIENvbXBsZXhBc3BlY3QgZm9yIHBvbHltb3JwaGljIHJlYXNvbnMuXHJcbiAgZ2V0UHJvcGVydHlQYXRoKHByb3BOYW1lOiBzdHJpbmcpIHtcclxuICAgIHJldHVybiBwcm9wTmFtZTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gIFNldHMgdGhlIGVudGl0eSB0byBhbiBFbnRpdHlTdGF0ZSBvZiAnQWRkZWQnLiAgVGhpcyBpcyBOT1QgdGhlIGVxdWl2YWxlbnQgb2YgY2FsbGluZyBbW0VudGl0eU1hbmFnZXIuYWRkRW50aXR5XV1cclxuICBiZWNhdXNlIG5vIGtleSBnZW5lcmF0aW9uIHdpbGwgb2NjdXIgZm9yIGF1dG9nZW5lcmF0ZWQga2V5cyBhcyBhIHJlc3VsdCBvZiB0aGlzIG9wZXJhdGlvbi4gQXMgYSByZXN1bHQgdGhpcyBvcGVyYXRpb24gY2FuIGJlIHByb2JsZW1hdGljXHJcbiAgdW5sZXNzIHlvdSBhcmUgY2VydGFpbiB0aGF0IHRoZSBlbnRpdHkgYmVpbmcgbWFya2VkICdBZGRlZCcgZG9lcyBub3QgYWxyZWFkeSBleGlzdCBpbiB0aGUgZGF0YWJhc2UgYW5kIGRvZXMgbm90IGhhdmUgYW4gYXV0b2dlbmVyYXRlZCBrZXkuXHJcbiAgVGhlIHNhbWUgb3BlcmF0aW9uIGNhbiBiZSBwZXJmb3JtZWQgYnkgY2FsbGluZyBbW0VudGl0eUFzcGVjdC5zZXRFbnRpdHlTdGF0ZV1dLlxyXG4gID4gICAgICAvLyBhc3N1bWUgb3JkZXIgaXMgYW4gb3JkZXIgZW50aXR5IGF0dGFjaGVkIHRvIGFuIEVudGl0eU1hbmFnZXIuXHJcbiAgPiAgICAgIG9yZGVyLmVudGl0eUFzcGVjdC5zZXRBZGRlZCgpO1xyXG4gID4gICAgICAvLyBUaGUgJ29yZGVyJyBlbnRpdHkgd2lsbCBub3cgYmUgaW4gYW4gJ0FkZGVkJyBzdGF0ZS5cclxuICAqKi9cclxuICBzZXRBZGRlZCgpIHtcclxuICAgIHJldHVybiB0aGlzLnNldEVudGl0eVN0YXRlKEVudGl0eVN0YXRlLkFkZGVkKTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gIFNldHMgdGhlIGVudGl0eSB0byBhbiBFbnRpdHlTdGF0ZSBvZiAnVW5jaGFuZ2VkJy4gIFRoaXMgaXMgYWxzbyB0aGUgZXF1aXZhbGVudCBvZiBjYWxsaW5nIFtbRW50aXR5QXNwZWN0LmFjY2VwdENoYW5nZXNdXS5cclxuICBUaGUgc2FtZSBvcGVyYXRpb24gY2FuIGJlIHBlcmZvcm1lZCBieSBjYWxsaW5nIFtbRW50aXR5QXNwZWN0LnNldEVudGl0eVN0YXRlXV0uXHJcbiAgPiAgICAgIC8vIGFzc3VtZSBvcmRlciBpcyBhbiBvcmRlciBlbnRpdHkgYXR0YWNoZWQgdG8gYW4gRW50aXR5TWFuYWdlci5cclxuICA+ICAgICAgb3JkZXIuZW50aXR5QXNwZWN0LnNldFVuY2hhbmdlZCgpO1xyXG4gID4gICAgICAvLyBUaGUgJ29yZGVyJyBlbnRpdHkgd2lsbCBub3cgYmUgaW4gYW4gJ1VuY2hhbmdlZCcgc3RhdGUgd2l0aCBhbnkgY2hhbmdlcyBjb21taXR0ZWQuXHJcbiAgKiovXHJcbiAgc2V0VW5jaGFuZ2VkID0gZnVuY3Rpb24gKCkge1xyXG4gICAgcmV0dXJuIHRoaXMuc2V0RW50aXR5U3RhdGUoRW50aXR5U3RhdGUuVW5jaGFuZ2VkKTtcclxuICB9O1xyXG5cclxuXHJcbiAgLyoqXHJcbiAgU2V0cyB0aGUgZW50aXR5IHRvIGFuIEVudGl0eVN0YXRlIG9mICdNb2RpZmllZCcuICBUaGlzIGNhbiBhbHNvIGJlIGFjaGlldmVkIGJ5IGNoYW5naW5nIHRoZSB2YWx1ZSBvZiBhbnkgcHJvcGVydHkgb24gYW4gJ1VuY2hhbmdlZCcgZW50aXR5LlxyXG4gIFRoZSBzYW1lIG9wZXJhdGlvbiBjYW4gYmUgcGVyZm9ybWVkIGJ5IGNhbGxpbmcgW1tFbnRpdHlBc3BlY3Quc2V0RW50aXR5U3RhdGVdXS5cclxuICA+ICAgICAgLy8gYXNzdW1lIG9yZGVyIGlzIGFuIG9yZGVyIGVudGl0eSBhdHRhY2hlZCB0byBhbiBFbnRpdHlNYW5hZ2VyLlxyXG4gID4gICAgICBvcmRlci5lbnRpdHlBc3BlY3Quc2V0TW9kaWZpZWQoKTtcclxuICA+ICAgICAgLy8gVGhlICdvcmRlcicgZW50aXR5IHdpbGwgbm93IGJlIGluIGEgJ01vZGlmaWVkJyBzdGF0ZS5cclxuICAqKi9cclxuICBzZXRNb2RpZmllZCA9IGZ1bmN0aW9uICgpIHtcclxuICAgIHJldHVybiB0aGlzLnNldEVudGl0eVN0YXRlKEVudGl0eVN0YXRlLk1vZGlmaWVkKTtcclxuICB9O1xyXG5cclxuICAvKipcclxuICBTZXRzIHRoZSBlbnRpdHkgdG8gYW4gRW50aXR5U3RhdGUgb2YgJ0RlbGV0ZWQnLiAgVGhpcyBib3RoIG1hcmtzIHRoZSBlbnRpdHkgYXMgYmVpbmcgc2NoZWR1bGVkIGZvciBkZWxldGlvbiBkdXJpbmcgdGhlIG5leHQgJ1NhdmUnIGNhbGxcclxuICBidXQgYWxzbyByZW1vdmVzIHRoZSBlbnRpdHkgZnJvbSBhbGwgb2YgaXRzIHJlbGF0ZWQgZW50aXRpZXMuXHJcbiAgVGhlIHNhbWUgb3BlcmF0aW9uIGNhbiBiZSBwZXJmb3JtZWQgYnkgY2FsbGluZyBbW0VudGl0eUFzcGVjdC5zZXRFbnRpdHlTdGF0ZV1dLlxyXG4gID4gICAgICAvLyBhc3N1bWUgb3JkZXIgaXMgYW4gb3JkZXIgZW50aXR5IGF0dGFjaGVkIHRvIGFuIEVudGl0eU1hbmFnZXIuXHJcbiAgPiAgICAgIG9yZGVyLmVudGl0eUFzcGVjdC5zZXREZWxldGVkKCk7XHJcbiAgPiAgICAgIC8vIFRoZSAnb3JkZXInIGVudGl0eSB3aWxsIG5vdyBiZSBpbiBhICdEZWxldGVkJyBzdGF0ZSBhbmQgaXQgd2lsbCBubyBsb25nZXIgaGF2ZSBhbnkgJ3JlbGF0ZWQnIGVudGl0aWVzLlxyXG4gICoqL1xyXG4gIHNldERlbGV0ZWQgPSBmdW5jdGlvbiAoKSB7XHJcbiAgICByZXR1cm4gdGhpcy5zZXRFbnRpdHlTdGF0ZShFbnRpdHlTdGF0ZS5EZWxldGVkKTtcclxuICB9O1xyXG5cclxuICAvKipcclxuICBTZXRzIHRoZSBlbnRpdHkgdG8gYW4gRW50aXR5U3RhdGUgb2YgJ0RldGFjaGVkJy4gIFRoaXMgcmVtb3ZlcyB0aGUgZW50aXR5IGZyb20gYWxsIG9mIGl0cyByZWxhdGVkIGVudGl0aWVzLCBidXQgZG9lcyBOT1QgY2hhbmdlIHRoZSBFbnRpdHlTdGF0ZSBvZiBhbnkgZXhpc3RpbmcgZW50aXRpZXMuXHJcbiAgVGhlIHNhbWUgb3BlcmF0aW9uIGNhbiBiZSBwZXJmb3JtZWQgYnkgY2FsbGluZyBbW0VudGl0eUFzcGVjdC5zZXRFbnRpdHlTdGF0ZV1dLlxyXG4gID4gICAgICAvLyBhc3N1bWUgb3JkZXIgaXMgYW4gb3JkZXIgZW50aXR5IGF0dGFjaGVkIHRvIGFuIEVudGl0eU1hbmFnZXIuXHJcbiAgPiAgICAgIG9yZGVyLmVudGl0eUFzcGVjdC5zZXREZXRhY2hlZCgpO1xyXG4gID4gICAgICAvLyBUaGUgJ29yZGVyJyBlbnRpdHkgd2lsbCBub3cgYmUgaW4gYSAnRGV0YWNoZWQnIHN0YXRlIGFuZCBpdCB3aWxsIG5vIGxvbmdlciBoYXZlIGFueSAncmVsYXRlZCcgZW50aXRpZXMuXHJcbiAgKiovXHJcbiAgc2V0RGV0YWNoZWQgPSBmdW5jdGlvbiAoKSB7XHJcbiAgICByZXR1cm4gdGhpcy5zZXRFbnRpdHlTdGF0ZShFbnRpdHlTdGF0ZS5EZXRhY2hlZCk7XHJcbiAgfTtcclxuXHJcbiAgLyoqXHJcbiAgU2V0cyB0aGUgZW50aXR5IHRvIHRoZSBzcGVjaWZpZWQgRW50aXR5U3RhdGUuIFNlZSBhbHNvICdzZXRVbmNoYW5nZWQnLCAnc2V0TW9kaWZpZWQnLCAnc2V0RGV0YWNoZWQnLCBldGMuXHJcbiAgPiAgICAgIC8vIGFzc3VtZSBvcmRlciBpcyBhbiBvcmRlciBlbnRpdHkgYXR0YWNoZWQgdG8gYW4gRW50aXR5TWFuYWdlci5cclxuICA+ICAgICAgb3JkZXIuZW50aXR5QXNwZWN0LnNldEVudGl0eVN0YXRlKEVudGl0eVN0YXRlLlVuY2hhbmdlZCk7XHJcbiAgPiAgICAgIC8vIFRoZSAnb3JkZXInIGVudGl0eSB3aWxsIG5vdyBiZSBpbiBhICdVbmNoYW5nZWQnIHN0YXRlLlxyXG4gICoqL1xyXG4gIHNldEVudGl0eVN0YXRlKGVudGl0eVN0YXRlOiBFbnRpdHlTdGF0ZSkge1xyXG4gICAgaWYgKHRoaXMuZW50aXR5U3RhdGUgPT09IGVudGl0eVN0YXRlKSByZXR1cm4gZmFsc2U7XHJcbiAgICB0aGlzLl9jaGVja09wZXJhdGlvbihcInNldEVudGl0eVN0YXRlXCIpO1xyXG4gICAgaWYgKHRoaXMuZW50aXR5U3RhdGUuaXNEZXRhY2hlZCgpKSB7XHJcbiAgICAgIHRocm93IG5ldyBFcnJvcihcIllvdSBjYW5ub3Qgc2V0IHRoZSAnZW50aXR5U3RhdGUnIG9mIGFuIGVudGl0eSB3aGVuIGl0IGlzIGRldGFjaGVkIC0gZXhjZXB0IGJ5IGZpcnN0IGF0dGFjaGluZyBpdCB0byBhbiBFbnRpdHlNYW5hZ2VyXCIpO1xyXG4gICAgfVxyXG4gICAgbGV0IGVudGl0eSA9IHRoaXMuZW50aXR5ITtcclxuICAgIGxldCBlbSA9IHRoaXMuZW50aXR5TWFuYWdlciE7XHJcbiAgICBsZXQgbmVlZHNTYXZlID0gdHJ1ZTtcclxuICAgIGlmIChlbnRpdHlTdGF0ZSA9PT0gRW50aXR5U3RhdGUuVW5jaGFuZ2VkKSB7XHJcbiAgICAgIGNsZWFyT3JpZ2luYWxWYWx1ZXMoZW50aXR5KTtcclxuICAgICAgZGVsZXRlIHRoaXMuaGFzVGVtcEtleTtcclxuICAgICAgbmVlZHNTYXZlID0gZmFsc2U7XHJcbiAgICB9IGVsc2UgaWYgKGVudGl0eVN0YXRlID09PSBFbnRpdHlTdGF0ZS5BZGRlZCkge1xyXG4gICAgICBjbGVhck9yaWdpbmFsVmFsdWVzKGVudGl0eSk7XHJcbiAgICAgIC8vIFRPRE86IG1vcmUgdG8gZG8gaGVyZS4uLiBsaWtlIHJlZ2VuZXJhdGluZyBrZXkgPz8/XHJcbiAgICB9IGVsc2UgaWYgKGVudGl0eVN0YXRlID09PSBFbnRpdHlTdGF0ZS5EZWxldGVkKSB7XHJcbiAgICAgIGlmICh0aGlzLmVudGl0eVN0YXRlLmlzQWRkZWQoKSkge1xyXG4gICAgICAgIC8vIHR1cm4gaXQgaW50byBhIGRldGFjaCBhbmQgZXhpdCBlYXJseVxyXG4gICAgICAgIHRoaXMuc2V0RW50aXR5U3RhdGUoRW50aXR5U3RhdGUuRGV0YWNoZWQpO1xyXG4gICAgICAgIHJldHVybiB0cnVlO1xyXG4gICAgICB9IGVsc2Uge1xyXG4gICAgICAgIC8vIFRPRE86IHRoaW5rIGFib3V0IGNhc2NhZGUgZGVsZXRlc1xyXG4gICAgICAgIC8vIGVudGl0eVN0YXRlIG5lZWRzIHRvIGJlIHNldCBpdCBlYXJseSBpbiB0aGlzIG9uZSBjYXNlIHRvIGluc3VyZSB0aGF0IGZrJ3MgYXJlIG5vdCBjbGVhcmVkLlxyXG4gICAgICAgIHRoaXMuZW50aXR5U3RhdGUgPSBFbnRpdHlTdGF0ZS5EZWxldGVkO1xyXG4gICAgICAgIHJlbW92ZUZyb21SZWxhdGlvbnMoZW50aXR5LCBFbnRpdHlTdGF0ZS5EZWxldGVkKTtcclxuICAgICAgfVxyXG4gICAgfSBlbHNlIGlmIChlbnRpdHlTdGF0ZSA9PT0gRW50aXR5U3RhdGUuTW9kaWZpZWQpIHtcclxuICAgICAgLy8gbm90aGluZyBleHRyYSBuZWVkZWRcclxuICAgIH0gZWxzZSBpZiAoZW50aXR5U3RhdGUgPT09IEVudGl0eVN0YXRlLkRldGFjaGVkKSB7XHJcbiAgICAgIGxldCBncm91cCA9IHRoaXMuZW50aXR5R3JvdXA7XHJcbiAgICAgIC8vIG5vIGdyb3VwID09PSBhbHJlYWR5IGRldGFjaGVkLlxyXG4gICAgICBpZiAoIWdyb3VwKSByZXR1cm4gZmFsc2U7XHJcbiAgICAgIGdyb3VwLmRldGFjaEVudGl0eShlbnRpdHkpO1xyXG4gICAgICAvLyBuZWVkcyB0byBvY2N1ciBlYXJseSBoZXJlIC0gc28gdGhpcyBJUyBkZWxpYmVyYXRlbHkgcmVkdW5kZW50IHdpdGggdGhlIHNhbWUgY29kZSBsYXRlciBpbiB0aGlzIG1ldGhvZC5cclxuICAgICAgdGhpcy5lbnRpdHlTdGF0ZSA9IGVudGl0eVN0YXRlO1xyXG4gICAgICByZW1vdmVGcm9tUmVsYXRpb25zKGVudGl0eSwgRW50aXR5U3RhdGUuRGV0YWNoZWQpO1xyXG4gICAgICB0aGlzLl9kZXRhY2goKTtcclxuICAgICAgZW0uZW50aXR5Q2hhbmdlZC5wdWJsaXNoKHsgZW50aXR5QWN0aW9uOiBFbnRpdHlBY3Rpb24uRGV0YWNoLCBlbnRpdHk6IGVudGl0eSB9KTtcclxuICAgICAgbmVlZHNTYXZlID0gZmFsc2U7XHJcbiAgICB9XHJcbiAgICB0aGlzLmVudGl0eVN0YXRlID0gZW50aXR5U3RhdGU7XHJcbiAgICBlbS5fbm90aWZ5U3RhdGVDaGFuZ2UoZW50aXR5LCBuZWVkc1NhdmUpO1xyXG4gICAgcmV0dXJuIHRydWU7XHJcbiAgfVxyXG5cclxuICBsb2FkTmF2aWdhdGlvblByb3BlcnR5KG5hdmlnYXRpb25Qcm9wZXJ0eTogc3RyaW5nLCBjYWxsYmFjaz86IFF1ZXJ5U3VjY2Vzc0NhbGxiYWNrLCBlcnJvckNhbGxiYWNrPzogUXVlcnlFcnJvckNhbGxiYWNrKTogUHJvbWlzZTxRdWVyeVJlc3VsdD47XHJcbiAgbG9hZE5hdmlnYXRpb25Qcm9wZXJ0eShuYXZpZ2F0aW9uUHJvcGVydHk6IE5hdmlnYXRpb25Qcm9wZXJ0eSwgY2FsbGJhY2s/OiBRdWVyeVN1Y2Nlc3NDYWxsYmFjaywgZXJyb3JDYWxsYmFjaz86IFF1ZXJ5RXJyb3JDYWxsYmFjayk6IFByb21pc2U8UXVlcnlSZXN1bHQ+O1xyXG4gIC8qKlxyXG4gIFBlcmZvcm1zIGEgcXVlcnkgZm9yIHRoZSB2YWx1ZSBvZiBhIHNwZWNpZmllZCBbW05hdmlnYXRpb25Qcm9wZXJ0eV1dLiBfX0FzeW5jX19cclxuICA+ICAgICAgZW1wLmVudGl0eUFzcGVjdC5sb2FkTmF2aWdhdGlvblByb3BlcnR5KFwiT3JkZXJzXCIpLnRoZW4oZnVuY3Rpb24gKGRhdGEpIHtcclxuICA+ICAgICAgICAgIHZhciBvcmRlcnMgPSBkYXRhLnJlc3VsdHM7XHJcbiAgPiAgICAgIH0pLmNhdGNoKGZ1bmN0aW9uIChleGNlcHRpb24pIHtcclxuICA+ICAgICAgICAgIC8vIGhhbmRsZSBleGNlcHRpb24gaGVyZTtcclxuICA+ICAgICAgfSk7XHJcbiAgQHBhcmFtIG5hdmlnYXRpb25Qcm9wZXJ0eSAtIFRoZSBOYXZpZ2F0aW9uUHJvcGVydHkgb3IgdGhlIG5hbWUgb2YgdGhlIE5hdmlnYXRpb25Qcm9wZXJ0eSB0byAnbG9hZCcuXHJcbiAgQHBhcmFtIGNhbGxiYWNrIC0gRnVuY3Rpb24gdG8gY2FsbCBvbiBzdWNjZXNzLlxyXG4gIEBwYXJhbSBlcnJvckNhbGxiYWNrIC0gRnVuY3Rpb24gdG8gY2FsbCBvbiBmYWlsdXJlLlxyXG4gIEByZXR1cm4gUHJvbWlzZSB3aXRoIHNoYXBlXHJcbiAgICAtIHJlc3VsdHMge0FycmF5IG9mIEVudGl0eX1cclxuICAgIC0gcXVlcnkge0VudGl0eVF1ZXJ5fSBUaGUgb3JpZ2luYWwgcXVlcnlcclxuICAgIC0gaHR0cFJlc3BvbnNlIHtodHRwUmVzcG9uc2V9IFRoZSBIdHRwUmVzcG9uc2UgcmV0dXJuZWQgZnJvbSB0aGUgc2VydmVyLlxyXG4gICoqL1xyXG4gIGxvYWROYXZpZ2F0aW9uUHJvcGVydHkobmF2aWdhdGlvblByb3BlcnR5OiBOYXZpZ2F0aW9uUHJvcGVydHkgfCBzdHJpbmcsIGNhbGxiYWNrOiBRdWVyeVN1Y2Nlc3NDYWxsYmFjaywgZXJyb3JDYWxsYmFjazogUXVlcnlFcnJvckNhbGxiYWNrKSB7XHJcbiAgICBsZXQgZW50aXR5ID0gdGhpcy5lbnRpdHkhO1xyXG4gICAgbGV0IG5hdlByb3BlcnR5ID0gZW50aXR5LmVudGl0eVR5cGUuX2NoZWNrTmF2UHJvcGVydHkobmF2aWdhdGlvblByb3BlcnR5KTtcclxuICAgIGxldCBxdWVyeSA9IEVudGl0eVF1ZXJ5LmZyb21FbnRpdHlOYXZpZ2F0aW9uKGVudGl0eSwgbmF2UHJvcGVydHkpO1xyXG4gICAgLy8gcmV0dXJuIGVudGl0eS5lbnRpdHlBc3BlY3QuZW50aXR5TWFuYWdlci5leGVjdXRlUXVlcnkocXVlcnksIGNhbGxiYWNrLCBlcnJvckNhbGxiYWNrKTtcclxuICAgIGxldCBwcm9taXNlID0gZW50aXR5LmVudGl0eUFzcGVjdC5lbnRpdHlNYW5hZ2VyIS5leGVjdXRlUXVlcnkocXVlcnkpO1xyXG5cclxuICAgIHJldHVybiBwcm9taXNlLnRoZW4oKGRhdGEpID0+IHtcclxuICAgICAgdGhpcy5fbWFya0FzTG9hZGVkKG5hdlByb3BlcnR5Lm5hbWUpO1xyXG4gICAgICBpZiAoY2FsbGJhY2spIGNhbGxiYWNrKGRhdGEpO1xyXG4gICAgICByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKGRhdGEpO1xyXG4gICAgfSwgKGVycm9yKSA9PiB7XHJcbiAgICAgIGlmIChlcnJvckNhbGxiYWNrKSBlcnJvckNhbGxiYWNrKGVycm9yKTtcclxuICAgICAgcmV0dXJuIFByb21pc2UucmVqZWN0KGVycm9yKTtcclxuICAgIH0pO1xyXG5cclxuICB9XHJcblxyXG4gIC8qKlxyXG4gIE1hcmtzIHRoaXMgbmF2aWdhdGlvblByb3BlcnR5IG9uIHRoaXMgZW50aXR5IGFzIGFscmVhZHkgaGF2aW5nIGJlZW4gbG9hZGVkLlxyXG4gID4gICAgICBlbXAuZW50aXR5QXNwZWN0Lm1hcmtOYXZpZ2F0aW9uUHJvcGVydHlBc0xvYWRlZChcIk9yZGVyc1wiKTtcclxuICBAcGFyYW0gbmF2aWdhdGlvblByb3BlcnR5IC0gVGhlIE5hdmlnYXRpb25Qcm9wZXJ0eSBvciBuYW1lIG9mIE5hdmlnYXRpb25Qcm9wZXJ0eSB0byAnbG9hZCcuXHJcbiAgKiovXHJcbiAgbWFya05hdmlnYXRpb25Qcm9wZXJ0eUFzTG9hZGVkKG5hdmlnYXRpb25Qcm9wZXJ0eTogTmF2aWdhdGlvblByb3BlcnR5IHwgc3RyaW5nKSB7XHJcbiAgICBpZiAoIXRoaXMuZW50aXR5KSByZXR1cm47XHJcbiAgICBsZXQgbmF2UHJvcGVydHkgPSB0aGlzLmVudGl0eS5lbnRpdHlUeXBlLl9jaGVja05hdlByb3BlcnR5KG5hdmlnYXRpb25Qcm9wZXJ0eSk7XHJcbiAgICB0aGlzLl9tYXJrQXNMb2FkZWQobmF2UHJvcGVydHkubmFtZSk7XHJcbiAgfVxyXG5cclxuICBpc05hdmlnYXRpb25Qcm9wZXJ0eUxvYWRlZChuYXZpZ2F0aW9uUHJvcGVydHk6IHN0cmluZyk6IGJvb2xlYW47XHJcbiAgaXNOYXZpZ2F0aW9uUHJvcGVydHlMb2FkZWQobmF2aWdhdGlvblByb3BlcnR5OiBOYXZpZ2F0aW9uUHJvcGVydHkpOiBib29sZWFuO1xyXG4gIC8qKlxyXG4gIERldGVybWluZXMgd2hldGhlciBhIG5hdmlnYXRpb25Qcm9wZXJ0eSBvbiB0aGlzIGVudGl0eSBoYXMgYWxyZWFkeSBiZWVuIGxvYWRlZC5cclxuXHJcbiAgQSBuYXZpZ2F0aW9uIHByb3BlcnR5IGlzIGNvbnNpZGVyZWQgbG9hZGVkIHdoZW4gYW55IG9mIHRoZSBmb2xsb3dpbmcgdGhyZWUgY29uZGl0aW9ucyBhcHBsaWVzOlxyXG5cclxuICAgIDEuIEl0IHdhcyBmZXRjaGVkIGZyb20gdGhlIGJhY2tlbmQgc2VydmVyLlxyXG4gICAgICAgIDxici8+ICAgVGhpcyBjYW4gYmUgdGhlIHJlc3VsdCBvZiBhbiBleHBhbmQgcXVlcnkgb3IgYSBjYWxsIHRvIHRoZSBbW0VudGl0eUFzcGVjdC5sb2FkTmF2aWdhdGlvblByb3BlcnR5XV0gbWV0aG9kLlxyXG4gICAgICAgIDxici8+ICAgTm90ZSB0aGF0IGV2ZW4gaWYgdGhlIGZldGNoIHJldHVybnMgbm90aGluZyB0aGUgcHJvcGVydHkgaXMgc3RpbGwgbWFya2VkIGFzIGxvYWRlZCBpbiB0aGlzIGNhc2UuXHJcbiAgICAxLiBUaGUgcHJvcGVydHkgaXMgc2NhbGFyIGFuZCBoYXMgYmVlbiBzZXQgdG8gYSBub25udWxsIHZhbHVlLlxyXG4gICAgMS4gVGhlIFtbRW50aXR5QXNwZWN0Lm1hcmtOYXZpZ2F0aW9uUHJvcGVydHlBc0xvYWRlZF1dIHdhcyBjYWxsZWQuXHJcbiAgXHJcbiAgPiAgICAgdmFyIHdhc0xvYWRlZCA9IGVtcC5lbnRpdHlBc3BlY3QuaXNOYXZpZ2F0aW9uUHJvcGVydHlMb2FkZWQoXCJPcmRlcnNcIik7XHJcbiAgQHBhcmFtIG5hdmlnYXRpb25Qcm9wZXJ0eSAtIFRoZSBOYXZpZ2F0aW9uUHJvcGVydHkgb3IgbmFtZSBvZiBOYXZpZ2F0aW9uUHJvcGVydHkgdG8gJ2xvYWQnLlxyXG4gICoqL1xyXG4gIGlzTmF2aWdhdGlvblByb3BlcnR5TG9hZGVkKG5hdmlnYXRpb25Qcm9wZXJ0eTogTmF2aWdhdGlvblByb3BlcnR5IHwgc3RyaW5nKSB7XHJcbiAgICBpZiAoIXRoaXMuZW50aXR5KSByZXR1cm47XHJcbiAgICBsZXQgbmF2UHJvcGVydHkgPSB0aGlzLmVudGl0eS5lbnRpdHlUeXBlLl9jaGVja05hdlByb3BlcnR5KG5hdmlnYXRpb25Qcm9wZXJ0eSk7XHJcbiAgICBpZiAobmF2UHJvcGVydHkuaXNTY2FsYXIgJiYgdGhpcy5lbnRpdHkuZ2V0UHJvcGVydHkobmF2UHJvcGVydHkubmFtZSkgIT0gbnVsbCkge1xyXG4gICAgICByZXR1cm4gdHJ1ZTtcclxuICAgIH1cclxuICAgIHJldHVybiB0aGlzLl9sb2FkZWROcHMgJiYgdGhpcy5fbG9hZGVkTnBzLmluZGV4T2YobmF2UHJvcGVydHkubmFtZSkgPj0gMDtcclxuICB9XHJcblxyXG4gIC8qKiBAaGlkZGVuIEBpbnRlcm5hbCAqL1xyXG4gIF9tYXJrQXNMb2FkZWQobmF2UHJvcE5hbWU6IHN0cmluZykge1xyXG4gICAgdGhpcy5fbG9hZGVkTnBzID0gdGhpcy5fbG9hZGVkTnBzIHx8IFtdO1xyXG4gICAgY29yZS5hcnJheUFkZEl0ZW1VbmlxdWUodGhpcy5fbG9hZGVkTnBzLCBuYXZQcm9wTmFtZSk7XHJcbiAgfVxyXG5cclxuXHJcbiAgLyoqXHJcbiAgUGVyZm9ybXMgdmFsaWRhdGlvbiBvbiB0aGUgZW50aXR5LCBhbnkgZXJyb3JzIGVuY291bnRlcmVkIGR1cmluZyB0aGUgdmFsaWRhdGlvbiBhcmUgYXZhaWxhYmxlIHZpYSB0aGVcclxuICBbW0VudGl0eUFzcGVjdC5nZXRWYWxpZGF0aW9uRXJyb3JzXV0gbWV0aG9kLiBWYWxpZGF0aW5nIGFuIGVudGl0eSBtZWFucyBleGVjdXRpbmdcclxuICBhbGwgb2YgdGhlIHZhbGlkYXRvcnMgb24gYm90aCB0aGUgZW50aXR5IGl0c2VsZiBhcyB3ZWxsIGFzIHRob3NlIG9uIGVhY2ggb2YgaXRzIHByb3BlcnRpZXMuXHJcbiAgPiAgICAgIC8vIGFzc3VtZSBvcmRlciBpcyBhbiBvcmRlciBlbnRpdHkgYXR0YWNoZWQgdG8gYW4gRW50aXR5TWFuYWdlci5cclxuICA+ICAgICAgdmFyIGlzT2sgPSBvcmRlci5lbnRpdHlBc3BlY3QudmFsaWRhdGVFbnRpdHkoKTtcclxuICA+ICAgICAgLy8gaXNPayB3aWxsIGJlICd0cnVlJyBpZiB0aGVyZSBhcmUgbm8gZXJyb3JzIG9uIHRoZSBlbnRpdHkuXHJcbiAgPiAgICAgIGlmICghaXNPaykge1xyXG4gID4gICAgICAgICAgdmFyIGVycm9ycyA9IG9yZGVyLmVudGl0eUFzcGVjdC5nZXRWYWxpZGF0aW9uRXJyb3JzKCk7XHJcbiAgPiAgICAgIH1cclxuICBAcmV0dXJuIFdoZXRoZXIgdGhlIGVudGl0eSBwYXNzZWQgdmFsaWRhdGlvbi5cclxuICAqKi9cclxuICB2YWxpZGF0ZUVudGl0eSgpIHtcclxuICAgIGxldCBvayA9IHRydWU7XHJcbiAgICB0aGlzLl9wcm9jZXNzVmFsaWRhdGlvbk9wQW5kUHVibGlzaChmdW5jdGlvbiAodGhhdDogYW55KSB7XHJcbiAgICAgIG9rID0gdmFsaWRhdGVUYXJnZXQodGhhdC5lbnRpdHkpO1xyXG4gICAgfSk7XHJcbiAgICByZXR1cm4gb2s7XHJcbiAgfVxyXG5cclxuICB2YWxpZGF0ZVByb3BlcnR5KHByb3BlcnR5OiBzdHJpbmcsIGNvbnRleHQ/OiBhbnkpOiBib29sZWFuO1xyXG4gIHZhbGlkYXRlUHJvcGVydHkocHJvcGVydHk6IERhdGFQcm9wZXJ0eSwgY29udGV4dD86IGFueSk6IGJvb2xlYW47XHJcbiAgdmFsaWRhdGVQcm9wZXJ0eShwcm9wZXJ0eTogTmF2aWdhdGlvblByb3BlcnR5LCBjb250ZXh0PzogYW55KTogYm9vbGVhbjtcclxuICAvKipcclxuICBQZXJmb3JtcyB2YWxpZGF0aW9uIG9uIGEgc3BlY2lmaWMgcHJvcGVydHkgb2YgdGhpcyBlbnRpdHksIGFueSBlcnJvcnMgZW5jb3VudGVyZWQgZHVyaW5nIHRoZSB2YWxpZGF0aW9uIGFyZSBhdmFpbGFibGUgdmlhIHRoZVxyXG4gIFtbRW50aXR5QXNwZWN0LmdldFZhbGlkYXRpb25FcnJvcnNdXSBtZXRob2QuIFZhbGlkYXRpbmcgYSBwcm9wZXJ0eSBtZWFucyBleGVjdXRpbmdcclxuICBhbGwgb2YgdGhlIHZhbGlkYXRvcnMgb24gdGhlIHNwZWNpZmllZCBwcm9wZXJ0eS4gIFRoaXMgY2FsbCBpcyBhbHNvIG1hZGUgYXV0b21hdGljYWxseSBhbnl0aW1lIGEgcHJvcGVydHlcclxuICBvZiBhbiBlbnRpdHkgaXMgY2hhbmdlZC5cclxuICA+ICAgICAgLy8gYXNzdW1lIG9yZGVyIGlzIGFuIG9yZGVyIGVudGl0eSBhdHRhY2hlZCB0byBhbiBFbnRpdHlNYW5hZ2VyLlxyXG4gID4gICAgICB2YXIgaXNPayA9IG9yZGVyLmVudGl0eUFzcGVjdC52YWxpZGF0ZVByb3BlcnR5KFwiT3JkZXJcIik7XHJcblxyXG4gIG9yXHJcbiAgPiAgICAgIHZhciBvcmRlckRhdGVQcm9wZXJ0eSA9IG9yZGVyLmVudGl0eVR5cGUuZ2V0UHJvcGVydHkoXCJPcmRlckRhdGVcIik7XHJcbiAgPiAgICAgIHZhciBpc09rID0gb3JkZXIuZW50aXR5QXNwZWN0LnZhbGlkYXRlUHJvcGVydHkoT3JkZXJEYXRlUHJvcGVydHkpO1xyXG4gIEBwYXJhbSBwcm9wZXJ0eSAtIFRoZSBbW0RhdGFQcm9wZXJ0eV1dIG9yIFtbTmF2aWdhdGlvblByb3BlcnR5XV0gdG8gdmFsaWRhdGUgb3IgYSBzdHJpbmcgXHJcbiAgd2l0aCB0aGUgbmFtZSBvZiB0aGUgcHJvcGVydHkgb3IgYSBwcm9wZXJ0eSBwYXRoIHdpdGggdGhlIHBhdGggdG8gYSBwcm9wZXJ0eSBvZiBhIGNvbXBsZXggb2JqZWN0LlxyXG4gIEBwYXJhbSBjb250ZXh0IC0gIEEgY29udGV4dCBvYmplY3QgdXNlZCB0byBwYXNzIGFkZGl0aW9uYWwgaW5mb3JtYXRpb24gdG8gZWFjaCBbW1ZhbGlkYXRvcl1dLlxyXG4gIEByZXR1cm4gV2hldGhlciB0aGUgZW50aXR5IHBhc3NlZCB2YWxpZGF0aW9uLlxyXG4gICoqL1xyXG4gIHZhbGlkYXRlUHJvcGVydHkocHJvcGVydHk6IEVudGl0eVByb3BlcnR5IHwgc3RyaW5nLCBjb250ZXh0OiBhbnkpIHtcclxuICAgIGxldCB2YWx1ZSA9IHRoaXMuZ2V0UHJvcGVydHlWYWx1ZShwcm9wZXJ0eSk7IC8vIHBlcmZvcm1zIHZhbGlkYXRpb25zXHJcbiAgICBpZiAodmFsdWUgJiYgdmFsdWUuY29tcGxleEFzcGVjdCkge1xyXG4gICAgICByZXR1cm4gdmFsaWRhdGVUYXJnZXQodmFsdWUpO1xyXG4gICAgfVxyXG4gICAgY29udGV4dCA9IGNvbnRleHQgfHwge307XHJcbiAgICBjb250ZXh0LmVudGl0eSA9IHRoaXMuZW50aXR5O1xyXG4gICAgaWYgKHR5cGVvZiBwcm9wZXJ0eSA9PT0gXCJzdHJpbmdcIikge1xyXG4gICAgICBjb250ZXh0LnByb3BlcnR5ID0gdGhpcy5lbnRpdHkhLmVudGl0eVR5cGUuZ2V0UHJvcGVydHkocHJvcGVydHksIHRydWUpO1xyXG4gICAgICBjb250ZXh0LnByb3BlcnR5TmFtZSA9IHByb3BlcnR5O1xyXG4gICAgfSBlbHNlIHtcclxuICAgICAgY29udGV4dC5wcm9wZXJ0eSA9IHByb3BlcnR5O1xyXG4gICAgICBjb250ZXh0LnByb3BlcnR5TmFtZSA9IHByb3BlcnR5Lm5hbWU7XHJcbiAgICB9XHJcblxyXG4gICAgcmV0dXJuIHRoaXMuX3ZhbGlkYXRlUHJvcGVydHkodmFsdWUsIGNvbnRleHQpO1xyXG4gIH1cclxuXHJcbiAgZ2V0VmFsaWRhdGlvbkVycm9ycygpOiBWYWxpZGF0aW9uRXJyb3JbXTtcclxuICBnZXRWYWxpZGF0aW9uRXJyb3JzKHByb3BlcnR5OiBzdHJpbmcpOiBWYWxpZGF0aW9uRXJyb3JbXTtcclxuICBnZXRWYWxpZGF0aW9uRXJyb3JzKHByb3BlcnR5OiBFbnRpdHlQcm9wZXJ0eSk6IFZhbGlkYXRpb25FcnJvcltdO1xyXG4gIC8qKlxyXG4gIFJldHVybnMgdGhlIHZhbGlkYXRpb24gZXJyb3JzIGFzc29jaWF0ZWQgd2l0aCBlaXRoZXIgdGhlIGVudGlyZSBlbnRpdHkgb3IgYW55IHNwZWNpZmllZCBwcm9wZXJ0eS5cclxuICBcclxuICBUaGlzIG1ldGhvZCBjYW4gcmV0dXJuIGFsbCBvZiB0aGUgZXJyb3JzIGZvciBhbiBFbnRpdHlcclxuICA+ICAgICAgLy8gYXNzdW1lIG9yZGVyIGlzIGFuIG9yZGVyIGVudGl0eSBhdHRhY2hlZCB0byBhbiBFbnRpdHlNYW5hZ2VyLlxyXG4gID4gICAgICB2YXIgdmFsRXJyb3JzID0gb3JkZXIuZW50aXR5QXNwZWN0LmdldFZhbGlkYXRpb25FcnJvcnMoKTtcclxuXHJcbiAgYXMgd2VsbCBhcyB0aG9zZSBmb3IganVzdCBhIHNwZWNpZmljIHByb3BlcnR5LlxyXG4gID4gICAgICAvLyBhc3N1bWUgb3JkZXIgaXMgYW4gb3JkZXIgZW50aXR5IGF0dGFjaGVkIHRvIGFuIEVudGl0eU1hbmFnZXIuXHJcbiAgPiAgICAgIHZhciBvcmRlckRhdGVFcnJvcnMgPSBvcmRlci5lbnRpdHlBc3BlY3QuZ2V0VmFsaWRhdGlvbkVycm9ycyhcIk9yZGVyRGF0ZVwiKTtcclxuXHJcbiAgd2hpY2ggY2FuIGFsc28gYmUgZXhwcmVzc2VkIGFzXHJcbiAgPiAgICAgIC8vIGFzc3VtZSBvcmRlciBpcyBhbiBvcmRlciBlbnRpdHkgYXR0YWNoZWQgdG8gYW4gRW50aXR5TWFuYWdlci5cclxuICA+ICAgICAgdmFyIG9yZGVyRGF0ZVByb3BlcnR5ID0gb3JkZXIuZW50aXR5VHlwZS5nZXRQcm9wZXJ0eShcIk9yZGVyRGF0ZVwiKTtcclxuICA+ICAgICAgdmFyIG9yZGVyRGF0ZUVycm9ycyA9IG9yZGVyLmVudGl0eUFzcGVjdC5nZXRWYWxpZGF0aW9uRXJyb3JzKG9yZGVyRGF0ZVByb3BlcnR5KTtcclxuICBAcGFyYW0gcHJvcGVydHkgLSBUaGUgcHJvcGVydHkgZm9yIHdoaWNoIHZhbGlkYXRpb24gZXJyb3JzIHNob3VsZCBiZSByZXRyaWV2ZWQuXHJcbiAgSWYgb21pdHRlZCwgYWxsIG9mIHRoZSB2YWxpZGF0aW9uIGVycm9ycyBmb3IgdGhpcyBlbnRpdHkgd2lsbCBiZSByZXR1cm5lZC5cclxuICBAcmV0dXJuIEEgYXJyYXkgb2YgdmFsaWRhdGlvbiBlcnJvcnMuXHJcbiAgKiovXHJcbiAgZ2V0VmFsaWRhdGlvbkVycm9ycyhwcm9wZXJ0eT86IERhdGFQcm9wZXJ0eSB8IE5hdmlnYXRpb25Qcm9wZXJ0eSB8IHN0cmluZykge1xyXG4gICAgYXNzZXJ0UGFyYW0ocHJvcGVydHksIFwicHJvcGVydHlcIikuaXNPcHRpb25hbCgpLmlzRW50aXR5UHJvcGVydHkoKS5vcigpLmlzU3RyaW5nKCkuY2hlY2soKTtcclxuICAgIGxldCByZXN1bHQgPSBjb3JlLmdldE93blByb3BlcnR5VmFsdWVzKHRoaXMuX3ZhbGlkYXRpb25FcnJvcnMpO1xyXG4gICAgaWYgKHByb3BlcnR5KSB7XHJcbiAgICAgIGxldCBwcm9wZXJ0eU5hbWUgPSB0eXBlb2YgKHByb3BlcnR5KSA9PT0gJ3N0cmluZycgPyBwcm9wZXJ0eSA6IHByb3BlcnR5Lm5hbWU7XHJcbiAgICAgIHJlc3VsdCA9IHJlc3VsdC5maWx0ZXIoZnVuY3Rpb24gKHZlOiBWYWxpZGF0aW9uRXJyb3IpIHtcclxuICAgICAgICByZXR1cm4gdmUucHJvcGVydHkgJiYgKHZlLnByb3BlcnR5Lm5hbWUgPT09IHByb3BlcnR5TmFtZSB8fCAocHJvcGVydHlOYW1lLmluZGV4T2YoXCIuXCIpICE9PSAtMSAmJiB2ZS5wcm9wZXJ0eU5hbWUgPT09IHByb3BlcnR5TmFtZSkpO1xyXG4gICAgICB9KTtcclxuICAgIH1cclxuICAgIHJldHVybiByZXN1bHQ7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICBBZGRzIGEgdmFsaWRhdGlvbiBlcnJvci5cclxuICAqKi9cclxuICBhZGRWYWxpZGF0aW9uRXJyb3IodmFsaWRhdGlvbkVycm9yOiBWYWxpZGF0aW9uRXJyb3IpIHtcclxuICAgIGFzc2VydFBhcmFtKHZhbGlkYXRpb25FcnJvciwgXCJ2YWxpZGF0aW9uRXJyb3JcIikuaXNJbnN0YW5jZU9mKFZhbGlkYXRpb25FcnJvcikuY2hlY2soKTtcclxuICAgIHRoaXMuX3Byb2Nlc3NWYWxpZGF0aW9uT3BBbmRQdWJsaXNoKGZ1bmN0aW9uICh0aGF0OiBhbnkpIHtcclxuICAgICAgdGhhdC5fYWRkVmFsaWRhdGlvbkVycm9yKHZhbGlkYXRpb25FcnJvcik7XHJcbiAgICB9KTtcclxuICB9XHJcblxyXG4gIHJlbW92ZVZhbGlkYXRpb25FcnJvcih2YWxpZGF0aW9uRXJyb3I6IFZhbGlkYXRpb25FcnJvcik6IHZvaWQ7XHJcbiAgcmVtb3ZlVmFsaWRhdGlvbkVycm9yKHZhbGlkYXRpb25LZXk6IHN0cmluZyk6IHZvaWQ7XHJcbiAgLyoqXHJcbiAgUmVtb3ZlcyBhIHZhbGlkYXRpb24gZXJyb3IuXHJcbiAgQHBhcmFtIHZhbGlkYXRpb25FcnJvck9yS2V5IC0gRWl0aGVyIGEgVmFsaWRhdGlvbkVycm9yIG9yIGEgVmFsaWRhdGlvbkVycm9yICdrZXknIHZhbHVlXHJcbiAgKiovXHJcbiAgcmVtb3ZlVmFsaWRhdGlvbkVycm9yKHZhbGlkYXRpb25FcnJvck9yS2V5OiBWYWxpZGF0aW9uRXJyb3IgfCBzdHJpbmcpIHtcclxuICAgIGFzc2VydFBhcmFtKHZhbGlkYXRpb25FcnJvck9yS2V5LCBcInZhbGlkYXRpb25FcnJvck9yS2V5XCIpLmlzU3RyaW5nKCkub3IoKS5pc0luc3RhbmNlT2YoVmFsaWRhdGlvbkVycm9yKS5vcigpLmlzSW5zdGFuY2VPZihWYWxpZGF0b3IpLmNoZWNrKCk7XHJcblxyXG4gICAgbGV0IGtleSA9ICh0eXBlb2YgKHZhbGlkYXRpb25FcnJvck9yS2V5KSA9PT0gXCJzdHJpbmdcIikgPyB2YWxpZGF0aW9uRXJyb3JPcktleSA6IHZhbGlkYXRpb25FcnJvck9yS2V5LmtleTtcclxuICAgIHRoaXMuX3Byb2Nlc3NWYWxpZGF0aW9uT3BBbmRQdWJsaXNoKGZ1bmN0aW9uICh0aGF0OiBhbnkpIHtcclxuICAgICAgdGhhdC5fcmVtb3ZlVmFsaWRhdGlvbkVycm9yKGtleSk7XHJcbiAgICB9KTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gIFJlbW92ZXMgYWxsIG9mIHRoZSB2YWxpZGF0aW9uIGVycm9ycyBmb3IgYSBzcGVjaWZpZWQgZW50aXR5XHJcbiAgKiovXHJcbiAgY2xlYXJWYWxpZGF0aW9uRXJyb3JzKCkge1xyXG4gICAgdGhpcy5fcHJvY2Vzc1ZhbGlkYXRpb25PcEFuZFB1Ymxpc2goZnVuY3Rpb24gKHRoYXQ6IGFueSkge1xyXG4gICAgICBjb3JlLm9iamVjdEZvckVhY2godGhhdC5fdmFsaWRhdGlvbkVycm9ycywgZnVuY3Rpb24gKGtleTogc3RyaW5nLCB2YWxFcnJvcjogVmFsaWRhdGlvbkVycm9yKSB7XHJcbiAgICAgICAgaWYgKHZhbEVycm9yKSB7XHJcbiAgICAgICAgICBkZWxldGUgdGhhdC5fdmFsaWRhdGlvbkVycm9yc1trZXldO1xyXG4gICAgICAgICAgdGhhdC5fcGVuZGluZ1ZhbGlkYXRpb25SZXN1bHQucmVtb3ZlZC5wdXNoKHZhbEVycm9yKTtcclxuICAgICAgICB9XHJcbiAgICAgIH0pO1xyXG4gICAgICB0aGF0Lmhhc1ZhbGlkYXRpb25FcnJvcnMgPSAhY29yZS5pc0VtcHR5KHRoYXQuX3ZhbGlkYXRpb25FcnJvcnMpO1xyXG4gICAgfSk7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICBSZXR1cm5zIGFuIFtbRW50aXR5S2V5XV0gZm9yIHRoZSBlbnRpdHkgcG9pbnRlZCB0byBieSB0aGUgc3BlY2lmaWVkIHNjYWxhciBOYXZpZ2F0aW9uUHJvcGVydHkuXHJcbiAgVGhpcyBvbmx5IHJldHVybnMgYW4gRW50aXR5S2V5IGlmIHRoZSBjdXJyZW50IGVudGl0eSBpcyBhICdjaGlsZCcgZW50aXR5IGFsb25nIHRoZSBzcGVjaWZpZWQgTmF2aWdhdGlvblByb3BlcnR5LiBcclxuICBpLmUuIGhhcyBhIHNpbmdsZSBwYXJlbnQuXHJcblxyXG4gIEBwYXJhbSBuYXZpZ2F0aW9uUHJvcGVydHkgLSBUaGUgW1tOYXZpZ2F0aW9uUHJvcGVydHldXSAoIHBvaW50aW5nIHRvIGEgcGFyZW50KS4gXHJcbiAgQHJldHVybnMgRWl0aGVyIGEgcGFyZW50IEVudGl0eUtleSBpZiB0aGlzIGlzIGEgJ2NoaWxkJyBlbnRpdHkgb3IgbnVsbDsgIFxyXG4gICovXHJcbiAgZ2V0UGFyZW50S2V5KG5hdmlnYXRpb25Qcm9wZXJ0eTogTmF2aWdhdGlvblByb3BlcnR5KSB7XHJcbiAgICBpZiAoIXRoaXMuZW50aXR5KSByZXR1cm4gbnVsbDtcclxuICAgIC8vIFRPRE86IHJldmlldyB0aGlzIC0gbm90IHN1cmUgYWJvdXQgdGhlIGNvbW1lbnQuXHJcbiAgICAvLyBOYXZpZ2F0aW9uUHJvcGVydHkgZG9lc24ndCB5ZXQgZXhpc3RcclxuICAgIC8vIGFzc2VydFBhcmFtKG5hdmlnYXRpb25Qcm9wZXJ0eSwgXCJuYXZpZ2F0aW9uUHJvcGVydHlcIikuaXNJbnN0YW5jZU9mKE5hdmlnYXRpb25Qcm9wZXJ0eSkuY2hlY2soKTtcclxuICAgIGxldCBma05hbWVzID0gbmF2aWdhdGlvblByb3BlcnR5LmZvcmVpZ25LZXlOYW1lcztcclxuICAgIGlmIChma05hbWVzLmxlbmd0aCA9PT0gMCkgcmV0dXJuIG51bGw7XHJcbiAgICBsZXQgdGhhdCA9IHRoaXM7XHJcbiAgICBsZXQgZmtWYWx1ZXMgPSBma05hbWVzLm1hcChmdW5jdGlvbiAoZmtuKSB7XHJcbiAgICAgIHJldHVybiB0aGF0LmVudGl0eSEuZ2V0UHJvcGVydHkoZmtuKTtcclxuICAgIH0pO1xyXG4gICAgcmV0dXJuIG5ldyBFbnRpdHlLZXkobmF2aWdhdGlvblByb3BlcnR5LmVudGl0eVR5cGUsIGZrVmFsdWVzKTtcclxuICB9XHJcblxyXG4gIC8vIFRPRE86IHJlZmFjdG9yIHRoaXMgYW5kIHRoZSBzdGF0aWMgZ2V0UHJvcGVydHlQYXRoVmFsdWUuXHJcbiAgLyoqXHJcbiAgUmV0dXJucyB0aGUgdmFsdWUgb2YgYSBzcGVjaWZpZWQgRGF0YVByb3BlcnR5IG9yIE5hdmlnYXRpb25Qcm9wZXJ0eSBvciAncHJvcGVydHkgcGF0aCcuICBcclxuICAqKi9cclxuICBnZXRQcm9wZXJ0eVZhbHVlKHByb3BlcnR5OiBzdHJpbmcgfCBEYXRhUHJvcGVydHkgfCBOYXZpZ2F0aW9uUHJvcGVydHkpIHtcclxuICAgIGFzc2VydFBhcmFtKHByb3BlcnR5LCBcInByb3BlcnR5XCIpLmlzU3RyaW5nKCkub3IoKS5pc0VudGl0eVByb3BlcnR5KCkuY2hlY2soKTtcclxuICAgIGxldCB2YWx1ZTogYW55O1xyXG4gICAgaWYgKHR5cGVvZiAocHJvcGVydHkpID09PSAnc3RyaW5nJykge1xyXG4gICAgICBsZXQgcHJvcE5hbWVzID0gcHJvcGVydHkudHJpbSgpLnNwbGl0KFwiLlwiKTtcclxuICAgICAgbGV0IHByb3BOYW1lID0gcHJvcE5hbWVzLnNoaWZ0KCk7XHJcbiAgICAgIHZhbHVlID0gdGhpcy5lbnRpdHk7XHJcbiAgICAgIHZhbHVlID0gdmFsdWUuZ2V0UHJvcGVydHkocHJvcE5hbWUpO1xyXG4gICAgICB3aGlsZSAocHJvcE5hbWVzLmxlbmd0aCA+IDApIHtcclxuICAgICAgICBwcm9wTmFtZSA9IHByb3BOYW1lcy5zaGlmdCgpO1xyXG4gICAgICAgIHZhbHVlID0gdmFsdWUuZ2V0UHJvcGVydHkocHJvcE5hbWUpO1xyXG4gICAgICB9XHJcbiAgICB9IGVsc2Uge1xyXG4gICAgICBpZiAoIShwcm9wZXJ0eS5wYXJlbnRUeXBlIGluc3RhbmNlb2YgRW50aXR5VHlwZSkpIHtcclxuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoXCJUaGUgdmFsaWRhdGVQcm9wZXJ0eSBtZXRob2QgZG9lcyBub3QgYWNjZXB0IGEgJ3Byb3BlcnR5JyBwYXJhbWV0ZXIgd2hvc2UgcGFyZW50VHlwZSBpcyBhIENvbXBsZXhUeXBlOyBcIiArXHJcbiAgICAgICAgICBcIlBhc3MgYSAncHJvcGVydHkgcGF0aCcgc3RyaW5nIGFzIHRoZSAncHJvcGVydHknIHBhcmFtZXRlciBpbnN0ZWFkIFwiKTtcclxuICAgICAgfVxyXG4gICAgICB2YWx1ZSA9IHRoaXMuZW50aXR5IS5nZXRQcm9wZXJ0eShwcm9wZXJ0eS5uYW1lKTtcclxuICAgIH1cclxuICAgIHJldHVybiB2YWx1ZTtcclxuICB9XHJcblxyXG4gIC8vIGludGVybmFsIG1ldGhvZHNcclxuICAvKiogQGhpZGRlbiBAaW50ZXJuYWwgKi9cclxuICBfY2hlY2tPcGVyYXRpb24ob3BlcmF0aW9uTmFtZTogc3RyaW5nKSB7XHJcbiAgICBpZiAodGhpcy5pc0JlaW5nU2F2ZWQpIHtcclxuICAgICAgdGhyb3cgbmV3IEVycm9yKFwiQ2Fubm90IHBlcmZvcm0gYSAnXCIgKyBvcGVyYXRpb25OYW1lICsgXCInIG9uIGFuIGVudGl0eSB0aGF0IGlzIGluIHRoZSBwcm9jZXNzIG9mIGJlaW5nIHNhdmVkXCIpO1xyXG4gICAgfVxyXG4gICAgLy8gYWxsb3dzIGNoYWluaW5nXHJcbiAgICByZXR1cm4gdGhpcztcclxuICB9XHJcblxyXG4gIC8qKiBAaGlkZGVuIEBpbnRlcm5hbCAqL1xyXG4gIF9kZXRhY2goKSB7XHJcbiAgICB0aGlzLmVudGl0eUdyb3VwID0gdW5kZWZpbmVkO1xyXG4gICAgdGhpcy5lbnRpdHlNYW5hZ2VyID0gdW5kZWZpbmVkO1xyXG4gICAgdGhpcy5lbnRpdHlTdGF0ZSA9IEVudGl0eVN0YXRlLkRldGFjaGVkO1xyXG4gICAgdGhpcy5vcmlnaW5hbFZhbHVlcyA9IHt9O1xyXG4gICAgdGhpcy5fdmFsaWRhdGlvbkVycm9ycyA9IHt9O1xyXG4gICAgdGhpcy5oYXNWYWxpZGF0aW9uRXJyb3JzID0gZmFsc2U7XHJcbiAgICB0aGlzLnZhbGlkYXRpb25FcnJvcnNDaGFuZ2VkLmNsZWFyKCk7XHJcbiAgICB0aGlzLnByb3BlcnR5Q2hhbmdlZC5jbGVhcigpO1xyXG5cclxuICB9XHJcblxyXG5cclxuICAvLyBjYWxsZWQgZnJvbSBkZWZhdWx0SW50ZXJjZXB0b3IuXHJcbiAgLyoqIEBoaWRkZW4gQGludGVybmFsICovXHJcbiAgX3ZhbGlkYXRlUHJvcGVydHkodmFsdWU6IGFueSwgY29udGV4dDogYW55KSB7XHJcbiAgICBsZXQgb2sgPSB0cnVlO1xyXG4gICAgdGhpcy5fcHJvY2Vzc1ZhbGlkYXRpb25PcEFuZFB1Ymxpc2goZnVuY3Rpb24gKHRoYXQ6IGFueSkge1xyXG4gICAgICBjb250ZXh0LnByb3BlcnR5LmdldEFsbFZhbGlkYXRvcnMoKS5mb3JFYWNoKGZ1bmN0aW9uICh2YWxpZGF0b3I6IFZhbGlkYXRvcikge1xyXG4gICAgICAgIG9rID0gdmFsaWRhdGUodGhhdCwgdmFsaWRhdG9yLCB2YWx1ZSwgY29udGV4dCkgJiYgb2s7XHJcbiAgICAgIH0pO1xyXG4gICAgfSk7XHJcbiAgICByZXR1cm4gb2s7XHJcbiAgfVxyXG5cclxuICAvKiogQGhpZGRlbiBAaW50ZXJuYWwgKi9cclxuICBfcHJvY2Vzc1ZhbGlkYXRpb25PcEFuZFB1Ymxpc2godmFsaWRhdGlvbkZuOiBhbnkpIHtcclxuICAgIGlmICh0aGlzLl9wZW5kaW5nVmFsaWRhdGlvblJlc3VsdCkge1xyXG4gICAgICAvLyBvbmx5IHRvcCBsZXZlbCBwcm9jZXNzVmFsaWRhdGlvbnMgY2FsbCBwdWJsaXNoZXNcclxuICAgICAgdmFsaWRhdGlvbkZuKHRoaXMpO1xyXG4gICAgfSBlbHNlIHtcclxuICAgICAgdHJ5IHtcclxuICAgICAgICB0aGlzLl9wZW5kaW5nVmFsaWRhdGlvblJlc3VsdCA9IHsgZW50aXR5OiB0aGlzLmVudGl0eSwgYWRkZWQ6IFtdLCByZW1vdmVkOiBbXSB9O1xyXG4gICAgICAgIHZhbGlkYXRpb25Gbih0aGlzKTtcclxuICAgICAgICBpZiAodGhpcy5fcGVuZGluZ1ZhbGlkYXRpb25SZXN1bHQuYWRkZWQubGVuZ3RoID4gMCB8fCB0aGlzLl9wZW5kaW5nVmFsaWRhdGlvblJlc3VsdC5yZW1vdmVkLmxlbmd0aCA+IDApIHtcclxuICAgICAgICAgIHRoaXMudmFsaWRhdGlvbkVycm9yc0NoYW5nZWQucHVibGlzaCh0aGlzLl9wZW5kaW5nVmFsaWRhdGlvblJlc3VsdCk7XHJcbiAgICAgICAgICAvLyB0aGlzIG1pZ2h0IGJlIGEgZGV0YWNoZWQgZW50aXR5IGhlbmNlIHRoZSBndWFyZCBiZWxvdy5cclxuICAgICAgICAgIHRoaXMuZW50aXR5TWFuYWdlciAmJiB0aGlzLmVudGl0eU1hbmFnZXIudmFsaWRhdGlvbkVycm9yc0NoYW5nZWQucHVibGlzaCh0aGlzLl9wZW5kaW5nVmFsaWRhdGlvblJlc3VsdCk7XHJcblxyXG4gICAgICAgIH1cclxuICAgICAgfSBmaW5hbGx5IHtcclxuICAgICAgICB0aGlzLl9wZW5kaW5nVmFsaWRhdGlvblJlc3VsdCA9IHVuZGVmaW5lZDtcclxuICAgICAgfVxyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgLyoqIEBoaWRkZW4gQGludGVybmFsICovXHJcbiAgLy8gVE9ETzogYWRkL3VzZSBhIFZhbGlkYXRpb25FcnJvciB0eXBlXHJcbiAgX2FkZFZhbGlkYXRpb25FcnJvcih2YWxpZGF0aW9uRXJyb3I6IGFueSkge1xyXG4gICAgdGhpcy5fdmFsaWRhdGlvbkVycm9yc1t2YWxpZGF0aW9uRXJyb3Iua2V5XSA9IHZhbGlkYXRpb25FcnJvcjtcclxuICAgIHRoaXMuaGFzVmFsaWRhdGlvbkVycm9ycyA9IHRydWU7XHJcbiAgICB0aGlzLl9wZW5kaW5nVmFsaWRhdGlvblJlc3VsdC5hZGRlZC5wdXNoKHZhbGlkYXRpb25FcnJvcik7XHJcbiAgfVxyXG5cclxuICAvKiogQGhpZGRlbiBAaW50ZXJuYWwgKi9cclxuICBfcmVtb3ZlVmFsaWRhdGlvbkVycm9yKGtleTogc3RyaW5nKSB7XHJcbiAgICBsZXQgdmFsRXJyb3IgPSB0aGlzLl92YWxpZGF0aW9uRXJyb3JzW2tleV07XHJcbiAgICBpZiAodmFsRXJyb3IpIHtcclxuICAgICAgZGVsZXRlIHRoaXMuX3ZhbGlkYXRpb25FcnJvcnNba2V5XTtcclxuICAgICAgdGhpcy5oYXNWYWxpZGF0aW9uRXJyb3JzID0gIWNvcmUuaXNFbXB0eSh0aGlzLl92YWxpZGF0aW9uRXJyb3JzKTtcclxuICAgICAgdGhpcy5fcGVuZGluZ1ZhbGlkYXRpb25SZXN1bHQucmVtb3ZlZC5wdXNoKHZhbEVycm9yKTtcclxuICAgIH1cclxuICB9XHJcblxyXG59XHJcblxyXG5CcmVlemVFdmVudC5idWJibGVFdmVudChFbnRpdHlBc3BlY3QucHJvdG90eXBlLCBmdW5jdGlvbiAoKSB7XHJcbiAgcmV0dXJuIHRoaXMuZW50aXR5TWFuYWdlcjtcclxufSk7XHJcblxyXG5mdW5jdGlvbiByZWplY3RDaGFuZ2VzQ29yZSh0YXJnZXQ6IGFueSkge1xyXG4gIGxldCBhc3BlY3QgPSB0YXJnZXQuZW50aXR5QXNwZWN0IHx8IHRhcmdldC5jb21wbGV4QXNwZWN0O1xyXG4gIGxldCBzdHlwZSA9IHRhcmdldC5lbnRpdHlUeXBlIHx8IHRhcmdldC5jb21wbGV4VHlwZTtcclxuICBsZXQgb3JpZ2luYWxWYWx1ZXMgPSBhc3BlY3Qub3JpZ2luYWxWYWx1ZXM7XHJcbiAgZm9yIChsZXQgcHJvcE5hbWUgaW4gb3JpZ2luYWxWYWx1ZXMpIHtcclxuICAgIHRhcmdldC5zZXRQcm9wZXJ0eShwcm9wTmFtZSwgb3JpZ2luYWxWYWx1ZXNbcHJvcE5hbWVdKTtcclxuICB9XHJcbiAgc3R5cGUuY29tcGxleFByb3BlcnRpZXMuZm9yRWFjaChmdW5jdGlvbiAoY3A6IGFueSkge1xyXG4gICAgbGV0IGNvcyA9IHRhcmdldC5nZXRQcm9wZXJ0eShjcC5uYW1lKTtcclxuICAgIGlmIChjcC5pc1NjYWxhcikge1xyXG4gICAgICByZWplY3RDaGFuZ2VzQ29yZShjb3MpO1xyXG4gICAgfSBlbHNlIHtcclxuICAgICAgY29zLl9yZWplY3RDaGFuZ2VzKCk7XHJcbiAgICAgIGNvcy5mb3JFYWNoKHJlamVjdENoYW5nZXNDb3JlKTtcclxuICAgIH1cclxuICB9KTtcclxufVxyXG5cclxuZnVuY3Rpb24gcmVtb3ZlRnJvbVJlbGF0aW9ucyhlbnRpdHk6IEVudGl0eSwgZW50aXR5U3RhdGU6IEVudGl0eVN0YXRlKSB7XHJcbiAgLy8gcmVtb3ZlIHRoaXMgZW50aXR5IGZyb20gYW55IGNvbGxlY3Rpb25zLlxyXG4gIC8vIG1hcmsgdGhlIGVudGl0eSBkZWxldGVkIG9yIGRldGFjaGVkXHJcblxyXG4gIGxldCBpc0RlbGV0ZWQgPSBlbnRpdHlTdGF0ZS5pc0RlbGV0ZWQoKTtcclxuICBpZiAoaXNEZWxldGVkKSB7XHJcbiAgICByZW1vdmVGcm9tUmVsYXRpb25zQ29yZShlbnRpdHkpO1xyXG4gIH0gZWxzZSB7XHJcbiAgICBjb3JlLnVzaW5nKGVudGl0eS5lbnRpdHlBc3BlY3QuZW50aXR5TWFuYWdlciEsIFwiaXNMb2FkaW5nXCIsIHRydWUsIGZ1bmN0aW9uICgpIHtcclxuICAgICAgcmVtb3ZlRnJvbVJlbGF0aW9uc0NvcmUoZW50aXR5KTtcclxuICAgIH0pO1xyXG4gIH1cclxufVxyXG5cclxuZnVuY3Rpb24gcmVtb3ZlRnJvbVJlbGF0aW9uc0NvcmUoZW50aXR5OiBFbnRpdHkpIHtcclxuICBlbnRpdHkuZW50aXR5VHlwZS5uYXZpZ2F0aW9uUHJvcGVydGllcy5mb3JFYWNoKGZ1bmN0aW9uIChucCkge1xyXG4gICAgbGV0IGludmVyc2VOcCA9IG5wLmludmVyc2U7XHJcbiAgICBsZXQgbnBWYWx1ZSA9IGVudGl0eS5nZXRQcm9wZXJ0eShucC5uYW1lKTtcclxuICAgIGlmIChucC5pc1NjYWxhcikge1xyXG4gICAgICBpZiAobnBWYWx1ZSkge1xyXG4gICAgICAgIGlmIChpbnZlcnNlTnApIHtcclxuICAgICAgICAgIGlmIChpbnZlcnNlTnAuaXNTY2FsYXIpIHtcclxuICAgICAgICAgICAgbnBWYWx1ZS5zZXRQcm9wZXJ0eShpbnZlcnNlTnAubmFtZSwgbnVsbCk7XHJcbiAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICBsZXQgY29sbGVjdGlvbiA9IG5wVmFsdWUuZ2V0UHJvcGVydHkoaW52ZXJzZU5wLm5hbWUpO1xyXG4gICAgICAgICAgICBpZiAoY29sbGVjdGlvbi5sZW5ndGgpIHtcclxuICAgICAgICAgICAgICBjb3JlLmFycmF5UmVtb3ZlSXRlbShjb2xsZWN0aW9uLCBlbnRpdHkpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGVudGl0eS5zZXRQcm9wZXJ0eShucC5uYW1lLCBudWxsKTtcclxuICAgICAgfVxyXG4gICAgfSBlbHNlIHtcclxuICAgICAgaWYgKGludmVyc2VOcCAhPSBudWxsKSB7XHJcbiAgICAgICAgLy8gbnBWYWx1ZSBpcyBhIGxpdmUgbGlzdCBzbyB3ZSBuZWVkIHRvIGNvcHkgaXQgZmlyc3QuXHJcbiAgICAgICAgbnBWYWx1ZS5zbGljZSgwKS5mb3JFYWNoKCh2OiBhbnkpID0+IHtcclxuICAgICAgICAgIGlmIChpbnZlcnNlTnAhLmlzU2NhbGFyKSB7XHJcbiAgICAgICAgICAgIHYuc2V0UHJvcGVydHkoaW52ZXJzZU5wIS5uYW1lLCBudWxsKTtcclxuICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgIC8vIFRPRE86IG1hbnkgdG8gbWFueSAtIG5vdCB5ZXQgaGFuZGxlZC5cclxuICAgICAgICAgIH1cclxuICAgICAgICB9KTtcclxuICAgICAgfVxyXG4gICAgICAvLyBub3cgY2xlYXIgaXQuXHJcbiAgICAgIG5wVmFsdWUubGVuZ3RoID0gMDtcclxuICAgIH1cclxuICB9KTtcclxuXHJcbn1cclxuXHJcbi8vIG5vdGUgZW50aXR5QXNwZWN0IG9ubHkgLSAoIG5vIGNvbXBsZXggYXNwZWN0IGFsbG93ZWQgb24gdGhlIGNhbGwpLlxyXG5mdW5jdGlvbiB2YWxpZGF0ZShlbnRpdHlBc3BlY3Q6IEVudGl0eUFzcGVjdCwgdmFsaWRhdG9yOiBWYWxpZGF0b3IsIHZhbHVlOiBhbnksIGNvbnRleHQ/OiBhbnkpIHtcclxuICBsZXQgdmUgPSB2YWxpZGF0b3IudmFsaWRhdGUodmFsdWUsIGNvbnRleHQpO1xyXG4gIGlmICh2ZSkge1xyXG4gICAgZW50aXR5QXNwZWN0Ll9hZGRWYWxpZGF0aW9uRXJyb3IodmUpO1xyXG4gICAgcmV0dXJuIGZhbHNlO1xyXG4gIH0gZWxzZSB7XHJcbiAgICBsZXQga2V5ID0gVmFsaWRhdGlvbkVycm9yLmdldEtleSh2YWxpZGF0b3IsIGNvbnRleHQgPyBjb250ZXh0LnByb3BlcnR5TmFtZSA6IG51bGwpO1xyXG4gICAgZW50aXR5QXNwZWN0Ll9yZW1vdmVWYWxpZGF0aW9uRXJyb3Ioa2V5KTtcclxuICAgIHJldHVybiB0cnVlO1xyXG4gIH1cclxufVxyXG5cclxuLy8gY29JbmRleCBpcyBvbmx5IHVzZWQgd2hlcmUgdGFyZ2V0IGlzIGEgY29tcGxleCBvYmplY3QgdGhhdCBpcyBwYXJ0IG9mIGFuIGFycmF5IG9mIGNvbXBsZXggb2JqZWN0c1xyXG4vLyBpbiB3aGljaCBjYXNlIGN0SW5kZXggaXMgdGhlIGluZGV4IG9mIHRoZSB0YXJnZXQgd2l0aGluIHRoZSBhcnJheS5cclxuZnVuY3Rpb24gdmFsaWRhdGVUYXJnZXQodGFyZ2V0OiBhbnksIGNvSW5kZXg/OiBudW1iZXIpIHtcclxuICBsZXQgb2sgPSB0cnVlO1xyXG4gIGxldCBzdHlwZSA9IHRhcmdldC5lbnRpdHlUeXBlIHx8IHRhcmdldC5jb21wbGV4VHlwZTtcclxuICBsZXQgYXNwZWN0ID0gdGFyZ2V0LmVudGl0eUFzcGVjdCB8fCB0YXJnZXQuY29tcGxleEFzcGVjdDtcclxuICBsZXQgZW50aXR5QXNwZWN0ID0gdGFyZ2V0LmVudGl0eUFzcGVjdCB8fCB0YXJnZXQuY29tcGxleEFzcGVjdC5nZXRFbnRpdHlBc3BlY3QoKTtcclxuICBsZXQgY29udGV4dCA9IDxhbnk+eyBlbnRpdHk6IGVudGl0eUFzcGVjdC5lbnRpdHkgfTtcclxuICBpZiAoY29JbmRleCAhPT0gdW5kZWZpbmVkKSB7XHJcbiAgICBjb250ZXh0LmluZGV4ID0gY29JbmRleDtcclxuICB9XHJcblxyXG4gIHN0eXBlLmdldFByb3BlcnRpZXMoKS5mb3JFYWNoKGZ1bmN0aW9uIChwOiBhbnkpIHtcclxuICAgIGxldCB2YWx1ZSA9IHRhcmdldC5nZXRQcm9wZXJ0eShwLm5hbWUpO1xyXG4gICAgbGV0IHZhbGlkYXRvcnMgPSBwLmdldEFsbFZhbGlkYXRvcnMoKTtcclxuICAgIGlmICh2YWxpZGF0b3JzLmxlbmd0aCA+IDApIHtcclxuICAgICAgY29udGV4dC5wcm9wZXJ0eSA9IHA7XHJcbiAgICAgIGNvbnRleHQucHJvcGVydHlOYW1lID0gYXNwZWN0LmdldFByb3BlcnR5UGF0aChwLm5hbWUpO1xyXG4gICAgICBvayA9IGVudGl0eUFzcGVjdC5fdmFsaWRhdGVQcm9wZXJ0eSh2YWx1ZSwgY29udGV4dCkgJiYgb2s7XHJcbiAgICB9XHJcbiAgICBpZiAocC5pc0NvbXBsZXhQcm9wZXJ0eSkge1xyXG4gICAgICBpZiAocC5pc1NjYWxhcikge1xyXG4gICAgICAgIG9rID0gdmFsaWRhdGVUYXJnZXQodmFsdWUpICYmIG9rO1xyXG4gICAgICB9IGVsc2Uge1xyXG4gICAgICAgIG9rID0gdmFsdWUucmVkdWNlKGZ1bmN0aW9uIChwdjogYW55LCBjdjogYW55LCBpeDogbnVtYmVyKSB7XHJcbiAgICAgICAgICByZXR1cm4gdmFsaWRhdGVUYXJnZXQoY3YsIGl4KSAmJiBwdjtcclxuICAgICAgICB9LCBvayk7XHJcbiAgICAgIH1cclxuICAgIH1cclxuICB9KTtcclxuXHJcblxyXG4gIC8vIHRoZW4gdGFyZ2V0IGxldmVsXHJcbiAgc3R5cGUuZ2V0QWxsVmFsaWRhdG9ycygpLmZvckVhY2goZnVuY3Rpb24gKHZhbGlkYXRvcjogVmFsaWRhdG9yKSB7XHJcbiAgICBvayA9IHZhbGlkYXRlKGVudGl0eUFzcGVjdCwgdmFsaWRhdG9yLCB0YXJnZXQpICYmIG9rO1xyXG4gIH0pO1xyXG4gIHJldHVybiBvaztcclxufVxyXG5cclxuLyoqXHJcbkFuIENvbXBsZXhBc3BlY3QgaW5zdGFuY2UgaXMgYXNzb2NpYXRlZCB3aXRoIGV2ZXJ5IGNvbXBsZXggb2JqZWN0IGluc3RhbmNlIGFuZCBpcyBhY2Nlc3NlZCB2aWEgdGhlIGNvbXBsZXggb2JqZWN0J3MgJ2NvbXBsZXhBc3BlY3QnIHByb3BlcnR5LlxyXG5cclxuVGhlIENvbXBsZXhBc3BlY3QgaXRzZWxmIHByb3ZpZGVzIHByb3BlcnRpZXMgdG8gZGV0ZXJtaW5lIHRoZSBwYXJlbnQgb2JqZWN0LCBwYXJlbnQgcHJvcGVydHkgYW5kIG9yaWdpbmFsIHZhbHVlcyBmb3IgdGhlIGNvbXBsZXggb2JqZWN0LlxyXG5cclxuQSBDb21wbGV4QXNwZWN0IHdpbGwgYWxtb3N0IG5ldmVyIG5lZWQgdG8gYmUgY29uc3RydWN0ZWQgZGlyZWN0bHkuIFlvdSB3aWxsIHVzdWFsbHkgZ2V0IGFuIENvbXBsZXhBc3BlY3QgYnkgYWNjZXNzaW5nXHJcbmFuIGVudGl0aWVzICdjb21wbGV4QXNwZWN0JyBwcm9wZXJ0eS4gIFRoaXMgcHJvcGVydHkgd2lsbCBiZSBhdXRvbWF0aWNhbGx5IGF0dGFjaGVkIHdoZW4gYW4gY29tcGxleCBvYmplY3QgaXMgY3JlYXRlZCBhcyBwYXJ0IG9mIGFuXHJcbmVudGl0eSB2aWEgZWl0aGVyIGEgcXVlcnksIGltcG9ydCBvciBFbnRpdHlNYW5hZ2VyLmNyZWF0ZUVudGl0eSBjYWxsLlxyXG4+ICAgICAgLy8gYXNzdW1lIGFkZHJlc3MgaXMgYSBjb21wbGV4IHByb3BlcnR5IG9uIHRoZSAnQ3VzdG9tZXInIHR5cGVcclxuPiAgICAgIHZhciBhc3BlY3QgPSBhQ3VzdG9tZXIuYWRkcmVzcy5jb21wbGV4QXNwZWN0O1xyXG4+ICAgICAgLy8gYUN1c3RvbWVyID09PSBhc3BlY3QucGFyZW50O1xyXG4qKi9cclxuZXhwb3J0IGNsYXNzIENvbXBsZXhBc3BlY3Qge1xyXG5cclxuICAvKiogVGhlIGNvbXBsZXggb2JqZWN0IHRoYXQgdGhpcyBhc3BlY3QgaXMgYXNzb2NpYXRlZCB3aXRoLiBfX1JlYWQgT25seV9fICovXHJcbiAgY29tcGxleE9iamVjdDogQ29tcGxleE9iamVjdDtcclxuICAvKiogVGhlICdvcmlnaW5hbCB2YWx1ZXMnIG9mIHRoaXMgY29tcGxleCBvYmplY3Qgd2hlcmUgdGhleSBhcmUgZGlmZmVyZW50IGZyb20gdGhlICdjdXJyZW50IHZhbHVlcycuXHJcbiAgVGhpcyBpcyBhIG1hcCB3aGVyZSB0aGUga2V5IGlzIGEgcHJvcGVydHkgbmFtZSBhbmQgdGhlIHZhbHVlIGlzIHRoZSAnb3JpZ2luYWwgdmFsdWUnIG9mIHRoZSBwcm9wZXJ0eS5cclxuICBfX1JlYWQgT25seV9fICovXHJcbiAgb3JpZ2luYWxWYWx1ZXM6IHt9O1xyXG4gIC8qKiBUaGUgcGFyZW50IG9iamVjdCB0aGF0IHRvIHdoaWNoIHRoaXMgYXNwZWN0IGJlbG9uZ3M7IHRoaXMgd2lsbCBlaXRoZXIgYmUgYW4gZW50aXR5IG9yIGFub3RoZXIgY29tcGxleCBvYmplY3QuIF9fUmVhZCBPbmx5X18gKi9cclxuICBwYXJlbnQ/OiBTdHJ1Y3R1cmFsT2JqZWN0O1xyXG4gIC8qKiBUaGUgW1tEYXRhUHJvcGVydHldXSBvbiB0aGUgJ3BhcmVudCcgdGhhdCBjb250YWlucyB0aGlzIGNvbXBsZXggb2JqZWN0LiBfX1JlYWQgT25seV9fICovXHJcbiAgcGFyZW50UHJvcGVydHk/OiBEYXRhUHJvcGVydHk7XHJcbiAgZXh0cmFNZXRhZGF0YT86IGFueTtcclxuXHJcbiAgLyoqIFlvdSB3aWxsIHJhcmVseSwgaWYgZXZlciwgY3JlYXRlIGEgQ29tcGxleEFzcGVjdCBkaXJlY3RseS4gKi9cclxuICBjb25zdHJ1Y3Rvcihjb21wbGV4T2JqZWN0OiBDb21wbGV4T2JqZWN0LCBwYXJlbnQ6IFN0cnVjdHVyYWxPYmplY3QsIHBhcmVudFByb3BlcnR5OiBEYXRhUHJvcGVydHkpIHtcclxuICAgIGlmICghY29tcGxleE9iamVjdCkge1xyXG4gICAgICB0aHJvdyBuZXcgRXJyb3IoXCJUaGUgIENvbXBsZXhBc3BlY3QgY3RvciByZXF1aXJlcyBhbiBlbnRpdHkgYXMgaXRzIG9ubHkgYXJndW1lbnQuXCIpO1xyXG4gICAgfVxyXG4gICAgaWYgKGNvbXBsZXhPYmplY3QuY29tcGxleEFzcGVjdCkge1xyXG4gICAgICByZXR1cm4gY29tcGxleE9iamVjdC5jb21wbGV4QXNwZWN0O1xyXG4gICAgfVxyXG4gICAgLy8gaWYgY2FsbGVkIHdpdGhvdXQgbmV3XHJcbiAgICBpZiAoISh0aGlzIGluc3RhbmNlb2YgQ29tcGxleEFzcGVjdCkpIHtcclxuICAgICAgcmV0dXJuIG5ldyBDb21wbGV4QXNwZWN0KGNvbXBsZXhPYmplY3QsIHBhcmVudCwgcGFyZW50UHJvcGVydHkpO1xyXG4gICAgfVxyXG5cclxuICAgIC8vIGVudGl0eVR5cGUgc2hvdWxkIGFscmVhZHkgYmUgb24gdGhlIGVudGl0eSBmcm9tICd3YXRjaCdcclxuICAgIHRoaXMuY29tcGxleE9iamVjdCA9IGNvbXBsZXhPYmplY3Q7XHJcbiAgICBjb21wbGV4T2JqZWN0LmNvbXBsZXhBc3BlY3QgPSB0aGlzO1xyXG5cclxuICAgIC8vIFRPRE86IGtlZXAgcHVibGljIG9yIG5vdD9cclxuICAgIHRoaXMub3JpZ2luYWxWYWx1ZXMgPSB7fTtcclxuXHJcbiAgICAvLyBpZiBhIHN0YW5kYWxvbmUgY29tcGxleE9iamVjdFxyXG4gICAgaWYgKHBhcmVudCAhPSBudWxsKSB7XHJcbiAgICAgIHRoaXMucGFyZW50ID0gcGFyZW50O1xyXG4gICAgICB0aGlzLnBhcmVudFByb3BlcnR5ID0gcGFyZW50UHJvcGVydHk7XHJcbiAgICB9XHJcblxyXG4gICAgbGV0IGNvbXBsZXhUeXBlID0gY29tcGxleE9iamVjdC5jb21wbGV4VHlwZTtcclxuICAgIGlmICghY29tcGxleFR5cGUpIHtcclxuICAgICAgbGV0IHR5cGVOYW1lID0gY29tcGxleE9iamVjdC5wcm90b3R5cGUuXyR0eXBlTmFtZTtcclxuICAgICAgaWYgKCF0eXBlTmFtZSkge1xyXG4gICAgICAgIHRocm93IG5ldyBFcnJvcihcIlRoaXMgZW50aXR5IGlzIG5vdCByZWdpc3RlcmVkIGFzIGEgdmFsaWQgQ29tcGxleFR5cGVcIik7XHJcbiAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKFwiTWV0YWRhdGEgZm9yIHRoaXMgY29tcGxleFR5cGUgaGFzIG5vdCB5ZXQgYmVlbiByZXNvbHZlZDogXCIgKyB0eXBlTmFtZSk7XHJcbiAgICAgIH1cclxuICAgIH1cclxuICAgIGxldCBjb21wbGV4Q3RvciA9IGNvbXBsZXhUeXBlLmdldEN0b3IoKTtcclxuICAgIGNvbmZpZy5pbnRlcmZhY2VSZWdpc3RyeS5tb2RlbExpYnJhcnkuZ2V0RGVmYXVsdEluc3RhbmNlKCkuc3RhcnRUcmFja2luZyhjb21wbGV4T2JqZWN0LCBjb21wbGV4Q3Rvci5wcm90b3R5cGUpO1xyXG5cclxuICB9XHJcblxyXG5cclxuICAvKipcclxuICBSZXR1cm5zIHRoZSBFbnRpdHlBc3BlY3QgZm9yIHRoZSB0b3AgbGV2ZWwgZW50aXR5IHRoYXQgY29udGFpbnMgdGhpcyBjb21wbGV4IG9iamVjdC5cclxuICAqKi9cclxuICBnZXRFbnRpdHlBc3BlY3QoKSB7XHJcbiAgICBsZXQgcGFyZW50ID0gPGFueT50aGlzLnBhcmVudDtcclxuICAgIGlmICghcGFyZW50KSByZXR1cm4gbmV3IEVudGl0eUFzcGVjdCgpO1xyXG4gICAgbGV0IGVudGl0eUFzcGVjdCA9IHBhcmVudC5lbnRpdHlBc3BlY3Q7XHJcbiAgICB3aGlsZSAocGFyZW50ICYmICFlbnRpdHlBc3BlY3QpIHtcclxuICAgICAgcGFyZW50ID0gcGFyZW50LmNvbXBsZXhBc3BlY3QgJiYgcGFyZW50LmNvbXBsZXhBc3BlY3QucGFyZW50O1xyXG4gICAgICBlbnRpdHlBc3BlY3QgPSBwYXJlbnQgJiYgcGFyZW50LmVudGl0eUFzcGVjdDtcclxuICAgIH1cclxuICAgIHJldHVybiBlbnRpdHlBc3BlY3QgfHwgbmV3IEVudGl0eUFzcGVjdCgpO1xyXG4gIH1cclxuXHJcbiAgLyoqICBAaGlkZGVuIEBpbnRlcm5hbCAqL1xyXG4gIC8vIFRPRE86IHJlbmFtZSAtIGFuZCB1c2UgJ18nOyB1c2VkIG9uIGJvdGggRW50aXR5QXNwZWN0IGFuZCBDb21wbGV4QXNwZWN0IGZvciBwb2x5bW9ycGhpYyByZWFzb25zLlxyXG4gIGdldFByb3BlcnR5UGF0aChwcm9wTmFtZTogc3RyaW5nKSB7XHJcbiAgICBsZXQgcGFyZW50ID0gPGFueT50aGlzLnBhcmVudDtcclxuICAgIGlmICghcGFyZW50KSByZXR1cm4gbnVsbDtcclxuICAgIGxldCBhc3BlY3QgPSBwYXJlbnQuY29tcGxleEFzcGVjdCB8fCBwYXJlbnQuZW50aXR5QXNwZWN0O1xyXG4gICAgcmV0dXJuIGFzcGVjdC5nZXRQcm9wZXJ0eVBhdGgodGhpcy5wYXJlbnRQcm9wZXJ0eSEubmFtZSArIFwiLlwiICsgcHJvcE5hbWUpO1xyXG4gIH1cclxuXHJcbn1cclxuXHJcbmZ1bmN0aW9uIGNsZWFyT3JpZ2luYWxWYWx1ZXModGFyZ2V0OiBhbnkpIHtcclxuICBsZXQgYXNwZWN0ID0gdGFyZ2V0LmVudGl0eUFzcGVjdCB8fCB0YXJnZXQuY29tcGxleEFzcGVjdDtcclxuICBhc3BlY3Qub3JpZ2luYWxWYWx1ZXMgPSB7fTtcclxuICBsZXQgc3R5cGUgPSB0YXJnZXQuZW50aXR5VHlwZSB8fCB0YXJnZXQuY29tcGxleFR5cGU7XHJcbiAgc3R5cGUuY29tcGxleFByb3BlcnRpZXMuZm9yRWFjaChmdW5jdGlvbiAoY3A6IGFueSkge1xyXG4gICAgbGV0IGNvcyA9IHRhcmdldC5nZXRQcm9wZXJ0eShjcC5uYW1lKTtcclxuICAgIGlmIChjcC5pc1NjYWxhcikge1xyXG4gICAgICBjbGVhck9yaWdpbmFsVmFsdWVzKGNvcyk7XHJcbiAgICB9IGVsc2Uge1xyXG4gICAgICBjb3MuX2FjY2VwdENoYW5nZXMoKTtcclxuICAgICAgY29zLmZvckVhY2goY2xlYXJPcmlnaW5hbFZhbHVlcyk7XHJcbiAgICB9XHJcbiAgfSk7XHJcbn1cclxuXHJcblxyXG4iXX0=