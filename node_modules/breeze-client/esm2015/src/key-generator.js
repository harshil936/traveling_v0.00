import { EntityKey } from './entity-key';
import { config } from './config';
/*
  @class KeyGenerator
  */
export class KeyGenerator {
    constructor() {
        // key is dataProperty.name + || + entityType.name, value is propEntry
        // propEntry = { entityType, propertyName, keyMap }
        // keyMap has key of the actual value ( as a string) and a value of null or the real id.
        this._tempIdMap = {};
    }
    /*
    Returns a unique 'temporary' id for the specified [[EntityType]].
    Uniqueness is defined for this purpose as being unique within each instance of a KeyGenerator. This is sufficient
    because each EntityManager will have its own instance of a KeyGenerator and any entities imported into
    the EntityManager with temporary keys will have them regenerated and remapped on import.
  
    The return value of this method must be of the correct type as determined by the keyProperties of the
    specified EntityType
    @example
        // Assume em1 is a preexisting EntityManager
        let custType = em1.metadataStore.getEntityType("Customer");
        let cust1 = custType.createEntity();
        // next line both sets cust1's 'CustomerId' property but also returns the value
        let cid1 = em1.generateTempKeyValue(cust1);
        em1.saveChanges().then( function( data) {
          let sameCust1 = data.results[0];
          // cust1 === sameCust1;
          // but cust1.getProperty("CustomerId") != cid1
          // because the server will have generated a new id
          // and the client will have been updated with this
          // new id.
        });
    @method generateTempKeyValue
    @param entityType {EntityType}
    */
    generateTempKeyValue(entityType, valueIfAvail) {
        let keyProps = entityType.keyProperties;
        if (keyProps.length > 1) {
            throw new Error("Ids can not be autogenerated for entities with multipart keys");
        }
        let keyProp = keyProps[0];
        let propEntry = this._getPropEntry(keyProp, true);
        let nextId;
        if (valueIfAvail != null) {
            if (!propEntry.keyMap[valueIfAvail.toString()]) {
                nextId = valueIfAvail;
            }
        }
        if (nextId === undefined) {
            let dataType = keyProp.dataType;
            let getNextFn = dataType.getNext;
            if (getNextFn) {
                nextId = getNextFn(this);
                // need to watch out for collision with previously imported ids that might also get generated.
                while (propEntry.keyMap[nextId.toString()] != null) {
                    nextId = getNextFn(this);
                }
            }
            else {
                throw new Error("Cannot use a property with a dataType of: " + dataType.toString() + " for id generation");
            }
        }
        propEntry.keyMap[nextId.toString()] = true;
        return nextId;
    }
    getTempKeys() {
        let results = [];
        //noinspection JSHint
        for (let key in this._tempIdMap) {
            let propEntry = this._tempIdMap[key];
            let entityType = propEntry.entityType;
            // let propName = propEntry.propertyName;
            //noinspection JSHint
            for (let keyValue in propEntry.keyMap) {
                results.push(new EntityKey(entityType, [keyValue]));
            }
        }
        return results;
    }
    // proto methods below are not part of the KeyGenerator interface.
    isTempKey(entityKey) {
        let keyProps = entityKey.entityType.keyProperties;
        if (keyProps.length > 1)
            return false;
        let keyProp = keyProps[0];
        let propEntry = this._getPropEntry(keyProp);
        if (!propEntry) {
            return false;
        }
        return (propEntry.keyMap[entityKey.values[0].toString()] !== undefined);
    }
    /** @hidden @internal */
    _getPropEntry(keyProp, createIfMissing = false) {
        let key = keyProp.name + ".." + keyProp.parentType.name;
        let propEntry = this._tempIdMap[key];
        if (!propEntry) {
            if (createIfMissing) {
                propEntry = { entityType: keyProp.parentType, propertyName: keyProp.name, keyMap: {} };
                this._tempIdMap[key] = propEntry;
            }
        }
        return propEntry;
    }
}
config.registerType(KeyGenerator, "KeyGenerator");
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoia2V5LWdlbmVyYXRvci5qcyIsInNvdXJjZVJvb3QiOiJuZzovL2JyZWV6ZS1jbGllbnQvIiwic291cmNlcyI6WyJzcmMva2V5LWdlbmVyYXRvci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFDQSxPQUFPLEVBQUUsU0FBUyxFQUFFLE1BQU0sY0FBYyxDQUFDO0FBQ3pDLE9BQU8sRUFBRSxNQUFNLEVBQUUsTUFBTSxVQUFVLENBQUM7QUFZbEM7O0lBRUk7QUFDSixNQUFNLE9BQU8sWUFBWTtJQUt2QjtRQUNFLHNFQUFzRTtRQUN0RSxtREFBbUQ7UUFDbkQsd0ZBQXdGO1FBQ3hGLElBQUksQ0FBQyxVQUFVLEdBQUcsRUFBRSxDQUFDO0lBQ3ZCLENBQUM7SUFHRDs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7O01Bd0JFO0lBQ0Ysb0JBQW9CLENBQUMsVUFBc0IsRUFBRSxZQUFzQjtRQUNqRSxJQUFJLFFBQVEsR0FBRyxVQUFVLENBQUMsYUFBYSxDQUFDO1FBQ3hDLElBQUksUUFBUSxDQUFDLE1BQU0sR0FBRyxDQUFDLEVBQUU7WUFDdkIsTUFBTSxJQUFJLEtBQUssQ0FBQywrREFBK0QsQ0FBQyxDQUFDO1NBQ2xGO1FBQ0QsSUFBSSxPQUFPLEdBQUcsUUFBUSxDQUFDLENBQUMsQ0FBQyxDQUFDO1FBQzFCLElBQUksU0FBUyxHQUFHLElBQUksQ0FBQyxhQUFhLENBQUMsT0FBTyxFQUFFLElBQUksQ0FBQyxDQUFDO1FBQ2xELElBQUksTUFBVyxDQUFDO1FBQ2hCLElBQUksWUFBWSxJQUFJLElBQUksRUFBRTtZQUN4QixJQUFJLENBQUMsU0FBUyxDQUFDLE1BQU0sQ0FBQyxZQUFZLENBQUMsUUFBUSxFQUFFLENBQUMsRUFBRTtnQkFDOUMsTUFBTSxHQUFHLFlBQVksQ0FBQzthQUN2QjtTQUNGO1FBRUQsSUFBSSxNQUFNLEtBQUssU0FBUyxFQUFFO1lBQ3hCLElBQUksUUFBUSxHQUFHLE9BQU8sQ0FBQyxRQUFRLENBQUM7WUFDaEMsSUFBSSxTQUFTLEdBQUksUUFBZ0IsQ0FBQyxPQUFPLENBQUM7WUFDMUMsSUFBSSxTQUFTLEVBQUU7Z0JBQ2IsTUFBTSxHQUFHLFNBQVMsQ0FBQyxJQUFJLENBQUMsQ0FBQztnQkFDekIsOEZBQThGO2dCQUM5RixPQUFPLFNBQVMsQ0FBQyxNQUFNLENBQUMsTUFBTSxDQUFDLFFBQVEsRUFBRSxDQUFDLElBQUksSUFBSSxFQUFFO29CQUNsRCxNQUFNLEdBQUcsU0FBUyxDQUFDLElBQUksQ0FBQyxDQUFDO2lCQUMxQjthQUNGO2lCQUFNO2dCQUNMLE1BQU0sSUFBSSxLQUFLLENBQUMsNENBQTRDLEdBQUcsUUFBUSxDQUFDLFFBQVEsRUFBRSxHQUFHLG9CQUFvQixDQUFDLENBQUM7YUFDNUc7U0FDRjtRQUVELFNBQVMsQ0FBQyxNQUFNLENBQUMsTUFBTSxDQUFDLFFBQVEsRUFBRSxDQUFDLEdBQUcsSUFBSSxDQUFDO1FBQzNDLE9BQU8sTUFBTSxDQUFDO0lBQ2hCLENBQUM7SUFFRCxXQUFXO1FBQ1QsSUFBSSxPQUFPLEdBQWdCLEVBQUUsQ0FBQztRQUM5QixxQkFBcUI7UUFDckIsS0FBSyxJQUFJLEdBQUcsSUFBSSxJQUFJLENBQUMsVUFBVSxFQUFFO1lBQy9CLElBQUksU0FBUyxHQUFHLElBQUksQ0FBQyxVQUFVLENBQUMsR0FBRyxDQUFDLENBQUM7WUFDckMsSUFBSSxVQUFVLEdBQUcsU0FBUyxDQUFDLFVBQVUsQ0FBQztZQUN0Qyx5Q0FBeUM7WUFDekMscUJBQXFCO1lBQ3JCLEtBQUssSUFBSSxRQUFRLElBQUksU0FBUyxDQUFDLE1BQU0sRUFBRTtnQkFDckMsT0FBTyxDQUFDLElBQUksQ0FBQyxJQUFJLFNBQVMsQ0FBQyxVQUFVLEVBQUUsQ0FBQyxRQUFRLENBQUMsQ0FBQyxDQUFDLENBQUM7YUFDckQ7U0FDRjtRQUNELE9BQU8sT0FBTyxDQUFDO0lBQ2pCLENBQUM7SUFHRCxrRUFBa0U7SUFFbEUsU0FBUyxDQUFDLFNBQW9CO1FBQzVCLElBQUksUUFBUSxHQUFHLFNBQVMsQ0FBQyxVQUFVLENBQUMsYUFBYSxDQUFDO1FBQ2xELElBQUksUUFBUSxDQUFDLE1BQU0sR0FBRyxDQUFDO1lBQUUsT0FBTyxLQUFLLENBQUM7UUFDdEMsSUFBSSxPQUFPLEdBQUcsUUFBUSxDQUFDLENBQUMsQ0FBQyxDQUFDO1FBQzFCLElBQUksU0FBUyxHQUFHLElBQUksQ0FBQyxhQUFhLENBQUMsT0FBTyxDQUFDLENBQUM7UUFDNUMsSUFBSSxDQUFDLFNBQVMsRUFBRTtZQUNkLE9BQU8sS0FBSyxDQUFDO1NBQ2Q7UUFDRCxPQUFPLENBQUMsU0FBUyxDQUFDLE1BQU0sQ0FBQyxTQUFTLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQyxDQUFDLFFBQVEsRUFBRSxDQUFDLEtBQUssU0FBUyxDQUFDLENBQUM7SUFDMUUsQ0FBQztJQUVELHdCQUF3QjtJQUNoQixhQUFhLENBQUMsT0FBcUIsRUFBRSxlQUFlLEdBQUcsS0FBSztRQUNsRSxJQUFJLEdBQUcsR0FBRyxPQUFPLENBQUMsSUFBSSxHQUFHLElBQUksR0FBRyxPQUFPLENBQUMsVUFBVSxDQUFDLElBQUksQ0FBQztRQUN4RCxJQUFJLFNBQVMsR0FBRyxJQUFJLENBQUMsVUFBVSxDQUFDLEdBQUcsQ0FBQyxDQUFDO1FBQ3JDLElBQUksQ0FBQyxTQUFTLEVBQUU7WUFDZCxJQUFJLGVBQWUsRUFBRTtnQkFDbkIsU0FBUyxHQUFHLEVBQUUsVUFBVSxFQUFFLE9BQU8sQ0FBQyxVQUF3QixFQUFFLFlBQVksRUFBRSxPQUFPLENBQUMsSUFBSSxFQUFFLE1BQU0sRUFBRSxFQUFFLEVBQUUsQ0FBQztnQkFDckcsSUFBSSxDQUFDLFVBQVUsQ0FBQyxHQUFHLENBQUMsR0FBRyxTQUFTLENBQUM7YUFDbEM7U0FDRjtRQUNELE9BQU8sU0FBUyxDQUFDO0lBQ25CLENBQUM7Q0FFRjtBQUVELE1BQU0sQ0FBQyxZQUFZLENBQUMsWUFBWSxFQUFFLGNBQWMsQ0FBQyxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgRW50aXR5VHlwZSwgRGF0YVByb3BlcnR5IH0gZnJvbSAnLi9lbnRpdHktbWV0YWRhdGEnO1xyXG5pbXBvcnQgeyBFbnRpdHlLZXkgfSBmcm9tICcuL2VudGl0eS1rZXknO1xyXG5pbXBvcnQgeyBjb25maWcgfSBmcm9tICcuL2NvbmZpZyc7XHJcblxyXG5pbnRlcmZhY2UgSVByb3BFbnRyeSB7XHJcbiAgZW50aXR5VHlwZTogRW50aXR5VHlwZTtcclxuICBwcm9wZXJ0eU5hbWU6IHN0cmluZztcclxuICBrZXlNYXA6IE9iamVjdDtcclxufVxyXG5cclxuaW50ZXJmYWNlIElUZW1wSWRNYXAge1xyXG4gIFtpbmRleDogc3RyaW5nXTogSVByb3BFbnRyeTtcclxufVxyXG5cclxuLypcclxuICBAY2xhc3MgS2V5R2VuZXJhdG9yXHJcbiAgKi9cclxuZXhwb3J0IGNsYXNzIEtleUdlbmVyYXRvciB7XHJcbiAgLyoqIEBoaWRkZW4gQGludGVybmFsICovXHJcbiAgcHJpdmF0ZSBfdGVtcElkTWFwOiBJVGVtcElkTWFwO1xyXG5cclxuXHJcbiAgY29uc3RydWN0b3IoKSB7XHJcbiAgICAvLyBrZXkgaXMgZGF0YVByb3BlcnR5Lm5hbWUgKyB8fCArIGVudGl0eVR5cGUubmFtZSwgdmFsdWUgaXMgcHJvcEVudHJ5XHJcbiAgICAvLyBwcm9wRW50cnkgPSB7IGVudGl0eVR5cGUsIHByb3BlcnR5TmFtZSwga2V5TWFwIH1cclxuICAgIC8vIGtleU1hcCBoYXMga2V5IG9mIHRoZSBhY3R1YWwgdmFsdWUgKCBhcyBhIHN0cmluZykgYW5kIGEgdmFsdWUgb2YgbnVsbCBvciB0aGUgcmVhbCBpZC5cclxuICAgIHRoaXMuX3RlbXBJZE1hcCA9IHt9O1xyXG4gIH1cclxuXHJcblxyXG4gIC8qXHJcbiAgUmV0dXJucyBhIHVuaXF1ZSAndGVtcG9yYXJ5JyBpZCBmb3IgdGhlIHNwZWNpZmllZCBbW0VudGl0eVR5cGVdXS5cclxuICBVbmlxdWVuZXNzIGlzIGRlZmluZWQgZm9yIHRoaXMgcHVycG9zZSBhcyBiZWluZyB1bmlxdWUgd2l0aGluIGVhY2ggaW5zdGFuY2Ugb2YgYSBLZXlHZW5lcmF0b3IuIFRoaXMgaXMgc3VmZmljaWVudFxyXG4gIGJlY2F1c2UgZWFjaCBFbnRpdHlNYW5hZ2VyIHdpbGwgaGF2ZSBpdHMgb3duIGluc3RhbmNlIG9mIGEgS2V5R2VuZXJhdG9yIGFuZCBhbnkgZW50aXRpZXMgaW1wb3J0ZWQgaW50b1xyXG4gIHRoZSBFbnRpdHlNYW5hZ2VyIHdpdGggdGVtcG9yYXJ5IGtleXMgd2lsbCBoYXZlIHRoZW0gcmVnZW5lcmF0ZWQgYW5kIHJlbWFwcGVkIG9uIGltcG9ydC5cclxuXHJcbiAgVGhlIHJldHVybiB2YWx1ZSBvZiB0aGlzIG1ldGhvZCBtdXN0IGJlIG9mIHRoZSBjb3JyZWN0IHR5cGUgYXMgZGV0ZXJtaW5lZCBieSB0aGUga2V5UHJvcGVydGllcyBvZiB0aGVcclxuICBzcGVjaWZpZWQgRW50aXR5VHlwZVxyXG4gIEBleGFtcGxlXHJcbiAgICAgIC8vIEFzc3VtZSBlbTEgaXMgYSBwcmVleGlzdGluZyBFbnRpdHlNYW5hZ2VyXHJcbiAgICAgIGxldCBjdXN0VHlwZSA9IGVtMS5tZXRhZGF0YVN0b3JlLmdldEVudGl0eVR5cGUoXCJDdXN0b21lclwiKTtcclxuICAgICAgbGV0IGN1c3QxID0gY3VzdFR5cGUuY3JlYXRlRW50aXR5KCk7XHJcbiAgICAgIC8vIG5leHQgbGluZSBib3RoIHNldHMgY3VzdDEncyAnQ3VzdG9tZXJJZCcgcHJvcGVydHkgYnV0IGFsc28gcmV0dXJucyB0aGUgdmFsdWVcclxuICAgICAgbGV0IGNpZDEgPSBlbTEuZ2VuZXJhdGVUZW1wS2V5VmFsdWUoY3VzdDEpO1xyXG4gICAgICBlbTEuc2F2ZUNoYW5nZXMoKS50aGVuKCBmdW5jdGlvbiggZGF0YSkge1xyXG4gICAgICAgIGxldCBzYW1lQ3VzdDEgPSBkYXRhLnJlc3VsdHNbMF07XHJcbiAgICAgICAgLy8gY3VzdDEgPT09IHNhbWVDdXN0MTtcclxuICAgICAgICAvLyBidXQgY3VzdDEuZ2V0UHJvcGVydHkoXCJDdXN0b21lcklkXCIpICE9IGNpZDFcclxuICAgICAgICAvLyBiZWNhdXNlIHRoZSBzZXJ2ZXIgd2lsbCBoYXZlIGdlbmVyYXRlZCBhIG5ldyBpZFxyXG4gICAgICAgIC8vIGFuZCB0aGUgY2xpZW50IHdpbGwgaGF2ZSBiZWVuIHVwZGF0ZWQgd2l0aCB0aGlzXHJcbiAgICAgICAgLy8gbmV3IGlkLlxyXG4gICAgICB9KTtcclxuICBAbWV0aG9kIGdlbmVyYXRlVGVtcEtleVZhbHVlXHJcbiAgQHBhcmFtIGVudGl0eVR5cGUge0VudGl0eVR5cGV9XHJcbiAgKi9cclxuICBnZW5lcmF0ZVRlbXBLZXlWYWx1ZShlbnRpdHlUeXBlOiBFbnRpdHlUeXBlLCB2YWx1ZUlmQXZhaWw/OiBib29sZWFuKSB7XHJcbiAgICBsZXQga2V5UHJvcHMgPSBlbnRpdHlUeXBlLmtleVByb3BlcnRpZXM7XHJcbiAgICBpZiAoa2V5UHJvcHMubGVuZ3RoID4gMSkge1xyXG4gICAgICB0aHJvdyBuZXcgRXJyb3IoXCJJZHMgY2FuIG5vdCBiZSBhdXRvZ2VuZXJhdGVkIGZvciBlbnRpdGllcyB3aXRoIG11bHRpcGFydCBrZXlzXCIpO1xyXG4gICAgfVxyXG4gICAgbGV0IGtleVByb3AgPSBrZXlQcm9wc1swXTtcclxuICAgIGxldCBwcm9wRW50cnkgPSB0aGlzLl9nZXRQcm9wRW50cnkoa2V5UHJvcCwgdHJ1ZSk7XHJcbiAgICBsZXQgbmV4dElkOiBhbnk7XHJcbiAgICBpZiAodmFsdWVJZkF2YWlsICE9IG51bGwpIHtcclxuICAgICAgaWYgKCFwcm9wRW50cnkua2V5TWFwW3ZhbHVlSWZBdmFpbC50b1N0cmluZygpXSkge1xyXG4gICAgICAgIG5leHRJZCA9IHZhbHVlSWZBdmFpbDtcclxuICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIGlmIChuZXh0SWQgPT09IHVuZGVmaW5lZCkge1xyXG4gICAgICBsZXQgZGF0YVR5cGUgPSBrZXlQcm9wLmRhdGFUeXBlO1xyXG4gICAgICBsZXQgZ2V0TmV4dEZuID0gKGRhdGFUeXBlIGFzIGFueSkuZ2V0TmV4dDtcclxuICAgICAgaWYgKGdldE5leHRGbikge1xyXG4gICAgICAgIG5leHRJZCA9IGdldE5leHRGbih0aGlzKTtcclxuICAgICAgICAvLyBuZWVkIHRvIHdhdGNoIG91dCBmb3IgY29sbGlzaW9uIHdpdGggcHJldmlvdXNseSBpbXBvcnRlZCBpZHMgdGhhdCBtaWdodCBhbHNvIGdldCBnZW5lcmF0ZWQuXHJcbiAgICAgICAgd2hpbGUgKHByb3BFbnRyeS5rZXlNYXBbbmV4dElkLnRvU3RyaW5nKCldICE9IG51bGwpIHtcclxuICAgICAgICAgIG5leHRJZCA9IGdldE5leHRGbih0aGlzKTtcclxuICAgICAgICB9XHJcbiAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKFwiQ2Fubm90IHVzZSBhIHByb3BlcnR5IHdpdGggYSBkYXRhVHlwZSBvZjogXCIgKyBkYXRhVHlwZS50b1N0cmluZygpICsgXCIgZm9yIGlkIGdlbmVyYXRpb25cIik7XHJcbiAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICBwcm9wRW50cnkua2V5TWFwW25leHRJZC50b1N0cmluZygpXSA9IHRydWU7XHJcbiAgICByZXR1cm4gbmV4dElkO1xyXG4gIH1cclxuXHJcbiAgZ2V0VGVtcEtleXMoKSB7XHJcbiAgICBsZXQgcmVzdWx0czogRW50aXR5S2V5W10gPSBbXTtcclxuICAgIC8vbm9pbnNwZWN0aW9uIEpTSGludFxyXG4gICAgZm9yIChsZXQga2V5IGluIHRoaXMuX3RlbXBJZE1hcCkge1xyXG4gICAgICBsZXQgcHJvcEVudHJ5ID0gdGhpcy5fdGVtcElkTWFwW2tleV07XHJcbiAgICAgIGxldCBlbnRpdHlUeXBlID0gcHJvcEVudHJ5LmVudGl0eVR5cGU7XHJcbiAgICAgIC8vIGxldCBwcm9wTmFtZSA9IHByb3BFbnRyeS5wcm9wZXJ0eU5hbWU7XHJcbiAgICAgIC8vbm9pbnNwZWN0aW9uIEpTSGludFxyXG4gICAgICBmb3IgKGxldCBrZXlWYWx1ZSBpbiBwcm9wRW50cnkua2V5TWFwKSB7XHJcbiAgICAgICAgcmVzdWx0cy5wdXNoKG5ldyBFbnRpdHlLZXkoZW50aXR5VHlwZSwgW2tleVZhbHVlXSkpO1xyXG4gICAgICB9XHJcbiAgICB9XHJcbiAgICByZXR1cm4gcmVzdWx0cztcclxuICB9XHJcblxyXG5cclxuICAvLyBwcm90byBtZXRob2RzIGJlbG93IGFyZSBub3QgcGFydCBvZiB0aGUgS2V5R2VuZXJhdG9yIGludGVyZmFjZS5cclxuXHJcbiAgaXNUZW1wS2V5KGVudGl0eUtleTogRW50aXR5S2V5KSB7XHJcbiAgICBsZXQga2V5UHJvcHMgPSBlbnRpdHlLZXkuZW50aXR5VHlwZS5rZXlQcm9wZXJ0aWVzO1xyXG4gICAgaWYgKGtleVByb3BzLmxlbmd0aCA+IDEpIHJldHVybiBmYWxzZTtcclxuICAgIGxldCBrZXlQcm9wID0ga2V5UHJvcHNbMF07XHJcbiAgICBsZXQgcHJvcEVudHJ5ID0gdGhpcy5fZ2V0UHJvcEVudHJ5KGtleVByb3ApO1xyXG4gICAgaWYgKCFwcm9wRW50cnkpIHtcclxuICAgICAgcmV0dXJuIGZhbHNlO1xyXG4gICAgfVxyXG4gICAgcmV0dXJuIChwcm9wRW50cnkua2V5TWFwW2VudGl0eUtleS52YWx1ZXNbMF0udG9TdHJpbmcoKV0gIT09IHVuZGVmaW5lZCk7XHJcbiAgfVxyXG5cclxuICAvKiogQGhpZGRlbiBAaW50ZXJuYWwgKi9cclxuICBwcml2YXRlIF9nZXRQcm9wRW50cnkoa2V5UHJvcDogRGF0YVByb3BlcnR5LCBjcmVhdGVJZk1pc3NpbmcgPSBmYWxzZSkge1xyXG4gICAgbGV0IGtleSA9IGtleVByb3AubmFtZSArIFwiLi5cIiArIGtleVByb3AucGFyZW50VHlwZS5uYW1lO1xyXG4gICAgbGV0IHByb3BFbnRyeSA9IHRoaXMuX3RlbXBJZE1hcFtrZXldO1xyXG4gICAgaWYgKCFwcm9wRW50cnkpIHtcclxuICAgICAgaWYgKGNyZWF0ZUlmTWlzc2luZykge1xyXG4gICAgICAgIHByb3BFbnRyeSA9IHsgZW50aXR5VHlwZToga2V5UHJvcC5wYXJlbnRUeXBlIGFzIEVudGl0eVR5cGUsIHByb3BlcnR5TmFtZToga2V5UHJvcC5uYW1lLCBrZXlNYXA6IHt9IH07XHJcbiAgICAgICAgdGhpcy5fdGVtcElkTWFwW2tleV0gPSBwcm9wRW50cnk7XHJcbiAgICAgIH1cclxuICAgIH1cclxuICAgIHJldHVybiBwcm9wRW50cnk7XHJcbiAgfVxyXG5cclxufVxyXG5cclxuY29uZmlnLnJlZ2lzdGVyVHlwZShLZXlHZW5lcmF0b3IsIFwiS2V5R2VuZXJhdG9yXCIpO1xyXG5cclxuIl19