import * as breeze from 'breeze-client';
let core = breeze.core;
let canIsolateES5Props = core.isES5Supported;
let ko;
export class ModelLibraryKnockoutAdapter {
    constructor() {
        this.name = "ko";
    }
    static register(config) {
        config = config || breeze.config;
        config.registerAdapter("modelLibrary", ModelLibraryKnockoutAdapter);
        return config.initializeAdapterInstance("modelLibrary", "ko", true);
    }
    initialize() {
        ko = core.requireLib("ko;knockout", "The Knockout library");
        ko.extenders.intercept = function (target, interceptorOptions) {
            let instance = interceptorOptions.instance;
            let property = interceptorOptions.property;
            // create a computed observable to intercept writes to our observable
            let result;
            if (target.splice) {
                result = ko.computed({
                    read: target //always return the original observables value
                });
            }
            else {
                result = ko.computed({
                    read: target,
                    write: function (newValue) {
                        instance._$interceptor(property, newValue, target);
                        return instance;
                    }
                });
            }
            //return the new computed observable
            return result;
        };
    }
    getTrackablePropertyNames(entity) {
        let names = [];
        for (let p in entity) {
            if (p === "entityType")
                continue;
            if (p === "_$typeName")
                continue;
            let propDescr = getES5PropDescriptor(entity, p);
            if (propDescr && propDescr.get) {
                names.push(p);
            }
            else {
                let val = entity[p];
                if (ko.isObservable(val)) {
                    names.push(p);
                }
                else if (!core.isFunction(val)) {
                    names.push(p);
                }
            }
        }
        return names;
    }
    initializeEntityPrototype(proto) {
        proto.getProperty = function (propertyName) {
            return this[propertyName]();
        };
        proto.setProperty = function (propertyName, value) {
            this[propertyName](value);
            // allow set property chaining.
            return this;
        };
        if (canIsolateES5Props) {
            isolateES5Props(proto);
        }
    }
    startTracking(entity, proto) {
        // create ko's for each property and assign defaultValues
        let stype = (entity.entityType || entity.complexType);
        let es5Descriptors = stype._extra.es5Descriptors || {};
        // sort unmapped properties to the end
        stype.getProperties().sort(function (p1, p2) {
            let v1 = p1.isUnmapped ? 1 : 0;
            let v2 = p2.isUnmapped ? 1 : 0;
            return v1 - v2;
        }).forEach(function (prop) {
            let propName = prop.name;
            let val = entity[propName];
            let propDescr = es5Descriptors[propName];
            let koObj;
            // check if property is an ES5 property
            if (propDescr) {
                let getFn = propDescr.get.bind(entity);
                if (propDescr.set) {
                    let setFn = propDescr.set.bind(entity);
                    let rawAccessorFn = function (newValue) {
                        if (arguments.length === 0) {
                            getFn();
                            return;
                        }
                        else {
                            setFn(newValue);
                        }
                    };
                    koObj = ko.computed({
                        read: function () {
                            stype._koDummy();
                            return getFn();
                        },
                        write: function (newValue) {
                            entity._$interceptor(prop, newValue, rawAccessorFn);
                            stype._koDummy.valueHasMutated();
                            return entity;
                        }
                    });
                }
                else {
                    koObj = ko.computed({
                        read: getFn,
                        write: function () {
                        }
                    });
                }
                // check if property is already exposed as a ko object
            }
            else if (ko.isObservable(val)) {
                if (prop.isNavigationProperty) {
                    throw new Error("Cannot assign a navigation property in an entity ctor.: " + propName);
                }
                koObj = val;
                // otherwise
            }
            else {
                val = initializeValueForProp(entity, prop, val);
                koObj = prop.isScalar ? ko.observable(val) : ko.observableArray(val);
            }
            if (prop.isScalar) {
                if (propDescr) {
                    Object.defineProperty(entity, propName, {
                        enumerable: true,
                        configurable: true,
                        writable: true,
                        value: koObj
                    });
                }
                else {
                    let koExt = koObj.extend({ intercept: { instance: entity, property: prop } });
                    entity[propName] = koExt;
                }
            }
            else {
                val._koObj = koObj;
                // code to suppress extra breeze notification when
                // ko's array methods are called.
                koObj.subscribe(onBeforeChange, null, "beforeChange");
                // code to insure that any direct breeze changes notify ko
                val.arrayChanged.subscribe(onArrayChanged);
                koObj.equalityComparer = function () {
                    throw new Error("Collection navigation properties may NOT be set.");
                };
                entity[propName] = koObj;
            }
        });
    }
}
breeze.config.registerAdapter("modelLibrary", ModelLibraryKnockoutAdapter);
// private fns
function getES5PropDescriptor(proto, propName) {
    if (!canIsolateES5Props) {
        return null;
    }
    if (proto.hasOwnProperty(propName)) {
        return Object.getOwnPropertyDescriptor && Object.getOwnPropertyDescriptor(proto, propName);
    }
    else {
        let nextProto = Object.getPrototypeOf(proto);
        return nextProto ? getES5PropDescriptor(nextProto, propName) : null;
    }
}
function initializeValueForProp(entity, prop, val) {
    if (prop instanceof breeze.DataProperty) {
        if (prop.isComplexProperty) {
            // TODO: right now we create Empty complexObjects here - these should actually come from the entity
            if (prop.isScalar) {
                val = prop.dataType._createInstanceCore(entity, prop);
            }
            else {
                val = breeze.makeComplexArray([], entity, prop);
            }
        }
        else if (!prop.isScalar) {
            val = breeze.makePrimitiveArray([], entity, prop);
        }
        else if (val === undefined) {
            val = prop.defaultValue;
        }
    }
    else if (prop instanceof breeze.NavigationProperty) {
        if (val !== undefined) {
            throw new Error("Cannot assign a navigation property in an entity ctor.: " + prop.name);
        }
        if (prop.isScalar) {
            // TODO: change this to nullEntity later.
            val = null;
        }
        else {
            val = breeze.makeRelationArray([], entity, prop);
        }
    }
    else {
        throw new Error("unknown property: " + prop.name);
    }
    return val;
}
function onBeforeChange(args) {
    args._koObj._suppressBreeze = true;
}
function onArrayChanged(args) {
    let koObj = args.array._koObj;
    if (koObj._suppressBreeze) {
        koObj._suppressBreeze = false;
    }
    else {
        koObj.valueHasMutated();
    }
}
function isolateES5Props(proto) {
    let stype = (proto.entityType || proto.complexType);
    let es5Descriptors = {};
    stype.getProperties().forEach(function (prop) {
        let propDescr = getES5PropDescriptor(proto, prop.name);
        if (propDescr) {
            es5Descriptors[prop.name] = propDescr;
        }
    });
    if (!core.isEmpty(es5Descriptors)) {
        let extra = stype._extra;
        extra.es5Descriptors = es5Descriptors;
        stype._koDummy = ko.observable(null);
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYWRhcHRlci1tb2RlbC1saWJyYXJ5LWtvLmpzIiwic291cmNlUm9vdCI6Im5nOi8vYnJlZXplLWNsaWVudC9hZGFwdGVyLW1vZGVsLWxpYnJhcnkta28vIiwic291cmNlcyI6WyJhZGFwdGVyLW1vZGVsLWxpYnJhcnkta28udHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxLQUFLLE1BQU0sTUFBTSxlQUFlLENBQUM7QUFFeEMsSUFBSSxJQUFJLEdBQUcsTUFBTSxDQUFDLElBQUksQ0FBQztBQUV2QixJQUFJLGtCQUFrQixHQUFHLElBQUksQ0FBQyxjQUFjLENBQUM7QUFDN0MsSUFBSSxFQUFPLENBQUM7QUFFWixNQUFNLE9BQU8sMkJBQTJCO0lBRXRDO1FBQ0UsSUFBSSxDQUFDLElBQUksR0FBRyxJQUFJLENBQUM7SUFDbkIsQ0FBQztJQUVELE1BQU0sQ0FBQyxRQUFRLENBQUMsTUFBNEI7UUFDMUMsTUFBTSxHQUFHLE1BQU0sSUFBSSxNQUFNLENBQUMsTUFBTSxDQUFDO1FBQ2pDLE1BQU0sQ0FBQyxlQUFlLENBQUMsY0FBYyxFQUFFLDJCQUEyQixDQUFDLENBQUM7UUFDcEUsT0FBTyxNQUFNLENBQUMseUJBQXlCLENBQUMsY0FBYyxFQUFFLElBQUksRUFBRSxJQUFJLENBQWdDLENBQUM7SUFDckcsQ0FBQztJQUVELFVBQVU7UUFDUixFQUFFLEdBQUcsSUFBSSxDQUFDLFVBQVUsQ0FBQyxhQUFhLEVBQUUsc0JBQXNCLENBQUMsQ0FBQztRQUM1RCxFQUFFLENBQUMsU0FBUyxDQUFDLFNBQVMsR0FBRyxVQUFVLE1BQVcsRUFBRSxrQkFBdUI7WUFDckUsSUFBSSxRQUFRLEdBQUcsa0JBQWtCLENBQUMsUUFBUSxDQUFDO1lBQzNDLElBQUksUUFBUSxHQUFHLGtCQUFrQixDQUFDLFFBQVEsQ0FBQztZQUUzQyxxRUFBcUU7WUFDckUsSUFBSSxNQUFXLENBQUM7WUFDaEIsSUFBSSxNQUFNLENBQUMsTUFBTSxFQUFFO2dCQUNqQixNQUFNLEdBQUcsRUFB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O0lBQzlCLElBQUksS0FBSyxDQUFDLGVBQWUsRUFBRTtRQUN6QixLQUFLLENBQUMsZUFBZSxHQUFHLEtBQUssQ0FBQztLQUMvQjtTQUFNO1FBQ0wsS0FBSyxDQUFDLGVBQWUsRUFBRSxDQUFDO0tBQ3pCO0FBQ0gsQ0FBQztBQUVELFNBQVMsZUFBZSxDQUFDLEtBQVU7SUFDakMsSUFBSSxLQUFLLEdBQUcsQ0FBQyxLQUFLLENBQUMsVUFBVSxJQUFJLEtBQUssQ0FBQyxXQUFXLENBQTBCLENBQUM7SUFDN0UsSUFBSSxjQUFjLEdBQUcsRUFBRSxDQUFDO0lBQ3hCLEtBQUssQ0FBQyxhQUFhLEVBQUUsQ0FBQyxPQUFPLENBQUMsVUFBVSxJQUFJO1FBQzFDLElBQUksU0FBUyxHQUFHLG9CQUFvQixDQUFDLEtBQUssRUFBRSxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUM7UUFDdkQsSUFBSSxTQUFTLEVBQUU7WUFDYixjQUFjLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxHQUFHLFNBQVMsQ0FBQztTQUN2QztJQUNILENBQUMsQ0FBQyxDQUFDO0lBQ0gsSUFBSSxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsY0FBYyxDQUFDLEVBQUU7UUFDakMsSUFBSSxLQUFLLEdBQUcsS0FBSyxDQUFDLE1BQU0sQ0FBQztRQUN6QixLQUFLLENBQUMsY0FBYyxHQUFHLGNBQWMsQ0FBQztRQUNyQyxLQUFhLENBQUMsUUFBUSxHQUFHLEVBQUUsQ0FBQyxVQUFVLENBQUMsSUFBSSxDQUFDLENBQUM7S0FDL0M7QUFDSCxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0ICogYXMgYnJlZXplIGZyb20gJ2JyZWV6ZS1jbGllbnQnO1xyXG5cclxubGV0IGNvcmUgPSBicmVlemUuY29yZTtcclxuXHJcbmxldCBjYW5Jc29sYXRlRVM1UHJvcHMgPSBjb3JlLmlzRVM1U3VwcG9ydGVkO1xyXG5sZXQga286IGFueTtcclxuXHJcbmV4cG9ydCBjbGFzcyBNb2RlbExpYnJhcnlLbm9ja291dEFkYXB0ZXIgaW1wbGVtZW50cyBicmVlemUuTW9kZWxMaWJyYXJ5QWRhcHRlciB7XHJcbiAgbmFtZTogc3RyaW5nO1xyXG4gIGNvbnN0cnVjdG9yKCkge1xyXG4gICAgdGhpcy5uYW1lID0gXCJrb1wiO1xyXG4gIH1cclxuXHJcbiAgc3RhdGljIHJlZ2lzdGVyKGNvbmZpZz86IGJyZWV6ZS5CcmVlemVDb25maWcpIHtcclxuICAgIGNvbmZpZyA9IGNvbmZpZyB8fCBicmVlemUuY29uZmlnO1xyXG4gICAgY29uZmlnLnJlZ2lzdGVyQWRhcHRlcihcIm1vZGVsTGlicmFyeVwiLCBNb2RlbExpYnJhcnlLbm9ja291dEFkYXB0ZXIpO1xyXG4gICAgcmV0dXJuIGNvbmZpZy5pbml0aWFsaXplQWRhcHRlckluc3RhbmNlKFwibW9kZWxMaWJyYXJ5XCIsIFwia29cIiwgdHJ1ZSkgYXMgTW9kZWxMaWJyYXJ5S25vY2tvdXRBZGFwdGVyO1xyXG4gIH1cclxuXHJcbiAgaW5pdGlhbGl6ZSgpIHtcclxuICAgIGtvID0gY29yZS5yZXF1aXJlTGliKFwia287a25vY2tvdXRcIiwgXCJUaGUgS25vY2tvdXQgbGlicmFyeVwiKTtcclxuICAgIGtvLmV4dGVuZGVycy5pbnRlcmNlcHQgPSBmdW5jdGlvbiAodGFyZ2V0OiBhbnksIGludGVyY2VwdG9yT3B0aW9uczogYW55KSB7XHJcbiAgICAgIGxldCBpbnN0YW5jZSA9IGludGVyY2VwdG9yT3B0aW9ucy5pbnN0YW5jZTtcclxuICAgICAgbGV0IHByb3BlcnR5ID0gaW50ZXJjZXB0b3JPcHRpb25zLnByb3BlcnR5O1xyXG5cclxuICAgICAgLy8gY3JlYXRlIGEgY29tcHV0ZWQgb2JzZXJ2YWJsZSB0byBpbnRlcmNlcHQgd3JpdGVzIHRvIG91ciBvYnNlcnZhYmxlXHJcbiAgICAgIGxldCByZXN1bHQ6IGFueTtcclxuICAgICAgaWYgKHRhcmdldC5zcGxpY2UpIHtcclxuICAgICAgICByZXN1bHQgPSBrby5jb21wdXRlZCh7XHJcbiAgICAgICAgICByZWFkOiB0YXJnZXQgIC8vYWx3YXlzIHJldHVybiB0aGUgb3JpZ2luYWwgb2JzZXJ2YWJsZXMgdmFsdWVcclxuICAgICAgICB9KTtcclxuICAgICAgfSBlbHNlIHtcclxuICAgICAgICByZXN1bHQgPSBrby5jb21wdXRlZCh7XHJcbiAgICAgICAgICByZWFkOiB0YXJnZXQsICAvL2Fsd2F5cyByZXR1cm4gdGhlIG9yaWdpbmFsIG9ic2VydmFibGVzIHZhbHVlXHJcbiAgICAgICAgICB3cml0ZTogZnVuY3Rpb24gKG5ld1ZhbHVlOiBhbnkpIHtcclxuICAgICAgICAgICAgaW5zdGFuY2UuXyRpbnRlcmNlcHRvcihwcm9wZXJ0eSwgbmV3VmFsdWUsIHRhcmdldCk7XHJcbiAgICAgICAgICAgIHJldHVybiBpbnN0YW5jZTtcclxuICAgICAgICAgIH1cclxuICAgICAgICB9KTtcclxuICAgICAgfVxyXG4gICAgICAvL3JldHVybiB0aGUgbmV3IGNvbXB1dGVkIG9ic2VydmFibGVcclxuICAgICAgcmV0dXJuIHJlc3VsdDtcclxuICAgIH07XHJcblxyXG4gIH1cclxuXHJcbiAgZ2V0VHJhY2thYmxlUHJvcGVydHlOYW1lcyhlbnRpdHk6IGFueSkge1xyXG4gICAgbGV0IG5hbWVzOiBzdHJpbmdbXSA9IFtdO1xyXG4gICAgZm9yIChsZXQgcCBpbiBlbnRpdHkpIHtcclxuICAgICAgaWYgKHAgPT09IFwiZW50aXR5VHlwZVwiKSBjb250aW51ZTtcclxuICAgICAgaWYgKHAgPT09IFwiXyR0eXBlTmFtZVwiKSBjb250aW51ZTtcclxuXHJcbiAgICAgIGxldCBwcm9wRGVzY3IgPSBnZXRFUzVQcm9wRGVzY3JpcHRvcihlbnRpdHksIHApO1xyXG4gICAgICBpZiAocHJvcERlc2NyICYmIHByb3BEZXNjci5nZXQpIHtcclxuICAgICAgICBuYW1lcy5wdXNoKHApO1xyXG4gICAgICB9IGVsc2Uge1xyXG4gICAgICAgIGxldCB2YWwgPSBlbnRpdHlbcF07XHJcbiAgICAgICAgaWYgKGtvLmlzT2JzZXJ2YWJsZSh2YWwpKSB7XHJcbiAgICAgICAgICBuYW1lcy5wdXNoKHApO1xyXG4gICAgICAgIH0gZWxzZSBpZiAoIWNvcmUuaXNGdW5jdGlvbih2YWwpKSB7XHJcbiAgICAgICAgICBuYW1lcy5wdXNoKHApO1xyXG4gICAgICAgIH1cclxuICAgICAgfVxyXG4gICAgfVxyXG4gICAgcmV0dXJuIG5hbWVzO1xyXG4gIH1cclxuXHJcbiAgaW5pdGlhbGl6ZUVudGl0eVByb3RvdHlwZShwcm90bzogYW55KSB7XHJcblxyXG4gICAgcHJvdG8uZ2V0UHJvcGVydHkgPSBmdW5jdGlvbiAocHJvcGVydHlOYW1lOiBzdHJpbmcpIHtcclxuICAgICAgcmV0dXJuIHRoaXNbcHJvcGVydHlOYW1lXSgpO1xyXG4gICAgfTtcclxuXHJcbiAgICBwcm90by5zZXRQcm9wZXJ0eSA9IGZ1bmN0aW9uIChwcm9wZXJ0eU5hbWU6IHN0cmluZywgdmFsdWU6IGFueSkge1xyXG4gICAgICB0aGlzW3Byb3BlcnR5TmFtZV0odmFsdWUpO1xyXG4gICAgICAvLyBhbGxvdyBzZXQgcHJvcGVydHkgY2hhaW5pbmcuXHJcbiAgICAgIHJldHVybiB0aGlzO1xyXG4gICAgfTtcclxuXHJcbiAgICBpZiAoY2FuSXNvbGF0ZUVTNVByb3BzKSB7XHJcbiAgICAgIGlzb2xhdGVFUzVQcm9wcyhwcm90byk7XHJcbiAgICB9XHJcblxyXG4gIH1cclxuXHJcbiAgc3RhcnRUcmFja2luZyhlbnRpdHk6IGFueSwgcHJvdG86IGFueSkge1xyXG4gICAgLy8gY3JlYXRlIGtvJ3MgZm9yIGVhY2ggcHJvcGVydHkgYW5kIGFzc2lnbiBkZWZhdWx0VmFsdWVzXHJcblxyXG4gICAgbGV0IHN0eXBlID0gKGVudGl0eS5lbnRpdHlUeXBlIHx8IGVudGl0eS5jb21wbGV4VHlwZSkgYXMgYnJlZXplLlN0cnVjdHVyYWxUeXBlO1xyXG4gICAgbGV0IGVzNURlc2NyaXB0b3JzID0gc3R5cGUuX2V4dHJhLmVzNURlc2NyaXB0b3JzIHx8IHt9O1xyXG5cclxuICAgIC8vIHNvcnQgdW5tYXBwZWQgcHJvcGVydGllcyB0byB0aGUgZW5kXHJcbiAgICBzdHlwZS5nZXRQcm9wZXJ0aWVzKCkuc29ydChmdW5jdGlvbiAocDEsIHAyKSB7XHJcbiAgICAgIGxldCB2MSA9IHAxLmlzVW5tYXBwZWQgPyAxIDogMDtcclxuICAgICAgbGV0IHYyID0gcDIuaXNVbm1hcHBlZCA/IDEgOiAwO1xyXG4gICAgICByZXR1cm4gdjEgLSB2MjtcclxuICAgIH0pLmZvckVhY2goZnVuY3Rpb24gKHByb3ApIHtcclxuICAgICAgbGV0IHByb3BOYW1lID0gcHJvcC5uYW1lO1xyXG4gICAgICBsZXQgdmFsID0gZW50aXR5W3Byb3BOYW1lXTtcclxuICAgICAgbGV0IHByb3BEZXNjciA9IGVzNURlc2NyaXB0b3JzW3Byb3BOYW1lXTtcclxuICAgICAgbGV0IGtvT2JqOiBhbnk7XHJcblxyXG4gICAgICAvLyBjaGVjayBpZiBwcm9wZXJ0eSBpcyBhbiBFUzUgcHJvcGVydHlcclxuICAgICAgaWYgKHByb3BEZXNjcikge1xyXG4gICAgICAgIGxldCBnZXRGbiA9IHByb3BEZXNjci5nZXQuYmluZChlbnRpdHkpO1xyXG4gICAgICAgIGlmIChwcm9wRGVzY3Iuc2V0KSB7XHJcbiAgICAgICAgICBsZXQgc2V0Rm4gPSBwcm9wRGVzY3Iuc2V0LmJpbmQoZW50aXR5KTtcclxuICAgICAgICAgIGxldCByYXdBY2Nlc3NvckZuID0gZnVuY3Rpb24gKG5ld1ZhbHVlOiBhbnkpIHtcclxuICAgICAgICAgICAgaWYgKGFyZ3VtZW50cy5sZW5ndGggPT09IDApIHtcclxuICAgICAgICAgICAgICBnZXRGbigpO1xyXG4gICAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICBzZXRGbihuZXdWYWx1ZSk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgIH07XHJcbiAgICAgICAgICBrb09iaiA9IGtvLmNvbXB1dGVkKHtcclxuICAgICAgICAgICAgcmVhZDogZnVuY3Rpb24gKCkge1xyXG4gICAgICAgICAgICAgIChzdHlwZSBhcyBhbnkpLl9rb0R1bW15KCk7XHJcbiAgICAgICAgICAgICAgcmV0dXJuIGdldEZuKCk7XHJcbiAgICAgICAgICAgIH0sXHJcbiAgICAgICAgICAgIHdyaXRlOiBmdW5jdGlvbiAobmV3VmFsdWU6IGFueSkge1xyXG4gICAgICAgICAgICAgIGVudGl0eS5fJGludGVyY2VwdG9yKHByb3AsIG5ld1ZhbHVlLCByYXdBY2Nlc3NvckZuKTtcclxuICAgICAgICAgICAgICAoc3R5cGUgYXMgYW55KS5fa29EdW1teS52YWx1ZUhhc011dGF0ZWQoKTtcclxuICAgICAgICAgICAgICByZXR1cm4gZW50aXR5O1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICB9KTtcclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAga29PYmogPSBrby5jb21wdXRlZCh7XHJcbiAgICAgICAgICAgIHJlYWQ6IGdldEZuLFxyXG4gICAgICAgICAgICB3cml0ZTogZnVuY3Rpb24gKCkge1xyXG4gICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgfSk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIC8vIGNoZWNrIGlmIHByb3BlcnR5IGlzIGFscmVhZHkgZXhwb3NlZCBhcyBhIGtvIG9iamVjdFxyXG4gICAgICB9IGVsc2UgaWYgKGtvLmlzT2JzZXJ2YWJsZSh2YWwpKSB7XHJcbiAgICAgICAgaWYgKHByb3AuaXNOYXZpZ2F0aW9uUHJvcGVydHkpIHtcclxuICAgICAgICAgIHRocm93IG5ldyBFcnJvcihcIkNhbm5vdCBhc3NpZ24gYSBuYXZpZ2F0aW9uIHByb3BlcnR5IGluIGFuIGVudGl0eSBjdG9yLjogXCIgKyBwcm9wTmFtZSk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGtvT2JqID0gdmFsO1xyXG4gICAgICAgIC8vIG90aGVyd2lzZVxyXG4gICAgICB9IGVsc2Uge1xyXG4gICAgICAgIHZhbCA9IGluaXRpYWxpemVWYWx1ZUZvclByb3AoZW50aXR5LCBwcm9wLCB2YWwpO1xyXG4gICAgICAgIGtvT2JqID0gcHJvcC5pc1NjYWxhciA/IGtvLm9ic2VydmFibGUodmFsKSA6IGtvLm9ic2VydmFibGVBcnJheSh2YWwpO1xyXG4gICAgICB9XHJcblxyXG5cclxuICAgICAgaWYgKHByb3AuaXNTY2FsYXIpIHtcclxuICAgICAgICBpZiAocHJvcERlc2NyKSB7XHJcbiAgICAgICAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkoZW50aXR5LCBwcm9wTmFtZSwge1xyXG4gICAgICAgICAgICBlbnVtZXJhYmxlOiB0cnVlLFxyXG4gICAgICAgICAgICBjb25maWd1cmFibGU6IHRydWUsXHJcbiAgICAgICAgICAgIHdyaXRhYmxlOiB0cnVlLFxyXG4gICAgICAgICAgICB2YWx1ZToga29PYmpcclxuICAgICAgICAgIH0pO1xyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICBsZXQga29FeHQgPSBrb09iai5leHRlbmQoeyBpbnRlcmNlcHQ6IHsgaW5zdGFuY2U6IGVudGl0eSwgcHJvcGVydHk6IHByb3AgfSB9KTtcclxuICAgICAgICAgIGVudGl0eVtwcm9wTmFtZV0gPSBrb0V4dDtcclxuICAgICAgICB9XHJcbiAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgdmFsLl9rb09iaiA9IGtvT2JqO1xyXG4gICAgICAgIC8vIGNvZGUgdG8gc3VwcHJlc3MgZXh0cmEgYnJlZXplIG5vdGlmaWNhdGlvbiB3aGVuXHJcbiAgICAgICAgLy8ga28ncyBhcnJheSBtZXRob2RzIGFyZSBjYWxsZWQuXHJcbiAgICAgICAga29PYmouc3Vic2NyaWJlKG9uQmVmb3JlQ2hhbmdlLCBudWxsLCBcImJlZm9yZUNoYW5nZVwiKTtcclxuICAgICAgICAvLyBjb2RlIHRvIGluc3VyZSB0aGF0IGFueSBkaXJlY3QgYnJlZXplIGNoYW5nZXMgbm90aWZ5IGtvXHJcbiAgICAgICAgdmFsLmFycmF5Q2hhbmdlZC5zdWJzY3JpYmUob25BcnJheUNoYW5nZWQpO1xyXG5cclxuICAgICAgICBrb09iai5lcXVhbGl0eUNvbXBhcmVyID0gZnVuY3Rpb24gKCkge1xyXG4gICAgICAgICAgdGhyb3cgbmV3IEVycm9yKFwiQ29sbGVjdGlvbiBuYXZpZ2F0aW9uIHByb3BlcnRpZXMgbWF5IE5PVCBiZSBzZXQuXCIpO1xyXG4gICAgICAgIH07XHJcbiAgICAgICAgZW50aXR5W3Byb3BOYW1lXSA9IGtvT2JqO1xyXG4gICAgICB9XHJcblxyXG4gICAgfSk7XHJcblxyXG4gIH1cclxufVxyXG5cclxuYnJlZXplLmNvbmZpZy5yZWdpc3RlckFkYXB0ZXIoXCJtb2RlbExpYnJhcnlcIiwgTW9kZWxMaWJyYXJ5S25vY2tvdXRBZGFwdGVyKTtcclxuXHJcblxyXG4vLyBwcml2YXRlIGZuc1xyXG5cclxuZnVuY3Rpb24gZ2V0RVM1UHJvcERlc2NyaXB0b3IocHJvdG86IGFueSwgcHJvcE5hbWU6IHN0cmluZyk6IGFueSB7XHJcbiAgaWYgKCFjYW5Jc29sYXRlRVM1UHJvcHMpIHtcclxuICAgIHJldHVybiBudWxsO1xyXG4gIH1cclxuICBpZiAocHJvdG8uaGFzT3duUHJvcGVydHkocHJvcE5hbWUpKSB7XHJcbiAgICByZXR1cm4gT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvciAmJiBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yKHByb3RvLCBwcm9wTmFtZSk7XHJcbiAgfSBlbHNlIHtcclxuICAgIGxldCBuZXh0UHJvdG8gPSBPYmplY3QuZ2V0UHJvdG90eXBlT2YocHJvdG8pO1xyXG4gICAgcmV0dXJuIG5leHRQcm90byA/IGdldEVTNVByb3BEZXNjcmlwdG9yKG5leHRQcm90bywgcHJvcE5hbWUpIDogbnVsbDtcclxuICB9XHJcbn1cclxuXHJcbmZ1bmN0aW9uIGluaXRpYWxpemVWYWx1ZUZvclByb3AoZW50aXR5OiBhbnksIHByb3A6IGJyZWV6ZS5FbnRpdHlQcm9wZXJ0eSwgdmFsOiBhbnkpIHtcclxuICBpZiAocHJvcCBpbnN0YW5jZW9mIGJyZWV6ZS5EYXRhUHJvcGVydHkpIHtcclxuICAgIGlmIChwcm9wLmlzQ29tcGxleFByb3BlcnR5KSB7XHJcbiAgICAgIC8vIFRPRE86IHJpZ2h0IG5vdyB3ZSBjcmVhdGUgRW1wdHkgY29tcGxleE9iamVjdHMgaGVyZSAtIHRoZXNlIHNob3VsZCBhY3R1YWxseSBjb21lIGZyb20gdGhlIGVudGl0eVxyXG4gICAgICBpZiAocHJvcC5pc1NjYWxhcikge1xyXG4gICAgICAgIHZhbCA9IChwcm9wLmRhdGFUeXBlIGFzIGJyZWV6ZS5Db21wbGV4VHlwZSkuX2NyZWF0ZUluc3RhbmNlQ29yZShlbnRpdHksIHByb3ApO1xyXG4gICAgICB9IGVsc2Uge1xyXG4gICAgICAgIHZhbCA9IGJyZWV6ZS5tYWtlQ29tcGxleEFycmF5KFtdLCBlbnRpdHksIHByb3ApO1xyXG4gICAgICB9XHJcbiAgICB9IGVsc2UgaWYgKCFwcm9wLmlzU2NhbGFyKSB7XHJcbiAgICAgIHZhbCA9IGJyZWV6ZS5tYWtlUHJpbWl0aXZlQXJyYXkoW10sIGVudGl0eSwgcHJvcCk7XHJcbiAgICB9IGVsc2UgaWYgKHZhbCA9PT0gdW5kZWZpbmVkKSB7XHJcbiAgICAgIHZhbCA9IHByb3AuZGVmYXVsdFZhbHVlO1xyXG4gICAgfVxyXG5cclxuICB9IGVsc2UgaWYgKHByb3AgaW5zdGFuY2VvZiBicmVlemUuTmF2aWdhdGlvblByb3BlcnR5KSB7XHJcbiAgICBpZiAodmFsICE9PSB1bmRlZmluZWQpIHtcclxuICAgICAgdGhyb3cgbmV3IEVycm9yKFwiQ2Fubm90IGFzc2lnbiBhIG5hdmlnYXRpb24gcHJvcGVydHkgaW4gYW4gZW50aXR5IGN0b3IuOiBcIiArIHByb3AubmFtZSk7XHJcbiAgICB9XHJcbiAgICBpZiAocHJvcC5pc1NjYWxhcikge1xyXG4gICAgICAvLyBUT0RPOiBjaGFuZ2UgdGhpcyB0byBudWxsRW50aXR5IGxhdGVyLlxyXG4gICAgICB2YWwgPSBudWxsO1xyXG4gICAgfSBlbHNlIHtcclxuICAgICAgdmFsID0gYnJlZXplLm1ha2VSZWxhdGlvbkFycmF5KFtdLCBlbnRpdHksIHByb3ApO1xyXG4gICAgfVxyXG4gIH0gZWxzZSB7XHJcbiAgICB0aHJvdyBuZXcgRXJyb3IoXCJ1bmtub3duIHByb3BlcnR5OiBcIiArIChwcm9wIGFzIGFueSkubmFtZSk7XHJcbiAgfVxyXG4gIHJldHVybiB2YWw7XHJcbn1cclxuXHJcblxyXG5mdW5jdGlvbiBvbkJlZm9yZUNoYW5nZShhcmdzOiBhbnkpIHtcclxuICBhcmdzLl9rb09iai5fc3VwcHJlc3NCcmVlemUgPSB0cnVlO1xyXG59XHJcblxyXG5mdW5jdGlvbiBvbkFycmF5Q2hhbmdlZChhcmdzOiBhbnkpIHtcclxuICBsZXQga29PYmogPSBhcmdzLmFycmF5Ll9rb09iajtcclxuICBpZiAoa29PYmouX3N1cHByZXNzQnJlZXplKSB7XHJcbiAgICBrb09iai5fc3VwcHJlc3NCcmVlemUgPSBmYWxzZTtcclxuICB9IGVsc2Uge1xyXG4gICAga29PYmoudmFsdWVIYXNNdXRhdGVkKCk7XHJcbiAgfVxyXG59XHJcblxyXG5mdW5jdGlvbiBpc29sYXRlRVM1UHJvcHMocHJvdG86IGFueSkge1xyXG4gIGxldCBzdHlwZSA9IChwcm90by5lbnRpdHlUeXBlIHx8IHByb3RvLmNvbXBsZXhUeXBlKSBhcyBicmVlemUuU3RydWN0dXJhbFR5cGU7XHJcbiAgbGV0IGVzNURlc2NyaXB0b3JzID0ge307XHJcbiAgc3R5cGUuZ2V0UHJvcGVydGllcygpLmZvckVhY2goZnVuY3Rpb24gKHByb3ApIHtcclxuICAgIGxldCBwcm9wRGVzY3IgPSBnZXRFUzVQcm9wRGVzY3JpcHRvcihwcm90bywgcHJvcC5uYW1lKTtcclxuICAgIGlmIChwcm9wRGVzY3IpIHtcclxuICAgICAgZXM1RGVzY3JpcHRvcnNbcHJvcC5uYW1lXSA9IHByb3BEZXNjcjtcclxuICAgIH1cclxuICB9KTtcclxuICBpZiAoIWNvcmUuaXNFbXB0eShlczVEZXNjcmlwdG9ycykpIHtcclxuICAgIGxldCBleHRyYSA9IHN0eXBlLl9leHRyYTtcclxuICAgIGV4dHJhLmVzNURlc2NyaXB0b3JzID0gZXM1RGVzY3JpcHRvcnM7XHJcbiAgICAoc3R5cGUgYXMgYW55KS5fa29EdW1teSA9IGtvLm9ic2VydmFibGUobnVsbCk7XHJcbiAgfVxyXG59XHJcblxyXG4iXX0=