//#region Copyright, Version, and Description
/*
 * Copyright 2015-2019 IdeaBlade, Inc.  All Rights Reserved.
 * Use, reproduction, distribution, and modification of this code is subject to the terms and
 * conditions of the IdeaBlade Breeze license, available at http://www.breezejs.com/license
 *
 * Author: Ward Bell
 * Version: 2.0.6 Steve Schmitt - convert to TypeScript, move to breeze-client repo, change enableSaveQueuing function
 * Version: 2.0.5 Ward Bell
 * --------------------------------------------------------------------------------
 * Adds "Save Queuing" capability to new EntityManagers
 *
 * Save Queuing automatically queues and defers an EntityManager.saveChanges call
 * when another save is in progress for that manager and the server has not yet responded.
 * This feature is helpful when your app needs to allow rapid, continuous changes
 * to entities that may be in the process of being saved.
 *
 * Without "Save Queuing", an EntityManager will throw an exception
 * when you call saveChanges for an entity which is currently being saved.
 *
 * !!! Use with caution !!!
 * It is usually better to disable user input while a save is in progress.
 * Save Queuing may be appropriate for simple "auto-save" scenarios
 * when the save latency is "short" (under a few seconds).
 *
 * Save Queuing is NOT intended for occassionally disconnected or offline scenarios.
 *
 * Save Queuing is experimental. It will not become a part of BreezeJS core
 * but might become an official Breeze plugin in future
 * although not necessarily in this form or with this API
 *
 * Must call EntityManager.enableSaveQueuing(true) to turn it on;
 * EntityManager.enableSaveQueuing(false) restores the manager's original
 * saveChanges method as it was at the time saveQueuing was first enabled.
 *
 * This module adds "enableSaveQueuing" to the EntityManager prototype.
 * Calling "enableSaveQueuing(true)" adds a new _saveQueuing object
 * to the manager instance.
 *
 * See DocCode:saveQueuingTests.js
 * https://github.com/Breeze/breeze.js.samples/blob/master/net/DocCode/DocCode/tests/saveQueuingTests.js
 *
 * LIMITATIONS
 * - Can't handle changes to the primary key (dangerous in any case)
 * - Assumes promises. Does not support the (deprecated) success and fail callbacks
 * - Does not queue saveOptions. The first one is re-used for all queued saves.
 * - Does not deal with export/import of entities while save is inflight
 * - Does not deal with rejectChanges while save is in flight
 * - Does not support parallel saves even when the change-sets are independent.
 *   The native saveChanges allows such saves.
 *   SaveQueuing does not; too complex and doesn't fit the primary scenario anyway.
 * - The resolved saveResult is the saveResult of the last completed save
 * - A queued save that might have succeeded if saved immediately
 *   may fail because the server no longer accepts it later
 * - Prior to Breeze v.1.5.3, a queued save that might have succeeded
 *   if saved immediately will fail if subsequently attempt to save
 *   an invalid entity. Can detect and circumvent after v.1.5.3.
 *
 * All members of EntityManager._saveQueuing are internal;
 * touch them at your own risk.
 */
//#endregion
import { EntityState, breeze } from 'breeze-client';
export function enableSaveQueuing(em, enable = true) {
    let saveQueuing = em['_saveQueueing'] ||
        (em['_saveQueuing'] = new SaveQueuing(em));
    enable = (enable === undefined) ? true : enable;
    saveQueuing._isEnabled = enable;
    if (enable) {
        // delegate to save changes queuing
        em.saveChanges = saveChangesWithQueuing;
    }
    else {
        // revert to the native EntityManager.saveChanges
        em.saveChanges = em['_saveQueuing'].baseSaveChanges;
    }
}
/**
 * Replacement for EntityManager.saveChanges
 * This version queues saveChanges calls while a real save is in progress
 **/
function saveChangesWithQueuing(entities, saveOptions) {
    try {
        // `this` is an EntityManager
        let saveQueuing = this._saveQueuing;
        if (saveQueuing.isSaving) {
            // save in progress; queue the save for later
            return saveQueuing.queueSaveChanges(entities);
        }
        else {
            // note that save is in progress; then save
            saveQueuing.isSaving = true;
            saveQueuing.saveOptions = saveOptions;
            return saveQueuing.saveChanges(entities, saveOptions);
        }
    }
    catch (err) {
        return Promise.reject(err);
    }
}
///////// SaveQueuing /////////
class SaveQueuing {
    constructor(entityManager) {
        this.entityManager = entityManager;
        this.baseSaveChanges = entityManager.saveChanges;
        this.isSaving = false;
    }
    isEnabled() {
        return this._isEnabled;
    }
    getSavedNothingResult() {
        return { entities: [], keyMappings: [] };
    }
    queueSaveChanges(entities) {
        let self = this; // `this` is a SaveQueuing
        let em = self.entityManager;
        let changes = entities || em.getChanges();
        if (changes.length === 0) {
            return Promise.resolve(this.getSavedNothingResult());
        }
        let valError = em.saveChangesValidateOnClient(changes);
        if (valError) {
            return Promise.reject(valError);
        }
        let saveMemo = self.nextSaveMemo || (self.nextSaveMemo = new SaveMemo());
        memoizeChanges();
        let deferred = self.nextSaveDeferred || (self.nextSaveDeferred = new Deferred());
        return deferred.promise;
        function memoizeChanges() {
            if (changes.length === 0) {
                return;
            }
            let queuedChanges = saveMemo.queuedChanges;
            changes.forEach(e => {
                if (!e.entityAspect.isBeingSaved && queuedChanges.indexOf(e) === -1) {
                    queuedChanges.push(e);
                }
            });
            saveMemo.updateEntityMemos(changes);
        }
    }
    saveChanges(entities, saveOptions) {
        let self = this; // `this` is a SaveQueuing
        let promise = self.baseSaveChanges.call(self.entityManager, entities, saveOptions || self.saveOptions)
            .then(function (saveResult) { return self.saveSucceeded(saveResult); })
            .then(null, function (error) { console.log(error); return self.saveFailed(error); });
        rememberAddedOriginalValues(entities); // do it after ... so don't send OrigValues to the server
        return promise;
        function rememberAddedOriginalValues(entities) {
            // added entities normally don't have original values but these will now
            let added = entities ?
                entities.filter(function (e) { return e.entityAspect.entityState.isAdded(); }) :
                self.entityManager.getEntities(null, EntityState.Added);
            added.forEach(entity => {
                let props = entity.entityType.dataProperties;
                let originalValues = entity.entityAspect.originalValues;
                props.forEach(dp => {
                    if (dp.isPartOfKey) {
                        return;
                    }
                    originalValues[dp.name] = entity.getProperty(dp.name);
                });
            });
        }
    }
    saveSucceeded(saveResult) {
        let self = this; // `this` is a SaveQueueing
        let activeSaveDeferred = self.activeSaveDeferred;
        let nextSaveDeferred = self.nextSaveDeferred;
        let nextSaveMemo = self.nextSaveMemo;
        // prepare as if nothing queued or left to save
        self.isSaving = false;
        self.activeSaveDeferred = null;
        self.activeSaveMemo = null;
        self.nextSaveDeferred = null;
        self.nextSaveMemo = null;
        if (nextSaveMemo) {
            // a save was queued since last save returned
            nextSaveMemo.pkFixup(saveResult.keyMappings);
            nextSaveMemo.applyToSavedEntities(self.entityManager, saveResult.entities);
            // remove detached entities from queuedChanges
            let queuedChanges = nextSaveMemo.queuedChanges.filter(e => {
                return !e.entityAspect.entityState.isDetached();
            });
            if (queuedChanges.length > 0) {
                // save again
                self.isSaving = true;
                // remember the queued changes that triggered this save
                self.activeSaveDeferred = nextSaveDeferred;
                self.activeSaveMemo = nextSaveMemo;
                self.saveChanges(queuedChanges, this.saveOptions);
            }
            else if (nextSaveDeferred) {
                nextSaveDeferred.resolve(this.getSavedNothingResult());
            }
        }
        if (activeSaveDeferred) {
            activeSaveDeferred.resolve(saveResult);
        }
        return saveResult; // for the current promise chain
    }
    saveFailed(error) {
        let self = this; // `this` is a SaveQueueing
        error = new QueuedSaveFailedError(error, self);
        let activeSaveDeferred = self.activeSaveDeferred;
        let nextSaveDeferred = self.nextSaveDeferred;
        self.isSaving = false;
        self.activeSaveDeferred = null;
        self.activeSaveMemo = null;
        self.nextSaveDeferred = null;
        self.nextSaveMemo = null;
        if (activeSaveDeferred) {
            activeSaveDeferred.reject(error);
        }
        if (nextSaveDeferred) {
            nextSaveDeferred.reject(error);
        }
        return Promise.reject(error); // let promise chain hear error
    }
}
/// for backward compat with older Promise implementation
class Deferred {
    constructor() {
        this.promise = new Promise(function (resolve, reject) {
            this.resolve = resolve;
            this.reject = reject;
        }.bind(this));
    }
}
////////// QueuedSaveFailedError /////////
// Error sub-class thrown when rejecting queued saves.
class QueuedSaveFailedError extends Error {
    // Error sub-class thrown when rejecting queued saves.
    // `innerError` is the actual save error
    // `failedSaveMemo` is the saveMemo that prompted this save
    // `nextSaveMemo` holds queued changes accumulated since that save.
    // You may try to recover using this info. Good luck with that.
    constructor(errObject, saveQueuing) {
        super();
        this.name = "QueuedSaveFailedError";
        this.innerError = errObject;
        this.message = "Queued save failed: " + errObject.message;
        this.failedSaveMemo = saveQueuing.activeSaveMemo;
        this.nextSaveMemo = saveQueuing.nextSaveMemo;
    }
}
////////// SaveMemo ////////////////
// SaveMemo is a record of changes for a queued save, consisting of:
//   entityMemos:   info about entities that are being saved and
//                  have been changed since the save started
//   queuedChanges: entities that are queued for save but
//                  are not currently being saved
class SaveMemo {
    constructor() {
        this.entityMemos = {};
        this.queuedChanges = [];
    }
    applyToSavedEntities(entityManager, savedEntities) {
        let entityMemos = this.entityMemos; // `this` is a SaveMemo
        let queuedChanges = this.queuedChanges;
        let restorePublishing = this.disableManagerPublishing(entityManager);
        try {
            savedEntities.forEach(saved => {
                let key = this.makeEntityMemoKey(saved);
                let entityMemo = entityMemos[key];
                let resave = entityMemo && entityMemo.applyToSavedEntity(saved);
                if (resave) {
                    queuedChanges.push(saved);
                }
            });
        }
        finally {
            restorePublishing();
            // D#2651 hasChanges will be wrong if changes made while save in progress
            let hasChanges = queuedChanges.length > 0;
            // Must use breeze internal method to properly set this flag true
            if (hasChanges) {
                entityManager._setHasChanges(true);
            }
        }
    }
    disableManagerPublishing(manager) {
        let Event = breeze.Event;
        Event.enable('entityChanged', manager, false);
        Event.enable('hasChangesChanged', manager, false);
        return function restorePublishing() {
            Event.enable('entityChanged', manager, true);
            Event.enable('hasChangesChanged', manager, true);
        };
    }
    pkFixup(keyMappings) {
        let entityMemos = this.entityMemos; // `this` is a SaveMemo
        keyMappings.forEach(km => {
            let type = km.entityTypeName;
            let tempKey = type + '|' + km.tempValue;
            if (entityMemos[tempKey]) {
                entityMemos[type + '|' + km.realValue] = entityMemos[tempKey];
                delete entityMemos[tempKey];
            }
            for (let memoKey in entityMemos) {
                entityMemos[memoKey].fkFixup(km);
            }
        });
    }
    makeEntityMemoKey(entity) {
        let entityKey = entity.entityAspect.getKey();
        return entityKey.entityType.name + '|' + entityKey.values;
    }
    updateEntityMemos(changes) {
        let entityMemos = this.entityMemos; // `this` is a SaveMemo
        changes.forEach(change => {
            // only update entityMemo for entity being save
            if (!change.entityAspect.isBeingSaved) {
                return;
            }
            let key = this.makeEntityMemoKey(change);
            let entityMemo = entityMemos[key] || (entityMemos[key] = new EntityMemo(change));
            entityMemo.update(change);
        });
    }
}
///////// EntityMemo Type ///////////////
// Information about an entity that is being saved
// and which has been changed since that save started
class EntityMemo {
    constructor(entity) {
        this.entity = entity;
        this.pendingChanges = {};
    }
    applyToSavedEntity(saved) {
        let entityMemo = this;
        let aspect = saved.entityAspect;
        if (aspect.entityState.isDetached()) {
            return false;
        }
        else if (entityMemo.isDeleted) {
            aspect.setDeleted();
            return true;
        }
        // treat entity with pending changes as modified
        let props = Object.keys(entityMemo.pendingChanges);
        if (props.length === 0) {
            return false;
        }
        let originalValues = aspect.originalValues;
        props.forEach(name => {
            originalValues[name] = saved.getProperty(name);
            saved.setProperty(name, entityMemo.pendingChanges[name]);
        });
        aspect.setModified();
        return true;
    }
    fkFixup(keyMapping) {
        let entityMemo = this;
        let type = entityMemo.entity.entityType;
        let fkProps = type.foreignKeyProperties;
        fkProps.forEach(fkProp => {
            if (fkProp.parentType.name === keyMapping.entityTypeName &&
                entityMemo.pendingChanges[fkProp.name] === keyMapping.tempValue) {
                entityMemo.pendingChanges[fkProp.name] = keyMapping.realValue;
            }
        });
    }
    // update the entityMemo of changes to an entity being saved
    // so that we know how to save it again later
    update() {
        let entityMemo = this;
        let props;
        let entity = entityMemo.entity;
        let aspect = entity.entityAspect;
        let stateName = aspect.entityState.name;
        switch (stateName) {
            case 'Added':
                let originalValues = aspect.originalValues;
                props = entity.entityType.dataProperties;
                props.forEach(dp => {
                    if (dp.isPartOfKey) {
                        return;
                    }
                    let name = dp.name;
                    let value = entity.getProperty(name);
                    if (originalValues[name] !== value) {
                        entityMemo.pendingChanges[name] = value;
                    }
                });
                break;
            case 'Deleted':
                entityMemo.isDeleted = true;
                entityMemo.pendingChanges = {};
                break;
            case 'Modified':
                props = Object.keys(aspect.originalValues);
                props.forEach(name => {
                    entityMemo.pendingChanges[name] = entity.getProperty(name);
                });
                break;
        }
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibWl4aW4tc2F2ZS1xdWV1aW5nLmpzIiwic291cmNlUm9vdCI6Im5nOi8vYnJlZXplLWNsaWVudC9taXhpbi1zYXZlLXF1ZXVpbmcvIiwic291cmNlcyI6WyJtaXhpbi1zYXZlLXF1ZXVpbmcudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsNkNBQTZDO0FBQzdDOzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7OztHQTJERztBQUNILFlBQVk7QUFDWixPQUFPLEVBQXFDLFdBQVcsRUFBYyxNQUFNLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFHbkcsTUFBTSxVQUFVLGlCQUFpQixDQUFDLEVBQWlCLEVBQUUsU0FBa0IsSUFBSTtJQUN6RSxJQUFJLFdBQVcsR0FBRyxFQUFFLENBQUMsZUFBZSxDQUFDO1FBQ25DLENBQUMsRUFBRSxDQUFDLGNBQWMsQ0FBQyxHQUFHLElBQUksV0FBVyxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUM7SUFFN0MsTUFBTSxHQUFHLENBQUMsTUFBTSxLQUFLLFNBQVMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLE1BQU0sQ0FBQztJQUNoRCxXQUFXLENBQUMsVUFBVSxHQUFHLE1BQU0sQ0FBQztJQUNoQyxJQUFJLE1BQU0sRUFBRTtRQUNWLG1DQUFtQztRQUNuQyxFQUFFLENBQUMsV0FBVyxHQUFHLHNCQUFzQixDQUFDO0tBQ3pDO1NBQU07UUFDTCxpREFBaUQ7UUFDakQsRUFBRSxDQUFDLFdBQVcsR0FBRyxFQUFFLENBQUMsY0FBYyxDQUFDLENBQUMsZUFBZSxDQUFDO0tBQ3JEO0FBQ0gsQ0FBQztBQUVEOzs7SUFHSTtBQUNKLFNBQVMsc0JBQXNCLENBQUMsUUFBeUIsRUFBRSxXQUFnQjtJQUN6RSxJQUFJO1FBQ0YsNkJBQTZCO1FBQzdCLElBQUksV0FBVyxHQUFHLElBQUksQ0FBQyxZQUFZLENBQUM7UUFDcEMsSUFBSSxXQUFXLENBQUMsUUFBUSxFQUFF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QUFDLElBQUksQ0FBQztRQUN4QyxRQUFRLFNBQVMsRUFBRTtZQUNqQixLQUFLLE9BQU87Z0JBQ1YsSUFBSSxjQUFjLEdBQUcsTUFBTSxDQUFDLGNBQWMsQ0FBQztnQkFDM0MsS0FBSyxHQUFHLE1BQU0sQ0FBQyxVQUFVLENBQUMsY0FBYyxDQUFDO2dCQUN6QyxLQUFLLENBQUMsT0FBTyxDQUFDLEVBQUUsQ0FBQyxFQUFFO29CQUNqQixJQUFJLEVBQUUsQ0FBQyxXQUFXLEVBQUU7d0JBQUUsT0FBTztxQkFBRTtvQkFDL0IsSUFBSSxJQUFJLEdBQUcsRUFBRSxDQUFDLElBQUksQ0FBQztvQkFDbkIsSUFBSSxLQUFLLEdBQUcsTUFBTSxDQUFDLFdBQVcsQ0FBQyxJQUFJLENBQUMsQ0FBQztvQkFDckMsSUFBSSxjQUFjLENBQUMsSUFBSSxDQUFDLEtBQUssS0FBSyxFQUFFO3dCQUNsQyxVQUFVLENBQUMsY0FBYyxDQUFDLElBQUksQ0FBQyxHQUFHLEtBQUssQ0FBQztxQkFDekM7Z0JBQ0gsQ0FBQyxDQUFDLENBQUM7Z0JBQ0gsTUFBTTtZQUVSLEtBQUssU0FBUztnQkFDWixVQUFVLENBQUMsU0FBUyxHQUFHLElBQUksQ0FBQztnQkFDNUIsVUFBVSxDQUFDLGNBQWMsR0FBRyxFQUFFLENBQUM7Z0JBQy9CLE1BQU07WUFFUixLQUFLLFVBQVU7Z0JBQ2IsS0FBSyxHQUFHLE1BQU0sQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLGNBQWMsQ0FBQyxDQUFDO2dCQUMzQyxLQUFLLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxFQUFFO29CQUNuQixVQUFVLENBQUMsY0FBYyxDQUFDLElBQUksQ0FBQyxHQUFHLE1BQU0sQ0FBQyxXQUFXLENBQUMsSUFBSSxDQUFDLENBQUM7Z0JBQzdELENBQUMsQ0FBQyxDQUFDO2dCQUNILE1BQU07U0FDVDtJQUNILENBQUM7Q0FDRiIsInNvdXJjZXNDb250ZW50IjpbIi8vI3JlZ2lvbiBDb3B5cmlnaHQsIFZlcnNpb24sIGFuZCBEZXNjcmlwdGlvblxyXG4vKlxyXG4gKiBDb3B5cmlnaHQgMjAxNS0yMDE5IElkZWFCbGFkZSwgSW5jLiAgQWxsIFJpZ2h0cyBSZXNlcnZlZC5cclxuICogVXNlLCByZXByb2R1Y3Rpb24sIGRpc3RyaWJ1dGlvbiwgYW5kIG1vZGlmaWNhdGlvbiBvZiB0aGlzIGNvZGUgaXMgc3ViamVjdCB0byB0aGUgdGVybXMgYW5kXHJcbiAqIGNvbmRpdGlvbnMgb2YgdGhlIElkZWFCbGFkZSBCcmVlemUgbGljZW5zZSwgYXZhaWxhYmxlIGF0IGh0dHA6Ly93d3cuYnJlZXplanMuY29tL2xpY2Vuc2VcclxuICpcclxuICogQXV0aG9yOiBXYXJkIEJlbGxcclxuICogVmVyc2lvbjogMi4wLjYgU3RldmUgU2NobWl0dCAtIGNvbnZlcnQgdG8gVHlwZVNjcmlwdCwgbW92ZSB0byBicmVlemUtY2xpZW50IHJlcG8sIGNoYW5nZSBlbmFibGVTYXZlUXVldWluZyBmdW5jdGlvblxyXG4gKiBWZXJzaW9uOiAyLjAuNSBXYXJkIEJlbGxcclxuICogLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS1cclxuICogQWRkcyBcIlNhdmUgUXVldWluZ1wiIGNhcGFiaWxpdHkgdG8gbmV3IEVudGl0eU1hbmFnZXJzXHJcbiAqXHJcbiAqIFNhdmUgUXVldWluZyBhdXRvbWF0aWNhbGx5IHF1ZXVlcyBhbmQgZGVmZXJzIGFuIEVudGl0eU1hbmFnZXIuc2F2ZUNoYW5nZXMgY2FsbFxyXG4gKiB3aGVuIGFub3RoZXIgc2F2ZSBpcyBpbiBwcm9ncmVzcyBmb3IgdGhhdCBtYW5hZ2VyIGFuZCB0aGUgc2VydmVyIGhhcyBub3QgeWV0IHJlc3BvbmRlZC5cclxuICogVGhpcyBmZWF0dXJlIGlzIGhlbHBmdWwgd2hlbiB5b3VyIGFwcCBuZWVkcyB0byBhbGxvdyByYXBpZCwgY29udGludW91cyBjaGFuZ2VzXHJcbiAqIHRvIGVudGl0aWVzIHRoYXQgbWF5IGJlIGluIHRoZSBwcm9jZXNzIG9mIGJlaW5nIHNhdmVkLlxyXG4gKlxyXG4gKiBXaXRob3V0IFwiU2F2ZSBRdWV1aW5nXCIsIGFuIEVudGl0eU1hbmFnZXIgd2lsbCB0aHJvdyBhbiBleGNlcHRpb25cclxuICogd2hlbiB5b3UgY2FsbCBzYXZlQ2hhbmdlcyBmb3IgYW4gZW50aXR5IHdoaWNoIGlzIGN1cnJlbnRseSBiZWluZyBzYXZlZC5cclxuICpcclxuICogISEhIFVzZSB3aXRoIGNhdXRpb24gISEhXHJcbiAqIEl0IGlzIHVzdWFsbHkgYmV0dGVyIHRvIGRpc2FibGUgdXNlciBpbnB1dCB3aGlsZSBhIHNhdmUgaXMgaW4gcHJvZ3Jlc3MuXHJcbiAqIFNhdmUgUXVldWluZyBtYXkgYmUgYXBwcm9wcmlhdGUgZm9yIHNpbXBsZSBcImF1dG8tc2F2ZVwiIHNjZW5hcmlvc1xyXG4gKiB3aGVuIHRoZSBzYXZlIGxhdGVuY3kgaXMgXCJzaG9ydFwiICh1bmRlciBhIGZldyBzZWNvbmRzKS5cclxuICpcclxuICogU2F2ZSBRdWV1aW5nIGlzIE5PVCBpbnRlbmRlZCBmb3Igb2NjYXNzaW9uYWxseSBkaXNjb25uZWN0ZWQgb3Igb2ZmbGluZSBzY2VuYXJpb3MuXHJcbiAqXHJcbiAqIFNhdmUgUXVldWluZyBpcyBleHBlcmltZW50YWwuIEl0IHdpbGwgbm90IGJlY29tZSBhIHBhcnQgb2YgQnJlZXplSlMgY29yZVxyXG4gKiBidXQgbWlnaHQgYmVjb21lIGFuIG9mZmljaWFsIEJyZWV6ZSBwbHVnaW4gaW4gZnV0dXJlXHJcbiAqIGFsdGhvdWdoIG5vdCBuZWNlc3NhcmlseSBpbiB0aGlzIGZvcm0gb3Igd2l0aCB0aGlzIEFQSVxyXG4gKlxyXG4gKiBNdXN0IGNhbGwgRW50aXR5TWFuYWdlci5lbmFibGVTYXZlUXVldWluZyh0cnVlKSB0byB0dXJuIGl0IG9uO1xyXG4gKiBFbnRpdHlNYW5hZ2VyLmVuYWJsZVNhdmVRdWV1aW5nKGZhbHNlKSByZXN0b3JlcyB0aGUgbWFuYWdlcidzIG9yaWdpbmFsXHJcbiAqIHNhdmVDaGFuZ2VzIG1ldGhvZCBhcyBpdCB3YXMgYXQgdGhlIHRpbWUgc2F2ZVF1ZXVpbmcgd2FzIGZpcnN0IGVuYWJsZWQuXHJcbiAqXHJcbiAqIFRoaXMgbW9kdWxlIGFkZHMgXCJlbmFibGVTYXZlUXVldWluZ1wiIHRvIHRoZSBFbnRpdHlNYW5hZ2VyIHByb3RvdHlwZS5cclxuICogQ2FsbGluZyBcImVuYWJsZVNhdmVRdWV1aW5nKHRydWUpXCIgYWRkcyBhIG5ldyBfc2F2ZVF1ZXVpbmcgb2JqZWN0XHJcbiAqIHRvIHRoZSBtYW5hZ2VyIGluc3RhbmNlLlxyXG4gKlxyXG4gKiBTZWUgRG9jQ29kZTpzYXZlUXVldWluZ1Rlc3RzLmpzXHJcbiAqIGh0dHBzOi8vZ2l0aHViLmNvbS9CcmVlemUvYnJlZXplLmpzLnNhbXBsZXMvYmxvYi9tYXN0ZXIvbmV0L0RvY0NvZGUvRG9jQ29kZS90ZXN0cy9zYXZlUXVldWluZ1Rlc3RzLmpzXHJcbiAqXHJcbiAqIExJTUlUQVRJT05TXHJcbiAqIC0gQ2FuJ3QgaGFuZGxlIGNoYW5nZXMgdG8gdGhlIHByaW1hcnkga2V5IChkYW5nZXJvdXMgaW4gYW55IGNhc2UpXHJcbiAqIC0gQXNzdW1lcyBwcm9taXNlcy4gRG9lcyBub3Qgc3VwcG9ydCB0aGUgKGRlcHJlY2F0ZWQpIHN1Y2Nlc3MgYW5kIGZhaWwgY2FsbGJhY2tzXHJcbiAqIC0gRG9lcyBub3QgcXVldWUgc2F2ZU9wdGlvbnMuIFRoZSBmaXJzdCBvbmUgaXMgcmUtdXNlZCBmb3IgYWxsIHF1ZXVlZCBzYXZlcy5cclxuICogLSBEb2VzIG5vdCBkZWFsIHdpdGggZXhwb3J0L2ltcG9ydCBvZiBlbnRpdGllcyB3aGlsZSBzYXZlIGlzIGluZmxpZ2h0XHJcbiAqIC0gRG9lcyBub3QgZGVhbCB3aXRoIHJlamVjdENoYW5nZXMgd2hpbGUgc2F2ZSBpcyBpbiBmbGlnaHRcclxuICogLSBEb2VzIG5vdCBzdXBwb3J0IHBhcmFsbGVsIHNhdmVzIGV2ZW4gd2hlbiB0aGUgY2hhbmdlLXNldHMgYXJlIGluZGVwZW5kZW50LlxyXG4gKiAgIFRoZSBuYXRpdmUgc2F2ZUNoYW5nZXMgYWxsb3dzIHN1Y2ggc2F2ZXMuXHJcbiAqICAgU2F2ZVF1ZXVpbmcgZG9lcyBub3Q7IHRvbyBjb21wbGV4IGFuZCBkb2Vzbid0IGZpdCB0aGUgcHJpbWFyeSBzY2VuYXJpbyBhbnl3YXkuXHJcbiAqIC0gVGhlIHJlc29sdmVkIHNhdmVSZXN1bHQgaXMgdGhlIHNhdmVSZXN1bHQgb2YgdGhlIGxhc3QgY29tcGxldGVkIHNhdmVcclxuICogLSBBIHF1ZXVlZCBzYXZlIHRoYXQgbWlnaHQgaGF2ZSBzdWNjZWVkZWQgaWYgc2F2ZWQgaW1tZWRpYXRlbHlcclxuICogICBtYXkgZmFpbCBiZWNhdXNlIHRoZSBzZXJ2ZXIgbm8gbG9uZ2VyIGFjY2VwdHMgaXQgbGF0ZXJcclxuICogLSBQcmlvciB0byBCcmVlemUgdi4xLjUuMywgYSBxdWV1ZWQgc2F2ZSB0aGF0IG1pZ2h0IGhhdmUgc3VjY2VlZGVkXHJcbiAqICAgaWYgc2F2ZWQgaW1tZWRpYXRlbHkgd2lsbCBmYWlsIGlmIHN1YnNlcXVlbnRseSBhdHRlbXB0IHRvIHNhdmVcclxuICogICBhbiBpbnZhbGlkIGVudGl0eS4gQ2FuIGRldGVjdCBhbmQgY2lyY3VtdmVudCBhZnRlciB2LjEuNS4zLlxyXG4gKlxyXG4gKiBBbGwgbWVtYmVycyBvZiBFbnRpdHlNYW5hZ2VyLl9zYXZlUXVldWluZyBhcmUgaW50ZXJuYWw7XHJcbiAqIHRvdWNoIHRoZW0gYXQgeW91ciBvd24gcmlzay5cclxuICovXHJcbi8vI2VuZHJlZ2lvblxyXG5pbXBvcnQgeyBFbnRpdHksIEVudGl0eU1hbmFnZXIsIEtleU1hcHBpbmcsIEVudGl0eVN0YXRlLCBTYXZlUmVzdWx0LCBicmVlemUgfSBmcm9tICdicmVlemUtY2xpZW50JztcclxuXHJcblxyXG5leHBvcnQgZnVuY3Rpb24gZW5hYmxlU2F2ZVF1ZXVpbmcoZW06IEVudGl0eU1hbmFnZXIsIGVuYWJsZTogYm9vbGVhbiA9IHRydWUpIHtcclxuICBsZXQgc2F2ZVF1ZXVpbmcgPSBlbVsnX3NhdmVRdWV1ZWluZyddIHx8XHJcbiAgICAoZW1bJ19zYXZlUXVldWluZyddID0gbmV3IFNhdmVRdWV1aW5nKGVtKSk7XHJcblxyXG4gIGVuYWJsZSA9IChlbmFibGUgPT09IHVuZGVmaW5lZCkgPyB0cnVlIDogZW5hYmxlO1xyXG4gIHNhdmVRdWV1aW5nLl9pc0VuYWJsZWQgPSBlbmFibGU7XHJcbiAgaWYgKGVuYWJsZSkge1xyXG4gICAgLy8gZGVsZWdhdGUgdG8gc2F2ZSBjaGFuZ2VzIHF1ZXVpbmdcclxuICAgIGVtLnNhdmVDaGFuZ2VzID0gc2F2ZUNoYW5nZXNXaXRoUXVldWluZztcclxuICB9IGVsc2Uge1xyXG4gICAgLy8gcmV2ZXJ0IHRvIHRoZSBuYXRpdmUgRW50aXR5TWFuYWdlci5zYXZlQ2hhbmdlc1xyXG4gICAgZW0uc2F2ZUNoYW5nZXMgPSBlbVsnX3NhdmVRdWV1aW5nJ10uYmFzZVNhdmVDaGFuZ2VzO1xyXG4gIH1cclxufVxyXG5cclxuLyoqXHJcbiAqIFJlcGxhY2VtZW50IGZvciBFbnRpdHlNYW5hZ2VyLnNhdmVDaGFuZ2VzXHJcbiAqIFRoaXMgdmVyc2lvbiBxdWV1ZXMgc2F2ZUNoYW5nZXMgY2FsbHMgd2hpbGUgYSByZWFsIHNhdmUgaXMgaW4gcHJvZ3Jlc3NcclxuICoqL1xyXG5mdW5jdGlvbiBzYXZlQ2hhbmdlc1dpdGhRdWV1aW5nKGVudGl0aWVzOiBFbnRpdHlbXSB8IG51bGwsIHNhdmVPcHRpb25zOiBhbnkpIHtcclxuICB0cnkge1xyXG4gICAgLy8gYHRoaXNgIGlzIGFuIEVudGl0eU1hbmFnZXJcclxuICAgIGxldCBzYXZlUXVldWluZyA9IHRoaXMuX3NhdmVRdWV1aW5nO1xyXG4gICAgaWYgKHNhdmVRdWV1aW5nLmlzU2F2aW5nKSB7XHJcbiAgICAgIC8vIHNhdmUgaW4gcHJvZ3Jlc3M7IHF1ZXVlIHRoZSBzYXZlIGZvciBsYXRlclxyXG4gICAgICByZXR1cm4gc2F2ZVF1ZXVpbmcucXVldWVTYXZlQ2hhbmdlcyhlbnRpdGllcyk7XHJcbiAgICB9IGVsc2Uge1xyXG4gICAgICAvLyBub3RlIHRoYXQgc2F2ZSBpcyBpbiBwcm9ncmVzczsgdGhlbiBzYXZlXHJcbiAgICAgIHNhdmVRdWV1aW5nLmlzU2F2aW5nID0gdHJ1ZTtcclxuICAgICAgc2F2ZVF1ZXVpbmcuc2F2ZU9wdGlvbnMgPSBzYXZlT3B0aW9ucztcclxuICAgICAgcmV0dXJuIHNhdmVRdWV1aW5nLnNhdmVDaGFuZ2VzKGVudGl0aWVzLCBzYXZlT3B0aW9ucyk7XHJcbiAgICB9XHJcbiAgfSBjYXRjaCAoZXJyKSB7XHJcbiAgICByZXR1cm4gUHJvbWlzZS5yZWplY3QoZXJyKTtcclxuICB9XHJcbn1cclxuXHJcbi8vLy8vLy8vLyBTYXZlUXVldWluZyAvLy8vLy8vLy9cclxuY2xhc3MgU2F2ZVF1ZXVpbmcge1xyXG4gIGVudGl0eU1hbmFnZXI6IEVudGl0eU1hbmFnZXI7XHJcbiAgYmFzZVNhdmVDaGFuZ2VzOiAoKSA9PiBQcm9taXNlPGFueT47XHJcbiAgaXNTYXZpbmc6IGJvb2xlYW47XHJcbiAgX2lzRW5hYmxlZDogYm9vbGVhbjtcclxuICBhY3RpdmVTYXZlRGVmZXJyZWQ6IERlZmVycmVkPFNhdmVSZXN1bHQ+O1xyXG4gIG5leHRTYXZlRGVmZXJyZWQ6IERlZmVycmVkPFNhdmVSZXN1bHQ+O1xyXG4gIGFjdGl2ZVNhdmVNZW1vOiBTYXZlTWVtbztcclxuICBuZXh0U2F2ZU1lbW86IFNhdmVNZW1vO1xyXG4gIHNhdmVPcHRpb25zOiBhbnk7XHJcblxyXG4gIGNvbnN0cnVjdG9yKGVudGl0eU1hbmFnZXI6IEVudGl0eU1hbmFnZXIpIHtcclxuICAgIHRoaXMuZW50aXR5TWFuYWdlciA9IGVudGl0eU1hbmFnZXI7XHJcbiAgICB0aGlzLmJhc2VTYXZlQ2hhbmdlcyA9IGVudGl0eU1hbmFnZXIuc2F2ZUNoYW5nZXM7XHJcbiAgICB0aGlzLmlzU2F2aW5nID0gZmFsc2U7XHJcbiAgfVxyXG5cclxuICBpc0VuYWJsZWQoKSB7XHJcbiAgICByZXR1cm4gdGhpcy5faXNFbmFibGVkO1xyXG4gIH1cclxuXHJcbiAgZ2V0U2F2ZWROb3RoaW5nUmVzdWx0KCk6IFNhdmVSZXN1bHQge1xyXG4gICAgcmV0dXJuIHsgZW50aXRpZXM6IFtdIGFzIEVudGl0eVtdLCBrZXlNYXBwaW5nczogW10gYXMgS2V5TWFwcGluZ1tdIH07XHJcbiAgfVxyXG5cclxuICBxdWV1ZVNhdmVDaGFuZ2VzKGVudGl0aWVzOiBFbnRpdHlbXSkge1xyXG4gICAgbGV0IHNlbGYgPSB0aGlzOyAvLyBgdGhpc2AgaXMgYSBTYXZlUXVldWluZ1xyXG4gICAgbGV0IGVtID0gc2VsZi5lbnRpdHlNYW5hZ2VyO1xyXG5cclxuICAgIGxldCBjaGFuZ2VzID0gZW50aXRpZXMgfHwgZW0uZ2V0Q2hhbmdlcygpO1xyXG4gICAgaWYgKGNoYW5nZXMubGVuZ3RoID09PSAwKSB7XHJcbiAgICAgIHJldHVybiBQcm9taXNlLnJlc29sdmUodGhpcy5nZXRTYXZlZE5vdGhpbmdSZXN1bHQoKSk7XHJcbiAgICB9XHJcblxyXG4gICAgbGV0IHZhbEVycm9yID0gZW0uc2F2ZUNoYW5nZXNWYWxpZGF0ZU9uQ2xpZW50KGNoYW5nZXMpO1xyXG4gICAgaWYgKHZhbEVycm9yKSB7XHJcbiAgICAgIHJldHVybiBQcm9taXNlLnJlamVjdCh2YWxFcnJvcik7XHJcbiAgICB9XHJcblxyXG4gICAgbGV0IHNhdmVNZW1vID0gc2VsZi5uZXh0U2F2ZU1lbW8gfHwgKHNlbGYubmV4dFNhdmVNZW1vID0gbmV3IFNhdmVNZW1vKCkpO1xyXG4gICAgbWVtb2l6ZUNoYW5nZXMoKTtcclxuICAgIGxldCBkZWZlcnJlZCA9IHNlbGYubmV4dFNhdmVEZWZlcnJlZCB8fCAoc2VsZi5uZXh0U2F2ZURlZmVycmVkID0gbmV3IERlZmVycmVkPFNhdmVSZXN1bHQ+KCkpO1xyXG4gICAgcmV0dXJuIGRlZmVycmVkLnByb21pc2U7XHJcblxyXG4gICAgZnVuY3Rpb24gbWVtb2l6ZUNoYW5nZXMoKSB7XHJcbiAgICAgIGlmIChjaGFuZ2VzLmxlbmd0aCA9PT0gMCkgeyByZXR1cm47IH1cclxuICAgICAgbGV0IHF1ZXVlZENoYW5nZXMgPSBzYXZlTWVtby5xdWV1ZWRDaGFuZ2VzO1xyXG4gICAgICBjaGFuZ2VzLmZvckVhY2goZSA9PiB7XHJcbiAgICAgICAgaWYgKCFlLmVudGl0eUFzcGVjdC5pc0JlaW5nU2F2ZWQgJiYgcXVldWVkQ2hhbmdlcy5pbmRleE9mKGUpID09PSAtMSkge1xyXG4gICAgICAgICAgcXVldWVkQ2hhbmdlcy5wdXNoKGUpO1xyXG4gICAgICAgIH1cclxuICAgICAgfSk7XHJcblxyXG4gICAgICBzYXZlTWVtby51cGRhdGVFbnRpdHlNZW1vcyhjaGFuZ2VzKTtcclxuICAgIH1cclxuICB9XHJcblxyXG4gIHNhdmVDaGFuZ2VzKGVudGl0aWVzOiBFbnRpdHlbXSwgc2F2ZU9wdGlvbnM6IGFueSkge1xyXG4gICAgbGV0IHNlbGYgPSB0aGlzOyAvLyBgdGhpc2AgaXMgYSBTYXZlUXVldWluZ1xyXG4gICAgbGV0IHByb21pc2UgPSBzZWxmLmJhc2VTYXZlQ2hhbmdlcy5jYWxsKHNlbGYuZW50aXR5TWFuYWdlciwgZW50aXRpZXMsIHNhdmVPcHRpb25zIHx8IHNlbGYuc2F2ZU9wdGlvbnMpXHJcbiAgICAgIC50aGVuKGZ1bmN0aW9uIChzYXZlUmVzdWx0OiBTYXZlUmVzdWx0KSB7IHJldHVybiBzZWxmLnNhdmVTdWNjZWVkZWQoc2F2ZVJlc3VsdCk7IH0pXHJcbiAgICAgIC50aGVuKG51bGwsIGZ1bmN0aW9uIChlcnJvcjogRXJyb3IpIHsgY29uc29sZS5sb2coZXJyb3IpOyByZXR1cm4gc2VsZi5zYXZlRmFpbGVkKGVycm9yKTsgfSk7XHJcbiAgICByZW1lbWJlckFkZGVkT3JpZ2luYWxWYWx1ZXMoZW50aXRpZXMpOyAvLyBkbyBpdCBhZnRlciAuLi4gc28gZG9uJ3Qgc2VuZCBPcmlnVmFsdWVzIHRvIHRoZSBzZXJ2ZXJcclxuICAgIHJldHVybiBwcm9taXNlO1xyXG5cclxuICAgIGZ1bmN0aW9uIHJlbWVtYmVyQWRkZWRPcmlnaW5hbFZhbHVlcyhlbnRpdGllczogRW50aXR5W10pIHtcclxuICAgICAgLy8gYWRkZWQgZW50aXRpZXMgbm9ybWFsbHkgZG9uJ3QgaGF2ZSBvcmlnaW5hbCB2YWx1ZXMgYnV0IHRoZXNlIHdpbGwgbm93XHJcbiAgICAgIGxldCBhZGRlZCA9IGVudGl0aWVzID9cclxuICAgICAgICBlbnRpdGllcy5maWx0ZXIoZnVuY3Rpb24gKGUpIHsgcmV0dXJuIGUuZW50aXR5QXNwZWN0LmVudGl0eVN0YXRlLmlzQWRkZWQoKTsgfSkgOlxyXG4gICAgICAgIHNlbGYuZW50aXR5TWFuYWdlci5nZXRFbnRpdGllcyhudWxsLCBFbnRpdHlTdGF0ZS5BZGRlZCk7XHJcbiAgICAgIGFkZGVkLmZvckVhY2goZW50aXR5ID0+IHtcclxuICAgICAgICBsZXQgcHJvcHMgPSBlbnRpdHkuZW50aXR5VHlwZS5kYXRhUHJvcGVydGllcztcclxuICAgICAgICBsZXQgb3JpZ2luYWxWYWx1ZXMgPSBlbnRpdHkuZW50aXR5QXNwZWN0Lm9yaWdpbmFsVmFsdWVzO1xyXG4gICAgICAgIHByb3BzLmZvckVhY2goZHAgPT4ge1xyXG4gICAgICAgICAgaWYgKGRwLmlzUGFydE9mS2V5KSB7IHJldHVybjsgfVxyXG4gICAgICAgICAgb3JpZ2luYWxWYWx1ZXNbZHAubmFtZV0gPSBlbnRpdHkuZ2V0UHJvcGVydHkoZHAubmFtZSk7XHJcbiAgICAgICAgfSk7XHJcbiAgICAgIH0pO1xyXG4gICAgfVxyXG4gIH1cclxuXHJcblxyXG4gIHNhdmVTdWNjZWVkZWQoc2F2ZVJlc3VsdDogU2F2ZVJlc3VsdCkge1xyXG4gICAgbGV0IHNlbGYgPSB0aGlzOyAvLyBgdGhpc2AgaXMgYSBTYXZlUXVldWVpbmdcclxuICAgIGxldCBhY3RpdmVTYXZlRGVmZXJyZWQgPSBzZWxmLmFjdGl2ZVNhdmVEZWZlcnJlZDtcclxuICAgIGxldCBuZXh0U2F2ZURlZmVycmVkID0gc2VsZi5uZXh0U2F2ZURlZmVycmVkO1xyXG4gICAgbGV0IG5leHRTYXZlTWVtbyA9IHNlbGYubmV4dFNhdmVNZW1vO1xyXG5cclxuXHJcbiAgICAvLyBwcmVwYXJlIGFzIGlmIG5vdGhpbmcgcXVldWVkIG9yIGxlZnQgdG8gc2F2ZVxyXG4gICAgc2VsZi5pc1NhdmluZyA9IGZhbHNlO1xyXG4gICAgc2VsZi5hY3RpdmVTYXZlRGVmZXJyZWQgPSBudWxsO1xyXG4gICAgc2VsZi5hY3RpdmVTYXZlTWVtbyA9IG51bGw7XHJcbiAgICBzZWxmLm5leHRTYXZlRGVmZXJyZWQgPSBudWxsO1xyXG4gICAgc2VsZi5uZXh0U2F2ZU1lbW8gPSBudWxsO1xyXG5cclxuICAgIGlmIChuZXh0U2F2ZU1lbW8pIHtcclxuICAgICAgLy8gYSBzYXZlIHdhcyBxdWV1ZWQgc2luY2UgbGFzdCBzYXZlIHJldHVybmVkXHJcbiAgICAgIG5leHRTYXZlTWVtby5wa0ZpeHVwKHNhdmVSZXN1bHQua2V5TWFwcGluZ3MpO1xyXG4gICAgICBuZXh0U2F2ZU1lbW8uYXBwbHlUb1NhdmVkRW50aXRpZXMoc2VsZi5lbnRpdHlNYW5hZ2VyLCBzYXZlUmVzdWx0LmVudGl0aWVzKTtcclxuICAgICAgLy8gcmVtb3ZlIGRldGFjaGVkIGVudGl0aWVzIGZyb20gcXVldWVkQ2hhbmdlc1xyXG4gICAgICBsZXQgcXVldWVkQ2hhbmdlcyA9IG5leHRTYXZlTWVtby5xdWV1ZWRDaGFuZ2VzLmZpbHRlcihlID0+IHtcclxuICAgICAgICByZXR1cm4gIWUuZW50aXR5QXNwZWN0LmVudGl0eVN0YXRlLmlzRGV0YWNoZWQoKTtcclxuICAgICAgfSk7XHJcblxyXG4gICAgICBpZiAocXVldWVkQ2hhbmdlcy5sZW5ndGggPiAwKSB7XHJcbiAgICAgICAgLy8gc2F2ZSBhZ2FpblxyXG4gICAgICAgIHNlbGYuaXNTYXZpbmcgPSB0cnVlO1xyXG4gICAgICAgIC8vIHJlbWVtYmVyIHRoZSBxdWV1ZWQgY2hhbmdlcyB0aGF0IHRyaWdnZXJlZCB0aGlzIHNhdmVcclxuICAgICAgICBzZWxmLmFjdGl2ZVNhdmVEZWZlcnJlZCA9IG5leHRTYXZlRGVmZXJyZWQ7XHJcbiAgICAgICAgc2VsZi5hY3RpdmVTYXZlTWVtbyA9IG5leHRTYXZlTWVtbztcclxuICAgICAgICBzZWxmLnNhdmVDaGFuZ2VzKHF1ZXVlZENoYW5nZXMsIHRoaXMuc2F2ZU9wdGlvbnMpO1xyXG4gICAgICB9IGVsc2UgaWYgKG5leHRTYXZlRGVmZXJyZWQpIHtcclxuICAgICAgICBuZXh0U2F2ZURlZmVycmVkLnJlc29sdmUodGhpcy5nZXRTYXZlZE5vdGhpbmdSZXN1bHQoKSk7XHJcbiAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICBpZiAoYWN0aXZlU2F2ZURlZmVycmVkKSB7IGFjdGl2ZVNhdmVEZWZlcnJlZC5yZXNvbHZlKHNhdmVSZXN1bHQpOyB9XHJcbiAgICByZXR1cm4gc2F2ZVJlc3VsdDsgIC8vIGZvciB0aGUgY3VycmVudCBwcm9taXNlIGNoYWluXHJcbiAgfVxyXG5cclxuICBzYXZlRmFpbGVkKGVycm9yOiBFcnJvcikge1xyXG4gICAgbGV0IHNlbGYgPSB0aGlzOyAvLyBgdGhpc2AgaXMgYSBTYXZlUXVldWVpbmdcclxuICAgIGVycm9yID0gbmV3IFF1ZXVlZFNhdmVGYWlsZWRFcnJvcihlcnJvciwgc2VsZik7XHJcblxyXG4gICAgbGV0IGFjdGl2ZVNhdmVEZWZlcnJlZCA9IHNlbGYuYWN0aXZlU2F2ZURlZmVycmVkO1xyXG4gICAgbGV0IG5leHRTYXZlRGVmZXJyZWQgPSBzZWxmLm5leHRTYXZlRGVmZXJyZWQ7XHJcblxyXG4gICAgc2VsZi5pc1NhdmluZyA9IGZhbHNlO1xyXG4gICAgc2VsZi5hY3RpdmVTYXZlRGVmZXJyZWQgPSBudWxsO1xyXG4gICAgc2VsZi5hY3RpdmVTYXZlTWVtbyA9IG51bGw7XHJcbiAgICBzZWxmLm5leHRTYXZlRGVmZXJyZWQgPSBudWxsO1xyXG4gICAgc2VsZi5uZXh0U2F2ZU1lbW8gPSBudWxsO1xyXG5cclxuICAgIGlmIChhY3RpdmVTYXZlRGVmZXJyZWQpIHsgYWN0aXZlU2F2ZURlZmVycmVkLnJlamVjdChlcnJvcik7IH1cclxuICAgIGlmIChuZXh0U2F2ZURlZmVycmVkKSB7IG5leHRTYXZlRGVmZXJyZWQucmVqZWN0KGVycm9yKTsgfVxyXG5cclxuICAgIHJldHVybiBQcm9taXNlLnJlamVjdChlcnJvcik7IC8vIGxldCBwcm9taXNlIGNoYWluIGhlYXIgZXJyb3JcclxuICB9XHJcbn1cclxuXHJcbi8vLyBmb3IgYmFja3dhcmQgY29tcGF0IHdpdGggb2xkZXIgUHJvbWlzZSBpbXBsZW1lbnRhdGlvblxyXG5jbGFzcyBEZWZlcnJlZDxUPiB7XHJcbiAgcmVzb2x2ZTogKHZhbDogYW55KSA9PiB2b2lkO1xyXG4gIHJlamVjdDogKGVycjogYW55KSA9PiB2b2lkO1xyXG4gIHByb21pc2U6IFByb21pc2U8VD47XHJcbiAgY29uc3RydWN0b3IoKSB7XHJcbiAgICB0aGlzLnByb21pc2UgPSBuZXcgUHJvbWlzZTxUPihmdW5jdGlvbiAocmVzb2x2ZTogKHZhbDogYW55KSA9PiB2b2lkLCByZWplY3Q6IChlcnI6IGFueSkgPT4gdm9pZCkge1xyXG4gICAgICB0aGlzLnJlc29sdmUgPSByZXNvbHZlO1xyXG4gICAgICB0aGlzLnJlamVjdCA9IHJlamVjdDtcclxuICAgIH0uYmluZCh0aGlzKSk7XHJcbiAgfVxyXG59XHJcblxyXG5cclxuLy8vLy8vLy8vLyBRdWV1ZWRTYXZlRmFpbGVkRXJyb3IgLy8vLy8vLy8vXHJcbi8vIEVycm9yIHN1Yi1jbGFzcyB0aHJvd24gd2hlbiByZWplY3RpbmcgcXVldWVkIHNhdmVzLlxyXG5jbGFzcyBRdWV1ZWRTYXZlRmFpbGVkRXJyb3IgZXh0ZW5kcyBFcnJvciB7XHJcbiAgbmFtZSA9IFwiUXVldWVkU2F2ZUZhaWxlZEVycm9yXCI7XHJcbiAgaW5uZXJFcnJvcjogRXJyb3I7XHJcbiAgbWVzc2FnZTogc3RyaW5nO1xyXG4gIGZhaWxlZFNhdmVNZW1vOiBTYXZlTWVtbztcclxuICBuZXh0U2F2ZU1lbW86IFNhdmVNZW1vO1xyXG5cclxuICAvLyBFcnJvciBzdWItY2xhc3MgdGhyb3duIHdoZW4gcmVqZWN0aW5nIHF1ZXVlZCBzYXZlcy5cclxuICAvLyBgaW5uZXJFcnJvcmAgaXMgdGhlIGFjdHVhbCBzYXZlIGVycm9yXHJcbiAgLy8gYGZhaWxlZFNhdmVNZW1vYCBpcyB0aGUgc2F2ZU1lbW8gdGhhdCBwcm9tcHRlZCB0aGlzIHNhdmVcclxuICAvLyBgbmV4dFNhdmVNZW1vYCBob2xkcyBxdWV1ZWQgY2hhbmdlcyBhY2N1bXVsYXRlZCBzaW5jZSB0aGF0IHNhdmUuXHJcbiAgLy8gWW91IG1heSB0cnkgdG8gcmVjb3ZlciB1c2luZyB0aGlzIGluZm8uIEdvb2QgbHVjayB3aXRoIHRoYXQuXHJcbiAgY29uc3RydWN0b3IoZXJyT2JqZWN0OiBFcnJvciwgc2F2ZVF1ZXVpbmc6IGFueSkge1xyXG4gICAgc3VwZXIoKTtcclxuICAgIHRoaXMuaW5uZXJFcnJvciA9IGVyck9iamVjdDtcclxuICAgIHRoaXMubWVzc2FnZSA9IFwiUXVldWVkIHNhdmUgZmFpbGVkOiBcIiArIGVyck9iamVjdC5tZXNzYWdlO1xyXG4gICAgdGhpcy5mYWlsZWRTYXZlTWVtbyA9IHNhdmVRdWV1aW5nLmFjdGl2ZVNhdmVNZW1vO1xyXG4gICAgdGhpcy5uZXh0U2F2ZU1lbW8gPSBzYXZlUXVldWluZy5uZXh0U2F2ZU1lbW87XHJcbiAgfVxyXG59XHJcblxyXG4vLy8vLy8vLy8vIFNhdmVNZW1vIC8vLy8vLy8vLy8vLy8vLy9cclxuLy8gU2F2ZU1lbW8gaXMgYSByZWNvcmQgb2YgY2hhbmdlcyBmb3IgYSBxdWV1ZWQgc2F2ZSwgY29uc2lzdGluZyBvZjpcclxuLy8gICBlbnRpdHlNZW1vczogICBpbmZvIGFib3V0IGVudGl0aWVzIHRoYXQgYXJlIGJlaW5nIHNhdmVkIGFuZFxyXG4vLyAgICAgICAgICAgICAgICAgIGhhdmUgYmVlbiBjaGFuZ2VkIHNpbmNlIHRoZSBzYXZlIHN0YXJ0ZWRcclxuLy8gICBxdWV1ZWRDaGFuZ2VzOiBlbnRpdGllcyB0aGF0IGFyZSBxdWV1ZWQgZm9yIHNhdmUgYnV0XHJcbi8vICAgICAgICAgICAgICAgICAgYXJlIG5vdCBjdXJyZW50bHkgYmVpbmcgc2F2ZWRcclxuY2xhc3MgU2F2ZU1lbW8ge1xyXG4gIGVudGl0eU1lbW9zOiBhbnk7XHJcbiAgcXVldWVkQ2hhbmdlczogYW55W107XHJcbiAgY29uc3RydWN0b3IoKSB7XHJcbiAgICB0aGlzLmVudGl0eU1lbW9zID0ge307XHJcbiAgICB0aGlzLnF1ZXVlZENoYW5nZXMgPSBbXTtcclxuICB9XHJcblxyXG4gIGFwcGx5VG9TYXZlZEVudGl0aWVzKGVudGl0eU1hbmFnZXI6IEVudGl0eU1hbmFnZXIsIHNhdmVkRW50aXRpZXM6IEVudGl0eVtdKSB7XHJcbiAgICBsZXQgZW50aXR5TWVtb3MgPSB0aGlzLmVudGl0eU1lbW9zOyAvLyBgdGhpc2AgaXMgYSBTYXZlTWVtb1xyXG4gICAgbGV0IHF1ZXVlZENoYW5nZXMgPSB0aGlzLnF1ZXVlZENoYW5nZXM7XHJcbiAgICBsZXQgcmVzdG9yZVB1Ymxpc2hpbmcgPSB0aGlzLmRpc2FibGVNYW5hZ2VyUHVibGlzaGluZyhlbnRpdHlNYW5hZ2VyKTtcclxuICAgIHRyeSB7XHJcbiAgICAgIHNhdmVkRW50aXRpZXMuZm9yRWFjaChzYXZlZCA9PiB7XHJcbiAgICAgICAgbGV0IGtleSA9IHRoaXMubWFrZUVudGl0eU1lbW9LZXkoc2F2ZWQpO1xyXG4gICAgICAgIGxldCBlbnRpdHlNZW1vID0gZW50aXR5TWVtb3Nba2V5XTtcclxuICAgICAgICBsZXQgcmVzYXZlID0gZW50aXR5TWVtbyAmJiBlbnRpdHlNZW1vLmFwcGx5VG9TYXZlZEVudGl0eShzYXZlZCk7XHJcbiAgICAgICAgaWYgKHJlc2F2ZSkge1xyXG4gICAgICAgICAgcXVldWVkQ2hhbmdlcy5wdXNoKHNhdmVkKTtcclxuICAgICAgICB9XHJcbiAgICAgIH0pO1xyXG4gICAgfSBmaW5hbGx5IHtcclxuICAgICAgcmVzdG9yZVB1Ymxpc2hpbmcoKTtcclxuICAgICAgLy8gRCMyNjUxIGhhc0NoYW5nZXMgd2lsbCBiZSB3cm9uZyBpZiBjaGFuZ2VzIG1hZGUgd2hpbGUgc2F2ZSBpbiBwcm9ncmVzc1xyXG4gICAgICBsZXQgaGFzQ2hhbmdlcyA9IHF1ZXVlZENoYW5nZXMubGVuZ3RoID4gMDtcclxuICAgICAgLy8gTXVzdCB1c2UgYnJlZXplIGludGVybmFsIG1ldGhvZCB0byBwcm9wZXJseSBzZXQgdGhpcyBmbGFnIHRydWVcclxuICAgICAgaWYgKGhhc0NoYW5nZXMpIHsgZW50aXR5TWFuYWdlci5fc2V0SGFzQ2hhbmdlcyh0cnVlKTsgfVxyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgcHJpdmF0ZSBkaXNhYmxlTWFuYWdlclB1Ymxpc2hpbmcobWFuYWdlcjogRW50aXR5TWFuYWdlcikge1xyXG4gICAgbGV0IEV2ZW50ID0gYnJlZXplLkV2ZW50O1xyXG4gICAgRXZlbnQuZW5hYmxlKCdlbnRpdHlDaGFuZ2VkJywgbWFuYWdlciwgZmFsc2UpO1xyXG4gICAgRXZlbnQuZW5hYmxlKCdoYXNDaGFuZ2VzQ2hhbmdlZCcsIG1hbmFnZXIsIGZhbHNlKTtcclxuXHJcbiAgICByZXR1cm4gZnVuY3Rpb24gcmVzdG9yZVB1Ymxpc2hpbmcoKSB7XHJcbiAgICAgIEV2ZW50LmVuYWJsZSgnZW50aXR5Q2hhbmdlZCcsIG1hbmFnZXIsIHRydWUpO1xyXG4gICAgICBFdmVudC5lbmFibGUoJ2hhc0NoYW5nZXNDaGFuZ2VkJywgbWFuYWdlciwgdHJ1ZSk7XHJcbiAgICB9O1xyXG4gIH1cclxuXHJcbiAgcGtGaXh1cChrZXlNYXBwaW5nczogS2V5TWFwcGluZ1tdKSB7XHJcbiAgICBsZXQgZW50aXR5TWVtb3MgPSB0aGlzLmVudGl0eU1lbW9zOyAgLy8gYHRoaXNgIGlzIGEgU2F2ZU1lbW9cclxuICAgIGtleU1hcHBpbmdzLmZvckVhY2goa20gPT4ge1xyXG4gICAgICBsZXQgdHlwZSA9IGttLmVudGl0eVR5cGVOYW1lO1xyXG4gICAgICBsZXQgdGVtcEtleSA9IHR5cGUgKyAnfCcgKyBrbS50ZW1wVmFsdWU7XHJcbiAgICAgIGlmIChlbnRpdHlNZW1vc1t0ZW1wS2V5XSkge1xyXG4gICAgICAgIGVudGl0eU1lbW9zW3R5cGUgKyAnfCcgKyBrbS5yZWFsVmFsdWVdID0gZW50aXR5TWVtb3NbdGVtcEtleV07XHJcbiAgICAgICAgZGVsZXRlIGVudGl0eU1lbW9zW3RlbXBLZXldO1xyXG4gICAgICB9XHJcbiAgICAgIGZvciAobGV0IG1lbW9LZXkgaW4gZW50aXR5TWVtb3MpIHtcclxuICAgICAgICBlbnRpdHlNZW1vc1ttZW1vS2V5XS5ma0ZpeHVwKGttKTtcclxuICAgICAgfVxyXG4gICAgfSk7XHJcbiAgfVxyXG5cclxuICBtYWtlRW50aXR5TWVtb0tleShlbnRpdHk6IEVudGl0eSkge1xyXG4gICAgbGV0IGVudGl0eUtleSA9IGVudGl0eS5lbnRpdHlBc3BlY3QuZ2V0S2V5KCk7XHJcbiAgICByZXR1cm4gZW50aXR5S2V5LmVudGl0eVR5cGUubmFtZSArICd8JyArIGVudGl0eUtleS52YWx1ZXM7XHJcbiAgfVxyXG5cclxuICB1cGRhdGVFbnRpdHlNZW1vcyhjaGFuZ2VzOiBFbnRpdHlbXSkge1xyXG4gICAgbGV0IGVudGl0eU1lbW9zID0gdGhpcy5lbnRpdHlNZW1vczsgIC8vIGB0aGlzYCBpcyBhIFNhdmVNZW1vXHJcbiAgICBjaGFuZ2VzLmZvckVhY2goY2hhbmdlID0+IHtcclxuICAgICAgLy8gb25seSB1cGRhdGUgZW50aXR5TWVtbyBmb3IgZW50aXR5IGJlaW5nIHNhdmVcclxuICAgICAgaWYgKCFjaGFuZ2UuZW50aXR5QXNwZWN0LmlzQmVpbmdTYXZlZCkgeyByZXR1cm47IH1cclxuXHJcbiAgICAgIGxldCBrZXkgPSB0aGlzLm1ha2VFbnRpdHlNZW1vS2V5KGNoYW5nZSk7XHJcbiAgICAgIGxldCBlbnRpdHlNZW1vID0gZW50aXR5TWVtb3Nba2V5XSB8fCAoZW50aXR5TWVtb3Nba2V5XSA9IG5ldyBFbnRpdHlNZW1vKGNoYW5nZSkpO1xyXG4gICAgICBlbnRpdHlNZW1vLnVwZGF0ZShjaGFuZ2UpO1xyXG4gICAgfSk7XHJcbiAgfVxyXG5cclxufVxyXG5cclxuXHJcblxyXG4vLy8vLy8vLy8gRW50aXR5TWVtbyBUeXBlIC8vLy8vLy8vLy8vLy8vL1xyXG4vLyBJbmZvcm1hdGlvbiBhYm91dCBhbiBlbnRpdHkgdGhhdCBpcyBiZWluZyBzYXZlZFxyXG4vLyBhbmQgd2hpY2ggaGFzIGJlZW4gY2hhbmdlZCBzaW5jZSB0aGF0IHNhdmUgc3RhcnRlZFxyXG5jbGFzcyBFbnRpdHlNZW1vIHtcclxuICBlbnRpdHk6IEVudGl0eTtcclxuICBwZW5kaW5nQ2hhbmdlczogYW55O1xyXG4gIGlzRGVsZXRlZDogYm9vbGVhbjtcclxuICBjb25zdHJ1Y3RvcihlbnRpdHk6IEVudGl0eSkge1xyXG4gICAgdGhpcy5lbnRpdHkgPSBlbnRpdHk7XHJcbiAgICB0aGlzLnBlbmRpbmdDaGFuZ2VzID0ge307XHJcbiAgfVxyXG5cclxuXHJcbiAgYXBwbHlUb1NhdmVkRW50aXR5KHNhdmVkOiBFbnRpdHkpIHtcclxuICAgIGxldCBlbnRpdHlNZW1vID0gdGhpcztcclxuICAgIGxldCBhc3BlY3QgPSBzYXZlZC5lbnRpdHlBc3BlY3Q7XHJcbiAgICBpZiAoYXNwZWN0LmVudGl0eVN0YXRlLmlzRGV0YWNoZWQoKSkge1xyXG4gICAgICByZXR1cm4gZmFsc2U7XHJcbiAgICB9IGVsc2UgaWYgKGVudGl0eU1lbW8uaXNEZWxldGVkKSB7XHJcbiAgICAgIGFzcGVjdC5zZXREZWxldGVkKCk7XHJcbiAgICAgIHJldHVybiB0cnVlO1xyXG4gICAgfVxyXG4gICAgLy8gdHJlYXQgZW50aXR5IHdpdGggcGVuZGluZyBjaGFuZ2VzIGFzIG1vZGlmaWVkXHJcbiAgICBsZXQgcHJvcHMgPSBPYmplY3Qua2V5cyhlbnRpdHlNZW1vLnBlbmRpbmdDaGFuZ2VzKTtcclxuICAgIGlmIChwcm9wcy5sZW5ndGggPT09IDApIHtcclxuICAgICAgcmV0dXJuIGZhbHNlO1xyXG4gICAgfVxyXG4gICAgbGV0IG9yaWdpbmFsVmFsdWVzID0gYXNwZWN0Lm9yaWdpbmFsVmFsdWVzO1xyXG4gICAgcHJvcHMuZm9yRWFjaChuYW1lID0+IHtcclxuICAgICAgb3JpZ2luYWxWYWx1ZXNbbmFtZV0gPSBzYXZlZC5nZXRQcm9wZXJ0eShuYW1lKTtcclxuICAgICAgc2F2ZWQuc2V0UHJvcGVydHkobmFtZSwgZW50aXR5TWVtby5wZW5kaW5nQ2hhbmdlc1tuYW1lXSk7XHJcbiAgICB9KTtcclxuICAgIGFzcGVjdC5zZXRNb2RpZmllZCgpO1xyXG4gICAgcmV0dXJuIHRydWU7XHJcbiAgfVxyXG5cclxuICBma0ZpeHVwKGtleU1hcHBpbmc6IEtleU1hcHBpbmcpIHtcclxuICAgIGxldCBlbnRpdHlNZW1vID0gdGhpcztcclxuICAgIGxldCB0eXBlID0gZW50aXR5TWVtby5lbnRpdHkuZW50aXR5VHlwZTtcclxuICAgIGxldCBma1Byb3BzID0gdHlwZS5mb3JlaWduS2V5UHJvcGVydGllcztcclxuICAgIGZrUHJvcHMuZm9yRWFjaChma1Byb3AgPT4ge1xyXG4gICAgICBpZiAoZmtQcm9wLnBhcmVudFR5cGUubmFtZSA9PT0ga2V5TWFwcGluZy5lbnRpdHlUeXBlTmFtZSAmJlxyXG4gICAgICAgIGVudGl0eU1lbW8ucGVuZGluZ0NoYW5nZXNbZmtQcm9wLm5hbWVdID09PSBrZXlNYXBwaW5nLnRlbXBWYWx1ZSkge1xyXG4gICAgICAgIGVudGl0eU1lbW8ucGVuZGluZ0NoYW5nZXNbZmtQcm9wLm5hbWVdID0ga2V5TWFwcGluZy5yZWFsVmFsdWU7XHJcbiAgICAgIH1cclxuICAgIH0pO1xyXG4gIH1cclxuXHJcbiAgLy8gdXBkYXRlIHRoZSBlbnRpdHlNZW1vIG9mIGNoYW5nZXMgdG8gYW4gZW50aXR5IGJlaW5nIHNhdmVkXHJcbiAgLy8gc28gdGhhdCB3ZSBrbm93IGhvdyB0byBzYXZlIGl0IGFnYWluIGxhdGVyXHJcbiAgdXBkYXRlKCkge1xyXG4gICAgbGV0IGVudGl0eU1lbW8gPSB0aGlzO1xyXG4gICAgbGV0IHByb3BzO1xyXG4gICAgbGV0IGVudGl0eSA9IGVudGl0eU1lbW8uZW50aXR5O1xyXG4gICAgbGV0IGFzcGVjdCA9IGVudGl0eS5lbnRpdHlBc3BlY3Q7XHJcbiAgICBsZXQgc3RhdGVOYW1lID0gYXNwZWN0LmVudGl0eVN0YXRlLm5hbWU7XHJcbiAgICBzd2l0Y2ggKHN0YXRlTmFtZSkge1xyXG4gICAgICBjYXNlICdBZGRlZCc6XHJcbiAgICAgICAgbGV0IG9yaWdpbmFsVmFsdWVzID0gYXNwZWN0Lm9yaWdpbmFsVmFsdWVzO1xyXG4gICAgICAgIHByb3BzID0gZW50aXR5LmVudGl0eVR5cGUuZGF0YVByb3BlcnRpZXM7XHJcbiAgICAgICAgcHJvcHMuZm9yRWFjaChkcCA9PiB7XHJcbiAgICAgICAgICBpZiAoZHAuaXNQYXJ0T2ZLZXkpIHsgcmV0dXJuOyB9XHJcbiAgICAgICAgICBsZXQgbmFtZSA9IGRwLm5hbWU7XHJcbiAgICAgICAgICBsZXQgdmFsdWUgPSBlbnRpdHkuZ2V0UHJvcGVydHkobmFtZSk7XHJcbiAgICAgICAgICBpZiAob3JpZ2luYWxWYWx1ZXNbbmFtZV0gIT09IHZhbHVlKSB7XHJcbiAgICAgICAgICAgIGVudGl0eU1lbW8ucGVuZGluZ0NoYW5nZXNbbmFtZV0gPSB2YWx1ZTtcclxuICAgICAgICAgIH1cclxuICAgICAgICB9KTtcclxuICAgICAgICBicmVhaztcclxuXHJcbiAgICAgIGNhc2UgJ0RlbGV0ZWQnOlxyXG4gICAgICAgIGVudGl0eU1lbW8uaXNEZWxldGVkID0gdHJ1ZTtcclxuICAgICAgICBlbnRpdHlNZW1vLnBlbmRpbmdDaGFuZ2VzID0ge307XHJcbiAgICAgICAgYnJlYWs7XHJcblxyXG4gICAgICBjYXNlICdNb2RpZmllZCc6XHJcbiAgICAgICAgcHJvcHMgPSBPYmplY3Qua2V5cyhhc3BlY3Qub3JpZ2luYWxWYWx1ZXMpO1xyXG4gICAgICAgIHByb3BzLmZvckVhY2gobmFtZSA9PiB7XHJcbiAgICAgICAgICBlbnRpdHlNZW1vLnBlbmRpbmdDaGFuZ2VzW25hbWVdID0gZW50aXR5LmdldFByb3BlcnR5KG5hbWUpO1xyXG4gICAgICAgIH0pO1xyXG4gICAgICAgIGJyZWFrO1xyXG4gICAgfVxyXG4gIH1cclxufVxyXG4iXX0=