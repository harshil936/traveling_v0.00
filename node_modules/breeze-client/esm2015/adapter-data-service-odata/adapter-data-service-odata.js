import * as breeze from 'breeze-client';
let core = breeze.core;
/** @hidden */
export class DataServiceODataAdapter extends breeze.AbstractDataServiceAdapter {
    constructor() {
        super();
        // _catchNoConnectionError = abstractDsaProto._catchNoConnectionError;
        // changeRequestInterceptor = abstractDsaProto.changeRequestInterceptor;
        // _createChangeRequestInterceptor = abstractDsaProto._createChangeRequestInterceptor;
        this.headers = { "DataServiceVersion": "2.0" };
        this.jsonResultsAdapter = new breeze.JsonResultsAdapter({
            name: "OData_default",
            visitNode: function (node, mappingContext, nodeContext) {
                let result = {};
                if (node == null)
                    return result;
                let metadata = node.__metadata;
                if (metadata != null) {
                    // TODO: may be able to make this more efficient by caching of the previous value.
                    let entityTypeName = breeze.MetadataStore.normalizeTypeName(metadata.type);
                    let et = entityTypeName && mappingContext.entityManager.metadataStore.getEntityType(entityTypeName, true);
                    // OData response doesn't distinguish a projection from a whole entity.
                    // We'll assume that whole-entity data would have at least as many properties  (<=)
                    // as the EntityType has mapped properties on the basis that
                    // most projections remove properties rather than add them.
                    // If not, assume it's a projection and do NOT treat as an entity
                    if (et && et._mappedPropertiesCount <= Object.keys(node).length - 1) {
                        // if (et && et._mappedPropertiesCount === Object.keys(node).length - 1) { // OLD
                        result.entityType = et;
                        let uriKey = metadata.uri || metadata.id;
                        if (uriKey) {
                            // Strip baseUri to make uriKey a relative uri
                            // Todo: why is this necessary when absolute works for every OData source tested?
                            let re = new RegExp('^' + mappingContext.dataService.serviceName, 'i');
                            uriKey = uriKey.replace(re, '');
                        }
                        result.extraMetadata = {
                            uriKey: uriKey,
                            etag: metadata.etag
                        };
                    }
                }
                // OData v3 - projection arrays will be enclosed in a results array
                if (node.results) {
                    result.node = node.results;
                }
                let propertyName = nodeContext.propertyName;
                result.ignore = node.__deferred != null || propertyName === "__metadata" ||
                    // EntityKey properties can be produced by EDMX models
                    (propertyName === "EntityKey" && node.$type && core.stringStartsWith(node.$type, "System.Data"));
                return result;
            }
        });
        this.name = "OData";
    }
    static register(config) {
        config = config || breeze.config;
        config.registerAdapter("dataService", DataServiceODataAdapter);
        return config.initializeAdapterInstance("dataService", "OData", true);
    }
    initialize() {
        OData = core.requireLib("OData", "Needed to support remote OData services");
        OData.jsonHandler.recognizeDates = true;
    }
    // Absolute URL is the default as of Breeze 1.5.5.  
    // To use relative URL (like pre-1.5.5), add adapterInstance.relativeUrl = true:
    //
    //     let ds = breeze.config.initializeAdapterInstance("dataService", "webApiOData");
    //     ds.relativeUrl = true; 
    //
    // To use custom url construction, add adapterInstance.relativeUrl = myfunction(dataService, url):
    //
    //     let ds = breeze.config.initializeAdapterInstance("dataService", "webApiOData");
    //     ds.relativeUrl = function(dataService, url) {
    //        return somehowConvert(url);
    //     }
    //
    fetchMetadata(metadataStore, dataService) {
        let serviceName = dataService.serviceName;
        let url;
        if (this.relativeUrl === true) {
            url = dataService.qualifyUrl('$metadata');
        }
        else if (core.isFunction(this.relativeUrl)) {
            url = this.relativeUrl(dataService, '$metadata');
        }
        else {
            url = this.getAbsoluteUrl(dataService, '$metadata');
        }
        let mheaders = core.extend({}, this.headers);
        mheaders.Accept = 'application/*; odata.metadata=full';
        let promise = new Promise((resolve, reject) => {
            // OData.read(url,
            OData.read({
                requestUri: url,
                // headers: { "Accept": "application/json"}
                headers: mheaders
            }, function (data) {
                // data.dataServices.schema is an array of schemas. with properties of
                // entityContainer[], association[], entityType[], and namespace.
                if (!data || !data.dataServices) {
                    let error = new Error("Metadata query failed for: " + url);
                    return reject(error);
                }
                let csdlMetadata = data.dataServices;
                // might have been fetched by another query
                if (!metadataStore.hasMetadataFor(serviceName)) {
                    try {
                        metadataStore.importMetadata(csdlMetadata);
                    }
                    catch (e) {
                        return reject(new Error("Metadata query failed for " + url + "; Unable to process returned metadata: " + e.message));
                    }
                    metadataStore.addDataService(dataService);
                }
                return resolve(csdlMetadata);
            }, function (error) {
                let err = createError(error, url);
                err.message = "Metadata query failed for: " + url + "; " + (err.message || "");
                return reject(err);
            }, OData.metadataHandler);
        });
        return promise;
    }
    executeQuery(mappingContext) {
        let url;
        if (this.relativeUrl === true) {
            url = mappingContext.getUrl();
        }
        else if (core.isFunction(this.relativeUrl)) {
            url = this.relativeUrl(mappingContext.dataService, mappingContext.getUrl());
        }
        else {
            url = this.getAbsoluteUrl(mappingContext.dataService, mappingContext.getUrl());
        }
        // Add query params if .withParameters was used
        let query = mappingContext.query;
        if (!core.isEmpty(query.parameters)) {
            let paramString = toQueryString(query.parameters);
            let sep = url.indexOf("?") < 0 ? "?" : "&";
            url = url + sep + paramString;
        }
        let promise = new Promise((resolve, reject) => {
            OData.read({
                requestUri: url,
                headers: core.extend({}, this.headers)
            }, function (data, response) {
                let inlineCount;
                if (data.__count) {
                    // OData can return data.__count as a string
                    inlineCount = parseInt(data.__count, 10);
                }
                // Odata returns different result structure when it returns multiple entities (data.results) vs single entity (data directly).
                // @see http://www.odata.org/documentation/odata-version-2-0/json-format/#RepresentingCollectionsOfEntries
                // and http://www.odata.org/documentation/odata-version-2-0/json-format/#RepresentingEntries
                let results;
                if (data.results) {
                    results = data.results;
                }
                else {
                    results = data;
                }
                return resolve({ results: results, inlineCount: inlineCount, httpResponse: response, query: query });
            }, function (error) {
                return reject(createError(error, url));
            });
        });
        return promise;
    }
    saveChanges(odataSaveContext, saveBundle) {
        let adapter = odataSaveContext.adapter = this;
        let saveContext = odataSaveContext;
        let url;
        if (this.relativeUrl === true) {
            saveContext.routePrefix = adapter.getRoutePrefix(saveContext.dataService);
            url = saveContext.dataService.qualifyUrl("$batch");
        }
        else if (core.isFunction(adapter.relativeUrl)) {
            saveContext.routePrefix = adapter.relativeUrl(saveContext.dataService, '');
            url = saveContext.routePrefix + '$batch';
        }
        else {
            saveContext.routePrefix = adapter.getAbsoluteUrl(saveContext.dataService, '');
            url = saveContext.routePrefix + '$batch';
        }
        let requestData = createChangeRequests(saveContext, saveBundle);
        let tempKeys = saveContext.tempKeys;
        let contentKeys = saveContext.contentKeys;
        let promise = new Promise((resolve, reject) => {
            OData.request({
                headers: core.extend({}, this.headers),
                requestUri: url,
                method: "POST",
                data: requestData
            }, function (data, response) {
                let entities = [];
                let keyMappings = [];
                let saveResult = { entities: entities, keyMappings: keyMappings };
                data.__batchResponses.forEach(function (br) {
                    br.__changeResponses.forEach(function (cr) {
                        let response = cr.response || cr;
                        let statusCode = response.statusCode;
                        if ((!statusCode) || statusCode >= 400) {
                            reject(createError(cr, url));
                            return;
                        }
                        let contentId = cr.headers["Content-ID"];
                        // Olingo sends different case of 'ID' for the header name.
                        if (!contentId) {
                            contentId = cr.headers["Content-Id"];
                        }
                        let rawEntity = cr.data;
                        if (rawEntity) {
                            let tempKey = tempKeys[contentId];
                            if (tempKey) {
                                let entityType = tempKey.entityType;
                                if (entityType.autoGeneratedKeyType !== breeze.AutoGeneratedKeyType.None) {
                                    let tempValue = tempKey.values[0];
                                    let realKey = entityType.getEntityKeyFromRawEntity(rawEntity, breeze.DataProperty.getRawValueFromServer);
                                    let keyMapping = { entityTypeName: entityType.name, tempValue: tempValue, realValue: realKey.values[0] };
                                    keyMappings.push(keyMapping);
                                }
                            }
                            entities.push(rawEntity);
                        }
                        else {
                            let origEntity = contentKeys[contentId];
                            entities.push(origEntity);
                        }
                    });
                });
                return resolve(saveResult);
            }, function (err) {
                return reject(createError(err, url));
            }, OData.batchHandler);
        });
        return promise;
    }
    getAbsoluteUrl(dataService, url) {
        let serviceName = dataService.qualifyUrl('');
        // only prefix with serviceName if not already on the url
        let base = (core.stringStartsWith(url, serviceName)) ? '' : serviceName;
        // If no protocol, turn base into an absolute URI
        if (window && serviceName.indexOf('//') < 0) {
            // no protocol; make it absolute
            base = window.location.protocol + '//' + window.location.host +
                (core.stringStartsWith(serviceName, '/') ? '' : '/') +
                base;
        }
        return base + url;
    }
    getRoutePrefix(dataService) {
        // Get the routePrefix from a Web API OData service name.
        // The routePrefix is presumed to be the pathname within the dataService.serviceName
        // Examples of servicename -> routePrefix:
        //   'http://localhost:55802/odata/' -> 'odata/'
        //   'http://198.154.121.75/service/odata/' -> 'service/odata/'
        let parser;
        if (typeof document === 'object') { // browser
            parser = document.createElement('a');
            parser.href = dataService.serviceName;
        }
        else { // node
            // TODO: how to best handle this
            // assumes existence of node's url.parse method.
            parser = url.parse(dataService.serviceName);
        }
        let prefix = parser.pathname;
        if (prefix[0] === '/') {
            prefix = prefix.substr(1);
        } // drop leading '/'  (all but IE)
        if (prefix.substr(-1) !== '/') {
            prefix += '/';
        } // ensure trailing '/'
        return prefix;
    }
}
// crude serializer.  Doesn't recurse
function toQueryString(obj) {
    let parts = [];
    for (let i in obj) {
        if (obj.hasOwnProperty(i)) {
            parts.push(encodeURIComponent(i) + "=" + encodeURIComponent(obj[i]));
        }
    }
    return parts.join("&");
}
function transformValue(prop, val) {
    if (prop.isUnmapped)
        return undefined;
    if (prop.dataType === breeze.DataType.DateTimeOffset) {
        // The datajs lib tries to treat client dateTimes that are defined as DateTimeOffset on the server differently
        // from other dateTimes. This fix compensates before the save.
        val = val && new Date(val.getTime() - (val.getTimezoneOffset() * 60000));
    }
    else if (prop.dataType.quoteJsonOData) {
        val = val != null ? val.toString() : val;
    }
    return val;
}
function createChangeRequests(saveContext, saveBundle) {
    let changeRequestInterceptor = saveContext.adapter._createChangeRequestInterceptor(saveContext, saveBundle);
    let changeRequests = [];
    let tempKeys = [];
    let contentKeys = [];
    let entityManager = saveContext.entityManager;
    let helper = entityManager.helper;
    let id = 0;
    let routePrefix = saveContext.routePrefix;
    saveBundle.entities.forEach(function (entity, index) {
        let aspect = entity.entityAspect;
        id = id + 1; // we are deliberately skipping id=0 because Content-ID = 0 seems to be ignored.
        let request = { headers: { "Content-ID": id, "DataServiceVersion": "2.0" } };
        contentKeys[id] = entity;
        if (aspect.entityState.isAdded()) {
            request.requestUri = routePrefix + entity.entityType.defaultResourceName;
            request.method = "POST";
            request.data = helper.unwrapInstance(entity, transformValue);
            tempKeys[id] = aspect.getKey();
        }
        else if (aspect.entityState.isModified()) {
            updateDeleteMergeRequest(request, aspect, routePrefix);
            request.method = "MERGE";
            request.data = helper.unwrapChangedValues(entity, entityManager.metadataStore, transformValue);
            // should be a PATCH/MERGE
        }
        else if (aspect.entityState.isDeleted()) {
            updateDeleteMergeRequest(request, aspect, routePrefix);
            request.method = "DELETE";
        }
        else {
            return;
        }
        request = changeRequestInterceptor.getRequest(request, entity, index);
        changeRequests.push(request);
    });
    saveContext.contentKeys = contentKeys;
    saveContext.tempKeys = tempKeys;
    changeRequestInterceptor.done(changeRequests);
    return {
        __batchRequests: [
            {
                __changeRequests: changeRequests
            }
        ]
    };
}
function updateDeleteMergeRequest(request, aspect, routePrefix) {
    let uriKey;
    let extraMetadata = aspect.extraMetadata;
    if (extraMetadata == null) {
        uriKey = getUriKey(aspect);
        aspect.extraMetadata = {
            uriKey: uriKey
        };
    }
    else {
        uriKey = extraMetadata.uriKey;
        if (extraMetadata.etag) {
            request.headers["If-Match"] = extraMetadata.etag;
        }
    }
    request.requestUri =
        // use routePrefix if uriKey lacks protocol (i.e., relative uri)
        uriKey.indexOf('//') > 0 ? uriKey : routePrefix + uriKey;
}
function getUriKey(aspect) {
    let entityType = aspect.entity.entityType;
    let resourceName = entityType.defaultResourceName;
    let kps = entityType.keyProperties;
    let uriKey = resourceName + "(";
    if (kps.length === 1) {
        uriKey = uriKey + fmtProperty(kps[0], aspect) + ")";
    }
    else {
        let delim = "";
        kps.forEach(function (kp) {
            uriKey = uriKey + delim + kp.nameOnServer + "=" + fmtProperty(kp, aspect);
            delim = ",";
        });
        uriKey = uriKey + ")";
    }
    return uriKey;
}
function fmtProperty(prop, aspect) {
    return prop.dataType.fmtOData(aspect.getPropertyValue(prop.name));
}
function createError(error, url) {
    // OData errors can have the message buried very deeply - and nonobviously
    // this code is tricky so be careful changing the response.body parsing.
    let result = new Error();
    let response = error && error.response;
    if (!response) {
        // in case DataJS returns "No handler for this data"
        result.message = error;
        result.statusText = error;
        return result;
    }
    result.message = response.statusText;
    result.statusText = response.statusText;
    result.status = response.statusCode;
    // non std
    if (url)
        result.url = url;
    result.body = response.body;
    if (response.body) {
        let nextErr;
        try {
            let body = JSON.parse(response.body);
            result.body = body;
            // OData v3 logic
            if (body['odata.error']) {
                body = body['odata.error'];
            }
            let msg = "";
            do {
                nextErr = body.error || body.innererror;
                if (!nextErr)
                    msg = msg + getMessage(body);
                nextErr = nextErr || body.internalexception;
                body = nextErr || body;
            } while (nextErr);
            if (msg.length > 0) {
                result.message = msg;
            }
        }
        catch (e) {
        }
    }
    breeze.AbstractDataServiceAdapter._catchNoConnectionError(result);
    return result;
}
function getMessage(body) {
    let msg = body.message || "";
    return ((typeof (msg) === "string") ? msg : msg.value) + "; ";
}
breeze.config.registerAdapter("dataService", DataServiceODataAdapter);
let webApiODataCtor = function () {
    this.name = "webApiOData";
};
const ɵ0 = webApiODataCtor;
breeze.core.extend(webApiODataCtor.prototype, DataServiceODataAdapter.prototype);
breeze.config.registerAdapter("dataService", webApiODataCtor);
// OData 4 adapter
let webApiOData4Ctor = function () {
    this.name = "webApiOData4";
};
const ɵ1 = webApiOData4Ctor;
breeze.core.extend(webApiOData4Ctor.prototype, webApiODataCtor.prototype);
webApiOData4Ctor.prototype.initialize = function () {
    // Aargh... they moved the cheese.
    let datajs = core.requireLib("datajs", "Needed to support remote OData v4 services");
    OData = datajs.V4.oData;
    OData.json.jsonHandler.recognizeDates = true;
};
webApiOData4Ctor.prototype.headers = { "OData-Version": "4.0" };
breeze.config.registerAdapter("dataService", webApiOData4Ctor);
export { ɵ0, ɵ1 };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYWRhcHRlci1kYXRhLXNlcnZpY2Utb2RhdGEuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9icmVlemUtY2xpZW50L2FkYXB0ZXItZGF0YS1zZXJ2aWNlLW9kYXRhLyIsInNvdXJjZXMiOlsiYWRhcHRlci1kYXRhLXNlcnZpY2Utb2RhdGEudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxLQUFLLE1BQU0sTUFBTSxlQUFlLENBQUM7QUFFeEMsSUFBSSxJQUFJLEdBQUcsTUFBTSxDQUFDLElBQUksQ0FBQztBQVl2QixjQUFjO0FBQ2QsTUFBTSxPQUFPLHVCQUF3QixTQUFRLE1BQU0sQ0FBQywwQkFBMEI7SUFRNUU7UUFDRSxLQUFLLEVBQUUsQ0FBQztRQU5WLHNFQUFzRTtRQUN0RSx3RUFBd0U7UUFDeEUsc0ZBQXNGO1FBQ3RGLFlBQU8sR0FBRyxFQUFFLG9CQUFvQixFQUFFLEtBQUssRUFBRSxDQUFDO1FBbU4xQyx1QkFBa0IsR0FBOEIsSUFBSSxNQUFNLENBQUMsa0JBQWtCLENBQUM7WUFDNUUsSUFBSSxFQUFFLGVBQWU7WUFFckIsU0FBUyxFQUFFLFVBQVUsSUFBUyxFQUFFLGNBQXFDLEVBQUUsV0FBK0I7Z0JBQ3BHLElBQUksTUFBTSxHQUFRLEVBQUUsQ0FBQztnQkFDckIsSUFBSSxJQUFJLElBQUksSUFBSTtvQkFBRSxPQUFPLE1BQU0sQ0FBQztnQkFDaEMsSUFBSSxRQUFRLEdBQUcsSUFBSSxDQUFDLFVBQVUsQ0FBQztnQkFDL0IsSUFBSSxRQUFRLElBQUksSUFBSSxFQUFFO29CQUNwQixrRkFBa0Y7b0JBQ2xGLElBQUksY0FBYyxHQUFHLE1BQU0sQ0FBQyxhQUFhLENBQUMsaUJBQWlCLENBQUMsUUFBUSxDQUFDLElBQUksQ0FBQyxDQUFDO29CQUMzRSxJQUFJLEVBQUUsR0FBRyxjQUFjLElBQUksY0FBYyxDQUFDLGFBQWEsQ0FBQyxhQUFhLENBQUMsYUFBYSxDQUFDLGNBQWMsRUFBRSxJQUFJLENBQUMsQ0FBQztvQkFDMUcsdUVBQXVFO29C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QUUsS0FBSyxFQUFFLENBQUM7QUFDaEUsTUFBTSxDQUFDLE1BQU0sQ0FBQyxlQUFlLENBQUMsYUFBYSxFQUFFLGdCQUF1QixDQUFDLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgKiBhcyBicmVlemUgZnJvbSAnYnJlZXplLWNsaWVudCc7XHJcblxyXG5sZXQgY29yZSA9IGJyZWV6ZS5jb3JlO1xyXG5cclxuZGVjbGFyZSB2YXIgd2luZG93OiBhbnk7XHJcbmRlY2xhcmUgdmFyIGRvY3VtZW50OiBhbnk7XHJcbmRlY2xhcmUgdmFyIHVybDogYW55OyAvLyBuZWVkZWQgdG8gYWNjZXNzIG5vZGUncyB1cmwucGFyc2VcclxuZGVjbGFyZSB2YXIgT0RhdGE6IGFueTtcclxuXHJcbmludGVyZmFjZSBPRGF0YVNhdmVDb250ZXh0IGV4dGVuZHMgYnJlZXplLlNhdmVDb250ZXh0IHtcclxuICB0ZW1wS2V5czogYnJlZXplLkVudGl0eUtleVtdO1xyXG4gIGNvbnRlbnRLZXlzOiBicmVlemUuRW50aXR5W107XHJcbn1cclxuXHJcbi8qKiBAaGlkZGVuICovXHJcbmV4cG9ydCBjbGFzcyBEYXRhU2VydmljZU9EYXRhQWRhcHRlciBleHRlbmRzIGJyZWV6ZS5BYnN0cmFjdERhdGFTZXJ2aWNlQWRhcHRlciB7XHJcbiAgbmFtZTogc3RyaW5nO1xyXG4gIHJlbGF0aXZlVXJsOiBib29sZWFuIHwgKChkczogYnJlZXplLkRhdGFTZXJ2aWNlLCB1cmw6IHN0cmluZykgPT4gc3RyaW5nKTtcclxuICAvLyBfY2F0Y2hOb0Nvbm5lY3Rpb25FcnJvciA9IGFic3RyYWN0RHNhUHJvdG8uX2NhdGNoTm9Db25uZWN0aW9uRXJyb3I7XHJcbiAgLy8gY2hhbmdlUmVxdWVzdEludGVyY2VwdG9yID0gYWJzdHJhY3REc2FQcm90by5jaGFuZ2VSZXF1ZXN0SW50ZXJjZXB0b3I7XHJcbiAgLy8gX2NyZWF0ZUNoYW5nZVJlcXVlc3RJbnRlcmNlcHRvciA9IGFic3RyYWN0RHNhUHJvdG8uX2NyZWF0ZUNoYW5nZVJlcXVlc3RJbnRlcmNlcHRvcjtcclxuICBoZWFkZXJzID0geyBcIkRhdGFTZXJ2aWNlVmVyc2lvblwiOiBcIjIuMFwiIH07XHJcblxyXG4gIGNvbnN0cnVjdG9yKCkge1xyXG4gICAgc3VwZXIoKTtcclxuICAgIHRoaXMubmFtZSA9IFwiT0RhdGFcIjtcclxuICB9XHJcblxyXG4gIHN0YXRpYyByZWdpc3Rlcihjb25maWc/OiBicmVlemUuQnJlZXplQ29uZmlnKSB7XHJcbiAgICBjb25maWcgPSBjb25maWcgfHwgYnJlZXplLmNvbmZpZztcclxuICAgIGNvbmZpZy5yZWdpc3RlckFkYXB0ZXIoXCJkYXRhU2VydmljZVwiLCBEYXRhU2VydmljZU9EYXRhQWRhcHRlcik7XHJcbiAgICByZXR1cm4gY29uZmlnLmluaXRpYWxpemVBZGFwdGVySW5zdGFuY2UoXCJkYXRhU2VydmljZVwiLCBcIk9EYXRhXCIsIHRydWUpIGFzIERhdGFTZXJ2aWNlT0RhdGFBZGFwdGVyO1xyXG4gIH1cclxuXHJcbiAgaW5pdGlhbGl6ZSgpIHtcclxuICAgIE9EYXRhID0gY29yZS5yZXF1aXJlTGliKFwiT0RhdGFcIiwgXCJOZWVkZWQgdG8gc3VwcG9ydCByZW1vdGUgT0RhdGEgc2VydmljZXNcIik7XHJcbiAgICBPRGF0YS5qc29uSGFuZGxlci5yZWNvZ25pemVEYXRlcyA9IHRydWU7XHJcbiAgfVxyXG5cclxuXHJcbiAgLy8gQWJzb2x1dGUgVVJMIGlzIHRoZSBkZWZhdWx0IGFzIG9mIEJyZWV6ZSAxLjUuNS4gIFxyXG4gIC8vIFRvIHVzZSByZWxhdGl2ZSBVUkwgKGxpa2UgcHJlLTEuNS41KSwgYWRkIGFkYXB0ZXJJbnN0YW5jZS5yZWxhdGl2ZVVybCA9IHRydWU6XHJcbiAgLy9cclxuICAvLyAgICAgbGV0IGRzID0gYnJlZXplLmNvbmZpZy5pbml0aWFsaXplQWRhcHRlckluc3RhbmNlKFwiZGF0YVNlcnZpY2VcIiwgXCJ3ZWJBcGlPRGF0YVwiKTtcclxuICAvLyAgICAgZHMucmVsYXRpdmVVcmwgPSB0cnVlOyBcclxuICAvL1xyXG4gIC8vIFRvIHVzZSBjdXN0b20gdXJsIGNvbnN0cnVjdGlvbiwgYWRkIGFkYXB0ZXJJbnN0YW5jZS5yZWxhdGl2ZVVybCA9IG15ZnVuY3Rpb24oZGF0YVNlcnZpY2UsIHVybCk6XHJcbiAgLy9cclxuICAvLyAgICAgbGV0IGRzID0gYnJlZXplLmNvbmZpZy5pbml0aWFsaXplQWRhcHRlckluc3RhbmNlKFwiZGF0YVNlcnZpY2VcIiwgXCJ3ZWJBcGlPRGF0YVwiKTtcclxuICAvLyAgICAgZHMucmVsYXRpdmVVcmwgPSBmdW5jdGlvbihkYXRhU2VydmljZSwgdXJsKSB7XHJcbiAgLy8gICAgICAgIHJldHVybiBzb21laG93Q29udmVydCh1cmwpO1xyXG4gIC8vICAgICB9XHJcbiAgLy9cclxuXHJcbiAgZmV0Y2hNZXRhZGF0YShtZXRhZGF0YVN0b3JlOiBicmVlemUuTWV0YWRhdGFTdG9yZSwgZGF0YVNlcnZpY2U6IGJyZWV6ZS5EYXRhU2VydmljZSkge1xyXG4gICAgbGV0IHNlcnZpY2VOYW1lID0gZGF0YVNlcnZpY2Uuc2VydmljZU5hbWU7XHJcblxyXG4gICAgbGV0IHVybDogc3RyaW5nO1xyXG4gICAgaWYgKHRoaXMucmVsYXRpdmVVcmwgPT09IHRydWUpIHtcclxuICAgICAgdXJsID0gZGF0YVNlcnZpY2UucXVhbGlmeVVybCgnJG1ldGFkYXRhJyk7XHJcbiAgICB9IGVsc2UgaWYgKGNvcmUuaXNGdW5jdGlvbih0aGlzLnJlbGF0aXZlVXJsKSkge1xyXG4gICAgICB1cmwgPSAodGhpcy5yZWxhdGl2ZVVybCBhcyBhbnkpKGRhdGFTZXJ2aWNlLCAnJG1ldGFkYXRhJyk7XHJcbiAgICB9IGVsc2Uge1xyXG4gICAgICB1cmwgPSB0aGlzLmdldEFic29sdXRlVXJsKGRhdGFTZXJ2aWNlLCAnJG1ldGFkYXRhJyk7XHJcbiAgICB9XHJcblxyXG4gICAgbGV0IG1oZWFkZXJzID0gY29yZS5leHRlbmQoe30sIHRoaXMuaGVhZGVycyk7XHJcbiAgICAobWhlYWRlcnMgYXMgYW55KS5BY2NlcHQgPSAnYXBwbGljYXRpb24vKjsgb2RhdGEubWV0YWRhdGE9ZnVsbCc7XHJcblxyXG4gICAgbGV0IHByb21pc2UgPSBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XHJcbiAgICAgIC8vIE9EYXRhLnJlYWQodXJsLFxyXG4gICAgICBPRGF0YS5yZWFkKHtcclxuICAgICAgICByZXF1ZXN0VXJpOiB1cmwsXHJcbiAgICAgICAgLy8gaGVhZGVyczogeyBcIkFjY2VwdFwiOiBcImFwcGxpY2F0aW9uL2pzb25cIn1cclxuICAgICAgICBoZWFkZXJzOiBtaGVhZGVyc1xyXG4gICAgICB9LFxyXG4gICAgICAgIGZ1bmN0aW9uIChkYXRhOiBhbnkpIHtcclxuICAgICAgICAgIC8vIGRhdGEuZGF0YVNlcnZpY2VzLnNjaGVtYSBpcyBhbiBhcnJheSBvZiBzY2hlbWFzLiB3aXRoIHByb3BlcnRpZXMgb2ZcclxuICAgICAgICAgIC8vIGVudGl0eUNvbnRhaW5lcltdLCBhc3NvY2lhdGlvbltdLCBlbnRpdHlUeXBlW10sIGFuZCBuYW1lc3BhY2UuXHJcbiAgICAgICAgICBpZiAoIWRhdGEgfHwgIWRhdGEuZGF0YVNlcnZpY2VzKSB7XHJcbiAgICAgICAgICAgIGxldCBlcnJvciA9IG5ldyBFcnJvcihcIk1ldGFkYXRhIHF1ZXJ5IGZhaWxlZCBmb3I6IFwiICsgdXJsKTtcclxuICAgICAgICAgICAgcmV0dXJuIHJlamVjdChlcnJvcik7XHJcbiAgICAgICAgICB9XHJcbiAgICAgICAgICBsZXQgY3NkbE1ldGFkYXRhID0gZGF0YS5kYXRhU2VydmljZXM7XHJcblxyXG4gICAgICAgICAgLy8gbWlnaHQgaGF2ZSBiZWVuIGZldGNoZWQgYnkgYW5vdGhlciBxdWVyeVxyXG4gICAgICAgICAgaWYgKCFtZXRhZGF0YVN0b3JlLmhhc01ldGFkYXRhRm9yKHNlcnZpY2VOYW1lKSkge1xyXG4gICAgICAgICAgICB0cnkge1xyXG4gICAgICAgICAgICAgIG1ldGFkYXRhU3RvcmUuaW1wb3J0TWV0YWRhdGEoY3NkbE1ldGFkYXRhKTtcclxuICAgICAgICAgICAgfSBjYXRjaCAoZSkge1xyXG4gICAgICAgICAgICAgIHJldHVybiByZWplY3QobmV3IEVycm9yKFwiTWV0YWRhdGEgcXVlcnkgZmFpbGVkIGZvciBcIiArIHVybCArIFwiOyBVbmFibGUgdG8gcHJvY2VzcyByZXR1cm5lZCBtZXRhZGF0YTogXCIgKyBlLm1lc3NhZ2UpKTtcclxuICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgbWV0YWRhdGFTdG9yZS5hZGREYXRhU2VydmljZShkYXRhU2VydmljZSk7XHJcbiAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgcmV0dXJuIHJlc29sdmUoY3NkbE1ldGFkYXRhKTtcclxuXHJcbiAgICAgICAgfSwgZnVuY3Rpb24gKGVycm9yOiBhbnkpIHtcclxuICAgICAgICAgIGxldCBlcnIgPSBjcmVhdGVFcnJvcihlcnJvciwgdXJsKTtcclxuICAgICAgICAgIGVyci5tZXNzYWdlID0gXCJNZXRhZGF0YSBxdWVyeSBmYWlsZWQgZm9yOiBcIiArIHVybCArIFwiOyBcIiArIChlcnIubWVzc2FnZSB8fCBcIlwiKTtcclxuICAgICAgICAgIHJldHVybiByZWplY3QoZXJyKTtcclxuICAgICAgICB9LFxyXG4gICAgICAgIE9EYXRhLm1ldGFkYXRhSGFuZGxlclxyXG4gICAgICApO1xyXG4gICAgfSk7XHJcblxyXG4gICAgcmV0dXJuIHByb21pc2U7XHJcbiAgfVxyXG5cclxuXHJcblxyXG4gIGV4ZWN1dGVRdWVyeShtYXBwaW5nQ29udGV4dDogYnJlZXplLk1hcHBpbmdDb250ZXh0KSB7XHJcbiAgICBsZXQgdXJsOiBzdHJpbmc7XHJcbiAgICBpZiAodGhpcy5yZWxhdGl2ZVVybCA9PT0gdHJ1ZSkge1xyXG4gICAgICB1cmwgPSBtYXBwaW5nQ29udGV4dC5nZXRVcmwoKTtcclxuICAgIH0gZWxzZSBpZiAoY29yZS5pc0Z1bmN0aW9uKHRoaXMucmVsYXRpdmVVcmwpKSB7XHJcbiAgICAgIHVybCA9ICh0aGlzLnJlbGF0aXZlVXJsIGFzIGFueSkobWFwcGluZ0NvbnRleHQuZGF0YVNlcnZpY2UsIG1hcHBpbmdDb250ZXh0LmdldFVybCgpKTtcclxuICAgIH0gZWxzZSB7XHJcbiAgICAgIHVybCA9IHRoaXMuZ2V0QWJzb2x1dGVVcmwobWFwcGluZ0NvbnRleHQuZGF0YVNlcnZpY2UsIG1hcHBpbmdDb250ZXh0LmdldFVybCgpKTtcclxuICAgIH1cclxuXHJcbiAgICAvLyBBZGQgcXVlcnkgcGFyYW1zIGlmIC53aXRoUGFyYW1ldGVycyB3YXMgdXNlZFxyXG4gICAgbGV0IHF1ZXJ5ID0gbWFwcGluZ0NvbnRleHQucXVlcnkgYXMgYnJlZXplLkVudGl0eVF1ZXJ5O1xyXG4gICAgaWYgKCFjb3JlLmlzRW1wdHkocXVlcnkucGFyYW1ldGVycykpIHtcclxuICAgICAgbGV0IHBhcmFtU3RyaW5nID0gdG9RdWVyeVN0cmluZyhxdWVyeS5wYXJhbWV0ZXJzKTtcclxuICAgICAgbGV0IHNlcCA9IHVybC5pbmRleE9mKFwiP1wiKSA8IDAgPyBcIj9cIiA6IFwiJlwiO1xyXG4gICAgICB1cmwgPSB1cmwgKyBzZXAgKyBwYXJhbVN0cmluZztcclxuICAgIH1cclxuXHJcbiAgICBsZXQgcHJvbWlzZSA9IG5ldyBQcm9taXNlPGJyZWV6ZS5RdWVyeVJlc3VsdD4oKHJlc29sdmUsIHJlamVjdCkgPT4ge1xyXG4gICAgICBPRGF0YS5yZWFkKHtcclxuICAgICAgICByZXF1ZXN0VXJpOiB1cmwsXHJcbiAgICAgICAgaGVhZGVyczogY29yZS5leHRlbmQoe30sIHRoaXMuaGVhZGVycylcclxuICAgICAgfSxcclxuICAgICAgICBmdW5jdGlvbiAoZGF0YTogYW55LCByZXNwb25zZTogYW55KSB7XHJcbiAgICAgICAgICBsZXQgaW5saW5lQ291bnQ6IGFueTtcclxuICAgICAgICAgIGlmIChkYXRhLl9fY291bnQpIHtcclxuICAgICAgICAgICAgLy8gT0RhdGEgY2FuIHJldHVybiBkYXRhLl9fY291bnQgYXMgYSBzdHJpbmdcclxuICAgICAgICAgICAgaW5saW5lQ291bnQgPSBwYXJzZUludChkYXRhLl9fY291bnQsIDEwKTtcclxuICAgICAgICAgIH1cclxuICAgICAgICAgIC8vIE9kYXRhIHJldHVybnMgZGlmZmVyZW50IHJlc3VsdCBzdHJ1Y3R1cmUgd2hlbiBpdCByZXR1cm5zIG11bHRpcGxlIGVudGl0aWVzIChkYXRhLnJlc3VsdHMpIHZzIHNpbmdsZSBlbnRpdHkgKGRhdGEgZGlyZWN0bHkpLlxyXG4gICAgICAgICAgLy8gQHNlZSBodHRwOi8vd3d3Lm9kYXRhLm9yZy9kb2N1bWVudGF0aW9uL29kYXRhLXZlcnNpb24tMi0wL2pzb24tZm9ybWF0LyNSZXByZXNlbnRpbmdDb2xsZWN0aW9uc09mRW50cmllc1xyXG4gICAgICAgICAgLy8gYW5kIGh0dHA6Ly93d3cub2RhdGEub3JnL2RvY3VtZW50YXRpb24vb2RhdGEtdmVyc2lvbi0yLTAvanNvbi1mb3JtYXQvI1JlcHJlc2VudGluZ0VudHJpZXNcclxuICAgICAgICAgIGxldCByZXN1bHRzOiBhbnk7XHJcbiAgICAgICAgICBpZiAoZGF0YS5yZXN1bHRzKSB7XHJcbiAgICAgICAgICAgIHJlc3VsdHMgPSBkYXRhLnJlc3VsdHM7XHJcbiAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICByZXN1bHRzID0gZGF0YTtcclxuICAgICAgICAgIH1cclxuICAgICAgICAgIHJldHVybiByZXNvbHZlKHsgcmVzdWx0czogcmVzdWx0cywgaW5saW5lQ291bnQ6IGlubGluZUNvdW50LCBodHRwUmVzcG9uc2U6IHJlc3BvbnNlLCBxdWVyeTogcXVlcnkgfSk7XHJcbiAgICAgICAgfSxcclxuICAgICAgICBmdW5jdGlvbiAoZXJyb3I6IGFueSkge1xyXG4gICAgICAgICAgcmV0dXJuIHJlamVjdChjcmVhdGVFcnJvcihlcnJvciwgdXJsKSk7XHJcbiAgICAgICAgfVxyXG4gICAgICApO1xyXG4gICAgfSk7XHJcbiAgICByZXR1cm4gcHJvbWlzZTtcclxuICB9XHJcblxyXG5cclxuICBzYXZlQ2hhbmdlcyhvZGF0YVNhdmVDb250ZXh0OiBicmVlemUuU2F2ZUNvbnRleHQsIHNhdmVCdW5kbGU6IGJyZWV6ZS5TYXZlQnVuZGxlKTogUHJvbWlzZTxicmVlemUuU2F2ZVJlc3VsdD4ge1xyXG4gICAgbGV0IGFkYXB0ZXIgPSBvZGF0YVNhdmVDb250ZXh0LmFkYXB0ZXIgPSB0aGlzO1xyXG4gICAgbGV0IHNhdmVDb250ZXh0ID0gb2RhdGFTYXZlQ29udGV4dCBhcyBPRGF0YVNhdmVDb250ZXh0O1xyXG4gICAgbGV0IHVybDogc3RyaW5nO1xyXG4gICAgaWYgKHRoaXMucmVsYXRpdmVVcmwgPT09IHRydWUpIHtcclxuICAgICAgc2F2ZUNvbnRleHQucm91dGVQcmVmaXggPSBhZGFwdGVyLmdldFJvdXRlUHJlZml4KHNhdmVDb250ZXh0LmRhdGFTZXJ2aWNlKTtcclxuICAgICAgdXJsID0gc2F2ZUNvbnRleHQuZGF0YVNlcnZpY2UucXVhbGlmeVVybChcIiRiYXRjaFwiKTtcclxuICAgIH0gZWxzZSBpZiAoY29yZS5pc0Z1bmN0aW9uKGFkYXB0ZXIucmVsYXRpdmVVcmwpKSB7XHJcbiAgICAgIHNhdmVDb250ZXh0LnJvdXRlUHJlZml4ID0gKGFkYXB0ZXIucmVsYXRpdmVVcmwgYXMgRnVuY3Rpb24pKHNhdmVDb250ZXh0LmRhdGFTZXJ2aWNlLCAnJyk7XHJcbiAgICAgIHVybCA9IHNhdmVDb250ZXh0LnJvdXRlUHJlZml4ICsgJyRiYXRjaCc7XHJcbiAgICB9IGVsc2Uge1xyXG4gICAgICBzYXZlQ29udGV4dC5yb3V0ZVByZWZpeCA9IGFkYXB0ZXIuZ2V0QWJzb2x1dGVVcmwoc2F2ZUNvbnRleHQuZGF0YVNlcnZpY2UsICcnKTtcclxuICAgICAgdXJsID0gc2F2ZUNvbnRleHQucm91dGVQcmVmaXggKyAnJGJhdGNoJztcclxuICAgIH1cclxuXHJcbiAgICBsZXQgcmVxdWVzdERhdGEgPSBjcmVhdGVDaGFuZ2VSZXF1ZXN0cyhzYXZlQ29udGV4dCwgc2F2ZUJ1bmRsZSk7XHJcbiAgICBsZXQgdGVtcEtleXMgPSBzYXZlQ29udGV4dC50ZW1wS2V5cztcclxuICAgIGxldCBjb250ZW50S2V5cyA9IHNhdmVDb250ZXh0LmNvbnRlbnRLZXlzO1xyXG4gICAgbGV0IHByb21pc2UgPSBuZXcgUHJvbWlzZTxicmVlemUuU2F2ZVJlc3VsdD4oKHJlc29sdmUsIHJlamVjdCkgPT4ge1xyXG4gICAgICBPRGF0YS5yZXF1ZXN0KHtcclxuICAgICAgICBoZWFkZXJzOiBjb3JlLmV4dGVuZCh7fSwgdGhpcy5oZWFkZXJzKSxcclxuICAgICAgICByZXF1ZXN0VXJpOiB1cmwsXHJcbiAgICAgICAgbWV0aG9kOiBcIlBPU1RcIixcclxuICAgICAgICBkYXRhOiByZXF1ZXN0RGF0YVxyXG4gICAgICB9LCBmdW5jdGlvbiAoZGF0YTogYW55LCByZXNwb25zZTogYW55KSB7XHJcbiAgICAgICAgbGV0IGVudGl0aWVzOiBhbnlbXSA9IFtdO1xyXG4gICAgICAgIGxldCBrZXlNYXBwaW5nczogYnJlZXplLktleU1hcHBpbmdbXSA9IFtdO1xyXG4gICAgICAgIGxldCBzYXZlUmVzdWx0OiBicmVlemUuU2F2ZVJlc3VsdCA9IHsgZW50aXRpZXM6IGVudGl0aWVzLCBrZXlNYXBwaW5nczoga2V5TWFwcGluZ3MgfTtcclxuICAgICAgICBkYXRhLl9fYmF0Y2hSZXNwb25zZXMuZm9yRWFjaChmdW5jdGlvbiAoYnI6IGFueSkge1xyXG4gICAgICAgICAgYnIuX19jaGFuZ2VSZXNwb25zZXMuZm9yRWFjaChmdW5jdGlvbiAoY3I6IGFueSkge1xyXG4gICAgICAgICAgICBsZXQgcmVzcG9uc2UgPSBjci5yZXNwb25zZSB8fCBjcjtcclxuICAgICAgICAgICAgbGV0IHN0YXR1c0NvZGUgPSByZXNwb25zZS5zdGF0dXNDb2RlO1xyXG4gICAgICAgICAgICBpZiAoKCFzdGF0dXNDb2RlKSB8fCBzdGF0dXNDb2RlID49IDQwMCkge1xyXG4gICAgICAgICAgICAgIHJlamVjdChjcmVhdGVFcnJvcihjciwgdXJsKSk7XHJcbiAgICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICBsZXQgY29udGVudElkID0gY3IuaGVhZGVyc1tcIkNvbnRlbnQtSURcIl07XHJcbiAgICAgICAgICAgIC8vIE9saW5nbyBzZW5kcyBkaWZmZXJlbnQgY2FzZSBvZiAnSUQnIGZvciB0aGUgaGVhZGVyIG5hbWUuXHJcbiAgICAgICAgICAgIGlmICghY29udGVudElkKSB7XHJcbiAgICAgICAgICAgICAgY29udGVudElkID0gY3IuaGVhZGVyc1tcIkNvbnRlbnQtSWRcIl07XHJcbiAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgIGxldCByYXdFbnRpdHkgPSBjci5kYXRhO1xyXG4gICAgICAgICAgICBpZiAocmF3RW50aXR5KSB7XHJcbiAgICAgICAgICAgICAgbGV0IHRlbXBLZXkgPSB0ZW1wS2V5c1tjb250ZW50SWRdO1xyXG4gICAgICAgICAgICAgIGlmICh0ZW1wS2V5KSB7XHJcbiAgICAgICAgICAgICAgICBsZXQgZW50aXR5VHlwZSA9IHRlbXBLZXkuZW50aXR5VHlwZTtcclxuICAgICAgICAgICAgICAgIGlmIChlbnRpdHlUeXBlLmF1dG9HZW5lcmF0ZWRLZXlUeXBlICE9PSBicmVlemUuQXV0b0dlbmVyYXRlZEtleVR5cGUuTm9uZSkge1xyXG4gICAgICAgICAgICAgICAgICBsZXQgdGVtcFZhbHVlID0gdGVtcEtleS52YWx1ZXNbMF07XHJcbiAgICAgICAgICAgICAgICAgIGxldCByZWFsS2V5ID0gZW50aXR5VHlwZS5nZXRFbnRpdHlLZXlGcm9tUmF3RW50aXR5KHJhd0VudGl0eSwgYnJlZXplLkRhdGFQcm9wZXJ0eS5nZXRSYXdWYWx1ZUZyb21TZXJ2ZXIpO1xyXG4gICAgICAgICAgICAgICAgICBsZXQga2V5TWFwcGluZyA9IHsgZW50aXR5VHlwZU5hbWU6IGVudGl0eVR5cGUubmFtZSwgdGVtcFZhbHVlOiB0ZW1wVmFsdWUsIHJlYWxWYWx1ZTogcmVhbEtleS52YWx1ZXNbMF0gfTtcclxuICAgICAgICAgICAgICAgICAga2V5TWFwcGluZ3MucHVzaChrZXlNYXBwaW5nKTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgZW50aXRpZXMucHVzaChyYXdFbnRpdHkpO1xyXG4gICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgIGxldCBvcmlnRW50aXR5ID0gY29udGVudEtleXNbY29udGVudElkXTtcclxuICAgICAgICAgICAgICBlbnRpdGllcy5wdXNoKG9yaWdFbnRpdHkpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICB9KTtcclxuICAgICAgICB9KTtcclxuICAgICAgICByZXR1cm4gcmVzb2x2ZShzYXZlUmVzdWx0KTtcclxuICAgICAgfSwgZnVuY3Rpb24gKGVycjogYW55KSB7XHJcbiAgICAgICAgcmV0dXJuIHJlamVjdChjcmVhdGVFcnJvcihlcnIsIHVybCkpO1xyXG4gICAgICB9LCBPRGF0YS5iYXRjaEhhbmRsZXIpO1xyXG4gICAgfSk7XHJcbiAgICByZXR1cm4gcHJvbWlzZTtcclxuXHJcbiAgfVxyXG5cclxuICBqc29uUmVzdWx0c0FkYXB0ZXI6IGJyZWV6ZS5Kc29uUmVzdWx0c0FkYXB0ZXIgPSBuZXcgYnJlZXplLkpzb25SZXN1bHRzQWRhcHRlcih7XHJcbiAgICBuYW1lOiBcIk9EYXRhX2RlZmF1bHRcIixcclxuXHJcbiAgICB2aXNpdE5vZGU6IGZ1bmN0aW9uIChub2RlOiBhbnksIG1hcHBpbmdDb250ZXh0OiBicmVlemUuTWFwcGluZ0NvbnRleHQsIG5vZGVDb250ZXh0OiBicmVlemUuTm9kZUNvbnRleHQpIHtcclxuICAgICAgbGV0IHJlc3VsdDogYW55ID0ge307XHJcbiAgICAgIGlmIChub2RlID09IG51bGwpIHJldHVybiByZXN1bHQ7XHJcbiAgICAgIGxldCBtZXRhZGF0YSA9IG5vZGUuX19tZXRhZGF0YTtcclxuICAgICAgaWYgKG1ldGFkYXRhICE9IG51bGwpIHtcclxuICAgICAgICAvLyBUT0RPOiBtYXkgYmUgYWJsZSB0byBtYWtlIHRoaXMgbW9yZSBlZmZpY2llbnQgYnkgY2FjaGluZyBvZiB0aGUgcHJldmlvdXMgdmFsdWUuXHJcbiAgICAgICAgbGV0IGVudGl0eVR5cGVOYW1lID0gYnJlZXplLk1ldGFkYXRhU3RvcmUubm9ybWFsaXplVHlwZU5hbWUobWV0YWRhdGEudHlwZSk7XHJcbiAgICAgICAgbGV0IGV0ID0gZW50aXR5VHlwZU5hbWUgJiYgbWFwcGluZ0NvbnRleHQuZW50aXR5TWFuYWdlci5tZXRhZGF0YVN0b3JlLmdldEVudGl0eVR5cGUoZW50aXR5VHlwZU5hbWUsIHRydWUpO1xyXG4gICAgICAgIC8vIE9EYXRhIHJlc3BvbnNlIGRvZXNuJ3QgZGlzdGluZ3Vpc2ggYSBwcm9qZWN0aW9uIGZyb20gYSB3aG9sZSBlbnRpdHkuXHJcbiAgICAgICAgLy8gV2UnbGwgYXNzdW1lIHRoYXQgd2hvbGUtZW50aXR5IGRhdGEgd291bGQgaGF2ZSBhdCBsZWFzdCBhcyBtYW55IHByb3BlcnRpZXMgICg8PSlcclxuICAgICAgICAvLyBhcyB0aGUgRW50aXR5VHlwZSBoYXMgbWFwcGVkIHByb3BlcnRpZXMgb24gdGhlIGJhc2lzIHRoYXRcclxuICAgICAgICAvLyBtb3N0IHByb2plY3Rpb25zIHJlbW92ZSBwcm9wZXJ0aWVzIHJhdGhlciB0aGFuIGFkZCB0aGVtLlxyXG4gICAgICAgIC8vIElmIG5vdCwgYXNzdW1lIGl0J3MgYSBwcm9qZWN0aW9uIGFuZCBkbyBOT1QgdHJlYXQgYXMgYW4gZW50aXR5XHJcbiAgICAgICAgaWYgKGV0ICYmIGV0Ll9tYXBwZWRQcm9wZXJ0aWVzQ291bnQgPD0gT2JqZWN0LmtleXMobm9kZSkubGVuZ3RoIC0gMSkge1xyXG4gICAgICAgICAgLy8gaWYgKGV0ICYmIGV0Ll9tYXBwZWRQcm9wZXJ0aWVzQ291bnQgPT09IE9iamVjdC5rZXlzKG5vZGUpLmxlbmd0aCAtIDEpIHsgLy8gT0xEXHJcbiAgICAgICAgICByZXN1bHQuZW50aXR5VHlwZSA9IGV0O1xyXG4gICAgICAgICAgbGV0IHVyaUtleSA9IG1ldGFkYXRhLnVyaSB8fCBtZXRhZGF0YS5pZDtcclxuICAgICAgICAgIGlmICh1cmlLZXkpIHtcclxuICAgICAgICAgICAgLy8gU3RyaXAgYmFzZVVyaSB0byBtYWtlIHVyaUtleSBhIHJlbGF0aXZlIHVyaVxyXG4gICAgICAgICAgICAvLyBUb2RvOiB3aHkgaXMgdGhpcyBuZWNlc3Nhcnkgd2hlbiBhYnNvbHV0ZSB3b3JrcyBmb3IgZXZlcnkgT0RhdGEgc291cmNlIHRlc3RlZD9cclxuICAgICAgICAgICAgbGV0IHJlID0gbmV3IFJlZ0V4cCgnXicgKyBtYXBwaW5nQ29udGV4dC5kYXRhU2VydmljZS5zZXJ2aWNlTmFtZSwgJ2knKTtcclxuICAgICAgICAgICAgdXJpS2V5ID0gdXJpS2V5LnJlcGxhY2UocmUsICcnKTtcclxuICAgICAgICAgIH1cclxuICAgICAgICAgIHJlc3VsdC5leHRyYU1ldGFkYXRhID0ge1xyXG4gICAgICAgICAgICB1cmlLZXk6IHVyaUtleSxcclxuICAgICAgICAgICAgZXRhZzogbWV0YWRhdGEuZXRhZ1xyXG4gICAgICAgICAgfTtcclxuICAgICAgICB9XHJcbiAgICAgIH1cclxuICAgICAgLy8gT0RhdGEgdjMgLSBwcm9qZWN0aW9uIGFycmF5cyB3aWxsIGJlIGVuY2xvc2VkIGluIGEgcmVzdWx0cyBhcnJheVxyXG4gICAgICBpZiAobm9kZS5yZXN1bHRzKSB7XHJcbiAgICAgICAgcmVzdWx0Lm5vZGUgPSBub2RlLnJlc3VsdHM7XHJcbiAgICAgIH1cclxuXHJcbiAgICAgIGxldCBwcm9wZXJ0eU5hbWUgPSBub2RlQ29udGV4dC5wcm9wZXJ0eU5hbWU7XHJcbiAgICAgIHJlc3VsdC5pZ25vcmUgPSBub2RlLl9fZGVmZXJyZWQgIT0gbnVsbCB8fCBwcm9wZXJ0eU5hbWUgPT09IFwiX19tZXRhZGF0YVwiIHx8XHJcbiAgICAgICAgLy8gRW50aXR5S2V5IHByb3BlcnRpZXMgY2FuIGJlIHByb2R1Y2VkIGJ5IEVETVggbW9kZWxzXHJcbiAgICAgICAgKHByb3BlcnR5TmFtZSA9PT0gXCJFbnRpdHlLZXlcIiAmJiBub2RlLiR0eXBlICYmIGNvcmUuc3RyaW5nU3RhcnRzV2l0aChub2RlLiR0eXBlLCBcIlN5c3RlbS5EYXRhXCIpKTtcclxuICAgICAgcmV0dXJuIHJlc3VsdDtcclxuICAgIH1cclxuXHJcbiAgfSk7XHJcblxyXG4gIGdldEFic29sdXRlVXJsKGRhdGFTZXJ2aWNlOiBicmVlemUuRGF0YVNlcnZpY2UsIHVybDogc3RyaW5nKSB7XHJcbiAgICBsZXQgc2VydmljZU5hbWUgPSBkYXRhU2VydmljZS5xdWFsaWZ5VXJsKCcnKTtcclxuICAgIC8vIG9ubHkgcHJlZml4IHdpdGggc2VydmljZU5hbWUgaWYgbm90IGFscmVhZHkgb24gdGhlIHVybFxyXG4gICAgbGV0IGJhc2UgPSAoY29yZS5zdHJpbmdTdGFydHNXaXRoKHVybCwgc2VydmljZU5hbWUpKSA/ICcnIDogc2VydmljZU5hbWU7XHJcbiAgICAvLyBJZiBubyBwcm90b2NvbCwgdHVybiBiYXNlIGludG8gYW4gYWJzb2x1dGUgVVJJXHJcbiAgICBpZiAod2luZG93ICYmIHNlcnZpY2VOYW1lLmluZGV4T2YoJy8vJykgPCAwKSB7XHJcbiAgICAgIC8vIG5vIHByb3RvY29sOyBtYWtlIGl0IGFic29sdXRlXHJcbiAgICAgIGJhc2UgPSB3aW5kb3cubG9jYXRpb24ucHJvdG9jb2wgKyAnLy8nICsgd2luZG93LmxvY2F0aW9uLmhvc3QgK1xyXG4gICAgICAgIChjb3JlLnN0cmluZ1N0YXJ0c1dpdGgoc2VydmljZU5hbWUsICcvJykgPyAnJyA6ICcvJykgK1xyXG4gICAgICAgIGJhc2U7XHJcbiAgICB9XHJcbiAgICByZXR1cm4gYmFzZSArIHVybDtcclxuICB9XHJcblxyXG4gIGdldFJvdXRlUHJlZml4KGRhdGFTZXJ2aWNlOiBicmVlemUuRGF0YVNlcnZpY2UpIHtcclxuICAgIC8vIEdldCB0aGUgcm91dGVQcmVmaXggZnJvbSBhIFdlYiBBUEkgT0RhdGEgc2VydmljZSBuYW1lLlxyXG4gICAgLy8gVGhlIHJvdXRlUHJlZml4IGlzIHByZXN1bWVkIHRvIGJlIHRoZSBwYXRobmFtZSB3aXRoaW4gdGhlIGRhdGFTZXJ2aWNlLnNlcnZpY2VOYW1lXHJcbiAgICAvLyBFeGFtcGxlcyBvZiBzZXJ2aWNlbmFtZSAtPiByb3V0ZVByZWZpeDpcclxuICAgIC8vICAgJ2h0dHA6Ly9sb2NhbGhvc3Q6NTU4MDIvb2RhdGEvJyAtPiAnb2RhdGEvJ1xyXG4gICAgLy8gICAnaHR0cDovLzE5OC4xNTQuMTIxLjc1L3NlcnZpY2Uvb2RhdGEvJyAtPiAnc2VydmljZS9vZGF0YS8nXHJcbiAgICBsZXQgcGFyc2VyOiBhbnk7XHJcbiAgICBpZiAodHlwZW9mIGRvY3VtZW50ID09PSAnb2JqZWN0JykgeyAvLyBicm93c2VyXHJcbiAgICAgIHBhcnNlciA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2EnKTtcclxuICAgICAgcGFyc2VyLmhyZWYgPSBkYXRhU2VydmljZS5zZXJ2aWNlTmFtZTtcclxuICAgIH0gZWxzZSB7IC8vIG5vZGVcclxuICAgICAgLy8gVE9ETzogaG93IHRvIGJlc3QgaGFuZGxlIHRoaXNcclxuICAgICAgLy8gYXNzdW1lcyBleGlzdGVuY2Ugb2Ygbm9kZSdzIHVybC5wYXJzZSBtZXRob2QuXHJcbiAgICAgIHBhcnNlciA9IHVybC5wYXJzZShkYXRhU2VydmljZS5zZXJ2aWNlTmFtZSk7XHJcbiAgICB9XHJcbiAgICBsZXQgcHJlZml4ID0gcGFyc2VyLnBhdGhuYW1lO1xyXG4gICAgaWYgKHByZWZpeFswXSA9PT0gJy8nKSB7XHJcbiAgICAgIHByZWZpeCA9IHByZWZpeC5zdWJzdHIoMSk7XHJcbiAgICB9IC8vIGRyb3AgbGVhZGluZyAnLycgIChhbGwgYnV0IElFKVxyXG4gICAgaWYgKHByZWZpeC5zdWJzdHIoLTEpICE9PSAnLycpIHtcclxuICAgICAgcHJlZml4ICs9ICcvJztcclxuICAgIH0gICAgICAvLyBlbnN1cmUgdHJhaWxpbmcgJy8nXHJcbiAgICByZXR1cm4gcHJlZml4O1xyXG4gIH1cclxuXHJcbn1cclxuXHJcbi8vIGNydWRlIHNlcmlhbGl6ZXIuICBEb2Vzbid0IHJlY3Vyc2VcclxuZnVuY3Rpb24gdG9RdWVyeVN0cmluZyhvYmo6IE9iamVjdCkge1xyXG4gIGxldCBwYXJ0czogc3RyaW5nW10gPSBbXTtcclxuICBmb3IgKGxldCBpIGluIG9iaikge1xyXG4gICAgaWYgKG9iai5oYXNPd25Qcm9wZXJ0eShpKSkge1xyXG4gICAgICBwYXJ0cy5wdXNoKGVuY29kZVVSSUNvbXBvbmVudChpKSArIFwiPVwiICsgZW5jb2RlVVJJQ29tcG9uZW50KG9ialtpXSkpO1xyXG4gICAgfVxyXG4gIH1cclxuICByZXR1cm4gcGFydHMuam9pbihcIiZcIik7XHJcbn1cclxuXHJcbmZ1bmN0aW9uIHRyYW5zZm9ybVZhbHVlKHByb3A6IGJyZWV6ZS5EYXRhUHJvcGVydHksIHZhbDogYW55KSB7XHJcbiAgaWYgKHByb3AuaXNVbm1hcHBlZCkgcmV0dXJuIHVuZGVmaW5lZDtcclxuICBpZiAocHJvcC5kYXRhVHlwZSA9PT0gYnJlZXplLkRhdGFUeXBlLkRhdGVUaW1lT2Zmc2V0KSB7XHJcbiAgICAvLyBUaGUgZGF0YWpzIGxpYiB0cmllcyB0byB0cmVhdCBjbGllbnQgZGF0ZVRpbWVzIHRoYXQgYXJlIGRlZmluZWQgYXMgRGF0ZVRpbWVPZmZzZXQgb24gdGhlIHNlcnZlciBkaWZmZXJlbnRseVxyXG4gICAgLy8gZnJvbSBvdGhlciBkYXRlVGltZXMuIFRoaXMgZml4IGNvbXBlbnNhdGVzIGJlZm9yZSB0aGUgc2F2ZS5cclxuICAgIHZhbCA9IHZhbCAmJiBuZXcgRGF0ZSh2YWwuZ2V0VGltZSgpIC0gKHZhbC5nZXRUaW1lem9uZU9mZnNldCgpICogNjAwMDApKTtcclxuICB9IGVsc2UgaWYgKChwcm9wLmRhdGFUeXBlIGFzIGJyZWV6ZS5EYXRhVHlwZSkucXVvdGVKc29uT0RhdGEpIHtcclxuICAgIHZhbCA9IHZhbCAhPSBudWxsID8gdmFsLnRvU3RyaW5nKCkgOiB2YWw7XHJcbiAgfVxyXG4gIHJldHVybiB2YWw7XHJcbn1cclxuXHJcbmZ1bmN0aW9uIGNyZWF0ZUNoYW5nZVJlcXVlc3RzKHNhdmVDb250ZXh0OiBPRGF0YVNhdmVDb250ZXh0LCBzYXZlQnVuZGxlOiBicmVlemUuU2F2ZUJ1bmRsZSkge1xyXG4gIGxldCBjaGFuZ2VSZXF1ZXN0SW50ZXJjZXB0b3IgPSAoc2F2ZUNvbnRleHQuYWRhcHRlciBhcyBEYXRhU2VydmljZU9EYXRhQWRhcHRlcikuX2NyZWF0ZUNoYW5nZVJlcXVlc3RJbnRlcmNlcHRvcihzYXZlQ29udGV4dCwgc2F2ZUJ1bmRsZSk7XHJcbiAgbGV0IGNoYW5nZVJlcXVlc3RzOiBhbnlbXSA9IFtdO1xyXG4gIGxldCB0ZW1wS2V5czogYnJlZXplLkVudGl0eUtleVtdID0gW107XHJcbiAgbGV0IGNvbnRlbnRLZXlzOiBicmVlemUuRW50aXR5W10gPSBbXTtcclxuICBsZXQgZW50aXR5TWFuYWdlciA9IHNhdmVDb250ZXh0LmVudGl0eU1hbmFnZXI7XHJcbiAgbGV0IGhlbHBlciA9IGVudGl0eU1hbmFnZXIuaGVscGVyO1xyXG4gIGxldCBpZCA9IDA7XHJcbiAgbGV0IHJvdXRlUHJlZml4ID0gc2F2ZUNvbnRleHQucm91dGVQcmVmaXg7XHJcblxyXG4gIHNhdmVCdW5kbGUuZW50aXRpZXMuZm9yRWFjaChmdW5jdGlvbiAoZW50aXR5LCBpbmRleCkge1xyXG4gICAgbGV0IGFzcGVjdCA9IGVudGl0eS5lbnRpdHlBc3BlY3Q7XHJcbiAgICBpZCA9IGlkICsgMTsgLy8gd2UgYXJlIGRlbGliZXJhdGVseSBza2lwcGluZyBpZD0wIGJlY2F1c2UgQ29udGVudC1JRCA9IDAgc2VlbXMgdG8gYmUgaWdub3JlZC5cclxuICAgIGxldCByZXF1ZXN0ID0geyBoZWFkZXJzOiB7IFwiQ29udGVudC1JRFwiOiBpZCwgXCJEYXRhU2VydmljZVZlcnNpb25cIjogXCIyLjBcIiB9IH0gYXMgYW55O1xyXG4gICAgY29udGVudEtleXNbaWRdID0gZW50aXR5O1xyXG4gICAgaWYgKGFzcGVjdC5lbnRpdHlTdGF0ZS5pc0FkZGVkKCkpIHtcclxuICAgICAgcmVxdWVzdC5yZXF1ZXN0VXJpID0gcm91dGVQcmVmaXggKyBlbnRpdHkuZW50aXR5VHlwZS5kZWZhdWx0UmVzb3VyY2VOYW1lO1xyXG4gICAgICByZXF1ZXN0Lm1ldGhvZCA9IFwiUE9TVFwiO1xyXG4gICAgICByZXF1ZXN0LmRhdGEgPSBoZWxwZXIudW53cmFwSW5zdGFuY2UoZW50aXR5LCB0cmFuc2Zvcm1WYWx1ZSk7XHJcbiAgICAgIHRlbXBLZXlzW2lkXSA9IGFzcGVjdC5nZXRLZXkoKTtcclxuICAgIH0gZWxzZSBpZiAoYXNwZWN0LmVudGl0eVN0YXRlLmlzTW9kaWZpZWQoKSkge1xyXG4gICAgICB1cGRhdGVEZWxldGVNZXJnZVJlcXVlc3QocmVxdWVzdCwgYXNwZWN0LCByb3V0ZVByZWZpeCEpO1xyXG4gICAgICByZXF1ZXN0Lm1ldGhvZCA9IFwiTUVSR0VcIjtcclxuICAgICAgcmVxdWVzdC5kYXRhID0gaGVscGVyLnVud3JhcENoYW5nZWRWYWx1ZXMoZW50aXR5LCBlbnRpdHlNYW5hZ2VyLm1ldGFkYXRhU3RvcmUsIHRyYW5zZm9ybVZhbHVlKTtcclxuICAgICAgLy8gc2hvdWxkIGJlIGEgUEFUQ0gvTUVSR0VcclxuICAgIH0gZWxzZSBpZiAoYXNwZWN0LmVudGl0eVN0YXRlLmlzRGVsZXRlZCgpKSB7XHJcbiAgICAgIHVwZGF0ZURlbGV0ZU1lcmdlUmVxdWVzdChyZXF1ZXN0LCBhc3BlY3QsIHJvdXRlUHJlZml4ISk7XHJcbiAgICAgIHJlcXVlc3QubWV0aG9kID0gXCJERUxFVEVcIjtcclxuICAgIH0gZWxzZSB7XHJcbiAgICAgIHJldHVybjtcclxuICAgIH1cclxuICAgIHJlcXVlc3QgPSBjaGFuZ2VSZXF1ZXN0SW50ZXJjZXB0b3IuZ2V0UmVxdWVzdChyZXF1ZXN0LCBlbnRpdHksIGluZGV4KTtcclxuICAgIGNoYW5nZVJlcXVlc3RzLnB1c2gocmVxdWVzdCk7XHJcbiAgfSk7XHJcbiAgc2F2ZUNvbnRleHQuY29udGVudEtleXMgPSBjb250ZW50S2V5cztcclxuICBzYXZlQ29udGV4dC50ZW1wS2V5cyA9IHRlbXBLZXlzO1xyXG4gIGNoYW5nZVJlcXVlc3RJbnRlcmNlcHRvci5kb25lKGNoYW5nZVJlcXVlc3RzKTtcclxuICByZXR1cm4ge1xyXG4gICAgX19iYXRjaFJlcXVlc3RzOiBbXHJcbiAgICAgIHtcclxuICAgICAgICBfX2NoYW5nZVJlcXVlc3RzOiBjaGFuZ2VSZXF1ZXN0c1xyXG4gICAgICB9XHJcbiAgICBdXHJcbiAgfTtcclxuXHJcbn1cclxuXHJcbmZ1bmN0aW9uIHVwZGF0ZURlbGV0ZU1lcmdlUmVxdWVzdChyZXF1ZXN0OiBhbnksIGFzcGVjdDogYnJlZXplLkVudGl0eUFzcGVjdCwgcm91dGVQcmVmaXg6IHN0cmluZykge1xyXG4gIGxldCB1cmlLZXk6IHN0cmluZztcclxuICBsZXQgZXh0cmFNZXRhZGF0YSA9IGFzcGVjdC5leHRyYU1ldGFkYXRhO1xyXG4gIGlmIChleHRyYU1ldGFkYXRhID09IG51bGwpIHtcclxuICAgIHVyaUtleSA9IGdldFVyaUtleShhc3BlY3QpO1xyXG4gICAgYXNwZWN0LmV4dHJhTWV0YWRhdGEgPSB7XHJcbiAgICAgIHVyaUtleTogdXJpS2V5XHJcbiAgICB9O1xyXG4gIH0gZWxzZSB7XHJcbiAgICB1cmlLZXkgPSBleHRyYU1ldGFkYXRhLnVyaUtleTtcclxuICAgIGlmIChleHRyYU1ldGFkYXRhLmV0YWcpIHtcclxuICAgICAgcmVxdWVzdC5oZWFkZXJzW1wiSWYtTWF0Y2hcIl0gPSBleHRyYU1ldGFkYXRhLmV0YWc7XHJcbiAgICB9XHJcbiAgfVxyXG4gIHJlcXVlc3QucmVxdWVzdFVyaSA9XHJcbiAgICAvLyB1c2Ugcm91dGVQcmVmaXggaWYgdXJpS2V5IGxhY2tzIHByb3RvY29sIChpLmUuLCByZWxhdGl2ZSB1cmkpXHJcbiAgICB1cmlLZXkuaW5kZXhPZignLy8nKSA+IDAgPyB1cmlLZXkgOiByb3V0ZVByZWZpeCArIHVyaUtleTtcclxufVxyXG5cclxuZnVuY3Rpb24gZ2V0VXJpS2V5KGFzcGVjdDogYnJlZXplLkVudGl0eUFzcGVjdCkge1xyXG4gIGxldCBlbnRpdHlUeXBlID0gYXNwZWN0LmVudGl0eSEuZW50aXR5VHlwZTtcclxuICBsZXQgcmVzb3VyY2VOYW1lID0gZW50aXR5VHlwZS5kZWZhdWx0UmVzb3VyY2VOYW1lO1xyXG4gIGxldCBrcHMgPSBlbnRpdHlUeXBlLmtleVByb3BlcnRpZXM7XHJcbiAgbGV0IHVyaUtleSA9IHJlc291cmNlTmFtZSArIFwiKFwiO1xyXG4gIGlmIChrcHMubGVuZ3RoID09PSAxKSB7XHJcbiAgICB1cmlLZXkgPSB1cmlLZXkgKyBmbXRQcm9wZXJ0eShrcHNbMF0sIGFzcGVjdCkgKyBcIilcIjtcclxuICB9IGVsc2Uge1xyXG4gICAgbGV0IGRlbGltID0gXCJcIjtcclxuICAgIGtwcy5mb3JFYWNoKGZ1bmN0aW9uIChrcCkge1xyXG4gICAgICB1cmlLZXkgPSB1cmlLZXkgKyBkZWxpbSArIGtwLm5hbWVPblNlcnZlciArIFwiPVwiICsgZm10UHJvcGVydHkoa3AsIGFzcGVjdCk7XHJcbiAgICAgIGRlbGltID0gXCIsXCI7XHJcbiAgICB9KTtcclxuICAgIHVyaUtleSA9IHVyaUtleSArIFwiKVwiO1xyXG4gIH1cclxuICByZXR1cm4gdXJpS2V5O1xyXG59XHJcblxyXG5mdW5jdGlvbiBmbXRQcm9wZXJ0eShwcm9wOiBicmVlemUuRGF0YVByb3BlcnR5LCBhc3BlY3Q6IGJyZWV6ZS5FbnRpdHlBc3BlY3QpIHtcclxuICByZXR1cm4gKHByb3AuZGF0YVR5cGUgYXMgYnJlZXplLkRhdGFUeXBlKS5mbXRPRGF0YSEoYXNwZWN0LmdldFByb3BlcnR5VmFsdWUocHJvcC5uYW1lKSk7XHJcbn1cclxuXHJcbmZ1bmN0aW9uIGNyZWF0ZUVycm9yKGVycm9yOiBhbnksIHVybDogc3RyaW5nKSB7XHJcbiAgLy8gT0RhdGEgZXJyb3JzIGNhbiBoYXZlIHRoZSBtZXNzYWdlIGJ1cmllZCB2ZXJ5IGRlZXBseSAtIGFuZCBub25vYnZpb3VzbHlcclxuICAvLyB0aGlzIGNvZGUgaXMgdHJpY2t5IHNvIGJlIGNhcmVmdWwgY2hhbmdpbmcgdGhlIHJlc3BvbnNlLmJvZHkgcGFyc2luZy5cclxuICBsZXQgcmVzdWx0ID0gbmV3IEVycm9yKCkgYXMgYnJlZXplLlNlcnZlckVycm9yO1xyXG4gIGxldCByZXNwb25zZSA9IGVycm9yICYmIGVycm9yLnJlc3BvbnNlO1xyXG4gIGlmICghcmVzcG9uc2UpIHtcclxuICAgIC8vIGluIGNhc2UgRGF0YUpTIHJldHVybnMgXCJObyBoYW5kbGVyIGZvciB0aGlzIGRhdGFcIlxyXG4gICAgcmVzdWx0Lm1lc3NhZ2UgPSBlcnJvcjtcclxuICAgIHJlc3VsdC5zdGF0dXNUZXh0ID0gZXJyb3I7XHJcbiAgICByZXR1cm4gcmVzdWx0O1xyXG4gIH1cclxuICByZXN1bHQubWVzc2FnZSA9IHJlc3BvbnNlLnN0YXR1c1RleHQ7XHJcbiAgcmVzdWx0LnN0YXR1c1RleHQgPSByZXNwb25zZS5zdGF0dXNUZXh0O1xyXG4gIHJlc3VsdC5zdGF0dXMgPSByZXNwb25zZS5zdGF0dXNDb2RlO1xyXG4gIC8vIG5vbiBzdGRcclxuICBpZiAodXJsKSByZXN1bHQudXJsID0gdXJsO1xyXG4gIHJlc3VsdC5ib2R5ID0gcmVzcG9uc2UuYm9keTtcclxuICBpZiAocmVzcG9uc2UuYm9keSkge1xyXG4gICAgbGV0IG5leHRFcnI6IGFueTtcclxuICAgIHRyeSB7XHJcbiAgICAgIGxldCBib2R5ID0gSlNPTi5wYXJzZShyZXNwb25zZS5ib2R5KTtcclxuICAgICAgcmVzdWx0LmJvZHkgPSBib2R5O1xyXG4gICAgICAvLyBPRGF0YSB2MyBsb2dpY1xyXG4gICAgICBpZiAoYm9keVsnb2RhdGEuZXJyb3InXSkge1xyXG4gICAgICAgIGJvZHkgPSBib2R5WydvZGF0YS5lcnJvciddO1xyXG4gICAgICB9XHJcbiAgICAgIGxldCBtc2cgPSBcIlwiO1xyXG4gICAgICBkbyB7XHJcbiAgICAgICAgbmV4dEVyciA9IGJvZHkuZXJyb3IgfHwgYm9keS5pbm5lcmVycm9yO1xyXG4gICAgICAgIGlmICghbmV4dEVycikgbXNnID0gbXNnICsgZ2V0TWVzc2FnZShib2R5KTtcclxuICAgICAgICBuZXh0RXJyID0gbmV4dEVyciB8fCBib2R5LmludGVybmFsZXhjZXB0aW9uO1xyXG4gICAgICAgIGJvZHkgPSBuZXh0RXJyIHx8IGJvZHk7XHJcbiAgICAgIH0gd2hpbGUgKG5leHRFcnIpO1xyXG4gICAgICBpZiAobXNnLmxlbmd0aCA+IDApIHtcclxuICAgICAgICByZXN1bHQubWVzc2FnZSA9IG1zZztcclxuICAgICAgfVxyXG4gICAgfSBjYXRjaCAoZSkge1xyXG5cclxuICAgIH1cclxuICB9XHJcbiAgYnJlZXplLkFic3RyYWN0RGF0YVNlcnZpY2VBZGFwdGVyLl9jYXRjaE5vQ29ubmVjdGlvbkVycm9yKHJlc3VsdCk7XHJcbiAgcmV0dXJuIHJlc3VsdDtcclxufVxyXG5cclxuZnVuY3Rpb24gZ2V0TWVzc2FnZShib2R5OiBhbnkpIHtcclxuICBsZXQgbXNnID0gYm9keS5tZXNzYWdlIHx8IFwiXCI7XHJcbiAgcmV0dXJuICgodHlwZW9mIChtc2cpID09PSBcInN0cmluZ1wiKSA/IG1zZyA6IG1zZy52YWx1ZSkgKyBcIjsgXCI7XHJcbn1cclxuXHJcbmJyZWV6ZS5jb25maWcucmVnaXN0ZXJBZGFwdGVyKFwiZGF0YVNlcnZpY2VcIiwgRGF0YVNlcnZpY2VPRGF0YUFkYXB0ZXIpO1xyXG5cclxuXHJcbmxldCB3ZWJBcGlPRGF0YUN0b3IgPSBmdW5jdGlvbiAoKSB7XHJcbiAgdGhpcy5uYW1lID0gXCJ3ZWJBcGlPRGF0YVwiO1xyXG59O1xyXG5cclxuYnJlZXplLmNvcmUuZXh0ZW5kKHdlYkFwaU9EYXRhQ3Rvci5wcm90b3R5cGUsIERhdGFTZXJ2aWNlT0RhdGFBZGFwdGVyLnByb3RvdHlwZSk7XHJcblxyXG5icmVlemUuY29uZmlnLnJlZ2lzdGVyQWRhcHRlcihcImRhdGFTZXJ2aWNlXCIsIHdlYkFwaU9EYXRhQ3RvciBhcyBhbnkpO1xyXG4vLyBPRGF0YSA0IGFkYXB0ZXJcclxubGV0IHdlYkFwaU9EYXRhNEN0b3IgPSBmdW5jdGlvbiAoKSB7XHJcbiAgdGhpcy5uYW1lID0gXCJ3ZWJBcGlPRGF0YTRcIjtcclxufTtcclxuYnJlZXplLmNvcmUuZXh0ZW5kKHdlYkFwaU9EYXRhNEN0b3IucHJvdG90eXBlLCB3ZWJBcGlPRGF0YUN0b3IucHJvdG90eXBlKTtcclxud2ViQXBpT0RhdGE0Q3Rvci5wcm90b3R5cGUuaW5pdGlhbGl6ZSA9IGZ1bmN0aW9uICgpIHtcclxuICAvLyBBYXJnaC4uLiB0aGV5IG1vdmVkIHRoZSBjaGVlc2UuXHJcbiAgbGV0IGRhdGFqcyA9IGNvcmUucmVxdWlyZUxpYihcImRhdGFqc1wiLCBcIk5lZWRlZCB0byBzdXBwb3J0IHJlbW90ZSBPRGF0YSB2NCBzZXJ2aWNlc1wiKTtcclxuICBPRGF0YSA9IGRhdGFqcy5WNC5vRGF0YTtcclxuICBPRGF0YS5qc29uLmpzb25IYW5kbGVyLnJlY29nbml6ZURhdGVzID0gdHJ1ZTtcclxufTtcclxud2ViQXBpT0RhdGE0Q3Rvci5wcm90b3R5cGUuaGVhZGVycyA9IHsgXCJPRGF0YS1WZXJzaW9uXCI6IFwiNC4wXCIgfTtcclxuYnJlZXplLmNvbmZpZy5yZWdpc3RlckFkYXB0ZXIoXCJkYXRhU2VydmljZVwiLCB3ZWJBcGlPRGF0YTRDdG9yIGFzIGFueSk7XHJcblxyXG5cclxuXHJcblxyXG4iXX0=