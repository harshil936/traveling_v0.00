import * as breeze from 'breeze-client';
let core = breeze.core;
export class AjaxAngularjsAdapter {
    constructor() {
        this.name = "angularjs";
        this.defaultSettings = {};
        this.requestInterceptor = undefined;
        // Will set:
        //   this.$http;
        //   this.$rootScope;
    }
    static register(config) {
        config = config || breeze.config;
        config.registerAdapter("ajax", AjaxAngularjsAdapter);
        return config.initializeAdapterInstance("ajax", "angularjs", true);
    }
    initialize() {
        let ng = breeze.core.requireLib("angular");
        if (ng) {
            let $injector = ng.injector(['ng']);
            let http, rootScope;
            $injector.invoke(['$http', '$rootScope', function ($http, $rootScope) {
                    http = $http;
                    rootScope = $rootScope;
                }]);
            this.$http = http;
            this.$rootScope = rootScope;
        }
    }
    setHttp(http) {
        this.$http = http;
        this.$rootScope = null; // to suppress $rootScope.digest
    }
    ajax(config) {
        if (!this.$http) {
            throw new Error("Unable to locate angularjs for ajax adapter");
        }
        let ngConfig = {
            method: config.type,
            url: config.url,
            dataType: config.dataType,
            contentType: config.contentType,
            crossDomain: config.crossDomain,
            headers: config.headers || {},
            data: undefined
        };
        if (config.params) {
            // Hack: because of the way that Angular handles writing parameters out to the url.
            // so this approach takes over the url param writing completely.
            // See: http://victorblog.com/2012/12/20/make-angularjs-http-service-behave-like-jquery-ajax/
            let delim = (ngConfig.url.indexOf("?") >= 0) ? "&" : "?";
            ngConfig.url = ngConfig.url + delim + encodeParams(config.params);
        }
        if (config.data) {
            ngConfig.data = config.data;
        }
        if (!core.isEmpty(this.defaultSettings)) {
            let compositeConfig = core.extend({}, this.defaultSettings);
            ngConfig = core.extend(compositeConfig, ngConfig);
            // extend is shallow; extend headers separately
            let headers = core.extend({}, this.defaultSettings.headers); // copy default headers 1st
            ngConfig.headers = core.extend(headers, ngConfig.headers);
        }
        let requestInfo = {
            adapter: this,
            config: ngConfig,
            dsaConfig: config,
            success: successFn,
            error: errorFn,
            responseSuccess: responseSuccessFn,
            responseError: responseErrorFn // adapter's error callback (ng 1.6+)
        };
        if (core.isFunction(this.requestInterceptor)) {
            let ri = this.requestInterceptor;
            ri(requestInfo);
            if (ri.oneTime) {
                this.requestInterceptor = undefined;
            }
        }
        if (requestInfo.config) { // exists unless requestInterceptor killed it.
            let prom = this.$http(requestInfo.config);
            if (prom.success) {
                // response for ng < 1.6        
                prom.success(requestInfo.success).error(requestInfo.error);
            }
            else {
                // response for ng 1.6+
                prom.then(requestInfo.responseSuccess).catch(requestInfo.responseError);
            }
            this.$rootScope && this.$rootScope.$digest();
        }
        function responseSuccessFn(response) {
            return successFn(response.data, response.status, response.headers, response.config, response.statusText);
        }
        function successFn(data, status, headers, xconfig, statusText) {
            // HACK: because $http returns a server side null as a string containing "null" - this is WRONG.
            if (data === "null")
                data = null;
            let httpResponse = {
                config: config,
                data: data,
                getHeaders: headers,
                ngConfig: xconfig,
                status: status,
                statusText: statusText
            };
            config.success(httpResponse);
        }
        function responseErrorFn(response) {
            return errorFn(response.data, response.status, response.headers, response.config, response.statusText);
        }
        function errorFn(data, status, headers, xconfig, statusText) {
            // Timeout appears as an error with status===0 and no data.
            // Make it better
            if (status === 0 && data == null) {
                data = 'timeout';
            }
            let httpResponse = {
                config: config,
                data: data,
                getHeaders: headers,
                ngConfig: xconfig,
                status: status,
                statusText: statusText
            };
            config.error(httpResponse);
        }
    }
}
breeze.config.registerAdapter("ajax", AjaxAngularjsAdapter);
function encodeParams(obj) {
    let query = '';
    let subValue, innerObj, fullSubName;
    for (let name in obj) {
        let value = obj[name];
        if (value instanceof Array) {
            for (let i = 0; i < value.length; ++i) {
                subValue = value[i];
                fullSubName = name + '[' + i + ']';
                innerObj = {};
                innerObj[fullSubName] = subValue;
                query += encodeParams(innerObj) + '&';
            }
        }
        else if (value && value.toISOString) { // a feature of Date-like things
            query += encodeURIComponent(name) + '=' + encodeURIComponent(value.toISOString()) + '&';
        }
        else if (value instanceof Object) {
            for (let subName in value) {
                subValue = value[subName];
                fullSubName = name + '[' + subName + ']';
                innerObj = {};
                innerObj[fullSubName] = subValue;
                query += encodeParams(innerObj) + '&';
            }
        }
        else if (value === null) {
            query += encodeURIComponent(name) + '=&';
        }
        else if (value !== undefined) {
            query += encodeURIComponent(name) + '=' + encodeURIComponent(value) + '&';
        }
    }
    return query.length ? query.substr(0, query.length - 1) : query;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYWRhcHRlci1hamF4LWFuZ3VsYXJqcy5qcyIsInNvdXJjZVJvb3QiOiJuZzovL2JyZWV6ZS1jbGllbnQvYWRhcHRlci1hamF4LWFuZ3VsYXJqcy8iLCJzb3VyY2VzIjpbImFkYXB0ZXItYWpheC1hbmd1bGFyanMudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxLQUFLLE1BQU0sTUFBTSxlQUFlLENBQUM7QUFFeEMsSUFBSSxJQUFJLEdBQUcsTUFBTSxDQUFDLElBQUksQ0FBQztBQUV2QixNQUFNLE9BQU8sb0JBQW9CO0lBTS9CO1FBQ0UsSUFBSSxDQUFDLElBQUksR0FBRyxXQUFXLENBQUM7UUFDeEIsSUFBSSxDQUFDLGVBQWUsR0FBRyxFQUFFLENBQUM7UUFDMUIsSUFBSSxDQUFDLGtCQUFrQixHQUFHLFNBQVMsQ0FBQztRQUNwQyxZQUFZO1FBQ1osZ0JBQWdCO1FBQ2hCLHFCQUFxQjtJQUN2QixDQUFDO0lBRUQsTUFBTSxDQUFDLFFBQVEsQ0FBQyxNQUE0QjtRQUMxQyxNQUFNLEdBQUcsTUFBTSxJQUFJLE1BQU0sQ0FBQyxNQUFNLENBQUM7UUFDakMsTUFBTSxDQUFDLGVBQWUsQ0FBQyxNQUFNLEVBQUUsb0JBQW9CLENBQUMsQ0FBQztRQUNyRCxPQUFPLE1BQU0sQ0FBQyx5QkFBeUIsQ0FBQyxNQUFNLEVBQUUsV0FBVyxFQUFFLElBQUksQ0FBeUIsQ0FBQztJQUM3RixDQUFDO0lBRUQsVUFBVTtRQUVSLElBQUksRUFBRSxHQUFHLE1BQU0sQ0FBQyxJQUFJLENBQUMsVUFBVSxDQUFDLFNBQVMsQ0FBQyxDQUFDO1FBQzNDLElBQUksRUFBRSxFQUFFO1lBQ04sSUFBSSxTQUFTLEdBQUcsRUFBRSxDQUFDLFFBQVEsQ0FBQyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUM7WUFDcEMsSUFBSSxJQUFTLEVBQUUsU0FBYyxDQUFDO1lBQzlCLFNBQVMsQ0FBQyxNQUFNLENBQUMsQ0FBQyxPQUFPLEVBQUUsWUFBWSxFQUFFLFVBQVUsS0FBVSxFQUFFLFVB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QUFHLEdBQUcsR0FBRyxrQkFBa0IsQ0FBQyxLQUFLLENBQUMsR0FBRyxHQUFHLENBQUM7U0FDM0U7S0FDRjtJQUVELE9BQU8sS0FBSyxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUMsS0FBSyxDQUFDLE1BQU0sQ0FBQyxDQUFDLEVBQUUsS0FBSyxDQUFDLE1BQU0sR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsS0FBSyxDQUFDO0FBQ2xFLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgKiBhcyBicmVlemUgZnJvbSAnYnJlZXplLWNsaWVudCc7XHJcblxyXG5sZXQgY29yZSA9IGJyZWV6ZS5jb3JlO1xyXG5cclxuZXhwb3J0IGNsYXNzIEFqYXhBbmd1bGFyanNBZGFwdGVyIGltcGxlbWVudHMgYnJlZXplLkFqYXhBZGFwdGVyIHtcclxuICBuYW1lOiBzdHJpbmc7XHJcbiAgZGVmYXVsdFNldHRpbmdzOiB7IGhlYWRlcnM/OiBhbnkgfTtcclxuICByZXF1ZXN0SW50ZXJjZXB0b3I/OiAoKCkgPT4gYnJlZXplLkNoYW5nZVJlcXVlc3RJbnRlcmNlcHRvcikgfCBicmVlemUuQ2hhbmdlUmVxdWVzdEludGVyY2VwdG9yO1xyXG4gICRodHRwOiBhbnk7XHJcbiAgJHJvb3RTY29wZTogYW55O1xyXG4gIGNvbnN0cnVjdG9yKCkge1xyXG4gICAgdGhpcy5uYW1lID0gXCJhbmd1bGFyanNcIjtcclxuICAgIHRoaXMuZGVmYXVsdFNldHRpbmdzID0ge307XHJcbiAgICB0aGlzLnJlcXVlc3RJbnRlcmNlcHRvciA9IHVuZGVmaW5lZDtcclxuICAgIC8vIFdpbGwgc2V0OlxyXG4gICAgLy8gICB0aGlzLiRodHRwO1xyXG4gICAgLy8gICB0aGlzLiRyb290U2NvcGU7XHJcbiAgfVxyXG5cclxuICBzdGF0aWMgcmVnaXN0ZXIoY29uZmlnPzogYnJlZXplLkJyZWV6ZUNvbmZpZykge1xyXG4gICAgY29uZmlnID0gY29uZmlnIHx8IGJyZWV6ZS5jb25maWc7XHJcbiAgICBjb25maWcucmVnaXN0ZXJBZGFwdGVyKFwiYWpheFwiLCBBamF4QW5ndWxhcmpzQWRhcHRlcik7XHJcbiAgICByZXR1cm4gY29uZmlnLmluaXRpYWxpemVBZGFwdGVySW5zdGFuY2UoXCJhamF4XCIsIFwiYW5ndWxhcmpzXCIsIHRydWUpIGFzIEFqYXhBbmd1bGFyanNBZGFwdGVyO1xyXG4gIH1cclxuXHJcbiAgaW5pdGlhbGl6ZSgpIHtcclxuXHJcbiAgICBsZXQgbmcgPSBicmVlemUuY29yZS5yZXF1aXJlTGliKFwiYW5ndWxhclwiKTtcclxuICAgIGlmIChuZykge1xyXG4gICAgICBsZXQgJGluamVjdG9yID0gbmcuaW5qZWN0b3IoWyduZyddKTtcclxuICAgICAgbGV0IGh0dHA6IGFueSwgcm9vdFNjb3BlOiBhbnk7XHJcbiAgICAgICRpbmplY3Rvci5pbnZva2UoWyckaHR0cCcsICckcm9vdFNjb3BlJywgZnVuY3Rpb24gKCRodHRwOiBhbnksICRyb290U2NvcGU6IGFueSkge1xyXG4gICAgICAgIGh0dHAgPSAkaHR0cDtcclxuICAgICAgICByb290U2NvcGUgPSAkcm9vdFNjb3BlO1xyXG4gICAgICB9XSk7XHJcbiAgICAgIHRoaXMuJGh0dHAgPSBodHRwO1xyXG4gICAgICB0aGlzLiRyb290U2NvcGUgPSByb290U2NvcGU7XHJcbiAgICB9XHJcblxyXG4gIH1cclxuXHJcbiAgc2V0SHR0cChodHRwOiBhbnkpIHtcclxuICAgIHRoaXMuJGh0dHAgPSBodHRwO1xyXG4gICAgdGhpcy4kcm9vdFNjb3BlID0gbnVsbDsgLy8gdG8gc3VwcHJlc3MgJHJvb3RTY29wZS5kaWdlc3RcclxuICB9XHJcblxyXG5cclxuICBhamF4KGNvbmZpZzogYW55KSB7XHJcbiAgICBpZiAoIXRoaXMuJGh0dHApIHtcclxuICAgICAgdGhyb3cgbmV3IEVycm9yKFwiVW5hYmxlIHRvIGxvY2F0ZSBhbmd1bGFyanMgZm9yIGFqYXggYWRhcHRlclwiKTtcclxuICAgIH1cclxuICAgIGxldCBuZ0NvbmZpZyA9IHtcclxuICAgICAgbWV0aG9kOiBjb25maWcudHlwZSxcclxuICAgICAgdXJsOiBjb25maWcudXJsLFxyXG4gICAgICBkYXRhVHlwZTogY29uZmlnLmRhdGFUeXBlLFxyXG4gICAgICBjb250ZW50VHlwZTogY29uZmlnLmNvbnRlbnRUeXBlLFxyXG4gICAgICBjcm9zc0RvbWFpbjogY29uZmlnLmNyb3NzRG9tYWluLFxyXG4gICAgICBoZWFkZXJzOiBjb25maWcuaGVhZGVycyB8fCB7fSxcclxuICAgICAgZGF0YTogdW5kZWZpbmVkIGFzIGFueVxyXG4gICAgfTtcclxuXHJcbiAgICBpZiAoY29uZmlnLnBhcmFtcykge1xyXG4gICAgICAvLyBIYWNrOiBiZWNhdXNlIG9mIHRoZSB3YXkgdGhhdCBBbmd1bGFyIGhhbmRsZXMgd3JpdGluZyBwYXJhbWV0ZXJzIG91dCB0byB0aGUgdXJsLlxyXG4gICAgICAvLyBzbyB0aGlzIGFwcHJvYWNoIHRha2VzIG92ZXIgdGhlIHVybCBwYXJhbSB3cml0aW5nIGNvbXBsZXRlbHkuXHJcbiAgICAgIC8vIFNlZTogaHR0cDovL3ZpY3RvcmJsb2cuY29tLzIwMTIvMTIvMjAvbWFrZS1hbmd1bGFyanMtaHR0cC1zZXJ2aWNlLWJlaGF2ZS1saWtlLWpxdWVyeS1hamF4L1xyXG4gICAgICBsZXQgZGVsaW0gPSAobmdDb25maWcudXJsLmluZGV4T2YoXCI/XCIpID49IDApID8gXCImXCIgOiBcIj9cIjtcclxuICAgICAgbmdDb25maWcudXJsID0gbmdDb25maWcudXJsICsgZGVsaW0gKyBlbmNvZGVQYXJhbXMoY29uZmlnLnBhcmFtcyk7XHJcbiAgICB9XHJcblxyXG4gICAgaWYgKGNvbmZpZy5kYXRhKSB7XHJcbiAgICAgIG5nQ29uZmlnLmRhdGEgPSBjb25maWcuZGF0YTtcclxuICAgIH1cclxuXHJcbiAgICBpZiAoIWNvcmUuaXNFbXB0eSh0aGlzLmRlZmF1bHRTZXR0aW5ncykpIHtcclxuICAgICAgbGV0IGNvbXBvc2l0ZUNvbmZpZyA9IGNvcmUuZXh0ZW5kKHt9LCB0aGlzLmRlZmF1bHRTZXR0aW5ncyk7XHJcbiAgICAgIG5nQ29uZmlnID0gY29yZS5leHRlbmQoY29tcG9zaXRlQ29uZmlnLCBuZ0NvbmZpZykgYXMgYW55O1xyXG4gICAgICAvLyBleHRlbmQgaXMgc2hhbGxvdzsgZXh0ZW5kIGhlYWRlcnMgc2VwYXJhdGVseVxyXG4gICAgICBsZXQgaGVhZGVycyA9IGNvcmUuZXh0ZW5kKHt9LCB0aGlzLmRlZmF1bHRTZXR0aW5ncy5oZWFkZXJzKTsgLy8gY29weSBkZWZhdWx0IGhlYWRlcnMgMXN0XHJcbiAgICAgIG5nQ29uZmlnLmhlYWRlcnMgPSBjb3JlLmV4dGVuZChoZWFkZXJzLCBuZ0NvbmZpZy5oZWFkZXJzKTtcclxuICAgIH1cclxuXHJcbiAgICBsZXQgcmVxdWVzdEluZm8gPSB7XHJcbiAgICAgIGFkYXB0ZXI6IHRoaXMsICAgICAgLy8gdGhpcyBhZGFwdGVyXHJcbiAgICAgIGNvbmZpZzogbmdDb25maWcsICAgLy8gYW5ndWxhcidzICRodHRwIGNvbmZpZ3VyYXRpb24gb2JqZWN0XHJcbiAgICAgIGRzYUNvbmZpZzogY29uZmlnLCAgLy8gdGhlIGNvbmZpZyBhcmcgZnJvbSB0aGUgY2FsbGluZyBCcmVlemUgRGF0YVNlcnZpY2VBZGFwdGVyXHJcbiAgICAgIHN1Y2Nlc3M6IHN1Y2Nlc3NGbiwgLy8gYWRhcHRlcidzIHN1Y2Nlc3MgY2FsbGJhY2tcclxuICAgICAgZXJyb3I6IGVycm9yRm4sICAgICAgLy8gYWRhcHRlcidzIGVycm9yIGNhbGxiYWNrXHJcbiAgICAgIHJlc3BvbnNlU3VjY2VzczogcmVzcG9uc2VTdWNjZXNzRm4sIC8vIGFkYXB0ZXIncyBzdWNjZXNzIGNhbGxiYWNrIChuZyAxLjYrKVxyXG4gICAgICByZXNwb25zZUVycm9yOiByZXNwb25zZUVycm9yRm4gICAgICAvLyBhZGFwdGVyJ3MgZXJyb3IgY2FsbGJhY2sgKG5nIDEuNispXHJcbiAgICB9O1xyXG5cclxuICAgIGlmIChjb3JlLmlzRnVuY3Rpb24odGhpcy5yZXF1ZXN0SW50ZXJjZXB0b3IpKSB7XHJcbiAgICAgIGxldCByaSA9IHRoaXMucmVxdWVzdEludGVyY2VwdG9yIGFzIGFueTtcclxuICAgICAgcmkocmVxdWVzdEluZm8pO1xyXG4gICAgICBpZiAocmkub25lVGltZSkge1xyXG4gICAgICAgIHRoaXMucmVxdWVzdEludGVyY2VwdG9yID0gdW5kZWZpbmVkO1xyXG4gICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgaWYgKHJlcXVlc3RJbmZvLmNvbmZpZykgeyAvLyBleGlzdHMgdW5sZXNzIHJlcXVlc3RJbnRlcmNlcHRvciBraWxsZWQgaXQuXHJcbiAgICAgIGxldCBwcm9tID0gdGhpcy4kaHR0cChyZXF1ZXN0SW5mby5jb25maWcpO1xyXG4gICAgICBpZiAocHJvbS5zdWNjZXNzKSB7XHJcbiAgICAgICAgLy8gcmVzcG9uc2UgZm9yIG5nIDwgMS42ICAgICAgICBcclxuICAgICAgICBwcm9tLnN1Y2Nlc3MocmVxdWVzdEluZm8uc3VjY2VzcykuZXJyb3IocmVxdWVzdEluZm8uZXJyb3IpO1xyXG4gICAgICB9IGVsc2Uge1xyXG4gICAgICAgIC8vIHJlc3BvbnNlIGZvciBuZyAxLjYrXHJcbiAgICAgICAgcHJvbS50aGVuKHJlcXVlc3RJbmZvLnJlc3BvbnNlU3VjY2VzcykuY2F0Y2gocmVxdWVzdEluZm8ucmVzcG9uc2VFcnJvcik7XHJcbiAgICAgIH1cclxuICAgICAgdGhpcy4kcm9vdFNjb3BlICYmIHRoaXMuJHJvb3RTY29wZS4kZGlnZXN0KCk7XHJcbiAgICB9XHJcblxyXG4gICAgZnVuY3Rpb24gcmVzcG9uc2VTdWNjZXNzRm4ocmVzcG9uc2U6IGFueSkge1xyXG4gICAgICByZXR1cm4gc3VjY2Vzc0ZuKHJlc3BvbnNlLmRhdGEsIHJlc3BvbnNlLnN0YXR1cywgcmVzcG9uc2UuaGVhZGVycywgcmVzcG9uc2UuY29uZmlnLCByZXNwb25zZS5zdGF0dXNUZXh0KTtcclxuICAgIH1cclxuXHJcbiAgICBmdW5jdGlvbiBzdWNjZXNzRm4oZGF0YTogYW55LCBzdGF0dXM6IGFueSwgaGVhZGVyczogYW55LCB4Y29uZmlnOiBhbnksIHN0YXR1c1RleHQ6IHN0cmluZykge1xyXG4gICAgICAvLyBIQUNLOiBiZWNhdXNlICRodHRwIHJldHVybnMgYSBzZXJ2ZXIgc2lkZSBudWxsIGFzIGEgc3RyaW5nIGNvbnRhaW5pbmcgXCJudWxsXCIgLSB0aGlzIGlzIFdST05HLlxyXG4gICAgICBpZiAoZGF0YSA9PT0gXCJudWxsXCIpIGRhdGEgPSBudWxsO1xyXG4gICAgICBsZXQgaHR0cFJlc3BvbnNlID0ge1xyXG4gICAgICAgIGNvbmZpZzogY29uZmlnLFxyXG4gICAgICAgIGRhdGE6IGRhdGEsXHJcbiAgICAgICAgZ2V0SGVhZGVyczogaGVhZGVycyxcclxuICAgICAgICBuZ0NvbmZpZzogeGNvbmZpZyxcclxuICAgICAgICBzdGF0dXM6IHN0YXR1cyxcclxuICAgICAgICBzdGF0dXNUZXh0OiBzdGF0dXNUZXh0XHJcbiAgICAgIH07XHJcbiAgICAgIGNvbmZpZy5zdWNjZXNzKGh0dHBSZXNwb25zZSk7XHJcbiAgICB9XHJcblxyXG4gICAgZnVuY3Rpb24gcmVzcG9uc2VFcnJvckZuKHJlc3BvbnNlOiBhbnkpIHtcclxuICAgICAgcmV0dXJuIGVycm9yRm4ocmVzcG9uc2UuZGF0YSwgcmVzcG9uc2Uuc3RhdHVzLCByZXNwb25zZS5oZWFkZXJzLCByZXNwb25zZS5jb25maWcsIHJlc3BvbnNlLnN0YXR1c1RleHQpO1xyXG4gICAgfVxyXG5cclxuICAgIGZ1bmN0aW9uIGVycm9yRm4oZGF0YTogYW55LCBzdGF0dXM6IGFueSwgaGVhZGVyczogYW55LCB4Y29uZmlnOiBhbnksIHN0YXR1c1RleHQ6IHN0cmluZykge1xyXG4gICAgICAvLyBUaW1lb3V0IGFwcGVhcnMgYXMgYW4gZXJyb3Igd2l0aCBzdGF0dXM9PT0wIGFuZCBubyBkYXRhLlxyXG4gICAgICAvLyBNYWtlIGl0IGJldHRlclxyXG4gICAgICBpZiAoc3RhdHVzID09PSAwICYmIGRhdGEgPT0gbnVsbCkge1xyXG4gICAgICAgIGRhdGEgPSAndGltZW91dCc7XHJcbiAgICAgIH1cclxuICAgICAgbGV0IGh0dHBSZXNwb25zZSA9IHtcclxuICAgICAgICBjb25maWc6IGNvbmZpZyxcclxuICAgICAgICBkYXRhOiBkYXRhLFxyXG4gICAgICAgIGdldEhlYWRlcnM6IGhlYWRlcnMsXHJcbiAgICAgICAgbmdDb25maWc6IHhjb25maWcsXHJcbiAgICAgICAgc3RhdHVzOiBzdGF0dXMsXHJcbiAgICAgICAgc3RhdHVzVGV4dDogc3RhdHVzVGV4dFxyXG4gICAgICB9O1xyXG4gICAgICBjb25maWcuZXJyb3IoaHR0cFJlc3BvbnNlKTtcclxuICAgIH1cclxuICB9XHJcbn1cclxuXHJcbmJyZWV6ZS5jb25maWcucmVnaXN0ZXJBZGFwdGVyKFwiYWpheFwiLCBBamF4QW5ndWxhcmpzQWRhcHRlcik7XHJcblxyXG5mdW5jdGlvbiBlbmNvZGVQYXJhbXMob2JqOiBPYmplY3QpIHtcclxuICBsZXQgcXVlcnkgPSAnJztcclxuICBsZXQgc3ViVmFsdWU6IGFueSwgaW5uZXJPYmo6IE9iamVjdCwgZnVsbFN1Yk5hbWU6IHN0cmluZztcclxuXHJcbiAgZm9yIChsZXQgbmFtZSBpbiBvYmopIHtcclxuICAgIGxldCB2YWx1ZSA9IG9ialtuYW1lXTtcclxuXHJcbiAgICBpZiAodmFsdWUgaW5zdGFuY2VvZiBBcnJheSkge1xyXG4gICAgICBmb3IgKGxldCBpID0gMDsgaSA8IHZhbHVlLmxlbmd0aDsgKytpKSB7XHJcbiAgICAgICAgc3ViVmFsdWUgPSB2YWx1ZVtpXTtcclxuICAgICAgICBmdWxsU3ViTmFtZSA9IG5hbWUgKyAnWycgKyBpICsgJ10nO1xyXG4gICAgICAgIGlubmVyT2JqID0ge307XHJcbiAgICAgICAgaW5uZXJPYmpbZnVsbFN1Yk5hbWVdID0gc3ViVmFsdWU7XHJcbiAgICAgICAgcXVlcnkgKz0gZW5jb2RlUGFyYW1zKGlubmVyT2JqKSArICcmJztcclxuICAgICAgfVxyXG4gICAgfSBlbHNlIGlmICh2YWx1ZSAmJiB2YWx1ZS50b0lTT1N0cmluZykgeyAvLyBhIGZlYXR1cmUgb2YgRGF0ZS1saWtlIHRoaW5nc1xyXG4gICAgICBxdWVyeSArPSBlbmNvZGVVUklDb21wb25lbnQobmFtZSkgKyAnPScgKyBlbmNvZGVVUklDb21wb25lbnQodmFsdWUudG9JU09TdHJpbmcoKSkgKyAnJic7XHJcbiAgICB9IGVsc2UgaWYgKHZhbHVlIGluc3RhbmNlb2YgT2JqZWN0KSB7XHJcbiAgICAgIGZvciAobGV0IHN1Yk5hbWUgaW4gdmFsdWUpIHtcclxuICAgICAgICBzdWJWYWx1ZSA9IHZhbHVlW3N1Yk5hbWVdO1xyXG4gICAgICAgIGZ1bGxTdWJOYW1lID0gbmFtZSArICdbJyArIHN1Yk5hbWUgKyAnXSc7XHJcbiAgICAgICAgaW5uZXJPYmogPSB7fTtcclxuICAgICAgICBpbm5lck9ialtmdWxsU3ViTmFtZV0gPSBzdWJWYWx1ZTtcclxuICAgICAgICBxdWVyeSArPSBlbmNvZGVQYXJhbXMoaW5uZXJPYmopICsgJyYnO1xyXG4gICAgICB9XHJcbiAgICB9IGVsc2UgaWYgKHZhbHVlID09PSBudWxsKSB7XHJcbiAgICAgIHF1ZXJ5ICs9IGVuY29kZVVSSUNvbXBvbmVudChuYW1lKSArICc9Jic7XHJcbiAgICB9IGVsc2UgaWYgKHZhbHVlICE9PSB1bmRlZmluZWQpIHtcclxuICAgICAgcXVlcnkgKz0gZW5jb2RlVVJJQ29tcG9uZW50KG5hbWUpICsgJz0nICsgZW5jb2RlVVJJQ29tcG9uZW50KHZhbHVlKSArICcmJztcclxuICAgIH1cclxuICB9XHJcblxyXG4gIHJldHVybiBxdWVyeS5sZW5ndGggPyBxdWVyeS5zdWJzdHIoMCwgcXVlcnkubGVuZ3RoIC0gMSkgOiBxdWVyeTtcclxufSJdfQ==