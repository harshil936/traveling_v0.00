{"version":3,"file":"breeze-client-adapter-ajax-fetch.js","sources":["ng://breeze-client/adapter-ajax-fetch/adapter-ajax-fetch.ts","ng://breeze-client/adapter-ajax-fetch/breeze-client-adapter-ajax-fetch.ts"],"sourcesContent":["import * as breeze from 'breeze-client';\r\n\r\nlet core = breeze.core;\r\n\r\n/** Breeze AJAX adapter using fetch API \r\n * See https://developer.mozilla.org/en-US/docs/Web/API/Fetch_API/Using_Fetch\r\n*/\r\nexport class AjaxFetchAdapter implements breeze.AjaxAdapter {\r\n  static adapterName = \"fetch\";\r\n  name: string;\r\n  defaultSettings: { headers?: any };\r\n  requestInterceptor?: (() => breeze.ChangeRequestInterceptor) | breeze.ChangeRequestInterceptor;\r\n\r\n  constructor() {\r\n    this.name = AjaxFetchAdapter.adapterName;\r\n    this.defaultSettings = { };\r\n    this.requestInterceptor = undefined;\r\n  }\r\n\r\n  static register(config?: breeze.BreezeConfig) {\r\n    config = config || breeze.config;\r\n    config.registerAdapter(\"ajax\", AjaxFetchAdapter);\r\n    return config.initializeAdapterInstance(\"ajax\", AjaxFetchAdapter.adapterName, true) as AjaxFetchAdapter;\r\n  }\r\n\r\n  initialize() {\r\n  }\r\n\r\n  ajax(config: breeze.AjaxConfig) {\r\n    if (!fetch) {\r\n      throw new Error(\"fetch API not supported in this browser\");\r\n    }\r\n\r\n    let init: RequestInit = {\r\n      method: config.type, // *GET, POST, PUT, DELETE, etc.\r\n      mode: 'cors', // no-cors, *cors, same-origin\r\n      cache: 'no-cache', // *default, no-cache, reload, force-cache, only-if-cached\r\n      credentials: 'include', // include, *same-origin, omit\r\n      headers: {\r\n        'Content-Type': config.contentType || 'application/json',\r\n        // ...config.headers\r\n        // 'Content-Type': 'application/x-www-form-urlencoded',\r\n      },\r\n      redirect: 'follow', // manual, *follow, error\r\n      referrer: 'client', // no-referrer, *client\r\n    };\r\n    if (config.type !== \"GET\" && config.type !== \"HEAD\") {\r\n      // body data type must match \"Content-Type\" header\r\n      // let data = config.params || config.data;\r\n      let data = config.data;\r\n      if (typeof(data) !== \"string\") {\r\n        data = JSON.stringify(data);\r\n      }\r\n      init.body = data;\r\n    }\r\n\r\n    let url = config.url;\r\n    if (!core.isEmpty(config.params)) {\r\n      // Hack: Not sure how Fetch handles writing 'search' parameters to the url.\r\n      // so this approach takes over the url param writing completely.\r\n      let delim = (url.indexOf('?') >= 0) ? '&' : '?';\r\n      url = url + delim + encodeParams(config.params);\r\n    }\r\n\r\n    if (!core.isEmpty(this.defaultSettings)) {\r\n      let compositeConfig = core.extend({}, this.defaultSettings);\r\n      init = core.extend(compositeConfig, init) as any;\r\n      // extend is shallow; extend headers separately\r\n      let headers = core.extend({}, this.defaultSettings.headers); // copy default headers 1st\r\n      init.headers = core.extend(headers, init.headers) as any;\r\n    }\r\n\r\n    let requestInfo = {\r\n      adapter: this,      // this adapter\r\n      config: init,   // fetch api 'init' object\r\n      dsaConfig: config,  // the config arg from the calling Breeze DataServiceAdapter\r\n      success: successFn, // adapter's success callback\r\n      error: errorFn,      // adapter's error callback\r\n    };\r\n\r\n    if (core.isFunction(this.requestInterceptor)) {\r\n      let ri = this.requestInterceptor as any;\r\n      ri(requestInfo);\r\n      if (ri.oneTime) {\r\n        this.requestInterceptor = undefined;\r\n      }\r\n    }\r\n\r\n    if (requestInfo.config) { // exists unless requestInterceptor killed it.\r\n      fetch(url, requestInfo.config).then(response => {\r\n        if (!response.ok) {\r\n          response.text().then(s => {\r\n            requestInfo.error(response.status, response.statusText, s, response, null);\r\n          });\r\n        } else {\r\n          response.json().then(j => {\r\n            requestInfo.success(j, response.statusText, response);\r\n          });\r\n        }\r\n      }).catch(err => {\r\n        requestInfo.error(0, err && err.message || err, null, null, err);\r\n      });\r\n    }\r\n\r\n    function encodeParams(obj: {}) {\r\n      let query = '';\r\n      let subValue: any, innerObj: any, fullSubName: any;\r\n    \r\n      for (let name in obj) {\r\n        if (!obj.hasOwnProperty(name)) { continue; }\r\n    \r\n        let value = obj[name];\r\n    \r\n        if (value instanceof Array) {\r\n          for (let i = 0; i < value.length; ++i) {\r\n            subValue = value[i];\r\n            fullSubName = name + '[' + i + ']';\r\n            innerObj = {};\r\n            innerObj[fullSubName] = subValue;\r\n            query += encodeParams(innerObj) + '&';\r\n          }\r\n        } else if (value && value.toISOString) { // a feature of Date-like things\r\n          query += encodeURIComponent(name) + '=' + encodeURIComponent(value.toISOString()) + '&';\r\n        } else if (value instanceof Object) {\r\n          for (let subName in value) {\r\n            if (obj.hasOwnProperty(name)) {\r\n              subValue = value[subName];\r\n              fullSubName = name + '[' + subName + ']';\r\n              innerObj = {};\r\n              innerObj[fullSubName] = subValue;\r\n              query += encodeParams(innerObj) + '&';\r\n            }\r\n          }\r\n        } else if (value === null) {\r\n          query += encodeURIComponent(name) + '=&';\r\n        } else if (value !== undefined) {\r\n          query += encodeURIComponent(name) + '=' + encodeURIComponent(value) + '&';\r\n        }\r\n      }\r\n    \r\n      return query.length ? query.substr(0, query.length - 1) : query;\r\n    }\r\n\r\n    function successFn(data: any, statusText: string, response: Response) {\r\n      let httpResponse = {\r\n        config: config,\r\n        data: data,\r\n        getHeaders: getHeadersFn(response),\r\n        status: response.status,\r\n        statusText: statusText\r\n      };\r\n      config.success(httpResponse);\r\n    }\r\n\r\n    function errorFn(status: number, statusText: string, body: string, response: Response, errorThrown: any) {\r\n      let httpResponse = {\r\n        config: config,\r\n        data: body,\r\n        error: errorThrown || statusText,\r\n        getHeaders: getHeadersFn(response),\r\n        status: status,\r\n        statusText: statusText\r\n      };\r\n      config.error(httpResponse);\r\n    }\r\n  }\r\n}\r\n\r\nbreeze.config.registerAdapter(\"ajax\", AjaxFetchAdapter);\r\n\r\nfunction getHeadersFn(response: Response): any {\r\n  if (!response || response.status === 0) { // timeout or abort; no headers\r\n    return function (headerName: string) {\r\n      return (headerName && headerName.length > 0) ? \"\" : {};\r\n    };\r\n  } else {\r\n    return function (headerName: string) {\r\n      if (headerName && headerName.length > 0) {\r\n        return response.headers.get(headerName);\r\n      }\r\n      let hob = {};\r\n      response.headers.forEach((val, key) => {\r\n        hob[key] = val;\r\n      });\r\n      return hob;\r\n    };\r\n  }\r\n}\r\n","/**\n * Generated bundle index. Do not edit.\n */\n\nexport * from './adapter-ajax-fetch';\n"],"names":["breeze.core","config","breeze.config"],"mappings":"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"}