!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("breeze-client")):"function"==typeof define&&define.amd?define("breeze-client/mixin-save-queuing",["exports","breeze-client"],t):t(((e=e||self)["breeze-client"]=e["breeze-client"]||{},e["breeze-client"]["mixin-save-queuing"]={}),e["breeze-client"])}(this,(function(e,t){"use strict";
/*! *****************************************************************************
    Copyright (c) Microsoft Corporation. All rights reserved.
    Licensed under the Apache License, Version 2.0 (the "License"); you may not use
    this file except in compliance with the License. You may obtain a copy of the
    License at http://www.apache.org/licenses/LICENSE-2.0

    THIS CODE IS PROVIDED ON AN *AS IS* BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
    KIND, EITHER EXPRESS OR IMPLIED, INCLUDING WITHOUT LIMITATION ANY IMPLIED
    WARRANTIES OR CONDITIONS OF TITLE, FITNESS FOR A PARTICULAR PURPOSE,
    MERCHANTABLITY OR NON-INFRINGEMENT.

    See the Apache Version 2.0 License for specific language governing permissions
    and limitations under the License.
    ***************************************************************************** */var n=function(e,t){return(n=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])})(e,t)};function i(e,t){try{var n=this._saveQueuing;return n.isSaving?n.queueSaveChanges(e):(n.isSaving=!0,n.saveOptions=t,n.saveChanges(e,t))}catch(e){return Promise.reject(e)}}var a=function(){function e(e){this.entityManager=e,this.baseSaveChanges=e.saveChanges,this.isSaving=!1}return e.prototype.isEnabled=function(){return this._isEnabled},e.prototype.getSavedNothingResult=function(){return{entities:[],keyMappings:[]}},e.prototype.queueSaveChanges=function(e){var t=this.entityManager,n=e||t.getChanges();if(0===n.length)return Promise.resolve(this.getSavedNothingResult());var i=t.saveChangesValidateOnClient(n);if(i)return Promise.reject(i);var a=this.nextSaveMemo||(this.nextSaveMemo=new o);return function(){if(0===n.length)return;var e=a.queuedChanges;n.forEach((function(t){t.entityAspect.isBeingSaved||-1!==e.indexOf(t)||e.push(t)})),a.updateEntityMemos(n)}(),(this.nextSaveDeferred||(this.nextSaveDeferred=new r)).promise},e.prototype.saveChanges=function(e,n){var i=this,a=i.baseSaveChanges.call(i.entityManager,e,n||i.saveOptions).then((function(e){return i.saveSucceeded(e)})).then(null,(function(e){return console.log(e),i.saveFailed(e)}));return function(e){(e?e.filter((function(e){return e.entityAspect.entityState.isAdded()})):i.entityManager.getEntities(null,t.EntityState.Added)).forEach((function(e){var t=e.entityType.dataProperties,n=e.entityAspect.originalValues;t.forEach((function(t){t.isPartOfKey||(n[t.name]=e.getProperty(t.name))}))}))}(e),a},e.prototype.saveSucceeded=function(e){var t=this.activeSaveDeferred,n=this.nextSaveDeferred,i=this.nextSaveMemo;if(this.isSaving=!1,this.activeSaveDeferred=null,this.activeSaveMemo=null,this.nextSaveDeferred=null,this.nextSaveMemo=null,i){i.pkFixup(e.keyMappings),i.applyToSavedEntities(this.entityManager,e.entities);var a=i.queuedChanges.filter((function(e){return!e.entityAspect.entityState.isDetached()}));a.length>0?(this.isSaving=!0,this.activeSaveDeferred=n,this.activeSaveMemo=i,this.saveChanges(a,this.saveOptions)):n&&n.resolve(this.getSavedNothingResult())}return t&&t.resolve(e),e},e.prototype.saveFailed=function(e){e=new s(e,this);var t=this.activeSaveDeferred,n=this.nextSaveDeferred;return this.isSaving=!1,this.activeSaveDeferred=null,this.activeSaveMemo=null,this.nextSaveDeferred=null,this.nextSaveMemo=null,t&&t.reject(e),n&&n.reject(e),Promise.reject(e)},e}(),r=function(){this.promise=new Promise(function(e,t){this.resolve=e,this.reject=t}.bind(this))},s=function(e){function t(t,n){var i=e.call(this)||this;return i.name="QueuedSaveFailedError",i.innerError=t,i.message="Queued save failed: "+t.message,i.failedSaveMemo=n.activeSaveMemo,i.nextSaveMemo=n.nextSaveMemo,i}return function(e,t){function i(){this.constructor=e}n(e,t),e.prototype=null===t?Object.create(t):(i.prototype=t.prototype,new i)}(t,e),t}(Error),o=function(){function e(){this.entityMemos={},this.queuedChanges=[]}return e.prototype.applyToSavedEntities=function(e,t){var n=this,i=this.entityMemos,a=this.queuedChanges,r=this.disableManagerPublishing(e);try{t.forEach((function(e){var t=n.makeEntityMemoKey(e),r=i[t];r&&r.applyToSavedEntity(e)&&a.push(e)}))}finally{r(),a.length>0&&e._setHasChanges(!0)}},e.prototype.disableManagerPublishing=function(e){var n=t.breeze.Event;return n.enable("entityChanged",e,!1),n.enable("hasChangesChanged",e,!1),function(){n.enable("entityChanged",e,!0),n.enable("hasChangesChanged",e,!0)}},e.prototype.pkFixup=function(e){var t=this.entityMemos;e.forEach((function(e){var n=e.entityTypeName,i=n+"|"+e.tempValue;for(var a in t[i]&&(t[n+"|"+e.realValue]=t[i],delete t[i]),t)t[a].fkFixup(e)}))},e.prototype.makeEntityMemoKey=function(e){var t=e.entityAspect.getKey();return t.entityType.name+"|"+t.values},e.prototype.updateEntityMemos=function(e){var t=this,n=this.entityMemos;e.forEach((function(e){if(e.entityAspect.isBeingSaved){var i=t.makeEntityMemoKey(e);(n[i]||(n[i]=new u(e))).update(e)}}))},e}(),u=function(){function e(e){this.entity=e,this.pendingChanges={}}return e.prototype.applyToSavedEntity=function(e){var t=this,n=e.entityAspect;if(n.entityState.isDetached())return!1;if(t.isDeleted)return n.setDeleted(),!0;var i=Object.keys(t.pendingChanges);if(0===i.length)return!1;var a=n.originalValues;return i.forEach((function(n){a[n]=e.getProperty(n),e.setProperty(n,t.pendingChanges[n])})),n.setModified(),!0},e.prototype.fkFixup=function(e){var t=this;t.entity.entityType.foreignKeyProperties.forEach((function(n){n.parentType.name===e.entityTypeName&&t.pendingChanges[n.name]===e.tempValue&&(t.pendingChanges[n.name]=e.realValue)}))},e.prototype.update=function(){var e=this,t=e.entity,n=t.entityAspect;switch(n.entityState.name){case"Added":var i=n.originalValues;t.entityType.dataProperties.forEach((function(n){if(!n.isPartOfKey){var a=n.name,r=t.getProperty(a);i[a]!==r&&(e.pendingChanges[a]=r)}}));break;case"Deleted":e.isDeleted=!0,e.pendingChanges={};break;case"Modified":Object.keys(n.originalValues).forEach((function(n){e.pendingChanges[n]=t.getProperty(n)}))}},e}();e.enableSaveQueuing=function(e,t){void 0===t&&(t=!0),t=void 0===t||t,(e._saveQueueing||(e._saveQueuing=new a(e)))._isEnabled=t,e.saveChanges=t?i:e._saveQueuing.baseSaveChanges},Object.defineProperty(e,"__esModule",{value:!0})}));
//# sourceMappingURL=breeze-client-mixin-save-queuing.umd.min.js.map