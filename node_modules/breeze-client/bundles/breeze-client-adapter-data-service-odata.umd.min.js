!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("breeze-client")):"function"==typeof define&&define.amd?define("breeze-client/adapter-data-service-odata",["exports","breeze-client"],t):t(((e=e||self)["breeze-client"]=e["breeze-client"]||{},e["breeze-client"]["adapter-data-service-odata"]={}),e["breeze-client"])}(this,(function(e,t){"use strict";
/*! *****************************************************************************
    Copyright (c) Microsoft Corporation. All rights reserved.
    Licensed under the Apache License, Version 2.0 (the "License"); you may not use
    this file except in compliance with the License. You may obtain a copy of the
    License at http://www.apache.org/licenses/LICENSE-2.0

    THIS CODE IS PROVIDED ON AN *AS IS* BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
    KIND, EITHER EXPRESS OR IMPLIED, INCLUDING WITHOUT LIMITATION ANY IMPLIED
    WARRANTIES OR CONDITIONS OF TITLE, FITNESS FOR A PARTICULAR PURPOSE,
    MERCHANTABLITY OR NON-INFRINGEMENT.

    See the Apache Version 2.0 License for specific language governing permissions
    and limitations under the License.
    ***************************************************************************** */var r=function(e,t){return(r=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])})(e,t)};var a=t.core,n=function(e){function n(){var r=e.call(this)||this;return r.headers={DataServiceVersion:"2.0"},r.jsonResultsAdapter=new t.JsonResultsAdapter({name:"OData_default",visitNode:function(e,r,n){var i={};if(null==e)return i;var o=e.__metadata;if(null!=o){var s=t.MetadataStore.normalizeTypeName(o.type),u=s&&r.entityManager.metadataStore.getEntityType(s,!0);if(u&&u._mappedPropertiesCount<=Object.keys(e).length-1){i.entityType=u;var c=o.uri||o.id;if(c){var d=new RegExp("^"+r.dataService.serviceName,"i");c=c.replace(d,"")}i.extraMetadata={uriKey:c,etag:o.etag}}}e.results&&(i.node=e.results);var p=n.propertyName;return i.ignore=null!=e.__deferred||"__metadata"===p||"EntityKey"===p&&e.$type&&a.stringStartsWith(e.$type,"System.Data"),i}}),r.name="OData",r}return function(e,t){function a(){this.constructor=e}r(e,t),e.prototype=null===t?Object.create(t):(a.prototype=t.prototype,new a)}(n,e),n.register=function(e){return(e=e||t.config).registerAdapter("dataService",n),e.initializeAdapterInstance("dataService","OData",!0)},n.prototype.initialize=function(){OData=a.requireLib("OData","Needed to support remote OData services"),OData.jsonHandler.recognizeDates=!0},n.prototype.fetchMetadata=function(e,t){var r,n=t.serviceName;r=!0===this.relativeUrl?t.qualifyUrl("$metadata"):a.isFunction(this.relativeUrl)?this.relativeUrl(t,"$metadata"):this.getAbsoluteUrl(t,"$metadata");var i=a.extend({},this.headers);return i.Accept="application/*; odata.metadata=full",new Promise((function(a,o){OData.read({requestUri:r,headers:i},(function(i){if(!i||!i.dataServices){var s=new Error("Metadata query failed for: "+r);return o(s)}var u=i.dataServices;if(!e.hasMetadataFor(n)){try{e.importMetadata(u)}catch(e){return o(new Error("Metadata query failed for "+r+"; Unable to process returned metadata: "+e.message))}e.addDataService(t)}return a(u)}),(function(e){var t=u(e,r);return t.message="Metadata query failed for: "+r+"; "+(t.message||""),o(t)}),OData.metadataHandler)}))},n.prototype.executeQuery=function(e){var t,r=this;t=!0===this.relativeUrl?e.getUrl():a.isFunction(this.relativeUrl)?this.relativeUrl(e.dataService,e.getUrl()):this.getAbsoluteUrl(e.dataService,e.getUrl());var n=e.query;if(!a.isEmpty(n.parameters)){var i=function(e){var t=[];for(var r in e)e.hasOwnProperty(r)&&t.push(encodeURIComponent(r)+"="+encodeURIComponent(e[r]));return t.join("&")}(n.parameters),o=t.indexOf("?")<0?"?":"&";t=t+o+i}return new Promise((function(e,i){OData.read({requestUri:t,headers:a.extend({},r.headers)},(function(t,r){var a,i;return t.__count&&(a=parseInt(t.__count,10)),i=t.results?t.results:t,e({results:i,inlineCount:a,httpResponse:r,query:n})}),(function(e){return i(u(e,t))}))}))},n.prototype.saveChanges=function(e,r){var n,s=this,c=e.adapter=this,d=e;!0===this.relativeUrl?(d.routePrefix=c.getRoutePrefix(d.dataService),n=d.dataService.qualifyUrl("$batch")):a.isFunction(c.relativeUrl)?(d.routePrefix=c.relativeUrl(d.dataService,""),n=d.routePrefix+"$batch"):(d.routePrefix=c.getAbsoluteUrl(d.dataService,""),n=d.routePrefix+"$batch");var p=function(e,t){var r=e.adapter._createChangeRequestInterceptor(e,t),a=[],n=[],s=[],u=e.entityManager,c=u.helper,d=0,p=e.routePrefix;return t.entities.forEach((function(e,t){var f=e.entityAspect,l={headers:{"Content-ID":d+=1,DataServiceVersion:"2.0"}};if(s[d]=e,f.entityState.isAdded())l.requestUri=p+e.entityType.defaultResourceName,l.method="POST",l.data=c.unwrapInstance(e,i),n[d]=f.getKey();else if(f.entityState.isModified())o(l,f,p),l.method="MERGE",l.data=c.unwrapChangedValues(e,u.metadataStore,i);else{if(!f.entityState.isDeleted())return;o(l,f,p),l.method="DELETE"}l=r.getRequest(l,e,t),a.push(l)})),e.contentKeys=s,e.tempKeys=n,r.done(a),{__batchRequests:[{__changeRequests:a}]}}(d,r),f=d.tempKeys,l=d.contentKeys;return new Promise((function(e,r){OData.request({headers:a.extend({},s.headers),requestUri:n,method:"POST",data:p},(function(a,i){var o=[],s=[],c={entities:o,keyMappings:s};return a.__batchResponses.forEach((function(e){e.__changeResponses.forEach((function(e){var a=(e.response||e).statusCode;if(!a||a>=400)r(u(e,n));else{var i=e.headers["Content-ID"];i||(i=e.headers["Content-Id"]);var c=e.data;if(c){var d=f[i];if(d){var p=d.entityType;if(p.autoGeneratedKeyType!==t.AutoGeneratedKeyType.None){var v=d.values[0],y=p.getEntityKeyFromRawEntity(c,t.DataProperty.getRawValueFromServer),h={entityTypeName:p.name,tempValue:v,realValue:y.values[0]};s.push(h)}}o.push(c)}else{var m=l[i];o.push(m)}}}))})),e(c)}),(function(e){return r(u(e,n))}),OData.batchHandler)}))},n.prototype.getAbsoluteUrl=function(e,t){var r=e.qualifyUrl(""),n=a.stringStartsWith(t,r)?"":r;return window&&r.indexOf("//")<0&&(n=window.location.protocol+"//"+window.location.host+(a.stringStartsWith(r,"/")?"":"/")+n),n+t},n.prototype.getRoutePrefix=function(e){var t;"object"==typeof document?(t=document.createElement("a")).href=e.serviceName:t=url.parse(e.serviceName);var r=t.pathname;return"/"===r[0]&&(r=r.substr(1)),"/"!==r.substr(-1)&&(r+="/"),r},n}(t.AbstractDataServiceAdapter);function i(e,r){if(!e.isUnmapped)return e.dataType===t.DataType.DateTimeOffset?r=r&&new Date(r.getTime()-6e4*r.getTimezoneOffset()):e.dataType.quoteJsonOData&&(r=null!=r?r.toString():r),r}function o(e,t,r){var a,n=t.extraMetadata;null==n?(a=function(e){var t=e.entity.entityType,r=t.defaultResourceName,a=t.keyProperties,n=r+"(";if(1===a.length)n=n+s(a[0],e)+")";else{var i="";a.forEach((function(t){n=n+i+t.nameOnServer+"="+s(t,e),i=","})),n+=")"}return n}(t),t.extraMetadata={uriKey:a}):(a=n.uriKey,n.etag&&(e.headers["If-Match"]=n.etag)),e.requestUri=a.indexOf("//")>0?a:r+a}function s(e,t){return e.dataType.fmtOData(t.getPropertyValue(e.name))}function u(e,r){var a=new Error,n=e&&e.response;if(!n)return a.message=e,a.statusText=e,a;if(a.message=n.statusText,a.statusText=n.statusText,a.status=n.statusCode,r&&(a.url=r),a.body=n.body,n.body){var i=void 0;try{var o=JSON.parse(n.body);a.body=o,o["odata.error"]&&(o=o["odata.error"]);var s="";do{(i=o.error||o.innererror)||(s+=c(o)),o=(i=i||o.internalexception)||o}while(i);s.length>0&&(a.message=s)}catch(e){}}return t.AbstractDataServiceAdapter._catchNoConnectionError(a),a}function c(e){var t=e.message||"";return("string"==typeof t?t:t.value)+"; "}t.config.registerAdapter("dataService",n);var d=function(){this.name="webApiOData"},p=d;t.core.extend(d.prototype,n.prototype),t.config.registerAdapter("dataService",d);var f=function(){this.name="webApiOData4"},l=f;t.core.extend(f.prototype,d.prototype),f.prototype.initialize=function(){var e=a.requireLib("datajs","Needed to support remote OData v4 services");OData=e.V4.oData,OData.json.jsonHandler.recognizeDates=!0},f.prototype.headers={"OData-Version":"4.0"},t.config.registerAdapter("dataService",f),e.DataServiceODataAdapter=n,e.ɵ0=p,e.ɵ1=l,Object.defineProperty(e,"__esModule",{value:!0})}));
//# sourceMappingURL=breeze-client-adapter-data-service-odata.umd.min.js.map