{"version":3,"file":"breeze-client-adapter-ajax-httpclient.umd.js","sources":["ng://breeze-client/adapter-ajax-httpclient/adapter-ajax-httpclient.ts"],"sourcesContent":["import { HttpClient, HttpErrorResponse, HttpEvent, HttpHeaders, HttpRequest, HttpResponse } from \"@angular/common/http\";\r\nimport { AjaxConfig, config, core, HttpResponse as BreezeHttpResponse, BreezeConfig } from \"breeze-client\";\r\nimport { filter, map } from \"rxjs/operators\";\r\n\r\nexport class AjaxHttpClientAdapter {\r\n  static adapterName = 'httpclient';\r\n  name = AjaxHttpClientAdapter.adapterName;\r\n  defaultSettings = {};\r\n  requestInterceptor: (info: {}) => {};\r\n\r\n  constructor(public http: HttpClient) { }\r\n\r\n  static register(http: HttpClient, breezeConfig?: BreezeConfig) {\r\n    breezeConfig = breezeConfig || config;\r\n    breezeConfig.registerAdapter(\"ajax\", <any>function () { return new AjaxHttpClientAdapter(http); });\r\n    return breezeConfig.initializeAdapterInstance(\"ajax\", AjaxHttpClientAdapter.adapterName, true) as AjaxHttpClientAdapter;\r\n  }\r\n\r\n  initialize() { }\r\n\r\n  ajax(config: AjaxConfig) {\r\n    if (!this.http) {\r\n      throw new Error('Unable to locate angular http module for ajax adapter');\r\n    }\r\n\r\n    // merge default DataSetAdapter Settings with config arg\r\n    if (!core.isEmpty(this.defaultSettings)) {\r\n      let compositeConfig = core.extend({}, this.defaultSettings);\r\n      config = <AjaxConfig>core.extend(compositeConfig, config);\r\n      // extend is shallow; extend headers separately\r\n      let headers = core.extend({}, this.defaultSettings['headers']); // copy default headers 1st\r\n      config['headers'] = core.extend(headers, config.headers);\r\n    }\r\n\r\n    if (config.crossDomain) {\r\n      throw new Error(this.name + ' does not support JSONP (crossDomain) requests');\r\n    }\r\n\r\n    let url = config.url;\r\n    if (!core.isEmpty(config.params)) {\r\n      // Hack: Not sure how Angular handles writing 'search' parameters to the url.\r\n      // so this approach takes over the url param writing completely.\r\n      let delim = (url.indexOf('?') >= 0) ? '&' : '?';\r\n      url = url + delim + encodeParams(config.params);\r\n    }\r\n\r\n    let headers = new HttpHeaders(config.headers || {});\r\n    if (!headers.has('Content-Type')) {\r\n      if (config.type !== 'GET' && config.type !== 'DELETE' && !!config.contentType) {\r\n        headers = headers.set('Content-Type',\r\n          <string>config.contentType || 'application/json; charset=utf-8');\r\n      }\r\n    }\r\n\r\n    let body: any = config.data;\r\n    let request = new HttpRequest((config.type || 'GET').toUpperCase(), url, body, { headers: headers, responseType: \"text\" });\r\n\r\n    let requestInfo = {\r\n      adapter: this,      // this adapter\r\n      request: request,   // the http request from the requestOptions\r\n      dsaConfig: config,  // the config arg from the calling Breeze DataServiceAdapter\r\n      success: successFn, // adapter's success callback\r\n      error: errorFn      // adapter's error callback\r\n    };\r\n\r\n    if (core.isFunction(this.requestInterceptor)) {\r\n      this.requestInterceptor(requestInfo);\r\n      if (this.requestInterceptor['oneTime']) {\r\n        this.requestInterceptor = null;\r\n      }\r\n    }\r\n\r\n    if (requestInfo.request) { // exists unless requestInterceptor killed it.\r\n      const ffilter = filter((response: HttpEvent<any>) => response instanceof HttpResponse);\r\n      const fmap = map(extractData);\r\n\r\n      fmap(ffilter(this.http.request(requestInfo.request)))\r\n        .forEach(requestInfo.success)\r\n        .catch(requestInfo.error);\r\n    }\r\n\r\n    function extractData(event: HttpEvent<any>) {\r\n      let response = event as HttpResponse<any>;\r\n      let data: any;\r\n      let dt = requestInfo.dsaConfig.dataType;\r\n      // beware:`res.json` and `res.text` will be async some day\r\n      if (dt && dt !== 'json') {\r\n        data = response.body;\r\n      } else {\r\n        data = JSON.parse(response.body);\r\n      }\r\n      return { data, response };\r\n    }\r\n\r\n    function successFn(arg: { data: any, response: HttpResponse<any> }) {\r\n      if (arg.response.status < 200 || arg.response.status >= 300) {\r\n        throw { data: arg.data, response: arg.response };\r\n      }\r\n\r\n      let httpResponse: BreezeHttpResponse = {\r\n        config: requestInfo.request,\r\n        data: arg.data,\r\n        getHeaders: makeGetHeaders(arg.response.headers),\r\n        status: arg.response.status\r\n      };\r\n      httpResponse['ngConfig'] = requestInfo.request;\r\n      httpResponse['statusText'] = arg.response.statusText;\r\n      httpResponse['response'] = arg.response;\r\n      config.success(httpResponse);\r\n    }\r\n\r\n    function errorFn(response: HttpErrorResponse) {\r\n      if (response instanceof Error) {\r\n        throw response; // program error; nothing we can do\r\n      } else {\r\n        let data: any;\r\n        if (response.error instanceof HttpResponse) {\r\n          data = response.error.body;\r\n        } else if (response.error instanceof Error) {\r\n          data = response.error.message;\r\n        } else {\r\n          data = response.error;\r\n        }\r\n\r\n        // Timeout appears as an error with status===0 and no data.\r\n        if (response.status === 0 && data == null) {\r\n          data = 'timeout';\r\n        }\r\n\r\n        let errorMessage = response.status + \": \" + response.statusText;\r\n        if (data && typeof data === 'object') {\r\n          data[\"message\"] = data[\"message\"] || errorMessage;  // breeze looks at the message property\r\n        }\r\n        if (!data) {\r\n          data = errorMessage;   // Return the error message as data\r\n        }\r\n        let httpResponse: BreezeHttpResponse = {\r\n          config: requestInfo.request,\r\n          data: data,\r\n          getHeaders: makeGetHeaders(response.headers),\r\n          status: response.status\r\n        };\r\n        httpResponse['ngConfig'] = requestInfo.request;\r\n        httpResponse['statusText'] = response.statusText;\r\n        httpResponse['response'] = response;\r\n\r\n        config.error(httpResponse); // send error to breeze error handler\r\n      }\r\n    }\r\n  }\r\n\r\n}\r\n\r\n///// Helpers ////\r\n\r\nfunction encodeParams(obj: {}) {\r\n  let query = '';\r\n  let subValue: any, innerObj: any, fullSubName: any;\r\n\r\n  for (let name in obj) {\r\n    if (!obj.hasOwnProperty(name)) { continue; }\r\n\r\n    let value = obj[name];\r\n\r\n    if (value instanceof Array) {\r\n      for (let i = 0; i < value.length; ++i) {\r\n        subValue = value[i];\r\n        fullSubName = name + '[' + i + ']';\r\n        innerObj = {};\r\n        innerObj[fullSubName] = subValue;\r\n        query += encodeParams(innerObj) + '&';\r\n      }\r\n    } else if (value && value.toISOString) { // a feature of Date-like things\r\n      query += encodeURIComponent(name) + '=' + encodeURIComponent(value.toISOString()) + '&';\r\n    } else if (value instanceof Object) {\r\n      for (let subName in value) {\r\n        if (obj.hasOwnProperty(name)) {\r\n          subValue = value[subName];\r\n          fullSubName = name + '[' + subName + ']';\r\n          innerObj = {};\r\n          innerObj[fullSubName] = subValue;\r\n          query += encodeParams(innerObj) + '&';\r\n        }\r\n      }\r\n    } else if (value === null) {\r\n      query += encodeURIComponent(name) + '=&';\r\n    } else if (value !== undefined) {\r\n      query += encodeURIComponent(name) + '=' + encodeURIComponent(value) + '&';\r\n    }\r\n  }\r\n\r\n  return query.length ? query.substr(0, query.length - 1) : query;\r\n}\r\n\r\nfunction makeGetHeaders(headers: HttpHeaders) {\r\n  return function getHeaders(headerName?: string) { return headers.getAll(headerName).join('\\r\\n'); };\r\n}"],"names":["config","core","HttpHeaders","HttpRequest","filter","HttpResponse","map"],"mappings":"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"}