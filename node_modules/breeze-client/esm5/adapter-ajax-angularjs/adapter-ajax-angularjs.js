import * as breeze from 'breeze-client';
var core = breeze.core;
var AjaxAngularjsAdapter = /** @class */ (function () {
    function AjaxAngularjsAdapter() {
        this.name = "angularjs";
        this.defaultSettings = {};
        this.requestInterceptor = undefined;
        // Will set:
        //   this.$http;
        //   this.$rootScope;
    }
    AjaxAngularjsAdapter.register = function (config) {
        config = config || breeze.config;
        config.registerAdapter("ajax", AjaxAngularjsAdapter);
        return config.initializeAdapterInstance("ajax", "angularjs", true);
    };
    AjaxAngularjsAdapter.prototype.initialize = function () {
        var ng = breeze.core.requireLib("angular");
        if (ng) {
            var $injector = ng.injector(['ng']);
            var http_1, rootScope_1;
            $injector.invoke(['$http', '$rootScope', function ($http, $rootScope) {
                    http_1 = $http;
                    rootScope_1 = $rootScope;
                }]);
            this.$http = http_1;
            this.$rootScope = rootScope_1;
        }
    };
    AjaxAngularjsAdapter.prototype.setHttp = function (http) {
        this.$http = http;
        this.$rootScope = null; // to suppress $rootScope.digest
    };
    AjaxAngularjsAdapter.prototype.ajax = function (config) {
        if (!this.$http) {
            throw new Error("Unable to locate angularjs for ajax adapter");
        }
        var ngConfig = {
            method: config.type,
            url: config.url,
            dataType: config.dataType,
            contentType: config.contentType,
            crossDomain: config.crossDomain,
            headers: config.headers || {},
            data: undefined
        };
        if (config.params) {
            // Hack: because of the way that Angular handles writing parameters out to the url.
            // so this approach takes over the url param writing completely.
            // See: http://victorblog.com/2012/12/20/make-angularjs-http-service-behave-like-jquery-ajax/
            var delim = (ngConfig.url.indexOf("?") >= 0) ? "&" : "?";
            ngConfig.url = ngConfig.url + delim + encodeParams(config.params);
        }
        if (config.data) {
            ngConfig.data = config.data;
        }
        if (!core.isEmpty(this.defaultSettings)) {
            var compositeConfig = core.extend({}, this.defaultSettings);
            ngConfig = core.extend(compositeConfig, ngConfig);
            // extend is shallow; extend headers separately
            var headers = core.extend({}, this.defaultSettings.headers); // copy default headers 1st
            ngConfig.headers = core.extend(headers, ngConfig.headers);
        }
        var requestInfo = {
            adapter: this,
            config: ngConfig,
            dsaConfig: config,
            success: successFn,
            error: errorFn,
            responseSuccess: responseSuccessFn,
            responseError: responseErrorFn // adapter's error callback (ng 1.6+)
        };
        if (core.isFunction(this.requestInterceptor)) {
            var ri = this.requestInterceptor;
            ri(requestInfo);
            if (ri.oneTime) {
                this.requestInterceptor = undefined;
            }
        }
        if (requestInfo.config) { // exists unless requestInterceptor killed it.
            var prom = this.$http(requestInfo.config);
            if (prom.success) {
                // response for ng < 1.6        
                prom.success(requestInfo.success).error(requestInfo.error);
            }
            else {
                // response for ng 1.6+
                prom.then(requestInfo.responseSuccess).catch(requestInfo.responseError);
            }
            this.$rootScope && this.$rootScope.$digest();
        }
        function responseSuccessFn(response) {
            return successFn(response.data, response.status, response.headers, response.config, response.statusText);
        }
        function successFn(data, status, headers, xconfig, statusText) {
            // HACK: because $http returns a server side null as a string containing "null" - this is WRONG.
            if (data === "null")
                data = null;
            var httpResponse = {
                config: config,
                data: data,
                getHeaders: headers,
                ngConfig: xconfig,
                status: status,
                statusText: statusText
            };
            config.success(httpResponse);
        }
        function responseErrorFn(response) {
            return errorFn(response.data, response.status, response.headers, response.config, response.statusText);
        }
        function errorFn(data, status, headers, xconfig, statusText) {
            // Timeout appears as an error with status===0 and no data.
            // Make it better
            if (status === 0 && data == null) {
                data = 'timeout';
            }
            var httpResponse = {
                config: config,
                data: data,
                getHeaders: headers,
                ngConfig: xconfig,
                status: status,
                statusText: statusText
            };
            config.error(httpResponse);
        }
    };
    return AjaxAngularjsAdapter;
}());
export { AjaxAngularjsAdapter };
breeze.config.registerAdapter("ajax", AjaxAngularjsAdapter);
function encodeParams(obj) {
    var query = '';
    var subValue, innerObj, fullSubName;
    for (var name_1 in obj) {
        var value = obj[name_1];
        if (value instanceof Array) {
            for (var i = 0; i < value.length; ++i) {
                subValue = value[i];
                fullSubName = name_1 + '[' + i + ']';
                innerObj = {};
                innerObj[fullSubName] = subValue;
                query += encodeParams(innerObj) + '&';
            }
        }
        else if (value && value.toISOString) { // a feature of Date-like things
            query += encodeURIComponent(name_1) + '=' + encodeURIComponent(value.toISOString()) + '&';
        }
        else if (value instanceof Object) {
            for (var subName in value) {
                subValue = value[subName];
                fullSubName = name_1 + '[' + subName + ']';
                innerObj = {};
                innerObj[fullSubName] = subValue;
                query += encodeParams(innerObj) + '&';
            }
        }
        else if (value === null) {
            query += encodeURIComponent(name_1) + '=&';
        }
        else if (value !== undefined) {
            query += encodeURIComponent(name_1) + '=' + encodeURIComponent(value) + '&';
        }
    }
    return query.length ? query.substr(0, query.length - 1) : query;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYWRhcHRlci1hamF4LWFuZ3VsYXJqcy5qcyIsInNvdXJjZVJvb3QiOiJuZzovL2JyZWV6ZS1jbGllbnQvYWRhcHRlci1hamF4LWFuZ3VsYXJqcy8iLCJzb3VyY2VzIjpbImFkYXB0ZXItYWpheC1hbmd1bGFyanMudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxLQUFLLE1BQU0sTUFBTSxlQUFlLENBQUM7QUFFeEMsSUFBSSxJQUFJLEdBQUcsTUFBTSxDQUFDLElBQUksQ0FBQztBQUV2QjtJQU1FO1FBQ0UsSUFBSSxDQUFDLElBQUksR0FBRyxXQUFXLENBQUM7UUFDeEIsSUFBSSxDQUFDLGVBQWUsR0FBRyxFQUFFLENBQUM7UUFDMUIsSUFBSSxDQUFDLGtCQUFrQixHQUFHLFNBQVMsQ0FBQztRQUNwQyxZQUFZO1FBQ1osZ0JBQWdCO1FBQ2hCLHFCQUFxQjtJQUN2QixDQUFDO0lBRU0sNkJBQVEsR0FBZixVQUFnQixNQUE0QjtRQUMxQyxNQUFNLEdBQUcsTUFBTSxJQUFJLE1BQU0sQ0FBQyxNQUFNLENBQUM7UUFDakMsTUFBTSxDQUFDLGVBQWUsQ0FBQyxNQUFNLEVBQUUsb0JBQW9CLENBQUMsQ0FBQztRQUNyRCxPQUFPLE1BQU0sQ0FBQyx5QkFBeUIsQ0FBQyxNQUFNLEVBQUUsV0FBVyxFQUFFLElBQUksQ0FBeUIsQ0FBQztJQUM3RixDQUFDO0lBRUQseUNBQVUsR0FBVjtRQUVFLElBQUksRUFBRSxHQUFHLE1BQU0sQ0FBQyxJQUFJLENBQUMsVUFBVSxDQUFDLFNBQVMsQ0FBQyxDQUFDO1FBQzNDLElBQUksRUFBRSxFQUFFO1lBQ04sSUFBSSxTQUFTLEdBQUcsRUFBRSxDQUFDLFFBQVEsQ0FBQyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUM7WUFDcEMsSUFBSSxNQUFTLEVBQUUsV0FBYyxDQUFDO1lBQzlCLFNBQVMsQ0FBQyxNQUFNLENBQUMsQ0FBQyxPQUFPLEVBQUUsWUFBWSxFQUFFLFVBQVUsS0FBVSxFQUFFLFVBQWU7b0JBQzVFLE1BQUks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QUksa0JBQWtCLENBQUMsTUFBSSxDQUFDLEdBQUcsR0FBRyxHQUFHLGtCQUFrQixDQUFDLEtBQUssQ0FBQyxHQUFHLEdBQUcsQ0FBQztTQUMzRTtLQUNGO0lBRUQsT0FBTyxLQUFLLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQyxLQUFLLENBQUMsTUFBTSxDQUFDLENBQUMsRUFBRSxLQUFLLENBQUMsTUFBTSxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxLQUFLLENBQUM7QUFDbEUsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCAqIGFzIGJyZWV6ZSBmcm9tICdicmVlemUtY2xpZW50JztcclxuXHJcbmxldCBjb3JlID0gYnJlZXplLmNvcmU7XHJcblxyXG5leHBvcnQgY2xhc3MgQWpheEFuZ3VsYXJqc0FkYXB0ZXIgaW1wbGVtZW50cyBicmVlemUuQWpheEFkYXB0ZXIge1xyXG4gIG5hbWU6IHN0cmluZztcclxuICBkZWZhdWx0U2V0dGluZ3M6IHsgaGVhZGVycz86IGFueSB9O1xyXG4gIHJlcXVlc3RJbnRlcmNlcHRvcj86ICgoKSA9PiBicmVlemUuQ2hhbmdlUmVxdWVzdEludGVyY2VwdG9yKSB8IGJyZWV6ZS5DaGFuZ2VSZXF1ZXN0SW50ZXJjZXB0b3I7XHJcbiAgJGh0dHA6IGFueTtcclxuICAkcm9vdFNjb3BlOiBhbnk7XHJcbiAgY29uc3RydWN0b3IoKSB7XHJcbiAgICB0aGlzLm5hbWUgPSBcImFuZ3VsYXJqc1wiO1xyXG4gICAgdGhpcy5kZWZhdWx0U2V0dGluZ3MgPSB7fTtcclxuICAgIHRoaXMucmVxdWVzdEludGVyY2VwdG9yID0gdW5kZWZpbmVkO1xyXG4gICAgLy8gV2lsbCBzZXQ6XHJcbiAgICAvLyAgIHRoaXMuJGh0dHA7XHJcbiAgICAvLyAgIHRoaXMuJHJvb3RTY29wZTtcclxuICB9XHJcblxyXG4gIHN0YXRpYyByZWdpc3Rlcihjb25maWc/OiBicmVlemUuQnJlZXplQ29uZmlnKSB7XHJcbiAgICBjb25maWcgPSBjb25maWcgfHwgYnJlZXplLmNvbmZpZztcclxuICAgIGNvbmZpZy5yZWdpc3RlckFkYXB0ZXIoXCJhamF4XCIsIEFqYXhBbmd1bGFyanNBZGFwdGVyKTtcclxuICAgIHJldHVybiBjb25maWcuaW5pdGlhbGl6ZUFkYXB0ZXJJbnN0YW5jZShcImFqYXhcIiwgXCJhbmd1bGFyanNcIiwgdHJ1ZSkgYXMgQWpheEFuZ3VsYXJqc0FkYXB0ZXI7XHJcbiAgfVxyXG5cclxuICBpbml0aWFsaXplKCkge1xyXG5cclxuICAgIGxldCBuZyA9IGJyZWV6ZS5jb3JlLnJlcXVpcmVMaWIoXCJhbmd1bGFyXCIpO1xyXG4gICAgaWYgKG5nKSB7XHJcbiAgICAgIGxldCAkaW5qZWN0b3IgPSBuZy5pbmplY3RvcihbJ25nJ10pO1xyXG4gICAgICBsZXQgaHR0cDogYW55LCByb290U2NvcGU6IGFueTtcclxuICAgICAgJGluamVjdG9yLmludm9rZShbJyRodHRwJywgJyRyb290U2NvcGUnLCBmdW5jdGlvbiAoJGh0dHA6IGFueSwgJHJvb3RTY29wZTogYW55KSB7XHJcbiAgICAgICAgaHR0cCA9ICRodHRwO1xyXG4gICAgICAgIHJvb3RTY29wZSA9ICRyb290U2NvcGU7XHJcbiAgICAgIH1dKTtcclxuICAgICAgdGhpcy4kaHR0cCA9IGh0dHA7XHJcbiAgICAgIHRoaXMuJHJvb3RTY29wZSA9IHJvb3RTY29wZTtcclxuICAgIH1cclxuXHJcbiAgfVxyXG5cclxuICBzZXRIdHRwKGh0dHA6IGFueSkge1xyXG4gICAgdGhpcy4kaHR0cCA9IGh0dHA7XHJcbiAgICB0aGlzLiRyb290U2NvcGUgPSBudWxsOyAvLyB0byBzdXBwcmVzcyAkcm9vdFNjb3BlLmRpZ2VzdFxyXG4gIH1cclxuXHJcblxyXG4gIGFqYXgoY29uZmlnOiBhbnkpIHtcclxuICAgIGlmICghdGhpcy4kaHR0cCkge1xyXG4gICAgICB0aHJvdyBuZXcgRXJyb3IoXCJVbmFibGUgdG8gbG9jYXRlIGFuZ3VsYXJqcyBmb3IgYWpheCBhZGFwdGVyXCIpO1xyXG4gICAgfVxyXG4gICAgbGV0IG5nQ29uZmlnID0ge1xyXG4gICAgICBtZXRob2Q6IGNvbmZpZy50eXBlLFxyXG4gICAgICB1cmw6IGNvbmZpZy51cmwsXHJcbiAgICAgIGRhdGFUeXBlOiBjb25maWcuZGF0YVR5cGUsXHJcbiAgICAgIGNvbnRlbnRUeXBlOiBjb25maWcuY29udGVudFR5cGUsXHJcbiAgICAgIGNyb3NzRG9tYWluOiBjb25maWcuY3Jvc3NEb21haW4sXHJcbiAgICAgIGhlYWRlcnM6IGNvbmZpZy5oZWFkZXJzIHx8IHt9LFxyXG4gICAgICBkYXRhOiB1bmRlZmluZWQgYXMgYW55XHJcbiAgICB9O1xyXG5cclxuICAgIGlmIChjb25maWcucGFyYW1zKSB7XHJcbiAgICAgIC8vIEhhY2s6IGJlY2F1c2Ugb2YgdGhlIHdheSB0aGF0IEFuZ3VsYXIgaGFuZGxlcyB3cml0aW5nIHBhcmFtZXRlcnMgb3V0IHRvIHRoZSB1cmwuXHJcbiAgICAgIC8vIHNvIHRoaXMgYXBwcm9hY2ggdGFrZXMgb3ZlciB0aGUgdXJsIHBhcmFtIHdyaXRpbmcgY29tcGxldGVseS5cclxuICAgICAgLy8gU2VlOiBodHRwOi8vdmljdG9yYmxvZy5jb20vMjAxMi8xMi8yMC9tYWtlLWFuZ3VsYXJqcy1odHRwLXNlcnZpY2UtYmVoYXZlLWxpa2UtanF1ZXJ5LWFqYXgvXHJcbiAgICAgIGxldCBkZWxpbSA9IChuZ0NvbmZpZy51cmwuaW5kZXhPZihcIj9cIikgPj0gMCkgPyBcIiZcIiA6IFwiP1wiO1xyXG4gICAgICBuZ0NvbmZpZy51cmwgPSBuZ0NvbmZpZy51cmwgKyBkZWxpbSArIGVuY29kZVBhcmFtcyhjb25maWcucGFyYW1zKTtcclxuICAgIH1cclxuXHJcbiAgICBpZiAoY29uZmlnLmRhdGEpIHtcclxuICAgICAgbmdDb25maWcuZGF0YSA9IGNvbmZpZy5kYXRhO1xyXG4gICAgfVxyXG5cclxuICAgIGlmICghY29yZS5pc0VtcHR5KHRoaXMuZGVmYXVsdFNldHRpbmdzKSkge1xyXG4gICAgICBsZXQgY29tcG9zaXRlQ29uZmlnID0gY29yZS5leHRlbmQoe30sIHRoaXMuZGVmYXVsdFNldHRpbmdzKTtcclxuICAgICAgbmdDb25maWcgPSBjb3JlLmV4dGVuZChjb21wb3NpdGVDb25maWcsIG5nQ29uZmlnKSBhcyBhbnk7XHJcbiAgICAgIC8vIGV4dGVuZCBpcyBzaGFsbG93OyBleHRlbmQgaGVhZGVycyBzZXBhcmF0ZWx5XHJcbiAgICAgIGxldCBoZWFkZXJzID0gY29yZS5leHRlbmQoe30sIHRoaXMuZGVmYXVsdFNldHRpbmdzLmhlYWRlcnMpOyAvLyBjb3B5IGRlZmF1bHQgaGVhZGVycyAxc3RcclxuICAgICAgbmdDb25maWcuaGVhZGVycyA9IGNvcmUuZXh0ZW5kKGhlYWRlcnMsIG5nQ29uZmlnLmhlYWRlcnMpO1xyXG4gICAgfVxyXG5cclxuICAgIGxldCByZXF1ZXN0SW5mbyA9IHtcclxuICAgICAgYWRhcHRlcjogdGhpcywgICAgICAvLyB0aGlzIGFkYXB0ZXJcclxuICAgICAgY29uZmlnOiBuZ0NvbmZpZywgICAvLyBhbmd1bGFyJ3MgJGh0dHAgY29uZmlndXJhdGlvbiBvYmplY3RcclxuICAgICAgZHNhQ29uZmlnOiBjb25maWcsICAvLyB0aGUgY29uZmlnIGFyZyBmcm9tIHRoZSBjYWxsaW5nIEJyZWV6ZSBEYXRhU2VydmljZUFkYXB0ZXJcclxuICAgICAgc3VjY2Vzczogc3VjY2Vzc0ZuLCAvLyBhZGFwdGVyJ3Mgc3VjY2VzcyBjYWxsYmFja1xyXG4gICAgICBlcnJvcjogZXJyb3JGbiwgICAgICAvLyBhZGFwdGVyJ3MgZXJyb3IgY2FsbGJhY2tcclxuICAgICAgcmVzcG9uc2VTdWNjZXNzOiByZXNwb25zZVN1Y2Nlc3NGbiwgLy8gYWRhcHRlcidzIHN1Y2Nlc3MgY2FsbGJhY2sgKG5nIDEuNispXHJcbiAgICAgIHJlc3BvbnNlRXJyb3I6IHJlc3BvbnNlRXJyb3JGbiAgICAgIC8vIGFkYXB0ZXIncyBlcnJvciBjYWxsYmFjayAobmcgMS42KylcclxuICAgIH07XHJcblxyXG4gICAgaWYgKGNvcmUuaXNGdW5jdGlvbih0aGlzLnJlcXVlc3RJbnRlcmNlcHRvcikpIHtcclxuICAgICAgbGV0IHJpID0gdGhpcy5yZXF1ZXN0SW50ZXJjZXB0b3IgYXMgYW55O1xyXG4gICAgICByaShyZXF1ZXN0SW5mbyk7XHJcbiAgICAgIGlmIChyaS5vbmVUaW1lKSB7XHJcbiAgICAgICAgdGhpcy5yZXF1ZXN0SW50ZXJjZXB0b3IgPSB1bmRlZmluZWQ7XHJcbiAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICBpZiAocmVxdWVzdEluZm8uY29uZmlnKSB7IC8vIGV4aXN0cyB1bmxlc3MgcmVxdWVzdEludGVyY2VwdG9yIGtpbGxlZCBpdC5cclxuICAgICAgbGV0IHByb20gPSB0aGlzLiRodHRwKHJlcXVlc3RJbmZvLmNvbmZpZyk7XHJcbiAgICAgIGlmIChwcm9tLnN1Y2Nlc3MpIHtcclxuICAgICAgICAvLyByZXNwb25zZSBmb3IgbmcgPCAxLjYgICAgICAgIFxyXG4gICAgICAgIHByb20uc3VjY2VzcyhyZXF1ZXN0SW5mby5zdWNjZXNzKS5lcnJvcihyZXF1ZXN0SW5mby5lcnJvcik7XHJcbiAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgLy8gcmVzcG9uc2UgZm9yIG5nIDEuNitcclxuICAgICAgICBwcm9tLnRoZW4ocmVxdWVzdEluZm8ucmVzcG9uc2VTdWNjZXNzKS5jYXRjaChyZXF1ZXN0SW5mby5yZXNwb25zZUVycm9yKTtcclxuICAgICAgfVxyXG4gICAgICB0aGlzLiRyb290U2NvcGUgJiYgdGhpcy4kcm9vdFNjb3BlLiRkaWdlc3QoKTtcclxuICAgIH1cclxuXHJcbiAgICBmdW5jdGlvbiByZXNwb25zZVN1Y2Nlc3NGbihyZXNwb25zZTogYW55KSB7XHJcbiAgICAgIHJldHVybiBzdWNjZXNzRm4ocmVzcG9uc2UuZGF0YSwgcmVzcG9uc2Uuc3RhdHVzLCByZXNwb25zZS5oZWFkZXJzLCByZXNwb25zZS5jb25maWcsIHJlc3BvbnNlLnN0YXR1c1RleHQpO1xyXG4gICAgfVxyXG5cclxuICAgIGZ1bmN0aW9uIHN1Y2Nlc3NGbihkYXRhOiBhbnksIHN0YXR1czogYW55LCBoZWFkZXJzOiBhbnksIHhjb25maWc6IGFueSwgc3RhdHVzVGV4dDogc3RyaW5nKSB7XHJcbiAgICAgIC8vIEhBQ0s6IGJlY2F1c2UgJGh0dHAgcmV0dXJucyBhIHNlcnZlciBzaWRlIG51bGwgYXMgYSBzdHJpbmcgY29udGFpbmluZyBcIm51bGxcIiAtIHRoaXMgaXMgV1JPTkcuXHJcbiAgICAgIGlmIChkYXRhID09PSBcIm51bGxcIikgZGF0YSA9IG51bGw7XHJcbiAgICAgIGxldCBodHRwUmVzcG9uc2UgPSB7XHJcbiAgICAgICAgY29uZmlnOiBjb25maWcsXHJcbiAgICAgICAgZGF0YTogZGF0YSxcclxuICAgICAgICBnZXRIZWFkZXJzOiBoZWFkZXJzLFxyXG4gICAgICAgIG5nQ29uZmlnOiB4Y29uZmlnLFxyXG4gICAgICAgIHN0YXR1czogc3RhdHVzLFxyXG4gICAgICAgIHN0YXR1c1RleHQ6IHN0YXR1c1RleHRcclxuICAgICAgfTtcclxuICAgICAgY29uZmlnLnN1Y2Nlc3MoaHR0cFJlc3BvbnNlKTtcclxuICAgIH1cclxuXHJcbiAgICBmdW5jdGlvbiByZXNwb25zZUVycm9yRm4ocmVzcG9uc2U6IGFueSkge1xyXG4gICAgICByZXR1cm4gZXJyb3JGbihyZXNwb25zZS5kYXRhLCByZXNwb25zZS5zdGF0dXMsIHJlc3BvbnNlLmhlYWRlcnMsIHJlc3BvbnNlLmNvbmZpZywgcmVzcG9uc2Uuc3RhdHVzVGV4dCk7XHJcbiAgICB9XHJcblxyXG4gICAgZnVuY3Rpb24gZXJyb3JGbihkYXRhOiBhbnksIHN0YXR1czogYW55LCBoZWFkZXJzOiBhbnksIHhjb25maWc6IGFueSwgc3RhdHVzVGV4dDogc3RyaW5nKSB7XHJcbiAgICAgIC8vIFRpbWVvdXQgYXBwZWFycyBhcyBhbiBlcnJvciB3aXRoIHN0YXR1cz09PTAgYW5kIG5vIGRhdGEuXHJcbiAgICAgIC8vIE1ha2UgaXQgYmV0dGVyXHJcbiAgICAgIGlmIChzdGF0dXMgPT09IDAgJiYgZGF0YSA9PSBudWxsKSB7XHJcbiAgICAgICAgZGF0YSA9ICd0aW1lb3V0JztcclxuICAgICAgfVxyXG4gICAgICBsZXQgaHR0cFJlc3BvbnNlID0ge1xyXG4gICAgICAgIGNvbmZpZzogY29uZmlnLFxyXG4gICAgICAgIGRhdGE6IGRhdGEsXHJcbiAgICAgICAgZ2V0SGVhZGVyczogaGVhZGVycyxcclxuICAgICAgICBuZ0NvbmZpZzogeGNvbmZpZyxcclxuICAgICAgICBzdGF0dXM6IHN0YXR1cyxcclxuICAgICAgICBzdGF0dXNUZXh0OiBzdGF0dXNUZXh0XHJcbiAgICAgIH07XHJcbiAgICAgIGNvbmZpZy5lcnJvcihodHRwUmVzcG9uc2UpO1xyXG4gICAgfVxyXG4gIH1cclxufVxyXG5cclxuYnJlZXplLmNvbmZpZy5yZWdpc3RlckFkYXB0ZXIoXCJhamF4XCIsIEFqYXhBbmd1bGFyanNBZGFwdGVyKTtcclxuXHJcbmZ1bmN0aW9uIGVuY29kZVBhcmFtcyhvYmo6IE9iamVjdCkge1xyXG4gIGxldCBxdWVyeSA9ICcnO1xyXG4gIGxldCBzdWJWYWx1ZTogYW55LCBpbm5lck9iajogT2JqZWN0LCBmdWxsU3ViTmFtZTogc3RyaW5nO1xyXG5cclxuICBmb3IgKGxldCBuYW1lIGluIG9iaikge1xyXG4gICAgbGV0IHZhbHVlID0gb2JqW25hbWVdO1xyXG5cclxuICAgIGlmICh2YWx1ZSBpbnN0YW5jZW9mIEFycmF5KSB7XHJcbiAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgdmFsdWUubGVuZ3RoOyArK2kpIHtcclxuICAgICAgICBzdWJWYWx1ZSA9IHZhbHVlW2ldO1xyXG4gICAgICAgIGZ1bGxTdWJOYW1lID0gbmFtZSArICdbJyArIGkgKyAnXSc7XHJcbiAgICAgICAgaW5uZXJPYmogPSB7fTtcclxuICAgICAgICBpbm5lck9ialtmdWxsU3ViTmFtZV0gPSBzdWJWYWx1ZTtcclxuICAgICAgICBxdWVyeSArPSBlbmNvZGVQYXJhbXMoaW5uZXJPYmopICsgJyYnO1xyXG4gICAgICB9XHJcbiAgICB9IGVsc2UgaWYgKHZhbHVlICYmIHZhbHVlLnRvSVNPU3RyaW5nKSB7IC8vIGEgZmVhdHVyZSBvZiBEYXRlLWxpa2UgdGhpbmdzXHJcbiAgICAgIHF1ZXJ5ICs9IGVuY29kZVVSSUNvbXBvbmVudChuYW1lKSArICc9JyArIGVuY29kZVVSSUNvbXBvbmVudCh2YWx1ZS50b0lTT1N0cmluZygpKSArICcmJztcclxuICAgIH0gZWxzZSBpZiAodmFsdWUgaW5zdGFuY2VvZiBPYmplY3QpIHtcclxuICAgICAgZm9yIChsZXQgc3ViTmFtZSBpbiB2YWx1ZSkge1xyXG4gICAgICAgIHN1YlZhbHVlID0gdmFsdWVbc3ViTmFtZV07XHJcbiAgICAgICAgZnVsbFN1Yk5hbWUgPSBuYW1lICsgJ1snICsgc3ViTmFtZSArICddJztcclxuICAgICAgICBpbm5lck9iaiA9IHt9O1xyXG4gICAgICAgIGlubmVyT2JqW2Z1bGxTdWJOYW1lXSA9IHN1YlZhbHVlO1xyXG4gICAgICAgIHF1ZXJ5ICs9IGVuY29kZVBhcmFtcyhpbm5lck9iaikgKyAnJic7XHJcbiAgICAgIH1cclxuICAgIH0gZWxzZSBpZiAodmFsdWUgPT09IG51bGwpIHtcclxuICAgICAgcXVlcnkgKz0gZW5jb2RlVVJJQ29tcG9uZW50KG5hbWUpICsgJz0mJztcclxuICAgIH0gZWxzZSBpZiAodmFsdWUgIT09IHVuZGVmaW5lZCkge1xyXG4gICAgICBxdWVyeSArPSBlbmNvZGVVUklDb21wb25lbnQobmFtZSkgKyAnPScgKyBlbmNvZGVVUklDb21wb25lbnQodmFsdWUpICsgJyYnO1xyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgcmV0dXJuIHF1ZXJ5Lmxlbmd0aCA/IHF1ZXJ5LnN1YnN0cigwLCBxdWVyeS5sZW5ndGggLSAxKSA6IHF1ZXJ5O1xyXG59Il19