import * as breeze from 'breeze-client';
var core = breeze.core;
var ModelLibraryBackingStoreAdapter = /** @class */ (function () {
    function ModelLibraryBackingStoreAdapter() {
        this.name = "backingStore";
    }
    ModelLibraryBackingStoreAdapter.register = function (config) {
        config = config || breeze.config;
        config.registerAdapter("modelLibrary", ModelLibraryBackingStoreAdapter);
        return config.initializeAdapterInstance("modelLibrary", "backingStore", true);
    };
    ModelLibraryBackingStoreAdapter.prototype.initialize = function () {
    };
    ModelLibraryBackingStoreAdapter.prototype.getTrackablePropertyNames = function (entity) {
        var names = [];
        for (var p in entity) {
            if (p === "entityAspect" || p === "entityType")
                continue;
            if (p === "_$typeName" || p === "_pendingSets" || p === "_backingStore")
                continue;
            var val = entity[p];
            if (!core.isFunction(val)) {
                names.push(p);
            }
        }
        return names;
    };
    // This method is called during Metadata initialization
    ModelLibraryBackingStoreAdapter.prototype.initializeEntityPrototype = function (proto) {
        proto.getProperty = function (propertyName) {
            return this[propertyName];
        };
        proto.setProperty = function (propertyName, value) {
            //if (!this._backingStore.hasOwnProperty(propertyName)) {
            //    throw new Error("Unknown property name:" + propertyName);
            //}
            this[propertyName] = value;
            // allow setProperty chaining.
            return this;
        };
        movePropDefsToProto(proto);
    };
    // This method is called when an EntityAspect is first created - this will occur as part of the entityType.createEntity call.
    // which can be called either directly or via standard query materialization
    // entity is either an entity or a complexObject
    ModelLibraryBackingStoreAdapter.prototype.startTracking = function (entity, proto) {
        // can't touch the normal property sets within this method - access the backingStore directly instead.
        var bs = movePropsToBackingStore(entity);
        // assign default values to the entity
        var stype = breeze.EntityAspect.isEntity(entity) ? entity.entityType : entity.complexType;
        stype.getProperties().forEach(function (prop) {
            var propName = prop.name;
            var val = entity[propName];
            if (prop instanceof breeze.DataProperty) {
                if (prop.isComplexProperty) {
                    if (prop.isScalar) {
                        val = prop.dataType._createInstanceCore(entity, prop);
                    }
                    else {
                        val = breeze.makeComplexArray([], entity, prop);
                    }
                }
                else if (!prop.isScalar) {
                    val = breeze.makePrimitiveArray([], entity, prop);
                }
                else if (val === undefined) {
                    val = prop.defaultValue;
                }
            }
            else if (prop.isNavigationProperty) {
                if (val !== undefined && val !== null) {
                    throw new Error("Cannot assign a navigation property in an entity ctor.: " + propName);
                }
                if (prop.isScalar) {
                    // TODO: change this to nullstob later.
                    val = null;
                }
                else {
                    val = breeze.makeRelationArray([], entity, prop);
                }
            }
            else {
                throw new Error("unknown property: " + propName);
            }
            // can't touch the normal property sets within this method (IE9 Bug) - so we access the backingStore directly instead.
            // otherwise we could just do
            // entity[propName] = val
            // after all of the interception logic had been injected.
            if (prop.isSettable || prop.isNavigationProperty) {
                bs[propName] = val;
            }
        });
    };
    return ModelLibraryBackingStoreAdapter;
}());
export { ModelLibraryBackingStoreAdapter };
breeze.config.registerAdapter("modelLibrary", ModelLibraryBackingStoreAdapter);
// private methods
// This method is called during Metadata initialization to correctly "wrap" properties.
function movePropDefsToProto(proto) {
    var stype = (proto.entityType || proto.complexType);
    var extra = stype._extra;
    var alreadyWrapped = extra.alreadyWrappedProps || {};
    stype.getProperties().forEach(function (prop) {
        var propName = prop.name;
        // we only want to wrap props that haven't already been wrapped
        if (alreadyWrapped[propName])
            return;
        // If property is already defined on the prototype then wrap it in another propertyDescriptor.
        // otherwise create a propDescriptor for it.
        var descr;
        if (propName in proto) {
            descr = wrapPropDescription(proto, prop);
        }
        else {
            descr = makePropDescription(proto, prop);
        }
        // descr will be null for a wrapped descr that is not configurable
        if (descr != null) {
            Object.defineProperty(proto, propName, descr);
        }
        alreadyWrapped[propName] = true;
    });
    extra.alreadyWrappedProps = alreadyWrapped;
}
// This method is called when an instance is first created via materialization or createEntity.
// this method cannot be called while a 'defineProperty' accessor is executing
// because of IE bug mentioned above.
function movePropsToBackingStore(instance) {
    var bs = getBackingStore(instance);
    var proto = Object.getPrototypeOf(instance);
    var stype = (proto.entityType || proto.complexType);
    stype.getProperties().forEach(function (prop) {
        var propName = prop.name;
        if (prop.isUnmapped) {
            // insure that any unmapped properties that were added after entityType
            // was first created are wrapped with a property descriptor.
            if (!core.getPropertyDescriptor(proto, propName)) {
                var descr = makePropDescription(proto, prop);
                Object.defineProperty(proto, propName, descr);
            }
        }
        if (!instance.hasOwnProperty(propName))
            return;
        // pulls off the value, removes the instance property and then rewrites it via ES5 accessor
        var value = instance[propName];
        delete instance[propName];
        instance[propName] = value;
    });
    return bs;
}
function makePropDescription(proto, property) {
    var propName = property.name;
    var pendingStores = proto._pendingBackingStores;
    if (!pendingStores) {
        pendingStores = [];
        proto._pendingBackingStores = pendingStores;
    }
    var descr = {
        get: function () {
            var bs = this._backingStore || getBackingStore(this);
            return bs[propName];
        },
        set: function (value) {
            // IE9 cannot touch instance._backingStore here
            var bs = this._backingStore || getPendingBackingStore(this);
            var accessorFn = getAccessorFn(bs, propName);
            this._$interceptor(property, value, accessorFn);
        },
        enumerable: true,
        configurable: true
    };
    descr.set.rawSet = function (value) {
        var bs = this._backingStore || getPendingBackingStore(this);
        var accessorFn = getAccessorFn(bs, propName);
        accessorFn(value);
    };
    return descr;
}
function getAccessorFn(bs, propName) {
    return function () {
        if (arguments.length === 0) {
            return bs[propName];
        }
        else {
            bs[propName] = arguments[0];
            return undefined;
        }
    };
}
function wrapPropDescription(proto, property) {
    if (!proto.hasOwnProperty(property.name)) {
        var nextProto = Object.getPrototypeOf(proto);
        return wrapPropDescription(nextProto, property);
    }
    var propDescr = Object.getOwnPropertyDescriptor(proto, property.name);
    if (!propDescr)
        return undefined;
    // if not configurable; we can't touch it - so leave.
    if (!propDescr.configurable)
        return undefined;
    // if a data descriptor - don't change it - this is basically a static property - i.e. defined on every instance of the type with the same value.
    if (propDescr.value)
        return undefined;
    // if a read only property descriptor - no need to change it.
    if (!propDescr.set)
        return undefined;
    var localAccessorFn = function (entity) {
        return function () {
            if (!propDescr)
                return undefined;
            if (arguments.length === 0) {
                return propDescr.get.bind(entity)();
            }
            else {
                var set = propDescr.set;
                var rawSet = set.rawSet || set;
                rawSet.bind(entity)(arguments[0]);
                return undefined;
            }
        };
    };
    var newDescr = {
        get: function () {
            if (!propDescr)
                return undefined;
            return propDescr.get.bind(this)();
        },
        set: function (value) {
            this._$interceptor(property, value, localAccessorFn(this));
        },
        enumerable: propDescr.enumerable,
        configurable: true
    };
    newDescr.set.rawSet = propDescr.set;
    return newDescr;
}
function getBackingStore(instance) {
    var proto = Object.getPrototypeOf(instance);
    processPendingStores(proto);
    var bs = instance._backingStore;
    if (!bs) {
        bs = {};
        instance._backingStore = bs;
    }
    return bs;
}
// workaround for IE9 bug where instance properties cannot be changed when executing a property 'set' method.
function getPendingBackingStore(instance) {
    var proto = Object.getPrototypeOf(instance);
    var pendingStores = proto._pendingBackingStores;
    var pending = core.arrayFirst(pendingStores, function (pending) {
        return pending.entity === instance;
    });
    if (pending)
        return pending.backingStore;
    var bs = {};
    pendingStores.push({ entity: instance, backingStore: bs });
    return bs;
}
function processPendingStores(proto) {
    var pendingStores = proto._pendingBackingStores;
    if (pendingStores) {
        pendingStores.forEach(function (pending) {
            pending.entity._backingStore = pending.backingStore;
        });
        pendingStores.length = 0;
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYWRhcHRlci1tb2RlbC1saWJyYXJ5LWJhY2tpbmctc3RvcmUuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9icmVlemUtY2xpZW50L2FkYXB0ZXItbW9kZWwtbGlicmFyeS1iYWNraW5nLXN0b3JlLyIsInNvdXJjZXMiOlsiYWRhcHRlci1tb2RlbC1saWJyYXJ5LWJhY2tpbmctc3RvcmUudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxLQUFLLE1BQU0sTUFBTSxlQUFlLENBQUM7QUFFeEMsSUFBSSxJQUFJLEdBQUcsTUFBTSxDQUFDLElBQUksQ0FBQztBQUV2QjtJQUdFO1FBQ0UsSUFBSSxDQUFDLElBQUksR0FBRyxjQUFjLENBQUM7SUFDN0IsQ0FBQztJQUVNLHdDQUFRLEdBQWYsVUFBZ0IsTUFBNEI7UUFDMUMsTUFBTSxHQUFHLE1BQU0sSUFBSSxNQUFNLENBQUMsTUFBTSxDQUFDO1FBQ2pDLE1BQU0sQ0FBQyxlQUFlLENBQUMsY0FBYyxFQUFFLCtCQUErQixDQUFDLENBQUM7UUFDeEUsT0FBTyxNQUFNLENBQUMseUJBQXlCLENBQUMsY0FBYyxFQUFFLGNBQWMsRUFBRSxJQUFJLENBQW9DLENBQUM7SUFDbkgsQ0FBQztJQUVELG9EQUFVLEdBQVY7SUFDQSxDQUFDO0lBRUQsbUVBQXlCLEdBQXpCLFVBQTBCLE1BQXFCO1FBQzdDLElBQUksS0FBSyxHQUFhLEVBQUUsQ0FBQztRQUN6QixLQUFLLElBQUksQ0FBQyxJQUFJLE1BQU0sRUFBRTtZQUNwQixJQUFJLENBQUMsS0FBSyxjQUFjLElBQUksQ0FBQyxLQUFLLFlBQVk7Z0JBQUUsU0FBUztZQUN6RCxJQUFJLENBQUMsS0FBSyxZQUFZLElBQUksQ0FBQyxLQUFLLGNBQWMsSUFBSSxDQUFDLEtBQUssZUFBZTtnQkFBRSxTQUFTO1lBQ2xGLElBQUksR0FBRyxHQUFHLE1BQU0sQ0FBQyxDQUFDLENBQUMsQ0FBQztZQUNwQixJQUFJLENBQUMsSUFBSSxDQUFDLFVBQVUsQ0FBQyxHQUFHLENBQUMsRUFB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R0FBRyxFQUFFLENBQUM7S0FDN0I7SUFDRCxPQUFPLEVBQUUsQ0FBQztBQUNaLENBQUM7QUFFRCw2R0FBNkc7QUFDN0csU0FBUyxzQkFBc0IsQ0FBQyxRQUFhO0lBQzNDLElBQUksS0FBSyxHQUFHLE1BQU0sQ0FBQyxjQUFjLENBQUMsUUFBUSxDQUFDLENBQUM7SUFDNUMsSUFBSSxhQUFhLEdBQUcsS0FBSyxDQUFDLHFCQUFxQixDQUFDO0lBQ2hELElBQUksT0FBTyxHQUFHLElBQUksQ0FBQyxVQUFVLENBQUMsYUFBYSxFQUFFLFVBQVUsT0FBTztRQUM1RCxPQUFPLE9BQU8sQ0FBQyxNQUFNLEtBQUssUUFBUSxDQUFDO0lBQ3JDLENBQUMsQ0FBQyxDQUFDO0lBQ0gsSUFBSSxPQUFPO1FBQUUsT0FBUSxPQUFlLENBQUMsWUFBWSxDQUFDO0lBQ2xELElBQUksRUFBRSxHQUFHLEVBQUUsQ0FBQztJQUNaLGFBQWEsQ0FBQyxJQUFJLENBQUMsRUFBRSxNQUFNLEVBQUUsUUFBUSxFQUFFLFlBQVksRUFBRSxFQUFFLEVBQUUsQ0FBQyxDQUFDO0lBQzNELE9BQU8sRUFBRSxDQUFDO0FBQ1osQ0FBQztBQUVELFNBQVMsb0JBQW9CLENBQUMsS0FBVTtJQUN0QyxJQUFJLGFBQWEsR0FBRyxLQUFLLENBQUMscUJBQXFCLENBQUM7SUFDaEQsSUFBSSxhQUFhLEVBQUU7UUFDakIsYUFBYSxDQUFDLE9BQU8sQ0FBQyxVQUFVLE9BQVk7WUFDMUMsT0FBTyxDQUFDLE1BQU0sQ0FBQyxhQUFhLEdBQUcsT0FBTyxDQUFDLFlBQVksQ0FBQztRQUN0RCxDQUFDLENBQUMsQ0FBQztRQUNILGFBQWEsQ0FBQyxNQUFNLEdBQUcsQ0FBQyxDQUFDO0tBQzFCO0FBQ0gsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCAqIGFzIGJyZWV6ZSBmcm9tICdicmVlemUtY2xpZW50JztcclxuXHJcbmxldCBjb3JlID0gYnJlZXplLmNvcmU7XHJcblxyXG5leHBvcnQgY2xhc3MgTW9kZWxMaWJyYXJ5QmFja2luZ1N0b3JlQWRhcHRlciBpbXBsZW1lbnRzIGJyZWV6ZS5Nb2RlbExpYnJhcnlBZGFwdGVyIHtcclxuICBuYW1lOiBzdHJpbmc7XHJcblxyXG4gIGNvbnN0cnVjdG9yKCkge1xyXG4gICAgdGhpcy5uYW1lID0gXCJiYWNraW5nU3RvcmVcIjtcclxuICB9XHJcblxyXG4gIHN0YXRpYyByZWdpc3Rlcihjb25maWc/OiBicmVlemUuQnJlZXplQ29uZmlnKSB7XHJcbiAgICBjb25maWcgPSBjb25maWcgfHwgYnJlZXplLmNvbmZpZztcclxuICAgIGNvbmZpZy5yZWdpc3RlckFkYXB0ZXIoXCJtb2RlbExpYnJhcnlcIiwgTW9kZWxMaWJyYXJ5QmFja2luZ1N0b3JlQWRhcHRlcik7XHJcbiAgICByZXR1cm4gY29uZmlnLmluaXRpYWxpemVBZGFwdGVySW5zdGFuY2UoXCJtb2RlbExpYnJhcnlcIiwgXCJiYWNraW5nU3RvcmVcIiwgdHJ1ZSkgYXMgTW9kZWxMaWJyYXJ5QmFja2luZ1N0b3JlQWRhcHRlcjtcclxuICB9XHJcblxyXG4gIGluaXRpYWxpemUoKSB7XHJcbiAgfVxyXG5cclxuICBnZXRUcmFja2FibGVQcm9wZXJ0eU5hbWVzKGVudGl0eTogYnJlZXplLkVudGl0eSkge1xyXG4gICAgbGV0IG5hbWVzOiBzdHJpbmdbXSA9IFtdO1xyXG4gICAgZm9yIChsZXQgcCBpbiBlbnRpdHkpIHtcclxuICAgICAgaWYgKHAgPT09IFwiZW50aXR5QXNwZWN0XCIgfHwgcCA9PT0gXCJlbnRpdHlUeXBlXCIpIGNvbnRpbnVlO1xyXG4gICAgICBpZiAocCA9PT0gXCJfJHR5cGVOYW1lXCIgfHwgcCA9PT0gXCJfcGVuZGluZ1NldHNcIiB8fCBwID09PSBcIl9iYWNraW5nU3RvcmVcIikgY29udGludWU7XHJcbiAgICAgIGxldCB2YWwgPSBlbnRpdHlbcF07XHJcbiAgICAgIGlmICghY29yZS5pc0Z1bmN0aW9uKHZhbCkpIHtcclxuICAgICAgICBuYW1lcy5wdXNoKHApO1xyXG4gICAgICB9XHJcbiAgICB9XHJcbiAgICByZXR1cm4gbmFtZXM7XHJcbiAgfVxyXG5cclxuICAvLyBUaGlzIG1ldGhvZCBpcyBjYWxsZWQgZHVyaW5nIE1ldGFkYXRhIGluaXRpYWxpemF0aW9uXHJcbiAgaW5pdGlhbGl6ZUVudGl0eVByb3RvdHlwZShwcm90bzogYW55KSB7XHJcblxyXG4gICAgcHJvdG8uZ2V0UHJvcGVydHkgPSBmdW5jdGlvbiAocHJvcGVydHlOYW1lOiBzdHJpbmcpIHtcclxuICAgICAgcmV0dXJuIHRoaXNbcHJvcGVydHlOYW1lXTtcclxuICAgIH07XHJcblxyXG4gICAgcHJvdG8uc2V0UHJvcGVydHkgPSBmdW5jdGlvbiAocHJvcGVydHlOYW1lOiBzdHJpbmcsIHZhbHVlOiBhbnkpIHtcclxuICAgICAgLy9pZiAoIXRoaXMuX2JhY2tpbmdTdG9yZS5oYXNPd25Qcm9wZXJ0eShwcm9wZXJ0eU5hbWUpKSB7XHJcbiAgICAgIC8vICAgIHRocm93IG5ldyBFcnJvcihcIlVua25vd24gcHJvcGVydHkgbmFtZTpcIiArIHByb3BlcnR5TmFtZSk7XHJcbiAgICAgIC8vfVxyXG4gICAgICB0aGlzW3Byb3BlcnR5TmFtZV0gPSB2YWx1ZTtcclxuICAgICAgLy8gYWxsb3cgc2V0UHJvcGVydHkgY2hhaW5pbmcuXHJcbiAgICAgIHJldHVybiB0aGlzO1xyXG4gICAgfTtcclxuXHJcbiAgICBtb3ZlUHJvcERlZnNUb1Byb3RvKHByb3RvKTtcclxuICB9XHJcblxyXG4gIC8vIFRoaXMgbWV0aG9kIGlzIGNhbGxlZCB3aGVuIGFuIEVudGl0eUFzcGVjdCBpcyBmaXJzdCBjcmVhdGVkIC0gdGhpcyB3aWxsIG9jY3VyIGFzIHBhcnQgb2YgdGhlIGVudGl0eVR5cGUuY3JlYXRlRW50aXR5IGNhbGwuXHJcbiAgLy8gd2hpY2ggY2FuIGJlIGNhbGxlZCBlaXRoZXIgZGlyZWN0bHkgb3IgdmlhIHN0YW5kYXJkIHF1ZXJ5IG1hdGVyaWFsaXphdGlvblxyXG5cclxuICAvLyBlbnRpdHkgaXMgZWl0aGVyIGFuIGVudGl0eSBvciBhIGNvbXBsZXhPYmplY3RcclxuICBzdGFydFRyYWNraW5nKGVudGl0eTogYnJlZXplLlN0cnVjdHVyYWxPYmplY3QsIHByb3RvOiBhbnkpIHtcclxuICAgIC8vIGNhbid0IHRvdWNoIHRoZSBub3JtYWwgcHJvcGVydHkgc2V0cyB3aXRoaW4gdGhpcyBtZXRob2QgLSBhY2Nlc3MgdGhlIGJhY2tpbmdTdG9yZSBkaXJlY3RseSBpbnN0ZWFkLlxyXG4gICAgbGV0IGJzID0gbW92ZVByb3BzVG9CYWNraW5nU3RvcmUoZW50aXR5KTtcclxuXHJcbiAgICAvLyBhc3NpZ24gZGVmYXVsdCB2YWx1ZXMgdG8gdGhlIGVudGl0eVxyXG4gICAgbGV0IHN0eXBlID0gYnJlZXplLkVudGl0eUFzcGVjdC5pc0VudGl0eShlbnRpdHkpID8gZW50aXR5LmVudGl0eVR5cGUgOiBlbnRpdHkuY29tcGxleFR5cGU7XHJcbiAgICBzdHlwZS5nZXRQcm9wZXJ0aWVzKCkuZm9yRWFjaChmdW5jdGlvbiAocHJvcCkge1xyXG5cclxuICAgICAgbGV0IHByb3BOYW1lID0gcHJvcC5uYW1lO1xyXG4gICAgICBsZXQgdmFsID0gZW50aXR5W3Byb3BOYW1lXTtcclxuXHJcbiAgICAgIGlmIChwcm9wIGluc3RhbmNlb2YgYnJlZXplLkRhdGFQcm9wZXJ0eSkge1xyXG4gICAgICAgIGlmIChwcm9wLmlzQ29tcGxleFByb3BlcnR5KSB7XHJcbiAgICAgICAgICBpZiAocHJvcC5pc1NjYWxhcikge1xyXG4gICAgICAgICAgICB2YWwgPSAocHJvcC5kYXRhVHlwZSBhcyBicmVlemUuQ29tcGxleFR5cGUpLl9jcmVhdGVJbnN0YW5jZUNvcmUoZW50aXR5LCBwcm9wKTtcclxuICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgIHZhbCA9IGJyZWV6ZS5tYWtlQ29tcGxleEFycmF5KFtdLCBlbnRpdHksIHByb3ApO1xyXG4gICAgICAgICAgfVxyXG4gICAgICAgIH0gZWxzZSBpZiAoIXByb3AuaXNTY2FsYXIpIHtcclxuICAgICAgICAgIHZhbCA9IGJyZWV6ZS5tYWtlUHJpbWl0aXZlQXJyYXkoW10sIGVudGl0eSwgcHJvcCk7XHJcbiAgICAgICAgfSBlbHNlIGlmICh2YWwgPT09IHVuZGVmaW5lZCkge1xyXG4gICAgICAgICAgdmFsID0gcHJvcC5kZWZhdWx0VmFsdWU7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgfSBlbHNlIGlmIChwcm9wLmlzTmF2aWdhdGlvblByb3BlcnR5KSB7XHJcbiAgICAgICAgaWYgKHZhbCAhPT0gdW5kZWZpbmVkICYmIHZhbCAhPT0gbnVsbCkge1xyXG4gICAgICAgICAgdGhyb3cgbmV3IEVycm9yKFwiQ2Fubm90IGFzc2lnbiBhIG5hdmlnYXRpb24gcHJvcGVydHkgaW4gYW4gZW50aXR5IGN0b3IuOiBcIiArIHByb3BOYW1lKTtcclxuICAgICAgICB9XHJcbiAgICAgICAgaWYgKHByb3AuaXNTY2FsYXIpIHtcclxuICAgICAgICAgIC8vIFRPRE86IGNoYW5nZSB0aGlzIHRvIG51bGxzdG9iIGxhdGVyLlxyXG4gICAgICAgICAgdmFsID0gbnVsbDtcclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgdmFsID0gYnJlZXplLm1ha2VSZWxhdGlvbkFycmF5KFtdLCBlbnRpdHkgYXMgYnJlZXplLkVudGl0eSwgcHJvcCk7XHJcbiAgICAgICAgfVxyXG4gICAgICB9IGVsc2Uge1xyXG4gICAgICAgIHRocm93IG5ldyBFcnJvcihcInVua25vd24gcHJvcGVydHk6IFwiICsgcHJvcE5hbWUpO1xyXG4gICAgICB9XHJcbiAgICAgIC8vIGNhbid0IHRvdWNoIHRoZSBub3JtYWwgcHJvcGVydHkgc2V0cyB3aXRoaW4gdGhpcyBtZXRob2QgKElFOSBCdWcpIC0gc28gd2UgYWNjZXNzIHRoZSBiYWNraW5nU3RvcmUgZGlyZWN0bHkgaW5zdGVhZC5cclxuICAgICAgLy8gb3RoZXJ3aXNlIHdlIGNvdWxkIGp1c3QgZG9cclxuICAgICAgLy8gZW50aXR5W3Byb3BOYW1lXSA9IHZhbFxyXG4gICAgICAvLyBhZnRlciBhbGwgb2YgdGhlIGludGVyY2VwdGlvbiBsb2dpYyBoYWQgYmVlbiBpbmplY3RlZC5cclxuICAgICAgaWYgKChwcm9wIGFzIGJyZWV6ZS5EYXRhUHJvcGVydHkpLmlzU2V0dGFibGUgfHwgcHJvcC5pc05hdmlnYXRpb25Qcm9wZXJ0eSkge1xyXG4gICAgICAgIGJzW3Byb3BOYW1lXSA9IHZhbDtcclxuICAgICAgfVxyXG4gICAgfSk7XHJcbiAgfVxyXG59XHJcblxyXG5icmVlemUuY29uZmlnLnJlZ2lzdGVyQWRhcHRlcihcIm1vZGVsTGlicmFyeVwiLCBNb2RlbExpYnJhcnlCYWNraW5nU3RvcmVBZGFwdGVyKTtcclxuXHJcbi8vIHByaXZhdGUgbWV0aG9kc1xyXG5cclxuLy8gVGhpcyBtZXRob2QgaXMgY2FsbGVkIGR1cmluZyBNZXRhZGF0YSBpbml0aWFsaXphdGlvbiB0byBjb3JyZWN0bHkgXCJ3cmFwXCIgcHJvcGVydGllcy5cclxuZnVuY3Rpb24gbW92ZVByb3BEZWZzVG9Qcm90byhwcm90bzogYW55KSB7XHJcbiAgbGV0IHN0eXBlID0gKHByb3RvLmVudGl0eVR5cGUgfHwgcHJvdG8uY29tcGxleFR5cGUpIGFzIGJyZWV6ZS5TdHJ1Y3R1cmFsVHlwZTtcclxuICBsZXQgZXh0cmEgPSBzdHlwZS5fZXh0cmE7XHJcblxyXG4gIGxldCBhbHJlYWR5V3JhcHBlZCA9IGV4dHJhLmFscmVhZHlXcmFwcGVkUHJvcHMgfHwge307XHJcblxyXG4gIHN0eXBlLmdldFByb3BlcnRpZXMoKS5mb3JFYWNoKGZ1bmN0aW9uIChwcm9wKSB7XHJcbiAgICBsZXQgcHJvcE5hbWUgPSBwcm9wLm5hbWU7XHJcbiAgICAvLyB3ZSBvbmx5IHdhbnQgdG8gd3JhcCBwcm9wcyB0aGF0IGhhdmVuJ3QgYWxyZWFkeSBiZWVuIHdyYXBwZWRcclxuICAgIGlmIChhbHJlYWR5V3JhcHBlZFtwcm9wTmFtZV0pIHJldHVybjtcclxuXHJcbiAgICAvLyBJZiBwcm9wZXJ0eSBpcyBhbHJlYWR5IGRlZmluZWQgb24gdGhlIHByb3RvdHlwZSB0aGVuIHdyYXAgaXQgaW4gYW5vdGhlciBwcm9wZXJ0eURlc2NyaXB0b3IuXHJcbiAgICAvLyBvdGhlcndpc2UgY3JlYXRlIGEgcHJvcERlc2NyaXB0b3IgZm9yIGl0LlxyXG4gICAgbGV0IGRlc2NyOiBhbnk7XHJcbiAgICBpZiAocHJvcE5hbWUgaW4gcHJvdG8pIHtcclxuICAgICAgZGVzY3IgPSB3cmFwUHJvcERlc2NyaXB0aW9uKHByb3RvLCBwcm9wKTtcclxuICAgIH0gZWxzZSB7XHJcbiAgICAgIGRlc2NyID0gbWFrZVByb3BEZXNjcmlwdGlvbihwcm90bywgcHJvcCk7XHJcbiAgICB9XHJcbiAgICAvLyBkZXNjciB3aWxsIGJlIG51bGwgZm9yIGEgd3JhcHBlZCBkZXNjciB0aGF0IGlzIG5vdCBjb25maWd1cmFibGVcclxuICAgIGlmIChkZXNjciAhPSBudWxsKSB7XHJcbiAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShwcm90bywgcHJvcE5hbWUsIGRlc2NyKTtcclxuICAgIH1cclxuICAgIGFscmVhZHlXcmFwcGVkW3Byb3BOYW1lXSA9IHRydWU7XHJcbiAgfSk7XHJcbiAgZXh0cmEuYWxyZWFkeVdyYXBwZWRQcm9wcyA9IGFscmVhZHlXcmFwcGVkO1xyXG59XHJcblxyXG4vLyBUaGlzIG1ldGhvZCBpcyBjYWxsZWQgd2hlbiBhbiBpbnN0YW5jZSBpcyBmaXJzdCBjcmVhdGVkIHZpYSBtYXRlcmlhbGl6YXRpb24gb3IgY3JlYXRlRW50aXR5LlxyXG4vLyB0aGlzIG1ldGhvZCBjYW5ub3QgYmUgY2FsbGVkIHdoaWxlIGEgJ2RlZmluZVByb3BlcnR5JyBhY2Nlc3NvciBpcyBleGVjdXRpbmdcclxuLy8gYmVjYXVzZSBvZiBJRSBidWcgbWVudGlvbmVkIGFib3ZlLlxyXG5cclxuZnVuY3Rpb24gbW92ZVByb3BzVG9CYWNraW5nU3RvcmUoaW5zdGFuY2U6IGFueSkge1xyXG5cclxuICBsZXQgYnMgPSBnZXRCYWNraW5nU3RvcmUoaW5zdGFuY2UpO1xyXG4gIGxldCBwcm90byA9IE9iamVjdC5nZXRQcm90b3R5cGVPZihpbnN0YW5jZSk7XHJcbiAgbGV0IHN0eXBlID0gKHByb3RvLmVudGl0eVR5cGUgfHwgcHJvdG8uY29tcGxleFR5cGUpIGFzIGJyZWV6ZS5TdHJ1Y3R1cmFsVHlwZTtcclxuICBzdHlwZS5nZXRQcm9wZXJ0aWVzKCkuZm9yRWFjaChmdW5jdGlvbiAocHJvcCkge1xyXG4gICAgbGV0IHByb3BOYW1lID0gcHJvcC5uYW1lO1xyXG4gICAgaWYgKHByb3AuaXNVbm1hcHBlZCkge1xyXG4gICAgICAvLyBpbnN1cmUgdGhhdCBhbnkgdW5tYXBwZWQgcHJvcGVydGllcyB0aGF0IHdlcmUgYWRkZWQgYWZ0ZXIgZW50aXR5VHlwZVxyXG4gICAgICAvLyB3YXMgZmlyc3QgY3JlYXRlZCBhcmUgd3JhcHBlZCB3aXRoIGEgcHJvcGVydHkgZGVzY3JpcHRvci5cclxuICAgICAgaWYgKCFjb3JlLmdldFByb3BlcnR5RGVzY3JpcHRvcihwcm90bywgcHJvcE5hbWUpKSB7XHJcbiAgICAgICAgbGV0IGRlc2NyID0gbWFrZVByb3BEZXNjcmlwdGlvbihwcm90bywgcHJvcCk7XHJcbiAgICAgICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KHByb3RvLCBwcm9wTmFtZSwgZGVzY3IpO1xyXG4gICAgICB9XHJcbiAgICB9XHJcbiAgICBpZiAoIWluc3RhbmNlLmhhc093blByb3BlcnR5KHByb3BOYW1lKSkgcmV0dXJuO1xyXG4gICAgLy8gcHVsbHMgb2ZmIHRoZSB2YWx1ZSwgcmVtb3ZlcyB0aGUgaW5zdGFuY2UgcHJvcGVydHkgYW5kIHRoZW4gcmV3cml0ZXMgaXQgdmlhIEVTNSBhY2Nlc3NvclxyXG4gICAgbGV0IHZhbHVlID0gaW5zdGFuY2VbcHJvcE5hbWVdO1xyXG4gICAgZGVsZXRlIGluc3RhbmNlW3Byb3BOYW1lXTtcclxuICAgIGluc3RhbmNlW3Byb3BOYW1lXSA9IHZhbHVlO1xyXG4gIH0pO1xyXG4gIHJldHVybiBicztcclxufVxyXG5cclxuZnVuY3Rpb24gbWFrZVByb3BEZXNjcmlwdGlvbihwcm90bzogYW55LCBwcm9wZXJ0eTogYnJlZXplLkVudGl0eVByb3BlcnR5KSB7XHJcbiAgbGV0IHByb3BOYW1lID0gcHJvcGVydHkubmFtZTtcclxuICBsZXQgcGVuZGluZ1N0b3JlcyA9IHByb3RvLl9wZW5kaW5nQmFja2luZ1N0b3JlcztcclxuICBpZiAoIXBlbmRpbmdTdG9yZXMpIHtcclxuICAgIHBlbmRpbmdTdG9yZXMgPSBbXTtcclxuICAgIHByb3RvLl9wZW5kaW5nQmFja2luZ1N0b3JlcyA9IHBlbmRpbmdTdG9yZXM7XHJcbiAgfVxyXG4gIGxldCBkZXNjciA9IHtcclxuICAgIGdldDogZnVuY3Rpb24gKCkge1xyXG4gICAgICBsZXQgYnMgPSB0aGlzLl9iYWNraW5nU3RvcmUgfHwgZ2V0QmFja2luZ1N0b3JlKHRoaXMpO1xyXG4gICAgICByZXR1cm4gYnNbcHJvcE5hbWVdO1xyXG4gICAgfSxcclxuICAgIHNldDogZnVuY3Rpb24gKHZhbHVlOiBhbnkpIHtcclxuICAgICAgLy8gSUU5IGNhbm5vdCB0b3VjaCBpbnN0YW5jZS5fYmFja2luZ1N0b3JlIGhlcmVcclxuICAgICAgbGV0IGJzID0gdGhpcy5fYmFja2luZ1N0b3JlIHx8IGdldFBlbmRpbmdCYWNraW5nU3RvcmUodGhpcyk7XHJcbiAgICAgIGxldCBhY2Nlc3NvckZuID0gZ2V0QWNjZXNzb3JGbihicywgcHJvcE5hbWUpO1xyXG4gICAgICB0aGlzLl8kaW50ZXJjZXB0b3IocHJvcGVydHksIHZhbHVlLCBhY2Nlc3NvckZuKTtcclxuICAgIH0sXHJcbiAgICBlbnVtZXJhYmxlOiB0cnVlLFxyXG4gICAgY29uZmlndXJhYmxlOiB0cnVlXHJcbiAgfTtcclxuXHJcbiAgKGRlc2NyLnNldCBhcyBhbnkpLnJhd1NldCA9IGZ1bmN0aW9uICh2YWx1ZTogYW55KSB7XHJcbiAgICBsZXQgYnMgPSB0aGlzLl9iYWNraW5nU3RvcmUgfHwgZ2V0UGVuZGluZ0JhY2tpbmdTdG9yZSh0aGlzKTtcclxuICAgIGxldCBhY2Nlc3NvckZuID0gZ2V0QWNjZXNzb3JGbihicywgcHJvcE5hbWUpO1xyXG4gICAgYWNjZXNzb3JGbih2YWx1ZSk7XHJcbiAgfTtcclxuICByZXR1cm4gZGVzY3I7XHJcblxyXG59XHJcblxyXG5mdW5jdGlvbiBnZXRBY2Nlc3NvckZuKGJzOiB7fSwgcHJvcE5hbWU6IHN0cmluZyk6IGFueSB7XHJcbiAgcmV0dXJuIGZ1bmN0aW9uICgpIHtcclxuICAgIGlmIChhcmd1bWVudHMubGVuZ3RoID09PSAwKSB7XHJcbiAgICAgIHJldHVybiBic1twcm9wTmFtZV07XHJcbiAgICB9IGVsc2Uge1xyXG4gICAgICBic1twcm9wTmFtZV0gPSBhcmd1bWVudHNbMF07XHJcbiAgICAgIHJldHVybiB1bmRlZmluZWQ7XHJcbiAgICB9XHJcbiAgfTtcclxufVxyXG5cclxuZnVuY3Rpb24gd3JhcFByb3BEZXNjcmlwdGlvbihwcm90bzogYW55LCBwcm9wZXJ0eTogYnJlZXplLkVudGl0eVByb3BlcnR5KTogYW55IHtcclxuICBpZiAoIXByb3RvLmhhc093blByb3BlcnR5KHByb3BlcnR5Lm5hbWUpKSB7XHJcbiAgICBsZXQgbmV4dFByb3RvID0gT2JqZWN0LmdldFByb3RvdHlwZU9mKHByb3RvKTtcclxuICAgIHJldHVybiB3cmFwUHJvcERlc2NyaXB0aW9uKG5leHRQcm90bywgcHJvcGVydHkpO1xyXG4gIH1cclxuXHJcbiAgbGV0IHByb3BEZXNjciA9IE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3IocHJvdG8sIHByb3BlcnR5Lm5hbWUpO1xyXG4gIGlmICghcHJvcERlc2NyKSByZXR1cm4gdW5kZWZpbmVkO1xyXG4gIC8vIGlmIG5vdCBjb25maWd1cmFibGU7IHdlIGNhbid0IHRvdWNoIGl0IC0gc28gbGVhdmUuXHJcbiAgaWYgKCFwcm9wRGVzY3IuY29uZmlndXJhYmxlKSByZXR1cm4gdW5kZWZpbmVkO1xyXG4gIC8vIGlmIGEgZGF0YSBkZXNjcmlwdG9yIC0gZG9uJ3QgY2hhbmdlIGl0IC0gdGhpcyBpcyBiYXNpY2FsbHkgYSBzdGF0aWMgcHJvcGVydHkgLSBpLmUuIGRlZmluZWQgb24gZXZlcnkgaW5zdGFuY2Ugb2YgdGhlIHR5cGUgd2l0aCB0aGUgc2FtZSB2YWx1ZS5cclxuICBpZiAocHJvcERlc2NyLnZhbHVlKSByZXR1cm4gdW5kZWZpbmVkO1xyXG4gIC8vIGlmIGEgcmVhZCBvbmx5IHByb3BlcnR5IGRlc2NyaXB0b3IgLSBubyBuZWVkIHRvIGNoYW5nZSBpdC5cclxuICBpZiAoIXByb3BEZXNjci5zZXQpIHJldHVybiB1bmRlZmluZWQ7XHJcblxyXG4gIGxldCBsb2NhbEFjY2Vzc29yRm4gPSBmdW5jdGlvbiAoZW50aXR5OiBhbnkpIHtcclxuICAgIHJldHVybiBmdW5jdGlvbiAoKSB7XHJcbiAgICAgIGlmICghcHJvcERlc2NyKSByZXR1cm4gdW5kZWZpbmVkO1xyXG4gICAgICBpZiAoYXJndW1lbnRzLmxlbmd0aCA9PT0gMCkge1xyXG4gICAgICAgIHJldHVybiBwcm9wRGVzY3IuZ2V0IS5iaW5kKGVudGl0eSkoKTtcclxuICAgICAgfSBlbHNlIHtcclxuICAgICAgICBsZXQgc2V0ID0gcHJvcERlc2NyLnNldDtcclxuICAgICAgICBsZXQgcmF3U2V0ID0gKHNldCBhcyBhbnkpLnJhd1NldCB8fCBzZXQ7XHJcbiAgICAgICAgcmF3U2V0LmJpbmQoZW50aXR5KShhcmd1bWVudHNbMF0pO1xyXG4gICAgICAgIHJldHVybiB1bmRlZmluZWQ7XHJcbiAgICAgIH1cclxuICAgIH07XHJcbiAgfTtcclxuXHJcbiAgbGV0IG5ld0Rlc2NyID0ge1xyXG4gICAgZ2V0OiBmdW5jdGlvbiAoKSB7XHJcbiAgICAgIGlmICghcHJvcERlc2NyKSByZXR1cm4gdW5kZWZpbmVkO1xyXG4gICAgICByZXR1cm4gcHJvcERlc2NyLmdldCEuYmluZCh0aGlzKSgpO1xyXG4gICAgfSxcclxuICAgIHNldDogZnVuY3Rpb24gKHZhbHVlOiBhbnkpIHtcclxuICAgICAgdGhpcy5fJGludGVyY2VwdG9yKHByb3BlcnR5LCB2YWx1ZSwgbG9jYWxBY2Nlc3NvckZuKHRoaXMpKTtcclxuICAgIH0sXHJcbiAgICBlbnVtZXJhYmxlOiBwcm9wRGVzY3IuZW51bWVyYWJsZSxcclxuICAgIGNvbmZpZ3VyYWJsZTogdHJ1ZVxyXG4gIH07XHJcbiAgKG5ld0Rlc2NyLnNldCBhcyBhbnkpLnJhd1NldCA9IHByb3BEZXNjci5zZXQ7XHJcbiAgcmV0dXJuIG5ld0Rlc2NyO1xyXG59XHJcblxyXG5cclxuZnVuY3Rpb24gZ2V0QmFja2luZ1N0b3JlKGluc3RhbmNlOiBhbnkpIHtcclxuICBsZXQgcHJvdG8gPSBPYmplY3QuZ2V0UHJvdG90eXBlT2YoaW5zdGFuY2UpO1xyXG4gIHByb2Nlc3NQZW5kaW5nU3RvcmVzKHByb3RvKTtcclxuICBsZXQgYnMgPSBpbnN0YW5jZS5fYmFja2luZ1N0b3JlO1xyXG4gIGlmICghYnMpIHtcclxuICAgIGJzID0ge307XHJcbiAgICBpbnN0YW5jZS5fYmFja2luZ1N0b3JlID0gYnM7XHJcbiAgfVxyXG4gIHJldHVybiBicztcclxufVxyXG5cclxuLy8gd29ya2Fyb3VuZCBmb3IgSUU5IGJ1ZyB3aGVyZSBpbnN0YW5jZSBwcm9wZXJ0aWVzIGNhbm5vdCBiZSBjaGFuZ2VkIHdoZW4gZXhlY3V0aW5nIGEgcHJvcGVydHkgJ3NldCcgbWV0aG9kLlxyXG5mdW5jdGlvbiBnZXRQZW5kaW5nQmFja2luZ1N0b3JlKGluc3RhbmNlOiBhbnkpIHtcclxuICBsZXQgcHJvdG8gPSBPYmplY3QuZ2V0UHJvdG90eXBlT2YoaW5zdGFuY2UpO1xyXG4gIGxldCBwZW5kaW5nU3RvcmVzID0gcHJvdG8uX3BlbmRpbmdCYWNraW5nU3RvcmVzO1xyXG4gIGxldCBwZW5kaW5nID0gY29yZS5hcnJheUZpcnN0KHBlbmRpbmdTdG9yZXMsIGZ1bmN0aW9uIChwZW5kaW5nKSB7XHJcbiAgICByZXR1cm4gcGVuZGluZy5lbnRpdHkgPT09IGluc3RhbmNlO1xyXG4gIH0pO1xyXG4gIGlmIChwZW5kaW5nKSByZXR1cm4gKHBlbmRpbmcgYXMgYW55KS5iYWNraW5nU3RvcmU7XHJcbiAgbGV0IGJzID0ge307XHJcbiAgcGVuZGluZ1N0b3Jlcy5wdXNoKHsgZW50aXR5OiBpbnN0YW5jZSwgYmFja2luZ1N0b3JlOiBicyB9KTtcclxuICByZXR1cm4gYnM7XHJcbn1cclxuXHJcbmZ1bmN0aW9uIHByb2Nlc3NQZW5kaW5nU3RvcmVzKHByb3RvOiBhbnkpIHtcclxuICBsZXQgcGVuZGluZ1N0b3JlcyA9IHByb3RvLl9wZW5kaW5nQmFja2luZ1N0b3JlcztcclxuICBpZiAocGVuZGluZ1N0b3Jlcykge1xyXG4gICAgcGVuZGluZ1N0b3Jlcy5mb3JFYWNoKGZ1bmN0aW9uIChwZW5kaW5nOiBhbnkpIHtcclxuICAgICAgcGVuZGluZy5lbnRpdHkuX2JhY2tpbmdTdG9yZSA9IHBlbmRpbmcuYmFja2luZ1N0b3JlO1xyXG4gICAgfSk7XHJcbiAgICBwZW5kaW5nU3RvcmVzLmxlbmd0aCA9IDA7XHJcbiAgfVxyXG59XHJcblxyXG4iXX0=