import * as breeze from 'breeze-client';
var UriBuilderODataAdapter = /** @class */ (function () {
    function UriBuilderODataAdapter() {
        this.name = "odata";
    }
    UriBuilderODataAdapter.register = function (config) {
        config = config || breeze.config;
        config.registerAdapter("uriBuilder", UriBuilderODataAdapter);
        return config.initializeAdapterInstance("uriBuilder", "odata", true);
    };
    UriBuilderODataAdapter.prototype.initialize = function () { };
    UriBuilderODataAdapter.prototype.buildUri = function (entityQuery, metadataStore) {
        // force entityType validation;
        var entityType = entityQuery._getFromEntityType(metadataStore, false);
        if (!entityType) {
            // anonymous type but still has naming convention info avail
            entityType = new breeze.EntityType(metadataStore);
        }
        var queryOptions = {};
        queryOptions["$filter"] = toWhereODataFragment(entityQuery.wherePredicate);
        queryOptions["$orderby"] = toOrderByODataFragment(entityQuery.orderByClause);
        if (entityQuery.skipCount) {
            queryOptions["$skip"] = entityQuery.skipCount;
        }
        if (entityQuery.takeCount != null) {
            queryOptions["$top"] = entityQuery.takeCount;
        }
        queryOptions["$expand"] = toExpandODataFragment(entityQuery.expandClause);
        queryOptions["$select"] = toSelectODataFragment(entityQuery.selectClause);
        if (entityQuery.inlineCountEnabled) {
            queryOptions["$inlinecount"] = "allpages";
        }
        var qoText = toQueryOptionsString(queryOptions);
        var sep = entityQuery.resourceName.includes("?") ? "&" : "?";
        return entityQuery.resourceName + sep + qoText;
        // private methods to this func.
        function toWhereODataFragment(wherePredicate) {
            if (!wherePredicate)
                return undefined;
            // validation occurs inside of the toODataFragment call here.
            var frag = wherePredicate.visit({ entityType: entityType }, toODataFragmentVisitor);
            return (frag && frag.length > 0) ? frag : undefined;
        }
        function toOrderByODataFragment(orderByClause) {
            if (!orderByClause)
                return undefined;
            orderByClause.validate(entityType);
            var strings = orderByClause.items.map(function (item) {
                return entityType.clientPropertyPathToServer(item.propertyPath, "/") + (item.isDesc ? " desc" : "");
            });
            // should return something like CompanyName,Address/City desc
            return strings.join(',');
        }
        function toSelectODataFragment(selectClause) {
            if (!selectClause)
                return undefined;
            selectClause.validate(entityType);
            var frag = selectClause.propertyPaths.map(function (pp) {
                return entityType.clientPropertyPathToServer(pp, "/");
            }).join(",");
            return frag;
        }
        function toExpandODataFragment(expandClause) {
            if (!expandClause)
                return undefined;
            // no validate on expand clauses currently.
            // expandClause.validate(entityType);
            var frag = expandClause.propertyPaths.map(function (pp) {
                return entityType.clientPropertyPathToServer(pp, "/");
            }).join(",");
            return frag;
        }
        function toQueryOptionsString(queryOptions) {
            var qoStrings = [];
            var _loop_1 = function (qoName) {
                var qoValue = queryOptions[qoName];
                if (qoValue !== undefined) {
                    if (qoValue instanceof Array) {
                        qoValue.forEach(function (qov) {
                            qoStrings.push(qoName + "=" + encodeURIComponent(qov));
                        });
                    }
                    else {
                        qoStrings.push(qoName + "=" + encodeURIComponent(qoValue));
                    }
                }
            };
            for (var qoName in queryOptions) {
                _loop_1(qoName);
            }
            if (qoStrings.length > 0) {
                return qoStrings.join("&");
            }
            else {
                return "";
            }
        }
    };
    return UriBuilderODataAdapter;
}());
export { UriBuilderODataAdapter };
breeze.Predicate.prototype.toODataFragment = function (context) {
    return this.visit(context, toODataFragmentVisitor);
};
var ɵ0 = function () {
    return this.value;
}, ɵ1 = function (context) {
    var predVal = this.pred.visit(context);
    return odataOpFrom(this) + " " + "(" + predVal + ")";
}, ɵ2 = function (context) {
    var expr1Val = this.expr1.visit(context);
    var expr2Val = this.expr2.visit(context);
    var prefix = context.prefix;
    if (prefix) {
        expr1Val = prefix + "/" + expr1Val;
    }
    var odataOp = odataOpFrom(this);
    if (this.op.key === 'in') {
        var result = expr2Val.map(function (v) {
            return "(" + expr1Val + " eq " + v + ")";
        }).join(" or ");
        return result;
    }
    else if (this.op.isFunction) {
        if (odataOp === "substringof") {
            return odataOp + "(" + expr2Val + "," + expr1Val + ") eq true";
        }
        else {
            return odataOp + "(" + expr1Val + "," + expr2Val + ") eq true";
        }
    }
    else {
        return expr1Val + " " + odataOp + " " + expr2Val;
    }
}, ɵ3 = function (context) {
    var result = this.preds.map(function (pred) {
        var predVal = pred.visit(context);
        return "(" + predVal + ")";
    }).join(" " + odataOpFrom(this) + " ");
    return result;
}, ɵ4 = function (context) {
    var exprVal = this.expr.visit(context);
    if (!this.pred.op) { // added 21-Oct-2016 to fix breeze.js issue #172
        return exprVal + "/" + odataOpFrom(this) + "()";
    }
    var prefix = context.prefix;
    if (prefix) {
        exprVal = prefix + "/" + exprVal;
        prefix = "x" + (parseInt(prefix.substring(1)) + 1);
    }
    else {
        prefix = "x1";
    }
    // need to create a new context because of 'prefix'
    var newContext = breeze.core.extend({}, context);
    newContext.entityType = this.expr.dataType;
    newContext.prefix = prefix;
    var newPredVal = this.pred.visit(newContext);
    return exprVal + "/" + odataOpFrom(this) + "(" + prefix + ": " + newPredVal + ")";
}, ɵ5 = function () {
    if (Array.isArray(this.value)) {
        return this.value.map(function (v) { return this.dataType.fmtOData(v); }, this);
    }
    else {
        return this.dataType.fmtOData(this.value);
    }
}, ɵ6 = function (context) {
    var entityType = context.entityType;
    // '/' is the OData path delimiter
    return entityType ? entityType.clientPropertyPathToServer(this.propertyPath, "/") : this.propertyPath;
}, ɵ7 = function (context) {
    var exprVals = this.exprs.map(function (expr) {
        return expr.visit(context);
    });
    return this.fnName + "(" + exprVals.join(",") + ")";
};
var toODataFragmentVisitor = {
    passthruPredicate: ɵ0,
    unaryPredicate: ɵ1,
    binaryPredicate: ɵ2,
    andOrPredicate: ɵ3,
    anyAllPredicate: ɵ4,
    litExpr: ɵ5,
    propExpr: ɵ6,
    fnExpr: ɵ7
};
var _operatorMap = {
    'contains': 'substringof'
};
function odataOpFrom(node) {
    var op = node.op.key;
    var odataOp = _operatorMap[op];
    return odataOp || op;
}
breeze.config.registerAdapter("uriBuilder", UriBuilderODataAdapter);
export { ɵ0, ɵ1, ɵ2, ɵ3, ɵ4, ɵ5, ɵ6, ɵ7 };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYWRhcHRlci11cmktYnVpbGRlci1vZGF0YS5qcyIsInNvdXJjZVJvb3QiOiJuZzovL2JyZWV6ZS1jbGllbnQvYWRhcHRlci11cmktYnVpbGRlci1vZGF0YS8iLCJzb3VyY2VzIjpbImFkYXB0ZXItdXJpLWJ1aWxkZXItb2RhdGEudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxLQUFLLE1BQU0sTUFBTSxlQUFlLENBQUM7QUFFeEM7SUFJRTtRQUNFLElBQUksQ0FBQyxJQUFJLEdBQUcsT0FBTyxDQUFDO0lBQ3RCLENBQUM7SUFFTSwrQkFBUSxHQUFmLFVBQWdCLE1BQTRCO1FBQzFDLE1BQU0sR0FBRyxNQUFNLElBQUksTUFBTSxDQUFDLE1BQU0sQ0FBQztRQUNqQyxNQUFNLENBQUMsZUFBZSxDQUFDLFlBQVksRUFBRSxzQkFBc0IsQ0FBQyxDQUFDO1FBQzdELE9BQU8sTUFBTSxDQUFDLHlCQUF5QixDQUFDLFlBQVksRUFBRSxPQUFPLEVBQUUsSUFBSSxDQUEyQixDQUFDO0lBQ2pHLENBQUM7SUFFRCwyQ0FBVSxHQUFWLGNBQWUsQ0FBQztJQUVoQix5Q0FBUSxHQUFSLFVBQVMsV0FBK0IsRUFBRSxhQUFtQztRQUMzRSwrQkFBK0I7UUFDL0IsSUFBSSxVQUFVLEdBQUcsV0FBVyxDQUFDLGtCQUFrQixDQUFDLGFBQWEsRUFBRSxLQUFLLENBQUMsQ0FBQztRQUN0RSxJQUFJLENBQUMsVUFBVSxFQUFFO1lBQ2YsNERBQTREO1lBQzVELFVBQVUsR0FBRyxJQUFJLE1BQU0sQ0FBQyxVQUFVLENBQUMsYUFBYSxDQUFDLENBQUM7U0FDbkQ7UUFFRCxJQUFJLFlBQVksR0FBRyxFQUFFLENBQUM7UUFDdEIsWUFBWSxDQUFDLFNBQVMsQ0FBQyxHQUFHLG9CQUFvQixDQUFDLFdBQVcsQ0FBQyxjQUFjLENBQUMsQ0FBQztRQUMzRSxZQUFZLENBQUMsVUFBVSxDQUFDLEdBQUcsc0JBQXNCLENBQUMsV0FBVyxDQUFDLGFBQWMsQ0FBQyxDQUFDO1FBRTlFLElBQUks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LEdBQUcsQ0FBQyxVQUFVLElBQUk7UUFDMUMsT0FBTyxJQUFJLENBQUMsS0FBSyxDQUFDLE9BQU8sQ0FBQyxDQUFDO0lBQzdCLENBQUMsQ0FBQyxDQUFDO0lBQ0gsT0FBTyxJQUFJLENBQUMsTUFBTSxHQUFHLEdBQUcsR0FBRyxRQUFRLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxHQUFHLEdBQUcsQ0FBQztBQUN0RCxDQUFDO0FBcEZILElBQUksc0JBQXNCLEdBQUc7SUFFM0IsaUJBQWlCLElBRWhCO0lBRUQsY0FBYyxJQUdiO0lBRUQsZUFBZSxJQXdCZDtJQUVELGNBQWMsSUFNYjtJQUVELGVBQWUsSUFrQmQ7SUFFRCxPQUFPLElBTU47SUFFRCxRQUFRLElBSVA7SUFFRCxNQUFNLElBS0w7Q0FDRixDQUFDO0FBRUYsSUFBSSxZQUFZLEdBQUc7SUFDakIsVUFBVSxFQUFFLGFBQWE7Q0FDMUIsQ0FBQztBQUVGLFNBQVMsV0FBVyxDQUFDLElBQVM7SUFDNUIsSUFBSSxFQUFFLEdBQUcsSUFBSSxDQUFDLEVBQUUsQ0FBQyxHQUFHLENBQUM7SUFDckIsSUFBSSxPQUFPLEdBQUcsWUFBWSxDQUFDLEVBQUUsQ0FBQyxDQUFDO0lBQy9CLE9BQU8sT0FBTyxJQUFJLEVBQUUsQ0FBQztBQUN2QixDQUFDO0FBRUQsTUFBTSxDQUFDLE1BQU0sQ0FBQyxlQUFlLENBQUMsWUFBWSxFQUFFLHNCQUFzQixDQUFDLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgKiBhcyBicmVlemUgZnJvbSAnYnJlZXplLWNsaWVudCc7XHJcblxyXG5leHBvcnQgY2xhc3MgVXJpQnVpbGRlck9EYXRhQWRhcHRlciBpbXBsZW1lbnRzIGJyZWV6ZS5VcmlCdWlsZGVyQWRhcHRlciB7XHJcblxyXG4gIG5hbWU6IHN0cmluZztcclxuXHJcbiAgY29uc3RydWN0b3IoKSB7XHJcbiAgICB0aGlzLm5hbWUgPSBcIm9kYXRhXCI7XHJcbiAgfVxyXG5cclxuICBzdGF0aWMgcmVnaXN0ZXIoY29uZmlnPzogYnJlZXplLkJyZWV6ZUNvbmZpZykge1xyXG4gICAgY29uZmlnID0gY29uZmlnIHx8IGJyZWV6ZS5jb25maWc7XHJcbiAgICBjb25maWcucmVnaXN0ZXJBZGFwdGVyKFwidXJpQnVpbGRlclwiLCBVcmlCdWlsZGVyT0RhdGFBZGFwdGVyKTtcclxuICAgIHJldHVybiBjb25maWcuaW5pdGlhbGl6ZUFkYXB0ZXJJbnN0YW5jZShcInVyaUJ1aWxkZXJcIiwgXCJvZGF0YVwiLCB0cnVlKSBhcyBVcmlCdWlsZGVyT0RhdGFBZGFwdGVyO1xyXG4gIH1cclxuXHJcbiAgaW5pdGlhbGl6ZSgpIHsgfVxyXG5cclxuICBidWlsZFVyaShlbnRpdHlRdWVyeTogYnJlZXplLkVudGl0eVF1ZXJ5LCBtZXRhZGF0YVN0b3JlOiBicmVlemUuTWV0YWRhdGFTdG9yZSkge1xyXG4gICAgLy8gZm9yY2UgZW50aXR5VHlwZSB2YWxpZGF0aW9uO1xyXG4gICAgbGV0IGVudGl0eVR5cGUgPSBlbnRpdHlRdWVyeS5fZ2V0RnJvbUVudGl0eVR5cGUobWV0YWRhdGFTdG9yZSwgZmFsc2UpO1xyXG4gICAgaWYgKCFlbnRpdHlUeXBlKSB7XHJcbiAgICAgIC8vIGFub255bW91cyB0eXBlIGJ1dCBzdGlsbCBoYXMgbmFtaW5nIGNvbnZlbnRpb24gaW5mbyBhdmFpbFxyXG4gICAgICBlbnRpdHlUeXBlID0gbmV3IGJyZWV6ZS5FbnRpdHlUeXBlKG1ldGFkYXRhU3RvcmUpO1xyXG4gICAgfVxyXG5cclxuICAgIGxldCBxdWVyeU9wdGlvbnMgPSB7fTtcclxuICAgIHF1ZXJ5T3B0aW9uc1tcIiRmaWx0ZXJcIl0gPSB0b1doZXJlT0RhdGFGcmFnbWVudChlbnRpdHlRdWVyeS53aGVyZVByZWRpY2F0ZSk7XHJcbiAgICBxdWVyeU9wdGlvbnNbXCIkb3JkZXJieVwiXSA9IHRvT3JkZXJCeU9EYXRhRnJhZ21lbnQoZW50aXR5UXVlcnkub3JkZXJCeUNsYXVzZSEpO1xyXG5cclxuICAgIGlmIChlbnRpdHlRdWVyeS5za2lwQ291bnQpIHtcclxuICAgICAgcXVlcnlPcHRpb25zW1wiJHNraXBcIl0gPSBlbnRpdHlRdWVyeS5za2lwQ291bnQ7XHJcbiAgICB9XHJcblxyXG4gICAgaWYgKGVudGl0eVF1ZXJ5LnRha2VDb3VudCAhPSBudWxsKSB7XHJcbiAgICAgIHF1ZXJ5T3B0aW9uc1tcIiR0b3BcIl0gPSBlbnRpdHlRdWVyeS50YWtlQ291bnQ7XHJcbiAgICB9XHJcblxyXG4gICAgcXVlcnlPcHRpb25zW1wiJGV4cGFuZFwiXSA9IHRvRXhwYW5kT0RhdGFGcmFnbWVudChlbnRpdHlRdWVyeS5leHBhbmRDbGF1c2UpO1xyXG4gICAgcXVlcnlPcHRpb25zW1wiJHNlbGVjdFwiXSA9IHRvU2VsZWN0T0RhdGFGcmFnbWVudChlbnRpdHlRdWVyeS5zZWxlY3RDbGF1c2UhKTtcclxuXHJcbiAgICBpZiAoZW50aXR5UXVlcnkuaW5saW5lQ291bnRFbmFibGVkKSB7XHJcbiAgICAgIHF1ZXJ5T3B0aW9uc1tcIiRpbmxpbmVjb3VudFwiXSA9IFwiYWxscGFnZXNcIjtcclxuICAgIH1cclxuXHJcbiAgICBsZXQgcW9UZXh0ID0gdG9RdWVyeU9wdGlvbnNTdHJpbmcocXVlcnlPcHRpb25zIGFzIGJyZWV6ZS5RdWVyeU9wdGlvbnMpO1xyXG4gICAgbGV0IHNlcCA9IGVudGl0eVF1ZXJ5LnJlc291cmNlTmFtZS5pbmNsdWRlcyhcIj9cIikgPyBcIiZcIiA6IFwiP1wiO1xyXG4gICAgcmV0dXJuIGVudGl0eVF1ZXJ5LnJlc291cmNlTmFtZSArIHNlcCArIHFvVGV4dDtcclxuXHJcbiAgICAvLyBwcml2YXRlIG1ldGhvZHMgdG8gdGhpcyBmdW5jLlxyXG5cclxuICAgIGZ1bmN0aW9uIHRvV2hlcmVPRGF0YUZyYWdtZW50KHdoZXJlUHJlZGljYXRlOiBicmVlemUuUHJlZGljYXRlKSB7XHJcbiAgICAgIGlmICghd2hlcmVQcmVkaWNhdGUpIHJldHVybiB1bmRlZmluZWQ7XHJcbiAgICAgIC8vIHZhbGlkYXRpb24gb2NjdXJzIGluc2lkZSBvZiB0aGUgdG9PRGF0YUZyYWdtZW50IGNhbGwgaGVyZS5cclxuICAgICAgbGV0IGZyYWcgPSB3aGVyZVByZWRpY2F0ZS52aXNpdCh7IGVudGl0eVR5cGU6IGVudGl0eVR5cGUgfSwgdG9PRGF0YUZyYWdtZW50VmlzaXRvcik7XHJcbiAgICAgIHJldHVybiAoZnJhZyAmJiBmcmFnLmxlbmd0aCA+IDApID8gZnJhZyA6IHVuZGVmaW5lZDtcclxuICAgIH1cclxuXHJcbiAgICBmdW5jdGlvbiB0b09yZGVyQnlPRGF0YUZyYWdtZW50KG9yZGVyQnlDbGF1c2U6IGJyZWV6ZS5PcmRlckJ5Q2xhdXNlKSB7XHJcbiAgICAgIGlmICghb3JkZXJCeUNsYXVzZSkgcmV0dXJuIHVuZGVmaW5lZDtcclxuICAgICAgb3JkZXJCeUNsYXVzZS52YWxpZGF0ZShlbnRpdHlUeXBlISk7XHJcbiAgICAgIGxldCBzdHJpbmdzID0gb3JkZXJCeUNsYXVzZS5pdGVtcy5tYXAoZnVuY3Rpb24gKGl0ZW0pIHtcclxuICAgICAgICByZXR1cm4gZW50aXR5VHlwZSEuY2xpZW50UHJvcGVydHlQYXRoVG9TZXJ2ZXIoaXRlbS5wcm9wZXJ0eVBhdGgsIFwiL1wiKSArIChpdGVtLmlzRGVzYyA/IFwiIGRlc2NcIiA6IFwiXCIpO1xyXG4gICAgICB9KTtcclxuICAgICAgLy8gc2hvdWxkIHJldHVybiBzb21ldGhpbmcgbGlrZSBDb21wYW55TmFtZSxBZGRyZXNzL0NpdHkgZGVzY1xyXG4gICAgICByZXR1cm4gc3RyaW5ncy5qb2luKCcsJyk7XHJcbiAgICB9XHJcblxyXG4gICAgZnVuY3Rpb24gdG9TZWxlY3RPRGF0YUZyYWdtZW50KHNlbGVjdENsYXVzZT86IGJyZWV6ZS5TZWxlY3RDbGF1c2UpIHtcclxuICAgICAgaWYgKCFzZWxlY3RDbGF1c2UpIHJldHVybiB1bmRlZmluZWQ7XHJcbiAgICAgIHNlbGVjdENsYXVzZS52YWxpZGF0ZShlbnRpdHlUeXBlISk7XHJcbiAgICAgIGxldCBmcmFnID0gc2VsZWN0Q2xhdXNlLnByb3BlcnR5UGF0aHMubWFwKGZ1bmN0aW9uIChwcCkge1xyXG4gICAgICAgIHJldHVybiBlbnRpdHlUeXBlIS5jbGllbnRQcm9wZXJ0eVBhdGhUb1NlcnZlcihwcCwgXCIvXCIpO1xyXG4gICAgICB9KS5qb2luKFwiLFwiKTtcclxuICAgICAgcmV0dXJuIGZyYWc7XHJcbiAgICB9XHJcblxyXG4gICAgZnVuY3Rpb24gdG9FeHBhbmRPRGF0YUZyYWdtZW50KGV4cGFuZENsYXVzZT86IGJyZWV6ZS5FeHBhbmRDbGF1c2UpIHtcclxuICAgICAgaWYgKCFleHBhbmRDbGF1c2UpIHJldHVybiB1bmRlZmluZWQ7XHJcbiAgICAgIC8vIG5vIHZhbGlkYXRlIG9uIGV4cGFuZCBjbGF1c2VzIGN1cnJlbnRseS5cclxuICAgICAgLy8gZXhwYW5kQ2xhdXNlLnZhbGlkYXRlKGVudGl0eVR5cGUpO1xyXG4gICAgICBsZXQgZnJhZyA9IGV4cGFuZENsYXVzZS5wcm9wZXJ0eVBhdGhzLm1hcChmdW5jdGlvbiAocHApIHtcclxuICAgICAgICByZXR1cm4gZW50aXR5VHlwZSEuY2xpZW50UHJvcGVydHlQYXRoVG9TZXJ2ZXIocHAsIFwiL1wiKTtcclxuICAgICAgfSkuam9pbihcIixcIik7XHJcbiAgICAgIHJldHVybiBmcmFnO1xyXG4gICAgfVxyXG5cclxuICAgIGZ1bmN0aW9uIHRvUXVlcnlPcHRpb25zU3RyaW5nKHF1ZXJ5T3B0aW9uczogYnJlZXplLlF1ZXJ5T3B0aW9ucykge1xyXG4gICAgICBsZXQgcW9TdHJpbmdzOiBzdHJpbmdbXSA9IFtdO1xyXG4gICAgICBmb3IgKGxldCBxb05hbWUgaW4gcXVlcnlPcHRpb25zKSB7XHJcbiAgICAgICAgbGV0IHFvVmFsdWUgPSBxdWVyeU9wdGlvbnNbcW9OYW1lXTtcclxuICAgICAgICBpZiAocW9WYWx1ZSAhPT0gdW5kZWZpbmVkKSB7XHJcbiAgICAgICAgICBpZiAocW9WYWx1ZSBpbnN0YW5jZW9mIEFycmF5KSB7XHJcbiAgICAgICAgICAgIHFvVmFsdWUuZm9yRWFjaChmdW5jdGlvbiAocW92KSB7XHJcbiAgICAgICAgICAgICAgcW9TdHJpbmdzLnB1c2gocW9OYW1lICsgXCI9XCIgKyBlbmNvZGVVUklDb21wb25lbnQocW92KSk7XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgcW9TdHJpbmdzLnB1c2gocW9OYW1lICsgXCI9XCIgKyBlbmNvZGVVUklDb21wb25lbnQocW9WYWx1ZSkpO1xyXG4gICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgICAgfVxyXG5cclxuICAgICAgaWYgKHFvU3RyaW5ncy5sZW5ndGggPiAwKSB7XHJcbiAgICAgICAgcmV0dXJuIHFvU3RyaW5ncy5qb2luKFwiJlwiKTtcclxuICAgICAgfSBlbHNlIHtcclxuICAgICAgICByZXR1cm4gXCJcIjtcclxuICAgICAgfVxyXG4gICAgfVxyXG4gIH1cclxuXHJcblxyXG59XHJcblxyXG4oYnJlZXplLlByZWRpY2F0ZS5wcm90b3R5cGUgYXMgYW55KS50b09EYXRhRnJhZ21lbnQgPSBmdW5jdGlvbiAoY29udGV4dDogYnJlZXplLlZpc2l0Q29udGV4dCkge1xyXG4gIHJldHVybiB0aGlzLnZpc2l0KGNvbnRleHQsIHRvT0RhdGFGcmFnbWVudFZpc2l0b3IpO1xyXG59O1xyXG5cclxubGV0IHRvT0RhdGFGcmFnbWVudFZpc2l0b3IgPSB7XHJcblxyXG4gIHBhc3N0aHJ1UHJlZGljYXRlOiBmdW5jdGlvbiAoKSB7XHJcbiAgICByZXR1cm4gdGhpcy52YWx1ZTtcclxuICB9LFxyXG5cclxuICB1bmFyeVByZWRpY2F0ZTogZnVuY3Rpb24gKHRoaXM6IGJyZWV6ZS5VbmFyeVByZWRpY2F0ZSwgY29udGV4dDogYnJlZXplLlZpc2l0Q29udGV4dCkge1xyXG4gICAgbGV0IHByZWRWYWwgPSB0aGlzLnByZWQudmlzaXQoY29udGV4dCk7XHJcbiAgICByZXR1cm4gb2RhdGFPcEZyb20odGhpcykgKyBcIiBcIiArIFwiKFwiICsgcHJlZFZhbCArIFwiKVwiO1xyXG4gIH0sXHJcblxyXG4gIGJpbmFyeVByZWRpY2F0ZTogZnVuY3Rpb24gKHRoaXM6IGJyZWV6ZS5CaW5hcnlQcmVkaWNhdGUsIGNvbnRleHQ6IGJyZWV6ZS5WaXNpdENvbnRleHQpIHtcclxuICAgIGxldCBleHByMVZhbCA9IHRoaXMuZXhwcjEhLnZpc2l0KGNvbnRleHQpO1xyXG4gICAgbGV0IGV4cHIyVmFsID0gdGhpcy5leHByMiEudmlzaXQoY29udGV4dCk7XHJcbiAgICBsZXQgcHJlZml4ID0gKGNvbnRleHQgYXMgYW55KS5wcmVmaXg7XHJcbiAgICBpZiAocHJlZml4KSB7XHJcbiAgICAgIGV4cHIxVmFsID0gcHJlZml4ICsgXCIvXCIgKyBleHByMVZhbDtcclxuICAgIH1cclxuXHJcbiAgICBsZXQgb2RhdGFPcCA9IG9kYXRhT3BGcm9tKHRoaXMpO1xyXG5cclxuICAgIGlmICh0aGlzLm9wLmtleSA9PT0gJ2luJykge1xyXG4gICAgICBsZXQgcmVzdWx0ID0gZXhwcjJWYWwubWFwKGZ1bmN0aW9uICh2OiBhbnkpIHtcclxuICAgICAgICByZXR1cm4gXCIoXCIgKyBleHByMVZhbCArIFwiIGVxIFwiICsgdiArIFwiKVwiO1xyXG4gICAgICB9KS5qb2luKFwiIG9yIFwiKTtcclxuICAgICAgcmV0dXJuIHJlc3VsdDtcclxuICAgIH0gZWxzZSBpZiAodGhpcy5vcC5pc0Z1bmN0aW9uKSB7XHJcbiAgICAgIGlmIChvZGF0YU9wID09PSBcInN1YnN0cmluZ29mXCIpIHtcclxuICAgICAgICByZXR1cm4gb2RhdGFPcCArIFwiKFwiICsgZXhwcjJWYWwgKyBcIixcIiArIGV4cHIxVmFsICsgXCIpIGVxIHRydWVcIjtcclxuICAgICAgfSBlbHNlIHtcclxuICAgICAgICByZXR1cm4gb2RhdGFPcCArIFwiKFwiICsgZXhwcjFWYWwgKyBcIixcIiArIGV4cHIyVmFsICsgXCIpIGVxIHRydWVcIjtcclxuICAgICAgfVxyXG4gICAgfSBlbHNlIHtcclxuICAgICAgcmV0dXJuIGV4cHIxVmFsICsgXCIgXCIgKyBvZGF0YU9wICsgXCIgXCIgKyBleHByMlZhbDtcclxuICAgIH1cclxuICB9LFxyXG5cclxuICBhbmRPclByZWRpY2F0ZTogZnVuY3Rpb24gKHRoaXM6IGJyZWV6ZS5BbmRPclByZWRpY2F0ZSwgY29udGV4dDogYnJlZXplLlZpc2l0Q29udGV4dCkge1xyXG4gICAgbGV0IHJlc3VsdCA9IHRoaXMucHJlZHMubWFwKGZ1bmN0aW9uIChwcmVkKSB7XHJcbiAgICAgIGxldCBwcmVkVmFsID0gcHJlZC52aXNpdChjb250ZXh0KTtcclxuICAgICAgcmV0dXJuIFwiKFwiICsgcHJlZFZhbCArIFwiKVwiO1xyXG4gICAgfSkuam9pbihcIiBcIiArIG9kYXRhT3BGcm9tKHRoaXMpICsgXCIgXCIpO1xyXG4gICAgcmV0dXJuIHJlc3VsdDtcclxuICB9LFxyXG5cclxuICBhbnlBbGxQcmVkaWNhdGU6IGZ1bmN0aW9uICh0aGlzOiBicmVlemUuQW55QWxsUHJlZGljYXRlLCBjb250ZXh0OiBicmVlemUuVmlzaXRDb250ZXh0KSB7XHJcbiAgICBsZXQgZXhwclZhbCA9IHRoaXMuZXhwci52aXNpdChjb250ZXh0KTtcclxuICAgIGlmICghdGhpcy5wcmVkLm9wKSB7IC8vIGFkZGVkIDIxLU9jdC0yMDE2IHRvIGZpeCBicmVlemUuanMgaXNzdWUgIzE3MlxyXG4gICAgICByZXR1cm4gZXhwclZhbCArIFwiL1wiICsgb2RhdGFPcEZyb20odGhpcykgKyBcIigpXCI7XHJcbiAgICB9XHJcbiAgICBsZXQgcHJlZml4ID0gKGNvbnRleHQgYXMgYW55KS5wcmVmaXg7XHJcbiAgICBpZiAocHJlZml4KSB7XHJcbiAgICAgIGV4cHJWYWwgPSBwcmVmaXggKyBcIi9cIiArIGV4cHJWYWw7XHJcbiAgICAgIHByZWZpeCA9IFwieFwiICsgKHBhcnNlSW50KHByZWZpeC5zdWJzdHJpbmcoMSkpICsgMSk7XHJcbiAgICB9IGVsc2Uge1xyXG4gICAgICBwcmVmaXggPSBcIngxXCI7XHJcbiAgICB9XHJcbiAgICAvLyBuZWVkIHRvIGNyZWF0ZSBhIG5ldyBjb250ZXh0IGJlY2F1c2Ugb2YgJ3ByZWZpeCdcclxuICAgIGxldCBuZXdDb250ZXh0ID0gYnJlZXplLmNvcmUuZXh0ZW5kKHt9LCBjb250ZXh0KSBhcyBhbnk7XHJcbiAgICBuZXdDb250ZXh0LmVudGl0eVR5cGUgPSB0aGlzLmV4cHIuZGF0YVR5cGU7XHJcbiAgICBuZXdDb250ZXh0LnByZWZpeCA9IHByZWZpeDtcclxuICAgIGxldCBuZXdQcmVkVmFsID0gdGhpcy5wcmVkLnZpc2l0KG5ld0NvbnRleHQpO1xyXG4gICAgcmV0dXJuIGV4cHJWYWwgKyBcIi9cIiArIG9kYXRhT3BGcm9tKHRoaXMpICsgXCIoXCIgKyBwcmVmaXggKyBcIjogXCIgKyBuZXdQcmVkVmFsICsgXCIpXCI7XHJcbiAgfSxcclxuXHJcbiAgbGl0RXhwcjogZnVuY3Rpb24gKCkge1xyXG4gICAgaWYgKEFycmF5LmlzQXJyYXkodGhpcy52YWx1ZSkpIHtcclxuICAgICAgcmV0dXJuIHRoaXMudmFsdWUubWFwKGZ1bmN0aW9uICh2OiBhbnkpIHsgcmV0dXJuIHRoaXMuZGF0YVR5cGUuZm10T0RhdGEodik7IH0sIHRoaXMpO1xyXG4gICAgfSBlbHNlIHtcclxuICAgICAgcmV0dXJuIHRoaXMuZGF0YVR5cGUuZm10T0RhdGEodGhpcy52YWx1ZSk7XHJcbiAgICB9XHJcbiAgfSxcclxuXHJcbiAgcHJvcEV4cHI6IGZ1bmN0aW9uICh0aGlzOiBicmVlemUuUHJvcEV4cHIsIGNvbnRleHQ6IGJyZWV6ZS5FeHByZXNzaW9uQ29udGV4dCkge1xyXG4gICAgbGV0IGVudGl0eVR5cGUgPSBjb250ZXh0LmVudGl0eVR5cGU7XHJcbiAgICAvLyAnLycgaXMgdGhlIE9EYXRhIHBhdGggZGVsaW1pdGVyXHJcbiAgICByZXR1cm4gZW50aXR5VHlwZSA/IGVudGl0eVR5cGUuY2xpZW50UHJvcGVydHlQYXRoVG9TZXJ2ZXIodGhpcy5wcm9wZXJ0eVBhdGgsIFwiL1wiKSA6IHRoaXMucHJvcGVydHlQYXRoO1xyXG4gIH0sXHJcblxyXG4gIGZuRXhwcjogZnVuY3Rpb24gKHRoaXM6IGJyZWV6ZS5GbkV4cHIsIGNvbnRleHQ6IGJyZWV6ZS5FeHByZXNzaW9uQ29udGV4dCkge1xyXG4gICAgbGV0IGV4cHJWYWxzID0gdGhpcy5leHBycy5tYXAoZnVuY3Rpb24gKGV4cHIpIHtcclxuICAgICAgcmV0dXJuIGV4cHIudmlzaXQoY29udGV4dCk7XHJcbiAgICB9KTtcclxuICAgIHJldHVybiB0aGlzLmZuTmFtZSArIFwiKFwiICsgZXhwclZhbHMuam9pbihcIixcIikgKyBcIilcIjtcclxuICB9XHJcbn07XHJcblxyXG5sZXQgX29wZXJhdG9yTWFwID0ge1xyXG4gICdjb250YWlucyc6ICdzdWJzdHJpbmdvZidcclxufTtcclxuXHJcbmZ1bmN0aW9uIG9kYXRhT3BGcm9tKG5vZGU6IGFueSkge1xyXG4gIGxldCBvcCA9IG5vZGUub3Aua2V5O1xyXG4gIGxldCBvZGF0YU9wID0gX29wZXJhdG9yTWFwW29wXTtcclxuICByZXR1cm4gb2RhdGFPcCB8fCBvcDtcclxufVxyXG5cclxuYnJlZXplLmNvbmZpZy5yZWdpc3RlckFkYXB0ZXIoXCJ1cmlCdWlsZGVyXCIsIFVyaUJ1aWxkZXJPRGF0YUFkYXB0ZXIpO1xyXG5cclxuXHJcblxyXG4iXX0=