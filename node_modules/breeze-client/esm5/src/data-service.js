import { assertConfig } from './assert-param';
import { config } from './config';
import { core } from './core';
/**
A DataService instance is used to encapsulate the details of a single 'service'; this includes a serviceName, a dataService adapterInstance,
and whether the service has server side metadata.

You can construct an EntityManager with either a serviceName or a DataService instance, if you use a serviceName then a DataService
is constructed for you.  (It can also be set via the EntityManager.setProperties method).

The same applies to the MetadataStore.fetchMetadata method, i.e. it takes either a serviceName or a DataService instance.

Each metadataStore contains a list of DataServices, each accessible via its ‘serviceName’.
( see MetadataStore.getDataService and MetadataStore.addDataService).  The ‘addDataService’ method is called internally
anytime a MetadataStore.fetchMetadata call occurs with a new dataService ( or service name).

**/
var DataService = /** @class */ (function () {
    /**   DataService constructor
    >     var dataService = new DataService({
    >         serviceName: altServiceName,
    >         hasServerMetadata: false
    >     });
  
    >     var metadataStore = new MetadataStore({
    >         namingConvention: NamingConvention.camelCase
    >     });
  
    >     return new EntityManager({
    >         dataService: dataService,
    >         metadataStore: metadataStore
    >     });
    @param config - A configuration object.
    **/
    function DataService(config) {
        updateWithConfig(this, config);
    }
    /**
    Returns a copy of this DataService with the specified properties applied.
    @param config - The configuration object to apply to create a new DataService.
    **/
    DataService.prototype.using = function (config) {
        if (!config)
            return this;
        var result = new DataService(this);
        return updateWithConfig(result, config);
    };
    DataService.resolve = function (dataServices) {
        // final defaults
        // Deliberate use of 'as any' below.
        dataServices.push({
            hasServerMetadata: true,
            useJsonp: false
        });
        var ds = new DataService(core.resolveProperties(dataServices, ["serviceName", "adapterName", "uriBuilderName", "hasServerMetadata", "jsonResultsAdapter", "useJsonp"]));
        if (!ds.serviceName) {
            throw new Error("Unable to resolve a 'serviceName' for this dataService");
        }
        ds.adapterInstance = ds.adapterInstance || config.getAdapterInstance("dataService", ds.adapterName);
        ds.jsonResultsAdapter = ds.jsonResultsAdapter || ds.adapterInstance.jsonResultsAdapter;
        ds.uriBuilder = ds.uriBuilder || config.getAdapterInstance("uriBuilder", ds.uriBuilderName);
        return ds;
    };
    /** @hidden @internal */
    DataService._normalizeServiceName = function (serviceName) {
        serviceName = serviceName.trim();
        if (serviceName.substr(-1) !== "/") {
            return serviceName + '/';
        }
        else {
            return serviceName;
        }
    };
    /**  */
    DataService.prototype.toJSON = function () {
        // don't use default value here - because we want to be able to distinguish undefined props for inheritence purposes.
        return core.toJson(this, {
            serviceName: null,
            adapterName: null,
            uriBuilderName: null,
            hasServerMetadata: null,
            jsonResultsAdapter: function (v) {
                return v && v.name;
            },
            useJsonp: null
        });
    };
    DataService.fromJSON = function (json) {
        json.jsonResultsAdapter = config._fetchObject(JsonResultsAdapter, json.jsonResultsAdapter);
        return new DataService(json);
    };
    /**
     Returns a url for this dataService with the specified suffix. This method handles dataService names either
     with or without trailing '/'s.  If the suffix starts with "http" then it will be returned as-is.
     @method qualifyUrl
     @param suffix {String} The resulting url.
     @return {a Url string}
     **/
    DataService.prototype.qualifyUrl = function (suffix) {
        if (suffix && suffix.startsWith("http")) {
            return suffix;
        }
        var url = this.serviceName;
        // remove any trailing "/"
        if (core.stringEndsWith(url, "/")) {
            url = url.substr(0, url.length - 1);
        }
        // ensure that it ends with "/" + suffix
        suffix = "/" + suffix;
        if (!core.stringEndsWith(url, suffix)) {
            url = url + suffix;
        }
        return url;
    };
    return DataService;
}());
export { DataService };
DataService.prototype._$typeName = "DataService";
function updateWithConfig(obj, dsConfig) {
    if (dsConfig) {
        assertConfig(dsConfig)
            .whereParam("serviceName").isOptional()
            .whereParam("adapterName").isString().isOptional()
            .whereParam("uriBuilderName").isString().isOptional()
            .whereParam("hasServerMetadata").isBoolean().isOptional()
            .whereParam("jsonResultsAdapter").isInstanceOf(JsonResultsAdapter).isOptional()
            .whereParam("useJsonp").isBoolean().isOptional()
            .applyAll(obj);
        obj.serviceName = obj.serviceName && DataService._normalizeServiceName(obj.serviceName);
        obj.adapterInstance = obj.adapterName ? config.getAdapterInstance("dataService", obj.adapterName) : undefined;
        obj.uriBuilder = obj.uriBuilderName ? config.getAdapterInstance("uriBuilder", obj.uriBuilderName) : undefined;
    }
    return obj;
}
/**
A JsonResultsAdapter instance is used to provide custom extraction and parsing logic on the json results returned by any web service.
This facility makes it possible for breeze to talk to virtually any web service and return objects that will be first class 'breeze' citizens.
**/
var JsonResultsAdapter = /** @class */ (function () {
    /**
    JsonResultsAdapter constructor
  
    @example
        //
        var jsonResultsAdapter = new JsonResultsAdapter({
            name: "test1e",
            extractResults: function(json) {
                return json.results;
            },
            visitNode: function(node, mappingContext, nodeContext) {
                var entityType = normalizeTypeName(node.$type);
                var propertyName = nodeContext.propertyName;
                var ignore = propertyName && propertyName.substr(0, 1) === "$";
  
                return {
                    entityType: entityType,
                    nodeId: node.$id,
                    nodeRefId: node.$ref,
                    ignore: ignore,
                    passThru: false // default
                };
            }
        });
  
        var dataService = new DataService( {
                serviceName: "breeze/foo",
                jsonResultsAdapter: jsonResultsAdapter
        });
  
        var entityManager = new EntityManager( {
            dataService: dataService
        });
  
    @param config - A configuration object.
  
    **/
    function JsonResultsAdapter(jsConfig) {
        if (arguments.length !== 1) {
            throw new Error("The JsonResultsAdapter ctor should be called with a single argument that is a configuration object.");
        }
        assertConfig(jsConfig)
            .whereParam("name").isNonEmptyString()
            .whereParam("extractResults").isFunction().isOptional().withDefault(extractResultsDefault)
            .whereParam("extractSaveResults").isFunction().isOptional().withDefault(extractSaveResultsDefault)
            .whereParam("extractKeyMappings").isFunction().isOptional().withDefault(extractKeyMappingsDefault)
            .whereParam("extractDeletedKeys").isFunction().isOptional().withDefault(extractDeletedKeysDefault)
            .whereParam("visitNode").isFunction()
            .applyAll(this);
        config._storeObject(this, "JsonResultsAdapter", this.name);
    }
    return JsonResultsAdapter;
}());
export { JsonResultsAdapter };
JsonResultsAdapter.prototype._$typeName = "JsonResultsAdapter";
function extractResultsDefault(data) {
    return data.results;
}
function extractSaveResultsDefault(data) {
    return data.entities || data.Entities || [];
}
function extractKeyMappingsDefault(data) {
    return data.keyMappings || data.KeyMappings || [];
}
function extractDeletedKeysDefault(data) {
    return data.deletedKeys || data.DeletedKeys || [];
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZGF0YS1zZXJ2aWNlLmpzIiwic291cmNlUm9vdCI6Im5nOi8vYnJlZXplLWNsaWVudC8iLCJzb3VyY2VzIjpbInNyYy9kYXRhLXNlcnZpY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBSUEsT0FBTyxFQUFFLFlBQVksRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBQzlDLE9BQU8sRUFBRSxNQUFNLEVBQUUsTUFBTSxVQUFVLENBQUM7QUFDbEMsT0FBTyxFQUFFLElBQUksRUFBRSxNQUFNLFFBQVEsQ0FBQztBQWlCOUI7Ozs7Ozs7Ozs7Ozs7R0FhRztBQUNIO0lBb0JFOzs7Ozs7Ozs7Ozs7Ozs7T0FlRztJQUNILHFCQUFZLE1BQTBCO1FBQ3BDLGdCQUFnQixDQUFDLElBQUksRUFBRSxNQUFNLENBQUMsQ0FBQztJQUNqQyxDQUFDO0lBR0Q7OztPQUdHO0lBQ0gsMkJBQUssR0FBTCxVQUFNLE1BQXlCO1FBQzdCLElBQUksQ0FBQyxNQUFNO1lBQUUsT0FBTyxJQUFJLENBQUM7UUFDekIsSUFBSSxNQUFNLEdBQUcsSUFBSSxXQUFXLENBQUMsSUFBSSxDQUFDLENBQUM7UUFDbkMsT0FBTyxnQkFBZ0IsQ0FBQyxNQUFNLEVBQUUsTUFBTSxDQUFDLENBQUM7SUFDMUMsQ0FBQztJQUVNLG1CQUFPLEdBQWQsVUFBZSxZQUEyQjtRQUN4QyxpQkFBaUI7UUFDakIsb0NBQW9DO1FBQ25DLFlBQW9CLENBQUMsSUFBSSxDQUFDO1lBQ3pCLGlCQUFpQixFQUFFLElBQUk7WUFDdkIsUUFBUSxFQUFFLEtBQUs7U0FDaEIsQ0FBQyxDQUFDO1FBQ0gsSUFBSSxFQUFFLEdBQUcsSUFBSSxXQUFXLENBQUMsSUFBSSxDQUFDLGlCQUFpQixDQUFDLFlBQVksRUFDeEQsQ0FBQyxhQUFhLEVBQUUsYUFBYSxFQUFFLGdCQUFnQixFQUFFLG1CQUFtQixFQUFFLG9CQUFvQixFQUFFLFVBQVUsQ0FBQyxDQUFDLENBQUMsQ0FBQztRQUU5RyxJQUFJLENBQUMsRUFBRSxDQUFDLFdBQVcsRUFBRTtZ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LE9BQU8sSUFBSSxDQUFDLFdBQVcsSUFBSSxJQUFJLENBQUMsV0FBVyxJQUFJLEVBQUUsQ0FBQztBQUNwRCxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgRW50aXR5VHlwZSwgTmF2aWdhdGlvblByb3BlcnR5IH0gZnJvbSAnLi9lbnRpdHktbWV0YWRhdGEnO1xyXG5pbXBvcnQgeyBEYXRhU2VydmljZUFkYXB0ZXIsIFVyaUJ1aWxkZXJBZGFwdGVyIH0gZnJvbSAnLi9pbnRlcmZhY2UtcmVnaXN0cnknO1xyXG5pbXBvcnQgeyBLZXlNYXBwaW5nIH0gZnJvbSAnLi9lbnRpdHktbWFuYWdlcic7XHJcbmltcG9ydCB7IE1hcHBpbmdDb250ZXh0IH0gZnJvbSAnLi9tYXBwaW5nLWNvbnRleHQnO1xyXG5pbXBvcnQgeyBhc3NlcnRDb25maWcgfSBmcm9tICcuL2Fzc2VydC1wYXJhbSc7XHJcbmltcG9ydCB7IGNvbmZpZyB9IGZyb20gJy4vY29uZmlnJztcclxuaW1wb3J0IHsgY29yZSB9IGZyb20gJy4vY29yZSc7XHJcblxyXG4vKiogQ29uZmlndXJhdGlvbiBpbmZvIHRvIGJlIHBhc3NlZCB0byB0aGUgW1tEYXRhU2VydmljZV1dIGNvbnN0cnVjdG9yICovXHJcbmV4cG9ydCBpbnRlcmZhY2UgRGF0YVNlcnZpY2VDb25maWcge1xyXG4gIC8qKiBUaGUgc2VydmljZU5hbWUgZm9yIHRoaXMgRGF0YVNlcnZpY2UuICAqKi9cclxuICBzZXJ2aWNlTmFtZT86IHN0cmluZztcclxuICAvKiogVGhlIGFkYXB0ZXIgbmFtZSBmb3IgdGhlIFtbSURhdGFTZXJ2aWNlQWRhcHRlcl1dIHRvIGJlIHVzZWQgd2l0aCB0aGlzIHNlcnZpY2UuICAqKi9cclxuICBhZGFwdGVyTmFtZT86IHN0cmluZztcclxuICAvKiogVGhlIGFkYXB0ZXIgbmFtZSBmb3IgdGhlIFtbSVVyaUJ1aWxkZXJBZGFwdGVyXV0gdG8gYmUgdXNlZCB3aXRoIHRoaXMgc2VydmljZS4gICoqL1xyXG4gIHVyaUJ1aWxkZXJOYW1lPzogc3RyaW5nO1xyXG4gIC8qKiBXaGV0aGVyIHRoZSBzZXJ2ZXIgY2FuIHByb3ZpZGUgbWV0YWRhdGEgZm9yIHRoaXMgc2VydmljZS4gICoqL1xyXG4gIGhhc1NlcnZlck1ldGFkYXRhPzogYm9vbGVhbjtcclxuICAvKiogVGhlIFtbSnNvblJlc3VsdHNBZGFwdGVyXV0gdXNlZCB0byBwcm9jZXNzIHRoZSByZXN1bHRzIG9mIGFueSBxdWVyeSBhZ2FpbnN0IHRoaXMgRGF0YVNlcnZpY2UuICAqKi9cclxuICBqc29uUmVzdWx0c0FkYXB0ZXI/OiBKc29uUmVzdWx0c0FkYXB0ZXI7XHJcbiAgLyoqIFdoZXRoZXIgdG8gdXNlIEpTT05QIHdoZW4gcGVyZm9ybWluZyBhICdHRVQnIHJlcXVlc3QgYWdhaW5zdCB0aGlzIHNlcnZpY2UuICAqKi9cclxuICB1c2VKc29ucD86IGJvb2xlYW47XHJcbn1cclxuLyoqXHJcbkEgRGF0YVNlcnZpY2UgaW5zdGFuY2UgaXMgdXNlZCB0byBlbmNhcHN1bGF0ZSB0aGUgZGV0YWlscyBvZiBhIHNpbmdsZSAnc2VydmljZSc7IHRoaXMgaW5jbHVkZXMgYSBzZXJ2aWNlTmFtZSwgYSBkYXRhU2VydmljZSBhZGFwdGVySW5zdGFuY2UsXHJcbmFuZCB3aGV0aGVyIHRoZSBzZXJ2aWNlIGhhcyBzZXJ2ZXIgc2lkZSBtZXRhZGF0YS5cclxuXHJcbllvdSBjYW4gY29uc3RydWN0IGFuIEVudGl0eU1hbmFnZXIgd2l0aCBlaXRoZXIgYSBzZXJ2aWNlTmFtZSBvciBhIERhdGFTZXJ2aWNlIGluc3RhbmNlLCBpZiB5b3UgdXNlIGEgc2VydmljZU5hbWUgdGhlbiBhIERhdGFTZXJ2aWNlXHJcbmlzIGNvbnN0cnVjdGVkIGZvciB5b3UuICAoSXQgY2FuIGFsc28gYmUgc2V0IHZpYSB0aGUgRW50aXR5TWFuYWdlci5zZXRQcm9wZXJ0aWVzIG1ldGhvZCkuXHJcblxyXG5UaGUgc2FtZSBhcHBsaWVzIHRvIHRoZSBNZXRhZGF0YVN0b3JlLmZldGNoTWV0YWRhdGEgbWV0aG9kLCBpLmUuIGl0IHRha2VzIGVpdGhlciBhIHNlcnZpY2VOYW1lIG9yIGEgRGF0YVNlcnZpY2UgaW5zdGFuY2UuXHJcblxyXG5FYWNoIG1ldGFkYXRhU3RvcmUgY29udGFpbnMgYSBsaXN0IG9mIERhdGFTZXJ2aWNlcywgZWFjaCBhY2Nlc3NpYmxlIHZpYSBpdHMg4oCYc2VydmljZU5hbWXigJkuXHJcbiggc2VlIE1ldGFkYXRhU3RvcmUuZ2V0RGF0YVNlcnZpY2UgYW5kIE1ldGFkYXRhU3RvcmUuYWRkRGF0YVNlcnZpY2UpLiAgVGhlIOKAmGFkZERhdGFTZXJ2aWNl4oCZIG1ldGhvZCBpcyBjYWxsZWQgaW50ZXJuYWxseVxyXG5hbnl0aW1lIGEgTWV0YWRhdGFTdG9yZS5mZXRjaE1ldGFkYXRhIGNhbGwgb2NjdXJzIHdpdGggYSBuZXcgZGF0YVNlcnZpY2UgKCBvciBzZXJ2aWNlIG5hbWUpLlxyXG5cclxuKiovXHJcbmV4cG9ydCBjbGFzcyBEYXRhU2VydmljZSB7XHJcbiAgLyoqIEBoaWRkZW4gQGludGVybmFsICovXHJcbiAgXyR0eXBlTmFtZTogc3RyaW5nOyAvLyBhY3R1YWxseSBwdXQgb24gcHJvdG90eXBlLlxyXG4gIC8qKiBUaGUgc2VydmljZU5hbWUgZm9yIHRoaXMgRGF0YVNlcnZpY2UuIF9fUmVhZCBPbmx5X18gKiovXHJcbiAgc2VydmljZU5hbWU6IHN0cmluZztcclxuICAvKiogVGhlIGFkYXB0ZXIgbmFtZSBmb3IgdGhlIFtbSURhdGFTZXJ2aWNlQWRhcHRlcl1dIHRvIGJlIHVzZWQgd2l0aCB0aGlzIHNlcnZpY2UuIF9fUmVhZCBPbmx5X18gICoqL1xyXG4gIGFkYXB0ZXJOYW1lOiBzdHJpbmc7XHJcbiAgLyoqICBUaGUgW1tJRGF0YVNlcnZpY2VBZGFwdGVyXV0gaW1wbGVtZW50YXRpb24gaW5zdGFuY2UgYXNzb2NpYXRlZCB3aXRoIHRoaXMgRW50aXR5TWFuYWdlci4gX19SZWFkIE9ubHlfXyAgKiovXHJcbiAgYWRhcHRlckluc3RhbmNlPzogRGF0YVNlcnZpY2VBZGFwdGVyO1xyXG4gIC8qKiBUaGUgYWRhcHRlciBuYW1lIGZvciB0aGUgW1tJVXJpQnVpbGRlckFkYXB0ZXJdXSB0byBiZSB1c2VkIHdpdGggdGhpcyBzZXJ2aWNlLiBfX1JlYWQgT25seV9fICAqKi9cclxuICB1cmlCdWlsZGVyTmFtZTogc3RyaW5nO1xyXG4gIC8qKiAgVGhlIFtbSVVyaUJ1aWxkZXJBZGFwdGVyXV0gaW1wbGVtZW50YXRpb24gaW5zdGFuY2UgYXNzb2NpYXRlZCB3aXRoIHRoaXMgRW50aXR5TWFuYWdlci4gX19SZWFkIE9ubHlfXyAgKiovXHJcbiAgdXJpQnVpbGRlcj86IFVyaUJ1aWxkZXJBZGFwdGVyO1xyXG4gIC8qKiBXaGV0aGVyIHRoZSBzZXJ2ZXIgY2FuIHByb3ZpZGUgbWV0YWRhdGEgZm9yIHRoaXMgc2VydmljZS4gX19SZWFkIE9ubHlfXyAgICoqL1xyXG4gIGhhc1NlcnZlck1ldGFkYXRhOiBib29sZWFuO1xyXG4gIC8qKiBUaGUgW1tKc29uUmVzdWx0c0FkYXB0ZXJdXSB1c2VkIHRvIHByb2Nlc3MgdGhlIHJlc3VsdHMgb2YgYW55IHF1ZXJ5IGFnYWluc3QgdGhpcyBEYXRhU2VydmljZS4gX19SZWFkIE9ubHlfXyAqKi9cclxuICBqc29uUmVzdWx0c0FkYXB0ZXI6IEpzb25SZXN1bHRzQWRhcHRlcjtcclxuICAvKiogV2hldGhlciB0byB1c2UgSlNPTlAgd2hlbiBwZXJmb3JtaW5nIGEgJ0dFVCcgcmVxdWVzdCBhZ2FpbnN0IHRoaXMgc2VydmljZS4gX19SZWFkIE9ubHlfXyAgKiovXHJcbiAgdXNlSnNvbnA6IGJvb2xlYW47XHJcblxyXG4gIC8qKiAgIERhdGFTZXJ2aWNlIGNvbnN0cnVjdG9yXHJcbiAgPiAgICAgdmFyIGRhdGFTZXJ2aWNlID0gbmV3IERhdGFTZXJ2aWNlKHtcclxuICA+ICAgICAgICAgc2VydmljZU5hbWU6IGFsdFNlcnZpY2VOYW1lLFxyXG4gID4gICAgICAgICBoYXNTZXJ2ZXJNZXRhZGF0YTogZmFsc2VcclxuICA+ICAgICB9KTtcclxuXHJcbiAgPiAgICAgdmFyIG1ldGFkYXRhU3RvcmUgPSBuZXcgTWV0YWRhdGFTdG9yZSh7XHJcbiAgPiAgICAgICAgIG5hbWluZ0NvbnZlbnRpb246IE5hbWluZ0NvbnZlbnRpb24uY2FtZWxDYXNlXHJcbiAgPiAgICAgfSk7XHJcblxyXG4gID4gICAgIHJldHVybiBuZXcgRW50aXR5TWFuYWdlcih7XHJcbiAgPiAgICAgICAgIGRhdGFTZXJ2aWNlOiBkYXRhU2VydmljZSxcclxuICA+ICAgICAgICAgbWV0YWRhdGFTdG9yZTogbWV0YWRhdGFTdG9yZVxyXG4gID4gICAgIH0pO1xyXG4gIEBwYXJhbSBjb25maWcgLSBBIGNvbmZpZ3VyYXRpb24gb2JqZWN0LlxyXG4gICoqL1xyXG4gIGNvbnN0cnVjdG9yKGNvbmZpZz86IERhdGFTZXJ2aWNlQ29uZmlnKSB7XHJcbiAgICB1cGRhdGVXaXRoQ29uZmlnKHRoaXMsIGNvbmZpZyk7XHJcbiAgfVxyXG5cclxuXHJcbiAgLyoqXHJcbiAgUmV0dXJucyBhIGNvcHkgb2YgdGhpcyBEYXRhU2VydmljZSB3aXRoIHRoZSBzcGVjaWZpZWQgcHJvcGVydGllcyBhcHBsaWVkLlxyXG4gIEBwYXJhbSBjb25maWcgLSBUaGUgY29uZmlndXJhdGlvbiBvYmplY3QgdG8gYXBwbHkgdG8gY3JlYXRlIGEgbmV3IERhdGFTZXJ2aWNlLlxyXG4gICoqL1xyXG4gIHVzaW5nKGNvbmZpZzogRGF0YVNlcnZpY2VDb25maWcpIHtcclxuICAgIGlmICghY29uZmlnKSByZXR1cm4gdGhpcztcclxuICAgIGxldCByZXN1bHQgPSBuZXcgRGF0YVNlcnZpY2UodGhpcyk7XHJcbiAgICByZXR1cm4gdXBkYXRlV2l0aENvbmZpZyhyZXN1bHQsIGNvbmZpZyk7XHJcbiAgfVxyXG5cclxuICBzdGF0aWMgcmVzb2x2ZShkYXRhU2VydmljZXM6IERhdGFTZXJ2aWNlW10pIHtcclxuICAgIC8vIGZpbmFsIGRlZmF1bHRzXHJcbiAgICAvLyBEZWxpYmVyYXRlIHVzZSBvZiAnYXMgYW55JyBiZWxvdy5cclxuICAgIChkYXRhU2VydmljZXMgYXMgYW55KS5wdXNoKHtcclxuICAgICAgaGFzU2VydmVyTWV0YWRhdGE6IHRydWUsXHJcbiAgICAgIHVzZUpzb25wOiBmYWxzZVxyXG4gICAgfSk7XHJcbiAgICBsZXQgZHMgPSBuZXcgRGF0YVNlcnZpY2UoY29yZS5yZXNvbHZlUHJvcGVydGllcyhkYXRhU2VydmljZXMsXHJcbiAgICAgICAgW1wic2VydmljZU5hbWVcIiwgXCJhZGFwdGVyTmFtZVwiLCBcInVyaUJ1aWxkZXJOYW1lXCIsIFwiaGFzU2VydmVyTWV0YWRhdGFcIiwgXCJqc29uUmVzdWx0c0FkYXB0ZXJcIiwgXCJ1c2VKc29ucFwiXSkpO1xyXG5cclxuICAgIGlmICghZHMuc2VydmljZU5hbWUpIHtcclxuICAgICAgdGhyb3cgbmV3IEVycm9yKFwiVW5hYmxlIHRvIHJlc29sdmUgYSAnc2VydmljZU5hbWUnIGZvciB0aGlzIGRhdGFTZXJ2aWNlXCIpO1xyXG4gICAgfVxyXG4gICAgZHMuYWRhcHRlckluc3RhbmNlID0gZHMuYWRhcHRlckluc3RhbmNlIHx8IGNvbmZpZy5nZXRBZGFwdGVySW5zdGFuY2U8RGF0YVNlcnZpY2VBZGFwdGVyPihcImRhdGFTZXJ2aWNlXCIsIGRzLmFkYXB0ZXJOYW1lKTtcclxuICAgIGRzLmpzb25SZXN1bHRzQWRhcHRlciA9IGRzLmpzb25SZXN1bHRzQWRhcHRlciB8fCBkcy5hZGFwdGVySW5zdGFuY2UhLmpzb25SZXN1bHRzQWRhcHRlcjtcclxuICAgIGRzLnVyaUJ1aWxkZXIgPSBkcy51cmlCdWlsZGVyIHx8IGNvbmZpZy5nZXRBZGFwdGVySW5zdGFuY2U8VXJpQnVpbGRlckFkYXB0ZXI+KFwidXJpQnVpbGRlclwiLCBkcy51cmlCdWlsZGVyTmFtZSk7XHJcbiAgICByZXR1cm4gZHM7XHJcbiAgfVxyXG5cclxuICAvKiogQGhpZGRlbiBAaW50ZXJuYWwgKi9cclxuICBzdGF0aWMgX25vcm1hbGl6ZVNlcnZpY2VOYW1lKHNlcnZpY2VOYW1lOiBzdHJpbmcpIHtcclxuICAgIHNlcnZpY2VOYW1lID0gc2VydmljZU5hbWUudHJpbSgpO1xyXG4gICAgaWYgKHNlcnZpY2VOYW1lLnN1YnN0cigtMSkgIT09IFwiL1wiKSB7XHJcbiAgICAgIHJldHVybiBzZXJ2aWNlTmFtZSArICcvJztcclxuICAgIH0gZWxzZSB7XHJcbiAgICAgIHJldHVybiBzZXJ2aWNlTmFtZTtcclxuICAgIH1cclxuICB9XHJcblxyXG4gIC8qKiAgKi9cclxuICB0b0pTT04oKSB7XHJcbiAgICAvLyBkb24ndCB1c2UgZGVmYXVsdCB2YWx1ZSBoZXJlIC0gYmVjYXVzZSB3ZSB3YW50IHRvIGJlIGFibGUgdG8gZGlzdGluZ3Vpc2ggdW5kZWZpbmVkIHByb3BzIGZvciBpbmhlcml0ZW5jZSBwdXJwb3Nlcy5cclxuICAgIHJldHVybiBjb3JlLnRvSnNvbih0aGlzLCB7XHJcbiAgICAgIHNlcnZpY2VOYW1lOiBudWxsLFxyXG4gICAgICBhZGFwdGVyTmFtZTogbnVsbCxcclxuICAgICAgdXJpQnVpbGRlck5hbWU6IG51bGwsXHJcbiAgICAgIGhhc1NlcnZlck1ldGFkYXRhOiBudWxsLFxyXG4gICAgICBqc29uUmVzdWx0c0FkYXB0ZXI6IGZ1bmN0aW9uICh2OiBhbnkpIHtcclxuICAgICAgICByZXR1cm4gdiAmJiB2Lm5hbWU7XHJcbiAgICAgIH0sXHJcbiAgICAgIHVzZUpzb25wOiBudWxsXHJcbiAgICB9KTtcclxuICB9XHJcblxyXG4gIHN0YXRpYyBmcm9tSlNPTihqc29uOiBhbnkpIHtcclxuICAgIGpzb24uanNvblJlc3VsdHNBZGFwdGVyID0gY29uZmlnLl9mZXRjaE9iamVjdChKc29uUmVzdWx0c0FkYXB0ZXIsIGpzb24uanNvblJlc3VsdHNBZGFwdGVyKTtcclxuICAgIHJldHVybiBuZXcgRGF0YVNlcnZpY2UoanNvbik7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgUmV0dXJucyBhIHVybCBmb3IgdGhpcyBkYXRhU2VydmljZSB3aXRoIHRoZSBzcGVjaWZpZWQgc3VmZml4LiBUaGlzIG1ldGhvZCBoYW5kbGVzIGRhdGFTZXJ2aWNlIG5hbWVzIGVpdGhlclxyXG4gICB3aXRoIG9yIHdpdGhvdXQgdHJhaWxpbmcgJy8ncy4gIElmIHRoZSBzdWZmaXggc3RhcnRzIHdpdGggXCJodHRwXCIgdGhlbiBpdCB3aWxsIGJlIHJldHVybmVkIGFzLWlzLlxyXG4gICBAbWV0aG9kIHF1YWxpZnlVcmxcclxuICAgQHBhcmFtIHN1ZmZpeCB7U3RyaW5nfSBUaGUgcmVzdWx0aW5nIHVybC5cclxuICAgQHJldHVybiB7YSBVcmwgc3RyaW5nfVxyXG4gICAqKi9cclxuICBxdWFsaWZ5VXJsKHN1ZmZpeDogc3RyaW5nKSB7XHJcbiAgICBpZiAoc3VmZml4ICYmIHN1ZmZpeC5zdGFydHNXaXRoKFwiaHR0cFwiKSkge1xyXG4gICAgICByZXR1cm4gc3VmZml4O1xyXG4gICAgfVxyXG4gICAgbGV0IHVybCA9IHRoaXMuc2VydmljZU5hbWU7XHJcbiAgICAvLyByZW1vdmUgYW55IHRyYWlsaW5nIFwiL1wiXHJcbiAgICBpZiAoY29yZS5zdHJpbmdFbmRzV2l0aCh1cmwsIFwiL1wiKSkge1xyXG4gICAgICB1cmwgPSB1cmwuc3Vic3RyKDAsIHVybC5sZW5ndGggLSAxKTtcclxuICAgIH1cclxuICAgIC8vIGVuc3VyZSB0aGF0IGl0IGVuZHMgd2l0aCBcIi9cIiArIHN1ZmZpeFxyXG4gICAgc3VmZml4ID0gXCIvXCIgKyBzdWZmaXg7XHJcbiAgICBpZiAoIWNvcmUuc3RyaW5nRW5kc1dpdGgodXJsLCBzdWZmaXgpKSB7XHJcbiAgICAgIHVybCA9IHVybCArIHN1ZmZpeDtcclxuICAgIH1cclxuICAgIHJldHVybiB1cmw7XHJcbiAgfVxyXG5cclxufVxyXG5EYXRhU2VydmljZS5wcm90b3R5cGUuXyR0eXBlTmFtZSA9IFwiRGF0YVNlcnZpY2VcIjtcclxuXHJcbmZ1bmN0aW9uIHVwZGF0ZVdpdGhDb25maWcob2JqOiBEYXRhU2VydmljZSwgZHNDb25maWc/OiBEYXRhU2VydmljZUNvbmZpZykge1xyXG4gIGlmIChkc0NvbmZpZykge1xyXG4gICAgYXNzZXJ0Q29uZmlnKGRzQ29uZmlnKVxyXG4gICAgICAgIC53aGVyZVBhcmFtKFwic2VydmljZU5hbWVcIikuaXNPcHRpb25hbCgpXHJcbiAgICAgICAgLndoZXJlUGFyYW0oXCJhZGFwdGVyTmFtZVwiKS5pc1N0cmluZygpLmlzT3B0aW9uYWwoKVxyXG4gICAgICAgIC53aGVyZVBhcmFtKFwidXJpQnVpbGRlck5hbWVcIikuaXNTdHJpbmcoKS5pc09wdGlvbmFsKClcclxuICAgICAgICAud2hlcmVQYXJhbShcImhhc1NlcnZlck1ldGFkYXRhXCIpLmlzQm9vbGVhbigpLmlzT3B0aW9uYWwoKVxyXG4gICAgICAgIC53aGVyZVBhcmFtKFwianNvblJlc3VsdHNBZGFwdGVyXCIpLmlzSW5zdGFuY2VPZihKc29uUmVzdWx0c0FkYXB0ZXIpLmlzT3B0aW9uYWwoKVxyXG4gICAgICAgIC53aGVyZVBhcmFtKFwidXNlSnNvbnBcIikuaXNCb29sZWFuKCkuaXNPcHRpb25hbCgpXHJcbiAgICAgICAgLmFwcGx5QWxsKG9iaik7XHJcbiAgICBvYmouc2VydmljZU5hbWUgPSBvYmouc2VydmljZU5hbWUgJiYgRGF0YVNlcnZpY2UuX25vcm1hbGl6ZVNlcnZpY2VOYW1lKG9iai5zZXJ2aWNlTmFtZSk7XHJcbiAgICBvYmouYWRhcHRlckluc3RhbmNlID0gb2JqLmFkYXB0ZXJOYW1lID8gIGNvbmZpZy5nZXRBZGFwdGVySW5zdGFuY2U8RGF0YVNlcnZpY2VBZGFwdGVyPihcImRhdGFTZXJ2aWNlXCIsIG9iai5hZGFwdGVyTmFtZSkgOiB1bmRlZmluZWQ7XHJcbiAgICBvYmoudXJpQnVpbGRlciA9IG9iai51cmlCdWlsZGVyTmFtZSA/IGNvbmZpZy5nZXRBZGFwdGVySW5zdGFuY2U8VXJpQnVpbGRlckFkYXB0ZXI+KFwidXJpQnVpbGRlclwiLCBvYmoudXJpQnVpbGRlck5hbWUpIDogdW5kZWZpbmVkO1xyXG4gIH1cclxuICByZXR1cm4gb2JqO1xyXG59XHJcblxyXG5leHBvcnQgaW50ZXJmYWNlIE5vZGVNZXRhIHtcclxuICBlbnRpdHlUeXBlPzogRW50aXR5VHlwZTtcclxuICBub2RlSWQ/OiBzdHJpbmc7XHJcbiAgbm9kZVJlZklkPzogc3RyaW5nO1xyXG4gIGlnbm9yZT86IGJvb2xlYW47XHJcbiAgcGFzc1RocnU/OiBib29sZWFuO1xyXG4gIGV4dHJhTWV0YWRhdGE/OiBhbnk7XHJcbn1cclxuXHJcbmV4cG9ydCBpbnRlcmZhY2UgTm9kZUNvbnRleHQge1xyXG4gIG5vZGVUeXBlOiBzdHJpbmc7XHJcbiAgcHJvcGVydHlOYW1lPzogc3RyaW5nO1xyXG4gIG5hdmlnYXRpb25Qcm9wZXJ0eT86IE5hdmlnYXRpb25Qcm9wZXJ0eTtcclxufVxyXG5cclxuLyoqIENvbmZpZ3VyYXRpb24gaW5mbyB0byBiZSBwYXNzZWQgdG8gdGhlIFtbSnNvblJlc3VsdHNBZGFwdGVyXV0gY29uc3RydWN0b3IgKi9cclxuZXhwb3J0IGludGVyZmFjZSBKc29uUmVzdWx0c0FkYXB0ZXJDb25maWcge1xyXG4gIC8qKiBUaGUgbmFtZSBvZiB0aGlzIGFkYXB0ZXIuICBUaGlzIG5hbWUgaXMgdXNlZCB0byB1bmlxdWVseSBpZGVudGlmeSBhbmQgbG9jYXRlIHRoaXMgaW5zdGFuY2Ugd2hlbiBhbiAnZXhwb3J0ZWQnIEpzb25SZXN1bHRzQWRhcHRlciBpcyBsYXRlciBpbXBvcnRlZC4gKi9cclxuICBuYW1lOiBzdHJpbmc7XHJcbiAgLyoqIEEgRnVuY3Rpb24gdGhhdCBpcyBjYWxsZWQgb25jZSBwZXIgcXVlcnkgb3BlcmF0aW9uIHRvIGV4dHJhY3QgdGhlICdwYXlsb2FkJyBmcm9tIGFueSBqc29uIHJlY2VpdmVkIG92ZXIgdGhlIHdpcmUuIFxyXG4gIFRoaXMgbWV0aG9kIGhhcyBhIGRlZmF1bHQgaW1wbGVtZW50YXRpb24gd2hpY2ggdG8gc2ltcGx5IHJldHVybiB0aGUgXCJyZXN1bHRzXCIgcHJvcGVydHkgZnJvbSBhbnkganNvbiByZXR1cm5lZCBhcyBhIHJlc3VsdCBvZiBleGVjdXRpbmcgdGhlIHF1ZXJ5LiBcclxuICAqL1xyXG4gIGV4dHJhY3RSZXN1bHRzPzogRnVuY3Rpb247XHJcbiAgLyoqIEEgZnVuY3Rpb24gdGhhdCBpcyBjYWxsZWQgb25jZSBwZXIgc2F2ZSBvcGVyYXRpb24gdG8gZXh0cmFjdCB0aGUgZW50aXRpZXMgZnJvbSBhbnkganNvbiByZWNlaXZlZCBvdmVyIHRoZSB3aXJlLiAgTXVzdCByZXR1cm4gYW4gYXJyYXkuXHJcbiAgVGhpcyBtZXRob2QgaGFzIGEgZGVmYXVsdCBpbXBsZW1lbnRhdGlvbiB3aGljaCBzaW1wbHkgcmV0dXJucyB0aGUgXCJlbnRpdGllc1wiIHByb3BlcnR5IGZyb20gYW55IGpzb24gcmV0dXJuZWQgYXMgYSByZXN1bHQgb2YgZXhlY3V0aW5nIHRoZSBzYXZlLiAqL1xyXG4gIGV4dHJhY3RTYXZlUmVzdWx0cz86IEZ1bmN0aW9uO1xyXG4gIC8qKiBBIGZ1bmN0aW9uIHRoYXQgaXMgY2FsbGVkIG9uY2UgcGVyIHNhdmUgb3BlcmF0aW9uIHRvIGV4dHJhY3QgdGhlIGtleSBtYXBwaW5ncyBmcm9tIGFueSBqc29uIHJlY2VpdmVkIG92ZXIgdGhlIHdpcmUuICBNdXN0IHJldHVybiBhbiBhcnJheS5cclxuICBUaGlzIG1ldGhvZCBoYXMgYSBkZWZhdWx0IGltcGxlbWVudGF0aW9uIHdoaWNoIHNpbXBseSByZXR1cm5zIHRoZSBcImtleU1hcHBpbmdzXCIgcHJvcGVydHkgZnJvbSBhbnkganNvbiByZXR1cm5lZCBhcyBhIHJlc3VsdCBvZiBleGVjdXRpbmcgdGhlIHNhdmUuICovXHJcbiAgZXh0cmFjdEtleU1hcHBpbmdzPzogKGRhdGE6IHt9KSA9PiBLZXlNYXBwaW5nW107XHJcbiAgLyoqIEEgZnVuY3Rpb24gdGhhdCBpcyBjYWxsZWQgb25jZSBwZXIgc2F2ZSBvcGVyYXRpb24gdG8gZXh0cmFjdCBhbnkgZGVsZXRlZCBrZXlzIGZyb20gYW55IGpzb24gcmVjZWl2ZWQgb3ZlciB0aGUgd2lyZS4gIE11c3QgcmV0dXJuIGFuIGFycmF5LlxyXG4gIFRoaXMgbWV0aG9kIGhhcyBhIGRlZmF1bHQgaW1wbGVtZW50YXRpb24gd2hpY2ggc2ltcGx5IHJldHVybnMgYW4gZW1wdHkgYXJyYXkuICovXHJcbiAgZXh0cmFjdERlbGV0ZWRLZXlzPzogKGRhdGE6IHt9KSA9PiBhbnlbXTsgLy8gVE9ETzogcmVmaW5lXHJcbiAgLyoqIEEgdmlzaXRvciBtZXRob2QgdGhhdCB3aWxsIGJlIGNhbGxlZCBvbiBlYWNoIG5vZGUgb2YgdGhlIHJldHVybmVkIHBheWxvYWQuICovXHJcbiAgdmlzaXROb2RlPzogKHY6IGFueSwgbWM/OiBNYXBwaW5nQ29udGV4dCwgbm9kZUNvbnRleHQ/OiBOb2RlQ29udGV4dCkgPT4gTm9kZU1ldGE7XHJcblxyXG59XHJcblxyXG4vKipcclxuQSBKc29uUmVzdWx0c0FkYXB0ZXIgaW5zdGFuY2UgaXMgdXNlZCB0byBwcm92aWRlIGN1c3RvbSBleHRyYWN0aW9uIGFuZCBwYXJzaW5nIGxvZ2ljIG9uIHRoZSBqc29uIHJlc3VsdHMgcmV0dXJuZWQgYnkgYW55IHdlYiBzZXJ2aWNlLlxyXG5UaGlzIGZhY2lsaXR5IG1ha2VzIGl0IHBvc3NpYmxlIGZvciBicmVlemUgdG8gdGFsayB0byB2aXJ0dWFsbHkgYW55IHdlYiBzZXJ2aWNlIGFuZCByZXR1cm4gb2JqZWN0cyB0aGF0IHdpbGwgYmUgZmlyc3QgY2xhc3MgJ2JyZWV6ZScgY2l0aXplbnMuXHJcbioqL1xyXG5leHBvcnQgY2xhc3MgSnNvblJlc3VsdHNBZGFwdGVyIHtcclxuICAvKiogQGhpZGRlbiBAaW50ZXJuYWwgKi9cclxuICBfJHR5cGVOYW1lOiBzdHJpbmc7IC8vIGFjdHVhbGx5IHB1dCBvbiBwcm90b3R5cGUuXHJcbiAgLyoqIFRoZSBuYW1lIG9mIHRoaXMgYWRhcHRlci4gIFRoaXMgbmFtZSBpcyB1c2VkIHRvIHVuaXF1ZWx5IGlkZW50aWZ5IGFuZCBsb2NhdGUgdGhpcyBpbnN0YW5jZSB3aGVuIGFuICdleHBvcnRlZCcgSnNvblJlc3VsdHNBZGFwdGVyIGlzIGxhdGVyIGltcG9ydGVkLiAqL1xyXG4gIG5hbWU6IHN0cmluZztcclxuICAvKiogQSBGdW5jdGlvbiB0aGF0IGlzIGNhbGxlZCBvbmNlIHBlciBxdWVyeSBvcGVyYXRpb24gdG8gZXh0cmFjdCB0aGUgJ3BheWxvYWQnIGZyb20gYW55IGpzb24gcmVjZWl2ZWQgb3ZlciB0aGUgd2lyZS4gXHJcbiAgVGhpcyBtZXRob2QgaGFzIGEgZGVmYXVsdCBpbXBsZW1lbnRhdGlvbiB3aGljaCBzaW1wbHkgcmV0dXJucyB0aGUgXCJyZXN1bHRzXCIgcHJvcGVydHkgZnJvbSBhbnkganNvbiByZXR1cm5lZCBhcyBhIHJlc3VsdCBvZiBleGVjdXRpbmcgdGhlIHF1ZXJ5LiAqL1xyXG4gIGV4dHJhY3RSZXN1bHRzOiBGdW5jdGlvbjsgLy8gVE9ETyAtIHJlZmluZVxyXG4gIC8qKiBBIGZ1bmN0aW9uIHRoYXQgaXMgY2FsbGVkIG9uY2UgcGVyIHNhdmUgb3BlcmF0aW9uIHRvIGV4dHJhY3QgdGhlIGVudGl0aWVzIGZyb20gYW55IGpzb24gcmVjZWl2ZWQgb3ZlciB0aGUgd2lyZS4gIE11c3QgcmV0dXJuIGFuIGFycmF5LlxyXG4gIFRoaXMgbWV0aG9kIGhhcyBhIGRlZmF1bHQgaW1wbGVtZW50YXRpb24gd2hpY2ggc2ltcGx5IHJldHVybnMgdGhlIFwiZW50aXRpZXNcIiBwcm9wZXJ0eSBmcm9tIGFueSBqc29uIHJldHVybmVkIGFzIGEgcmVzdWx0IG9mIGV4ZWN1dGluZyB0aGUgc2F2ZS4gKi9cclxuICBleHRyYWN0U2F2ZVJlc3VsdHM6IEZ1bmN0aW9uO1xyXG4gICAgLyoqIEEgZnVuY3Rpb24gdGhhdCBpcyBjYWxsZWQgb25jZSBwZXIgc2F2ZSBvcGVyYXRpb24gdG8gZXh0cmFjdCB0aGUga2V5IG1hcHBpbmdzIGZyb20gYW55IGpzb24gcmVjZWl2ZWQgb3ZlciB0aGUgd2lyZS4gIE11c3QgcmV0dXJuIGFuIGFycmF5LlxyXG4gIFRoaXMgbWV0aG9kIGhhcyBhIGRlZmF1bHQgaW1wbGVtZW50YXRpb24gd2hpY2ggc2ltcGx5IHJldHVybnMgdGhlIFwia2V5TWFwcGluZ3NcIiBwcm9wZXJ0eSBmcm9tIGFueSBqc29uIHJldHVybmVkIGFzIGEgcmVzdWx0IG9mIGV4ZWN1dGluZyB0aGUgc2F2ZS4gKi9cclxuICBleHRyYWN0S2V5TWFwcGluZ3M6ICAoZGF0YToge30pID0+IEtleU1hcHBpbmdbXTtcclxuICAvKiogQSBmdW5jdGlvbiB0aGF0IGlzIGNhbGxlZCBvbmNlIHBlciBzYXZlIG9wZXJhdGlvbiB0byBleHRyYWN0IGFueSBkZWxldGVkIGtleXMgZnJvbSBhbnkganNvbiByZWNlaXZlZCBvdmVyIHRoZSB3aXJlLiAgTXVzdCByZXR1cm4gYW4gYXJyYXkuXHJcbiAgVGhpcyBtZXRob2QgaGFzIGEgZGVmYXVsdCBpbXBsZW1lbnRhdGlvbiB3aGljaCBpcyB0byBzaW1wbHkgcmV0dXJucyB0aGUgXCJkZWxldGVkS2V5c1wiIHByb3BlcnR5IGZyb20gYW55IGpzb24gcmV0dXJuZWQgYXMgYSByZXN1bHQgb2YgZXhlY3V0aW5nIHRoZSBzYXZlLiAqL1xyXG4gIGV4dHJhY3REZWxldGVkS2V5cz86IChkYXRhOiB7fSkgPT4gYW55W107IC8vIFRPRE86IHJlZmluZVxyXG4gIC8qKiBBIHZpc2l0b3IgbWV0aG9kIHRoYXQgd2lsbCBiZSBjYWxsZWQgb24gZWFjaCBub2RlIG9mIHRoZSByZXR1cm5lZCBwYXlsb2FkLiAqL1xyXG4gIHZpc2l0Tm9kZTogRnVuY3Rpb247XHJcblxyXG4gIC8qKlxyXG4gIEpzb25SZXN1bHRzQWRhcHRlciBjb25zdHJ1Y3RvclxyXG5cclxuICBAZXhhbXBsZVxyXG4gICAgICAvL1xyXG4gICAgICB2YXIganNvblJlc3VsdHNBZGFwdGVyID0gbmV3IEpzb25SZXN1bHRzQWRhcHRlcih7XHJcbiAgICAgICAgICBuYW1lOiBcInRlc3QxZVwiLFxyXG4gICAgICAgICAgZXh0cmFjdFJlc3VsdHM6IGZ1bmN0aW9uKGpzb24pIHtcclxuICAgICAgICAgICAgICByZXR1cm4ganNvbi5yZXN1bHRzO1xyXG4gICAgICAgICAgfSxcclxuICAgICAgICAgIHZpc2l0Tm9kZTogZnVuY3Rpb24obm9kZSwgbWFwcGluZ0NvbnRleHQsIG5vZGVDb250ZXh0KSB7XHJcbiAgICAgICAgICAgICAgdmFyIGVudGl0eVR5cGUgPSBub3JtYWxpemVUeXBlTmFtZShub2RlLiR0eXBlKTtcclxuICAgICAgICAgICAgICB2YXIgcHJvcGVydHlOYW1lID0gbm9kZUNvbnRleHQucHJvcGVydHlOYW1lO1xyXG4gICAgICAgICAgICAgIHZhciBpZ25vcmUgPSBwcm9wZXJ0eU5hbWUgJiYgcHJvcGVydHlOYW1lLnN1YnN0cigwLCAxKSA9PT0gXCIkXCI7XHJcblxyXG4gICAgICAgICAgICAgIHJldHVybiB7XHJcbiAgICAgICAgICAgICAgICAgIGVudGl0eVR5cGU6IGVudGl0eVR5cGUsXHJcbiAgICAgICAgICAgICAgICAgIG5vZGVJZDogbm9kZS4kaWQsXHJcbiAgICAgICAgICAgICAgICAgIG5vZGVSZWZJZDogbm9kZS4kcmVmLFxyXG4gICAgICAgICAgICAgICAgICBpZ25vcmU6IGlnbm9yZSxcclxuICAgICAgICAgICAgICAgICAgcGFzc1RocnU6IGZhbHNlIC8vIGRlZmF1bHRcclxuICAgICAgICAgICAgICB9O1xyXG4gICAgICAgICAgfVxyXG4gICAgICB9KTtcclxuXHJcbiAgICAgIHZhciBkYXRhU2VydmljZSA9IG5ldyBEYXRhU2VydmljZSgge1xyXG4gICAgICAgICAgICAgIHNlcnZpY2VOYW1lOiBcImJyZWV6ZS9mb29cIixcclxuICAgICAgICAgICAgICBqc29uUmVzdWx0c0FkYXB0ZXI6IGpzb25SZXN1bHRzQWRhcHRlclxyXG4gICAgICB9KTtcclxuXHJcbiAgICAgIHZhciBlbnRpdHlNYW5hZ2VyID0gbmV3IEVudGl0eU1hbmFnZXIoIHtcclxuICAgICAgICAgIGRhdGFTZXJ2aWNlOiBkYXRhU2VydmljZVxyXG4gICAgICB9KTtcclxuXHJcbiAgQHBhcmFtIGNvbmZpZyAtIEEgY29uZmlndXJhdGlvbiBvYmplY3QuXHJcblxyXG4gICoqL1xyXG4gIGNvbnN0cnVjdG9yKGpzQ29uZmlnOiBKc29uUmVzdWx0c0FkYXB0ZXJDb25maWcpIHtcclxuICAgIGlmIChhcmd1bWVudHMubGVuZ3RoICE9PSAxKSB7XHJcbiAgICAgIHRocm93IG5ldyBFcnJvcihcIlRoZSBKc29uUmVzdWx0c0FkYXB0ZXIgY3RvciBzaG91bGQgYmUgY2FsbGVkIHdpdGggYSBzaW5nbGUgYXJndW1lbnQgdGhhdCBpcyBhIGNvbmZpZ3VyYXRpb24gb2JqZWN0LlwiKTtcclxuICAgIH1cclxuXHJcbiAgICBhc3NlcnRDb25maWcoanNDb25maWcpXHJcbiAgICAgICAgLndoZXJlUGFyYW0oXCJuYW1lXCIpLmlzTm9uRW1wdHlTdHJpbmcoKVxyXG4gICAgICAgIC53aGVyZVBhcmFtKFwiZXh0cmFjdFJlc3VsdHNcIikuaXNGdW5jdGlvbigpLmlzT3B0aW9uYWwoKS53aXRoRGVmYXVsdChleHRyYWN0UmVzdWx0c0RlZmF1bHQpXHJcbiAgICAgICAgLndoZXJlUGFyYW0oXCJleHRyYWN0U2F2ZVJlc3VsdHNcIikuaXNGdW5jdGlvbigpLmlzT3B0aW9uYWwoKS53aXRoRGVmYXVsdChleHRyYWN0U2F2ZVJlc3VsdHNEZWZhdWx0KVxyXG4gICAgICAgIC53aGVyZVBhcmFtKFwiZXh0cmFjdEtleU1hcHBpbmdzXCIpLmlzRnVuY3Rpb24oKS5pc09wdGlvbmFsKCkud2l0aERlZmF1bHQoZXh0cmFjdEtleU1hcHBpbmdzRGVmYXVsdClcclxuICAgICAgICAud2hlcmVQYXJhbShcImV4dHJhY3REZWxldGVkS2V5c1wiKS5pc0Z1bmN0aW9uKCkuaXNPcHRpb25hbCgpLndpdGhEZWZhdWx0KGV4dHJhY3REZWxldGVkS2V5c0RlZmF1bHQpXHJcbiAgICAgICAgLndoZXJlUGFyYW0oXCJ2aXNpdE5vZGVcIikuaXNGdW5jdGlvbigpXHJcbiAgICAgICAgLmFwcGx5QWxsKHRoaXMpO1xyXG4gICAgY29uZmlnLl9zdG9yZU9iamVjdCh0aGlzLCBcIkpzb25SZXN1bHRzQWRhcHRlclwiLCB0aGlzLm5hbWUpO1xyXG4gIH1cclxuXHJcbn1cclxuSnNvblJlc3VsdHNBZGFwdGVyLnByb3RvdHlwZS5fJHR5cGVOYW1lID0gXCJKc29uUmVzdWx0c0FkYXB0ZXJcIjtcclxuXHJcbmZ1bmN0aW9uIGV4dHJhY3RSZXN1bHRzRGVmYXVsdChkYXRhOiBhbnkpIHtcclxuICByZXR1cm4gZGF0YS5yZXN1bHRzO1xyXG59XHJcblxyXG5mdW5jdGlvbiBleHRyYWN0U2F2ZVJlc3VsdHNEZWZhdWx0KGRhdGE6IGFueSkge1xyXG4gIHJldHVybiBkYXRhLmVudGl0aWVzIHx8IGRhdGEuRW50aXRpZXMgfHwgW107XHJcbn1cclxuXHJcbmZ1bmN0aW9uIGV4dHJhY3RLZXlNYXBwaW5nc0RlZmF1bHQoZGF0YTogYW55KSB7XHJcbiAgcmV0dXJuIGRhdGEua2V5TWFwcGluZ3MgfHwgZGF0YS5LZXlNYXBwaW5ncyB8fCBbXTtcclxufVxyXG5cclxuZnVuY3Rpb24gZXh0cmFjdERlbGV0ZWRLZXlzRGVmYXVsdChkYXRhOiBhbnkpIHtcclxuICByZXR1cm4gZGF0YS5kZWxldGVkS2V5cyB8fCBkYXRhLkRlbGV0ZWRLZXlzIHx8IFtdO1xyXG59XHJcblxyXG4iXX0=