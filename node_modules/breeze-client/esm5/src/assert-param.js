import { core } from './core';
/** @hidden @internal */
var Param = /** @class */ (function () {
    function Param(v, name) {
        /** @hidden @internal */
        this._applyOne = function (instance) {
            if (this.v !== undefined) {
                instance[this.name] = this.v;
            }
            else {
                if (this.defaultValue !== undefined) {
                    instance[this.name] = this.defaultValue;
                }
            }
        };
        this.MESSAGE_PREFIX = "The '%1' parameter ";
        this.v = v;
        this.name = name;
        this._contexts = [null];
    }
    Param.prototype.isObject = function () {
        return this.isTypeOf('object');
    };
    Param.prototype.isBoolean = function () {
        return this.isTypeOf('boolean');
    };
    Param.prototype.isString = function () {
        return this.isTypeOf('string');
    };
    Param.prototype.isNumber = function () {
        return this.isTypeOf('number');
    };
    Param.prototype.isFunction = function () {
        return this.isTypeOf('function');
    };
    Param.prototype.isNonEmptyString = function () {
        return addContext(this, {
            fn: isNonEmptyString,
            msg: "must be a nonEmpty string"
        });
    };
    Param.prototype.isTypeOf = function (typeName) {
        return addContext(this, {
            fn: isTypeOf,
            typeName: typeName,
            msg: "must be a '" + typeName + "'"
        });
    };
    Param.prototype.isInstanceOf = function (type, typeName) {
        typeName = typeName || type.prototype._$typeName;
        return addContext(this, {
            fn: isInstanceOf,
            type: type,
            typeName: typeName,
            msg: "must be an instance of '" + typeName + "'"
        });
    };
    Param.prototype.hasProperty = function (propertyName) {
        return addContext(this, {
            fn: hasProperty,
            propertyName: propertyName,
            msg: "must have a '" + propertyName + "' property"
        });
    };
    Param.prototype.isEnumOf = function (enumType) {
        return addContext(this, {
            fn: isEnumOf,
            enumType: enumType,
            msg: "must be an instance of the '" + (enumType.name || 'unknown') + "' enumeration"
        });
    };
    Param.prototype.isRequired = function (allowNull) {
        if (allowNull === void 0) { allowNull = false; }
        return addContext(this, {
            fn: isRequired,
            allowNull: allowNull,
            msg: "is required"
        });
    };
    Param.prototype.isOptional = function () {
        var context = {
            fn: isOptional,
            prevContext: null,
            msg: isOptionalMessage
        };
        return addContext(this, context);
    };
    Param.prototype.isNonEmptyArray = function () {
        return this.isArray(true);
    };
    Param.prototype.isArray = function (mustNotBeEmpty) {
        var context = {
            fn: isArray,
            mustNotBeEmpty: mustNotBeEmpty,
            prevContext: null,
            msg: isArrayMessage
        };
        return addContext(this, context);
    };
    Param.prototype.or = function () {
        this._contexts.push(null);
        this._context = null;
        return this;
    };
    Param.prototype.check = function (defaultValue) {
        var ok = exec(this);
        if (ok === undefined)
            return;
        if (!ok) {
            throw new Error(this.getMessage());
        }
        if (this.v !== undefined) {
            return this.v;
        }
        else {
            return defaultValue;
        }
    };
    /** @hidden @internal */
    // called from outside this file.
    Param.prototype._addContext = function (context) {
        return addContext(this, context);
    };
    Param.prototype.getMessage = function () {
        var that = this;
        var message = this._contexts.map(function (context) {
            return getMessage(context, that.v);
        }).join(", or it ");
        return core.formatString(this.MESSAGE_PREFIX, this.name) + " " + message;
    };
    Param.prototype.withDefault = function (defaultValue) {
        this.defaultValue = defaultValue;
        return this;
    };
    Param.prototype.whereParam = function (propName) {
        return this.parent.whereParam(propName);
    };
    Param.prototype.applyAll = function (instance, checkOnly) {
        if (checkOnly === void 0) { checkOnly = false; }
        var parentTypeName = instance._$typeName;
        var allowUnknownProperty = (parentTypeName && this.parent.config._$typeName === parentTypeName);
        var clone = core.extend({}, this.parent.config);
        this.parent.params.forEach(function (p) {
            if (!allowUnknownProperty)
                delete clone[p.name];
            try {
                p.check();
            }
            catch (e) {
                throwConfigError(instance, e.message);
            }
            (!checkOnly) && p._applyOne(instance);
        });
        // should be no properties left in the clone
        if (!allowUnknownProperty) {
            for (var key in clone) {
                // allow props with an undefined value
                if (clone[key] !== undefined) {
                    throwConfigError(instance, core.formatString("Unknown property: '%1'.", key));
                }
            }
        }
    };
    return Param;
}());
export { Param };
/** @hidden @internal */
export var assertParam = function (v, name) {
    return new Param(v, name);
};
function isTypeOf(context, v) {
    if (v == null)
        return false;
    if (typeof (v) === context.typeName)
        return true;
    return false;
}
function isNonEmptyString(context, v) {
    if (v == null)
        return false;
    return (typeof (v) === 'string') && v.length > 0;
}
function isInstanceOf(context, v) {
    if (v == null || context.type == null)
        return false;
    return (v instanceof context.type);
}
function isEnumOf(context, v) {
    if (v == null || context.enumType == null)
        return false;
    return context.enumType.contains(v);
}
function hasProperty(context, v) {
    if (v == null || context.propertyName == null)
        return false;
    return (v[context.propertyName] !== undefined);
}
function isRequired(context, v) {
    if (context.allowNull) {
        return v !== undefined;
    }
    else {
        return v != null;
    }
}
function isOptional(context, v) {
    if (v == null)
        return true;
    var prevContext = context.prevContext;
    if (prevContext && prevContext.fn) {
        return prevContext.fn(prevContext, v);
    }
    else {
        return true;
    }
}
function isOptionalMessage(context, v) {
    var prevContext = context.prevContext;
    var element = prevContext ? " or it " + getMessage(prevContext, v) : "";
    return "is optional" + element;
}
function isArray(context, v) {
    if (!Array.isArray(v)) {
        return false;
    }
    if (context.mustNotBeEmpty) {
        if (v.length === 0)
            return false;
    }
    // allow standalone is array call.
    var prevContext = context.prevContext;
    if (!prevContext)
        return true;
    var pc = prevContext;
    return v.every(function (v1) {
        return pc.fn && pc.fn(pc, v1);
    });
}
function isArrayMessage(context, v) {
    var arrayDescr = context.mustNotBeEmpty ? "a nonEmpty array" : "an array";
    var prevContext = context.prevContext;
    var element = prevContext ? " where each element " + getMessage(prevContext, v) : "";
    return " must be " + arrayDescr + element;
}
function getMessage(context, v) {
    var msg = context.msg;
    if (typeof (msg) === "function") {
        msg = msg(context, v);
    }
    return msg;
}
function addContext(that, context) {
    if (that._context) {
        var curContext = that._context;
        while (curContext.prevContext != null) {
            curContext = curContext.prevContext;
        }
        if (curContext.prevContext === null) {
            curContext.prevContext = context;
            // just update the prevContext but don't change the curContext.
            return that;
        }
        else if (context.prevContext == null) {
            context.prevContext = that._context;
        }
        else {
            throw new Error("Illegal construction - use 'or' to combine checks");
        }
    }
    return setContext(that, context);
}
function setContext(that, context) {
    that._contexts[that._contexts.length - 1] = context;
    that._context = context;
    return that;
}
function exec(self) {
    // clear off last one if null
    var contexts = self._contexts;
    if (contexts[contexts.length - 1] == null) {
        contexts.pop();
    }
    if (contexts.length === 0) {
        return undefined;
    }
    return contexts.some(function (context) {
        return context.fn ? context.fn(context, self.v) : false;
    });
}
function throwConfigError(instance, message) {
    throw new Error(core.formatString("Error configuring an instance of '%1'. %2", (instance && instance._$typeName) || "object", message));
}
var ConfigParam = /** @class */ (function () {
    function ConfigParam(config) {
        if (typeof (config) !== "object") {
            throw new Error("Configuration parameter should be an object, instead it is a: " + typeof (config));
        }
        this.config = config;
        this.params = [];
    }
    ConfigParam.prototype.whereParam = function (propName) {
        var param = new Param(this.config[propName], propName);
        param.parent = this;
        this.params.push(param);
        return param;
    };
    return ConfigParam;
}());
/** @hidden @internal */
export var assertConfig = function (config) {
    return new ConfigParam(config);
};
// Param is exposed so that additional 'is' methods can be added to the prototype.
core.Param = Param;
core.assertParam = assertParam;
core.assertConfig = assertConfig;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYXNzZXJ0LXBhcmFtLmpzIiwic291cmNlUm9vdCI6Im5nOi8vYnJlZXplLWNsaWVudC8iLCJzb3VyY2VzIjpbInNyYy9hc3NlcnQtcGFyYW0udHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQ0EsT0FBTyxFQUFFLElBQUksRUFBRyxNQUFNLFFBQVEsQ0FBQztBQXNCL0Isd0JBQXdCO0FBQ3hCO0lBbUJJLGVBQVksQ0FBTSxFQUFFLElBQVk7UUEwS2hDLHdCQUF3QjtRQUN4QixjQUFTLEdBQUcsVUFBdUIsUUFBYTtZQUM1QyxJQUFJLElBQUksQ0FBQyxDQUFDLEtBQUssU0FBUyxFQUFFO2dCQUN0QixRQUFRLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxHQUFHLElBQUksQ0FBQyxDQUFDLENBQUM7YUFDaEM7aUJBQU07Z0JBQ0gsSUFBSSxJQUFJLENBQUMsWUFBWSxLQUFLLFNBQVMsRUFBRTtvQkFDakMsUUFBUSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsR0FBRyxJQUFJLENBQUMsWUFBWSxDQUFDO2lCQUMzQzthQUNKO1FBQ0wsQ0FBQyxDQUFDO1FBRUYsbUJBQWMsR0FBRyxxQkFBcUIsQ0FBQztRQXBMbkMsSUFBSSxDQUFDLENBQUMsR0FBRyxDQUFDLENBQUM7UUFDWCxJQUFJLENBQUMsSUFBSSxHQUFHLElBQUksQ0FBQztRQUNqQixJQUFJLENBQUMsU0FBUyxHQUFHLENBQU0sSUFBSSxDQUFDLENBQUM7SUFDakMsQ0FBQztJQUVELHdCQUFRLEdBQVI7UUFDSSxPQUFPLElBQUksQ0FBQyxRQUFRLENBQUMsUUFBUSxDQUFDLENBQUM7SUFDbkMsQ0FBQztJQUVELHlCQUFTLEdBQVQ7UUFDSSxPQUFPLElBQUksQ0FBQyxRQUFRLENBQUMsU0FBUyxDQUFDLENBQUM7SUFDcEMsQ0FBQztJQUVELHdCQUFRLEdBQVI7UUFDSSxPQUFPLElBQUksQ0FBQyxRQUFRLENBQUMsUUFBUSxDQUFDLENBQUM7SUFDbkMsQ0FBQztJQUVELHdCQUFRLEdBQVI7UUFDSSxPQUFPLElBQUksQ0FBQyxRQUFRLENBQUMsUUFBUSxDQUFDLENBQUM7SUFDbkMsQ0FBQztJQUVELDBCQUFVLEdBQVY7UUFDSSxPQUFPLElBQUksQ0FBQyxRQUFRLENBQUMsVUFBVSxDQUFDLENBQUM7SUFDckMsQ0FBQztJQUVELGdDQUFnQixHQUFoQjtRQUNJLE9BQU8sVUFBVSxDQUFDLElBQUksRUFBRTtZQUNwQixFQUFFLEVBQUUsZ0JBQWdCO1lBQ3BCLEdBQUcsRUFBRSwyQkFBMkI7U0FDbkMsQ0FBQyxDQUFDO0lBQ1AsQ0FBQztJQUdELHdCQUFRLEdBQVIsVUFBUyxRQUFnQjtRQUNyQixPQUFPLFVBQVUsQ0FBQyxJQUFJLEVBQUU7WUFDcEIsRUFBRSxFQUFFLFFBQVE7WUFDWixRQUFRLEVBQUUsUUFBUTtZQUNsQixHQUFHLEVBQUUsYUFBYSxHQUFHLFFBQVEsR0FBRyxHQUFHO1NBQ3RDLENBQUMsQ0FBQztJQUNQLENBQUM7SUFHRCw0QkFBWSxHQUFaLFVBQWEsSUFBYyxFQUFFLFFBQWlCO1FBQzFDLFFBQVEsR0FBRyxRQUFRLElBQUksSUFBSSxDQUFDLFNBQVMsQ0FBQyxVQUFVLENBQUM7UUFDakQsT0FBTyxVQUFVLENBQUMsSUFBSSxFQUFFO1lBQ3BCLEVBQUUsRUFBRSxZQUFZO1lBQ2hCLElBQUksRUFBRSxJQUFJO1lBQ1YsUUFBUSxFQUFFLFFBQVE7WUFDbEIsR0FBRyxFQUFFLDBCQUEwQixHQUFHLFFBQVEsR0FBRyxHQUFHO1NBQ25ELENBQUMsQ0FBQztJQUNQLENBQUM7SUFHRCwyQkFBVyxHQUFYLFVBQVksWUFBb0I7UUFDNUIsT0FBTyxVQUFVLENBQUMsSUFBSSxFQUFFO1lBQ3BCLEVBQUUsRUFBRSxXQUFXO1lBQ2YsWUFBWSxFQUFFLFlBQVk7WUFDMUIsR0FBRyxFQUFFLGVBQWUsR0FBRyxZQUFZLEdBQUcsWUFBWTtTQUNyRCxDQUFDLENBQUM7SUFDUCxDQUFDO0lBR0Qsd0JBQVEsR0FBUixVQUFTLFFBQWE7UUFDbEIsT0FBTyxVQUFVLENBQUMsSUFBSSxFQUFFO1lBQ3BCLEVBQUUsRUFBRSxRQUFRO1lBQ1osUUFBUSxFQUFFLFFBQVE7WUFDbEIsR0FBRyxFQUFFLDhCQUE4QixHQUFHLENBQUMsUUFBUSxDQUFDLElBQUksSUFBSSxTQUFTLENBQUMsR0FBRyxlQUFlO1NBQ3ZGLENBQUMsQ0FBQztJQUNQLENBQUM7SUFFRCwwQkFBVSxHQUFWLFVBQVcsU0FBMEI7UUFBMUIsMEJBQUEsRUFBQSxpQkFBMEI7UUFDakMsT0FBTyxVQUFVLENBQUMsSUFBSSxFQUFFO1lBQ3BCLEVBQUUsRUFBRSxVQUFVO1lBQ2QsU0FBUyxFQUFFLFNBQVM7WUFDcEIsR0FBRyxFQUFFLGFBQWE7U0FDckIsQ0FBQyxDQUFDO0lBQ1AsQ0FBQztJQUVELDBCQUFVLEdBQVY7UUFDSSxJQUFJLE9BQU8sR0FBRztZQUNWLEVBQUUsRUFBRSxVQUFVO1lBQ2QsV0FBVyxFQUFPLElBQUk7WUFDdEIsR0FBRyxFQUFFLGlCQUFpQjtTQUN6QixDQUFDO1FBQ0YsT0FBTyxVQUFVLENBQUMsSUFBSSxFQUFFLE9BQU8sQ0FBQyxDQUFDO0lBQ3JDLENBQUM7SUFFRCwrQkFBZSxHQUFmO1FBQ0ksT0FBTyxJQUFJLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxDQUFDO0lBQzlCLENBQUM7SUFFRCx1QkFBTyxHQUFQLFVBQVEsY0FBd0I7UUFDNUIsSUFBSSxPQUFPLEdBQUc7WUFDVixFQUFFLEVBQUUsT0FBTztZQUNYLGNBQWMsRUFBRSxjQUFjO1lBQzlCLFdBQVcsRUFBTyxJQUFJO1lBQ3RCLEdBQUcsRUFBRSxjQUFjO1NBQ3RCLENBQUM7UUFDRixPQUFPLFVBQVUsQ0FBQyxJQUFJLEVBQUUsT0FBTyxDQUFDLENBQUM7SUFDckMsQ0FBQztJQUVELGtCQUFFLEdBQUY7UUFDSSxJQUFJLENBQUMsU0FBUyxDQUFDLElBQUksQ0FBTSxJQUFJLENBQUMsQ0FBQztRQUMvQixJQUFJLENBQUMsUUFBUSxHQUFRLElBQUksQ0FBQztRQUMxQixPQUFPLElBQUksQ0FBQztJQUNoQixDQUFDO0lBRUQscUJBQUssR0FBTCxVQUFNLFlBQWtCO1FBQ3BCLElBQUksRUFBRSxHQUFHLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQztRQUNwQixJQUFJLEVBQUUsS0FBSyxTQUFTO1lBQUUsT0FBTztRQUM3QixJQUFJLENBQUMsRUFBRSxFQUFFO1lBQ0wsTUFBTSxJQUFJLEtBQUssQ0FBQyxJQUFJLENBQUMsVUFBVSxFQUFFLENBQUMsQ0FBQztTQUN0QztRQUVELElBQUksSUFBSSxDQUFDLENBQUMsS0FBSyxTQUFTLEVBQUU7WUFDdEIsT0FBTyxJQUFJLENBQUMsQ0FBQyxDQUFDO1NBQ2pCO2FBQU07WUFDSCxPQUFPLFlBQVksQ0FBQztTQUN2QjtJQUNMLENBQUM7SUFFRCx3QkFBd0I7SUFDeEIsaUNBQWlDO0lBQ2pDLDJCQUFXLEdBQVgsVUFBWSxPQUFzQjtRQUM5QixPQUFPLFVBQVUsQ0FBQyxJQUFJLEVBQUUsT0FBTyxDQUFDLENBQUM7SUFDckMsQ0FBQztJQUVELDBCQUFVLEdBQVY7UUFDSSxJQUFJLElBQUksR0FBRyxJQUFJLENBQUM7UUFDaEIsSUFBSSxPQUFPLEdBQUcsSUFBSSxDQUFDLFNBQVMsQ0FBQyxHQUFHLENBQUMsVUFBVSxPQUFPO1lBQzlDLE9BQU8sVUFBVSxDQUFDLE9BQU8sRUFBRSxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUM7UUFDdkMsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLFVBQVUsQ0FBQyxDQUFDO1FBQ3BCLE9BQU8sSUFBSSxDQUFDLFlBQVksQ0FBQyxJQUFJLENBQUMsY0FBYyxFQUFFLElBQUksQ0FBQyxJQUFJLENBQUMsR0FBRyxHQUFHLEdBQUcsT0FBTyxDQUFDO0lBQzdFLENBQUM7SUFFRCwyQkFBVyxHQUFYLFVBQVksWUFBaUI7UUFDekIsSUFBSSxDQUFDLFlBQVksR0FBRyxZQUFZLENBQUM7UUFDakMsT0FBTyxJQUFJLENBQUM7SUFDaEIsQ0FBQztJQUVELDBCQUFVLEdBQVYsVUFBVyxRQUFnQjtRQUN2QixPQUFPLElBQUksQ0FBQyxNQUFNLENBQUMsVUFBVSxDQUFDLFFBQVEsQ0FBQyxDQUFDO0lBQzVDLENBQUM7SUFFRCx3QkFBUSxHQUFSLFVBQVMsUUFBYSxFQUFFLFNBQTBCO1FBQTFCLDBCQUFBLEVBQUEsaUJBQTBCO1FBQzlDLElBQUksY0FBYyxHQUFHLFFBQVEsQ0FBQyxVQUFVLENBQUM7UUFDekMsSUFBSSxvQkFBb0IsR0FBRyxDQUFDLGNBQWMsSUFBSSxJQUFJLENBQUMsTUFBTSxDQUFDLE1BQU0sQ0FBQyxVQUFVLEtBQUssY0FBYyxDQUFDLENBQUM7UUFFaEcsSUFBSSxLQUFLLEdBQUcsSUFBSSxDQUFDLE1BQU0sQ0FBQyxFQUFFLEVBQUUsSUFBSSxDQUFDLE1BQU0sQ0FBQyxNQUFNLENBQUMsQ0FBQztRQUNoRCxJQUFJLENBQUMsTUFBTSxDQUFDLE1BQU0sQ0FBQyxPQUFPLENBQUMsVUFBVSxDQUFDO1lBQ2xDLElBQUksQ0FBQyxvQkFBb0I7Z0JBQUUsT0FBTyxLQUFLLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxDQUFDO1lBQ2hELElBQUk7Z0JBQ0EsQ0FBQyxDQUFDLEtBQUssRUFBRSxDQUFDO2FBQ2I7WUFBQyxPQUFPLENBQUMsRUFBRTtnQkFDUixnQkFBZ0IsQ0FBQyxRQUFRLEVBQUUsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxDQUFDO2FBQ3pDO1lBQ0QsQ0FBQyxDQUFDLFNBQVMsQ0FBQyxJQUFJLENBQUMsQ0FBQyxTQUFTLENBQUMsUUFBUSxDQUFDLENBQUM7UUFDMUMsQ0FBQyxDQUFDLENBQUM7UUFDSCw0Q0FBNEM7UUFDNUMsSUFBSSxDQUFDLG9CQUFvQixFQUFFO1lBQ3ZCLEtBQUssSUFBSSxHQUFHLElBQUksS0FBSyxFQUFFO2dCQUNuQixzQ0FBc0M7Z0JBQ3RDLElBQUksS0FBSyxDQUFDLEdBQUcsQ0FBQyxLQUFLLFNBQVMsRUFBRTtvQkFDMUIsZ0JBQWdCLENBQUMsUUFBUSxFQUFFLElBQUksQ0FBQyxZQUFZLENBQUMseUJBQXlCLEVBQUUsR0FBRyxDQUFDLENBQUMsQ0FBQztpQkFDakY7YUFDSjtTQUNKO0lBQ0wsQ0FBQztJQWVMLFlBQUM7QUFBRCxDQUFDLEFBMU1ELElBME1DOztBQUVELHdCQUF3QjtBQUN4QixNQUFNLENBQUMsSUFBSSxXQUFXLEdBQUcsVUFBVSxDQUFNLEVBQUUsSUFBWTtJQUNuRCxPQUFPLElBQUksS0FBSyxDQUFDLENBQUMsRUFBRSxJQUFJLENBQUMsQ0FBQztBQUM5QixDQUFDLENBQUM7QUFFRixTQUFTLFFBQVEsQ0FBQyxPQUFzQixFQUFFLENBQU07SUFDNUMsSUFBSSxDQUFDLElBQUksSUFBSTtRQUFFLE9BQU8sS0FBSyxDQUFDO0lBQzVCLElBQUksT0FBTyxDQUFDLENBQUMsQ0FBQyxLQUFLLE9BQU8sQ0FBQyxRQUFRO1FBQUUsT0FBTyxJQUFJLENBQUM7SUFDakQsT0FBTyxLQUFLLENBQUM7QUFDakIsQ0FBQztBQUVELFNBQVMsZ0JBQWdCLENBQUMsT0FBc0IsRUFBRSxDQUFNO0lBQ3BELElBQUksQ0FBQyxJQUFJLElBQUk7UUFBRSxPQUFPLEtBQUssQ0FBQztJQUM1QixPQUFPLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQyxLQUFLLFFBQVEsQ0FBQyxJQUFJLENBQUMsQ0FBQyxNQUFNLEdBQUcsQ0FBQyxDQUFDO0FBQ3JELENBQUM7QUFFRCxTQUFTLFlBQVksQ0FBQyxPQUFzQixFQUFFLENBQU07SUFDaEQsSUFBSSxDQUFDLElBQUksSUFBSSxJQUFJLE9BQU8sQ0FBQyxJQUFJLElBQUksSUFBSTtRQUFFLE9BQU8sS0FBSyxDQUFDO0lBQ3BELE9BQU8sQ0FBQyxDQUFDLFlBQVksT0FBTyxDQUFDLElBQUksQ0FBQyxDQUFDO0FBQ3ZDLENBQUM7QUFFRCxTQUFTLFFBQVEsQ0FBQyxPQUFzQixFQUFFLENBQU07SUFDNUMsSUFBSSxDQUFDLElBQUksSUFBSSxJQUFJLE9BQU8sQ0FBQyxRQUFRLElBQUksSUFBSTtRQUFHLE9BQU8sS0FBSyxDQUFDO0lBQ3pELE9BQVEsT0FBTyxDQUFDLFFBQWdCLENBQUMsUUFBUSxDQUFDLENBQUMsQ0FBQyxDQUFDO0FBQ2pELENBQUM7QUFFRCxTQUFTLFdBQVcsQ0FBQyxPQUFzQixFQUFFLENBQU07SUFDL0MsSUFBSSxDQUFDLElBQUksSUFBSSxJQUFJLE9BQU8sQ0FBQyxZQUFZLElBQUksSUFBSTtRQUFFLE9BQU8sS0FBSyxDQUFDO0lBQzVELE9BQU8sQ0FBQyxDQUFDLENBQUMsT0FBTyxDQUFDLFlBQVksQ0FBQyxLQUFLLFNBQVMsQ0FBQyxDQUFDO0FBQ25ELENBQUM7QUFFRCxTQUFTLFVBQVUsQ0FBQyxPQUFzQixFQUFFLENBQU07SUFDOUMsSUFBSSxPQUFPLENBQUMsU0FBUyxFQUFFO1FBQ25CLE9BQU8sQ0FBQyxLQUFLLFNBQVMsQ0FBQztLQUMxQjtTQUFNO1FBQ0gsT0FBTyxDQUFDLElBQUksSUFBSSxDQUFDO0tBQ3BCO0FBQ0wsQ0FBQztBQUVELFNBQVMsVUFBVSxDQUFDLE9BQXNCLEVBQUUsQ0FBTTtJQUM5QyxJQUFJLENBQUMsSUFBSSxJQUFJO1FBQUUsT0FBTyxJQUFJLENBQUM7SUFDM0IsSUFBSSxXQUFXLEdBQUcsT0FBTyxDQUFDLFdBQVcsQ0FBQztJQUN0QyxJQUFJLFdBQVcsSUFBSSxXQUFXLENBQUMsRUFBRSxFQUFFO1FBQy9CLE9BQU8sV0FBVyxDQUFDLEVBQUUsQ0FBQyxXQUFXLEVBQUUsQ0FBQyxDQUFDLENBQUM7S0FDekM7U0FBTTtRQUNILE9BQU8sSUFBSSxDQUFDO0tBQ2Y7QUFDTCxDQUFDO0FBRUQsU0FBUyxpQkFBaUIsQ0FBQyxPQUFzQixFQUFFLENBQU07SUFDckQsSUFBSSxXQUFXLEdBQUcsT0FBTyxDQUFDLFdBQVcsQ0FBQztJQUN0QyxJQUFJLE9BQU8sR0FBRyxXQUFXLENBQUMsQ0FBQyxDQUFDLFNBQVMsR0FBRyxVQUFVLENBQUMsV0FBVyxFQUFFLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUM7SUFDeEUsT0FBTyxhQUFhLEdBQUcsT0FBTyxDQUFDO0FBQ25DLENBQUM7QUFFRCxTQUFTLE9BQU8sQ0FBQyxPQUFzQixFQUFFLENBQU07SUFDM0MsSUFBSSxDQUFDLEtBQUssQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDLEVBQUU7UUFDbkIsT0FBTyxLQUFLLENBQUM7S0FDaEI7SUFDRCxJQUFJLE9BQU8sQ0FBQyxjQUFjLEVBQUU7UUFDeEIsSUFBSSxDQUFDLENBQUMsTUFBTSxLQUFLLENBQUM7WUFBRSxPQUFPLEtBQUssQ0FBQztLQUNwQztJQUNELGtDQUFrQztJQUNsQyxJQUFJLFdBQVcsR0FBRyxPQUFPLENBQUMsV0FBVyxDQUFDO0lBQ3RDLElBQUksQ0FBQyxXQUFXO1FBQUUsT0FBTyxJQUFJLENBQUM7SUFFOUIsSUFBSSxFQUFFLEdBQVEsV0FBVyxDQUFDO0lBQzFCLE9BQU8sQ0FBQyxDQUFDLEtBQUssQ0FBQyxVQUFVLEVBQU87UUFDNUIsT0FBTyxFQUFFLENBQUMsRUFBRSxJQUFJLEVBQUUsQ0FBQyxFQUFFLENBQUMsRUFBRSxFQUFFLEVBQUUsQ0FBQyxDQUFDO0lBQ2xDLENBQUMsQ0FBQyxDQUFDO0FBQ1AsQ0FBQztBQUVELFNBQVMsY0FBYyxDQUFDLE9BQXNCLEVBQUUsQ0FBTTtJQUNsRCxJQUFJLFVBQVUsR0FBRyxPQUFPLENBQUMsY0FBYyxDQUFDLENBQUMsQ0FBQyxrQkFBa0IsQ0FBQyxDQUFDLENBQUMsVUFBVSxDQUFDO0lBQzFFLElBQUksV0FBVyxHQUFHLE9BQU8sQ0FBQyxXQUFXLENBQUM7SUFDdEMsSUFBSSxPQUFPLEdBQUcsV0FBVyxDQUFDLENBQUMsQ0FBQyxzQkFBc0IsR0FBRyxVQUFVLENBQUMsV0FBVyxFQUFFLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUM7SUFDckYsT0FBTyxXQUFXLEdBQUcsVUFBVSxHQUFHLE9BQU8sQ0FBQztBQUM5QyxDQUFDO0FBRUQsU0FBUyxVQUFVLENBQUMsT0FBc0IsRUFBRSxDQUFNO0lBQzlDLElBQUksR0FBRyxHQUFHLE9BQU8sQ0FBQyxHQUFHLENBQUM7SUFDdEIsSUFBSSxPQUFPLENBQUMsR0FBRyxDQUFDLEtBQUssVUFBVSxFQUFFO1FBQzdCLEdBQUcsR0FBUyxHQUFJLENBQUMsT0FBTyxFQUFFLENBQUMsQ0FBQyxDQUFDO0tBQ2hDO0lBQ0QsT0FBTyxHQUFHLENBQUM7QUFDZixDQUFDO0FBRUQsU0FBUyxVQUFVLENBQUMsSUFBVyxFQUFFLE9BQXNCO0lBQ25ELElBQUksSUFBSSxDQUFDLFFBQVEsRUFBRTtRQUNmLElBQUksVUFBVSxHQUFHLElBQUksQ0FBQyxRQUFRLENBQUM7UUFFL0IsT0FBTyxVQUFVLENBQUMsV0FBVyxJQUFJLElBQUksRUFBRTtZQUNuQyxVQUFVLEdBQUcsVUFBVSxDQUFDLFdBQVcsQ0FBQztTQUN2QztRQUVELElBQUksVUFBVSxDQUFDLFdBQVcsS0FBSyxJQUFJLEVBQUU7WUFDakMsVUFBVSxDQUFDLFdBQVcsR0FBRyxPQUFPLENBQUM7WUFDakMsK0RBQStEO1lBQy9ELE9BQU8sSUFBSSxDQUFDO1NBQ2Y7YUFBTSxJQUFJLE9BQU8sQ0FBQyxXQUFXLElBQUksSUFBSSxFQUFFO1lBQ3BDLE9BQU8sQ0FBQyxXQUFXLEdBQUcsSUFBSSxDQUFDLFFBQVEsQ0FBQztTQUN2QzthQUFNO1lBQ0gsTUFBTSxJQUFJLEtBQUssQ0FBQyxtREFBbUQsQ0FBQyxDQUFDO1NBQ3hFO0tBQ0o7SUFDRCxPQUFPLFVBQVUsQ0FBQyxJQUFJLEVBQUUsT0FBTyxDQUFDLENBQUM7QUFDckMsQ0FBQztBQUVELFNBQVMsVUFBVSxDQUFDLElBQVcsRUFBRSxPQUFzQjtJQUNuRCxJQUFJLENBQUMsU0FBUyxDQUFDLElBQUksQ0FBQyxTQUFTLENBQUMsTUFBTSxHQUFHLENBQUMsQ0FBQyxHQUFHLE9BQU8sQ0FBQztJQUNwRCxJQUFJLENBQUMsUUFBUSxHQUFHLE9BQU8sQ0FBQztJQUN4QixPQUFPLElBQUksQ0FBQztBQUNoQixDQUFDO0FBR0QsU0FBUyxJQUFJLENBQUMsSUFBVztJQUNyQiw2QkFBNkI7SUFDN0IsSUFBSSxRQUFRLEdBQUcsSUFBSSxDQUFDLFNBQVMsQ0FBQztJQUM5QixJQUFJLFFBQVEsQ0FBQyxRQUFRLENBQUMsTUFBTSxHQUFHLENBQUMsQ0FBQyxJQUFJLElBQUksRUFBRTtRQUN2QyxRQUFRLENBQUMsR0FBRyxFQUFFLENBQUM7S0FDbEI7SUFDRCxJQUFJLFFBQVEsQ0FBQyxNQUFNLEtBQUssQ0FBQyxFQUFFO1FBQ3ZCLE9BQU8sU0FBUyxDQUFDO0tBQ3BCO0lBQ0QsT0FBTyxRQUFRLENBQUMsSUFBSSxDQUFDLFVBQVUsT0FBc0I7UUFDakQsT0FBTyxPQUFPLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQyxPQUFPLENBQUMsRUFBRSxDQUFDLE9BQU8sRUFBRSxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLEtBQUssQ0FBQztJQUM1RCxDQUFDLENBQUMsQ0FBQztBQUNQLENBQUM7QUFFRCxTQUFTLGdCQUFnQixDQUFDLFFBQWEsRUFBRSxPQUFlO0lBQ3BELE1BQU0sSUFBSSxLQUFLLENBQUMsSUFBSSxDQUFDLFlBQVksQ0FBQywyQ0FBMkMsRUFBRSxDQUFDLFFBQVEsSUFBSSxRQUFRLENBQUMsVUFBVSxDQUFDLElBQUksUUFBUSxFQUFFLE9BQU8sQ0FBQyxDQUFDLENBQUM7QUFDNUksQ0FBQztBQUVEO0lBR0kscUJBQVksTUFBYztRQUN0QixJQUFJLE9BQU8sQ0FBQyxNQUFNLENBQUMsS0FBSyxRQUFRLEVBQUU7WUFDOUIsTUFBTSxJQUFJLEtBQUssQ0FBQyxnRUFBZ0UsR0FBRyxPQUFPLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQztTQUN2RztRQUNELElBQUksQ0FBQyxNQUFNLEdBQUcsTUFBTSxDQUFDO1FBQ3JCLElBQUksQ0FBQyxNQUFNLEdBQUcsRUFBRSxDQUFDO0lBQ3JCLENBQUM7SUFFRCxnQ0FBVSxHQUFWLFVBQVcsUUFBZ0I7UUFDdkIsSUFBSSxLQUFLLEdBQUcsSUFBSSxLQUFLLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxRQUFRLENBQUMsRUFBRSxRQUFRLENBQUMsQ0FBQztRQUN2RCxLQUFLLENBQUMsTUFBTSxHQUFHLElBQUksQ0FBQztRQUNwQixJQUFJLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsQ0FBQztRQUN4QixPQUFPLEtBQUssQ0FBQztJQUNqQixDQUFDO0lBQ0wsa0JBQUM7QUFBRCxDQUFDLEFBakJELElBaUJDO0FBRUQsd0JBQXdCO0FBQ3hCLE1BQU0sQ0FBQyxJQUFJLFlBQVksR0FBRyxVQUFVLE1BQWM7SUFDOUMsT0FBTyxJQUFJLFdBQVcsQ0FBQyxNQUFNLENBQWlCLENBQUM7QUFDbkQsQ0FBQyxDQUFDO0FBR0Ysa0ZBQWtGO0FBQ2pGLElBQVksQ0FBQyxLQUFLLEdBQUcsS0FBSyxDQUFDO0FBQzNCLElBQVksQ0FBQyxXQUFXLEdBQUcsV0FBVyxDQUFDO0FBQ3ZDLElBQVksQ0FBQyxZQUFZLEdBQUcsWUFBWSxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgQnJlZXplRW51bSB9IGZyb20gJy4vZW51bSc7XHJcbmltcG9ydCB7IGNvcmUgIH0gZnJvbSAnLi9jb3JlJztcclxuXHJcbi8qKiBAaGlkZGVuIEBpbnRlcm5hbCAqL1xyXG5leHBvcnQgaW50ZXJmYWNlIElQYXJhbUNvbnRleHQge1xyXG4gICAgdHlwZU5hbWU/OiBzdHJpbmc7XHJcbiAgICB0eXBlPzogRnVuY3Rpb247XHJcbiAgICBwcmV2Q29udGV4dD86IElQYXJhbUNvbnRleHQ7XHJcbiAgICBtc2c/OiBzdHJpbmcgfCAoKGNvbnRleHQ6IElQYXJhbUNvbnRleHQsIHY6IGFueSkgPT4gc3RyaW5nKTtcclxuICAgIG11c3ROb3RCZUVtcHR5PzogYm9vbGVhbjtcclxuICAgIGVudW1UeXBlPzogQnJlZXplRW51bTtcclxuICAgIHByb3BlcnR5TmFtZT86IHN0cmluZztcclxuICAgIGFsbG93TnVsbD86IGJvb2xlYW47XHJcbiAgICBmbj8oY29udGV4dDogSVBhcmFtQ29udGV4dCwgdjogYW55KTogYm9vbGVhbjtcclxufVxyXG5cclxuLyoqIEBoaWRkZW4gQGludGVybmFsICovXHJcbmV4cG9ydCBpbnRlcmZhY2UgSUNvbmZpZ1BhcmFtIHtcclxuICAgIGNvbmZpZzogYW55O1xyXG4gICAgcGFyYW1zOiBQYXJhbVtdO1xyXG4gICAgd2hlcmVQYXJhbTogKHByb3BOYW1lOiBzdHJpbmcpID0+IFBhcmFtO1xyXG59XHJcblxyXG4vKiogQGhpZGRlbiBAaW50ZXJuYWwgKi9cclxuZXhwb3J0IGNsYXNzIFBhcmFtIHtcclxuICAgIC8vIFRoZSAlMSBwYXJhbWV0ZXJcclxuICAgIC8vIGlzIHJlcXVpcmVkXHJcbiAgICAvLyBtdXN0IGJlIGEgJTJcclxuICAgIC8vIG11c3QgYmUgYW4gaW5zdGFuY2Ugb2YgJTJcclxuICAgIC8vIG11c3QgYmUgYW4gaW5zdGFuY2Ugb2YgdGhlICUyIGVudW1lcmF0aW9uXHJcbiAgICAvLyBtdXN0IGhhdmUgYSAlMiBwcm9wZXJ0eVxyXG4gICAgLy8gbXVzdCBiZSBhbiBhcnJheSB3aGVyZSBlYWNoIGVsZW1lbnRcclxuICAgIC8vIGlzIG9wdGlvbmFsIG9yXHJcblxyXG4gICAgdjogYW55O1xyXG4gICAgbmFtZTogc3RyaW5nO1xyXG4gICAgZGVmYXVsdFZhbHVlOiBhbnk7XHJcbiAgICBwYXJlbnQ6IElDb25maWdQYXJhbTtcclxuICAgIC8qKiBAaGlkZGVuIEBpbnRlcm5hbCAqL1xyXG4gICAgX2NvbnRleHQ6IElQYXJhbUNvbnRleHQ7XHJcbiAgICAvKiogQGhpZGRlbiBAaW50ZXJuYWwgKi9cclxuICAgIF9jb250ZXh0czogSVBhcmFtQ29udGV4dFtdO1xyXG5cclxuICAgIGNvbnN0cnVjdG9yKHY6IGFueSwgbmFtZTogc3RyaW5nKSB7XHJcbiAgICAgICAgdGhpcy52ID0gdjtcclxuICAgICAgICB0aGlzLm5hbWUgPSBuYW1lO1xyXG4gICAgICAgIHRoaXMuX2NvbnRleHRzID0gWzxhbnk+bnVsbF07XHJcbiAgICB9XHJcblxyXG4gICAgaXNPYmplY3QoKTogUGFyYW0ge1xyXG4gICAgICAgIHJldHVybiB0aGlzLmlzVHlwZU9mKCdvYmplY3QnKTtcclxuICAgIH1cclxuXHJcbiAgICBpc0Jvb2xlYW4oKTogUGFyYW0ge1xyXG4gICAgICAgIHJldHVybiB0aGlzLmlzVHlwZU9mKCdib29sZWFuJyk7XHJcbiAgICB9XHJcblxyXG4gICAgaXNTdHJpbmcoKTogUGFyYW0ge1xyXG4gICAgICAgIHJldHVybiB0aGlzLmlzVHlwZU9mKCdzdHJpbmcnKTtcclxuICAgIH1cclxuXHJcbiAgICBpc051bWJlcigpOiBQYXJhbSB7XHJcbiAgICAgICAgcmV0dXJuIHRoaXMuaXNUeXBlT2YoJ251bWJlcicpO1xyXG4gICAgfVxyXG5cclxuICAgIGlzRnVuY3Rpb24oKTogUGFyYW0ge1xyXG4gICAgICAgIHJldHVybiB0aGlzLmlzVHlwZU9mKCdmdW5jdGlvbicpO1xyXG4gICAgfVxyXG5cclxuICAgIGlzTm9uRW1wdHlTdHJpbmcoKTogUGFyYW0ge1xyXG4gICAgICAgIHJldHVybiBhZGRDb250ZXh0KHRoaXMsIHtcclxuICAgICAgICAgICAgZm46IGlzTm9uRW1wdHlTdHJpbmcsXHJcbiAgICAgICAgICAgIG1zZzogXCJtdXN0IGJlIGEgbm9uRW1wdHkgc3RyaW5nXCJcclxuICAgICAgICB9KTtcclxuICAgIH1cclxuXHJcblxyXG4gICAgaXNUeXBlT2YodHlwZU5hbWU6IHN0cmluZyk6IFBhcmFtIHtcclxuICAgICAgICByZXR1cm4gYWRkQ29udGV4dCh0aGlzLCB7XHJcbiAgICAgICAgICAgIGZuOiBpc1R5cGVPZixcclxuICAgICAgICAgICAgdHlwZU5hbWU6IHR5cGVOYW1lLFxyXG4gICAgICAgICAgICBtc2c6IFwibXVzdCBiZSBhICdcIiArIHR5cGVOYW1lICsgXCInXCJcclxuICAgICAgICB9KTtcclxuICAgIH1cclxuXHJcblxyXG4gICAgaXNJbnN0YW5jZU9mKHR5cGU6IEZ1bmN0aW9uLCB0eXBlTmFtZT86IHN0cmluZyk6IFBhcmFtIHtcclxuICAgICAgICB0eXBlTmFtZSA9IHR5cGVOYW1lIHx8IHR5cGUucHJvdG90eXBlLl8kdHlwZU5hbWU7XHJcbiAgICAgICAgcmV0dXJuIGFkZENvbnRleHQodGhpcywge1xyXG4gICAgICAgICAgICBmbjogaXNJbnN0YW5jZU9mLFxyXG4gICAgICAgICAgICB0eXBlOiB0eXBlLFxyXG4gICAgICAgICAgICB0eXBlTmFtZTogdHlwZU5hbWUsXHJcbiAgICAgICAgICAgIG1zZzogXCJtdXN0IGJlIGFuIGluc3RhbmNlIG9mICdcIiArIHR5cGVOYW1lICsgXCInXCJcclxuICAgICAgICB9KTtcclxuICAgIH1cclxuXHJcblxyXG4gICAgaGFzUHJvcGVydHkocHJvcGVydHlOYW1lOiBzdHJpbmcpOiBQYXJhbSB7XHJcbiAgICAgICAgcmV0dXJuIGFkZENvbnRleHQodGhpcywge1xyXG4gICAgICAgICAgICBmbjogaGFzUHJvcGVydHksXHJcbiAgICAgICAgICAgIHByb3BlcnR5TmFtZTogcHJvcGVydHlOYW1lLFxyXG4gICAgICAgICAgICBtc2c6IFwibXVzdCBoYXZlIGEgJ1wiICsgcHJvcGVydHlOYW1lICsgXCInIHByb3BlcnR5XCJcclxuICAgICAgICB9KTtcclxuICAgIH1cclxuXHJcblxyXG4gICAgaXNFbnVtT2YoZW51bVR5cGU6IGFueSk6IFBhcmFtIHtcclxuICAgICAgICByZXR1cm4gYWRkQ29udGV4dCh0aGlzLCB7XHJcbiAgICAgICAgICAgIGZuOiBpc0VudW1PZixcclxuICAgICAgICAgICAgZW51bVR5cGU6IGVudW1UeXBlLFxyXG4gICAgICAgICAgICBtc2c6IFwibXVzdCBiZSBhbiBpbnN0YW5jZSBvZiB0aGUgJ1wiICsgKGVudW1UeXBlLm5hbWUgfHwgJ3Vua25vd24nKSArIFwiJyBlbnVtZXJhdGlvblwiXHJcbiAgICAgICAgfSk7XHJcbiAgICB9XHJcblxyXG4gICAgaXNSZXF1aXJlZChhbGxvd051bGw6IGJvb2xlYW4gPSBmYWxzZSk6IFBhcmFtIHtcclxuICAgICAgICByZXR1cm4gYWRkQ29udGV4dCh0aGlzLCB7XHJcbiAgICAgICAgICAgIGZuOiBpc1JlcXVpcmVkLFxyXG4gICAgICAgICAgICBhbGxvd051bGw6IGFsbG93TnVsbCxcclxuICAgICAgICAgICAgbXNnOiBcImlzIHJlcXVpcmVkXCJcclxuICAgICAgICB9KTtcclxuICAgIH1cclxuXHJcbiAgICBpc09wdGlvbmFsKCk6IFBhcmFtIHtcclxuICAgICAgICBsZXQgY29udGV4dCA9IHtcclxuICAgICAgICAgICAgZm46IGlzT3B0aW9uYWwsXHJcbiAgICAgICAgICAgIHByZXZDb250ZXh0OiA8YW55Pm51bGwsXHJcbiAgICAgICAgICAgIG1zZzogaXNPcHRpb25hbE1lc3NhZ2VcclxuICAgICAgICB9O1xyXG4gICAgICAgIHJldHVybiBhZGRDb250ZXh0KHRoaXMsIGNvbnRleHQpO1xyXG4gICAgfVxyXG5cclxuICAgIGlzTm9uRW1wdHlBcnJheSgpOiBQYXJhbSB7XHJcbiAgICAgICAgcmV0dXJuIHRoaXMuaXNBcnJheSh0cnVlKTtcclxuICAgIH1cclxuXHJcbiAgICBpc0FycmF5KG11c3ROb3RCZUVtcHR5PzogYm9vbGVhbik6IFBhcmFtIHtcclxuICAgICAgICBsZXQgY29udGV4dCA9IHtcclxuICAgICAgICAgICAgZm46IGlzQXJyYXksXHJcbiAgICAgICAgICAgIG11c3ROb3RCZUVtcHR5OiBtdXN0Tm90QmVFbXB0eSxcclxuICAgICAgICAgICAgcHJldkNvbnRleHQ6IDxhbnk+bnVsbCxcclxuICAgICAgICAgICAgbXNnOiBpc0FycmF5TWVzc2FnZVxyXG4gICAgICAgIH07XHJcbiAgICAgICAgcmV0dXJuIGFkZENvbnRleHQodGhpcywgY29udGV4dCk7XHJcbiAgICB9XHJcblxyXG4gICAgb3IoKSB7XHJcbiAgICAgICAgdGhpcy5fY29udGV4dHMucHVzaCg8YW55Pm51bGwpO1xyXG4gICAgICAgIHRoaXMuX2NvbnRleHQgPSA8YW55Pm51bGw7XHJcbiAgICAgICAgcmV0dXJuIHRoaXM7XHJcbiAgICB9XHJcblxyXG4gICAgY2hlY2soZGVmYXVsdFZhbHVlPzogYW55KSB7XHJcbiAgICAgICAgbGV0IG9rID0gZXhlYyh0aGlzKTtcclxuICAgICAgICBpZiAob2sgPT09IHVuZGVmaW5lZCkgcmV0dXJuO1xyXG4gICAgICAgIGlmICghb2spIHtcclxuICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKHRoaXMuZ2V0TWVzc2FnZSgpKTtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGlmICh0aGlzLnYgIT09IHVuZGVmaW5lZCkge1xyXG4gICAgICAgICAgICByZXR1cm4gdGhpcy52O1xyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgIHJldHVybiBkZWZhdWx0VmFsdWU7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIC8qKiBAaGlkZGVuIEBpbnRlcm5hbCAqL1xyXG4gICAgLy8gY2FsbGVkIGZyb20gb3V0c2lkZSB0aGlzIGZpbGUuXHJcbiAgICBfYWRkQ29udGV4dChjb250ZXh0OiBJUGFyYW1Db250ZXh0KSB7XHJcbiAgICAgICAgcmV0dXJuIGFkZENvbnRleHQodGhpcywgY29udGV4dCk7XHJcbiAgICB9XHJcblxyXG4gICAgZ2V0TWVzc2FnZSgpIHtcclxuICAgICAgICBsZXQgdGhhdCA9IHRoaXM7XHJcbiAgICAgICAgbGV0IG1lc3NhZ2UgPSB0aGlzLl9jb250ZXh0cy5tYXAoZnVuY3Rpb24gKGNvbnRleHQpIHtcclxuICAgICAgICAgICAgcmV0dXJuIGdldE1lc3NhZ2UoY29udGV4dCwgdGhhdC52KTtcclxuICAgICAgICB9KS5qb2luKFwiLCBvciBpdCBcIik7XHJcbiAgICAgICAgcmV0dXJuIGNvcmUuZm9ybWF0U3RyaW5nKHRoaXMuTUVTU0FHRV9QUkVGSVgsIHRoaXMubmFtZSkgKyBcIiBcIiArIG1lc3NhZ2U7XHJcbiAgICB9XHJcblxyXG4gICAgd2l0aERlZmF1bHQoZGVmYXVsdFZhbHVlOiBhbnkpIHtcclxuICAgICAgICB0aGlzLmRlZmF1bHRWYWx1ZSA9IGRlZmF1bHRWYWx1ZTtcclxuICAgICAgICByZXR1cm4gdGhpcztcclxuICAgIH1cclxuXHJcbiAgICB3aGVyZVBhcmFtKHByb3BOYW1lOiBzdHJpbmcpIHtcclxuICAgICAgICByZXR1cm4gdGhpcy5wYXJlbnQud2hlcmVQYXJhbShwcm9wTmFtZSk7XHJcbiAgICB9XHJcblxyXG4gICAgYXBwbHlBbGwoaW5zdGFuY2U6IGFueSwgY2hlY2tPbmx5OiBib29sZWFuID0gZmFsc2UpIHtcclxuICAgICAgICBsZXQgcGFyZW50VHlwZU5hbWUgPSBpbnN0YW5jZS5fJHR5cGVOYW1lO1xyXG4gICAgICAgIGxldCBhbGxvd1Vua25vd25Qcm9wZXJ0eSA9IChwYXJlbnRUeXBlTmFtZSAmJiB0aGlzLnBhcmVudC5jb25maWcuXyR0eXBlTmFtZSA9PT0gcGFyZW50VHlwZU5hbWUpO1xyXG5cclxuICAgICAgICBsZXQgY2xvbmUgPSBjb3JlLmV4dGVuZCh7fSwgdGhpcy5wYXJlbnQuY29uZmlnKTtcclxuICAgICAgICB0aGlzLnBhcmVudC5wYXJhbXMuZm9yRWFjaChmdW5jdGlvbiAocCkge1xyXG4gICAgICAgICAgICBpZiAoIWFsbG93VW5rbm93blByb3BlcnR5KSBkZWxldGUgY2xvbmVbcC5uYW1lXTtcclxuICAgICAgICAgICAgdHJ5IHtcclxuICAgICAgICAgICAgICAgIHAuY2hlY2soKTtcclxuICAgICAgICAgICAgfSBjYXRjaCAoZSkge1xyXG4gICAgICAgICAgICAgICAgdGhyb3dDb25maWdFcnJvcihpbnN0YW5jZSwgZS5tZXNzYWdlKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAoIWNoZWNrT25seSkgJiYgcC5fYXBwbHlPbmUoaW5zdGFuY2UpO1xyXG4gICAgICAgIH0pO1xyXG4gICAgICAgIC8vIHNob3VsZCBiZSBubyBwcm9wZXJ0aWVzIGxlZnQgaW4gdGhlIGNsb25lXHJcbiAgICAgICAgaWYgKCFhbGxvd1Vua25vd25Qcm9wZXJ0eSkge1xyXG4gICAgICAgICAgICBmb3IgKGxldCBrZXkgaW4gY2xvbmUpIHtcclxuICAgICAgICAgICAgICAgIC8vIGFsbG93IHByb3BzIHdpdGggYW4gdW5kZWZpbmVkIHZhbHVlXHJcbiAgICAgICAgICAgICAgICBpZiAoY2xvbmVba2V5XSAhPT0gdW5kZWZpbmVkKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgdGhyb3dDb25maWdFcnJvcihpbnN0YW5jZSwgY29yZS5mb3JtYXRTdHJpbmcoXCJVbmtub3duIHByb3BlcnR5OiAnJTEnLlwiLCBrZXkpKTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICAvKiogQGhpZGRlbiBAaW50ZXJuYWwgKi9cclxuICAgIF9hcHBseU9uZSA9IGZ1bmN0aW9uICh0aGlzOiBQYXJhbSwgaW5zdGFuY2U6IGFueSkge1xyXG4gICAgICAgIGlmICh0aGlzLnYgIT09IHVuZGVmaW5lZCkge1xyXG4gICAgICAgICAgICBpbnN0YW5jZVt0aGlzLm5hbWVdID0gdGhpcy52O1xyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgIGlmICh0aGlzLmRlZmF1bHRWYWx1ZSAhPT0gdW5kZWZpbmVkKSB7XHJcbiAgICAgICAgICAgICAgICBpbnN0YW5jZVt0aGlzLm5hbWVdID0gdGhpcy5kZWZhdWx0VmFsdWU7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICB9O1xyXG5cclxuICAgIE1FU1NBR0VfUFJFRklYID0gXCJUaGUgJyUxJyBwYXJhbWV0ZXIgXCI7XHJcblxyXG59XHJcblxyXG4vKiogQGhpZGRlbiBAaW50ZXJuYWwgKi9cclxuZXhwb3J0IGxldCBhc3NlcnRQYXJhbSA9IGZ1bmN0aW9uICh2OiBhbnksIG5hbWU6IHN0cmluZykge1xyXG4gICAgcmV0dXJuIG5ldyBQYXJhbSh2LCBuYW1lKTtcclxufTtcclxuXHJcbmZ1bmN0aW9uIGlzVHlwZU9mKGNvbnRleHQ6IElQYXJhbUNvbnRleHQsIHY6IGFueSkge1xyXG4gICAgaWYgKHYgPT0gbnVsbCkgcmV0dXJuIGZhbHNlO1xyXG4gICAgaWYgKHR5cGVvZiAodikgPT09IGNvbnRleHQudHlwZU5hbWUpIHJldHVybiB0cnVlO1xyXG4gICAgcmV0dXJuIGZhbHNlO1xyXG59XHJcblxyXG5mdW5jdGlvbiBpc05vbkVtcHR5U3RyaW5nKGNvbnRleHQ6IElQYXJhbUNvbnRleHQsIHY6IGFueSkge1xyXG4gICAgaWYgKHYgPT0gbnVsbCkgcmV0dXJuIGZhbHNlO1xyXG4gICAgcmV0dXJuICh0eXBlb2YgKHYpID09PSAnc3RyaW5nJykgJiYgdi5sZW5ndGggPiAwO1xyXG59XHJcblxyXG5mdW5jdGlvbiBpc0luc3RhbmNlT2YoY29udGV4dDogSVBhcmFtQ29udGV4dCwgdjogYW55KSB7XHJcbiAgICBpZiAodiA9PSBudWxsIHx8IGNvbnRleHQudHlwZSA9PSBudWxsKSByZXR1cm4gZmFsc2U7XHJcbiAgICByZXR1cm4gKHYgaW5zdGFuY2VvZiBjb250ZXh0LnR5cGUpO1xyXG59XHJcblxyXG5mdW5jdGlvbiBpc0VudW1PZihjb250ZXh0OiBJUGFyYW1Db250ZXh0LCB2OiBhbnkpIHtcclxuICAgIGlmICh2ID09IG51bGwgfHwgY29udGV4dC5lbnVtVHlwZSA9PSBudWxsICkgcmV0dXJuIGZhbHNlO1xyXG4gICAgcmV0dXJuIChjb250ZXh0LmVudW1UeXBlIGFzIGFueSkuY29udGFpbnModik7XHJcbn1cclxuXHJcbmZ1bmN0aW9uIGhhc1Byb3BlcnR5KGNvbnRleHQ6IElQYXJhbUNvbnRleHQsIHY6IGFueSkge1xyXG4gICAgaWYgKHYgPT0gbnVsbCB8fCBjb250ZXh0LnByb3BlcnR5TmFtZSA9PSBudWxsKSByZXR1cm4gZmFsc2U7XHJcbiAgICByZXR1cm4gKHZbY29udGV4dC5wcm9wZXJ0eU5hbWVdICE9PSB1bmRlZmluZWQpO1xyXG59XHJcblxyXG5mdW5jdGlvbiBpc1JlcXVpcmVkKGNvbnRleHQ6IElQYXJhbUNvbnRleHQsIHY6IGFueSkge1xyXG4gICAgaWYgKGNvbnRleHQuYWxsb3dOdWxsKSB7XHJcbiAgICAgICAgcmV0dXJuIHYgIT09IHVuZGVmaW5lZDtcclxuICAgIH0gZWxzZSB7XHJcbiAgICAgICAgcmV0dXJuIHYgIT0gbnVsbDtcclxuICAgIH1cclxufVxyXG5cclxuZnVuY3Rpb24gaXNPcHRpb25hbChjb250ZXh0OiBJUGFyYW1Db250ZXh0LCB2OiBhbnkpIHtcclxuICAgIGlmICh2ID09IG51bGwpIHJldHVybiB0cnVlO1xyXG4gICAgbGV0IHByZXZDb250ZXh0ID0gY29udGV4dC5wcmV2Q29udGV4dDtcclxuICAgIGlmIChwcmV2Q29udGV4dCAmJiBwcmV2Q29udGV4dC5mbikge1xyXG4gICAgICAgIHJldHVybiBwcmV2Q29udGV4dC5mbihwcmV2Q29udGV4dCwgdik7XHJcbiAgICB9IGVsc2Uge1xyXG4gICAgICAgIHJldHVybiB0cnVlO1xyXG4gICAgfVxyXG59XHJcblxyXG5mdW5jdGlvbiBpc09wdGlvbmFsTWVzc2FnZShjb250ZXh0OiBJUGFyYW1Db250ZXh0LCB2OiBhbnkpIHtcclxuICAgIGxldCBwcmV2Q29udGV4dCA9IGNvbnRleHQucHJldkNvbnRleHQ7XHJcbiAgICBsZXQgZWxlbWVudCA9IHByZXZDb250ZXh0ID8gXCIgb3IgaXQgXCIgKyBnZXRNZXNzYWdlKHByZXZDb250ZXh0LCB2KSA6IFwiXCI7XHJcbiAgICByZXR1cm4gXCJpcyBvcHRpb25hbFwiICsgZWxlbWVudDtcclxufVxyXG5cclxuZnVuY3Rpb24gaXNBcnJheShjb250ZXh0OiBJUGFyYW1Db250ZXh0LCB2OiBhbnkpIHtcclxuICAgIGlmICghQXJyYXkuaXNBcnJheSh2KSkge1xyXG4gICAgICAgIHJldHVybiBmYWxzZTtcclxuICAgIH1cclxuICAgIGlmIChjb250ZXh0Lm11c3ROb3RCZUVtcHR5KSB7XHJcbiAgICAgICAgaWYgKHYubGVuZ3RoID09PSAwKSByZXR1cm4gZmFsc2U7XHJcbiAgICB9XHJcbiAgICAvLyBhbGxvdyBzdGFuZGFsb25lIGlzIGFycmF5IGNhbGwuXHJcbiAgICBsZXQgcHJldkNvbnRleHQgPSBjb250ZXh0LnByZXZDb250ZXh0O1xyXG4gICAgaWYgKCFwcmV2Q29udGV4dCkgcmV0dXJuIHRydWU7XHJcblxyXG4gICAgbGV0IHBjID0gPGFueT5wcmV2Q29udGV4dDtcclxuICAgIHJldHVybiB2LmV2ZXJ5KGZ1bmN0aW9uICh2MTogYW55KSB7XHJcbiAgICAgICAgcmV0dXJuIHBjLmZuICYmIHBjLmZuKHBjLCB2MSk7XHJcbiAgICB9KTtcclxufVxyXG5cclxuZnVuY3Rpb24gaXNBcnJheU1lc3NhZ2UoY29udGV4dDogSVBhcmFtQ29udGV4dCwgdjogYW55KSB7XHJcbiAgICBsZXQgYXJyYXlEZXNjciA9IGNvbnRleHQubXVzdE5vdEJlRW1wdHkgPyBcImEgbm9uRW1wdHkgYXJyYXlcIiA6IFwiYW4gYXJyYXlcIjtcclxuICAgIGxldCBwcmV2Q29udGV4dCA9IGNvbnRleHQucHJldkNvbnRleHQ7XHJcbiAgICBsZXQgZWxlbWVudCA9IHByZXZDb250ZXh0ID8gXCIgd2hlcmUgZWFjaCBlbGVtZW50IFwiICsgZ2V0TWVzc2FnZShwcmV2Q29udGV4dCwgdikgOiBcIlwiO1xyXG4gICAgcmV0dXJuIFwiIG11c3QgYmUgXCIgKyBhcnJheURlc2NyICsgZWxlbWVudDtcclxufVxyXG5cclxuZnVuY3Rpb24gZ2V0TWVzc2FnZShjb250ZXh0OiBJUGFyYW1Db250ZXh0LCB2OiBhbnkpIHtcclxuICAgIGxldCBtc2cgPSBjb250ZXh0Lm1zZztcclxuICAgIGlmICh0eXBlb2YgKG1zZykgPT09IFwiZnVuY3Rpb25cIikge1xyXG4gICAgICAgIG1zZyA9ICg8YW55Pm1zZykoY29udGV4dCwgdik7XHJcbiAgICB9XHJcbiAgICByZXR1cm4gbXNnO1xyXG59XHJcblxyXG5mdW5jdGlvbiBhZGRDb250ZXh0KHRoYXQ6IFBhcmFtLCBjb250ZXh0OiBJUGFyYW1Db250ZXh0KSB7XHJcbiAgICBpZiAodGhhdC5fY29udGV4dCkge1xyXG4gICAgICAgIGxldCBjdXJDb250ZXh0ID0gdGhhdC5fY29udGV4dDtcclxuXHJcbiAgICAgICAgd2hpbGUgKGN1ckNvbnRleHQucHJldkNvbnRleHQgIT0gbnVsbCkge1xyXG4gICAgICAgICAgICBjdXJDb250ZXh0ID0gY3VyQ29udGV4dC5wcmV2Q29udGV4dDtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGlmIChjdXJDb250ZXh0LnByZXZDb250ZXh0ID09PSBudWxsKSB7XHJcbiAgICAgICAgICAgIGN1ckNvbnRleHQucHJldkNvbnRleHQgPSBjb250ZXh0O1xyXG4gICAgICAgICAgICAvLyBqdXN0IHVwZGF0ZSB0aGUgcHJldkNvbnRleHQgYnV0IGRvbid0IGNoYW5nZSB0aGUgY3VyQ29udGV4dC5cclxuICAgICAgICAgICAgcmV0dXJuIHRoYXQ7XHJcbiAgICAgICAgfSBlbHNlIGlmIChjb250ZXh0LnByZXZDb250ZXh0ID09IG51bGwpIHtcclxuICAgICAgICAgICAgY29udGV4dC5wcmV2Q29udGV4dCA9IHRoYXQuX2NvbnRleHQ7XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKFwiSWxsZWdhbCBjb25zdHJ1Y3Rpb24gLSB1c2UgJ29yJyB0byBjb21iaW5lIGNoZWNrc1wiKTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcbiAgICByZXR1cm4gc2V0Q29udGV4dCh0aGF0LCBjb250ZXh0KTtcclxufVxyXG5cclxuZnVuY3Rpb24gc2V0Q29udGV4dCh0aGF0OiBQYXJhbSwgY29udGV4dDogSVBhcmFtQ29udGV4dCkge1xyXG4gICAgdGhhdC5fY29udGV4dHNbdGhhdC5fY29udGV4dHMubGVuZ3RoIC0gMV0gPSBjb250ZXh0O1xyXG4gICAgdGhhdC5fY29udGV4dCA9IGNvbnRleHQ7XHJcbiAgICByZXR1cm4gdGhhdDtcclxufVxyXG5cclxuXHJcbmZ1bmN0aW9uIGV4ZWMoc2VsZjogUGFyYW0pIHtcclxuICAgIC8vIGNsZWFyIG9mZiBsYXN0IG9uZSBpZiBudWxsXHJcbiAgICBsZXQgY29udGV4dHMgPSBzZWxmLl9jb250ZXh0cztcclxuICAgIGlmIChjb250ZXh0c1tjb250ZXh0cy5sZW5ndGggLSAxXSA9PSBudWxsKSB7XHJcbiAgICAgICAgY29udGV4dHMucG9wKCk7XHJcbiAgICB9XHJcbiAgICBpZiAoY29udGV4dHMubGVuZ3RoID09PSAwKSB7XHJcbiAgICAgICAgcmV0dXJuIHVuZGVmaW5lZDtcclxuICAgIH1cclxuICAgIHJldHVybiBjb250ZXh0cy5zb21lKGZ1bmN0aW9uIChjb250ZXh0OiBJUGFyYW1Db250ZXh0KSB7XHJcbiAgICAgICAgcmV0dXJuIGNvbnRleHQuZm4gPyBjb250ZXh0LmZuKGNvbnRleHQsIHNlbGYudikgOiBmYWxzZTtcclxuICAgIH0pO1xyXG59XHJcblxyXG5mdW5jdGlvbiB0aHJvd0NvbmZpZ0Vycm9yKGluc3RhbmNlOiBhbnksIG1lc3NhZ2U6IHN0cmluZykge1xyXG4gICAgdGhyb3cgbmV3IEVycm9yKGNvcmUuZm9ybWF0U3RyaW5nKFwiRXJyb3IgY29uZmlndXJpbmcgYW4gaW5zdGFuY2Ugb2YgJyUxJy4gJTJcIiwgKGluc3RhbmNlICYmIGluc3RhbmNlLl8kdHlwZU5hbWUpIHx8IFwib2JqZWN0XCIsIG1lc3NhZ2UpKTtcclxufVxyXG5cclxuY2xhc3MgQ29uZmlnUGFyYW0ge1xyXG4gICAgY29uZmlnOiBhbnk7XHJcbiAgICBwYXJhbXM6IFBhcmFtW107XHJcbiAgICBjb25zdHJ1Y3Rvcihjb25maWc6IE9iamVjdCkge1xyXG4gICAgICAgIGlmICh0eXBlb2YgKGNvbmZpZykgIT09IFwib2JqZWN0XCIpIHtcclxuICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKFwiQ29uZmlndXJhdGlvbiBwYXJhbWV0ZXIgc2hvdWxkIGJlIGFuIG9iamVjdCwgaW5zdGVhZCBpdCBpcyBhOiBcIiArIHR5cGVvZiAoY29uZmlnKSk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHRoaXMuY29uZmlnID0gY29uZmlnO1xyXG4gICAgICAgIHRoaXMucGFyYW1zID0gW107XHJcbiAgICB9XHJcblxyXG4gICAgd2hlcmVQYXJhbShwcm9wTmFtZTogc3RyaW5nKSB7XHJcbiAgICAgICAgbGV0IHBhcmFtID0gbmV3IFBhcmFtKHRoaXMuY29uZmlnW3Byb3BOYW1lXSwgcHJvcE5hbWUpO1xyXG4gICAgICAgIHBhcmFtLnBhcmVudCA9IHRoaXM7XHJcbiAgICAgICAgdGhpcy5wYXJhbXMucHVzaChwYXJhbSk7XHJcbiAgICAgICAgcmV0dXJuIHBhcmFtO1xyXG4gICAgfVxyXG59XHJcblxyXG4vKiogQGhpZGRlbiBAaW50ZXJuYWwgKi9cclxuZXhwb3J0IGxldCBhc3NlcnRDb25maWcgPSBmdW5jdGlvbiAoY29uZmlnOiBPYmplY3QpIHtcclxuICAgIHJldHVybiBuZXcgQ29uZmlnUGFyYW0oY29uZmlnKSBhcyBJQ29uZmlnUGFyYW07XHJcbn07XHJcblxyXG5cclxuLy8gUGFyYW0gaXMgZXhwb3NlZCBzbyB0aGF0IGFkZGl0aW9uYWwgJ2lzJyBtZXRob2RzIGNhbiBiZSBhZGRlZCB0byB0aGUgcHJvdG90eXBlLlxyXG4oY29yZSBhcyBhbnkpLlBhcmFtID0gUGFyYW07XHJcbihjb3JlIGFzIGFueSkuYXNzZXJ0UGFyYW0gPSBhc3NlcnRQYXJhbTtcclxuKGNvcmUgYXMgYW55KS5hc3NlcnRDb25maWcgPSBhc3NlcnRDb25maWc7XHJcbiJdfQ==