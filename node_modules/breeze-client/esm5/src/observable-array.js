import { core } from './core';
var ɵ0 = function () {
    var args = [];
    for (var _i = 0; _i < arguments.length; _i++) {
        args[_i] = arguments[_i];
    }
    if (this._inProgress) {
        return -1;
    }
    var goodAdds = this._getGoodAdds(args);
    if (!goodAdds.length) {
        return this.length;
    }
    this._beforeChange();
    var result;
    var objPrototype = Object.getPrototypeOf(this);
    if (objPrototype.push) {
        result = objPrototype.push.apply(this, goodAdds);
    }
    else {
        result = Array.prototype.push.apply(this, goodAdds);
    }
    processAdds(this, goodAdds);
    return result;
}, ɵ1 = function () {
    var args = [];
    for (var _i = 0; _i < arguments.length; _i++) {
        args[_i] = arguments[_i];
    }
    if (this._inProgress) {
        return -1;
    }
    var goodAdds = args;
    this._beforeChange();
    var result;
    var objPrototype = Object.getPrototypeOf(this);
    if (objPrototype.push) {
        result = objPrototype.push.apply(this, goodAdds);
    }
    else {
        result = Array.prototype.push.apply(this, goodAdds);
    }
    processAdds(this, goodAdds);
    return result;
}, ɵ2 = function () {
    var args = [];
    for (var _i = 0; _i < arguments.length; _i++) {
        args[_i] = arguments[_i];
    }
    var goodAdds = this._getGoodAdds(args);
    if (!goodAdds.length) {
        return this.length;
    }
    this._beforeChange();
    var result;
    var objPrototype = Object.getPrototypeOf(this);
    if (objPrototype.unshift) {
        result = objPrototype.unshift.apply(this, goodAdds);
    }
    else {
        result = Array.prototype.unshift.apply(this, goodAdds);
    }
    processAdds(this, goodAdds);
    return result;
}, ɵ3 = function () {
    this._beforeChange();
    var result;
    var objPrototype = Object.getPrototypeOf(this);
    if (objPrototype.pop) {
        result = objPrototype.pop.apply(this);
    }
    else {
        result = Array.prototype.pop.apply(this);
    }
    processRemoves(this, [result]);
    return result;
}, ɵ4 = function () {
    this._beforeChange();
    var result;
    var objPrototype = Object.getPrototypeOf(this);
    if (objPrototype.shift) {
        result = objPrototype.shift.apply(this);
    }
    else {
        result = Array.prototype.shift.apply(this);
    }
    processRemoves(this, [result]);
    return result;
}, ɵ5 = function () {
    var args = [];
    for (var _i = 0; _i < arguments.length; _i++) {
        args[_i] = arguments[_i];
    }
    var goodAdds = this._getGoodAdds(core.arraySlice(args, 2));
    var newArgs = core.arraySlice(args, 0, 2).concat(goodAdds);
    this._beforeChange();
    var result;
    var objPrototype = Object.getPrototypeOf(this);
    if (objPrototype.splice) {
        result = objPrototype.splice.apply(this, newArgs);
    }
    else {
        result = Array.prototype.splice.apply(this, newArgs);
    }
    processRemoves(this, result);
    if (goodAdds.length) {
        processAdds(this, goodAdds);
    }
    return result;
}, ɵ6 = function () {
    return this.parent.entityAspect || this.parent.complexAspect.getEntityAspect();
}, ɵ7 = function () {
    return this.getEntityAspect();
}, ɵ8 = function () {
    var em = this.getEntityAspect().entityManager;
    return em && em._pendingPubs;
}, ɵ9 = function () {
    // default is to do nothing
};
var mixin = {
    push: ɵ0,
    _push: ɵ1,
    unshift: ɵ2,
    pop: ɵ3,
    shift: ɵ4,
    splice: ɵ5,
    getEntityAspect: ɵ6,
    _getEventParent: ɵ7,
    _getPendingPubs: ɵ8,
    _beforeChange: ɵ9
};
function updateEntityState(obsArray) {
    var entityAspect = obsArray.getEntityAspect();
    if (entityAspect.entityState.isUnchanged()) {
        entityAspect.setModified();
    }
    if (entityAspect.entityState.isModified() && !obsArray._origValues) {
        obsArray._origValues = obsArray.slice(0);
    }
}
function publish(publisher, eventName, eventArgs) {
    var pendingPubs = publisher._getPendingPubs();
    if (pendingPubs) {
        if (!publisher._pendingArgs) {
            publisher._pendingArgs = eventArgs;
            pendingPubs.push(function () {
                publisher[eventName].publish(publisher._pendingArgs);
                publisher._pendingArgs = null;
            });
        }
        else {
            combineArgs(publisher._pendingArgs, eventArgs);
        }
    }
    else {
        publisher[eventName].publish(eventArgs);
    }
}
function initializeParent(obsArray, parent, parentProperty) {
    obsArray.parent = parent;
    obsArray.parentProperty = parentProperty;
}
function processAdds(obsArray, adds) {
    obsArray._processAdds(adds);
    // this is referencing the name of the method on the complexArray not the name of the event
    //var args = { added: adds };
    //args[obsArray._typeName] = obsArray;
    publish(obsArray, "arrayChanged", { array: obsArray, added: adds });
}
function processRemoves(obsArray, removes) {
    obsArray._processRemoves(removes);
    // this is referencing the name of the method on the array not the name of the event
    publish(obsArray, "arrayChanged", { array: obsArray, removed: removes });
}
// TODO: see if this function already exists in core and can be imported.
function combineArgs(target, source) {
    for (var key in source) {
        if (key !== "array" && target.hasOwnProperty(key)) {
            var sourceValue = source[key];
            var targetValue = target[key];
            if (targetValue) {
                if (!Array.isArray(targetValue)) {
                    throw new Error("Cannot combine non array args");
                }
                Array.prototype.push.apply(targetValue, sourceValue);
            }
            else {
                target[key] = sourceValue;
            }
        }
    }
}
/** @hidden @internal */
export var observableArray = {
    mixin: mixin,
    updateEntityState: updateEntityState,
    publish: publish,
    initializeParent: initializeParent
};
export { ɵ0, ɵ1, ɵ2, ɵ3, ɵ4, ɵ5, ɵ6, ɵ7, ɵ8, ɵ9 };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoib2JzZXJ2YWJsZS1hcnJheS5qcyIsInNvdXJjZVJvb3QiOiJuZzovL2JyZWV6ZS1jbGllbnQvIiwic291cmNlcyI6WyJzcmMvb2JzZXJ2YWJsZS1hcnJheS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQUUsSUFBSSxFQUFFLE1BQU0sUUFBUSxDQUFDO1NBb0N0QjtJQUFTLGNBQWM7U0FBZCxVQUFjLEVBQWQscUJBQWMsRUFBZCxJQUFjO1FBQWQseUJBQWM7O0lBQzNCLElBQUksSUFBSSxDQUFDLFdBQVcsRUFBRTtRQUNwQixPQUFPLENBQUMsQ0FBQyxDQUFDO0tBQ1g7SUFFRCxJQUFJLFFBQVEsR0FBRyxJQUFJLENBQUMsWUFBWSxDQUFDLElBQUksQ0FBQyxDQUFDO0lBQ3ZDLElBQUksQ0FBQyxRQUFRLENBQUMsTUFBTSxFQUFFO1FBQ3BCLE9BQU8sSUFBSSxDQUFDLE1BQU0sQ0FBQztLQUNwQjtJQUNELElBQUksQ0FBQyxhQUFhLEVBQUUsQ0FBQztJQUNyQixJQUFJLE1BQU0sQ0FBQztJQUNYLElBQUksWUFBWSxHQUFHLE1BQU0sQ0FBQyxjQUFjLENBQUMsSUFBSSxDQUFDLENBQUM7SUFDL0MsSUFBSSxZQUFZLENBQUMsSUFBSSxFQUFFO1FBQ25CLE1BQU0sR0FBRyxZQUFZLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxJQUFJLEVBQUUsUUFBUSxDQUFDLENBQUM7S0FDcEQ7U0FBTTtRQUNILE1BQU0sR0FBRyxLQUFLLENBQUMsU0FBUyxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsSUFBSSxFQUFFLFFBQVEsQ0FBQyxDQUFDO0tBQ3ZEO0lBQ0QsV0FBVyxDQUFDLElBQUksRUFBRSxRQUFRLENBQUMsQ0FBQztJQUM1QixPQUFPLE1BQU0sQ0FBQztBQUNoQixDQUFDLE9BRU07SUFBUyxjQUFjO1NBQWQsVUFBYyxFQUFkLHFCQUFjLEVBQWQsSUFBYztRQUFkLHlCQUFjOztJQUM1QixJQUFJLElBQUksQ0FBQyxXQUFXLEVBQUU7UUFDcEIs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QUFJLFdBQVcsRUFBRTtnQkFDZixJQUFJLENBQUMsS0FBSyxDQUFDLE9BQU8sQ0FBQyxXQUFXLENBQUMsRUFBRTtvQkFDL0IsTUFBTSxJQUFJLEtBQUssQ0FBQywrQkFBK0IsQ0FBQyxDQUFDO2lCQUNsRDtnQkFDRCxLQUFLLENBQUMsU0FBUyxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsV0FBVyxFQUFFLFdBQVcsQ0FBQyxDQUFDO2FBQ3REO2lCQUFNO2dCQUNMLE1BQU0sQ0FBQyxHQUFHLENBQUMsR0FBRyxXQUFXLENBQUM7YUFDM0I7U0FDRjtLQUNGO0FBQ0gsQ0FBQztBQUNELHdCQUF3QjtBQUN4QixNQUFNLENBQUMsSUFBTSxlQUFlLEdBQUc7SUFDN0IsS0FBSyxFQUFFLEtBQUs7SUFDWixpQkFBaUIsRUFBRSxpQkFBaUI7SUFDcEMsT0FBTyxFQUFFLE9BQU87SUFDaEIsZ0JBQWdCLEVBQUUsZ0JBQWdCO0NBQ25DLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBjb3JlIH0gZnJvbSAnLi9jb3JlJztcclxuaW1wb3J0IHsgQnJlZXplRXZlbnQgfSBmcm9tICcuL2V2ZW50JztcclxuaW1wb3J0IHsgRW50aXR5QXNwZWN0IH0gZnJvbSAnLi9lbnRpdHktYXNwZWN0JztcclxuaW1wb3J0IHsgRGF0YVByb3BlcnR5IH0gZnJvbSAnLi9lbnRpdHktbWV0YWRhdGEnO1xyXG5cclxuLyoqIEBoaWRkZW4gKi9cclxuZXhwb3J0IGludGVyZmFjZSBPYnNlcnZhYmxlQXJyYXkge1xyXG4gIHB1c2g6ICguLi5hcmdzOiBhbnlbXSkgPT4gbnVtYmVyO1xyXG4gIF9wdXNoOiAoLi4uYXJnczogYW55W10pID0+IG51bWJlcjtcclxuICB1bnNoaWZ0OiAoLi4uYXJnczogYW55W10pID0+ICBudW1iZXI7XHJcbiAgcG9wOiAoKSA9PiBhbnk7XHJcbiAgc2hpZnQ6ICgpID0+IGFueTtcclxuICBzcGxpY2U6ICguLi5hcmdzOiBhbnlbXSkgPT4gYW55W107XHJcbiAgc2xpY2U6IChhOiBudW1iZXIsIGI/OiBudW1iZXIpID0+IGFueVtdOyAvLyBpbXBsZW1lbnRlZCBvbiB0aGUgbmF0aXZlIGFycmF5XHJcbiAgbGVuZ3RoOiBudW1iZXI7XHJcbiAgXHJcbiAgZ2V0RW50aXR5QXNwZWN0OiAoKSA9PiBFbnRpdHlBc3BlY3Q7XHJcbiAgYXJyYXlDaGFuZ2VkOiBCcmVlemVFdmVudDxBcnJheUNoYW5nZWRBcmdzPjtcclxuICBwYXJlbnQ/OiBPYmplY3Q7XHJcbiAgcGFyZW50UHJvcGVydHk/OiBEYXRhUHJvcGVydHk7XHJcbiAgX2dldEV2ZW50UGFyZW50OiAoKSA9PiBPYmplY3Q7XHJcbiAgX2dldFBlbmRpbmdQdWJzOiAoKSA9PiBhbnlbXTsgLy8gVE9ETzogUHViW11cclxuICBfYmVmb3JlQ2hhbmdlOiAoKSA9PiB2b2lkO1xyXG4gIF9wcm9jZXNzQWRkcyhpdGVtczogYW55W10pOiB2b2lkO1xyXG4gIF9wcm9jZXNzUmVtb3ZlcyhpdGVtczogYW55W10pOiB2b2lkO1xyXG4gIF9vcmlnVmFsdWVzOiBhbnlbXTtcclxuICBfcGVuZGluZ0FyZ3M6IGFueTtcclxufVxyXG5cclxuZXhwb3J0IGludGVyZmFjZSBBcnJheUNoYW5nZWRBcmdzIHtcclxuICBhcnJheTogYW55W107XHJcbiAgYWRkZWQ/OiBhbnlbXTsgXHJcbiAgcmVtb3ZlZD86IGFueVtdO1xyXG59XHJcblxyXG5sZXQgbWl4aW4gPSB7XHJcbiAgcHVzaDogZnVuY3Rpb24oLi4uYXJnczogYW55W10pIHtcclxuICAgIGlmICh0aGlzLl9pblByb2dyZXNzKSB7XHJcbiAgICAgIHJldHVybiAtMTtcclxuICAgIH1cclxuXHJcbiAgICBsZXQgZ29vZEFkZHMgPSB0aGlzLl9nZXRHb29kQWRkcyhhcmdzKTtcclxuICAgIGlmICghZ29vZEFkZHMubGVuZ3RoKSB7XHJcbiAgICAgIHJldHVybiB0aGlzLmxlbmd0aDtcclxuICAgIH1cclxuICAgIHRoaXMuX2JlZm9yZUNoYW5nZSgpO1xyXG4gICAgbGV0IHJlc3VsdDtcclxuICAgIGxldCBvYmpQcm90b3R5cGUgPSBPYmplY3QuZ2V0UHJvdG90eXBlT2YodGhpcyk7XHJcbiAgICBpZiAob2JqUHJvdG90eXBlLnB1c2gpIHtcclxuICAgICAgICByZXN1bHQgPSBvYmpQcm90b3R5cGUucHVzaC5hcHBseSh0aGlzLCBnb29kQWRkcyk7XHJcbiAgICB9IGVsc2Uge1xyXG4gICAgICAgIHJlc3VsdCA9IEFycmF5LnByb3RvdHlwZS5wdXNoLmFwcGx5KHRoaXMsIGdvb2RBZGRzKTtcclxuICAgIH1cclxuICAgIHByb2Nlc3NBZGRzKHRoaXMsIGdvb2RBZGRzKTtcclxuICAgIHJldHVybiByZXN1bHQ7XHJcbiAgfSxcclxuXHJcbiAgX3B1c2g6IGZ1bmN0aW9uKC4uLmFyZ3M6IGFueVtdKSB7XHJcbiAgICBpZiAodGhpcy5faW5Qcm9ncmVzcykge1xyXG4gICAgICByZXR1cm4gLTE7XHJcbiAgICB9XHJcbiAgICBsZXQgZ29vZEFkZHMgPSBhcmdzO1xyXG4gICAgdGhpcy5fYmVmb3JlQ2hhbmdlKCk7XHJcbiAgICBsZXQgcmVzdWx0O1xyXG4gICAgbGV0IG9ialByb3RvdHlwZSA9IE9iamVjdC5nZXRQcm90b3R5cGVPZih0aGlzKTtcclxuICAgIGlmIChvYmpQcm90b3R5cGUucHVzaCkge1xyXG4gICAgICAgIHJlc3VsdCA9IG9ialByb3RvdHlwZS5wdXNoLmFwcGx5KHRoaXMsIGdvb2RBZGRzKTtcclxuICAgIH0gZWxzZSB7XHJcbiAgICAgICAgcmVzdWx0ID0gQXJyYXkucHJvdG90eXBlLnB1c2guYXBwbHkodGhpcywgZ29vZEFkZHMpO1xyXG4gICAgfVxyXG4gICAgcHJvY2Vzc0FkZHModGhpcywgZ29vZEFkZHMpO1xyXG4gICAgcmV0dXJuIHJlc3VsdDtcclxuICB9LFxyXG5cclxuICB1bnNoaWZ0OiBmdW5jdGlvbiguLi5hcmdzOiBhbnlbXSkge1xyXG4gICAgbGV0IGdvb2RBZGRzID0gdGhpcy5fZ2V0R29vZEFkZHMoYXJncyk7XHJcbiAgICBpZiAoIWdvb2RBZGRzLmxlbmd0aCkge1xyXG4gICAgICByZXR1cm4gdGhpcy5sZW5ndGg7XHJcbiAgICB9XHJcbiAgICB0aGlzLl9iZWZvcmVDaGFuZ2UoKTtcclxuICAgIGxldCByZXN1bHQ7XHJcbiAgICBsZXQgb2JqUHJvdG90eXBlID0gT2JqZWN0LmdldFByb3RvdHlwZU9mKHRoaXMpO1xyXG4gICAgaWYgKG9ialByb3RvdHlwZS51bnNoaWZ0KSB7XHJcbiAgICAgICAgcmVzdWx0ID0gb2JqUHJvdG90eXBlLnVuc2hpZnQuYXBwbHkodGhpcywgZ29vZEFkZHMpO1xyXG4gICAgfSBlbHNlIHtcclxuICAgICAgICByZXN1bHQgPSBBcnJheS5wcm90b3R5cGUudW5zaGlmdC5hcHBseSh0aGlzLCBnb29kQWRkcyk7XHJcbiAgICB9XHJcbiAgICBwcm9jZXNzQWRkcyh0aGlzLCBnb29kQWRkcyk7XHJcbiAgICByZXR1cm4gcmVzdWx0O1xyXG4gIH0sXHJcblxyXG4gIHBvcDogZnVuY3Rpb24oKSB7XHJcbiAgICB0aGlzLl9iZWZvcmVDaGFuZ2UoKTtcclxuICAgIGxldCByZXN1bHQ7XHJcbiAgICBsZXQgb2JqUHJvdG90eXBlID0gT2JqZWN0LmdldFByb3RvdHlwZU9mKHRoaXMpO1xyXG4gICAgaWYgKG9ialByb3RvdHlwZS5wb3ApIHtcclxuICAgICAgICByZXN1bHQgPSBvYmpQcm90b3R5cGUucG9wLmFwcGx5KHRoaXMpO1xyXG4gICAgfSBlbHNlIHtcclxuICAgICAgICByZXN1bHQgPSBBcnJheS5wcm90b3R5cGUucG9wLmFwcGx5KHRoaXMpO1xyXG4gICAgfVxyXG4gICAgcHJvY2Vzc1JlbW92ZXModGhpcywgW3Jlc3VsdF0pO1xyXG4gICAgcmV0dXJuIHJlc3VsdDtcclxuICB9LFxyXG5cclxuICBzaGlmdDogZnVuY3Rpb24oKSB7XHJcbiAgICB0aGlzLl9iZWZvcmVDaGFuZ2UoKTtcclxuICAgIGxldCByZXN1bHQ7XHJcbiAgICBsZXQgb2JqUHJvdG90eXBlID0gT2JqZWN0LmdldFByb3RvdHlwZU9mKHRoaXMpO1xyXG4gICAgaWYgKG9ialByb3RvdHlwZS5zaGlmdCkge1xyXG4gICAgICAgIHJlc3VsdCA9IG9ialByb3RvdHlwZS5zaGlmdC5hcHBseSh0aGlzKTtcclxuICAgIH0gZWxzZSB7XHJcbiAgICAgICAgcmVzdWx0ID0gQXJyYXkucHJvdG90eXBlLnNoaWZ0LmFwcGx5KHRoaXMpO1xyXG4gICAgfSAgICBcclxuICAgIHByb2Nlc3NSZW1vdmVzKHRoaXMsIFtyZXN1bHRdKTtcclxuICAgIHJldHVybiByZXN1bHQ7XHJcbiAgfSxcclxuXHJcbiAgc3BsaWNlOiBmdW5jdGlvbiguLi5hcmdzOiBhbnlbXSkge1xyXG4gICAgbGV0IGdvb2RBZGRzID0gdGhpcy5fZ2V0R29vZEFkZHMoY29yZS5hcnJheVNsaWNlKGFyZ3MsIDIpKTtcclxuICAgIGxldCBuZXdBcmdzID0gY29yZS5hcnJheVNsaWNlKGFyZ3MsIDAsIDIpLmNvbmNhdChnb29kQWRkcyk7XHJcbiAgICB0aGlzLl9iZWZvcmVDaGFuZ2UoKTtcclxuICAgIGxldCByZXN1bHQ7XHJcbiAgICBsZXQgb2JqUHJvdG90eXBlID0gT2JqZWN0LmdldFByb3RvdHlwZU9mKHRoaXMpO1xyXG4gICAgaWYgKG9ialByb3RvdHlwZS5zcGxpY2UpIHtcclxuICAgICAgICByZXN1bHQgPSBvYmpQcm90b3R5cGUuc3BsaWNlLmFwcGx5KHRoaXMsIG5ld0FyZ3MpO1xyXG4gICAgfSBlbHNlIHtcclxuICAgICAgICByZXN1bHQgPSBBcnJheS5wcm90b3R5cGUuc3BsaWNlLmFwcGx5KHRoaXMsIG5ld0FyZ3MpO1xyXG4gICAgfVxyXG4gICAgcHJvY2Vzc1JlbW92ZXModGhpcywgcmVzdWx0KTtcclxuXHJcbiAgICBpZiAoZ29vZEFkZHMubGVuZ3RoKSB7XHJcbiAgICAgIHByb2Nlc3NBZGRzKHRoaXMsIGdvb2RBZGRzKTtcclxuICAgIH1cclxuICAgIHJldHVybiByZXN1bHQ7XHJcbiAgfSxcclxuXHJcbiAgZ2V0RW50aXR5QXNwZWN0OiBmdW5jdGlvbigpIHtcclxuICAgIHJldHVybiB0aGlzLnBhcmVudC5lbnRpdHlBc3BlY3QgfHwgdGhpcy5wYXJlbnQuY29tcGxleEFzcGVjdC5nZXRFbnRpdHlBc3BlY3QoKTtcclxuICB9LFxyXG5cclxuICBfZ2V0RXZlbnRQYXJlbnQ6IGZ1bmN0aW9uKCkge1xyXG4gICAgcmV0dXJuIHRoaXMuZ2V0RW50aXR5QXNwZWN0KCk7XHJcbiAgfSxcclxuXHJcbiAgX2dldFBlbmRpbmdQdWJzOiBmdW5jdGlvbiAoKSB7XHJcbiAgICBsZXQgZW0gPSB0aGlzLmdldEVudGl0eUFzcGVjdCgpLmVudGl0eU1hbmFnZXI7XHJcbiAgICByZXR1cm4gZW0gJiYgZW0uX3BlbmRpbmdQdWJzO1xyXG4gIH0sXHJcblxyXG4gIF9iZWZvcmVDaGFuZ2U6ICBmdW5jdGlvbiAoKSB7XHJcbiAgICAvLyBkZWZhdWx0IGlzIHRvIGRvIG5vdGhpbmdcclxuICB9XHJcbn07XHJcblxyXG5mdW5jdGlvbiB1cGRhdGVFbnRpdHlTdGF0ZShvYnNBcnJheTogT2JzZXJ2YWJsZUFycmF5KSB7XHJcbiAgbGV0IGVudGl0eUFzcGVjdCA9IG9ic0FycmF5LmdldEVudGl0eUFzcGVjdCgpO1xyXG4gIGlmIChlbnRpdHlBc3BlY3QuZW50aXR5U3RhdGUuaXNVbmNoYW5nZWQoKSkge1xyXG4gICAgZW50aXR5QXNwZWN0LnNldE1vZGlmaWVkKCk7XHJcbiAgfVxyXG4gIGlmIChlbnRpdHlBc3BlY3QuZW50aXR5U3RhdGUuaXNNb2RpZmllZCgpICYmICFvYnNBcnJheS5fb3JpZ1ZhbHVlcykge1xyXG4gICAgb2JzQXJyYXkuX29yaWdWYWx1ZXMgPSBvYnNBcnJheS5zbGljZSgwKTtcclxuICB9XHJcbn1cclxuXHJcbmZ1bmN0aW9uIHB1Ymxpc2gocHVibGlzaGVyOiBPYnNlcnZhYmxlQXJyYXksIGV2ZW50TmFtZTogc3RyaW5nLCBldmVudEFyZ3M6IGFueSkge1xyXG4gIGxldCBwZW5kaW5nUHVicyA9IHB1Ymxpc2hlci5fZ2V0UGVuZGluZ1B1YnMoKTtcclxuICBpZiAocGVuZGluZ1B1YnMpIHtcclxuICAgIGlmICghcHVibGlzaGVyLl9wZW5kaW5nQXJncykge1xyXG4gICAgICBwdWJsaXNoZXIuX3BlbmRpbmdBcmdzID0gZXZlbnRBcmdzO1xyXG4gICAgICBwZW5kaW5nUHVicy5wdXNoKGZ1bmN0aW9uICgpIHtcclxuICAgICAgICBwdWJsaXNoZXJbZXZlbnROYW1lXS5wdWJsaXNoKHB1Ymxpc2hlci5fcGVuZGluZ0FyZ3MpO1xyXG4gICAgICAgIHB1Ymxpc2hlci5fcGVuZGluZ0FyZ3MgPSBudWxsO1xyXG4gICAgICB9KTtcclxuICAgIH0gZWxzZSB7XHJcbiAgICAgIGNvbWJpbmVBcmdzKHB1Ymxpc2hlci5fcGVuZGluZ0FyZ3MsIGV2ZW50QXJncyk7XHJcbiAgICB9XHJcbiAgfSBlbHNlIHtcclxuICAgIHB1Ymxpc2hlcltldmVudE5hbWVdLnB1Ymxpc2goZXZlbnRBcmdzKTtcclxuICB9XHJcbn1cclxuXHJcbmZ1bmN0aW9uIGluaXRpYWxpemVQYXJlbnQob2JzQXJyYXk6IGFueSwgcGFyZW50OiBPYmplY3QsIHBhcmVudFByb3BlcnR5OiBEYXRhUHJvcGVydHkpIHtcclxuICBvYnNBcnJheS5wYXJlbnQgPSBwYXJlbnQ7XHJcbiAgb2JzQXJyYXkucGFyZW50UHJvcGVydHkgPSBwYXJlbnRQcm9wZXJ0eTtcclxufVxyXG5cclxuZnVuY3Rpb24gcHJvY2Vzc0FkZHMob2JzQXJyYXk6IE9ic2VydmFibGVBcnJheSwgYWRkczogYW55W10pIHtcclxuICBvYnNBcnJheS5fcHJvY2Vzc0FkZHMoYWRkcyk7XHJcbiAgLy8gdGhpcyBpcyByZWZlcmVuY2luZyB0aGUgbmFtZSBvZiB0aGUgbWV0aG9kIG9uIHRoZSBjb21wbGV4QXJyYXkgbm90IHRoZSBuYW1lIG9mIHRoZSBldmVudFxyXG4gIC8vdmFyIGFyZ3MgPSB7IGFkZGVkOiBhZGRzIH07XHJcbiAgLy9hcmdzW29ic0FycmF5Ll90eXBlTmFtZV0gPSBvYnNBcnJheTtcclxuICBwdWJsaXNoKG9ic0FycmF5LCBcImFycmF5Q2hhbmdlZFwiLCB7IGFycmF5OiBvYnNBcnJheSwgYWRkZWQ6IGFkZHMgfSk7XHJcbn1cclxuXHJcbmZ1bmN0aW9uIHByb2Nlc3NSZW1vdmVzKG9ic0FycmF5OiBPYnNlcnZhYmxlQXJyYXksIHJlbW92ZXM6IGFueVtdKSB7XHJcbiAgb2JzQXJyYXkuX3Byb2Nlc3NSZW1vdmVzKHJlbW92ZXMpO1xyXG4gIC8vIHRoaXMgaXMgcmVmZXJlbmNpbmcgdGhlIG5hbWUgb2YgdGhlIG1ldGhvZCBvbiB0aGUgYXJyYXkgbm90IHRoZSBuYW1lIG9mIHRoZSBldmVudFxyXG4gIHB1Ymxpc2gob2JzQXJyYXksIFwiYXJyYXlDaGFuZ2VkXCIsIHsgYXJyYXk6IG9ic0FycmF5LCByZW1vdmVkOiByZW1vdmVzIH0pO1xyXG59XHJcblxyXG4vLyBUT0RPOiBzZWUgaWYgdGhpcyBmdW5jdGlvbiBhbHJlYWR5IGV4aXN0cyBpbiBjb3JlIGFuZCBjYW4gYmUgaW1wb3J0ZWQuXHJcbmZ1bmN0aW9uIGNvbWJpbmVBcmdzKHRhcmdldDogT2JqZWN0LCBzb3VyY2U6IE9iamVjdCkge1xyXG4gIGZvciAobGV0IGtleSBpbiBzb3VyY2UpIHtcclxuICAgIGlmIChrZXkgIT09IFwiYXJyYXlcIiAmJiB0YXJnZXQuaGFzT3duUHJvcGVydHkoa2V5KSkge1xyXG4gICAgICBsZXQgc291cmNlVmFsdWUgPSBzb3VyY2Vba2V5XTtcclxuICAgICAgbGV0IHRhcmdldFZhbHVlID0gdGFyZ2V0W2tleV07XHJcbiAgICAgIGlmICh0YXJnZXRWYWx1ZSkge1xyXG4gICAgICAgIGlmICghQXJyYXkuaXNBcnJheSh0YXJnZXRWYWx1ZSkpIHtcclxuICAgICAgICAgIHRocm93IG5ldyBFcnJvcihcIkNhbm5vdCBjb21iaW5lIG5vbiBhcnJheSBhcmdzXCIpO1xyXG4gICAgICAgIH1cclxuICAgICAgICBBcnJheS5wcm90b3R5cGUucHVzaC5hcHBseSh0YXJnZXRWYWx1ZSwgc291cmNlVmFsdWUpO1xyXG4gICAgICB9IGVsc2Uge1xyXG4gICAgICAgIHRhcmdldFtrZXldID0gc291cmNlVmFsdWU7XHJcbiAgICAgIH1cclxuICAgIH1cclxuICB9XHJcbn1cclxuLyoqIEBoaWRkZW4gQGludGVybmFsICovXHJcbmV4cG9ydCBjb25zdCBvYnNlcnZhYmxlQXJyYXkgPSB7XHJcbiAgbWl4aW46IG1peGluLFxyXG4gIHVwZGF0ZUVudGl0eVN0YXRlOiB1cGRhdGVFbnRpdHlTdGF0ZSxcclxuICBwdWJsaXNoOiBwdWJsaXNoLFxyXG4gIGluaXRpYWxpemVQYXJlbnQ6IGluaXRpYWxpemVQYXJlbnRcclxufTtcclxuIl19