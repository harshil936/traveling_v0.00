import { core } from './core';
import { MetadataStore, EntityType, ComplexType, DataProperty, NavigationProperty, AutoGeneratedKeyType } from './entity-metadata';
import { DataType } from './data-type';
import { Validator } from './validate';
function parse(metadataStore, schemas, altMetadata) {
    metadataStore._entityTypeResourceMap = {};
    schemas = core.toArray(schemas);
    schemas.forEach(function (schema) {
        if (schema.cSpaceOSpaceMapping) {
            // Web api only - not avail in OData.
            // TODO throw informative error if already parsed and converted to map on a previous pass
            var mappings = JSON.parse(schema.cSpaceOSpaceMapping);
            var newMap_1 = {};
            mappings.forEach(function (mapping) {
                newMap_1[mapping[0]] = mapping[1];
            });
            schema.cSpaceOSpaceMapping = newMap_1;
        }
        if (schema.entityContainer) {
            core.toArray(schema.entityContainer).forEach(function (container) {
                core.toArray(container.entitySet).forEach(function (entitySet) {
                    var entityTypeName = parseTypeNameWithSchema(entitySet.entityType, schema).typeName;
                    metadataStore.setEntityTypeForResourceName(entitySet.name, entityTypeName);
                    metadataStore._entityTypeResourceMap[entityTypeName] = entitySet.name;
                });
            });
        }
        // process complextypes before entity types.
        if (schema.complexType) {
            core.toArray(schema.complexType).forEach(function (ct) {
                parseCsdlComplexType(ct, schema, metadataStore);
            });
        }
        if (schema.entityType) {
            core.toArray(schema.entityType).forEach(function (et) {
                parseCsdlEntityType(et, schema, schemas, metadataStore);
            });
        }
    });
    var badNavProps = metadataStore.getIncompleteNavigationProperties();
    if (badNavProps.length > 0) {
        var msg = badNavProps.map(function (npa) {
            if (Array.isArray(npa)) {
                return npa.map(function (np) {
                    return np.parentType.name + ":" + np.name;
                }).join(', ');
            }
            return npa.parentType.name + ":" + npa.name;
        }).join(', ');
        throw new Error("Incomplete navigation properties: " + msg);
    }
    if (altMetadata) {
        metadataStore.importMetadata(altMetadata, true);
    }
    return metadataStore;
}
function parseCsdlEntityType(csdlEntityType, schema, schemas, metadataStore) {
    var shortName = csdlEntityType.name;
    var ns = getNamespaceFor(shortName, schema);
    var entityType = new EntityType({
        shortName: shortName,
        namespace: ns,
        isAbstract: csdlEntityType.abstract && csdlEntityType.abstract === 'true'
    });
    if (csdlEntityType.baseType) {
        var baseTypeName = parseTypeNameWithSchema(csdlEntityType.baseType, schema).typeName;
        entityType.baseTypeName = baseTypeName;
        var baseEntityType = metadataStore._getStructuralType(baseTypeName, true);
        if (baseEntityType) {
            completeParseCsdlEntityType(entityType, csdlEntityType, schema, schemas, metadataStore);
        }
        else {
            var deferrals = metadataStore._deferredTypes[baseTypeName];
            if (!deferrals) {
                deferrals = [];
                metadataStore._deferredTypes[baseTypeName] = deferrals;
            }
            deferrals.push({ entityType: entityType, csdlEntityType: csdlEntityType });
        }
    }
    else {
        completeParseCsdlEntityType(entityType, csdlEntityType, schema, schemas, metadataStore);
    }
    // entityType may or may not have been added to the metadataStore at this point.
    return entityType;
}
function completeParseCsdlEntityType(entityType, csdlEntityType, schema, schemas, metadataStore) {
    var keyNamesOnServer = csdlEntityType.key ? core.toArray(csdlEntityType.key.propertyRef).map(core.pluck("name")) : [];
    core.toArray(csdlEntityType.property).forEach(function (prop) {
        parseCsdlDataProperty(entityType, prop, schema, keyNamesOnServer);
    });
    core.toArray(csdlEntityType.navigationProperty).forEach(function (prop) {
        parseCsdlNavProperty(entityType, prop, schema, schemas);
    });
    metadataStore.addEntityType(entityType);
    entityType.defaultResourceName = metadataStore._entityTypeResourceMap[entityType.name];
    var deferredTypes = metadataStore._deferredTypes;
    var deferrals = deferredTypes[entityType.name];
    if (deferrals) {
        deferrals.forEach(function (d) {
            completeParseCsdlEntityType(d.entityType, d.csdlEntityType, schema, schemas, metadataStore);
        });
        delete deferredTypes[entityType.name];
    }
}
function parseCsdlComplexType(csdlComplexType, schema, metadataStore) {
    var shortName = csdlComplexType.name;
    var ns = getNamespaceFor(shortName, schema);
    var complexType = new ComplexType({
        shortName: shortName,
        namespace: ns
    });
    core.toArray(csdlComplexType.property).forEach(function (prop) {
        parseCsdlDataProperty(complexType, prop, schema);
    });
    metadataStore.addEntityType(complexType);
    return complexType;
}
function parseCsdlDataProperty(parentType, csdlProperty, schema, keyNamesOnServer) {
    var dp;
    var typeParts = csdlProperty.type.split(".");
    // Both tests on typeParts are necessary because of differing metadata conventions for OData and Edmx feeds.
    if (typeParts[0] === "Edm" && typeParts.length === 2) {
        dp = parseCsdlSimpleProperty(parentType, csdlProperty, keyNamesOnServer);
    }
    else {
        if (isEnumType(csdlProperty, schema)) {
            dp = parseCsdlSimpleProperty(parentType, csdlProperty, keyNamesOnServer);
            if (dp) {
                dp.enumType = csdlProperty.type;
            }
        }
        else {
            dp = parseCsdlComplexProperty(parentType, csdlProperty, schema);
        }
    }
    if (dp) {
        parentType._addPropertyCore(dp);
        addValidators(dp);
    }
    return dp;
}
function parseCsdlSimpleProperty(parentType, csdlProperty, keyNamesOnServer) {
    var dataType = DataType.fromEdmDataType(csdlProperty.type);
    if (dataType == null) {
        parentType.warnings.push("Unable to recognize DataType for property: " + csdlProperty.name + " DateType: " + csdlProperty.type);
        return undefined;
    }
    var isNullable = csdlProperty.nullable === 'true' || csdlProperty.nullable == null;
    // let fixedLength = csdlProperty.fixedLength ? csdlProperty.fixedLength === true : undefined;
    var isPartOfKey = keyNamesOnServer != null && keyNamesOnServer.indexOf(csdlProperty.name) >= 0;
    if (isPartOfKey && parentType instanceof EntityType && parentType.autoGeneratedKeyType === AutoGeneratedKeyType.None) {
        if (isIdentityProperty(csdlProperty)) {
            parentType.autoGeneratedKeyType = AutoGeneratedKeyType.Identity;
        }
    }
    // TODO: nit - don't set maxLength if null;
    var maxLength = csdlProperty.maxLength;
    maxLength = (maxLength == null || maxLength === "Max") ? null : parseInt(maxLength, 10);
    // can't set the name until we go thru namingConventions and these need the dp.
    var dp = new DataProperty({
        nameOnServer: csdlProperty.name,
        dataType: dataType,
        isNullable: isNullable,
        isPartOfKey: isPartOfKey,
        maxLength: maxLength,
        defaultValue: csdlProperty.defaultValue,
        // fixedLength: fixedLength,
        concurrencyMode: csdlProperty.concurrencyMode
    });
    if (dataType === DataType.Undefined) {
        dp.rawTypeName = csdlProperty.type;
    }
    return dp;
}
function parseCsdlComplexProperty(parentType, csdlProperty, schema) {
    // Complex properties are never nullable ( per EF specs)
    // let isNullable = csdlProperty.nullable === 'true' || csdlProperty.nullable == null;
    // let complexTypeName = csdlProperty.type.split("Edm.")[1];
    var complexTypeName = parseTypeNameWithSchema(csdlProperty.type, schema).typeName;
    // can't set the name until we go thru namingConventions and these need the dp.
    var dp = new DataProperty({
        nameOnServer: csdlProperty.name,
        complexTypeName: complexTypeName,
        isNullable: false
    });
    return dp;
}
function parseCsdlNavProperty(entityType, csdlProperty, schema, schemas) {
    var association = getAssociation(csdlProperty, schema, schemas);
    if (!association) {
        throw new Error("Unable to resolve Foreign Key Association: " + csdlProperty.relationship);
    }
    var toEnd = core.arrayFirst(association.end, function (assocEnd) {
        return assocEnd.role === csdlProperty.toRole;
    });
    var isScalar = toEnd.multiplicity !== "*";
    var dataType = parseTypeNameWithSchema(toEnd.type, schema).typeName;
    var constraint = association.referentialConstraint;
    if (!constraint) {
        // TODO: Revisit this later - right now we just ignore many-many and assocs with missing constraints.
        // Think about adding this back later.
        if (association.end[0].multiplicity === "*" && association.end[1].multiplicity === "*") {
            // ignore many to many relations for now
            return;
        }
        else {
            // For now assume it will be set later directly on the client.
            // other alternative is to throw an error:
            // throw new Error("Foreign Key Associations must be turned on for this model");
        }
    }
    var cfg = {
        nameOnServer: csdlProperty.name,
        entityTypeName: dataType,
        isScalar: isScalar,
        associationName: association.name,
    };
    if (constraint) {
        var principal = constraint.principal;
        var dependent = constraint.dependent;
        var propRefs = core.toArray(dependent.propertyRef);
        var fkNames = propRefs.map(core.pluck("name"));
        if (csdlProperty.fromRole === principal.role) {
            cfg.invForeignKeyNamesOnServer = fkNames;
        }
        else {
            // will be used later by np._update
            cfg.foreignKeyNamesOnServer = fkNames;
        }
    }
    var np = new NavigationProperty(cfg);
    entityType._addPropertyCore(np);
    return np;
}
function isEnumType(csdlProperty, schema) {
    if (schema.enumType)
        return isEdmxEnumType(csdlProperty, schema);
    else if (schema.extensions)
        return isODataEnumType(csdlProperty, schema);
    else
        return false;
}
function isEdmxEnumType(csdlProperty, schema) {
    var enumTypes = core.toArray(schema.enumType);
    var typeParts = csdlProperty.type.split(".");
    var baseTypeName = typeParts[typeParts.length - 1];
    return enumTypes.some(function (enumType) {
        return enumType.name === baseTypeName;
    });
}
function isODataEnumType(csdlProperty, schema) {
    var enumTypes = schema.extensions.filter(function (ext) {
        return ext.name === "EnumType";
    });
    var typeParts = csdlProperty.type.split(".");
    var baseTypeName = typeParts[typeParts.length - 1];
    return enumTypes.some(function (enumType) {
        return enumType.attributes.some(function (attr) {
            return attr.name === "Name" && attr.value === baseTypeName;
        });
    });
}
function addValidators(dataProperty) {
    var typeValidator;
    if (!dataProperty.isNullable) {
        dataProperty.validators.push(Validator.required());
    }
    if (dataProperty.isComplexProperty)
        return;
    if (dataProperty.dataType === DataType.String) {
        if (dataProperty.maxLength) {
            var validatorArgs = { maxLength: dataProperty.maxLength };
            typeValidator = Validator.maxLength(validatorArgs);
        }
        else {
            typeValidator = Validator.string();
        }
    }
    else {
        var validatorCtor = dataProperty.dataType.validatorCtor;
        if (!validatorCtor)
            return;
        typeValidator = validatorCtor();
    }
    dataProperty.validators.push(typeValidator);
}
function isIdentityProperty(csdlProperty) {
    // see if web api feed
    var propName = core.arrayFirst(Object.keys(csdlProperty), function (pn) {
        return pn.indexOf("StoreGeneratedPattern") >= 0;
    });
    if (propName) {
        return (csdlProperty[propName] === "Identity");
    }
    else {
        // see if Odata feed
        var extensions = csdlProperty.extensions;
        if (!extensions) {
            return false;
        }
        var identityExtn = core.arrayFirst(extensions, function (extension) {
            return extension.name === "StoreGeneratedPattern" && extension.value === "Identity";
        });
        return !!identityExtn;
    }
}
// Fast version
// np: schema.entityType[].navigationProperty.relationship -> schema.association
//   match( shortName(np.relationship) == schema.association[].name
//      --> association__
// Correct version
// np: schema.entityType[].navigationProperty.relationship -> schema.association
//   match( np.relationship == schema.entityContainer[0].associationSet[].association )
//      -> associationSet.name
//   match ( associationSet.name == schema.association[].name )
//      -> association
function getAssociation(csdlNavProperty, containingSchema, schemas) {
    var assocFullName = parseTypeNameWithSchema(csdlNavProperty.relationship, containingSchema);
    var assocNamespace = assocFullName.namespace;
    var assocSchema = core.arrayFirst(schemas, function (schema) {
        return schema.namespace === assocNamespace;
    });
    if (!assocSchema)
        return null;
    var assocName = assocFullName.shortTypeName;
    var assocs = assocSchema.association;
    if (!assocs)
        return null;
    if (!Array.isArray(assocs)) {
        assocs = [assocs];
    }
    var association = core.arrayFirst(assocs, function (assoc) {
        return assoc.name === assocName;
    });
    return association;
}
// schema is only needed for navProperty type name
function parseTypeNameWithSchema(entityTypeName, schema) {
    var result = MetadataStore.parseTypeName(entityTypeName);
    if (schema && schema.cSpaceOSpaceMapping) {
        var ns = getNamespaceFor(result.shortTypeName, schema);
        if (ns) {
            result = MetadataStore.makeTypeHash(result.shortTypeName, ns);
        }
    }
    return result;
}
function getNamespaceFor(shortName, schema) {
    var ns;
    var mapping = schema.cSpaceOSpaceMapping;
    if (mapping) {
        var fullName = mapping[schema.namespace + "." + shortName];
        ns = fullName && fullName.substr(0, fullName.length - (shortName.length + 1));
        if (ns)
            return ns;
    }
    // if schema does not also have an entityType node then
    // this is an WebApi2 OData schema which is usually equal to 'Default'; which is useless.
    if (schema.entityType || schema.namespace !== 'Default') {
        return schema.namespace;
    }
    return null;
}
/** @hidden @internal */
export var CsdlMetadataParser = {
    parse: parse
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY3NkbC1tZXRhZGF0YS1wYXJzZXIuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9icmVlemUtY2xpZW50LyIsInNvdXJjZXMiOlsic3JjL2NzZGwtbWV0YWRhdGEtcGFyc2VyLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBRSxJQUFJLEVBQUUsTUFBTSxRQUFRLENBQUM7QUFDOUIsT0FBTyxFQUFFLGFBQWEsRUFBRSxVQUFVLEVBQUUsV0FBVyxFQUFFLFlBQVksRUFBRSxrQkFBa0IsRUFBRSxvQkFBb0IsRUFBRSxNQUFNLG1CQUFtQixDQUFDO0FBQ25JLE9BQU8sRUFBRSxRQUFRLEVBQUcsTUFBTSxhQUFhLENBQUM7QUFDeEMsT0FBTyxFQUFFLFNBQVMsRUFBRSxNQUFNLFlBQVksQ0FBQztBQWN2QyxTQUFTLEtBQUssQ0FBQyxhQUE0QixFQUFFLE9BQVksRUFBRSxXQUFnQjtJQUV6RSxhQUFhLENBQUMsc0JBQXNCLEdBQUcsRUFBRSxDQUFDO0lBQzFDLE9BQU8sR0FBRyxJQUFJLENBQUMsT0FBTyxDQUFDLE9BQU8sQ0FBQyxDQUFDO0lBQ2hDLE9BQU8sQ0FBQyxPQUFPLENBQUMsVUFBVSxNQUFXO1FBQ25DLElBQUksTUFBTSxDQUFDLG1CQUFtQixFQUFFO1lBQzlCLHFDQUFxQztZQUNyQyx5RkFBeUY7WUFDekYsSUFBSSxRQUFRLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQyxNQUFNLENBQUMsbUJBQW1CLENBQUMsQ0FBQztZQUN0RCxJQUFJLFFBQU0sR0FBRyxFQUFFLENBQUM7WUFDaEIsUUFBUSxDQUFDLE9BQU8sQ0FBQyxVQUFVLE9BQVk7Z0JBQ3JDLFFBQU0sQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDLENBQUMsR0FBRyxPQUFPLENBQUMsQ0FBQyxDQUFDLENBQUM7WUFDbEMsQ0FBQyxDQUFDLENBQUM7WUFDSCxNQUFNLENBQUMsbUJBQW1CLEdBQUcsUUFBTSxDQUFDO1NBQ3JDO1FBRUQsSUFBSSxNQUFNLENBQUMsZUFBZSxFQUFFO1lB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cm9tICcuL2NvcmUnO1xyXG5pbXBvcnQgeyBNZXRhZGF0YVN0b3JlLCBFbnRpdHlUeXBlLCBDb21wbGV4VHlwZSwgRGF0YVByb3BlcnR5LCBOYXZpZ2F0aW9uUHJvcGVydHksIEF1dG9HZW5lcmF0ZWRLZXlUeXBlIH0gZnJvbSAnLi9lbnRpdHktbWV0YWRhdGEnO1xyXG5pbXBvcnQgeyBEYXRhVHlwZSAgfSBmcm9tICcuL2RhdGEtdHlwZSc7XHJcbmltcG9ydCB7IFZhbGlkYXRvciB9IGZyb20gJy4vdmFsaWRhdGUnO1xyXG5cclxuaW50ZXJmYWNlIElBc3NvY2lhdGlvbiB7XHJcbiAgbmFtZTogc3RyaW5nO1xyXG4gIGVuZDogSUVuZFtdO1xyXG4gIHJlZmVyZW50aWFsQ29uc3RyYWludDogYW55O1xyXG59XHJcblxyXG5pbnRlcmZhY2UgSUVuZCB7XHJcbiAgbXVsdGlwbGljaXR5OiBzdHJpbmc7XHJcbiAgdHlwZTogc3RyaW5nO1xyXG4gIHJvbGU6IHN0cmluZztcclxufVxyXG5cclxuZnVuY3Rpb24gcGFyc2UobWV0YWRhdGFTdG9yZTogTWV0YWRhdGFTdG9yZSwgc2NoZW1hczogYW55LCBhbHRNZXRhZGF0YTogYW55KSB7XHJcblxyXG4gIG1ldGFkYXRhU3RvcmUuX2VudGl0eVR5cGVSZXNvdXJjZU1hcCA9IHt9O1xyXG4gIHNjaGVtYXMgPSBjb3JlLnRvQXJyYXkoc2NoZW1hcyk7XHJcbiAgc2NoZW1hcy5mb3JFYWNoKGZ1bmN0aW9uIChzY2hlbWE6IGFueSkge1xyXG4gICAgaWYgKHNjaGVtYS5jU3BhY2VPU3BhY2VNYXBwaW5nKSB7XHJcbiAgICAgIC8vIFdlYiBhcGkgb25seSAtIG5vdCBhdmFpbCBpbiBPRGF0YS5cclxuICAgICAgLy8gVE9ETyB0aHJvdyBpbmZvcm1hdGl2ZSBlcnJvciBpZiBhbHJlYWR5IHBhcnNlZCBhbmQgY29udmVydGVkIHRvIG1hcCBvbiBhIHByZXZpb3VzIHBhc3NcclxuICAgICAgbGV0IG1hcHBpbmdzID0gSlNPTi5wYXJzZShzY2hlbWEuY1NwYWNlT1NwYWNlTWFwcGluZyk7XHJcbiAgICAgIGxldCBuZXdNYXAgPSB7fTtcclxuICAgICAgbWFwcGluZ3MuZm9yRWFjaChmdW5jdGlvbiAobWFwcGluZzogYW55KSB7XHJcbiAgICAgICAgbmV3TWFwW21hcHBpbmdbMF1dID0gbWFwcGluZ1sxXTtcclxuICAgICAgfSk7XHJcbiAgICAgIHNjaGVtYS5jU3BhY2VPU3BhY2VNYXBwaW5nID0gbmV3TWFwO1xyXG4gICAgfVxyXG5cclxuICAgIGlmIChzY2hlbWEuZW50aXR5Q29udGFpbmVyKSB7XHJcbiAgICAgIGNvcmUudG9BcnJheShzY2hlbWEuZW50aXR5Q29udGFpbmVyKS5mb3JFYWNoKGZ1bmN0aW9uIChjb250YWluZXIpIHtcclxuICAgICAgICBjb3JlLnRvQXJyYXkoY29udGFpbmVyLmVudGl0eVNldCkuZm9yRWFjaChmdW5jdGlvbiAoZW50aXR5U2V0KSB7XHJcbiAgICAgICAgICBsZXQgZW50aXR5VHlwZU5hbWUgPSBwYXJzZVR5cGVOYW1lV2l0aFNjaGVtYShlbnRpdHlTZXQuZW50aXR5VHlwZSwgc2NoZW1hKS50eXBlTmFtZTtcclxuICAgICAgICAgIG1ldGFkYXRhU3RvcmUuc2V0RW50aXR5VHlwZUZvclJlc291cmNlTmFtZShlbnRpdHlTZXQubmFtZSwgZW50aXR5VHlwZU5hbWUpO1xyXG4gICAgICAgICAgbWV0YWRhdGFTdG9yZS5fZW50aXR5VHlwZVJlc291cmNlTWFwW2VudGl0eVR5cGVOYW1lXSA9IGVudGl0eVNldC5uYW1lO1xyXG4gICAgICAgIH0pO1xyXG4gICAgICB9KTtcclxuICAgIH1cclxuXHJcbiAgICAvLyBwcm9jZXNzIGNvbXBsZXh0eXBlcyBiZWZvcmUgZW50aXR5IHR5cGVzLlxyXG4gICAgaWYgKHNjaGVtYS5jb21wbGV4VHlwZSkge1xyXG4gICAgICBjb3JlLnRvQXJyYXkoc2NoZW1hLmNvbXBsZXhUeXBlKS5mb3JFYWNoKGZ1bmN0aW9uIChjdCkge1xyXG4gICAgICAgIHBhcnNlQ3NkbENvbXBsZXhUeXBlKGN0LCBzY2hlbWEsIG1ldGFkYXRhU3RvcmUpO1xyXG4gICAgICB9KTtcclxuICAgIH1cclxuICAgIGlmIChzY2hlbWEuZW50aXR5VHlwZSkge1xyXG4gICAgICBjb3JlLnRvQXJyYXkoc2NoZW1hLmVudGl0eVR5cGUpLmZvckVhY2goZnVuY3Rpb24gKGV0KSB7XHJcbiAgICAgICAgcGFyc2VDc2RsRW50aXR5VHlwZShldCwgc2NoZW1hLCBzY2hlbWFzLCBtZXRhZGF0YVN0b3JlKTtcclxuXHJcbiAgICAgIH0pO1xyXG4gICAgfVxyXG5cclxuICB9KTtcclxuICBsZXQgYmFkTmF2UHJvcHMgPSBtZXRhZGF0YVN0b3JlLmdldEluY29tcGxldGVOYXZpZ2F0aW9uUHJvcGVydGllcygpO1xyXG4gIGlmIChiYWROYXZQcm9wcy5sZW5ndGggPiAwKSB7XHJcbiAgICBsZXQgbXNnID0gYmFkTmF2UHJvcHMubWFwKGZ1bmN0aW9uIChucGEpIHtcclxuICAgICAgaWYgKEFycmF5LmlzQXJyYXkobnBhKSkge1xyXG4gICAgICAgIHJldHVybiBucGEubWFwKGZ1bmN0aW9uIChucCkge1xyXG4gICAgICAgICAgcmV0dXJuIG5wLnBhcmVudFR5cGUubmFtZSArIFwiOlwiICsgbnAubmFtZTtcclxuICAgICAgICB9KS5qb2luKCcsICcpO1xyXG4gICAgICB9XHJcbiAgICAgIHJldHVybiBucGEucGFyZW50VHlwZS5uYW1lICsgXCI6XCIgKyBucGEubmFtZTtcclxuICAgIH0pLmpvaW4oJywgJyk7XHJcbiAgICB0aHJvdyBuZXcgRXJyb3IoXCJJbmNvbXBsZXRlIG5hdmlnYXRpb24gcHJvcGVydGllczogXCIgKyBtc2cpO1xyXG4gIH1cclxuICBpZiAoYWx0TWV0YWRhdGEpIHtcclxuICAgIG1ldGFkYXRhU3RvcmUuaW1wb3J0TWV0YWRhdGEoYWx0TWV0YWRhdGEsIHRydWUpO1xyXG4gIH1cclxuICByZXR1cm4gbWV0YWRhdGFTdG9yZTtcclxufVxyXG5cclxuZnVuY3Rpb24gcGFyc2VDc2RsRW50aXR5VHlwZShjc2RsRW50aXR5VHlwZTogYW55LCBzY2hlbWE6IGFueSwgc2NoZW1hczogYW55LCBtZXRhZGF0YVN0b3JlOiBNZXRhZGF0YVN0b3JlKSB7XHJcbiAgbGV0IHNob3J0TmFtZSA9IGNzZGxFbnRpdHlUeXBlLm5hbWU7XHJcbiAgbGV0IG5zID0gZ2V0TmFtZXNwYWNlRm9yKHNob3J0TmFtZSwgc2NoZW1hKTtcclxuICBsZXQgZW50aXR5VHlwZSA9IG5ldyBFbnRpdHlUeXBlKHtcclxuICAgIHNob3J0TmFtZTogc2hvcnROYW1lLFxyXG4gICAgbmFtZXNwYWNlOiBucyxcclxuICAgIGlzQWJzdHJhY3Q6IGNzZGxFbnRpdHlUeXBlLmFic3RyYWN0ICYmIGNzZGxFbnRpdHlUeXBlLmFic3RyYWN0ID09PSAndHJ1ZSdcclxuICB9KTtcclxuICBpZiAoY3NkbEVudGl0eVR5cGUuYmFzZVR5cGUpIHtcclxuICAgIGxldCBiYXNlVHlwZU5hbWUgPSBwYXJzZVR5cGVOYW1lV2l0aFNjaGVtYShjc2RsRW50aXR5VHlwZS5iYXNlVHlwZSwgc2NoZW1hKS50eXBlTmFtZTtcclxuICAgIGVudGl0eVR5cGUuYmFzZVR5cGVOYW1lID0gYmFzZVR5cGVOYW1lO1xyXG4gICAgbGV0IGJhc2VFbnRpdHlUeXBlID0gbWV0YWRhdGFTdG9yZS5fZ2V0U3RydWN0dXJhbFR5cGUoYmFzZVR5cGVOYW1lLCB0cnVlKTtcclxuICAgIGlmIChiYXNlRW50aXR5VHlwZSkge1xyXG4gICAgICBjb21wbGV0ZVBhcnNlQ3NkbEVudGl0eVR5cGUoZW50aXR5VHlwZSwgY3NkbEVudGl0eVR5cGUsIHNjaGVtYSwgc2NoZW1hcywgbWV0YWRhdGFTdG9yZSk7XHJcbiAgICB9IGVsc2Uge1xyXG4gICAgICBsZXQgZGVmZXJyYWxzID0gbWV0YWRhdGFTdG9yZS5fZGVmZXJyZWRUeXBlc1tiYXNlVHlwZU5hbWVdO1xyXG4gICAgICBpZiAoIWRlZmVycmFscykge1xyXG4gICAgICAgIGRlZmVycmFscyA9IFtdO1xyXG4gICAgICAgIG1ldGFkYXRhU3RvcmUuX2RlZmVycmVkVHlwZXNbYmFzZVR5cGVOYW1lXSA9IGRlZmVycmFscztcclxuICAgICAgfVxyXG4gICAgICBkZWZlcnJhbHMucHVzaCh7IGVudGl0eVR5cGU6IGVudGl0eVR5cGUsIGNzZGxFbnRpdHlUeXBlOiBjc2RsRW50aXR5VHlwZSB9KTtcclxuICAgIH1cclxuICB9IGVsc2Uge1xyXG4gICAgY29tcGxldGVQYXJzZUNzZGxFbnRpdHlUeXBlKGVudGl0eVR5cGUsIGNzZGxFbnRpdHlUeXBlLCBzY2hlbWEsIHNjaGVtYXMsIG1ldGFkYXRhU3RvcmUpO1xyXG4gIH1cclxuICAvLyBlbnRpdHlUeXBlIG1heSBvciBtYXkgbm90IGhhdmUgYmVlbiBhZGRlZCB0byB0aGUgbWV0YWRhdGFTdG9yZSBhdCB0aGlzIHBvaW50LlxyXG4gIHJldHVybiBlbnRpdHlUeXBlO1xyXG5cclxufVxyXG5cclxuZnVuY3Rpb24gY29tcGxldGVQYXJzZUNzZGxFbnRpdHlUeXBlKGVudGl0eVR5cGU6IEVudGl0eVR5cGUsIGNzZGxFbnRpdHlUeXBlOiBhbnksIHNjaGVtYTogYW55LCBzY2hlbWFzOiBhbnksIG1ldGFkYXRhU3RvcmU6IE1ldGFkYXRhU3RvcmUpIHtcclxuICBsZXQga2V5TmFtZXNPblNlcnZlciA9IGNzZGxFbnRpdHlUeXBlLmtleSA/IGNvcmUudG9BcnJheShjc2RsRW50aXR5VHlwZS5rZXkucHJvcGVydHlSZWYpLm1hcChjb3JlLnBsdWNrKFwibmFtZVwiKSkgOiBbXTtcclxuXHJcbiAgY29yZS50b0FycmF5KGNzZGxFbnRpdHlUeXBlLnByb3BlcnR5KS5mb3JFYWNoKGZ1bmN0aW9uIChwcm9wKSB7XHJcbiAgICBwYXJzZUNzZGxEYXRhUHJvcGVydHkoZW50aXR5VHlwZSwgcHJvcCwgc2NoZW1hLCBrZXlOYW1lc09uU2VydmVyKTtcclxuICB9KTtcclxuXHJcbiAgY29yZS50b0FycmF5KGNzZGxFbnRpdHlUeXBlLm5hdmlnYXRpb25Qcm9wZXJ0eSkuZm9yRWFjaChmdW5jdGlvbiAocHJvcCkge1xyXG4gICAgcGFyc2VDc2RsTmF2UHJvcGVydHkoZW50aXR5VHlwZSwgcHJvcCwgc2NoZW1hLCBzY2hlbWFzKTtcclxuICB9KTtcclxuXHJcbiAgbWV0YWRhdGFTdG9yZS5hZGRFbnRpdHlUeXBlKGVudGl0eVR5cGUpO1xyXG4gIGVudGl0eVR5cGUuZGVmYXVsdFJlc291cmNlTmFtZSA9IG1ldGFkYXRhU3RvcmUuX2VudGl0eVR5cGVSZXNvdXJjZU1hcFtlbnRpdHlUeXBlLm5hbWVdO1xyXG5cclxuICBsZXQgZGVmZXJyZWRUeXBlcyA9IG1ldGFkYXRhU3RvcmUuX2RlZmVycmVkVHlwZXM7XHJcbiAgbGV0IGRlZmVycmFscyA9IGRlZmVycmVkVHlwZXNbZW50aXR5VHlwZS5uYW1lXTtcclxuICBpZiAoZGVmZXJyYWxzKSB7XHJcbiAgICBkZWZlcnJhbHMuZm9yRWFjaChmdW5jdGlvbiAoZDogYW55KSB7XHJcbiAgICAgIGNvbXBsZXRlUGFyc2VDc2RsRW50aXR5VHlwZShkLmVudGl0eVR5cGUsIGQuY3NkbEVudGl0eVR5cGUsIHNjaGVtYSwgc2NoZW1hcywgbWV0YWRhdGFTdG9yZSk7XHJcbiAgICB9KTtcclxuICAgIGRlbGV0ZSBkZWZlcnJlZFR5cGVzW2VudGl0eVR5cGUubmFtZV07XHJcbiAgfVxyXG5cclxufVxyXG5cclxuZnVuY3Rpb24gcGFyc2VDc2RsQ29tcGxleFR5cGUoY3NkbENvbXBsZXhUeXBlOiBhbnksIHNjaGVtYTogYW55LCBtZXRhZGF0YVN0b3JlOiBNZXRhZGF0YVN0b3JlKSB7XHJcbiAgbGV0IHNob3J0TmFtZSA9IGNzZGxDb21wbGV4VHlwZS5uYW1lO1xyXG4gIGxldCBucyA9IGdldE5hbWVzcGFjZUZvcihzaG9ydE5hbWUsIHNjaGVtYSk7XHJcbiAgbGV0IGNvbXBsZXhUeXBlID0gbmV3IENvbXBsZXhUeXBlKHtcclxuICAgIHNob3J0TmFtZTogc2hvcnROYW1lLFxyXG4gICAgbmFtZXNwYWNlOiBuc1xyXG4gIH0pO1xyXG5cclxuICBjb3JlLnRvQXJyYXkoY3NkbENvbXBsZXhUeXBlLnByb3BlcnR5KS5mb3JFYWNoKGZ1bmN0aW9uIChwcm9wKSB7XHJcbiAgICBwYXJzZUNzZGxEYXRhUHJvcGVydHkoY29tcGxleFR5cGUsIHByb3AsIHNjaGVtYSk7XHJcbiAgfSk7XHJcblxyXG4gIG1ldGFkYXRhU3RvcmUuYWRkRW50aXR5VHlwZShjb21wbGV4VHlwZSk7XHJcbiAgcmV0dXJuIGNvbXBsZXhUeXBlO1xyXG59XHJcblxyXG5mdW5jdGlvbiBwYXJzZUNzZGxEYXRhUHJvcGVydHkocGFyZW50VHlwZTogRW50aXR5VHlwZSB8IENvbXBsZXhUeXBlLCBjc2RsUHJvcGVydHk6IGFueSwgc2NoZW1hOiBhbnksIGtleU5hbWVzT25TZXJ2ZXI/OiBzdHJpbmdbXSkge1xyXG4gIGxldCBkcDogRGF0YVByb3BlcnR5IHwgdW5kZWZpbmVkO1xyXG4gIGxldCB0eXBlUGFydHMgPSBjc2RsUHJvcGVydHkudHlwZS5zcGxpdChcIi5cIik7XHJcbiAgLy8gQm90aCB0ZXN0cyBvbiB0eXBlUGFydHMgYXJlIG5lY2Vzc2FyeSBiZWNhdXNlIG9mIGRpZmZlcmluZyBtZXRhZGF0YSBjb252ZW50aW9ucyBmb3IgT0RhdGEgYW5kIEVkbXggZmVlZHMuXHJcbiAgaWYgKHR5cGVQYXJ0c1swXSA9PT0gXCJFZG1cIiAmJiB0eXBlUGFydHMubGVuZ3RoID09PSAyKSB7XHJcbiAgICBkcCA9IHBhcnNlQ3NkbFNpbXBsZVByb3BlcnR5KHBhcmVudFR5cGUsIGNzZGxQcm9wZXJ0eSwga2V5TmFtZXNPblNlcnZlcik7XHJcbiAgfSBlbHNlIHtcclxuICAgIGlmIChpc0VudW1UeXBlKGNzZGxQcm9wZXJ0eSwgc2NoZW1hKSkge1xyXG4gICAgICBkcCA9IHBhcnNlQ3NkbFNpbXBsZVByb3BlcnR5KHBhcmVudFR5cGUsIGNzZGxQcm9wZXJ0eSwga2V5TmFtZXNPblNlcnZlcik7XHJcbiAgICAgIGlmIChkcCkge1xyXG4gICAgICAgIGRwLmVudW1UeXBlID0gY3NkbFByb3BlcnR5LnR5cGU7XHJcbiAgICAgIH1cclxuICAgIH0gZWxzZSB7XHJcbiAgICAgIGRwID0gcGFyc2VDc2RsQ29tcGxleFByb3BlcnR5KHBhcmVudFR5cGUsIGNzZGxQcm9wZXJ0eSwgc2NoZW1hKTtcclxuICAgIH1cclxuICB9XHJcbiAgaWYgKGRwKSB7XHJcbiAgICBwYXJlbnRUeXBlLl9hZGRQcm9wZXJ0eUNvcmUoZHApO1xyXG4gICAgYWRkVmFsaWRhdG9ycyhkcCk7XHJcbiAgfVxyXG4gIHJldHVybiBkcDtcclxufVxyXG5cclxuZnVuY3Rpb24gcGFyc2VDc2RsU2ltcGxlUHJvcGVydHkocGFyZW50VHlwZTogRW50aXR5VHlwZSB8IENvbXBsZXhUeXBlLCBjc2RsUHJvcGVydHk6IGFueSwga2V5TmFtZXNPblNlcnZlcj86IHN0cmluZ1tdKSB7XHJcbiAgbGV0IGRhdGFUeXBlID0gRGF0YVR5cGUuZnJvbUVkbURhdGFUeXBlKGNzZGxQcm9wZXJ0eS50eXBlKTtcclxuICBpZiAoZGF0YVR5cGUgPT0gbnVsbCkge1xyXG4gICAgcGFyZW50VHlwZS53YXJuaW5ncy5wdXNoKFwiVW5hYmxlIHRvIHJlY29nbml6ZSBEYXRhVHlwZSBmb3IgcHJvcGVydHk6IFwiICsgY3NkbFByb3BlcnR5Lm5hbWUgKyBcIiBEYXRlVHlwZTogXCIgKyBjc2RsUHJvcGVydHkudHlwZSk7XHJcbiAgICByZXR1cm4gdW5kZWZpbmVkO1xyXG4gIH1cclxuICBsZXQgaXNOdWxsYWJsZSA9IGNzZGxQcm9wZXJ0eS5udWxsYWJsZSA9PT0gJ3RydWUnIHx8IGNzZGxQcm9wZXJ0eS5udWxsYWJsZSA9PSBudWxsO1xyXG4gIC8vIGxldCBmaXhlZExlbmd0aCA9IGNzZGxQcm9wZXJ0eS5maXhlZExlbmd0aCA/IGNzZGxQcm9wZXJ0eS5maXhlZExlbmd0aCA9PT0gdHJ1ZSA6IHVuZGVmaW5lZDtcclxuICBsZXQgaXNQYXJ0T2ZLZXkgPSBrZXlOYW1lc09uU2VydmVyICE9IG51bGwgJiYga2V5TmFtZXNPblNlcnZlci5pbmRleE9mKGNzZGxQcm9wZXJ0eS5uYW1lKSA+PSAwO1xyXG4gIGlmIChpc1BhcnRPZktleSAmJiBwYXJlbnRUeXBlIGluc3RhbmNlb2YgRW50aXR5VHlwZSAmJiBwYXJlbnRUeXBlLmF1dG9HZW5lcmF0ZWRLZXlUeXBlID09PSBBdXRvR2VuZXJhdGVkS2V5VHlwZS5Ob25lKSB7XHJcbiAgICBpZiAoaXNJZGVudGl0eVByb3BlcnR5KGNzZGxQcm9wZXJ0eSkpIHtcclxuICAgICAgcGFyZW50VHlwZS5hdXRvR2VuZXJhdGVkS2V5VHlwZSA9IEF1dG9HZW5lcmF0ZWRLZXlUeXBlLklkZW50aXR5O1xyXG4gICAgfVxyXG4gIH1cclxuICAvLyBUT0RPOiBuaXQgLSBkb24ndCBzZXQgbWF4TGVuZ3RoIGlmIG51bGw7XHJcbiAgbGV0IG1heExlbmd0aCA9IGNzZGxQcm9wZXJ0eS5tYXhMZW5ndGg7XHJcbiAgbWF4TGVuZ3RoID0gKG1heExlbmd0aCA9PSBudWxsIHx8IG1heExlbmd0aCA9PT0gXCJNYXhcIikgPyBudWxsIDogcGFyc2VJbnQobWF4TGVuZ3RoLCAxMCk7XHJcbiAgLy8gY2FuJ3Qgc2V0IHRoZSBuYW1lIHVudGlsIHdlIGdvIHRocnUgbmFtaW5nQ29udmVudGlvbnMgYW5kIHRoZXNlIG5lZWQgdGhlIGRwLlxyXG5cclxuICBsZXQgZHAgPSBuZXcgRGF0YVByb3BlcnR5KHtcclxuICAgIG5hbWVPblNlcnZlcjogY3NkbFByb3BlcnR5Lm5hbWUsXHJcbiAgICBkYXRhVHlwZTogZGF0YVR5cGUsXHJcbiAgICBpc051bGxhYmxlOiBpc051bGxhYmxlLFxyXG4gICAgaXNQYXJ0T2ZLZXk6IGlzUGFydE9mS2V5LFxyXG4gICAgbWF4TGVuZ3RoOiBtYXhMZW5ndGgsXHJcbiAgICBkZWZhdWx0VmFsdWU6IGNzZGxQcm9wZXJ0eS5kZWZhdWx0VmFsdWUsXHJcbiAgICAvLyBmaXhlZExlbmd0aDogZml4ZWRMZW5ndGgsXHJcbiAgICBjb25jdXJyZW5jeU1vZGU6IGNzZGxQcm9wZXJ0eS5jb25jdXJyZW5jeU1vZGVcclxuICB9KTtcclxuXHJcbiAgaWYgKGRhdGFUeXBlID09PSBEYXRhVHlwZS5VbmRlZmluZWQpIHtcclxuICAgIGRwLnJhd1R5cGVOYW1lID0gY3NkbFByb3BlcnR5LnR5cGU7XHJcbiAgfVxyXG4gIHJldHVybiBkcDtcclxufVxyXG5cclxuZnVuY3Rpb24gcGFyc2VDc2RsQ29tcGxleFByb3BlcnR5KHBhcmVudFR5cGU6IEVudGl0eVR5cGUgfCBDb21wbGV4VHlwZSwgY3NkbFByb3BlcnR5OiBhbnksIHNjaGVtYTogYW55KSB7XHJcblxyXG4gIC8vIENvbXBsZXggcHJvcGVydGllcyBhcmUgbmV2ZXIgbnVsbGFibGUgKCBwZXIgRUYgc3BlY3MpXHJcbiAgLy8gbGV0IGlzTnVsbGFibGUgPSBjc2RsUHJvcGVydHkubnVsbGFibGUgPT09ICd0cnVlJyB8fCBjc2RsUHJvcGVydHkubnVsbGFibGUgPT0gbnVsbDtcclxuICAvLyBsZXQgY29tcGxleFR5cGVOYW1lID0gY3NkbFByb3BlcnR5LnR5cGUuc3BsaXQoXCJFZG0uXCIpWzFdO1xyXG4gIGxldCBjb21wbGV4VHlwZU5hbWUgPSBwYXJzZVR5cGVOYW1lV2l0aFNjaGVtYShjc2RsUHJvcGVydHkudHlwZSwgc2NoZW1hKS50eXBlTmFtZTtcclxuICAvLyBjYW4ndCBzZXQgdGhlIG5hbWUgdW50aWwgd2UgZ28gdGhydSBuYW1pbmdDb252ZW50aW9ucyBhbmQgdGhlc2UgbmVlZCB0aGUgZHAuXHJcbiAgbGV0IGRwID0gbmV3IERhdGFQcm9wZXJ0eSh7XHJcbiAgICBuYW1lT25TZXJ2ZXI6IGNzZGxQcm9wZXJ0eS5uYW1lLFxyXG4gICAgY29tcGxleFR5cGVOYW1lOiBjb21wbGV4VHlwZU5hbWUsXHJcbiAgICBpc051bGxhYmxlOiBmYWxzZVxyXG4gIH0pO1xyXG5cclxuICByZXR1cm4gZHA7XHJcbn1cclxuXHJcbmZ1bmN0aW9uIHBhcnNlQ3NkbE5hdlByb3BlcnR5KGVudGl0eVR5cGU6IEVudGl0eVR5cGUsIGNzZGxQcm9wZXJ0eTogYW55LCBzY2hlbWE6IGFueSwgc2NoZW1hczogYW55W10pIHtcclxuICBsZXQgYXNzb2NpYXRpb24gPSBnZXRBc3NvY2lhdGlvbihjc2RsUHJvcGVydHksIHNjaGVtYSwgc2NoZW1hcyk7XHJcbiAgaWYgKCFhc3NvY2lhdGlvbikge1xyXG4gICAgdGhyb3cgbmV3IEVycm9yKFwiVW5hYmxlIHRvIHJlc29sdmUgRm9yZWlnbiBLZXkgQXNzb2NpYXRpb246IFwiICsgY3NkbFByb3BlcnR5LnJlbGF0aW9uc2hpcCk7XHJcbiAgfVxyXG4gIGxldCB0b0VuZCA9IGNvcmUuYXJyYXlGaXJzdChhc3NvY2lhdGlvbi5lbmQsIChhc3NvY0VuZCkgPT4ge1xyXG4gICAgcmV0dXJuIGFzc29jRW5kLnJvbGUgPT09IGNzZGxQcm9wZXJ0eS50b1JvbGU7XHJcbiAgfSk7XHJcblxyXG4gIGxldCBpc1NjYWxhciA9IHRvRW5kIS5tdWx0aXBsaWNpdHkgIT09IFwiKlwiO1xyXG4gIGxldCBkYXRhVHlwZSA9IHBhcnNlVHlwZU5hbWVXaXRoU2NoZW1hKHRvRW5kIS50eXBlLCBzY2hlbWEpLnR5cGVOYW1lO1xyXG5cclxuICBsZXQgY29uc3RyYWludCA9IGFzc29jaWF0aW9uLnJlZmVyZW50aWFsQ29uc3RyYWludDtcclxuICBpZiAoIWNvbnN0cmFpbnQpIHtcclxuICAgIC8vIFRPRE86IFJldmlzaXQgdGhpcyBsYXRlciAtIHJpZ2h0IG5vdyB3ZSBqdXN0IGlnbm9yZSBtYW55LW1hbnkgYW5kIGFzc29jcyB3aXRoIG1pc3NpbmcgY29uc3RyYWludHMuXHJcblxyXG4gICAgLy8gVGhpbmsgYWJvdXQgYWRkaW5nIHRoaXMgYmFjayBsYXRlci5cclxuICAgIGlmIChhc3NvY2lhdGlvbi5lbmRbMF0ubXVsdGlwbGljaXR5ID09PSBcIipcIiAmJiBhc3NvY2lhdGlvbi5lbmRbMV0ubXVsdGlwbGljaXR5ID09PSBcIipcIikge1xyXG4gICAgICAvLyBpZ25vcmUgbWFueSB0byBtYW55IHJlbGF0aW9ucyBmb3Igbm93XHJcbiAgICAgIHJldHVybjtcclxuICAgIH0gZWxzZSB7XHJcbiAgICAgIC8vIEZvciBub3cgYXNzdW1lIGl0IHdpbGwgYmUgc2V0IGxhdGVyIGRpcmVjdGx5IG9uIHRoZSBjbGllbnQuXHJcbiAgICAgIC8vIG90aGVyIGFsdGVybmF0aXZlIGlzIHRvIHRocm93IGFuIGVycm9yOlxyXG4gICAgICAvLyB0aHJvdyBuZXcgRXJyb3IoXCJGb3JlaWduIEtleSBBc3NvY2lhdGlvbnMgbXVzdCBiZSB0dXJuZWQgb24gZm9yIHRoaXMgbW9kZWxcIik7XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuXHJcblxyXG4gIGxldCBjZmcgPSB7XHJcbiAgICBuYW1lT25TZXJ2ZXI6IGNzZGxQcm9wZXJ0eS5uYW1lLFxyXG4gICAgZW50aXR5VHlwZU5hbWU6IGRhdGFUeXBlLFxyXG4gICAgaXNTY2FsYXI6IGlzU2NhbGFyLFxyXG4gICAgYXNzb2NpYXRpb25OYW1lOiBhc3NvY2lhdGlvbi5uYW1lLFxyXG4gIH07XHJcblxyXG4gIGlmIChjb25zdHJhaW50KSB7XHJcbiAgICBsZXQgcHJpbmNpcGFsID0gY29uc3RyYWludC5wcmluY2lwYWw7XHJcbiAgICBsZXQgZGVwZW5kZW50ID0gY29uc3RyYWludC5kZXBlbmRlbnQ7XHJcblxyXG4gICAgbGV0IHByb3BSZWZzID0gY29yZS50b0FycmF5KGRlcGVuZGVudC5wcm9wZXJ0eVJlZik7XHJcbiAgICBsZXQgZmtOYW1lcyA9IHByb3BSZWZzLm1hcChjb3JlLnBsdWNrKFwibmFtZVwiKSk7XHJcbiAgICBpZiAoY3NkbFByb3BlcnR5LmZyb21Sb2xlID09PSBwcmluY2lwYWwucm9sZSkge1xyXG4gICAgICAoY2ZnIGFzIGFueSkuaW52Rm9yZWlnbktleU5hbWVzT25TZXJ2ZXIgPSBma05hbWVzO1xyXG4gICAgfSBlbHNlIHtcclxuICAgICAgLy8gd2lsbCBiZSB1c2VkIGxhdGVyIGJ5IG5wLl91cGRhdGVcclxuICAgICAgKGNmZyBhcyBhbnkpLmZvcmVpZ25LZXlOYW1lc09uU2VydmVyID0gZmtOYW1lcztcclxuICAgIH1cclxuICB9XHJcblxyXG4gIGxldCBucCA9IG5ldyBOYXZpZ2F0aW9uUHJvcGVydHkoY2ZnKTtcclxuICBlbnRpdHlUeXBlLl9hZGRQcm9wZXJ0eUNvcmUobnApO1xyXG4gIHJldHVybiBucDtcclxufVxyXG5cclxuXHJcbmZ1bmN0aW9uIGlzRW51bVR5cGUoY3NkbFByb3BlcnR5OiBhbnksIHNjaGVtYTogYW55KSB7XHJcbiAgaWYgKHNjaGVtYS5lbnVtVHlwZSkgcmV0dXJuIGlzRWRteEVudW1UeXBlKGNzZGxQcm9wZXJ0eSwgc2NoZW1hKTtcclxuICBlbHNlIGlmIChzY2hlbWEuZXh0ZW5zaW9ucykgcmV0dXJuIGlzT0RhdGFFbnVtVHlwZShjc2RsUHJvcGVydHksIHNjaGVtYSk7XHJcbiAgZWxzZSByZXR1cm4gZmFsc2U7XHJcbn1cclxuXHJcbmZ1bmN0aW9uIGlzRWRteEVudW1UeXBlKGNzZGxQcm9wZXJ0eTogYW55LCBzY2hlbWE6IGFueSkge1xyXG4gIGxldCBlbnVtVHlwZXMgPSBjb3JlLnRvQXJyYXkoc2NoZW1hLmVudW1UeXBlKTtcclxuICBsZXQgdHlwZVBhcnRzID0gY3NkbFByb3BlcnR5LnR5cGUuc3BsaXQoXCIuXCIpO1xyXG4gIGxldCBiYXNlVHlwZU5hbWUgPSB0eXBlUGFydHNbdHlwZVBhcnRzLmxlbmd0aCAtIDFdO1xyXG4gIHJldHVybiBlbnVtVHlwZXMuc29tZShmdW5jdGlvbiAoZW51bVR5cGUpIHtcclxuICAgIHJldHVybiBlbnVtVHlwZS5uYW1lID09PSBiYXNlVHlwZU5hbWU7XHJcbiAgfSk7XHJcbn1cclxuXHJcbmZ1bmN0aW9uIGlzT0RhdGFFbnVtVHlwZShjc2RsUHJvcGVydHk6IGFueSwgc2NoZW1hOiBhbnkpIHtcclxuICBsZXQgZW51bVR5cGVzID0gc2NoZW1hLmV4dGVuc2lvbnMuZmlsdGVyKChleHQ6IGFueSkgPT4ge1xyXG4gICAgcmV0dXJuIGV4dC5uYW1lID09PSBcIkVudW1UeXBlXCI7XHJcbiAgfSk7XHJcbiAgbGV0IHR5cGVQYXJ0cyA9IGNzZGxQcm9wZXJ0eS50eXBlLnNwbGl0KFwiLlwiKTtcclxuICBsZXQgYmFzZVR5cGVOYW1lID0gdHlwZVBhcnRzW3R5cGVQYXJ0cy5sZW5ndGggLSAxXTtcclxuICByZXR1cm4gZW51bVR5cGVzLnNvbWUoKGVudW1UeXBlOiBhbnkpID0+IHtcclxuICAgIHJldHVybiBlbnVtVHlwZS5hdHRyaWJ1dGVzLnNvbWUoKGF0dHI6IGFueSkgPT4ge1xyXG4gICAgICByZXR1cm4gYXR0ci5uYW1lID09PSBcIk5hbWVcIiAmJiBhdHRyLnZhbHVlID09PSBiYXNlVHlwZU5hbWU7XHJcbiAgICB9KTtcclxuICB9KTtcclxufVxyXG5cclxuZnVuY3Rpb24gYWRkVmFsaWRhdG9ycyhkYXRhUHJvcGVydHk6IERhdGFQcm9wZXJ0eSkge1xyXG4gIGxldCB0eXBlVmFsaWRhdG9yOiBWYWxpZGF0b3I7XHJcbiAgaWYgKCFkYXRhUHJvcGVydHkuaXNOdWxsYWJsZSkge1xyXG4gICAgZGF0YVByb3BlcnR5LnZhbGlkYXRvcnMucHVzaChWYWxpZGF0b3IucmVxdWlyZWQoKSk7XHJcbiAgfVxyXG5cclxuICBpZiAoZGF0YVByb3BlcnR5LmlzQ29tcGxleFByb3BlcnR5KSByZXR1cm47XHJcblxyXG4gIGlmIChkYXRhUHJvcGVydHkuZGF0YVR5cGUgPT09IERhdGFUeXBlLlN0cmluZykge1xyXG4gICAgaWYgKGRhdGFQcm9wZXJ0eS5tYXhMZW5ndGgpIHtcclxuICAgICAgbGV0IHZhbGlkYXRvckFyZ3MgPSB7IG1heExlbmd0aDogZGF0YVByb3BlcnR5Lm1heExlbmd0aCB9O1xyXG4gICAgICB0eXBlVmFsaWRhdG9yID0gVmFsaWRhdG9yLm1heExlbmd0aCh2YWxpZGF0b3JBcmdzKTtcclxuICAgIH0gZWxzZSB7XHJcbiAgICAgIHR5cGVWYWxpZGF0b3IgPSBWYWxpZGF0b3Iuc3RyaW5nKCk7XHJcbiAgICB9XHJcbiAgfSBlbHNlIHtcclxuICAgICAgbGV0IHZhbGlkYXRvckN0b3IgPSAoZGF0YVByb3BlcnR5LmRhdGFUeXBlIGFzIGFueSkudmFsaWRhdG9yQ3RvcjtcclxuICAgICAgaWYgKCF2YWxpZGF0b3JDdG9yKSByZXR1cm47XHJcbiAgICAgIHR5cGVWYWxpZGF0b3IgPSB2YWxpZGF0b3JDdG9yKCk7XHJcbiAgfVxyXG5cclxuICBkYXRhUHJvcGVydHkudmFsaWRhdG9ycy5wdXNoKHR5cGVWYWxpZGF0b3IpO1xyXG5cclxufVxyXG5cclxuZnVuY3Rpb24gaXNJZGVudGl0eVByb3BlcnR5KGNzZGxQcm9wZXJ0eTogYW55KSB7XHJcbiAgLy8gc2VlIGlmIHdlYiBhcGkgZmVlZFxyXG4gIGxldCBwcm9wTmFtZSA9IGNvcmUuYXJyYXlGaXJzdChPYmplY3Qua2V5cyhjc2RsUHJvcGVydHkpLCAocG4pID0+IHtcclxuICAgIHJldHVybiBwbi5pbmRleE9mKFwiU3RvcmVHZW5lcmF0ZWRQYXR0ZXJuXCIpID49IDA7XHJcbiAgfSk7XHJcbiAgaWYgKHByb3BOYW1lKSB7XHJcbiAgICByZXR1cm4gKGNzZGxQcm9wZXJ0eVtwcm9wTmFtZV0gPT09IFwiSWRlbnRpdHlcIik7XHJcbiAgfSBlbHNlIHtcclxuICAgIC8vIHNlZSBpZiBPZGF0YSBmZWVkXHJcbiAgICBsZXQgZXh0ZW5zaW9ucyA9IGNzZGxQcm9wZXJ0eS5leHRlbnNpb25zO1xyXG4gICAgaWYgKCFleHRlbnNpb25zKSB7XHJcbiAgICAgIHJldHVybiBmYWxzZTtcclxuICAgIH1cclxuICAgIGxldCBpZGVudGl0eUV4dG4gPSBjb3JlLmFycmF5Rmlyc3QoZXh0ZW5zaW9ucywgKGV4dGVuc2lvbikgPT4ge1xyXG4gICAgICByZXR1cm4gZXh0ZW5zaW9uLm5hbWUgPT09IFwiU3RvcmVHZW5lcmF0ZWRQYXR0ZXJuXCIgJiYgZXh0ZW5zaW9uLnZhbHVlID09PSBcIklkZW50aXR5XCI7XHJcbiAgICB9KTtcclxuICAgIHJldHVybiAhIWlkZW50aXR5RXh0bjtcclxuICB9XHJcbn1cclxuXHJcbi8vIEZhc3QgdmVyc2lvblxyXG4vLyBucDogc2NoZW1hLmVudGl0eVR5cGVbXS5uYXZpZ2F0aW9uUHJvcGVydHkucmVsYXRpb25zaGlwIC0+IHNjaGVtYS5hc3NvY2lhdGlvblxyXG4vLyAgIG1hdGNoKCBzaG9ydE5hbWUobnAucmVsYXRpb25zaGlwKSA9PSBzY2hlbWEuYXNzb2NpYXRpb25bXS5uYW1lXHJcbi8vICAgICAgLS0+IGFzc29jaWF0aW9uX19cclxuXHJcbi8vIENvcnJlY3QgdmVyc2lvblxyXG4vLyBucDogc2NoZW1hLmVudGl0eVR5cGVbXS5uYXZpZ2F0aW9uUHJvcGVydHkucmVsYXRpb25zaGlwIC0+IHNjaGVtYS5hc3NvY2lhdGlvblxyXG4vLyAgIG1hdGNoKCBucC5yZWxhdGlvbnNoaXAgPT0gc2NoZW1hLmVudGl0eUNvbnRhaW5lclswXS5hc3NvY2lhdGlvblNldFtdLmFzc29jaWF0aW9uIClcclxuLy8gICAgICAtPiBhc3NvY2lhdGlvblNldC5uYW1lXHJcbi8vICAgbWF0Y2ggKCBhc3NvY2lhdGlvblNldC5uYW1lID09IHNjaGVtYS5hc3NvY2lhdGlvbltdLm5hbWUgKVxyXG4vLyAgICAgIC0+IGFzc29jaWF0aW9uXHJcblxyXG5mdW5jdGlvbiBnZXRBc3NvY2lhdGlvbihjc2RsTmF2UHJvcGVydHk6IGFueSwgY29udGFpbmluZ1NjaGVtYTogYW55LCBzY2hlbWFzOiBhbnlbXSkge1xyXG4gIGxldCBhc3NvY0Z1bGxOYW1lID0gcGFyc2VUeXBlTmFtZVdpdGhTY2hlbWEoY3NkbE5hdlByb3BlcnR5LnJlbGF0aW9uc2hpcCwgY29udGFpbmluZ1NjaGVtYSk7XHJcbiAgbGV0IGFzc29jTmFtZXNwYWNlID0gYXNzb2NGdWxsTmFtZS5uYW1lc3BhY2U7XHJcbiAgbGV0IGFzc29jU2NoZW1hID0gY29yZS5hcnJheUZpcnN0KHNjaGVtYXMsIChzY2hlbWEpID0+IHtcclxuICAgIHJldHVybiBzY2hlbWEubmFtZXNwYWNlID09PSBhc3NvY05hbWVzcGFjZTtcclxuICB9KTtcclxuICBpZiAoIWFzc29jU2NoZW1hKSByZXR1cm4gbnVsbDtcclxuXHJcbiAgbGV0IGFzc29jTmFtZSA9IGFzc29jRnVsbE5hbWUuc2hvcnRUeXBlTmFtZTtcclxuICBsZXQgYXNzb2NzID0gYXNzb2NTY2hlbWEuYXNzb2NpYXRpb247XHJcbiAgaWYgKCFhc3NvY3MpIHJldHVybiBudWxsO1xyXG4gIGlmICghQXJyYXkuaXNBcnJheShhc3NvY3MpKSB7XHJcbiAgICBhc3NvY3MgPSBbYXNzb2NzXTtcclxuICB9XHJcbiAgbGV0IGFzc29jaWF0aW9uID0gY29yZS5hcnJheUZpcnN0KGFzc29jcywgKGFzc29jKSA9PiB7XHJcbiAgICByZXR1cm4gYXNzb2MubmFtZSA9PT0gYXNzb2NOYW1lO1xyXG4gIH0pO1xyXG4gIHJldHVybiBhc3NvY2lhdGlvbiBhcyBJQXNzb2NpYXRpb247XHJcbn1cclxuXHJcbi8vIHNjaGVtYSBpcyBvbmx5IG5lZWRlZCBmb3IgbmF2UHJvcGVydHkgdHlwZSBuYW1lXHJcbmZ1bmN0aW9uIHBhcnNlVHlwZU5hbWVXaXRoU2NoZW1hKGVudGl0eVR5cGVOYW1lOiBzdHJpbmcsIHNjaGVtYTogYW55KSB7XHJcbiAgbGV0IHJlc3VsdCA9IE1ldGFkYXRhU3RvcmUucGFyc2VUeXBlTmFtZShlbnRpdHlUeXBlTmFtZSk7XHJcbiAgaWYgKHNjaGVtYSAmJiBzY2hlbWEuY1NwYWNlT1NwYWNlTWFwcGluZykge1xyXG4gICAgbGV0IG5zID0gZ2V0TmFtZXNwYWNlRm9yKHJlc3VsdCEuc2hvcnRUeXBlTmFtZSwgc2NoZW1hKTtcclxuICAgIGlmIChucykge1xyXG4gICAgICByZXN1bHQgPSBNZXRhZGF0YVN0b3JlLm1ha2VUeXBlSGFzaChyZXN1bHQhLnNob3J0VHlwZU5hbWUsIG5zKTtcclxuICAgIH1cclxuICB9XHJcbiAgcmV0dXJuIHJlc3VsdDtcclxufVxyXG5cclxuZnVuY3Rpb24gZ2V0TmFtZXNwYWNlRm9yKHNob3J0TmFtZTogc3RyaW5nLCBzY2hlbWE6IGFueSkge1xyXG4gIGxldCBuczogc3RyaW5nO1xyXG4gIGxldCBtYXBwaW5nID0gc2NoZW1hLmNTcGFjZU9TcGFjZU1hcHBpbmc7XHJcbiAgaWYgKG1hcHBpbmcpIHtcclxuICAgIGxldCBmdWxsTmFtZSA9IG1hcHBpbmdbc2NoZW1hLm5hbWVzcGFjZSArIFwiLlwiICsgc2hvcnROYW1lXTtcclxuICAgIG5zID0gZnVsbE5hbWUgJiYgZnVsbE5hbWUuc3Vic3RyKDAsIGZ1bGxOYW1lLmxlbmd0aCAtIChzaG9ydE5hbWUubGVuZ3RoICsgMSkpO1xyXG4gICAgaWYgKG5zKSByZXR1cm4gbnM7XHJcbiAgfVxyXG4gIC8vIGlmIHNjaGVtYSBkb2VzIG5vdCBhbHNvIGhhdmUgYW4gZW50aXR5VHlwZSBub2RlIHRoZW5cclxuICAvLyB0aGlzIGlzIGFuIFdlYkFwaTIgT0RhdGEgc2NoZW1hIHdoaWNoIGlzIHVzdWFsbHkgZXF1YWwgdG8gJ0RlZmF1bHQnOyB3aGljaCBpcyB1c2VsZXNzLlxyXG4gIGlmIChzY2hlbWEuZW50aXR5VHlwZSB8fCBzY2hlbWEubmFtZXNwYWNlICE9PSAnRGVmYXVsdCcpIHtcclxuICAgIHJldHVybiBzY2hlbWEubmFtZXNwYWNlO1xyXG4gIH1cclxuICByZXR1cm4gbnVsbDtcclxufVxyXG5cclxuLyoqIEBoaWRkZW4gQGludGVybmFsICovXHJcbmV4cG9ydCBjb25zdCBDc2RsTWV0YWRhdGFQYXJzZXIgPSB7XHJcbiAgcGFyc2U6IHBhcnNlXHJcbn07XHJcbiJdfQ==