import { HttpHeaders, HttpRequest, HttpResponse } from "@angular/common/http";
import { config, core } from "breeze-client";
import { filter, map } from "rxjs/operators";
var AjaxHttpClientAdapter = /** @class */ (function () {
    function AjaxHttpClientAdapter(http) {
        this.http = http;
        this.name = AjaxHttpClientAdapter.adapterName;
        this.defaultSettings = {};
    }
    AjaxHttpClientAdapter.register = function (http, breezeConfig) {
        breezeConfig = breezeConfig || config;
        breezeConfig.registerAdapter("ajax", function () { return new AjaxHttpClientAdapter(http); });
        return breezeConfig.initializeAdapterInstance("ajax", AjaxHttpClientAdapter.adapterName, true);
    };
    AjaxHttpClientAdapter.prototype.initialize = function () { };
    AjaxHttpClientAdapter.prototype.ajax = function (config) {
        if (!this.http) {
            throw new Error('Unable to locate angular http module for ajax adapter');
        }
        // merge default DataSetAdapter Settings with config arg
        if (!core.isEmpty(this.defaultSettings)) {
            var compositeConfig = core.extend({}, this.defaultSettings);
            config = core.extend(compositeConfig, config);
            // extend is shallow; extend headers separately
            var headers_1 = core.extend({}, this.defaultSettings['headers']); // copy default headers 1st
            config['headers'] = core.extend(headers_1, config.headers);
        }
        if (config.crossDomain) {
            throw new Error(this.name + ' does not support JSONP (crossDomain) requests');
        }
        var url = config.url;
        if (!core.isEmpty(config.params)) {
            // Hack: Not sure how Angular handles writing 'search' parameters to the url.
            // so this approach takes over the url param writing completely.
            var delim = (url.indexOf('?') >= 0) ? '&' : '?';
            url = url + delim + encodeParams(config.params);
        }
        var headers = new HttpHeaders(config.headers || {});
        if (!headers.has('Content-Type')) {
            if (config.type !== 'GET' && config.type !== 'DELETE' && !!config.contentType) {
                headers = headers.set('Content-Type', config.contentType || 'application/json; charset=utf-8');
            }
        }
        var body = config.data;
        var request = new HttpRequest((config.type || 'GET').toUpperCase(), url, body, { headers: headers, responseType: "text" });
        var requestInfo = {
            adapter: this,
            request: request,
            dsaConfig: config,
            success: successFn,
            error: errorFn // adapter's error callback
        };
        if (core.isFunction(this.requestInterceptor)) {
            this.requestInterceptor(requestInfo);
            if (this.requestInterceptor['oneTime']) {
                this.requestInterceptor = null;
            }
        }
        if (requestInfo.request) { // exists unless requestInterceptor killed it.
            var ffilter = filter(function (response) { return response instanceof HttpResponse; });
            var fmap = map(extractData);
            fmap(ffilter(this.http.request(requestInfo.request)))
                .forEach(requestInfo.success)
                .catch(requestInfo.error);
        }
        function extractData(event) {
            var response = event;
            var data;
            var dt = requestInfo.dsaConfig.dataType;
            // beware:`res.json` and `res.text` will be async some day
            if (dt && dt !== 'json') {
                data = response.body;
            }
            else {
                data = JSON.parse(response.body);
            }
            return { data: data, response: response };
        }
        function successFn(arg) {
            if (arg.response.status < 200 || arg.response.status >= 300) {
                throw { data: arg.data, response: arg.response };
            }
            var httpResponse = {
                config: requestInfo.request,
                data: arg.data,
                getHeaders: makeGetHeaders(arg.response.headers),
                status: arg.response.status
            };
            httpResponse['ngConfig'] = requestInfo.request;
            httpResponse['statusText'] = arg.response.statusText;
            httpResponse['response'] = arg.response;
            config.success(httpResponse);
        }
        function errorFn(response) {
            if (response instanceof Error) {
                throw response; // program error; nothing we can do
            }
            else {
                var data = void 0;
                if (response.error instanceof HttpResponse) {
                    data = response.error.body;
                }
                else if (response.error instanceof Error) {
                    data = response.error.message;
                }
                else {
                    data = response.error;
                }
                // Timeout appears as an error with status===0 and no data.
                if (response.status === 0 && data == null) {
                    data = 'timeout';
                }
                var errorMessage = response.status + ": " + response.statusText;
                if (data && typeof data === 'object') {
                    data["message"] = data["message"] || errorMessage; // breeze looks at the message property
                }
                if (!data) {
                    data = errorMessage; // Return the error message as data
                }
                var httpResponse = {
                    config: requestInfo.request,
                    data: data,
                    getHeaders: makeGetHeaders(response.headers),
                    status: response.status
                };
                httpResponse['ngConfig'] = requestInfo.request;
                httpResponse['statusText'] = response.statusText;
                httpResponse['response'] = response;
                config.error(httpResponse); // send error to breeze error handler
            }
        }
    };
    AjaxHttpClientAdapter.adapterName = 'httpclient';
    return AjaxHttpClientAdapter;
}());
export { AjaxHttpClientAdapter };
///// Helpers ////
function encodeParams(obj) {
    var query = '';
    var subValue, innerObj, fullSubName;
    for (var name_1 in obj) {
        if (!obj.hasOwnProperty(name_1)) {
            continue;
        }
        var value = obj[name_1];
        if (value instanceof Array) {
            for (var i = 0; i < value.length; ++i) {
                subValue = value[i];
                fullSubName = name_1 + '[' + i + ']';
                innerObj = {};
                innerObj[fullSubName] = subValue;
                query += encodeParams(innerObj) + '&';
            }
        }
        else if (value && value.toISOString) { // a feature of Date-like things
            query += encodeURIComponent(name_1) + '=' + encodeURIComponent(value.toISOString()) + '&';
        }
        else if (value instanceof Object) {
            for (var subName in value) {
                if (obj.hasOwnProperty(name_1)) {
                    subValue = value[subName];
                    fullSubName = name_1 + '[' + subName + ']';
                    innerObj = {};
                    innerObj[fullSubName] = subValue;
                    query += encodeParams(innerObj) + '&';
                }
            }
        }
        else if (value === null) {
            query += encodeURIComponent(name_1) + '=&';
        }
        else if (value !== undefined) {
            query += encodeURIComponent(name_1) + '=' + encodeURIComponent(value) + '&';
        }
    }
    return query.length ? query.substr(0, query.length - 1) : query;
}
function makeGetHeaders(headers) {
    return function getHeaders(headerName) { return headers.getAll(headerName).join('\r\n'); };
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYWRhcHRlci1hamF4LWh0dHBjbGllbnQuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9icmVlemUtY2xpZW50L2FkYXB0ZXItYWpheC1odHRwY2xpZW50LyIsInNvdXJjZXMiOlsiYWRhcHRlci1hamF4LWh0dHBjbGllbnQudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUE0QyxXQUFXLEVBQUUsV0FBVyxFQUFFLFlBQVksRUFBRSxNQUFNLHNCQUFzQixDQUFDO0FBQ3hILE9BQU8sRUFBYyxNQUFNLEVBQUUsSUFBSSxFQUFvRCxNQUFNLGVBQWUsQ0FBQztBQUMzRyxPQUFPLEVBQUUsTUFBTSxFQUFFLEdBQUcsRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBRTdDO0lBTUUsK0JBQW1CLElBQWdCO1FBQWhCLFNBQUksR0FBSixJQUFJLENBQVk7UUFKbkMsU0FBSSxHQUFHLHFCQUFxQixDQUFDLFdBQVcsQ0FBQztRQUN6QyxvQkFBZSxHQUFHLEVBQUUsQ0FBQztJQUdrQixDQUFDO0lBRWpDLDhCQUFRLEdBQWYsVUFBZ0IsSUFBZ0IsRUFBRSxZQUEyQjtRQUMzRCxZQUFZLEdBQUcsWUFBWSxJQUFJLE1BQU0sQ0FBQztRQUN0QyxZQUFZLENBQUMsZUFBZSxDQUFDLE1BQU0sRUFBTyxjQUFjLE9BQU8sSUFBSSxxQkFBcUIsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO1FBQ25HLE9BQU8sWUFBWSxDQUFDLHlCQUF5QixDQUFDLE1BQU0sRUFBRSxxQkFBcUIsQ0FBQyxXQUFXLEVBQUUsSUFBSSxDQUEwQixDQUFDO0lBQzFILENBQUM7SUFFRCwwQ0FBVSxHQUFWLGNBQWUsQ0FBQztJQUVoQixvQ0FBSSxHQUFKLFVBQUssTUFBa0I7UUFDckIsSUFBSSxDQUFDLElBQUksQ0FBQyxJQUFJLEVBQUU7WUFDZCxNQUFNLElBQUksS0FBSyxDQUFDLHVEQUF1RCxDQUFDLENBQUM7U0FDMUU7UUFFRCx3REFBd0Q7UUFDeEQsSUFBSSxDQUFDLElB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QUksQ0FBQztTQUMxQzthQUFNLElBQUksS0FBSyxLQUFLLFNBQVMsRUFBRTtZQUM5QixLQUFLLElBQUksa0JBQWtCLENBQUMsTUFBSSxDQUFDLEdBQUcsR0FBRyxHQUFHLGtCQUFrQixDQUFDLEtBQUssQ0FBQyxHQUFHLEdBQUcsQ0FBQztTQUMzRTtLQUNGO0lBRUQsT0FBTyxLQUFLLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQyxLQUFLLENBQUMsTUFBTSxDQUFDLENBQUMsRUFBRSxLQUFLLENBQUMsTUFBTSxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxLQUFLLENBQUM7QUFDbEUsQ0FBQztBQUVELFNBQVMsY0FBYyxDQUFDLE9BQW9CO0lBQzFDLE9BQU8sU0FBUyxVQUFVLENBQUMsVUFBbUIsSUFBSSxPQUFPLE9BQU8sQ0FBQyxNQUFNLENBQUMsVUFBVSxDQUFDLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO0FBQ3RHLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBIdHRwQ2xpZW50LCBIdHRwRXJyb3JSZXNwb25zZSwgSHR0cEV2ZW50LCBIdHRwSGVhZGVycywgSHR0cFJlcXVlc3QsIEh0dHBSZXNwb25zZSB9IGZyb20gXCJAYW5ndWxhci9jb21tb24vaHR0cFwiO1xyXG5pbXBvcnQgeyBBamF4Q29uZmlnLCBjb25maWcsIGNvcmUsIEh0dHBSZXNwb25zZSBhcyBCcmVlemVIdHRwUmVzcG9uc2UsIEJyZWV6ZUNvbmZpZyB9IGZyb20gXCJicmVlemUtY2xpZW50XCI7XHJcbmltcG9ydCB7IGZpbHRlciwgbWFwIH0gZnJvbSBcInJ4anMvb3BlcmF0b3JzXCI7XHJcblxyXG5leHBvcnQgY2xhc3MgQWpheEh0dHBDbGllbnRBZGFwdGVyIHtcclxuICBzdGF0aWMgYWRhcHRlck5hbWUgPSAnaHR0cGNsaWVudCc7XHJcbiAgbmFtZSA9IEFqYXhIdHRwQ2xpZW50QWRhcHRlci5hZGFwdGVyTmFtZTtcclxuICBkZWZhdWx0U2V0dGluZ3MgPSB7fTtcclxuICByZXF1ZXN0SW50ZXJjZXB0b3I6IChpbmZvOiB7fSkgPT4ge307XHJcblxyXG4gIGNvbnN0cnVjdG9yKHB1YmxpYyBodHRwOiBIdHRwQ2xpZW50KSB7IH1cclxuXHJcbiAgc3RhdGljIHJlZ2lzdGVyKGh0dHA6IEh0dHBDbGllbnQsIGJyZWV6ZUNvbmZpZz86IEJyZWV6ZUNvbmZpZykge1xyXG4gICAgYnJlZXplQ29uZmlnID0gYnJlZXplQ29uZmlnIHx8IGNvbmZpZztcclxuICAgIGJyZWV6ZUNvbmZpZy5yZWdpc3RlckFkYXB0ZXIoXCJhamF4XCIsIDxhbnk+ZnVuY3Rpb24gKCkgeyByZXR1cm4gbmV3IEFqYXhIdHRwQ2xpZW50QWRhcHRlcihodHRwKTsgfSk7XHJcbiAgICByZXR1cm4gYnJlZXplQ29uZmlnLmluaXRpYWxpemVBZGFwdGVySW5zdGFuY2UoXCJhamF4XCIsIEFqYXhIdHRwQ2xpZW50QWRhcHRlci5hZGFwdGVyTmFtZSwgdHJ1ZSkgYXMgQWpheEh0dHBDbGllbnRBZGFwdGVyO1xyXG4gIH1cclxuXHJcbiAgaW5pdGlhbGl6ZSgpIHsgfVxyXG5cclxuICBhamF4KGNvbmZpZzogQWpheENvbmZpZykge1xyXG4gICAgaWYgKCF0aGlzLmh0dHApIHtcclxuICAgICAgdGhyb3cgbmV3IEVycm9yKCdVbmFibGUgdG8gbG9jYXRlIGFuZ3VsYXIgaHR0cCBtb2R1bGUgZm9yIGFqYXggYWRhcHRlcicpO1xyXG4gICAgfVxyXG5cclxuICAgIC8vIG1lcmdlIGRlZmF1bHQgRGF0YVNldEFkYXB0ZXIgU2V0dGluZ3Mgd2l0aCBjb25maWcgYXJnXHJcbiAgICBpZiAoIWNvcmUuaXNFbXB0eSh0aGlzLmRlZmF1bHRTZXR0aW5ncykpIHtcclxuICAgICAgbGV0IGNvbXBvc2l0ZUNvbmZpZyA9IGNvcmUuZXh0ZW5kKHt9LCB0aGlzLmRlZmF1bHRTZXR0aW5ncyk7XHJcbiAgICAgIGNvbmZpZyA9IDxBamF4Q29uZmlnPmNvcmUuZXh0ZW5kKGNvbXBvc2l0ZUNvbmZpZywgY29uZmlnKTtcclxuICAgICAgLy8gZXh0ZW5kIGlzIHNoYWxsb3c7IGV4dGVuZCBoZWFkZXJzIHNlcGFyYXRlbHlcclxuICAgICAgbGV0IGhlYWRlcnMgPSBjb3JlLmV4dGVuZCh7fSwgdGhpcy5kZWZhdWx0U2V0dGluZ3NbJ2hlYWRlcnMnXSk7IC8vIGNvcHkgZGVmYXVsdCBoZWFkZXJzIDFzdFxyXG4gICAgICBjb25maWdbJ2hlYWRlcnMnXSA9IGNvcmUuZXh0ZW5kKGhlYWRlcnMsIGNvbmZpZy5oZWFkZXJzKTtcclxuICAgIH1cclxuXHJcbiAgICBpZiAoY29uZmlnLmNyb3NzRG9tYWluKSB7XHJcbiAgICAgIHRocm93IG5ldyBFcnJvcih0aGlzLm5hbWUgKyAnIGRvZXMgbm90IHN1cHBvcnQgSlNPTlAgKGNyb3NzRG9tYWluKSByZXF1ZXN0cycpO1xyXG4gICAgfVxyXG5cclxuICAgIGxldCB1cmwgPSBjb25maWcudXJsO1xyXG4gICAgaWYgKCFjb3JlLmlzRW1wdHkoY29uZmlnLnBhcmFtcykpIHtcclxuICAgICAgLy8gSGFjazogTm90IHN1cmUgaG93IEFuZ3VsYXIgaGFuZGxlcyB3cml0aW5nICdzZWFyY2gnIHBhcmFtZXRlcnMgdG8gdGhlIHVybC5cclxuICAgICAgLy8gc28gdGhpcyBhcHByb2FjaCB0YWtlcyBvdmVyIHRoZSB1cmwgcGFyYW0gd3JpdGluZyBjb21wbGV0ZWx5LlxyXG4gICAgICBsZXQgZGVsaW0gPSAodXJsLmluZGV4T2YoJz8nKSA+PSAwKSA/ICcmJyA6ICc/JztcclxuICAgICAgdXJsID0gdXJsICsgZGVsaW0gKyBlbmNvZGVQYXJhbXMoY29uZmlnLnBhcmFtcyk7XHJcbiAgICB9XHJcblxyXG4gICAgbGV0IGhlYWRlcnMgPSBuZXcgSHR0cEhlYWRlcnMoY29uZmlnLmhlYWRlcnMgfHwge30pO1xyXG4gICAgaWYgKCFoZWFkZXJzLmhhcygnQ29udGVudC1UeXBlJykpIHtcclxuICAgICAgaWYgKGNvbmZpZy50eXBlICE9PSAnR0VUJyAmJiBjb25maWcudHlwZSAhPT0gJ0RFTEVURScgJiYgISFjb25maWcuY29udGVudFR5cGUpIHtcclxuICAgICAgICBoZWFkZXJzID0gaGVhZGVycy5zZXQoJ0NvbnRlbnQtVHlwZScsXHJcbiAgICAgICAgICA8c3RyaW5nPmNvbmZpZy5jb250ZW50VHlwZSB8fCAnYXBwbGljYXRpb24vanNvbjsgY2hhcnNldD11dGYtOCcpO1xyXG4gICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgbGV0IGJvZHk6IGFueSA9IGNvbmZpZy5kYXRhO1xyXG4gICAgbGV0IHJlcXVlc3QgPSBuZXcgSHR0cFJlcXVlc3QoKGNvbmZpZy50eXBlIHx8ICdHRVQnKS50b1VwcGVyQ2FzZSgpLCB1cmwsIGJvZHksIHsgaGVhZGVyczogaGVhZGVycywgcmVzcG9uc2VUeXBlOiBcInRleHRcIiB9KTtcclxuXHJcbiAgICBsZXQgcmVxdWVzdEluZm8gPSB7XHJcbiAgICAgIGFkYXB0ZXI6IHRoaXMsICAgICAgLy8gdGhpcyBhZGFwdGVyXHJcbiAgICAgIHJlcXVlc3Q6IHJlcXVlc3QsICAgLy8gdGhlIGh0dHAgcmVxdWVzdCBmcm9tIHRoZSByZXF1ZXN0T3B0aW9uc1xyXG4gICAgICBkc2FDb25maWc6IGNvbmZpZywgIC8vIHRoZSBjb25maWcgYXJnIGZyb20gdGhlIGNhbGxpbmcgQnJlZXplIERhdGFTZXJ2aWNlQWRhcHRlclxyXG4gICAgICBzdWNjZXNzOiBzdWNjZXNzRm4sIC8vIGFkYXB0ZXIncyBzdWNjZXNzIGNhbGxiYWNrXHJcbiAgICAgIGVycm9yOiBlcnJvckZuICAgICAgLy8gYWRhcHRlcidzIGVycm9yIGNhbGxiYWNrXHJcbiAgICB9O1xyXG5cclxuICAgIGlmIChjb3JlLmlzRnVuY3Rpb24odGhpcy5yZXF1ZXN0SW50ZXJjZXB0b3IpKSB7XHJcbiAgICAgIHRoaXMucmVxdWVzdEludGVyY2VwdG9yKHJlcXVlc3RJbmZvKTtcclxuICAgICAgaWYgKHRoaXMucmVxdWVzdEludGVyY2VwdG9yWydvbmVUaW1lJ10pIHtcclxuICAgICAgICB0aGlzLnJlcXVlc3RJbnRlcmNlcHRvciA9IG51bGw7XHJcbiAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICBpZiAocmVxdWVzdEluZm8ucmVxdWVzdCkgeyAvLyBleGlzdHMgdW5sZXNzIHJlcXVlc3RJbnRlcmNlcHRvciBraWxsZWQgaXQuXHJcbiAgICAgIGNvbnN0IGZmaWx0ZXIgPSBmaWx0ZXIoKHJlc3BvbnNlOiBIdHRwRXZlbnQ8YW55PikgPT4gcmVzcG9uc2UgaW5zdGFuY2VvZiBIdHRwUmVzcG9uc2UpO1xyXG4gICAgICBjb25zdCBmbWFwID0gbWFwKGV4dHJhY3REYXRhKTtcclxuXHJcbiAgICAgIGZtYXAoZmZpbHRlcih0aGlzLmh0dHAucmVxdWVzdChyZXF1ZXN0SW5mby5yZXF1ZXN0KSkpXHJcbiAgICAgICAgLmZvckVhY2gocmVxdWVzdEluZm8uc3VjY2VzcylcclxuICAgICAgICAuY2F0Y2gocmVxdWVzdEluZm8uZXJyb3IpO1xyXG4gICAgfVxyXG5cclxuICAgIGZ1bmN0aW9uIGV4dHJhY3REYXRhKGV2ZW50OiBIdHRwRXZlbnQ8YW55Pikge1xyXG4gICAgICBsZXQgcmVzcG9uc2UgPSBldmVudCBhcyBIdHRwUmVzcG9uc2U8YW55PjtcclxuICAgICAgbGV0IGRhdGE6IGFueTtcclxuICAgICAgbGV0IGR0ID0gcmVxdWVzdEluZm8uZHNhQ29uZmlnLmRhdGFUeXBlO1xyXG4gICAgICAvLyBiZXdhcmU6YHJlcy5qc29uYCBhbmQgYHJlcy50ZXh0YCB3aWxsIGJlIGFzeW5jIHNvbWUgZGF5XHJcbiAgICAgIGlmIChkdCAmJiBkdCAhPT0gJ2pzb24nKSB7XHJcbiAgICAgICAgZGF0YSA9IHJlc3BvbnNlLmJvZHk7XHJcbiAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgZGF0YSA9IEpTT04ucGFyc2UocmVzcG9uc2UuYm9keSk7XHJcbiAgICAgIH1cclxuICAgICAgcmV0dXJuIHsgZGF0YSwgcmVzcG9uc2UgfTtcclxuICAgIH1cclxuXHJcbiAgICBmdW5jdGlvbiBzdWNjZXNzRm4oYXJnOiB7IGRhdGE6IGFueSwgcmVzcG9uc2U6IEh0dHBSZXNwb25zZTxhbnk+IH0pIHtcclxuICAgICAgaWYgKGFyZy5yZXNwb25zZS5zdGF0dXMgPCAyMDAgfHwgYXJnLnJlc3BvbnNlLnN0YXR1cyA+PSAzMDApIHtcclxuICAgICAgICB0aHJvdyB7IGRhdGE6IGFyZy5kYXRhLCByZXNwb25zZTogYXJnLnJlc3BvbnNlIH07XHJcbiAgICAgIH1cclxuXHJcbiAgICAgIGxldCBodHRwUmVzcG9uc2U6IEJyZWV6ZUh0dHBSZXNwb25zZSA9IHtcclxuICAgICAgICBjb25maWc6IHJlcXVlc3RJbmZvLnJlcXVlc3QsXHJcbiAgICAgICAgZGF0YTogYXJnLmRhdGEsXHJcbiAgICAgICAgZ2V0SGVhZGVyczogbWFrZUdldEhlYWRlcnMoYXJnLnJlc3BvbnNlLmhlYWRlcnMpLFxyXG4gICAgICAgIHN0YXR1czogYXJnLnJlc3BvbnNlLnN0YXR1c1xyXG4gICAgICB9O1xyXG4gICAgICBodHRwUmVzcG9uc2VbJ25nQ29uZmlnJ10gPSByZXF1ZXN0SW5mby5yZXF1ZXN0O1xyXG4gICAgICBodHRwUmVzcG9uc2VbJ3N0YXR1c1RleHQnXSA9IGFyZy5yZXNwb25zZS5zdGF0dXNUZXh0O1xyXG4gICAgICBodHRwUmVzcG9uc2VbJ3Jlc3BvbnNlJ10gPSBhcmcucmVzcG9uc2U7XHJcbiAgICAgIGNvbmZpZy5zdWNjZXNzKGh0dHBSZXNwb25zZSk7XHJcbiAgICB9XHJcblxyXG4gICAgZnVuY3Rpb24gZXJyb3JGbihyZXNwb25zZTogSHR0cEVycm9yUmVzcG9uc2UpIHtcclxuICAgICAgaWYgKHJlc3BvbnNlIGluc3RhbmNlb2YgRXJyb3IpIHtcclxuICAgICAgICB0aHJvdyByZXNwb25zZTsgLy8gcHJvZ3JhbSBlcnJvcjsgbm90aGluZyB3ZSBjYW4gZG9cclxuICAgICAgfSBlbHNlIHtcclxuICAgICAgICBsZXQgZGF0YTogYW55O1xyXG4gICAgICAgIGlmIChyZXNwb25zZS5lcnJvciBpbnN0YW5jZW9mIEh0dHBSZXNwb25zZSkge1xyXG4gICAgICAgICAgZGF0YSA9IHJlc3BvbnNlLmVycm9yLmJvZHk7XHJcbiAgICAgICAgfSBlbHNlIGlmIChyZXNwb25zZS5lcnJvciBpbnN0YW5jZW9mIEVycm9yKSB7XHJcbiAgICAgICAgICBkYXRhID0gcmVzcG9uc2UuZXJyb3IubWVzc2FnZTtcclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgZGF0YSA9IHJlc3BvbnNlLmVycm9yO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgLy8gVGltZW91dCBhcHBlYXJzIGFzIGFuIGVycm9yIHdpdGggc3RhdHVzPT09MCBhbmQgbm8gZGF0YS5cclxuICAgICAgICBpZiAocmVzcG9uc2Uuc3RhdHVzID09PSAwICYmIGRhdGEgPT0gbnVsbCkge1xyXG4gICAgICAgICAgZGF0YSA9ICd0aW1lb3V0JztcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGxldCBlcnJvck1lc3NhZ2UgPSByZXNwb25zZS5zdGF0dXMgKyBcIjogXCIgKyByZXNwb25zZS5zdGF0dXNUZXh0O1xyXG4gICAgICAgIGlmIChkYXRhICYmIHR5cGVvZiBkYXRhID09PSAnb2JqZWN0Jykge1xyXG4gICAgICAgICAgZGF0YVtcIm1lc3NhZ2VcIl0gPSBkYXRhW1wibWVzc2FnZVwiXSB8fCBlcnJvck1lc3NhZ2U7ICAvLyBicmVlemUgbG9va3MgYXQgdGhlIG1lc3NhZ2UgcHJvcGVydHlcclxuICAgICAgICB9XHJcbiAgICAgICAgaWYgKCFkYXRhKSB7XHJcbiAgICAgICAgICBkYXRhID0gZXJyb3JNZXNzYWdlOyAgIC8vIFJldHVybiB0aGUgZXJyb3IgbWVzc2FnZSBhcyBkYXRhXHJcbiAgICAgICAgfVxyXG4gICAgICAgIGxldCBodHRwUmVzcG9uc2U6IEJyZWV6ZUh0dHBSZXNwb25zZSA9IHtcclxuICAgICAgICAgIGNvbmZpZzogcmVxdWVzdEluZm8ucmVxdWVzdCxcclxuICAgICAgICAgIGRhdGE6IGRhdGEsXHJcbiAgICAgICAgICBnZXRIZWFkZXJzOiBtYWtlR2V0SGVhZGVycyhyZXNwb25zZS5oZWFkZXJzKSxcclxuICAgICAgICAgIHN0YXR1czogcmVzcG9uc2Uuc3RhdHVzXHJcbiAgICAgICAgfTtcclxuICAgICAgICBodHRwUmVzcG9uc2VbJ25nQ29uZmlnJ10gPSByZXF1ZXN0SW5mby5yZXF1ZXN0O1xyXG4gICAgICAgIGh0dHBSZXNwb25zZVsnc3RhdHVzVGV4dCddID0gcmVzcG9uc2Uuc3RhdHVzVGV4dDtcclxuICAgICAgICBodHRwUmVzcG9uc2VbJ3Jlc3BvbnNlJ10gPSByZXNwb25zZTtcclxuXHJcbiAgICAgICAgY29uZmlnLmVycm9yKGh0dHBSZXNwb25zZSk7IC8vIHNlbmQgZXJyb3IgdG8gYnJlZXplIGVycm9yIGhhbmRsZXJcclxuICAgICAgfVxyXG4gICAgfVxyXG4gIH1cclxuXHJcbn1cclxuXHJcbi8vLy8vIEhlbHBlcnMgLy8vL1xyXG5cclxuZnVuY3Rpb24gZW5jb2RlUGFyYW1zKG9iajoge30pIHtcclxuICBsZXQgcXVlcnkgPSAnJztcclxuICBsZXQgc3ViVmFsdWU6IGFueSwgaW5uZXJPYmo6IGFueSwgZnVsbFN1Yk5hbWU6IGFueTtcclxuXHJcbiAgZm9yIChsZXQgbmFtZSBpbiBvYmopIHtcclxuICAgIGlmICghb2JqLmhhc093blByb3BlcnR5KG5hbWUpKSB7IGNvbnRpbnVlOyB9XHJcblxyXG4gICAgbGV0IHZhbHVlID0gb2JqW25hbWVdO1xyXG5cclxuICAgIGlmICh2YWx1ZSBpbnN0YW5jZW9mIEFycmF5KSB7XHJcbiAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgdmFsdWUubGVuZ3RoOyArK2kpIHtcclxuICAgICAgICBzdWJWYWx1ZSA9IHZhbHVlW2ldO1xyXG4gICAgICAgIGZ1bGxTdWJOYW1lID0gbmFtZSArICdbJyArIGkgKyAnXSc7XHJcbiAgICAgICAgaW5uZXJPYmogPSB7fTtcclxuICAgICAgICBpbm5lck9ialtmdWxsU3ViTmFtZV0gPSBzdWJWYWx1ZTtcclxuICAgICAgICBxdWVyeSArPSBlbmNvZGVQYXJhbXMoaW5uZXJPYmopICsgJyYnO1xyXG4gICAgICB9XHJcbiAgICB9IGVsc2UgaWYgKHZhbHVlICYmIHZhbHVlLnRvSVNPU3RyaW5nKSB7IC8vIGEgZmVhdHVyZSBvZiBEYXRlLWxpa2UgdGhpbmdzXHJcbiAgICAgIHF1ZXJ5ICs9IGVuY29kZVVSSUNvbXBvbmVudChuYW1lKSArICc9JyArIGVuY29kZVVSSUNvbXBvbmVudCh2YWx1ZS50b0lTT1N0cmluZygpKSArICcmJztcclxuICAgIH0gZWxzZSBpZiAodmFsdWUgaW5zdGFuY2VvZiBPYmplY3QpIHtcclxuICAgICAgZm9yIChsZXQgc3ViTmFtZSBpbiB2YWx1ZSkge1xyXG4gICAgICAgIGlmIChvYmouaGFzT3duUHJvcGVydHkobmFtZSkpIHtcclxuICAgICAgICAgIHN1YlZhbHVlID0gdmFsdWVbc3ViTmFtZV07XHJcbiAgICAgICAgICBmdWxsU3ViTmFtZSA9IG5hbWUgKyAnWycgKyBzdWJOYW1lICsgJ10nO1xyXG4gICAgICAgICAgaW5uZXJPYmogPSB7fTtcclxuICAgICAgICAgIGlubmVyT2JqW2Z1bGxTdWJOYW1lXSA9IHN1YlZhbHVlO1xyXG4gICAgICAgICAgcXVlcnkgKz0gZW5jb2RlUGFyYW1zKGlubmVyT2JqKSArICcmJztcclxuICAgICAgICB9XHJcbiAgICAgIH1cclxuICAgIH0gZWxzZSBpZiAodmFsdWUgPT09IG51bGwpIHtcclxuICAgICAgcXVlcnkgKz0gZW5jb2RlVVJJQ29tcG9uZW50KG5hbWUpICsgJz0mJztcclxuICAgIH0gZWxzZSBpZiAodmFsdWUgIT09IHVuZGVmaW5lZCkge1xyXG4gICAgICBxdWVyeSArPSBlbmNvZGVVUklDb21wb25lbnQobmFtZSkgKyAnPScgKyBlbmNvZGVVUklDb21wb25lbnQodmFsdWUpICsgJyYnO1xyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgcmV0dXJuIHF1ZXJ5Lmxlbmd0aCA/IHF1ZXJ5LnN1YnN0cigwLCBxdWVyeS5sZW5ndGggLSAxKSA6IHF1ZXJ5O1xyXG59XHJcblxyXG5mdW5jdGlvbiBtYWtlR2V0SGVhZGVycyhoZWFkZXJzOiBIdHRwSGVhZGVycykge1xyXG4gIHJldHVybiBmdW5jdGlvbiBnZXRIZWFkZXJzKGhlYWRlck5hbWU/OiBzdHJpbmcpIHsgcmV0dXJuIGhlYWRlcnMuZ2V0QWxsKGhlYWRlck5hbWUpLmpvaW4oJ1xcclxcbicpOyB9O1xyXG59Il19