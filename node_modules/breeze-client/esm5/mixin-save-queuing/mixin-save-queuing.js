import * as tslib_1 from "tslib";
//#region Copyright, Version, and Description
/*
 * Copyright 2015-2019 IdeaBlade, Inc.  All Rights Reserved.
 * Use, reproduction, distribution, and modification of this code is subject to the terms and
 * conditions of the IdeaBlade Breeze license, available at http://www.breezejs.com/license
 *
 * Author: Ward Bell
 * Version: 2.0.6 Steve Schmitt - convert to TypeScript, move to breeze-client repo, change enableSaveQueuing function
 * Version: 2.0.5 Ward Bell
 * --------------------------------------------------------------------------------
 * Adds "Save Queuing" capability to new EntityManagers
 *
 * Save Queuing automatically queues and defers an EntityManager.saveChanges call
 * when another save is in progress for that manager and the server has not yet responded.
 * This feature is helpful when your app needs to allow rapid, continuous changes
 * to entities that may be in the process of being saved.
 *
 * Without "Save Queuing", an EntityManager will throw an exception
 * when you call saveChanges for an entity which is currently being saved.
 *
 * !!! Use with caution !!!
 * It is usually better to disable user input while a save is in progress.
 * Save Queuing may be appropriate for simple "auto-save" scenarios
 * when the save latency is "short" (under a few seconds).
 *
 * Save Queuing is NOT intended for occassionally disconnected or offline scenarios.
 *
 * Save Queuing is experimental. It will not become a part of BreezeJS core
 * but might become an official Breeze plugin in future
 * although not necessarily in this form or with this API
 *
 * Must call EntityManager.enableSaveQueuing(true) to turn it on;
 * EntityManager.enableSaveQueuing(false) restores the manager's original
 * saveChanges method as it was at the time saveQueuing was first enabled.
 *
 * This module adds "enableSaveQueuing" to the EntityManager prototype.
 * Calling "enableSaveQueuing(true)" adds a new _saveQueuing object
 * to the manager instance.
 *
 * See DocCode:saveQueuingTests.js
 * https://github.com/Breeze/breeze.js.samples/blob/master/net/DocCode/DocCode/tests/saveQueuingTests.js
 *
 * LIMITATIONS
 * - Can't handle changes to the primary key (dangerous in any case)
 * - Assumes promises. Does not support the (deprecated) success and fail callbacks
 * - Does not queue saveOptions. The first one is re-used for all queued saves.
 * - Does not deal with export/import of entities while save is inflight
 * - Does not deal with rejectChanges while save is in flight
 * - Does not support parallel saves even when the change-sets are independent.
 *   The native saveChanges allows such saves.
 *   SaveQueuing does not; too complex and doesn't fit the primary scenario anyway.
 * - The resolved saveResult is the saveResult of the last completed save
 * - A queued save that might have succeeded if saved immediately
 *   may fail because the server no longer accepts it later
 * - Prior to Breeze v.1.5.3, a queued save that might have succeeded
 *   if saved immediately will fail if subsequently attempt to save
 *   an invalid entity. Can detect and circumvent after v.1.5.3.
 *
 * All members of EntityManager._saveQueuing are internal;
 * touch them at your own risk.
 */
//#endregion
import { EntityState, breeze } from 'breeze-client';
export function enableSaveQueuing(em, enable) {
    if (enable === void 0) { enable = true; }
    var saveQueuing = em['_saveQueueing'] ||
        (em['_saveQueuing'] = new SaveQueuing(em));
    enable = (enable === undefined) ? true : enable;
    saveQueuing._isEnabled = enable;
    if (enable) {
        // delegate to save changes queuing
        em.saveChanges = saveChangesWithQueuing;
    }
    else {
        // revert to the native EntityManager.saveChanges
        em.saveChanges = em['_saveQueuing'].baseSaveChanges;
    }
}
/**
 * Replacement for EntityManager.saveChanges
 * This version queues saveChanges calls while a real save is in progress
 **/
function saveChangesWithQueuing(entities, saveOptions) {
    try {
        // `this` is an EntityManager
        var saveQueuing = this._saveQueuing;
        if (saveQueuing.isSaving) {
            // save in progress; queue the save for later
            return saveQueuing.queueSaveChanges(entities);
        }
        else {
            // note that save is in progress; then save
            saveQueuing.isSaving = true;
            saveQueuing.saveOptions = saveOptions;
            return saveQueuing.saveChanges(entities, saveOptions);
        }
    }
    catch (err) {
        return Promise.reject(err);
    }
}
///////// SaveQueuing /////////
var SaveQueuing = /** @class */ (function () {
    function SaveQueuing(entityManager) {
        this.entityManager = entityManager;
        this.baseSaveChanges = entityManager.saveChanges;
        this.isSaving = false;
    }
    SaveQueuing.prototype.isEnabled = function () {
        return this._isEnabled;
    };
    SaveQueuing.prototype.getSavedNothingResult = function () {
        return { entities: [], keyMappings: [] };
    };
    SaveQueuing.prototype.queueSaveChanges = function (entities) {
        var self = this; // `this` is a SaveQueuing
        var em = self.entityManager;
        var changes = entities || em.getChanges();
        if (changes.length === 0) {
            return Promise.resolve(this.getSavedNothingResult());
        }
        var valError = em.saveChangesValidateOnClient(changes);
        if (valError) {
            return Promise.reject(valError);
        }
        var saveMemo = self.nextSaveMemo || (self.nextSaveMemo = new SaveMemo());
        memoizeChanges();
        var deferred = self.nextSaveDeferred || (self.nextSaveDeferred = new Deferred());
        return deferred.promise;
        function memoizeChanges() {
            if (changes.length === 0) {
                return;
            }
            var queuedChanges = saveMemo.queuedChanges;
            changes.forEach(function (e) {
                if (!e.entityAspect.isBeingSaved && queuedChanges.indexOf(e) === -1) {
                    queuedChanges.push(e);
                }
            });
            saveMemo.updateEntityMemos(changes);
        }
    };
    SaveQueuing.prototype.saveChanges = function (entities, saveOptions) {
        var self = this; // `this` is a SaveQueuing
        var promise = self.baseSaveChanges.call(self.entityManager, entities, saveOptions || self.saveOptions)
            .then(function (saveResult) { return self.saveSucceeded(saveResult); })
            .then(null, function (error) { console.log(error); return self.saveFailed(error); });
        rememberAddedOriginalValues(entities); // do it after ... so don't send OrigValues to the server
        return promise;
        function rememberAddedOriginalValues(entities) {
            // added entities normally don't have original values but these will now
            var added = entities ?
                entities.filter(function (e) { return e.entityAspect.entityState.isAdded(); }) :
                self.entityManager.getEntities(null, EntityState.Added);
            added.forEach(function (entity) {
                var props = entity.entityType.dataProperties;
                var originalValues = entity.entityAspect.originalValues;
                props.forEach(function (dp) {
                    if (dp.isPartOfKey) {
                        return;
                    }
                    originalValues[dp.name] = entity.getProperty(dp.name);
                });
            });
        }
    };
    SaveQueuing.prototype.saveSucceeded = function (saveResult) {
        var self = this; // `this` is a SaveQueueing
        var activeSaveDeferred = self.activeSaveDeferred;
        var nextSaveDeferred = self.nextSaveDeferred;
        var nextSaveMemo = self.nextSaveMemo;
        // prepare as if nothing queued or left to save
        self.isSaving = false;
        self.activeSaveDeferred = null;
        self.activeSaveMemo = null;
        self.nextSaveDeferred = null;
        self.nextSaveMemo = null;
        if (nextSaveMemo) {
            // a save was queued since last save returned
            nextSaveMemo.pkFixup(saveResult.keyMappings);
            nextSaveMemo.applyToSavedEntities(self.entityManager, saveResult.entities);
            // remove detached entities from queuedChanges
            var queuedChanges = nextSaveMemo.queuedChanges.filter(function (e) {
                return !e.entityAspect.entityState.isDetached();
            });
            if (queuedChanges.length > 0) {
                // save again
                self.isSaving = true;
                // remember the queued changes that triggered this save
                self.activeSaveDeferred = nextSaveDeferred;
                self.activeSaveMemo = nextSaveMemo;
                self.saveChanges(queuedChanges, this.saveOptions);
            }
            else if (nextSaveDeferred) {
                nextSaveDeferred.resolve(this.getSavedNothingResult());
            }
        }
        if (activeSaveDeferred) {
            activeSaveDeferred.resolve(saveResult);
        }
        return saveResult; // for the current promise chain
    };
    SaveQueuing.prototype.saveFailed = function (error) {
        var self = this; // `this` is a SaveQueueing
        error = new QueuedSaveFailedError(error, self);
        var activeSaveDeferred = self.activeSaveDeferred;
        var nextSaveDeferred = self.nextSaveDeferred;
        self.isSaving = false;
        self.activeSaveDeferred = null;
        self.activeSaveMemo = null;
        self.nextSaveDeferred = null;
        self.nextSaveMemo = null;
        if (activeSaveDeferred) {
            activeSaveDeferred.reject(error);
        }
        if (nextSaveDeferred) {
            nextSaveDeferred.reject(error);
        }
        return Promise.reject(error); // let promise chain hear error
    };
    return SaveQueuing;
}());
/// for backward compat with older Promise implementation
var Deferred = /** @class */ (function () {
    function Deferred() {
        this.promise = new Promise(function (resolve, reject) {
            this.resolve = resolve;
            this.reject = reject;
        }.bind(this));
    }
    return Deferred;
}());
////////// QueuedSaveFailedError /////////
// Error sub-class thrown when rejecting queued saves.
var QueuedSaveFailedError = /** @class */ (function (_super) {
    tslib_1.__extends(QueuedSaveFailedError, _super);
    // Error sub-class thrown when rejecting queued saves.
    // `innerError` is the actual save error
    // `failedSaveMemo` is the saveMemo that prompted this save
    // `nextSaveMemo` holds queued changes accumulated since that save.
    // You may try to recover using this info. Good luck with that.
    function QueuedSaveFailedError(errObject, saveQueuing) {
        var _this = _super.call(this) || this;
        _this.name = "QueuedSaveFailedError";
        _this.innerError = errObject;
        _this.message = "Queued save failed: " + errObject.message;
        _this.failedSaveMemo = saveQueuing.activeSaveMemo;
        _this.nextSaveMemo = saveQueuing.nextSaveMemo;
        return _this;
    }
    return QueuedSaveFailedError;
}(Error));
////////// SaveMemo ////////////////
// SaveMemo is a record of changes for a queued save, consisting of:
//   entityMemos:   info about entities that are being saved and
//                  have been changed since the save started
//   queuedChanges: entities that are queued for save but
//                  are not currently being saved
var SaveMemo = /** @class */ (function () {
    function SaveMemo() {
        this.entityMemos = {};
        this.queuedChanges = [];
    }
    SaveMemo.prototype.applyToSavedEntities = function (entityManager, savedEntities) {
        var _this = this;
        var entityMemos = this.entityMemos; // `this` is a SaveMemo
        var queuedChanges = this.queuedChanges;
        var restorePublishing = this.disableManagerPublishing(entityManager);
        try {
            savedEntities.forEach(function (saved) {
                var key = _this.makeEntityMemoKey(saved);
                var entityMemo = entityMemos[key];
                var resave = entityMemo && entityMemo.applyToSavedEntity(saved);
                if (resave) {
                    queuedChanges.push(saved);
                }
            });
        }
        finally {
            restorePublishing();
            // D#2651 hasChanges will be wrong if changes made while save in progress
            var hasChanges = queuedChanges.length > 0;
            // Must use breeze internal method to properly set this flag true
            if (hasChanges) {
                entityManager._setHasChanges(true);
            }
        }
    };
    SaveMemo.prototype.disableManagerPublishing = function (manager) {
        var Event = breeze.Event;
        Event.enable('entityChanged', manager, false);
        Event.enable('hasChangesChanged', manager, false);
        return function restorePublishing() {
            Event.enable('entityChanged', manager, true);
            Event.enable('hasChangesChanged', manager, true);
        };
    };
    SaveMemo.prototype.pkFixup = function (keyMappings) {
        var entityMemos = this.entityMemos; // `this` is a SaveMemo
        keyMappings.forEach(function (km) {
            var type = km.entityTypeName;
            var tempKey = type + '|' + km.tempValue;
            if (entityMemos[tempKey]) {
                entityMemos[type + '|' + km.realValue] = entityMemos[tempKey];
                delete entityMemos[tempKey];
            }
            for (var memoKey in entityMemos) {
                entityMemos[memoKey].fkFixup(km);
            }
        });
    };
    SaveMemo.prototype.makeEntityMemoKey = function (entity) {
        var entityKey = entity.entityAspect.getKey();
        return entityKey.entityType.name + '|' + entityKey.values;
    };
    SaveMemo.prototype.updateEntityMemos = function (changes) {
        var _this = this;
        var entityMemos = this.entityMemos; // `this` is a SaveMemo
        changes.forEach(function (change) {
            // only update entityMemo for entity being save
            if (!change.entityAspect.isBeingSaved) {
                return;
            }
            var key = _this.makeEntityMemoKey(change);
            var entityMemo = entityMemos[key] || (entityMemos[key] = new EntityMemo(change));
            entityMemo.update(change);
        });
    };
    return SaveMemo;
}());
///////// EntityMemo Type ///////////////
// Information about an entity that is being saved
// and which has been changed since that save started
var EntityMemo = /** @class */ (function () {
    function EntityMemo(entity) {
        this.entity = entity;
        this.pendingChanges = {};
    }
    EntityMemo.prototype.applyToSavedEntity = function (saved) {
        var entityMemo = this;
        var aspect = saved.entityAspect;
        if (aspect.entityState.isDetached()) {
            return false;
        }
        else if (entityMemo.isDeleted) {
            aspect.setDeleted();
            return true;
        }
        // treat entity with pending changes as modified
        var props = Object.keys(entityMemo.pendingChanges);
        if (props.length === 0) {
            return false;
        }
        var originalValues = aspect.originalValues;
        props.forEach(function (name) {
            originalValues[name] = saved.getProperty(name);
            saved.setProperty(name, entityMemo.pendingChanges[name]);
        });
        aspect.setModified();
        return true;
    };
    EntityMemo.prototype.fkFixup = function (keyMapping) {
        var entityMemo = this;
        var type = entityMemo.entity.entityType;
        var fkProps = type.foreignKeyProperties;
        fkProps.forEach(function (fkProp) {
            if (fkProp.parentType.name === keyMapping.entityTypeName &&
                entityMemo.pendingChanges[fkProp.name] === keyMapping.tempValue) {
                entityMemo.pendingChanges[fkProp.name] = keyMapping.realValue;
            }
        });
    };
    // update the entityMemo of changes to an entity being saved
    // so that we know how to save it again later
    EntityMemo.prototype.update = function () {
        var entityMemo = this;
        var props;
        var entity = entityMemo.entity;
        var aspect = entity.entityAspect;
        var stateName = aspect.entityState.name;
        switch (stateName) {
            case 'Added':
                var originalValues_1 = aspect.originalValues;
                props = entity.entityType.dataProperties;
                props.forEach(function (dp) {
                    if (dp.isPartOfKey) {
                        return;
                    }
                    var name = dp.name;
                    var value = entity.getProperty(name);
                    if (originalValues_1[name] !== value) {
                        entityMemo.pendingChanges[name] = value;
                    }
                });
                break;
            case 'Deleted':
                entityMemo.isDeleted = true;
                entityMemo.pendingChanges = {};
                break;
            case 'Modified':
                props = Object.keys(aspect.originalValues);
                props.forEach(function (name) {
                    entityMemo.pendingChanges[name] = entity.getProperty(name);
                });
                break;
        }
    };
    return EntityMemo;
}());
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibWl4aW4tc2F2ZS1xdWV1aW5nLmpzIiwic291cmNlUm9vdCI6Im5nOi8vYnJlZXplLWNsaWVudC9taXhpbi1zYXZlLXF1ZXVpbmcvIiwic291cmNlcyI6WyJtaXhpbi1zYXZlLXF1ZXVpbmcudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IjtBQUFBLDZDQUE2QztBQUM3Qzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7R0EyREc7QUFDSCxZQUFZO0FBQ1osT0FBTyxFQUFxQyxXQUFXLEVBQWMsTUFBTSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBR25HLE1BQU0sVUFBVSxpQkFBaUIsQ0FBQyxFQUFpQixFQUFFLE1BQXNCO0lBQXRCLHVCQUFBLEVBQUEsYUFBc0I7SUFDekUsSUFBSSxXQUFXLEdBQUcsRUFBRSxDQUFDLGVBQWUsQ0FBQztRQUNuQyxDQUFDLEVBQUUsQ0FBQyxjQUFjLENBQUMsR0FBRyxJQUFJLFdBQVcsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDO0lBRTdDLE1BQU0sR0FBRyxDQUFDLE1BQU0sS0FBSyxTQUFTLENBQUMsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxNQUFNLENBQUM7SUFDaEQsV0FBVyxDQUFDLFVBQVUsR0FBRyxNQUFNLENBQUM7SUFDaEMsSUFBSSxNQUFNLEVBQUU7UUFDVixtQ0FBbUM7UUFDbkMsRUFBRSxDQUFDLFdBQVcsR0FBRyxzQkFBc0IsQ0FBQztLQUN6QztTQUFNO1FBQ0wsaURBQWlEO1FBQ2pELEVBQUUsQ0FBQyxXQUFXLEdBQUcsRUFBRSxDQUFDLGNBQWMsQ0FBQyxDQUFDLGVBQWUsQ0FBQztLQUNyRDtBQUNILENBQUM7QUFFRDs7O0lBR0k7QUFDSixTQUFTLHNCQUFzQixDQUFDLFFBQXlCLEVBQUUsV0FBZ0I7SUFDekUsSUFBSTtRQUNGLDZCQUE2QjtRQUM3QixJQUFJLFdBQVcsR0FBRyxJQUFJLENBQUMsWUFBWSxDQUFDO1FBQ3BDLElBQUks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QUFJLENBQUMsQ0FBQztnQkFDN0QsQ0FBQyxDQUFDLENBQUM7Z0JBQ0gsTUFBTTtTQUNUO0lBQ0gsQ0FBQztJQUNILGlCQUFDO0FBQUQsQ0FBQyxBQWhGRCxJQWdGQyIsInNvdXJjZXNDb250ZW50IjpbIi8vI3JlZ2lvbiBDb3B5cmlnaHQsIFZlcnNpb24sIGFuZCBEZXNjcmlwdGlvblxyXG4vKlxyXG4gKiBDb3B5cmlnaHQgMjAxNS0yMDE5IElkZWFCbGFkZSwgSW5jLiAgQWxsIFJpZ2h0cyBSZXNlcnZlZC5cclxuICogVXNlLCByZXByb2R1Y3Rpb24sIGRpc3RyaWJ1dGlvbiwgYW5kIG1vZGlmaWNhdGlvbiBvZiB0aGlzIGNvZGUgaXMgc3ViamVjdCB0byB0aGUgdGVybXMgYW5kXHJcbiAqIGNvbmRpdGlvbnMgb2YgdGhlIElkZWFCbGFkZSBCcmVlemUgbGljZW5zZSwgYXZhaWxhYmxlIGF0IGh0dHA6Ly93d3cuYnJlZXplanMuY29tL2xpY2Vuc2VcclxuICpcclxuICogQXV0aG9yOiBXYXJkIEJlbGxcclxuICogVmVyc2lvbjogMi4wLjYgU3RldmUgU2NobWl0dCAtIGNvbnZlcnQgdG8gVHlwZVNjcmlwdCwgbW92ZSB0byBicmVlemUtY2xpZW50IHJlcG8sIGNoYW5nZSBlbmFibGVTYXZlUXVldWluZyBmdW5jdGlvblxyXG4gKiBWZXJzaW9uOiAyLjAuNSBXYXJkIEJlbGxcclxuICogLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS1cclxuICogQWRkcyBcIlNhdmUgUXVldWluZ1wiIGNhcGFiaWxpdHkgdG8gbmV3IEVudGl0eU1hbmFnZXJzXHJcbiAqXHJcbiAqIFNhdmUgUXVldWluZyBhdXRvbWF0aWNhbGx5IHF1ZXVlcyBhbmQgZGVmZXJzIGFuIEVudGl0eU1hbmFnZXIuc2F2ZUNoYW5nZXMgY2FsbFxyXG4gKiB3aGVuIGFub3RoZXIgc2F2ZSBpcyBpbiBwcm9ncmVzcyBmb3IgdGhhdCBtYW5hZ2VyIGFuZCB0aGUgc2VydmVyIGhhcyBub3QgeWV0IHJlc3BvbmRlZC5cclxuICogVGhpcyBmZWF0dXJlIGlzIGhlbHBmdWwgd2hlbiB5b3VyIGFwcCBuZWVkcyB0byBhbGxvdyByYXBpZCwgY29udGludW91cyBjaGFuZ2VzXHJcbiAqIHRvIGVudGl0aWVzIHRoYXQgbWF5IGJlIGluIHRoZSBwcm9jZXNzIG9mIGJlaW5nIHNhdmVkLlxyXG4gKlxyXG4gKiBXaXRob3V0IFwiU2F2ZSBRdWV1aW5nXCIsIGFuIEVudGl0eU1hbmFnZXIgd2lsbCB0aHJvdyBhbiBleGNlcHRpb25cclxuICogd2hlbiB5b3UgY2FsbCBzYXZlQ2hhbmdlcyBmb3IgYW4gZW50aXR5IHdoaWNoIGlzIGN1cnJlbnRseSBiZWluZyBzYXZlZC5cclxuICpcclxuICogISEhIFVzZSB3aXRoIGNhdXRpb24gISEhXHJcbiAqIEl0IGlzIHVzdWFsbHkgYmV0dGVyIHRvIGRpc2FibGUgdXNlciBpbnB1dCB3aGlsZSBhIHNhdmUgaXMgaW4gcHJvZ3Jlc3MuXHJcbiAqIFNhdmUgUXVldWluZyBtYXkgYmUgYXBwcm9wcmlhdGUgZm9yIHNpbXBsZSBcImF1dG8tc2F2ZVwiIHNjZW5hcmlvc1xyXG4gKiB3aGVuIHRoZSBzYXZlIGxhdGVuY3kgaXMgXCJzaG9ydFwiICh1bmRlciBhIGZldyBzZWNvbmRzKS5cclxuICpcclxuICogU2F2ZSBRdWV1aW5nIGlzIE5PVCBpbnRlbmRlZCBmb3Igb2NjYXNzaW9uYWxseSBkaXNjb25uZWN0ZWQgb3Igb2ZmbGluZSBzY2VuYXJpb3MuXHJcbiAqXHJcbiAqIFNhdmUgUXVldWluZyBpcyBleHBlcmltZW50YWwuIEl0IHdpbGwgbm90IGJlY29tZSBhIHBhcnQgb2YgQnJlZXplSlMgY29yZVxyXG4gKiBidXQgbWlnaHQgYmVjb21lIGFuIG9mZmljaWFsIEJyZWV6ZSBwbHVnaW4gaW4gZnV0dXJlXHJcbiAqIGFsdGhvdWdoIG5vdCBuZWNlc3NhcmlseSBpbiB0aGlzIGZvcm0gb3Igd2l0aCB0aGlzIEFQSVxyXG4gKlxyXG4gKiBNdXN0IGNhbGwgRW50aXR5TWFuYWdlci5lbmFibGVTYXZlUXVldWluZyh0cnVlKSB0byB0dXJuIGl0IG9uO1xyXG4gKiBFbnRpdHlNYW5hZ2VyLmVuYWJsZVNhdmVRdWV1aW5nKGZhbHNlKSByZXN0b3JlcyB0aGUgbWFuYWdlcidzIG9yaWdpbmFsXHJcbiAqIHNhdmVDaGFuZ2VzIG1ldGhvZCBhcyBpdCB3YXMgYXQgdGhlIHRpbWUgc2F2ZVF1ZXVpbmcgd2FzIGZpcnN0IGVuYWJsZWQuXHJcbiAqXHJcbiAqIFRoaXMgbW9kdWxlIGFkZHMgXCJlbmFibGVTYXZlUXVldWluZ1wiIHRvIHRoZSBFbnRpdHlNYW5hZ2VyIHByb3RvdHlwZS5cclxuICogQ2FsbGluZyBcImVuYWJsZVNhdmVRdWV1aW5nKHRydWUpXCIgYWRkcyBhIG5ldyBfc2F2ZVF1ZXVpbmcgb2JqZWN0XHJcbiAqIHRvIHRoZSBtYW5hZ2VyIGluc3RhbmNlLlxyXG4gKlxyXG4gKiBTZWUgRG9jQ29kZTpzYXZlUXVldWluZ1Rlc3RzLmpzXHJcbiAqIGh0dHBzOi8vZ2l0aHViLmNvbS9CcmVlemUvYnJlZXplLmpzLnNhbXBsZXMvYmxvYi9tYXN0ZXIvbmV0L0RvY0NvZGUvRG9jQ29kZS90ZXN0cy9zYXZlUXVldWluZ1Rlc3RzLmpzXHJcbiAqXHJcbiAqIExJTUlUQVRJT05TXHJcbiAqIC0gQ2FuJ3QgaGFuZGxlIGNoYW5nZXMgdG8gdGhlIHByaW1hcnkga2V5IChkYW5nZXJvdXMgaW4gYW55IGNhc2UpXHJcbiAqIC0gQXNzdW1lcyBwcm9taXNlcy4gRG9lcyBub3Qgc3VwcG9ydCB0aGUgKGRlcHJlY2F0ZWQpIHN1Y2Nlc3MgYW5kIGZhaWwgY2FsbGJhY2tzXHJcbiAqIC0gRG9lcyBub3QgcXVldWUgc2F2ZU9wdGlvbnMuIFRoZSBmaXJzdCBvbmUgaXMgcmUtdXNlZCBmb3IgYWxsIHF1ZXVlZCBzYXZlcy5cclxuICogLSBEb2VzIG5vdCBkZWFsIHdpdGggZXhwb3J0L2ltcG9ydCBvZiBlbnRpdGllcyB3aGlsZSBzYXZlIGlzIGluZmxpZ2h0XHJcbiAqIC0gRG9lcyBub3QgZGVhbCB3aXRoIHJlamVjdENoYW5nZXMgd2hpbGUgc2F2ZSBpcyBpbiBmbGlnaHRcclxuICogLSBEb2VzIG5vdCBzdXBwb3J0IHBhcmFsbGVsIHNhdmVzIGV2ZW4gd2hlbiB0aGUgY2hhbmdlLXNldHMgYXJlIGluZGVwZW5kZW50LlxyXG4gKiAgIFRoZSBuYXRpdmUgc2F2ZUNoYW5nZXMgYWxsb3dzIHN1Y2ggc2F2ZXMuXHJcbiAqICAgU2F2ZVF1ZXVpbmcgZG9lcyBub3Q7IHRvbyBjb21wbGV4IGFuZCBkb2Vzbid0IGZpdCB0aGUgcHJpbWFyeSBzY2VuYXJpbyBhbnl3YXkuXHJcbiAqIC0gVGhlIHJlc29sdmVkIHNhdmVSZXN1bHQgaXMgdGhlIHNhdmVSZXN1bHQgb2YgdGhlIGxhc3QgY29tcGxldGVkIHNhdmVcclxuICogLSBBIHF1ZXVlZCBzYXZlIHRoYXQgbWlnaHQgaGF2ZSBzdWNjZWVkZWQgaWYgc2F2ZWQgaW1tZWRpYXRlbHlcclxuICogICBtYXkgZmFpbCBiZWNhdXNlIHRoZSBzZXJ2ZXIgbm8gbG9uZ2VyIGFjY2VwdHMgaXQgbGF0ZXJcclxuICogLSBQcmlvciB0byBCcmVlemUgdi4xLjUuMywgYSBxdWV1ZWQgc2F2ZSB0aGF0IG1pZ2h0IGhhdmUgc3VjY2VlZGVkXHJcbiAqICAgaWYgc2F2ZWQgaW1tZWRpYXRlbHkgd2lsbCBmYWlsIGlmIHN1YnNlcXVlbnRseSBhdHRlbXB0IHRvIHNhdmVcclxuICogICBhbiBpbnZhbGlkIGVudGl0eS4gQ2FuIGRldGVjdCBhbmQgY2lyY3VtdmVudCBhZnRlciB2LjEuNS4zLlxyXG4gKlxyXG4gKiBBbGwgbWVtYmVycyBvZiBFbnRpdHlNYW5hZ2VyLl9zYXZlUXVldWluZyBhcmUgaW50ZXJuYWw7XHJcbiAqIHRvdWNoIHRoZW0gYXQgeW91ciBvd24gcmlzay5cclxuICovXHJcbi8vI2VuZHJlZ2lvblxyXG5pbXBvcnQgeyBFbnRpdHksIEVudGl0eU1hbmFnZXIsIEtleU1hcHBpbmcsIEVudGl0eVN0YXRlLCBTYXZlUmVzdWx0LCBicmVlemUgfSBmcm9tICdicmVlemUtY2xpZW50JztcclxuXHJcblxyXG5leHBvcnQgZnVuY3Rpb24gZW5hYmxlU2F2ZVF1ZXVpbmcoZW06IEVudGl0eU1hbmFnZXIsIGVuYWJsZTogYm9vbGVhbiA9IHRydWUpIHtcclxuICBsZXQgc2F2ZVF1ZXVpbmcgPSBlbVsnX3NhdmVRdWV1ZWluZyddIHx8XHJcbiAgICAoZW1bJ19zYXZlUXVldWluZyddID0gbmV3IFNhdmVRdWV1aW5nKGVtKSk7XHJcblxyXG4gIGVuYWJsZSA9IChlbmFibGUgPT09IHVuZGVmaW5lZCkgPyB0cnVlIDogZW5hYmxlO1xyXG4gIHNhdmVRdWV1aW5nLl9pc0VuYWJsZWQgPSBlbmFibGU7XHJcbiAgaWYgKGVuYWJsZSkge1xyXG4gICAgLy8gZGVsZWdhdGUgdG8gc2F2ZSBjaGFuZ2VzIHF1ZXVpbmdcclxuICAgIGVtLnNhdmVDaGFuZ2VzID0gc2F2ZUNoYW5nZXNXaXRoUXVldWluZztcclxuICB9IGVsc2Uge1xyXG4gICAgLy8gcmV2ZXJ0IHRvIHRoZSBuYXRpdmUgRW50aXR5TWFuYWdlci5zYXZlQ2hhbmdlc1xyXG4gICAgZW0uc2F2ZUNoYW5nZXMgPSBlbVsnX3NhdmVRdWV1aW5nJ10uYmFzZVNhdmVDaGFuZ2VzO1xyXG4gIH1cclxufVxyXG5cclxuLyoqXHJcbiAqIFJlcGxhY2VtZW50IGZvciBFbnRpdHlNYW5hZ2VyLnNhdmVDaGFuZ2VzXHJcbiAqIFRoaXMgdmVyc2lvbiBxdWV1ZXMgc2F2ZUNoYW5nZXMgY2FsbHMgd2hpbGUgYSByZWFsIHNhdmUgaXMgaW4gcHJvZ3Jlc3NcclxuICoqL1xyXG5mdW5jdGlvbiBzYXZlQ2hhbmdlc1dpdGhRdWV1aW5nKGVudGl0aWVzOiBFbnRpdHlbXSB8IG51bGwsIHNhdmVPcHRpb25zOiBhbnkpIHtcclxuICB0cnkge1xyXG4gICAgLy8gYHRoaXNgIGlzIGFuIEVudGl0eU1hbmFnZXJcclxuICAgIGxldCBzYXZlUXVldWluZyA9IHRoaXMuX3NhdmVRdWV1aW5nO1xyXG4gICAgaWYgKHNhdmVRdWV1aW5nLmlzU2F2aW5nKSB7XHJcbiAgICAgIC8vIHNhdmUgaW4gcHJvZ3Jlc3M7IHF1ZXVlIHRoZSBzYXZlIGZvciBsYXRlclxyXG4gICAgICByZXR1cm4gc2F2ZVF1ZXVpbmcucXVldWVTYXZlQ2hhbmdlcyhlbnRpdGllcyk7XHJcbiAgICB9IGVsc2Uge1xyXG4gICAgICAvLyBub3RlIHRoYXQgc2F2ZSBpcyBpbiBwcm9ncmVzczsgdGhlbiBzYXZlXHJcbiAgICAgIHNhdmVRdWV1aW5nLmlzU2F2aW5nID0gdHJ1ZTtcclxuICAgICAgc2F2ZVF1ZXVpbmcuc2F2ZU9wdGlvbnMgPSBzYXZlT3B0aW9ucztcclxuICAgICAgcmV0dXJuIHNhdmVRdWV1aW5nLnNhdmVDaGFuZ2VzKGVudGl0aWVzLCBzYXZlT3B0aW9ucyk7XHJcbiAgICB9XHJcbiAgfSBjYXRjaCAoZXJyKSB7XHJcbiAgICByZXR1cm4gUHJvbWlzZS5yZWplY3QoZXJyKTtcclxuICB9XHJcbn1cclxuXHJcbi8vLy8vLy8vLyBTYXZlUXVldWluZyAvLy8vLy8vLy9cclxuY2xhc3MgU2F2ZVF1ZXVpbmcge1xyXG4gIGVudGl0eU1hbmFnZXI6IEVudGl0eU1hbmFnZXI7XHJcbiAgYmFzZVNhdmVDaGFuZ2VzOiAoKSA9PiBQcm9taXNlPGFueT47XHJcbiAgaXNTYXZpbmc6IGJvb2xlYW47XHJcbiAgX2lzRW5hYmxlZDogYm9vbGVhbjtcclxuICBhY3RpdmVTYXZlRGVmZXJyZWQ6IERlZmVycmVkPFNhdmVSZXN1bHQ+O1xyXG4gIG5leHRTYXZlRGVmZXJyZWQ6IERlZmVycmVkPFNhdmVSZXN1bHQ+O1xyXG4gIGFjdGl2ZVNhdmVNZW1vOiBTYXZlTWVtbztcclxuICBuZXh0U2F2ZU1lbW86IFNhdmVNZW1vO1xyXG4gIHNhdmVPcHRpb25zOiBhbnk7XHJcblxyXG4gIGNvbnN0cnVjdG9yKGVudGl0eU1hbmFnZXI6IEVudGl0eU1hbmFnZXIpIHtcclxuICAgIHRoaXMuZW50aXR5TWFuYWdlciA9IGVudGl0eU1hbmFnZXI7XHJcbiAgICB0aGlzLmJhc2VTYXZlQ2hhbmdlcyA9IGVudGl0eU1hbmFnZXIuc2F2ZUNoYW5nZXM7XHJcbiAgICB0aGlzLmlzU2F2aW5nID0gZmFsc2U7XHJcbiAgfVxyXG5cclxuICBpc0VuYWJsZWQoKSB7XHJcbiAgICByZXR1cm4gdGhpcy5faXNFbmFibGVkO1xyXG4gIH1cclxuXHJcbiAgZ2V0U2F2ZWROb3RoaW5nUmVzdWx0KCk6IFNhdmVSZXN1bHQge1xyXG4gICAgcmV0dXJuIHsgZW50aXRpZXM6IFtdIGFzIEVudGl0eVtdLCBrZXlNYXBwaW5nczogW10gYXMgS2V5TWFwcGluZ1tdIH07XHJcbiAgfVxyXG5cclxuICBxdWV1ZVNhdmVDaGFuZ2VzKGVudGl0aWVzOiBFbnRpdHlbXSkge1xyXG4gICAgbGV0IHNlbGYgPSB0aGlzOyAvLyBgdGhpc2AgaXMgYSBTYXZlUXVldWluZ1xyXG4gICAgbGV0IGVtID0gc2VsZi5lbnRpdHlNYW5hZ2VyO1xyXG5cclxuICAgIGxldCBjaGFuZ2VzID0gZW50aXRpZXMgfHwgZW0uZ2V0Q2hhbmdlcygpO1xyXG4gICAgaWYgKGNoYW5nZXMubGVuZ3RoID09PSAwKSB7XHJcbiAgICAgIHJldHVybiBQcm9taXNlLnJlc29sdmUodGhpcy5nZXRTYXZlZE5vdGhpbmdSZXN1bHQoKSk7XHJcbiAgICB9XHJcblxyXG4gICAgbGV0IHZhbEVycm9yID0gZW0uc2F2ZUNoYW5nZXNWYWxpZGF0ZU9uQ2xpZW50KGNoYW5nZXMpO1xyXG4gICAgaWYgKHZhbEVycm9yKSB7XHJcbiAgICAgIHJldHVybiBQcm9taXNlLnJlamVjdCh2YWxFcnJvcik7XHJcbiAgICB9XHJcblxyXG4gICAgbGV0IHNhdmVNZW1vID0gc2VsZi5uZXh0U2F2ZU1lbW8gfHwgKHNlbGYubmV4dFNhdmVNZW1vID0gbmV3IFNhdmVNZW1vKCkpO1xyXG4gICAgbWVtb2l6ZUNoYW5nZXMoKTtcclxuICAgIGxldCBkZWZlcnJlZCA9IHNlbGYubmV4dFNhdmVEZWZlcnJlZCB8fCAoc2VsZi5uZXh0U2F2ZURlZmVycmVkID0gbmV3IERlZmVycmVkPFNhdmVSZXN1bHQ+KCkpO1xyXG4gICAgcmV0dXJuIGRlZmVycmVkLnByb21pc2U7XHJcblxyXG4gICAgZnVuY3Rpb24gbWVtb2l6ZUNoYW5nZXMoKSB7XHJcbiAgICAgIGlmIChjaGFuZ2VzLmxlbmd0aCA9PT0gMCkgeyByZXR1cm47IH1cclxuICAgICAgbGV0IHF1ZXVlZENoYW5nZXMgPSBzYXZlTWVtby5xdWV1ZWRDaGFuZ2VzO1xyXG4gICAgICBjaGFuZ2VzLmZvckVhY2goZSA9PiB7XHJcbiAgICAgICAgaWYgKCFlLmVudGl0eUFzcGVjdC5pc0JlaW5nU2F2ZWQgJiYgcXVldWVkQ2hhbmdlcy5pbmRleE9mKGUpID09PSAtMSkge1xyXG4gICAgICAgICAgcXVldWVkQ2hhbmdlcy5wdXNoKGUpO1xyXG4gICAgICAgIH1cclxuICAgICAgfSk7XHJcblxyXG4gICAgICBzYXZlTWVtby51cGRhdGVFbnRpdHlNZW1vcyhjaGFuZ2VzKTtcclxuICAgIH1cclxuICB9XHJcblxyXG4gIHNhdmVDaGFuZ2VzKGVudGl0aWVzOiBFbnRpdHlbXSwgc2F2ZU9wdGlvbnM6IGFueSkge1xyXG4gICAgbGV0IHNlbGYgPSB0aGlzOyAvLyBgdGhpc2AgaXMgYSBTYXZlUXVldWluZ1xyXG4gICAgbGV0IHByb21pc2UgPSBzZWxmLmJhc2VTYXZlQ2hhbmdlcy5jYWxsKHNlbGYuZW50aXR5TWFuYWdlciwgZW50aXRpZXMsIHNhdmVPcHRpb25zIHx8IHNlbGYuc2F2ZU9wdGlvbnMpXHJcbiAgICAgIC50aGVuKGZ1bmN0aW9uIChzYXZlUmVzdWx0OiBTYXZlUmVzdWx0KSB7IHJldHVybiBzZWxmLnNhdmVTdWNjZWVkZWQoc2F2ZVJlc3VsdCk7IH0pXHJcbiAgICAgIC50aGVuKG51bGwsIGZ1bmN0aW9uIChlcnJvcjogRXJyb3IpIHsgY29uc29sZS5sb2coZXJyb3IpOyByZXR1cm4gc2VsZi5zYXZlRmFpbGVkKGVycm9yKTsgfSk7XHJcbiAgICByZW1lbWJlckFkZGVkT3JpZ2luYWxWYWx1ZXMoZW50aXRpZXMpOyAvLyBkbyBpdCBhZnRlciAuLi4gc28gZG9uJ3Qgc2VuZCBPcmlnVmFsdWVzIHRvIHRoZSBzZXJ2ZXJcclxuICAgIHJldHVybiBwcm9taXNlO1xyXG5cclxuICAgIGZ1bmN0aW9uIHJlbWVtYmVyQWRkZWRPcmlnaW5hbFZhbHVlcyhlbnRpdGllczogRW50aXR5W10pIHtcclxuICAgICAgLy8gYWRkZWQgZW50aXRpZXMgbm9ybWFsbHkgZG9uJ3QgaGF2ZSBvcmlnaW5hbCB2YWx1ZXMgYnV0IHRoZXNlIHdpbGwgbm93XHJcbiAgICAgIGxldCBhZGRlZCA9IGVudGl0aWVzID9cclxuICAgICAgICBlbnRpdGllcy5maWx0ZXIoZnVuY3Rpb24gKGUpIHsgcmV0dXJuIGUuZW50aXR5QXNwZWN0LmVudGl0eVN0YXRlLmlzQWRkZWQoKTsgfSkgOlxyXG4gICAgICAgIHNlbGYuZW50aXR5TWFuYWdlci5nZXRFbnRpdGllcyhudWxsLCBFbnRpdHlTdGF0ZS5BZGRlZCk7XHJcbiAgICAgIGFkZGVkLmZvckVhY2goZW50aXR5ID0+IHtcclxuICAgICAgICBsZXQgcHJvcHMgPSBlbnRpdHkuZW50aXR5VHlwZS5kYXRhUHJvcGVydGllcztcclxuICAgICAgICBsZXQgb3JpZ2luYWxWYWx1ZXMgPSBlbnRpdHkuZW50aXR5QXNwZWN0Lm9yaWdpbmFsVmFsdWVzO1xyXG4gICAgICAgIHByb3BzLmZvckVhY2goZHAgPT4ge1xyXG4gICAgICAgICAgaWYgKGRwLmlzUGFydE9mS2V5KSB7IHJldHVybjsgfVxyXG4gICAgICAgICAgb3JpZ2luYWxWYWx1ZXNbZHAubmFtZV0gPSBlbnRpdHkuZ2V0UHJvcGVydHkoZHAubmFtZSk7XHJcbiAgICAgICAgfSk7XHJcbiAgICAgIH0pO1xyXG4gICAgfVxyXG4gIH1cclxuXHJcblxyXG4gIHNhdmVTdWNjZWVkZWQoc2F2ZVJlc3VsdDogU2F2ZVJlc3VsdCkge1xyXG4gICAgbGV0IHNlbGYgPSB0aGlzOyAvLyBgdGhpc2AgaXMgYSBTYXZlUXVldWVpbmdcclxuICAgIGxldCBhY3RpdmVTYXZlRGVmZXJyZWQgPSBzZWxmLmFjdGl2ZVNhdmVEZWZlcnJlZDtcclxuICAgIGxldCBuZXh0U2F2ZURlZmVycmVkID0gc2VsZi5uZXh0U2F2ZURlZmVycmVkO1xyXG4gICAgbGV0IG5leHRTYXZlTWVtbyA9IHNlbGYubmV4dFNhdmVNZW1vO1xyXG5cclxuXHJcbiAgICAvLyBwcmVwYXJlIGFzIGlmIG5vdGhpbmcgcXVldWVkIG9yIGxlZnQgdG8gc2F2ZVxyXG4gICAgc2VsZi5pc1NhdmluZyA9IGZhbHNlO1xyXG4gICAgc2VsZi5hY3RpdmVTYXZlRGVmZXJyZWQgPSBudWxsO1xyXG4gICAgc2VsZi5hY3RpdmVTYXZlTWVtbyA9IG51bGw7XHJcbiAgICBzZWxmLm5leHRTYXZlRGVmZXJyZWQgPSBudWxsO1xyXG4gICAgc2VsZi5uZXh0U2F2ZU1lbW8gPSBudWxsO1xyXG5cclxuICAgIGlmIChuZXh0U2F2ZU1lbW8pIHtcclxuICAgICAgLy8gYSBzYXZlIHdhcyBxdWV1ZWQgc2luY2UgbGFzdCBzYXZlIHJldHVybmVkXHJcbiAgICAgIG5leHRTYXZlTWVtby5wa0ZpeHVwKHNhdmVSZXN1bHQua2V5TWFwcGluZ3MpO1xyXG4gICAgICBuZXh0U2F2ZU1lbW8uYXBwbHlUb1NhdmVkRW50aXRpZXMoc2VsZi5lbnRpdHlNYW5hZ2VyLCBzYXZlUmVzdWx0LmVudGl0aWVzKTtcclxuICAgICAgLy8gcmVtb3ZlIGRldGFjaGVkIGVudGl0aWVzIGZyb20gcXVldWVkQ2hhbmdlc1xyXG4gICAgICBsZXQgcXVldWVkQ2hhbmdlcyA9IG5leHRTYXZlTWVtby5xdWV1ZWRDaGFuZ2VzLmZpbHRlcihlID0+IHtcclxuICAgICAgICByZXR1cm4gIWUuZW50aXR5QXNwZWN0LmVudGl0eVN0YXRlLmlzRGV0YWNoZWQoKTtcclxuICAgICAgfSk7XHJcblxyXG4gICAgICBpZiAocXVldWVkQ2hhbmdlcy5sZW5ndGggPiAwKSB7XHJcbiAgICAgICAgLy8gc2F2ZSBhZ2FpblxyXG4gICAgICAgIHNlbGYuaXNTYXZpbmcgPSB0cnVlO1xyXG4gICAgICAgIC8vIHJlbWVtYmVyIHRoZSBxdWV1ZWQgY2hhbmdlcyB0aGF0IHRyaWdnZXJlZCB0aGlzIHNhdmVcclxuICAgICAgICBzZWxmLmFjdGl2ZVNhdmVEZWZlcnJlZCA9IG5leHRTYXZlRGVmZXJyZWQ7XHJcbiAgICAgICAgc2VsZi5hY3RpdmVTYXZlTWVtbyA9IG5leHRTYXZlTWVtbztcclxuICAgICAgICBzZWxmLnNhdmVDaGFuZ2VzKHF1ZXVlZENoYW5nZXMsIHRoaXMuc2F2ZU9wdGlvbnMpO1xyXG4gICAgICB9IGVsc2UgaWYgKG5leHRTYXZlRGVmZXJyZWQpIHtcclxuICAgICAgICBuZXh0U2F2ZURlZmVycmVkLnJlc29sdmUodGhpcy5nZXRTYXZlZE5vdGhpbmdSZXN1bHQoKSk7XHJcbiAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICBpZiAoYWN0aXZlU2F2ZURlZmVycmVkKSB7IGFjdGl2ZVNhdmVEZWZlcnJlZC5yZXNvbHZlKHNhdmVSZXN1bHQpOyB9XHJcbiAgICByZXR1cm4gc2F2ZVJlc3VsdDsgIC8vIGZvciB0aGUgY3VycmVudCBwcm9taXNlIGNoYWluXHJcbiAgfVxyXG5cclxuICBzYXZlRmFpbGVkKGVycm9yOiBFcnJvcikge1xyXG4gICAgbGV0IHNlbGYgPSB0aGlzOyAvLyBgdGhpc2AgaXMgYSBTYXZlUXVldWVpbmdcclxuICAgIGVycm9yID0gbmV3IFF1ZXVlZFNhdmVGYWlsZWRFcnJvcihlcnJvciwgc2VsZik7XHJcblxyXG4gICAgbGV0IGFjdGl2ZVNhdmVEZWZlcnJlZCA9IHNlbGYuYWN0aXZlU2F2ZURlZmVycmVkO1xyXG4gICAgbGV0IG5leHRTYXZlRGVmZXJyZWQgPSBzZWxmLm5leHRTYXZlRGVmZXJyZWQ7XHJcblxyXG4gICAgc2VsZi5pc1NhdmluZyA9IGZhbHNlO1xyXG4gICAgc2VsZi5hY3RpdmVTYXZlRGVmZXJyZWQgPSBudWxsO1xyXG4gICAgc2VsZi5hY3RpdmVTYXZlTWVtbyA9IG51bGw7XHJcbiAgICBzZWxmLm5leHRTYXZlRGVmZXJyZWQgPSBudWxsO1xyXG4gICAgc2VsZi5uZXh0U2F2ZU1lbW8gPSBudWxsO1xyXG5cclxuICAgIGlmIChhY3RpdmVTYXZlRGVmZXJyZWQpIHsgYWN0aXZlU2F2ZURlZmVycmVkLnJlamVjdChlcnJvcik7IH1cclxuICAgIGlmIChuZXh0U2F2ZURlZmVycmVkKSB7IG5leHRTYXZlRGVmZXJyZWQucmVqZWN0KGVycm9yKTsgfVxyXG5cclxuICAgIHJldHVybiBQcm9taXNlLnJlamVjdChlcnJvcik7IC8vIGxldCBwcm9taXNlIGNoYWluIGhlYXIgZXJyb3JcclxuICB9XHJcbn1cclxuXHJcbi8vLyBmb3IgYmFja3dhcmQgY29tcGF0IHdpdGggb2xkZXIgUHJvbWlzZSBpbXBsZW1lbnRhdGlvblxyXG5jbGFzcyBEZWZlcnJlZDxUPiB7XHJcbiAgcmVzb2x2ZTogKHZhbDogYW55KSA9PiB2b2lkO1xyXG4gIHJlamVjdDogKGVycjogYW55KSA9PiB2b2lkO1xyXG4gIHByb21pc2U6IFByb21pc2U8VD47XHJcbiAgY29uc3RydWN0b3IoKSB7XHJcbiAgICB0aGlzLnByb21pc2UgPSBuZXcgUHJvbWlzZTxUPihmdW5jdGlvbiAocmVzb2x2ZTogKHZhbDogYW55KSA9PiB2b2lkLCByZWplY3Q6IChlcnI6IGFueSkgPT4gdm9pZCkge1xyXG4gICAgICB0aGlzLnJlc29sdmUgPSByZXNvbHZlO1xyXG4gICAgICB0aGlzLnJlamVjdCA9IHJlamVjdDtcclxuICAgIH0uYmluZCh0aGlzKSk7XHJcbiAgfVxyXG59XHJcblxyXG5cclxuLy8vLy8vLy8vLyBRdWV1ZWRTYXZlRmFpbGVkRXJyb3IgLy8vLy8vLy8vXHJcbi8vIEVycm9yIHN1Yi1jbGFzcyB0aHJvd24gd2hlbiByZWplY3RpbmcgcXVldWVkIHNhdmVzLlxyXG5jbGFzcyBRdWV1ZWRTYXZlRmFpbGVkRXJyb3IgZXh0ZW5kcyBFcnJvciB7XHJcbiAgbmFtZSA9IFwiUXVldWVkU2F2ZUZhaWxlZEVycm9yXCI7XHJcbiAgaW5uZXJFcnJvcjogRXJyb3I7XHJcbiAgbWVzc2FnZTogc3RyaW5nO1xyXG4gIGZhaWxlZFNhdmVNZW1vOiBTYXZlTWVtbztcclxuICBuZXh0U2F2ZU1lbW86IFNhdmVNZW1vO1xyXG5cclxuICAvLyBFcnJvciBzdWItY2xhc3MgdGhyb3duIHdoZW4gcmVqZWN0aW5nIHF1ZXVlZCBzYXZlcy5cclxuICAvLyBgaW5uZXJFcnJvcmAgaXMgdGhlIGFjdHVhbCBzYXZlIGVycm9yXHJcbiAgLy8gYGZhaWxlZFNhdmVNZW1vYCBpcyB0aGUgc2F2ZU1lbW8gdGhhdCBwcm9tcHRlZCB0aGlzIHNhdmVcclxuICAvLyBgbmV4dFNhdmVNZW1vYCBob2xkcyBxdWV1ZWQgY2hhbmdlcyBhY2N1bXVsYXRlZCBzaW5jZSB0aGF0IHNhdmUuXHJcbiAgLy8gWW91IG1heSB0cnkgdG8gcmVjb3ZlciB1c2luZyB0aGlzIGluZm8uIEdvb2QgbHVjayB3aXRoIHRoYXQuXHJcbiAgY29uc3RydWN0b3IoZXJyT2JqZWN0OiBFcnJvciwgc2F2ZVF1ZXVpbmc6IGFueSkge1xyXG4gICAgc3VwZXIoKTtcclxuICAgIHRoaXMuaW5uZXJFcnJvciA9IGVyck9iamVjdDtcclxuICAgIHRoaXMubWVzc2FnZSA9IFwiUXVldWVkIHNhdmUgZmFpbGVkOiBcIiArIGVyck9iamVjdC5tZXNzYWdlO1xyXG4gICAgdGhpcy5mYWlsZWRTYXZlTWVtbyA9IHNhdmVRdWV1aW5nLmFjdGl2ZVNhdmVNZW1vO1xyXG4gICAgdGhpcy5uZXh0U2F2ZU1lbW8gPSBzYXZlUXVldWluZy5uZXh0U2F2ZU1lbW87XHJcbiAgfVxyXG59XHJcblxyXG4vLy8vLy8vLy8vIFNhdmVNZW1vIC8vLy8vLy8vLy8vLy8vLy9cclxuLy8gU2F2ZU1lbW8gaXMgYSByZWNvcmQgb2YgY2hhbmdlcyBmb3IgYSBxdWV1ZWQgc2F2ZSwgY29uc2lzdGluZyBvZjpcclxuLy8gICBlbnRpdHlNZW1vczogICBpbmZvIGFib3V0IGVudGl0aWVzIHRoYXQgYXJlIGJlaW5nIHNhdmVkIGFuZFxyXG4vLyAgICAgICAgICAgICAgICAgIGhhdmUgYmVlbiBjaGFuZ2VkIHNpbmNlIHRoZSBzYXZlIHN0YXJ0ZWRcclxuLy8gICBxdWV1ZWRDaGFuZ2VzOiBlbnRpdGllcyB0aGF0IGFyZSBxdWV1ZWQgZm9yIHNhdmUgYnV0XHJcbi8vICAgICAgICAgICAgICAgICAgYXJlIG5vdCBjdXJyZW50bHkgYmVpbmcgc2F2ZWRcclxuY2xhc3MgU2F2ZU1lbW8ge1xyXG4gIGVudGl0eU1lbW9zOiBhbnk7XHJcbiAgcXVldWVkQ2hhbmdlczogYW55W107XHJcbiAgY29uc3RydWN0b3IoKSB7XHJcbiAgICB0aGlzLmVudGl0eU1lbW9zID0ge307XHJcbiAgICB0aGlzLnF1ZXVlZENoYW5nZXMgPSBbXTtcclxuICB9XHJcblxyXG4gIGFwcGx5VG9TYXZlZEVudGl0aWVzKGVudGl0eU1hbmFnZXI6IEVudGl0eU1hbmFnZXIsIHNhdmVkRW50aXRpZXM6IEVudGl0eVtdKSB7XHJcbiAgICBsZXQgZW50aXR5TWVtb3MgPSB0aGlzLmVudGl0eU1lbW9zOyAvLyBgdGhpc2AgaXMgYSBTYXZlTWVtb1xyXG4gICAgbGV0IHF1ZXVlZENoYW5nZXMgPSB0aGlzLnF1ZXVlZENoYW5nZXM7XHJcbiAgICBsZXQgcmVzdG9yZVB1Ymxpc2hpbmcgPSB0aGlzLmRpc2FibGVNYW5hZ2VyUHVibGlzaGluZyhlbnRpdHlNYW5hZ2VyKTtcclxuICAgIHRyeSB7XHJcbiAgICAgIHNhdmVkRW50aXRpZXMuZm9yRWFjaChzYXZlZCA9PiB7XHJcbiAgICAgICAgbGV0IGtleSA9IHRoaXMubWFrZUVudGl0eU1lbW9LZXkoc2F2ZWQpO1xyXG4gICAgICAgIGxldCBlbnRpdHlNZW1vID0gZW50aXR5TWVtb3Nba2V5XTtcclxuICAgICAgICBsZXQgcmVzYXZlID0gZW50aXR5TWVtbyAmJiBlbnRpdHlNZW1vLmFwcGx5VG9TYXZlZEVudGl0eShzYXZlZCk7XHJcbiAgICAgICAgaWYgKHJlc2F2ZSkge1xyXG4gICAgICAgICAgcXVldWVkQ2hhbmdlcy5wdXNoKHNhdmVkKTtcclxuICAgICAgICB9XHJcbiAgICAgIH0pO1xyXG4gICAgfSBmaW5hbGx5IHtcclxuICAgICAgcmVzdG9yZVB1Ymxpc2hpbmcoKTtcclxuICAgICAgLy8gRCMyNjUxIGhhc0NoYW5nZXMgd2lsbCBiZSB3cm9uZyBpZiBjaGFuZ2VzIG1hZGUgd2hpbGUgc2F2ZSBpbiBwcm9ncmVzc1xyXG4gICAgICBsZXQgaGFzQ2hhbmdlcyA9IHF1ZXVlZENoYW5nZXMubGVuZ3RoID4gMDtcclxuICAgICAgLy8gTXVzdCB1c2UgYnJlZXplIGludGVybmFsIG1ldGhvZCB0byBwcm9wZXJseSBzZXQgdGhpcyBmbGFnIHRydWVcclxuICAgICAgaWYgKGhhc0NoYW5nZXMpIHsgZW50aXR5TWFuYWdlci5fc2V0SGFzQ2hhbmdlcyh0cnVlKTsgfVxyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgcHJpdmF0ZSBkaXNhYmxlTWFuYWdlclB1Ymxpc2hpbmcobWFuYWdlcjogRW50aXR5TWFuYWdlcikge1xyXG4gICAgbGV0IEV2ZW50ID0gYnJlZXplLkV2ZW50O1xyXG4gICAgRXZlbnQuZW5hYmxlKCdlbnRpdHlDaGFuZ2VkJywgbWFuYWdlciwgZmFsc2UpO1xyXG4gICAgRXZlbnQuZW5hYmxlKCdoYXNDaGFuZ2VzQ2hhbmdlZCcsIG1hbmFnZXIsIGZhbHNlKTtcclxuXHJcbiAgICByZXR1cm4gZnVuY3Rpb24gcmVzdG9yZVB1Ymxpc2hpbmcoKSB7XHJcbiAgICAgIEV2ZW50LmVuYWJsZSgnZW50aXR5Q2hhbmdlZCcsIG1hbmFnZXIsIHRydWUpO1xyXG4gICAgICBFdmVudC5lbmFibGUoJ2hhc0NoYW5nZXNDaGFuZ2VkJywgbWFuYWdlciwgdHJ1ZSk7XHJcbiAgICB9O1xyXG4gIH1cclxuXHJcbiAgcGtGaXh1cChrZXlNYXBwaW5nczogS2V5TWFwcGluZ1tdKSB7XHJcbiAgICBsZXQgZW50aXR5TWVtb3MgPSB0aGlzLmVudGl0eU1lbW9zOyAgLy8gYHRoaXNgIGlzIGEgU2F2ZU1lbW9cclxuICAgIGtleU1hcHBpbmdzLmZvckVhY2goa20gPT4ge1xyXG4gICAgICBsZXQgdHlwZSA9IGttLmVudGl0eVR5cGVOYW1lO1xyXG4gICAgICBsZXQgdGVtcEtleSA9IHR5cGUgKyAnfCcgKyBrbS50ZW1wVmFsdWU7XHJcbiAgICAgIGlmIChlbnRpdHlNZW1vc1t0ZW1wS2V5XSkge1xyXG4gICAgICAgIGVudGl0eU1lbW9zW3R5cGUgKyAnfCcgKyBrbS5yZWFsVmFsdWVdID0gZW50aXR5TWVtb3NbdGVtcEtleV07XHJcbiAgICAgICAgZGVsZXRlIGVudGl0eU1lbW9zW3RlbXBLZXldO1xyXG4gICAgICB9XHJcbiAgICAgIGZvciAobGV0IG1lbW9LZXkgaW4gZW50aXR5TWVtb3MpIHtcclxuICAgICAgICBlbnRpdHlNZW1vc1ttZW1vS2V5XS5ma0ZpeHVwKGttKTtcclxuICAgICAgfVxyXG4gICAgfSk7XHJcbiAgfVxyXG5cclxuICBtYWtlRW50aXR5TWVtb0tleShlbnRpdHk6IEVudGl0eSkge1xyXG4gICAgbGV0IGVudGl0eUtleSA9IGVudGl0eS5lbnRpdHlBc3BlY3QuZ2V0S2V5KCk7XHJcbiAgICByZXR1cm4gZW50aXR5S2V5LmVudGl0eVR5cGUubmFtZSArICd8JyArIGVudGl0eUtleS52YWx1ZXM7XHJcbiAgfVxyXG5cclxuICB1cGRhdGVFbnRpdHlNZW1vcyhjaGFuZ2VzOiBFbnRpdHlbXSkge1xyXG4gICAgbGV0IGVudGl0eU1lbW9zID0gdGhpcy5lbnRpdHlNZW1vczsgIC8vIGB0aGlzYCBpcyBhIFNhdmVNZW1vXHJcbiAgICBjaGFuZ2VzLmZvckVhY2goY2hhbmdlID0+IHtcclxuICAgICAgLy8gb25seSB1cGRhdGUgZW50aXR5TWVtbyBmb3IgZW50aXR5IGJlaW5nIHNhdmVcclxuICAgICAgaWYgKCFjaGFuZ2UuZW50aXR5QXNwZWN0LmlzQmVpbmdTYXZlZCkgeyByZXR1cm47IH1cclxuXHJcbiAgICAgIGxldCBrZXkgPSB0aGlzLm1ha2VFbnRpdHlNZW1vS2V5KGNoYW5nZSk7XHJcbiAgICAgIGxldCBlbnRpdHlNZW1vID0gZW50aXR5TWVtb3Nba2V5XSB8fCAoZW50aXR5TWVtb3Nba2V5XSA9IG5ldyBFbnRpdHlNZW1vKGNoYW5nZSkpO1xyXG4gICAgICBlbnRpdHlNZW1vLnVwZGF0ZShjaGFuZ2UpO1xyXG4gICAgfSk7XHJcbiAgfVxyXG5cclxufVxyXG5cclxuXHJcblxyXG4vLy8vLy8vLy8gRW50aXR5TWVtbyBUeXBlIC8vLy8vLy8vLy8vLy8vL1xyXG4vLyBJbmZvcm1hdGlvbiBhYm91dCBhbiBlbnRpdHkgdGhhdCBpcyBiZWluZyBzYXZlZFxyXG4vLyBhbmQgd2hpY2ggaGFzIGJlZW4gY2hhbmdlZCBzaW5jZSB0aGF0IHNhdmUgc3RhcnRlZFxyXG5jbGFzcyBFbnRpdHlNZW1vIHtcclxuICBlbnRpdHk6IEVudGl0eTtcclxuICBwZW5kaW5nQ2hhbmdlczogYW55O1xyXG4gIGlzRGVsZXRlZDogYm9vbGVhbjtcclxuICBjb25zdHJ1Y3RvcihlbnRpdHk6IEVudGl0eSkge1xyXG4gICAgdGhpcy5lbnRpdHkgPSBlbnRpdHk7XHJcbiAgICB0aGlzLnBlbmRpbmdDaGFuZ2VzID0ge307XHJcbiAgfVxyXG5cclxuXHJcbiAgYXBwbHlUb1NhdmVkRW50aXR5KHNhdmVkOiBFbnRpdHkpIHtcclxuICAgIGxldCBlbnRpdHlNZW1vID0gdGhpcztcclxuICAgIGxldCBhc3BlY3QgPSBzYXZlZC5lbnRpdHlBc3BlY3Q7XHJcbiAgICBpZiAoYXNwZWN0LmVudGl0eVN0YXRlLmlzRGV0YWNoZWQoKSkge1xyXG4gICAgICByZXR1cm4gZmFsc2U7XHJcbiAgICB9IGVsc2UgaWYgKGVudGl0eU1lbW8uaXNEZWxldGVkKSB7XHJcbiAgICAgIGFzcGVjdC5zZXREZWxldGVkKCk7XHJcbiAgICAgIHJldHVybiB0cnVlO1xyXG4gICAgfVxyXG4gICAgLy8gdHJlYXQgZW50aXR5IHdpdGggcGVuZGluZyBjaGFuZ2VzIGFzIG1vZGlmaWVkXHJcbiAgICBsZXQgcHJvcHMgPSBPYmplY3Qua2V5cyhlbnRpdHlNZW1vLnBlbmRpbmdDaGFuZ2VzKTtcclxuICAgIGlmIChwcm9wcy5sZW5ndGggPT09IDApIHtcclxuICAgICAgcmV0dXJuIGZhbHNlO1xyXG4gICAgfVxyXG4gICAgbGV0IG9yaWdpbmFsVmFsdWVzID0gYXNwZWN0Lm9yaWdpbmFsVmFsdWVzO1xyXG4gICAgcHJvcHMuZm9yRWFjaChuYW1lID0+IHtcclxuICAgICAgb3JpZ2luYWxWYWx1ZXNbbmFtZV0gPSBzYXZlZC5nZXRQcm9wZXJ0eShuYW1lKTtcclxuICAgICAgc2F2ZWQuc2V0UHJvcGVydHkobmFtZSwgZW50aXR5TWVtby5wZW5kaW5nQ2hhbmdlc1tuYW1lXSk7XHJcbiAgICB9KTtcclxuICAgIGFzcGVjdC5zZXRNb2RpZmllZCgpO1xyXG4gICAgcmV0dXJuIHRydWU7XHJcbiAgfVxyXG5cclxuICBma0ZpeHVwKGtleU1hcHBpbmc6IEtleU1hcHBpbmcpIHtcclxuICAgIGxldCBlbnRpdHlNZW1vID0gdGhpcztcclxuICAgIGxldCB0eXBlID0gZW50aXR5TWVtby5lbnRpdHkuZW50aXR5VHlwZTtcclxuICAgIGxldCBma1Byb3BzID0gdHlwZS5mb3JlaWduS2V5UHJvcGVydGllcztcclxuICAgIGZrUHJvcHMuZm9yRWFjaChma1Byb3AgPT4ge1xyXG4gICAgICBpZiAoZmtQcm9wLnBhcmVudFR5cGUubmFtZSA9PT0ga2V5TWFwcGluZy5lbnRpdHlUeXBlTmFtZSAmJlxyXG4gICAgICAgIGVudGl0eU1lbW8ucGVuZGluZ0NoYW5nZXNbZmtQcm9wLm5hbWVdID09PSBrZXlNYXBwaW5nLnRlbXBWYWx1ZSkge1xyXG4gICAgICAgIGVudGl0eU1lbW8ucGVuZGluZ0NoYW5nZXNbZmtQcm9wLm5hbWVdID0ga2V5TWFwcGluZy5yZWFsVmFsdWU7XHJcbiAgICAgIH1cclxuICAgIH0pO1xyXG4gIH1cclxuXHJcbiAgLy8gdXBkYXRlIHRoZSBlbnRpdHlNZW1vIG9mIGNoYW5nZXMgdG8gYW4gZW50aXR5IGJlaW5nIHNhdmVkXHJcbiAgLy8gc28gdGhhdCB3ZSBrbm93IGhvdyB0byBzYXZlIGl0IGFnYWluIGxhdGVyXHJcbiAgdXBkYXRlKCkge1xyXG4gICAgbGV0IGVudGl0eU1lbW8gPSB0aGlzO1xyXG4gICAgbGV0IHByb3BzO1xyXG4gICAgbGV0IGVudGl0eSA9IGVudGl0eU1lbW8uZW50aXR5O1xyXG4gICAgbGV0IGFzcGVjdCA9IGVudGl0eS5lbnRpdHlBc3BlY3Q7XHJcbiAgICBsZXQgc3RhdGVOYW1lID0gYXNwZWN0LmVudGl0eVN0YXRlLm5hbWU7XHJcbiAgICBzd2l0Y2ggKHN0YXRlTmFtZSkge1xyXG4gICAgICBjYXNlICdBZGRlZCc6XHJcbiAgICAgICAgbGV0IG9yaWdpbmFsVmFsdWVzID0gYXNwZWN0Lm9yaWdpbmFsVmFsdWVzO1xyXG4gICAgICAgIHByb3BzID0gZW50aXR5LmVudGl0eVR5cGUuZGF0YVByb3BlcnRpZXM7XHJcbiAgICAgICAgcHJvcHMuZm9yRWFjaChkcCA9PiB7XHJcbiAgICAgICAgICBpZiAoZHAuaXNQYXJ0T2ZLZXkpIHsgcmV0dXJuOyB9XHJcbiAgICAgICAgICBsZXQgbmFtZSA9IGRwLm5hbWU7XHJcbiAgICAgICAgICBsZXQgdmFsdWUgPSBlbnRpdHkuZ2V0UHJvcGVydHkobmFtZSk7XHJcbiAgICAgICAgICBpZiAob3JpZ2luYWxWYWx1ZXNbbmFtZV0gIT09IHZhbHVlKSB7XHJcbiAgICAgICAgICAgIGVudGl0eU1lbW8ucGVuZGluZ0NoYW5nZXNbbmFtZV0gPSB2YWx1ZTtcclxuICAgICAgICAgIH1cclxuICAgICAgICB9KTtcclxuICAgICAgICBicmVhaztcclxuXHJcbiAgICAgIGNhc2UgJ0RlbGV0ZWQnOlxyXG4gICAgICAgIGVudGl0eU1lbW8uaXNEZWxldGVkID0gdHJ1ZTtcclxuICAgICAgICBlbnRpdHlNZW1vLnBlbmRpbmdDaGFuZ2VzID0ge307XHJcbiAgICAgICAgYnJlYWs7XHJcblxyXG4gICAgICBjYXNlICdNb2RpZmllZCc6XHJcbiAgICAgICAgcHJvcHMgPSBPYmplY3Qua2V5cyhhc3BlY3Qub3JpZ2luYWxWYWx1ZXMpO1xyXG4gICAgICAgIHByb3BzLmZvckVhY2gobmFtZSA9PiB7XHJcbiAgICAgICAgICBlbnRpdHlNZW1vLnBlbmRpbmdDaGFuZ2VzW25hbWVdID0gZW50aXR5LmdldFByb3BlcnR5KG5hbWUpO1xyXG4gICAgICAgIH0pO1xyXG4gICAgICAgIGJyZWFrO1xyXG4gICAgfVxyXG4gIH1cclxufVxyXG4iXX0=