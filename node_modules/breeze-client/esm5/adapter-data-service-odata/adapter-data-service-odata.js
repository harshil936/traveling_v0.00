import * as tslib_1 from "tslib";
import * as breeze from 'breeze-client';
var core = breeze.core;
/** @hidden */
var DataServiceODataAdapter = /** @class */ (function (_super) {
    tslib_1.__extends(DataServiceODataAdapter, _super);
    function DataServiceODataAdapter() {
        var _this = _super.call(this) || this;
        // _catchNoConnectionError = abstractDsaProto._catchNoConnectionError;
        // changeRequestInterceptor = abstractDsaProto.changeRequestInterceptor;
        // _createChangeRequestInterceptor = abstractDsaProto._createChangeRequestInterceptor;
        _this.headers = { "DataServiceVersion": "2.0" };
        _this.jsonResultsAdapter = new breeze.JsonResultsAdapter({
            name: "OData_default",
            visitNode: function (node, mappingContext, nodeContext) {
                var result = {};
                if (node == null)
                    return result;
                var metadata = node.__metadata;
                if (metadata != null) {
                    // TODO: may be able to make this more efficient by caching of the previous value.
                    var entityTypeName = breeze.MetadataStore.normalizeTypeName(metadata.type);
                    var et = entityTypeName && mappingContext.entityManager.metadataStore.getEntityType(entityTypeName, true);
                    // OData response doesn't distinguish a projection from a whole entity.
                    // We'll assume that whole-entity data would have at least as many properties  (<=)
                    // as the EntityType has mapped properties on the basis that
                    // most projections remove properties rather than add them.
                    // If not, assume it's a projection and do NOT treat as an entity
                    if (et && et._mappedPropertiesCount <= Object.keys(node).length - 1) {
                        // if (et && et._mappedPropertiesCount === Object.keys(node).length - 1) { // OLD
                        result.entityType = et;
                        var uriKey = metadata.uri || metadata.id;
                        if (uriKey) {
                            // Strip baseUri to make uriKey a relative uri
                            // Todo: why is this necessary when absolute works for every OData source tested?
                            var re = new RegExp('^' + mappingContext.dataService.serviceName, 'i');
                            uriKey = uriKey.replace(re, '');
                        }
                        result.extraMetadata = {
                            uriKey: uriKey,
                            etag: metadata.etag
                        };
                    }
                }
                // OData v3 - projection arrays will be enclosed in a results array
                if (node.results) {
                    result.node = node.results;
                }
                var propertyName = nodeContext.propertyName;
                result.ignore = node.__deferred != null || propertyName === "__metadata" ||
                    // EntityKey properties can be produced by EDMX models
                    (propertyName === "EntityKey" && node.$type && core.stringStartsWith(node.$type, "System.Data"));
                return result;
            }
        });
        _this.name = "OData";
        return _this;
    }
    DataServiceODataAdapter.register = function (config) {
        config = config || breeze.config;
        config.registerAdapter("dataService", DataServiceODataAdapter);
        return config.initializeAdapterInstance("dataService", "OData", true);
    };
    DataServiceODataAdapter.prototype.initialize = function () {
        OData = core.requireLib("OData", "Needed to support remote OData services");
        OData.jsonHandler.recognizeDates = true;
    };
    // Absolute URL is the default as of Breeze 1.5.5.  
    // To use relative URL (like pre-1.5.5), add adapterInstance.relativeUrl = true:
    //
    //     let ds = breeze.config.initializeAdapterInstance("dataService", "webApiOData");
    //     ds.relativeUrl = true; 
    //
    // To use custom url construction, add adapterInstance.relativeUrl = myfunction(dataService, url):
    //
    //     let ds = breeze.config.initializeAdapterInstance("dataService", "webApiOData");
    //     ds.relativeUrl = function(dataService, url) {
    //        return somehowConvert(url);
    //     }
    //
    DataServiceODataAdapter.prototype.fetchMetadata = function (metadataStore, dataService) {
        var serviceName = dataService.serviceName;
        var url;
        if (this.relativeUrl === true) {
            url = dataService.qualifyUrl('$metadata');
        }
        else if (core.isFunction(this.relativeUrl)) {
            url = this.relativeUrl(dataService, '$metadata');
        }
        else {
            url = this.getAbsoluteUrl(dataService, '$metadata');
        }
        var mheaders = core.extend({}, this.headers);
        mheaders.Accept = 'application/*; odata.metadata=full';
        var promise = new Promise(function (resolve, reject) {
            // OData.read(url,
            OData.read({
                requestUri: url,
                // headers: { "Accept": "application/json"}
                headers: mheaders
            }, function (data) {
                // data.dataServices.schema is an array of schemas. with properties of
                // entityContainer[], association[], entityType[], and namespace.
                if (!data || !data.dataServices) {
                    var error = new Error("Metadata query failed for: " + url);
                    return reject(error);
                }
                var csdlMetadata = data.dataServices;
                // might have been fetched by another query
                if (!metadataStore.hasMetadataFor(serviceName)) {
                    try {
                        metadataStore.importMetadata(csdlMetadata);
                    }
                    catch (e) {
                        return reject(new Error("Metadata query failed for " + url + "; Unable to process returned metadata: " + e.message));
                    }
                    metadataStore.addDataService(dataService);
                }
                return resolve(csdlMetadata);
            }, function (error) {
                var err = createError(error, url);
                err.message = "Metadata query failed for: " + url + "; " + (err.message || "");
                return reject(err);
            }, OData.metadataHandler);
        });
        return promise;
    };
    DataServiceODataAdapter.prototype.executeQuery = function (mappingContext) {
        var _this = this;
        var url;
        if (this.relativeUrl === true) {
            url = mappingContext.getUrl();
        }
        else if (core.isFunction(this.relativeUrl)) {
            url = this.relativeUrl(mappingContext.dataService, mappingContext.getUrl());
        }
        else {
            url = this.getAbsoluteUrl(mappingContext.dataService, mappingContext.getUrl());
        }
        // Add query params if .withParameters was used
        var query = mappingContext.query;
        if (!core.isEmpty(query.parameters)) {
            var paramString = toQueryString(query.parameters);
            var sep = url.indexOf("?") < 0 ? "?" : "&";
            url = url + sep + paramString;
        }
        var promise = new Promise(function (resolve, reject) {
            OData.read({
                requestUri: url,
                headers: core.extend({}, _this.headers)
            }, function (data, response) {
                var inlineCount;
                if (data.__count) {
                    // OData can return data.__count as a string
                    inlineCount = parseInt(data.__count, 10);
                }
                // Odata returns different result structure when it returns multiple entities (data.results) vs single entity (data directly).
                // @see http://www.odata.org/documentation/odata-version-2-0/json-format/#RepresentingCollectionsOfEntries
                // and http://www.odata.org/documentation/odata-version-2-0/json-format/#RepresentingEntries
                var results;
                if (data.results) {
                    results = data.results;
                }
                else {
                    results = data;
                }
                return resolve({ results: results, inlineCount: inlineCount, httpResponse: response, query: query });
            }, function (error) {
                return reject(createError(error, url));
            });
        });
        return promise;
    };
    DataServiceODataAdapter.prototype.saveChanges = function (odataSaveContext, saveBundle) {
        var _this = this;
        var adapter = odataSaveContext.adapter = this;
        var saveContext = odataSaveContext;
        var url;
        if (this.relativeUrl === true) {
            saveContext.routePrefix = adapter.getRoutePrefix(saveContext.dataService);
            url = saveContext.dataService.qualifyUrl("$batch");
        }
        else if (core.isFunction(adapter.relativeUrl)) {
            saveContext.routePrefix = adapter.relativeUrl(saveContext.dataService, '');
            url = saveContext.routePrefix + '$batch';
        }
        else {
            saveContext.routePrefix = adapter.getAbsoluteUrl(saveContext.dataService, '');
            url = saveContext.routePrefix + '$batch';
        }
        var requestData = createChangeRequests(saveContext, saveBundle);
        var tempKeys = saveContext.tempKeys;
        var contentKeys = saveContext.contentKeys;
        var promise = new Promise(function (resolve, reject) {
            OData.request({
                headers: core.extend({}, _this.headers),
                requestUri: url,
                method: "POST",
                data: requestData
            }, function (data, response) {
                var entities = [];
                var keyMappings = [];
                var saveResult = { entities: entities, keyMappings: keyMappings };
                data.__batchResponses.forEach(function (br) {
                    br.__changeResponses.forEach(function (cr) {
                        var response = cr.response || cr;
                        var statusCode = response.statusCode;
                        if ((!statusCode) || statusCode >= 400) {
                            reject(createError(cr, url));
                            return;
                        }
                        var contentId = cr.headers["Content-ID"];
                        // Olingo sends different case of 'ID' for the header name.
                        if (!contentId) {
                            contentId = cr.headers["Content-Id"];
                        }
                        var rawEntity = cr.data;
                        if (rawEntity) {
                            var tempKey = tempKeys[contentId];
                            if (tempKey) {
                                var entityType = tempKey.entityType;
                                if (entityType.autoGeneratedKeyType !== breeze.AutoGeneratedKeyType.None) {
                                    var tempValue = tempKey.values[0];
                                    var realKey = entityType.getEntityKeyFromRawEntity(rawEntity, breeze.DataProperty.getRawValueFromServer);
                                    var keyMapping = { entityTypeName: entityType.name, tempValue: tempValue, realValue: realKey.values[0] };
                                    keyMappings.push(keyMapping);
                                }
                            }
                            entities.push(rawEntity);
                        }
                        else {
                            var origEntity = contentKeys[contentId];
                            entities.push(origEntity);
                        }
                    });
                });
                return resolve(saveResult);
            }, function (err) {
                return reject(createError(err, url));
            }, OData.batchHandler);
        });
        return promise;
    };
    DataServiceODataAdapter.prototype.getAbsoluteUrl = function (dataService, url) {
        var serviceName = dataService.qualifyUrl('');
        // only prefix with serviceName if not already on the url
        var base = (core.stringStartsWith(url, serviceName)) ? '' : serviceName;
        // If no protocol, turn base into an absolute URI
        if (window && serviceName.indexOf('//') < 0) {
            // no protocol; make it absolute
            base = window.location.protocol + '//' + window.location.host +
                (core.stringStartsWith(serviceName, '/') ? '' : '/') +
                base;
        }
        return base + url;
    };
    DataServiceODataAdapter.prototype.getRoutePrefix = function (dataService) {
        // Get the routePrefix from a Web API OData service name.
        // The routePrefix is presumed to be the pathname within the dataService.serviceName
        // Examples of servicename -> routePrefix:
        //   'http://localhost:55802/odata/' -> 'odata/'
        //   'http://198.154.121.75/service/odata/' -> 'service/odata/'
        var parser;
        if (typeof document === 'object') { // browser
            parser = document.createElement('a');
            parser.href = dataService.serviceName;
        }
        else { // node
            // TODO: how to best handle this
            // assumes existence of node's url.parse method.
            parser = url.parse(dataService.serviceName);
        }
        var prefix = parser.pathname;
        if (prefix[0] === '/') {
            prefix = prefix.substr(1);
        } // drop leading '/'  (all but IE)
        if (prefix.substr(-1) !== '/') {
            prefix += '/';
        } // ensure trailing '/'
        return prefix;
    };
    return DataServiceODataAdapter;
}(breeze.AbstractDataServiceAdapter));
export { DataServiceODataAdapter };
// crude serializer.  Doesn't recurse
function toQueryString(obj) {
    var parts = [];
    for (var i in obj) {
        if (obj.hasOwnProperty(i)) {
            parts.push(encodeURIComponent(i) + "=" + encodeURIComponent(obj[i]));
        }
    }
    return parts.join("&");
}
function transformValue(prop, val) {
    if (prop.isUnmapped)
        return undefined;
    if (prop.dataType === breeze.DataType.DateTimeOffset) {
        // The datajs lib tries to treat client dateTimes that are defined as DateTimeOffset on the server differently
        // from other dateTimes. This fix compensates before the save.
        val = val && new Date(val.getTime() - (val.getTimezoneOffset() * 60000));
    }
    else if (prop.dataType.quoteJsonOData) {
        val = val != null ? val.toString() : val;
    }
    return val;
}
function createChangeRequests(saveContext, saveBundle) {
    var changeRequestInterceptor = saveContext.adapter._createChangeRequestInterceptor(saveContext, saveBundle);
    var changeRequests = [];
    var tempKeys = [];
    var contentKeys = [];
    var entityManager = saveContext.entityManager;
    var helper = entityManager.helper;
    var id = 0;
    var routePrefix = saveContext.routePrefix;
    saveBundle.entities.forEach(function (entity, index) {
        var aspect = entity.entityAspect;
        id = id + 1; // we are deliberately skipping id=0 because Content-ID = 0 seems to be ignored.
        var request = { headers: { "Content-ID": id, "DataServiceVersion": "2.0" } };
        contentKeys[id] = entity;
        if (aspect.entityState.isAdded()) {
            request.requestUri = routePrefix + entity.entityType.defaultResourceName;
            request.method = "POST";
            request.data = helper.unwrapInstance(entity, transformValue);
            tempKeys[id] = aspect.getKey();
        }
        else if (aspect.entityState.isModified()) {
            updateDeleteMergeRequest(request, aspect, routePrefix);
            request.method = "MERGE";
            request.data = helper.unwrapChangedValues(entity, entityManager.metadataStore, transformValue);
            // should be a PATCH/MERGE
        }
        else if (aspect.entityState.isDeleted()) {
            updateDeleteMergeRequest(request, aspect, routePrefix);
            request.method = "DELETE";
        }
        else {
            return;
        }
        request = changeRequestInterceptor.getRequest(request, entity, index);
        changeRequests.push(request);
    });
    saveContext.contentKeys = contentKeys;
    saveContext.tempKeys = tempKeys;
    changeRequestInterceptor.done(changeRequests);
    return {
        __batchRequests: [
            {
                __changeRequests: changeRequests
            }
        ]
    };
}
function updateDeleteMergeRequest(request, aspect, routePrefix) {
    var uriKey;
    var extraMetadata = aspect.extraMetadata;
    if (extraMetadata == null) {
        uriKey = getUriKey(aspect);
        aspect.extraMetadata = {
            uriKey: uriKey
        };
    }
    else {
        uriKey = extraMetadata.uriKey;
        if (extraMetadata.etag) {
            request.headers["If-Match"] = extraMetadata.etag;
        }
    }
    request.requestUri =
        // use routePrefix if uriKey lacks protocol (i.e., relative uri)
        uriKey.indexOf('//') > 0 ? uriKey : routePrefix + uriKey;
}
function getUriKey(aspect) {
    var entityType = aspect.entity.entityType;
    var resourceName = entityType.defaultResourceName;
    var kps = entityType.keyProperties;
    var uriKey = resourceName + "(";
    if (kps.length === 1) {
        uriKey = uriKey + fmtProperty(kps[0], aspect) + ")";
    }
    else {
        var delim_1 = "";
        kps.forEach(function (kp) {
            uriKey = uriKey + delim_1 + kp.nameOnServer + "=" + fmtProperty(kp, aspect);
            delim_1 = ",";
        });
        uriKey = uriKey + ")";
    }
    return uriKey;
}
function fmtProperty(prop, aspect) {
    return prop.dataType.fmtOData(aspect.getPropertyValue(prop.name));
}
function createError(error, url) {
    // OData errors can have the message buried very deeply - and nonobviously
    // this code is tricky so be careful changing the response.body parsing.
    var result = new Error();
    var response = error && error.response;
    if (!response) {
        // in case DataJS returns "No handler for this data"
        result.message = error;
        result.statusText = error;
        return result;
    }
    result.message = response.statusText;
    result.statusText = response.statusText;
    result.status = response.statusCode;
    // non std
    if (url)
        result.url = url;
    result.body = response.body;
    if (response.body) {
        var nextErr = void 0;
        try {
            var body = JSON.parse(response.body);
            result.body = body;
            // OData v3 logic
            if (body['odata.error']) {
                body = body['odata.error'];
            }
            var msg = "";
            do {
                nextErr = body.error || body.innererror;
                if (!nextErr)
                    msg = msg + getMessage(body);
                nextErr = nextErr || body.internalexception;
                body = nextErr || body;
            } while (nextErr);
            if (msg.length > 0) {
                result.message = msg;
            }
        }
        catch (e) {
        }
    }
    breeze.AbstractDataServiceAdapter._catchNoConnectionError(result);
    return result;
}
function getMessage(body) {
    var msg = body.message || "";
    return ((typeof (msg) === "string") ? msg : msg.value) + "; ";
}
breeze.config.registerAdapter("dataService", DataServiceODataAdapter);
var webApiODataCtor = function () {
    this.name = "webApiOData";
};
var ɵ0 = webApiODataCtor;
breeze.core.extend(webApiODataCtor.prototype, DataServiceODataAdapter.prototype);
breeze.config.registerAdapter("dataService", webApiODataCtor);
// OData 4 adapter
var webApiOData4Ctor = function () {
    this.name = "webApiOData4";
};
var ɵ1 = webApiOData4Ctor;
breeze.core.extend(webApiOData4Ctor.prototype, webApiODataCtor.prototype);
webApiOData4Ctor.prototype.initialize = function () {
    // Aargh... they moved the cheese.
    var datajs = core.requireLib("datajs", "Needed to support remote OData v4 services");
    OData = datajs.V4.oData;
    OData.json.jsonHandler.recognizeDates = true;
};
webApiOData4Ctor.prototype.headers = { "OData-Version": "4.0" };
breeze.config.registerAdapter("dataService", webApiOData4Ctor);
export { ɵ0, ɵ1 };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYWRhcHRlci1kYXRhLXNlcnZpY2Utb2RhdGEuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9icmVlemUtY2xpZW50L2FkYXB0ZXItZGF0YS1zZXJ2aWNlLW9kYXRhLyIsInNvdXJjZXMiOlsiYWRhcHRlci1kYXRhLXNlcnZpY2Utb2RhdGEudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IjtBQUFBLE9BQU8sS0FBSyxNQUFNLE1BQU0sZUFBZSxDQUFDO0FBRXhDLElBQUksSUFBSSxHQUFHLE1BQU0sQ0FBQyxJQUFJLENBQUM7QUFZdkIsY0FBYztBQUNkO0lBQTZDLG1EQUFpQztJQVE1RTtRQUFBLFlBQ0UsaUJBQU8sU0FFUjtRQVJELHNFQUFzRTtRQUN0RSx3RUFBd0U7UUFDeEUsc0ZBQXNGO1FBQ3RGLGFBQU8sR0FBRyxFQUFFLG9CQUFvQixFQUFFLEtBQUssRUFBRSxDQUFDO1FBbU4xQyx3QkFBa0IsR0FBOEIsSUFBSSxNQUFNLENBQUMsa0JBQWtCLENBQUM7WUFDNUUsSUFBSSxFQUFFLGVBQWU7WUFFckIsU0FBUyxFQUFFLFVBQVUsSUFBUyxFQUFFLGNBQXFDLEVBQUUsV0FBK0I7Z0JBQ3BHLElBQUksTUFBTSxHQUFRLEVBQUUsQ0FBQztnQkFDckIsSUFBSSxJQUFJLElBQUksSUFBSTtvQkFBRSxPQUFPLE1BQU0sQ0FBQztnQkFDaEMsSUFBSSxRQUFRLEdBQUcsSUFBSSxDQUFDLFVBQVUsQ0FBQztnQkFDL0IsSUFBSSxRQUFRLElBQUksSUFBSSxFQUFFO29CQUNwQixrRkFBa0Y7b0JBQ2xGLElBQUksY0FBYyxHQUFHLE1BQU0sQ0FBQyxhQUFhLENBQUMsaUJBQWlCLENBQUMsUUFBUSxDQUFDLElBQUksQ0FBQyxDQUFDO29CQUMzRSxJQUFJLEVBQUUsR0FBRyxjQUFjLElBQUksY0FBYyxDQUFDLGFBQWEsQ0FBQyxhQUFhLENBQUMsYUFBYSxDQUFDLGNBQWMsRUFBRSxJQUFJLENBQUMsQ0FBQztvQkFDMUcsdUVBQXVFO29CQUN2RSxtRkFBbUY7b0JBQ25GLDREQUE0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QUMvQyxDQUFDLENBQUM7QUFDRixnQkFBZ0IsQ0FBQyxTQUFTLENBQUMsT0FBTyxHQUFHLEVBQUUsZUFBZSxFQUFFLEtBQUssRUFBRSxDQUFDO0FBQ2hFLE1BQU0sQ0FBQyxNQUFNLENBQUMsZUFBZSxDQUFDLGFBQWEsRUFBRSxnQkFBdUIsQ0FBQyxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0ICogYXMgYnJlZXplIGZyb20gJ2JyZWV6ZS1jbGllbnQnO1xyXG5cclxubGV0IGNvcmUgPSBicmVlemUuY29yZTtcclxuXHJcbmRlY2xhcmUgdmFyIHdpbmRvdzogYW55O1xyXG5kZWNsYXJlIHZhciBkb2N1bWVudDogYW55O1xyXG5kZWNsYXJlIHZhciB1cmw6IGFueTsgLy8gbmVlZGVkIHRvIGFjY2VzcyBub2RlJ3MgdXJsLnBhcnNlXHJcbmRlY2xhcmUgdmFyIE9EYXRhOiBhbnk7XHJcblxyXG5pbnRlcmZhY2UgT0RhdGFTYXZlQ29udGV4dCBleHRlbmRzIGJyZWV6ZS5TYXZlQ29udGV4dCB7XHJcbiAgdGVtcEtleXM6IGJyZWV6ZS5FbnRpdHlLZXlbXTtcclxuICBjb250ZW50S2V5czogYnJlZXplLkVudGl0eVtdO1xyXG59XHJcblxyXG4vKiogQGhpZGRlbiAqL1xyXG5leHBvcnQgY2xhc3MgRGF0YVNlcnZpY2VPRGF0YUFkYXB0ZXIgZXh0ZW5kcyBicmVlemUuQWJzdHJhY3REYXRhU2VydmljZUFkYXB0ZXIge1xyXG4gIG5hbWU6IHN0cmluZztcclxuICByZWxhdGl2ZVVybDogYm9vbGVhbiB8ICgoZHM6IGJyZWV6ZS5EYXRhU2VydmljZSwgdXJsOiBzdHJpbmcpID0+IHN0cmluZyk7XHJcbiAgLy8gX2NhdGNoTm9Db25uZWN0aW9uRXJyb3IgPSBhYnN0cmFjdERzYVByb3RvLl9jYXRjaE5vQ29ubmVjdGlvbkVycm9yO1xyXG4gIC8vIGNoYW5nZVJlcXVlc3RJbnRlcmNlcHRvciA9IGFic3RyYWN0RHNhUHJvdG8uY2hhbmdlUmVxdWVzdEludGVyY2VwdG9yO1xyXG4gIC8vIF9jcmVhdGVDaGFuZ2VSZXF1ZXN0SW50ZXJjZXB0b3IgPSBhYnN0cmFjdERzYVByb3RvLl9jcmVhdGVDaGFuZ2VSZXF1ZXN0SW50ZXJjZXB0b3I7XHJcbiAgaGVhZGVycyA9IHsgXCJEYXRhU2VydmljZVZlcnNpb25cIjogXCIyLjBcIiB9O1xyXG5cclxuICBjb25zdHJ1Y3RvcigpIHtcclxuICAgIHN1cGVyKCk7XHJcbiAgICB0aGlzLm5hbWUgPSBcIk9EYXRhXCI7XHJcbiAgfVxyXG5cclxuICBzdGF0aWMgcmVnaXN0ZXIoY29uZmlnPzogYnJlZXplLkJyZWV6ZUNvbmZpZykge1xyXG4gICAgY29uZmlnID0gY29uZmlnIHx8IGJyZWV6ZS5jb25maWc7XHJcbiAgICBjb25maWcucmVnaXN0ZXJBZGFwdGVyKFwiZGF0YVNlcnZpY2VcIiwgRGF0YVNlcnZpY2VPRGF0YUFkYXB0ZXIpO1xyXG4gICAgcmV0dXJuIGNvbmZpZy5pbml0aWFsaXplQWRhcHRlckluc3RhbmNlKFwiZGF0YVNlcnZpY2VcIiwgXCJPRGF0YVwiLCB0cnVlKSBhcyBEYXRhU2VydmljZU9EYXRhQWRhcHRlcjtcclxuICB9XHJcblxyXG4gIGluaXRpYWxpemUoKSB7XHJcbiAgICBPRGF0YSA9IGNvcmUucmVxdWlyZUxpYihcIk9EYXRhXCIsIFwiTmVlZGVkIHRvIHN1cHBvcnQgcmVtb3RlIE9EYXRhIHNlcnZpY2VzXCIpO1xyXG4gICAgT0RhdGEuanNvbkhhbmRsZXIucmVjb2duaXplRGF0ZXMgPSB0cnVlO1xyXG4gIH1cclxuXHJcblxyXG4gIC8vIEFic29sdXRlIFVSTCBpcyB0aGUgZGVmYXVsdCBhcyBvZiBCcmVlemUgMS41LjUuICBcclxuICAvLyBUbyB1c2UgcmVsYXRpdmUgVVJMIChsaWtlIHByZS0xLjUuNSksIGFkZCBhZGFwdGVySW5zdGFuY2UucmVsYXRpdmVVcmwgPSB0cnVlOlxyXG4gIC8vXHJcbiAgLy8gICAgIGxldCBkcyA9IGJyZWV6ZS5jb25maWcuaW5pdGlhbGl6ZUFkYXB0ZXJJbnN0YW5jZShcImRhdGFTZXJ2aWNlXCIsIFwid2ViQXBpT0RhdGFcIik7XHJcbiAgLy8gICAgIGRzLnJlbGF0aXZlVXJsID0gdHJ1ZTsgXHJcbiAgLy9cclxuICAvLyBUbyB1c2UgY3VzdG9tIHVybCBjb25zdHJ1Y3Rpb24sIGFkZCBhZGFwdGVySW5zdGFuY2UucmVsYXRpdmVVcmwgPSBteWZ1bmN0aW9uKGRhdGFTZXJ2aWNlLCB1cmwpOlxyXG4gIC8vXHJcbiAgLy8gICAgIGxldCBkcyA9IGJyZWV6ZS5jb25maWcuaW5pdGlhbGl6ZUFkYXB0ZXJJbnN0YW5jZShcImRhdGFTZXJ2aWNlXCIsIFwid2ViQXBpT0RhdGFcIik7XHJcbiAgLy8gICAgIGRzLnJlbGF0aXZlVXJsID0gZnVuY3Rpb24oZGF0YVNlcnZpY2UsIHVybCkge1xyXG4gIC8vICAgICAgICByZXR1cm4gc29tZWhvd0NvbnZlcnQodXJsKTtcclxuICAvLyAgICAgfVxyXG4gIC8vXHJcblxyXG4gIGZldGNoTWV0YWRhdGEobWV0YWRhdGFTdG9yZTogYnJlZXplLk1ldGFkYXRhU3RvcmUsIGRhdGFTZXJ2aWNlOiBicmVlemUuRGF0YVNlcnZpY2UpIHtcclxuICAgIGxldCBzZXJ2aWNlTmFtZSA9IGRhdGFTZXJ2aWNlLnNlcnZpY2VOYW1lO1xyXG5cclxuICAgIGxldCB1cmw6IHN0cmluZztcclxuICAgIGlmICh0aGlzLnJlbGF0aXZlVXJsID09PSB0cnVlKSB7XHJcbiAgICAgIHVybCA9IGRhdGFTZXJ2aWNlLnF1YWxpZnlVcmwoJyRtZXRhZGF0YScpO1xyXG4gICAgfSBlbHNlIGlmIChjb3JlLmlzRnVuY3Rpb24odGhpcy5yZWxhdGl2ZVVybCkpIHtcclxuICAgICAgdXJsID0gKHRoaXMucmVsYXRpdmVVcmwgYXMgYW55KShkYXRhU2VydmljZSwgJyRtZXRhZGF0YScpO1xyXG4gICAgfSBlbHNlIHtcclxuICAgICAgdXJsID0gdGhpcy5nZXRBYnNvbHV0ZVVybChkYXRhU2VydmljZSwgJyRtZXRhZGF0YScpO1xyXG4gICAgfVxyXG5cclxuICAgIGxldCBtaGVhZGVycyA9IGNvcmUuZXh0ZW5kKHt9LCB0aGlzLmhlYWRlcnMpO1xyXG4gICAgKG1oZWFkZXJzIGFzIGFueSkuQWNjZXB0ID0gJ2FwcGxpY2F0aW9uLyo7IG9kYXRhLm1ldGFkYXRhPWZ1bGwnO1xyXG5cclxuICAgIGxldCBwcm9taXNlID0gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4ge1xyXG4gICAgICAvLyBPRGF0YS5yZWFkKHVybCxcclxuICAgICAgT0RhdGEucmVhZCh7XHJcbiAgICAgICAgcmVxdWVzdFVyaTogdXJsLFxyXG4gICAgICAgIC8vIGhlYWRlcnM6IHsgXCJBY2NlcHRcIjogXCJhcHBsaWNhdGlvbi9qc29uXCJ9XHJcbiAgICAgICAgaGVhZGVyczogbWhlYWRlcnNcclxuICAgICAgfSxcclxuICAgICAgICBmdW5jdGlvbiAoZGF0YTogYW55KSB7XHJcbiAgICAgICAgICAvLyBkYXRhLmRhdGFTZXJ2aWNlcy5zY2hlbWEgaXMgYW4gYXJyYXkgb2Ygc2NoZW1hcy4gd2l0aCBwcm9wZXJ0aWVzIG9mXHJcbiAgICAgICAgICAvLyBlbnRpdHlDb250YWluZXJbXSwgYXNzb2NpYXRpb25bXSwgZW50aXR5VHlwZVtdLCBhbmQgbmFtZXNwYWNlLlxyXG4gICAgICAgICAgaWYgKCFkYXRhIHx8ICFkYXRhLmRhdGFTZXJ2aWNlcykge1xyXG4gICAgICAgICAgICBsZXQgZXJyb3IgPSBuZXcgRXJyb3IoXCJNZXRhZGF0YSBxdWVyeSBmYWlsZWQgZm9yOiBcIiArIHVybCk7XHJcbiAgICAgICAgICAgIHJldHVybiByZWplY3QoZXJyb3IpO1xyXG4gICAgICAgICAgfVxyXG4gICAgICAgICAgbGV0IGNzZGxNZXRhZGF0YSA9IGRhdGEuZGF0YVNlcnZpY2VzO1xyXG5cclxuICAgICAgICAgIC8vIG1pZ2h0IGhhdmUgYmVlbiBmZXRjaGVkIGJ5IGFub3RoZXIgcXVlcnlcclxuICAgICAgICAgIGlmICghbWV0YWRhdGFTdG9yZS5oYXNNZXRhZGF0YUZvcihzZXJ2aWNlTmFtZSkpIHtcclxuICAgICAgICAgICAgdHJ5IHtcclxuICAgICAgICAgICAgICBtZXRhZGF0YVN0b3JlLmltcG9ydE1ldGFkYXRhKGNzZGxNZXRhZGF0YSk7XHJcbiAgICAgICAgICAgIH0gY2F0Y2ggKGUpIHtcclxuICAgICAgICAgICAgICByZXR1cm4gcmVqZWN0KG5ldyBFcnJvcihcIk1ldGFkYXRhIHF1ZXJ5IGZhaWxlZCBmb3IgXCIgKyB1cmwgKyBcIjsgVW5hYmxlIHRvIHByb2Nlc3MgcmV0dXJuZWQgbWV0YWRhdGE6IFwiICsgZS5tZXNzYWdlKSk7XHJcbiAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgIG1ldGFkYXRhU3RvcmUuYWRkRGF0YVNlcnZpY2UoZGF0YVNlcnZpY2UpO1xyXG4gICAgICAgICAgfVxyXG5cclxuICAgICAgICAgIHJldHVybiByZXNvbHZlKGNzZGxNZXRhZGF0YSk7XHJcblxyXG4gICAgICAgIH0sIGZ1bmN0aW9uIChlcnJvcjogYW55KSB7XHJcbiAgICAgICAgICBsZXQgZXJyID0gY3JlYXRlRXJyb3IoZXJyb3IsIHVybCk7XHJcbiAgICAgICAgICBlcnIubWVzc2FnZSA9IFwiTWV0YWRhdGEgcXVlcnkgZmFpbGVkIGZvcjogXCIgKyB1cmwgKyBcIjsgXCIgKyAoZXJyLm1lc3NhZ2UgfHwgXCJcIik7XHJcbiAgICAgICAgICByZXR1cm4gcmVqZWN0KGVycik7XHJcbiAgICAgICAgfSxcclxuICAgICAgICBPRGF0YS5tZXRhZGF0YUhhbmRsZXJcclxuICAgICAgKTtcclxuICAgIH0pO1xyXG5cclxuICAgIHJldHVybiBwcm9taXNlO1xyXG4gIH1cclxuXHJcblxyXG5cclxuICBleGVjdXRlUXVlcnkobWFwcGluZ0NvbnRleHQ6IGJyZWV6ZS5NYXBwaW5nQ29udGV4dCkge1xyXG4gICAgbGV0IHVybDogc3RyaW5nO1xyXG4gICAgaWYgKHRoaXMucmVsYXRpdmVVcmwgPT09IHRydWUpIHtcclxuICAgICAgdXJsID0gbWFwcGluZ0NvbnRleHQuZ2V0VXJsKCk7XHJcbiAgICB9IGVsc2UgaWYgKGNvcmUuaXNGdW5jdGlvbih0aGlzLnJlbGF0aXZlVXJsKSkge1xyXG4gICAgICB1cmwgPSAodGhpcy5yZWxhdGl2ZVVybCBhcyBhbnkpKG1hcHBpbmdDb250ZXh0LmRhdGFTZXJ2aWNlLCBtYXBwaW5nQ29udGV4dC5nZXRVcmwoKSk7XHJcbiAgICB9IGVsc2Uge1xyXG4gICAgICB1cmwgPSB0aGlzLmdldEFic29sdXRlVXJsKG1hcHBpbmdDb250ZXh0LmRhdGFTZXJ2aWNlLCBtYXBwaW5nQ29udGV4dC5nZXRVcmwoKSk7XHJcbiAgICB9XHJcblxyXG4gICAgLy8gQWRkIHF1ZXJ5IHBhcmFtcyBpZiAud2l0aFBhcmFtZXRlcnMgd2FzIHVzZWRcclxuICAgIGxldCBxdWVyeSA9IG1hcHBpbmdDb250ZXh0LnF1ZXJ5IGFzIGJyZWV6ZS5FbnRpdHlRdWVyeTtcclxuICAgIGlmICghY29yZS5pc0VtcHR5KHF1ZXJ5LnBhcmFtZXRlcnMpKSB7XHJcbiAgICAgIGxldCBwYXJhbVN0cmluZyA9IHRvUXVlcnlTdHJpbmcocXVlcnkucGFyYW1ldGVycyk7XHJcbiAgICAgIGxldCBzZXAgPSB1cmwuaW5kZXhPZihcIj9cIikgPCAwID8gXCI/XCIgOiBcIiZcIjtcclxuICAgICAgdXJsID0gdXJsICsgc2VwICsgcGFyYW1TdHJpbmc7XHJcbiAgICB9XHJcblxyXG4gICAgbGV0IHByb21pc2UgPSBuZXcgUHJvbWlzZTxicmVlemUuUXVlcnlSZXN1bHQ+KChyZXNvbHZlLCByZWplY3QpID0+IHtcclxuICAgICAgT0RhdGEucmVhZCh7XHJcbiAgICAgICAgcmVxdWVzdFVyaTogdXJsLFxyXG4gICAgICAgIGhlYWRlcnM6IGNvcmUuZXh0ZW5kKHt9LCB0aGlzLmhlYWRlcnMpXHJcbiAgICAgIH0sXHJcbiAgICAgICAgZnVuY3Rpb24gKGRhdGE6IGFueSwgcmVzcG9uc2U6IGFueSkge1xyXG4gICAgICAgICAgbGV0IGlubGluZUNvdW50OiBhbnk7XHJcbiAgICAgICAgICBpZiAoZGF0YS5fX2NvdW50KSB7XHJcbiAgICAgICAgICAgIC8vIE9EYXRhIGNhbiByZXR1cm4gZGF0YS5fX2NvdW50IGFzIGEgc3RyaW5nXHJcbiAgICAgICAgICAgIGlubGluZUNvdW50ID0gcGFyc2VJbnQoZGF0YS5fX2NvdW50LCAxMCk7XHJcbiAgICAgICAgICB9XHJcbiAgICAgICAgICAvLyBPZGF0YSByZXR1cm5zIGRpZmZlcmVudCByZXN1bHQgc3RydWN0dXJlIHdoZW4gaXQgcmV0dXJucyBtdWx0aXBsZSBlbnRpdGllcyAoZGF0YS5yZXN1bHRzKSB2cyBzaW5nbGUgZW50aXR5IChkYXRhIGRpcmVjdGx5KS5cclxuICAgICAgICAgIC8vIEBzZWUgaHR0cDovL3d3dy5vZGF0YS5vcmcvZG9jdW1lbnRhdGlvbi9vZGF0YS12ZXJzaW9uLTItMC9qc29uLWZvcm1hdC8jUmVwcmVzZW50aW5nQ29sbGVjdGlvbnNPZkVudHJpZXNcclxuICAgICAgICAgIC8vIGFuZCBodHRwOi8vd3d3Lm9kYXRhLm9yZy9kb2N1bWVudGF0aW9uL29kYXRhLXZlcnNpb24tMi0wL2pzb24tZm9ybWF0LyNSZXByZXNlbnRpbmdFbnRyaWVzXHJcbiAgICAgICAgICBsZXQgcmVzdWx0czogYW55O1xyXG4gICAgICAgICAgaWYgKGRhdGEucmVzdWx0cykge1xyXG4gICAgICAgICAgICByZXN1bHRzID0gZGF0YS5yZXN1bHRzO1xyXG4gICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgcmVzdWx0cyA9IGRhdGE7XHJcbiAgICAgICAgICB9XHJcbiAgICAgICAgICByZXR1cm4gcmVzb2x2ZSh7IHJlc3VsdHM6IHJlc3VsdHMsIGlubGluZUNvdW50OiBpbmxpbmVDb3VudCwgaHR0cFJlc3BvbnNlOiByZXNwb25zZSwgcXVlcnk6IHF1ZXJ5IH0pO1xyXG4gICAgICAgIH0sXHJcbiAgICAgICAgZnVuY3Rpb24gKGVycm9yOiBhbnkpIHtcclxuICAgICAgICAgIHJldHVybiByZWplY3QoY3JlYXRlRXJyb3IoZXJyb3IsIHVybCkpO1xyXG4gICAgICAgIH1cclxuICAgICAgKTtcclxuICAgIH0pO1xyXG4gICAgcmV0dXJuIHByb21pc2U7XHJcbiAgfVxyXG5cclxuXHJcbiAgc2F2ZUNoYW5nZXMob2RhdGFTYXZlQ29udGV4dDogYnJlZXplLlNhdmVDb250ZXh0LCBzYXZlQnVuZGxlOiBicmVlemUuU2F2ZUJ1bmRsZSk6IFByb21pc2U8YnJlZXplLlNhdmVSZXN1bHQ+IHtcclxuICAgIGxldCBhZGFwdGVyID0gb2RhdGFTYXZlQ29udGV4dC5hZGFwdGVyID0gdGhpcztcclxuICAgIGxldCBzYXZlQ29udGV4dCA9IG9kYXRhU2F2ZUNvbnRleHQgYXMgT0RhdGFTYXZlQ29udGV4dDtcclxuICAgIGxldCB1cmw6IHN0cmluZztcclxuICAgIGlmICh0aGlzLnJlbGF0aXZlVXJsID09PSB0cnVlKSB7XHJcbiAgICAgIHNhdmVDb250ZXh0LnJvdXRlUHJlZml4ID0gYWRhcHRlci5nZXRSb3V0ZVByZWZpeChzYXZlQ29udGV4dC5kYXRhU2VydmljZSk7XHJcbiAgICAgIHVybCA9IHNhdmVDb250ZXh0LmRhdGFTZXJ2aWNlLnF1YWxpZnlVcmwoXCIkYmF0Y2hcIik7XHJcbiAgICB9IGVsc2UgaWYgKGNvcmUuaXNGdW5jdGlvbihhZGFwdGVyLnJlbGF0aXZlVXJsKSkge1xyXG4gICAgICBzYXZlQ29udGV4dC5yb3V0ZVByZWZpeCA9IChhZGFwdGVyLnJlbGF0aXZlVXJsIGFzIEZ1bmN0aW9uKShzYXZlQ29udGV4dC5kYXRhU2VydmljZSwgJycpO1xyXG4gICAgICB1cmwgPSBzYXZlQ29udGV4dC5yb3V0ZVByZWZpeCArICckYmF0Y2gnO1xyXG4gICAgfSBlbHNlIHtcclxuICAgICAgc2F2ZUNvbnRleHQucm91dGVQcmVmaXggPSBhZGFwdGVyLmdldEFic29sdXRlVXJsKHNhdmVDb250ZXh0LmRhdGFTZXJ2aWNlLCAnJyk7XHJcbiAgICAgIHVybCA9IHNhdmVDb250ZXh0LnJvdXRlUHJlZml4ICsgJyRiYXRjaCc7XHJcbiAgICB9XHJcblxyXG4gICAgbGV0IHJlcXVlc3REYXRhID0gY3JlYXRlQ2hhbmdlUmVxdWVzdHMoc2F2ZUNvbnRleHQsIHNhdmVCdW5kbGUpO1xyXG4gICAgbGV0IHRlbXBLZXlzID0gc2F2ZUNvbnRleHQudGVtcEtleXM7XHJcbiAgICBsZXQgY29udGVudEtleXMgPSBzYXZlQ29udGV4dC5jb250ZW50S2V5cztcclxuICAgIGxldCBwcm9taXNlID0gbmV3IFByb21pc2U8YnJlZXplLlNhdmVSZXN1bHQ+KChyZXNvbHZlLCByZWplY3QpID0+IHtcclxuICAgICAgT0RhdGEucmVxdWVzdCh7XHJcbiAgICAgICAgaGVhZGVyczogY29yZS5leHRlbmQoe30sIHRoaXMuaGVhZGVycyksXHJcbiAgICAgICAgcmVxdWVzdFVyaTogdXJsLFxyXG4gICAgICAgIG1ldGhvZDogXCJQT1NUXCIsXHJcbiAgICAgICAgZGF0YTogcmVxdWVzdERhdGFcclxuICAgICAgfSwgZnVuY3Rpb24gKGRhdGE6IGFueSwgcmVzcG9uc2U6IGFueSkge1xyXG4gICAgICAgIGxldCBlbnRpdGllczogYW55W10gPSBbXTtcclxuICAgICAgICBsZXQga2V5TWFwcGluZ3M6IGJyZWV6ZS5LZXlNYXBwaW5nW10gPSBbXTtcclxuICAgICAgICBsZXQgc2F2ZVJlc3VsdDogYnJlZXplLlNhdmVSZXN1bHQgPSB7IGVudGl0aWVzOiBlbnRpdGllcywga2V5TWFwcGluZ3M6IGtleU1hcHBpbmdzIH07XHJcbiAgICAgICAgZGF0YS5fX2JhdGNoUmVzcG9uc2VzLmZvckVhY2goZnVuY3Rpb24gKGJyOiBhbnkpIHtcclxuICAgICAgICAgIGJyLl9fY2hhbmdlUmVzcG9uc2VzLmZvckVhY2goZnVuY3Rpb24gKGNyOiBhbnkpIHtcclxuICAgICAgICAgICAgbGV0IHJlc3BvbnNlID0gY3IucmVzcG9uc2UgfHwgY3I7XHJcbiAgICAgICAgICAgIGxldCBzdGF0dXNDb2RlID0gcmVzcG9uc2Uuc3RhdHVzQ29kZTtcclxuICAgICAgICAgICAgaWYgKCghc3RhdHVzQ29kZSkgfHwgc3RhdHVzQ29kZSA+PSA0MDApIHtcclxuICAgICAgICAgICAgICByZWplY3QoY3JlYXRlRXJyb3IoY3IsIHVybCkpO1xyXG4gICAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgbGV0IGNvbnRlbnRJZCA9IGNyLmhlYWRlcnNbXCJDb250ZW50LUlEXCJdO1xyXG4gICAgICAgICAgICAvLyBPbGluZ28gc2VuZHMgZGlmZmVyZW50IGNhc2Ugb2YgJ0lEJyBmb3IgdGhlIGhlYWRlciBuYW1lLlxyXG4gICAgICAgICAgICBpZiAoIWNvbnRlbnRJZCkge1xyXG4gICAgICAgICAgICAgIGNvbnRlbnRJZCA9IGNyLmhlYWRlcnNbXCJDb250ZW50LUlkXCJdO1xyXG4gICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICBsZXQgcmF3RW50aXR5ID0gY3IuZGF0YTtcclxuICAgICAgICAgICAgaWYgKHJhd0VudGl0eSkge1xyXG4gICAgICAgICAgICAgIGxldCB0ZW1wS2V5ID0gdGVtcEtleXNbY29udGVudElkXTtcclxuICAgICAgICAgICAgICBpZiAodGVtcEtleSkge1xyXG4gICAgICAgICAgICAgICAgbGV0IGVudGl0eVR5cGUgPSB0ZW1wS2V5LmVudGl0eVR5cGU7XHJcbiAgICAgICAgICAgICAgICBpZiAoZW50aXR5VHlwZS5hdXRvR2VuZXJhdGVkS2V5VHlwZSAhPT0gYnJlZXplLkF1dG9HZW5lcmF0ZWRLZXlUeXBlLk5vbmUpIHtcclxuICAgICAgICAgICAgICAgICAgbGV0IHRlbXBWYWx1ZSA9IHRlbXBLZXkudmFsdWVzWzBdO1xyXG4gICAgICAgICAgICAgICAgICBsZXQgcmVhbEtleSA9IGVudGl0eVR5cGUuZ2V0RW50aXR5S2V5RnJvbVJhd0VudGl0eShyYXdFbnRpdHksIGJyZWV6ZS5EYXRhUHJvcGVydHkuZ2V0UmF3VmFsdWVGcm9tU2VydmVyKTtcclxuICAgICAgICAgICAgICAgICAgbGV0IGtleU1hcHBpbmcgPSB7IGVudGl0eVR5cGVOYW1lOiBlbnRpdHlUeXBlLm5hbWUsIHRlbXBWYWx1ZTogdGVtcFZhbHVlLCByZWFsVmFsdWU6IHJlYWxLZXkudmFsdWVzWzBdIH07XHJcbiAgICAgICAgICAgICAgICAgIGtleU1hcHBpbmdzLnB1c2goa2V5TWFwcGluZyk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgIGVudGl0aWVzLnB1c2gocmF3RW50aXR5KTtcclxuICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICBsZXQgb3JpZ0VudGl0eSA9IGNvbnRlbnRLZXlzW2NvbnRlbnRJZF07XHJcbiAgICAgICAgICAgICAgZW50aXRpZXMucHVzaChvcmlnRW50aXR5KTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgfSk7XHJcbiAgICAgICAgfSk7XHJcbiAgICAgICAgcmV0dXJuIHJlc29sdmUoc2F2ZVJlc3VsdCk7XHJcbiAgICAgIH0sIGZ1bmN0aW9uIChlcnI6IGFueSkge1xyXG4gICAgICAgIHJldHVybiByZWplY3QoY3JlYXRlRXJyb3IoZXJyLCB1cmwpKTtcclxuICAgICAgfSwgT0RhdGEuYmF0Y2hIYW5kbGVyKTtcclxuICAgIH0pO1xyXG4gICAgcmV0dXJuIHByb21pc2U7XHJcblxyXG4gIH1cclxuXHJcbiAganNvblJlc3VsdHNBZGFwdGVyOiBicmVlemUuSnNvblJlc3VsdHNBZGFwdGVyID0gbmV3IGJyZWV6ZS5Kc29uUmVzdWx0c0FkYXB0ZXIoe1xyXG4gICAgbmFtZTogXCJPRGF0YV9kZWZhdWx0XCIsXHJcblxyXG4gICAgdmlzaXROb2RlOiBmdW5jdGlvbiAobm9kZTogYW55LCBtYXBwaW5nQ29udGV4dDogYnJlZXplLk1hcHBpbmdDb250ZXh0LCBub2RlQ29udGV4dDogYnJlZXplLk5vZGVDb250ZXh0KSB7XHJcbiAgICAgIGxldCByZXN1bHQ6IGFueSA9IHt9O1xyXG4gICAgICBpZiAobm9kZSA9PSBudWxsKSByZXR1cm4gcmVzdWx0O1xyXG4gICAgICBsZXQgbWV0YWRhdGEgPSBub2RlLl9fbWV0YWRhdGE7XHJcbiAgICAgIGlmIChtZXRhZGF0YSAhPSBudWxsKSB7XHJcbiAgICAgICAgLy8gVE9ETzogbWF5IGJlIGFibGUgdG8gbWFrZSB0aGlzIG1vcmUgZWZmaWNpZW50IGJ5IGNhY2hpbmcgb2YgdGhlIHByZXZpb3VzIHZhbHVlLlxyXG4gICAgICAgIGxldCBlbnRpdHlUeXBlTmFtZSA9IGJyZWV6ZS5NZXRhZGF0YVN0b3JlLm5vcm1hbGl6ZVR5cGVOYW1lKG1ldGFkYXRhLnR5cGUpO1xyXG4gICAgICAgIGxldCBldCA9IGVudGl0eVR5cGVOYW1lICYmIG1hcHBpbmdDb250ZXh0LmVudGl0eU1hbmFnZXIubWV0YWRhdGFTdG9yZS5nZXRFbnRpdHlUeXBlKGVudGl0eVR5cGVOYW1lLCB0cnVlKTtcclxuICAgICAgICAvLyBPRGF0YSByZXNwb25zZSBkb2Vzbid0IGRpc3Rpbmd1aXNoIGEgcHJvamVjdGlvbiBmcm9tIGEgd2hvbGUgZW50aXR5LlxyXG4gICAgICAgIC8vIFdlJ2xsIGFzc3VtZSB0aGF0IHdob2xlLWVudGl0eSBkYXRhIHdvdWxkIGhhdmUgYXQgbGVhc3QgYXMgbWFueSBwcm9wZXJ0aWVzICAoPD0pXHJcbiAgICAgICAgLy8gYXMgdGhlIEVudGl0eVR5cGUgaGFzIG1hcHBlZCBwcm9wZXJ0aWVzIG9uIHRoZSBiYXNpcyB0aGF0XHJcbiAgICAgICAgLy8gbW9zdCBwcm9qZWN0aW9ucyByZW1vdmUgcHJvcGVydGllcyByYXRoZXIgdGhhbiBhZGQgdGhlbS5cclxuICAgICAgICAvLyBJZiBub3QsIGFzc3VtZSBpdCdzIGEgcHJvamVjdGlvbiBhbmQgZG8gTk9UIHRyZWF0IGFzIGFuIGVudGl0eVxyXG4gICAgICAgIGlmIChldCAmJiBldC5fbWFwcGVkUHJvcGVydGllc0NvdW50IDw9IE9iamVjdC5rZXlzKG5vZGUpLmxlbmd0aCAtIDEpIHtcclxuICAgICAgICAgIC8vIGlmIChldCAmJiBldC5fbWFwcGVkUHJvcGVydGllc0NvdW50ID09PSBPYmplY3Qua2V5cyhub2RlKS5sZW5ndGggLSAxKSB7IC8vIE9MRFxyXG4gICAgICAgICAgcmVzdWx0LmVudGl0eVR5cGUgPSBldDtcclxuICAgICAgICAgIGxldCB1cmlLZXkgPSBtZXRhZGF0YS51cmkgfHwgbWV0YWRhdGEuaWQ7XHJcbiAgICAgICAgICBpZiAodXJpS2V5KSB7XHJcbiAgICAgICAgICAgIC8vIFN0cmlwIGJhc2VVcmkgdG8gbWFrZSB1cmlLZXkgYSByZWxhdGl2ZSB1cmlcclxuICAgICAgICAgICAgLy8gVG9kbzogd2h5IGlzIHRoaXMgbmVjZXNzYXJ5IHdoZW4gYWJzb2x1dGUgd29ya3MgZm9yIGV2ZXJ5IE9EYXRhIHNvdXJjZSB0ZXN0ZWQ/XHJcbiAgICAgICAgICAgIGxldCByZSA9IG5ldyBSZWdFeHAoJ14nICsgbWFwcGluZ0NvbnRleHQuZGF0YVNlcnZpY2Uuc2VydmljZU5hbWUsICdpJyk7XHJcbiAgICAgICAgICAgIHVyaUtleSA9IHVyaUtleS5yZXBsYWNlKHJlLCAnJyk7XHJcbiAgICAgICAgICB9XHJcbiAgICAgICAgICByZXN1bHQuZXh0cmFNZXRhZGF0YSA9IHtcclxuICAgICAgICAgICAgdXJpS2V5OiB1cmlLZXksXHJcbiAgICAgICAgICAgIGV0YWc6IG1ldGFkYXRhLmV0YWdcclxuICAgICAgICAgIH07XHJcbiAgICAgICAgfVxyXG4gICAgICB9XHJcbiAgICAgIC8vIE9EYXRhIHYzIC0gcHJvamVjdGlvbiBhcnJheXMgd2lsbCBiZSBlbmNsb3NlZCBpbiBhIHJlc3VsdHMgYXJyYXlcclxuICAgICAgaWYgKG5vZGUucmVzdWx0cykge1xyXG4gICAgICAgIHJlc3VsdC5ub2RlID0gbm9kZS5yZXN1bHRzO1xyXG4gICAgICB9XHJcblxyXG4gICAgICBsZXQgcHJvcGVydHlOYW1lID0gbm9kZUNvbnRleHQucHJvcGVydHlOYW1lO1xyXG4gICAgICByZXN1bHQuaWdub3JlID0gbm9kZS5fX2RlZmVycmVkICE9IG51bGwgfHwgcHJvcGVydHlOYW1lID09PSBcIl9fbWV0YWRhdGFcIiB8fFxyXG4gICAgICAgIC8vIEVudGl0eUtleSBwcm9wZXJ0aWVzIGNhbiBiZSBwcm9kdWNlZCBieSBFRE1YIG1vZGVsc1xyXG4gICAgICAgIChwcm9wZXJ0eU5hbWUgPT09IFwiRW50aXR5S2V5XCIgJiYgbm9kZS4kdHlwZSAmJiBjb3JlLnN0cmluZ1N0YXJ0c1dpdGgobm9kZS4kdHlwZSwgXCJTeXN0ZW0uRGF0YVwiKSk7XHJcbiAgICAgIHJldHVybiByZXN1bHQ7XHJcbiAgICB9XHJcblxyXG4gIH0pO1xyXG5cclxuICBnZXRBYnNvbHV0ZVVybChkYXRhU2VydmljZTogYnJlZXplLkRhdGFTZXJ2aWNlLCB1cmw6IHN0cmluZykge1xyXG4gICAgbGV0IHNlcnZpY2VOYW1lID0gZGF0YVNlcnZpY2UucXVhbGlmeVVybCgnJyk7XHJcbiAgICAvLyBvbmx5IHByZWZpeCB3aXRoIHNlcnZpY2VOYW1lIGlmIG5vdCBhbHJlYWR5IG9uIHRoZSB1cmxcclxuICAgIGxldCBiYXNlID0gKGNvcmUuc3RyaW5nU3RhcnRzV2l0aCh1cmwsIHNlcnZpY2VOYW1lKSkgPyAnJyA6IHNlcnZpY2VOYW1lO1xyXG4gICAgLy8gSWYgbm8gcHJvdG9jb2wsIHR1cm4gYmFzZSBpbnRvIGFuIGFic29sdXRlIFVSSVxyXG4gICAgaWYgKHdpbmRvdyAmJiBzZXJ2aWNlTmFtZS5pbmRleE9mKCcvLycpIDwgMCkge1xyXG4gICAgICAvLyBubyBwcm90b2NvbDsgbWFrZSBpdCBhYnNvbHV0ZVxyXG4gICAgICBiYXNlID0gd2luZG93LmxvY2F0aW9uLnByb3RvY29sICsgJy8vJyArIHdpbmRvdy5sb2NhdGlvbi5ob3N0ICtcclxuICAgICAgICAoY29yZS5zdHJpbmdTdGFydHNXaXRoKHNlcnZpY2VOYW1lLCAnLycpID8gJycgOiAnLycpICtcclxuICAgICAgICBiYXNlO1xyXG4gICAgfVxyXG4gICAgcmV0dXJuIGJhc2UgKyB1cmw7XHJcbiAgfVxyXG5cclxuICBnZXRSb3V0ZVByZWZpeChkYXRhU2VydmljZTogYnJlZXplLkRhdGFTZXJ2aWNlKSB7XHJcbiAgICAvLyBHZXQgdGhlIHJvdXRlUHJlZml4IGZyb20gYSBXZWIgQVBJIE9EYXRhIHNlcnZpY2UgbmFtZS5cclxuICAgIC8vIFRoZSByb3V0ZVByZWZpeCBpcyBwcmVzdW1lZCB0byBiZSB0aGUgcGF0aG5hbWUgd2l0aGluIHRoZSBkYXRhU2VydmljZS5zZXJ2aWNlTmFtZVxyXG4gICAgLy8gRXhhbXBsZXMgb2Ygc2VydmljZW5hbWUgLT4gcm91dGVQcmVmaXg6XHJcbiAgICAvLyAgICdodHRwOi8vbG9jYWxob3N0OjU1ODAyL29kYXRhLycgLT4gJ29kYXRhLydcclxuICAgIC8vICAgJ2h0dHA6Ly8xOTguMTU0LjEyMS43NS9zZXJ2aWNlL29kYXRhLycgLT4gJ3NlcnZpY2Uvb2RhdGEvJ1xyXG4gICAgbGV0IHBhcnNlcjogYW55O1xyXG4gICAgaWYgKHR5cGVvZiBkb2N1bWVudCA9PT0gJ29iamVjdCcpIHsgLy8gYnJvd3NlclxyXG4gICAgICBwYXJzZXIgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdhJyk7XHJcbiAgICAgIHBhcnNlci5ocmVmID0gZGF0YVNlcnZpY2Uuc2VydmljZU5hbWU7XHJcbiAgICB9IGVsc2UgeyAvLyBub2RlXHJcbiAgICAgIC8vIFRPRE86IGhvdyB0byBiZXN0IGhhbmRsZSB0aGlzXHJcbiAgICAgIC8vIGFzc3VtZXMgZXhpc3RlbmNlIG9mIG5vZGUncyB1cmwucGFyc2UgbWV0aG9kLlxyXG4gICAgICBwYXJzZXIgPSB1cmwucGFyc2UoZGF0YVNlcnZpY2Uuc2VydmljZU5hbWUpO1xyXG4gICAgfVxyXG4gICAgbGV0IHByZWZpeCA9IHBhcnNlci5wYXRobmFtZTtcclxuICAgIGlmIChwcmVmaXhbMF0gPT09ICcvJykge1xyXG4gICAgICBwcmVmaXggPSBwcmVmaXguc3Vic3RyKDEpO1xyXG4gICAgfSAvLyBkcm9wIGxlYWRpbmcgJy8nICAoYWxsIGJ1dCBJRSlcclxuICAgIGlmIChwcmVmaXguc3Vic3RyKC0xKSAhPT0gJy8nKSB7XHJcbiAgICAgIHByZWZpeCArPSAnLyc7XHJcbiAgICB9ICAgICAgLy8gZW5zdXJlIHRyYWlsaW5nICcvJ1xyXG4gICAgcmV0dXJuIHByZWZpeDtcclxuICB9XHJcblxyXG59XHJcblxyXG4vLyBjcnVkZSBzZXJpYWxpemVyLiAgRG9lc24ndCByZWN1cnNlXHJcbmZ1bmN0aW9uIHRvUXVlcnlTdHJpbmcob2JqOiBPYmplY3QpIHtcclxuICBsZXQgcGFydHM6IHN0cmluZ1tdID0gW107XHJcbiAgZm9yIChsZXQgaSBpbiBvYmopIHtcclxuICAgIGlmIChvYmouaGFzT3duUHJvcGVydHkoaSkpIHtcclxuICAgICAgcGFydHMucHVzaChlbmNvZGVVUklDb21wb25lbnQoaSkgKyBcIj1cIiArIGVuY29kZVVSSUNvbXBvbmVudChvYmpbaV0pKTtcclxuICAgIH1cclxuICB9XHJcbiAgcmV0dXJuIHBhcnRzLmpvaW4oXCImXCIpO1xyXG59XHJcblxyXG5mdW5jdGlvbiB0cmFuc2Zvcm1WYWx1ZShwcm9wOiBicmVlemUuRGF0YVByb3BlcnR5LCB2YWw6IGFueSkge1xyXG4gIGlmIChwcm9wLmlzVW5tYXBwZWQpIHJldHVybiB1bmRlZmluZWQ7XHJcbiAgaWYgKHByb3AuZGF0YVR5cGUgPT09IGJyZWV6ZS5EYXRhVHlwZS5EYXRlVGltZU9mZnNldCkge1xyXG4gICAgLy8gVGhlIGRhdGFqcyBsaWIgdHJpZXMgdG8gdHJlYXQgY2xpZW50IGRhdGVUaW1lcyB0aGF0IGFyZSBkZWZpbmVkIGFzIERhdGVUaW1lT2Zmc2V0IG9uIHRoZSBzZXJ2ZXIgZGlmZmVyZW50bHlcclxuICAgIC8vIGZyb20gb3RoZXIgZGF0ZVRpbWVzLiBUaGlzIGZpeCBjb21wZW5zYXRlcyBiZWZvcmUgdGhlIHNhdmUuXHJcbiAgICB2YWwgPSB2YWwgJiYgbmV3IERhdGUodmFsLmdldFRpbWUoKSAtICh2YWwuZ2V0VGltZXpvbmVPZmZzZXQoKSAqIDYwMDAwKSk7XHJcbiAgfSBlbHNlIGlmICgocHJvcC5kYXRhVHlwZSBhcyBicmVlemUuRGF0YVR5cGUpLnF1b3RlSnNvbk9EYXRhKSB7XHJcbiAgICB2YWwgPSB2YWwgIT0gbnVsbCA/IHZhbC50b1N0cmluZygpIDogdmFsO1xyXG4gIH1cclxuICByZXR1cm4gdmFsO1xyXG59XHJcblxyXG5mdW5jdGlvbiBjcmVhdGVDaGFuZ2VSZXF1ZXN0cyhzYXZlQ29udGV4dDogT0RhdGFTYXZlQ29udGV4dCwgc2F2ZUJ1bmRsZTogYnJlZXplLlNhdmVCdW5kbGUpIHtcclxuICBsZXQgY2hhbmdlUmVxdWVzdEludGVyY2VwdG9yID0gKHNhdmVDb250ZXh0LmFkYXB0ZXIgYXMgRGF0YVNlcnZpY2VPRGF0YUFkYXB0ZXIpLl9jcmVhdGVDaGFuZ2VSZXF1ZXN0SW50ZXJjZXB0b3Ioc2F2ZUNvbnRleHQsIHNhdmVCdW5kbGUpO1xyXG4gIGxldCBjaGFuZ2VSZXF1ZXN0czogYW55W10gPSBbXTtcclxuICBsZXQgdGVtcEtleXM6IGJyZWV6ZS5FbnRpdHlLZXlbXSA9IFtdO1xyXG4gIGxldCBjb250ZW50S2V5czogYnJlZXplLkVudGl0eVtdID0gW107XHJcbiAgbGV0IGVudGl0eU1hbmFnZXIgPSBzYXZlQ29udGV4dC5lbnRpdHlNYW5hZ2VyO1xyXG4gIGxldCBoZWxwZXIgPSBlbnRpdHlNYW5hZ2VyLmhlbHBlcjtcclxuICBsZXQgaWQgPSAwO1xyXG4gIGxldCByb3V0ZVByZWZpeCA9IHNhdmVDb250ZXh0LnJvdXRlUHJlZml4O1xyXG5cclxuICBzYXZlQnVuZGxlLmVudGl0aWVzLmZvckVhY2goZnVuY3Rpb24gKGVudGl0eSwgaW5kZXgpIHtcclxuICAgIGxldCBhc3BlY3QgPSBlbnRpdHkuZW50aXR5QXNwZWN0O1xyXG4gICAgaWQgPSBpZCArIDE7IC8vIHdlIGFyZSBkZWxpYmVyYXRlbHkgc2tpcHBpbmcgaWQ9MCBiZWNhdXNlIENvbnRlbnQtSUQgPSAwIHNlZW1zIHRvIGJlIGlnbm9yZWQuXHJcbiAgICBsZXQgcmVxdWVzdCA9IHsgaGVhZGVyczogeyBcIkNvbnRlbnQtSURcIjogaWQsIFwiRGF0YVNlcnZpY2VWZXJzaW9uXCI6IFwiMi4wXCIgfSB9IGFzIGFueTtcclxuICAgIGNvbnRlbnRLZXlzW2lkXSA9IGVudGl0eTtcclxuICAgIGlmIChhc3BlY3QuZW50aXR5U3RhdGUuaXNBZGRlZCgpKSB7XHJcbiAgICAgIHJlcXVlc3QucmVxdWVzdFVyaSA9IHJvdXRlUHJlZml4ICsgZW50aXR5LmVudGl0eVR5cGUuZGVmYXVsdFJlc291cmNlTmFtZTtcclxuICAgICAgcmVxdWVzdC5tZXRob2QgPSBcIlBPU1RcIjtcclxuICAgICAgcmVxdWVzdC5kYXRhID0gaGVscGVyLnVud3JhcEluc3RhbmNlKGVudGl0eSwgdHJhbnNmb3JtVmFsdWUpO1xyXG4gICAgICB0ZW1wS2V5c1tpZF0gPSBhc3BlY3QuZ2V0S2V5KCk7XHJcbiAgICB9IGVsc2UgaWYgKGFzcGVjdC5lbnRpdHlTdGF0ZS5pc01vZGlmaWVkKCkpIHtcclxuICAgICAgdXBkYXRlRGVsZXRlTWVyZ2VSZXF1ZXN0KHJlcXVlc3QsIGFzcGVjdCwgcm91dGVQcmVmaXghKTtcclxuICAgICAgcmVxdWVzdC5tZXRob2QgPSBcIk1FUkdFXCI7XHJcbiAgICAgIHJlcXVlc3QuZGF0YSA9IGhlbHBlci51bndyYXBDaGFuZ2VkVmFsdWVzKGVudGl0eSwgZW50aXR5TWFuYWdlci5tZXRhZGF0YVN0b3JlLCB0cmFuc2Zvcm1WYWx1ZSk7XHJcbiAgICAgIC8vIHNob3VsZCBiZSBhIFBBVENIL01FUkdFXHJcbiAgICB9IGVsc2UgaWYgKGFzcGVjdC5lbnRpdHlTdGF0ZS5pc0RlbGV0ZWQoKSkge1xyXG4gICAgICB1cGRhdGVEZWxldGVNZXJnZVJlcXVlc3QocmVxdWVzdCwgYXNwZWN0LCByb3V0ZVByZWZpeCEpO1xyXG4gICAgICByZXF1ZXN0Lm1ldGhvZCA9IFwiREVMRVRFXCI7XHJcbiAgICB9IGVsc2Uge1xyXG4gICAgICByZXR1cm47XHJcbiAgICB9XHJcbiAgICByZXF1ZXN0ID0gY2hhbmdlUmVxdWVzdEludGVyY2VwdG9yLmdldFJlcXVlc3QocmVxdWVzdCwgZW50aXR5LCBpbmRleCk7XHJcbiAgICBjaGFuZ2VSZXF1ZXN0cy5wdXNoKHJlcXVlc3QpO1xyXG4gIH0pO1xyXG4gIHNhdmVDb250ZXh0LmNvbnRlbnRLZXlzID0gY29udGVudEtleXM7XHJcbiAgc2F2ZUNvbnRleHQudGVtcEtleXMgPSB0ZW1wS2V5cztcclxuICBjaGFuZ2VSZXF1ZXN0SW50ZXJjZXB0b3IuZG9uZShjaGFuZ2VSZXF1ZXN0cyk7XHJcbiAgcmV0dXJuIHtcclxuICAgIF9fYmF0Y2hSZXF1ZXN0czogW1xyXG4gICAgICB7XHJcbiAgICAgICAgX19jaGFuZ2VSZXF1ZXN0czogY2hhbmdlUmVxdWVzdHNcclxuICAgICAgfVxyXG4gICAgXVxyXG4gIH07XHJcblxyXG59XHJcblxyXG5mdW5jdGlvbiB1cGRhdGVEZWxldGVNZXJnZVJlcXVlc3QocmVxdWVzdDogYW55LCBhc3BlY3Q6IGJyZWV6ZS5FbnRpdHlBc3BlY3QsIHJvdXRlUHJlZml4OiBzdHJpbmcpIHtcclxuICBsZXQgdXJpS2V5OiBzdHJpbmc7XHJcbiAgbGV0IGV4dHJhTWV0YWRhdGEgPSBhc3BlY3QuZXh0cmFNZXRhZGF0YTtcclxuICBpZiAoZXh0cmFNZXRhZGF0YSA9PSBudWxsKSB7XHJcbiAgICB1cmlLZXkgPSBnZXRVcmlLZXkoYXNwZWN0KTtcclxuICAgIGFzcGVjdC5leHRyYU1ldGFkYXRhID0ge1xyXG4gICAgICB1cmlLZXk6IHVyaUtleVxyXG4gICAgfTtcclxuICB9IGVsc2Uge1xyXG4gICAgdXJpS2V5ID0gZXh0cmFNZXRhZGF0YS51cmlLZXk7XHJcbiAgICBpZiAoZXh0cmFNZXRhZGF0YS5ldGFnKSB7XHJcbiAgICAgIHJlcXVlc3QuaGVhZGVyc1tcIklmLU1hdGNoXCJdID0gZXh0cmFNZXRhZGF0YS5ldGFnO1xyXG4gICAgfVxyXG4gIH1cclxuICByZXF1ZXN0LnJlcXVlc3RVcmkgPVxyXG4gICAgLy8gdXNlIHJvdXRlUHJlZml4IGlmIHVyaUtleSBsYWNrcyBwcm90b2NvbCAoaS5lLiwgcmVsYXRpdmUgdXJpKVxyXG4gICAgdXJpS2V5LmluZGV4T2YoJy8vJykgPiAwID8gdXJpS2V5IDogcm91dGVQcmVmaXggKyB1cmlLZXk7XHJcbn1cclxuXHJcbmZ1bmN0aW9uIGdldFVyaUtleShhc3BlY3Q6IGJyZWV6ZS5FbnRpdHlBc3BlY3QpIHtcclxuICBsZXQgZW50aXR5VHlwZSA9IGFzcGVjdC5lbnRpdHkhLmVudGl0eVR5cGU7XHJcbiAgbGV0IHJlc291cmNlTmFtZSA9IGVudGl0eVR5cGUuZGVmYXVsdFJlc291cmNlTmFtZTtcclxuICBsZXQga3BzID0gZW50aXR5VHlwZS5rZXlQcm9wZXJ0aWVzO1xyXG4gIGxldCB1cmlLZXkgPSByZXNvdXJjZU5hbWUgKyBcIihcIjtcclxuICBpZiAoa3BzLmxlbmd0aCA9PT0gMSkge1xyXG4gICAgdXJpS2V5ID0gdXJpS2V5ICsgZm10UHJvcGVydHkoa3BzWzBdLCBhc3BlY3QpICsgXCIpXCI7XHJcbiAgfSBlbHNlIHtcclxuICAgIGxldCBkZWxpbSA9IFwiXCI7XHJcbiAgICBrcHMuZm9yRWFjaChmdW5jdGlvbiAoa3ApIHtcclxuICAgICAgdXJpS2V5ID0gdXJpS2V5ICsgZGVsaW0gKyBrcC5uYW1lT25TZXJ2ZXIgKyBcIj1cIiArIGZtdFByb3BlcnR5KGtwLCBhc3BlY3QpO1xyXG4gICAgICBkZWxpbSA9IFwiLFwiO1xyXG4gICAgfSk7XHJcbiAgICB1cmlLZXkgPSB1cmlLZXkgKyBcIilcIjtcclxuICB9XHJcbiAgcmV0dXJuIHVyaUtleTtcclxufVxyXG5cclxuZnVuY3Rpb24gZm10UHJvcGVydHkocHJvcDogYnJlZXplLkRhdGFQcm9wZXJ0eSwgYXNwZWN0OiBicmVlemUuRW50aXR5QXNwZWN0KSB7XHJcbiAgcmV0dXJuIChwcm9wLmRhdGFUeXBlIGFzIGJyZWV6ZS5EYXRhVHlwZSkuZm10T0RhdGEhKGFzcGVjdC5nZXRQcm9wZXJ0eVZhbHVlKHByb3AubmFtZSkpO1xyXG59XHJcblxyXG5mdW5jdGlvbiBjcmVhdGVFcnJvcihlcnJvcjogYW55LCB1cmw6IHN0cmluZykge1xyXG4gIC8vIE9EYXRhIGVycm9ycyBjYW4gaGF2ZSB0aGUgbWVzc2FnZSBidXJpZWQgdmVyeSBkZWVwbHkgLSBhbmQgbm9ub2J2aW91c2x5XHJcbiAgLy8gdGhpcyBjb2RlIGlzIHRyaWNreSBzbyBiZSBjYXJlZnVsIGNoYW5naW5nIHRoZSByZXNwb25zZS5ib2R5IHBhcnNpbmcuXHJcbiAgbGV0IHJlc3VsdCA9IG5ldyBFcnJvcigpIGFzIGJyZWV6ZS5TZXJ2ZXJFcnJvcjtcclxuICBsZXQgcmVzcG9uc2UgPSBlcnJvciAmJiBlcnJvci5yZXNwb25zZTtcclxuICBpZiAoIXJlc3BvbnNlKSB7XHJcbiAgICAvLyBpbiBjYXNlIERhdGFKUyByZXR1cm5zIFwiTm8gaGFuZGxlciBmb3IgdGhpcyBkYXRhXCJcclxuICAgIHJlc3VsdC5tZXNzYWdlID0gZXJyb3I7XHJcbiAgICByZXN1bHQuc3RhdHVzVGV4dCA9IGVycm9yO1xyXG4gICAgcmV0dXJuIHJlc3VsdDtcclxuICB9XHJcbiAgcmVzdWx0Lm1lc3NhZ2UgPSByZXNwb25zZS5zdGF0dXNUZXh0O1xyXG4gIHJlc3VsdC5zdGF0dXNUZXh0ID0gcmVzcG9uc2Uuc3RhdHVzVGV4dDtcclxuICByZXN1bHQuc3RhdHVzID0gcmVzcG9uc2Uuc3RhdHVzQ29kZTtcclxuICAvLyBub24gc3RkXHJcbiAgaWYgKHVybCkgcmVzdWx0LnVybCA9IHVybDtcclxuICByZXN1bHQuYm9keSA9IHJlc3BvbnNlLmJvZHk7XHJcbiAgaWYgKHJlc3BvbnNlLmJvZHkpIHtcclxuICAgIGxldCBuZXh0RXJyOiBhbnk7XHJcbiAgICB0cnkge1xyXG4gICAgICBsZXQgYm9keSA9IEpTT04ucGFyc2UocmVzcG9uc2UuYm9keSk7XHJcbiAgICAgIHJlc3VsdC5ib2R5ID0gYm9keTtcclxuICAgICAgLy8gT0RhdGEgdjMgbG9naWNcclxuICAgICAgaWYgKGJvZHlbJ29kYXRhLmVycm9yJ10pIHtcclxuICAgICAgICBib2R5ID0gYm9keVsnb2RhdGEuZXJyb3InXTtcclxuICAgICAgfVxyXG4gICAgICBsZXQgbXNnID0gXCJcIjtcclxuICAgICAgZG8ge1xyXG4gICAgICAgIG5leHRFcnIgPSBib2R5LmVycm9yIHx8IGJvZHkuaW5uZXJlcnJvcjtcclxuICAgICAgICBpZiAoIW5leHRFcnIpIG1zZyA9IG1zZyArIGdldE1lc3NhZ2UoYm9keSk7XHJcbiAgICAgICAgbmV4dEVyciA9IG5leHRFcnIgfHwgYm9keS5pbnRlcm5hbGV4Y2VwdGlvbjtcclxuICAgICAgICBib2R5ID0gbmV4dEVyciB8fCBib2R5O1xyXG4gICAgICB9IHdoaWxlIChuZXh0RXJyKTtcclxuICAgICAgaWYgKG1zZy5sZW5ndGggPiAwKSB7XHJcbiAgICAgICAgcmVzdWx0Lm1lc3NhZ2UgPSBtc2c7XHJcbiAgICAgIH1cclxuICAgIH0gY2F0Y2ggKGUpIHtcclxuXHJcbiAgICB9XHJcbiAgfVxyXG4gIGJyZWV6ZS5BYnN0cmFjdERhdGFTZXJ2aWNlQWRhcHRlci5fY2F0Y2hOb0Nvbm5lY3Rpb25FcnJvcihyZXN1bHQpO1xyXG4gIHJldHVybiByZXN1bHQ7XHJcbn1cclxuXHJcbmZ1bmN0aW9uIGdldE1lc3NhZ2UoYm9keTogYW55KSB7XHJcbiAgbGV0IG1zZyA9IGJvZHkubWVzc2FnZSB8fCBcIlwiO1xyXG4gIHJldHVybiAoKHR5cGVvZiAobXNnKSA9PT0gXCJzdHJpbmdcIikgPyBtc2cgOiBtc2cudmFsdWUpICsgXCI7IFwiO1xyXG59XHJcblxyXG5icmVlemUuY29uZmlnLnJlZ2lzdGVyQWRhcHRlcihcImRhdGFTZXJ2aWNlXCIsIERhdGFTZXJ2aWNlT0RhdGFBZGFwdGVyKTtcclxuXHJcblxyXG5sZXQgd2ViQXBpT0RhdGFDdG9yID0gZnVuY3Rpb24gKCkge1xyXG4gIHRoaXMubmFtZSA9IFwid2ViQXBpT0RhdGFcIjtcclxufTtcclxuXHJcbmJyZWV6ZS5jb3JlLmV4dGVuZCh3ZWJBcGlPRGF0YUN0b3IucHJvdG90eXBlLCBEYXRhU2VydmljZU9EYXRhQWRhcHRlci5wcm90b3R5cGUpO1xyXG5cclxuYnJlZXplLmNvbmZpZy5yZWdpc3RlckFkYXB0ZXIoXCJkYXRhU2VydmljZVwiLCB3ZWJBcGlPRGF0YUN0b3IgYXMgYW55KTtcclxuLy8gT0RhdGEgNCBhZGFwdGVyXHJcbmxldCB3ZWJBcGlPRGF0YTRDdG9yID0gZnVuY3Rpb24gKCkge1xyXG4gIHRoaXMubmFtZSA9IFwid2ViQXBpT0RhdGE0XCI7XHJcbn07XHJcbmJyZWV6ZS5jb3JlLmV4dGVuZCh3ZWJBcGlPRGF0YTRDdG9yLnByb3RvdHlwZSwgd2ViQXBpT0RhdGFDdG9yLnByb3RvdHlwZSk7XHJcbndlYkFwaU9EYXRhNEN0b3IucHJvdG90eXBlLmluaXRpYWxpemUgPSBmdW5jdGlvbiAoKSB7XHJcbiAgLy8gQWFyZ2guLi4gdGhleSBtb3ZlZCB0aGUgY2hlZXNlLlxyXG4gIGxldCBkYXRhanMgPSBjb3JlLnJlcXVpcmVMaWIoXCJkYXRhanNcIiwgXCJOZWVkZWQgdG8gc3VwcG9ydCByZW1vdGUgT0RhdGEgdjQgc2VydmljZXNcIik7XHJcbiAgT0RhdGEgPSBkYXRhanMuVjQub0RhdGE7XHJcbiAgT0RhdGEuanNvbi5qc29uSGFuZGxlci5yZWNvZ25pemVEYXRlcyA9IHRydWU7XHJcbn07XHJcbndlYkFwaU9EYXRhNEN0b3IucHJvdG90eXBlLmhlYWRlcnMgPSB7IFwiT0RhdGEtVmVyc2lvblwiOiBcIjQuMFwiIH07XHJcbmJyZWV6ZS5jb25maWcucmVnaXN0ZXJBZGFwdGVyKFwiZGF0YVNlcnZpY2VcIiwgd2ViQXBpT0RhdGE0Q3RvciBhcyBhbnkpO1xyXG5cclxuXHJcblxyXG5cclxuIl19