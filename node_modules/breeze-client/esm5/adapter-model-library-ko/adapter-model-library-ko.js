import * as breeze from 'breeze-client';
var core = breeze.core;
var canIsolateES5Props = core.isES5Supported;
var ko;
var ModelLibraryKnockoutAdapter = /** @class */ (function () {
    function ModelLibraryKnockoutAdapter() {
        this.name = "ko";
    }
    ModelLibraryKnockoutAdapter.register = function (config) {
        config = config || breeze.config;
        config.registerAdapter("modelLibrary", ModelLibraryKnockoutAdapter);
        return config.initializeAdapterInstance("modelLibrary", "ko", true);
    };
    ModelLibraryKnockoutAdapter.prototype.initialize = function () {
        ko = core.requireLib("ko;knockout", "The Knockout library");
        ko.extenders.intercept = function (target, interceptorOptions) {
            var instance = interceptorOptions.instance;
            var property = interceptorOptions.property;
            // create a computed observable to intercept writes to our observable
            var result;
            if (target.splice) {
                result = ko.computed({
                    read: target //always return the original observables value
                });
            }
            else {
                result = ko.computed({
                    read: target,
                    write: function (newValue) {
                        instance._$interceptor(property, newValue, target);
                        return instance;
                    }
                });
            }
            //return the new computed observable
            return result;
        };
    };
    ModelLibraryKnockoutAdapter.prototype.getTrackablePropertyNames = function (entity) {
        var names = [];
        for (var p in entity) {
            if (p === "entityType")
                continue;
            if (p === "_$typeName")
                continue;
            var propDescr = getES5PropDescriptor(entity, p);
            if (propDescr && propDescr.get) {
                names.push(p);
            }
            else {
                var val = entity[p];
                if (ko.isObservable(val)) {
                    names.push(p);
                }
                else if (!core.isFunction(val)) {
                    names.push(p);
                }
            }
        }
        return names;
    };
    ModelLibraryKnockoutAdapter.prototype.initializeEntityPrototype = function (proto) {
        proto.getProperty = function (propertyName) {
            return this[propertyName]();
        };
        proto.setProperty = function (propertyName, value) {
            this[propertyName](value);
            // allow set property chaining.
            return this;
        };
        if (canIsolateES5Props) {
            isolateES5Props(proto);
        }
    };
    ModelLibraryKnockoutAdapter.prototype.startTracking = function (entity, proto) {
        // create ko's for each property and assign defaultValues
        var stype = (entity.entityType || entity.complexType);
        var es5Descriptors = stype._extra.es5Descriptors || {};
        // sort unmapped properties to the end
        stype.getProperties().sort(function (p1, p2) {
            var v1 = p1.isUnmapped ? 1 : 0;
            var v2 = p2.isUnmapped ? 1 : 0;
            return v1 - v2;
        }).forEach(function (prop) {
            var propName = prop.name;
            var val = entity[propName];
            var propDescr = es5Descriptors[propName];
            var koObj;
            // check if property is an ES5 property
            if (propDescr) {
                var getFn_1 = propDescr.get.bind(entity);
                if (propDescr.set) {
                    var setFn_1 = propDescr.set.bind(entity);
                    var rawAccessorFn_1 = function (newValue) {
                        if (arguments.length === 0) {
                            getFn_1();
                            return;
                        }
                        else {
                            setFn_1(newValue);
                        }
                    };
                    koObj = ko.computed({
                        read: function () {
                            stype._koDummy();
                            return getFn_1();
                        },
                        write: function (newValue) {
                            entity._$interceptor(prop, newValue, rawAccessorFn_1);
                            stype._koDummy.valueHasMutated();
                            return entity;
                        }
                    });
                }
                else {
                    koObj = ko.computed({
                        read: getFn_1,
                        write: function () {
                        }
                    });
                }
                // check if property is already exposed as a ko object
            }
            else if (ko.isObservable(val)) {
                if (prop.isNavigationProperty) {
                    throw new Error("Cannot assign a navigation property in an entity ctor.: " + propName);
                }
                koObj = val;
                // otherwise
            }
            else {
                val = initializeValueForProp(entity, prop, val);
                koObj = prop.isScalar ? ko.observable(val) : ko.observableArray(val);
            }
            if (prop.isScalar) {
                if (propDescr) {
                    Object.defineProperty(entity, propName, {
                        enumerable: true,
                        configurable: true,
                        writable: true,
                        value: koObj
                    });
                }
                else {
                    var koExt = koObj.extend({ intercept: { instance: entity, property: prop } });
                    entity[propName] = koExt;
                }
            }
            else {
                val._koObj = koObj;
                // code to suppress extra breeze notification when
                // ko's array methods are called.
                koObj.subscribe(onBeforeChange, null, "beforeChange");
                // code to insure that any direct breeze changes notify ko
                val.arrayChanged.subscribe(onArrayChanged);
                koObj.equalityComparer = function () {
                    throw new Error("Collection navigation properties may NOT be set.");
                };
                entity[propName] = koObj;
            }
        });
    };
    return ModelLibraryKnockoutAdapter;
}());
export { ModelLibraryKnockoutAdapter };
breeze.config.registerAdapter("modelLibrary", ModelLibraryKnockoutAdapter);
// private fns
function getES5PropDescriptor(proto, propName) {
    if (!canIsolateES5Props) {
        return null;
    }
    if (proto.hasOwnProperty(propName)) {
        return Object.getOwnPropertyDescriptor && Object.getOwnPropertyDescriptor(proto, propName);
    }
    else {
        var nextProto = Object.getPrototypeOf(proto);
        return nextProto ? getES5PropDescriptor(nextProto, propName) : null;
    }
}
function initializeValueForProp(entity, prop, val) {
    if (prop instanceof breeze.DataProperty) {
        if (prop.isComplexProperty) {
            // TODO: right now we create Empty complexObjects here - these should actually come from the entity
            if (prop.isScalar) {
                val = prop.dataType._createInstanceCore(entity, prop);
            }
            else {
                val = breeze.makeComplexArray([], entity, prop);
            }
        }
        else if (!prop.isScalar) {
            val = breeze.makePrimitiveArray([], entity, prop);
        }
        else if (val === undefined) {
            val = prop.defaultValue;
        }
    }
    else if (prop instanceof breeze.NavigationProperty) {
        if (val !== undefined) {
            throw new Error("Cannot assign a navigation property in an entity ctor.: " + prop.name);
        }
        if (prop.isScalar) {
            // TODO: change this to nullEntity later.
            val = null;
        }
        else {
            val = breeze.makeRelationArray([], entity, prop);
        }
    }
    else {
        throw new Error("unknown property: " + prop.name);
    }
    return val;
}
function onBeforeChange(args) {
    args._koObj._suppressBreeze = true;
}
function onArrayChanged(args) {
    var koObj = args.array._koObj;
    if (koObj._suppressBreeze) {
        koObj._suppressBreeze = false;
    }
    else {
        koObj.valueHasMutated();
    }
}
function isolateES5Props(proto) {
    var stype = (proto.entityType || proto.complexType);
    var es5Descriptors = {};
    stype.getProperties().forEach(function (prop) {
        var propDescr = getES5PropDescriptor(proto, prop.name);
        if (propDescr) {
            es5Descriptors[prop.name] = propDescr;
        }
    });
    if (!core.isEmpty(es5Descriptors)) {
        var extra = stype._extra;
        extra.es5Descriptors = es5Descriptors;
        stype._koDummy = ko.observable(null);
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYWRhcHRlci1tb2RlbC1saWJyYXJ5LWtvLmpzIiwic291cmNlUm9vdCI6Im5nOi8vYnJlZXplLWNsaWVudC9hZGFwdGVyLW1vZGVsLWxpYnJhcnkta28vIiwic291cmNlcyI6WyJhZGFwdGVyLW1vZGVsLWxpYnJhcnkta28udHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxLQUFLLE1BQU0sTUFBTSxlQUFlLENBQUM7QUFFeEMsSUFBSSxJQUFJLEdBQUcsTUFBTSxDQUFDLElBQUksQ0FBQztBQUV2QixJQUFJLGtCQUFrQixHQUFHLElBQUksQ0FBQyxjQUFjLENBQUM7QUFDN0MsSUFBSSxFQUFPLENBQUM7QUFFWjtJQUVFO1FBQ0UsSUFBSSxDQUFDLElBQUksR0FBRyxJQUFJLENBQUM7SUFDbkIsQ0FBQztJQUVNLG9DQUFRLEdBQWYsVUFBZ0IsTUFBNEI7UUFDMUMsTUFBTSxHQUFHLE1BQU0sSUFBSSxNQUFNLENBQUMsTUFBTSxDQUFDO1FBQ2pDLE1BQU0sQ0FBQyxlQUFlLENBQUMsY0FBYyxFQUFFLDJCQUEyQixDQUFDLENBQUM7UUFDcEUsT0FBTyxNQUFNLENBQUMseUJBQXlCLENBQUMsY0FBYyxFQUFFLElBQUksRUFBRSxJQUFJLENBQWdDLENBQUM7SUFDckcsQ0FBQztJQUVELGdEQUFVLEdBQVY7UUFDRSxFQUFFLEdBQUcsSUFBSSxDQUFDLFVBQVUsQ0FBQyxhQUFhLEVBQUUsc0JBQXNCLENBQUMsQ0FBQztRQUM1RCxFQUFFLENBQUMsU0FBUyxDQUFDLFNBQVMsR0FBRyxVQUFVLE1BQVcsRUFBRSxrQkFBdUI7WUFDckUsSUFBSSxRQUFRLEdBQUcsa0JBQWtCLENBQUMsUUFBUSxDQUFDO1lBQzNDLElBQUksUUFBUSxHQUFHLGtCQUFrQixDQUFDLFFBQVEsQ0FBQztZQUUzQyxxRUFBcUU7WUFDckUsSUFBSSxNQUFXLENBQUM7WUFDaEIsSUFBSSxNQUFNLENBQUMsTUFBTSxFQUFFO2dCQUNqQixNQUFNLEdBQUcsRUFBRSxDQUFDLFFBQVEsQ0FB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R0FBRyxJQUFJLENBQUMsS0FBSyxDQUFDLE1BQU0sQ0FBQztJQUM5QixJQUFJLEtBQUssQ0FBQyxlQUFlLEVBQUU7UUFDekIsS0FBSyxDQUFDLGVBQWUsR0FBRyxLQUFLLENBQUM7S0FDL0I7U0FBTTtRQUNMLEtBQUssQ0FBQyxlQUFlLEVBQUUsQ0FBQztLQUN6QjtBQUNILENBQUM7QUFFRCxTQUFTLGVBQWUsQ0FBQyxLQUFVO0lBQ2pDLElBQUksS0FBSyxHQUFHLENBQUMsS0FBSyxDQUFDLFVBQVUsSUFBSSxLQUFLLENBQUMsV0FBVyxDQUEwQixDQUFDO0lBQzdFLElBQUksY0FBYyxHQUFHLEVBQUUsQ0FBQztJQUN4QixLQUFLLENBQUMsYUFBYSxFQUFFLENBQUMsT0FBTyxDQUFDLFVBQVUsSUFBSTtRQUMxQyxJQUFJLFNBQVMsR0FBRyxvQkFBb0IsQ0FBQyxLQUFLLEVBQUUsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDO1FBQ3ZELElBQUksU0FBUyxFQUFFO1lBQ2IsY0FBYyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsR0FBRyxTQUFTLENBQUM7U0FDdkM7SUFDSCxDQUFDLENBQUMsQ0FBQztJQUNILElBQUksQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLGNBQWMsQ0FBQyxFQUFFO1FBQ2pDLElBQUksS0FBSyxHQUFHLEtBQUssQ0FBQyxNQUFNLENBQUM7UUFDekIsS0FBSyxDQUFDLGNBQWMsR0FBRyxjQUFjLENBQUM7UUFDckMsS0FBYSxDQUFDLFFBQVEsR0FBRyxFQUFFLENBQUMsVUFBVSxDQUFDLElBQUksQ0FBQyxDQUFDO0tBQy9DO0FBQ0gsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCAqIGFzIGJyZWV6ZSBmcm9tICdicmVlemUtY2xpZW50JztcclxuXHJcbmxldCBjb3JlID0gYnJlZXplLmNvcmU7XHJcblxyXG5sZXQgY2FuSXNvbGF0ZUVTNVByb3BzID0gY29yZS5pc0VTNVN1cHBvcnRlZDtcclxubGV0IGtvOiBhbnk7XHJcblxyXG5leHBvcnQgY2xhc3MgTW9kZWxMaWJyYXJ5S25vY2tvdXRBZGFwdGVyIGltcGxlbWVudHMgYnJlZXplLk1vZGVsTGlicmFyeUFkYXB0ZXIge1xyXG4gIG5hbWU6IHN0cmluZztcclxuICBjb25zdHJ1Y3RvcigpIHtcclxuICAgIHRoaXMubmFtZSA9IFwia29cIjtcclxuICB9XHJcblxyXG4gIHN0YXRpYyByZWdpc3Rlcihjb25maWc/OiBicmVlemUuQnJlZXplQ29uZmlnKSB7XHJcbiAgICBjb25maWcgPSBjb25maWcgfHwgYnJlZXplLmNvbmZpZztcclxuICAgIGNvbmZpZy5yZWdpc3RlckFkYXB0ZXIoXCJtb2RlbExpYnJhcnlcIiwgTW9kZWxMaWJyYXJ5S25vY2tvdXRBZGFwdGVyKTtcclxuICAgIHJldHVybiBjb25maWcuaW5pdGlhbGl6ZUFkYXB0ZXJJbnN0YW5jZShcIm1vZGVsTGlicmFyeVwiLCBcImtvXCIsIHRydWUpIGFzIE1vZGVsTGlicmFyeUtub2Nrb3V0QWRhcHRlcjtcclxuICB9XHJcblxyXG4gIGluaXRpYWxpemUoKSB7XHJcbiAgICBrbyA9IGNvcmUucmVxdWlyZUxpYihcImtvO2tub2Nrb3V0XCIsIFwiVGhlIEtub2Nrb3V0IGxpYnJhcnlcIik7XHJcbiAgICBrby5leHRlbmRlcnMuaW50ZXJjZXB0ID0gZnVuY3Rpb24gKHRhcmdldDogYW55LCBpbnRlcmNlcHRvck9wdGlvbnM6IGFueSkge1xyXG4gICAgICBsZXQgaW5zdGFuY2UgPSBpbnRlcmNlcHRvck9wdGlvbnMuaW5zdGFuY2U7XHJcbiAgICAgIGxldCBwcm9wZXJ0eSA9IGludGVyY2VwdG9yT3B0aW9ucy5wcm9wZXJ0eTtcclxuXHJcbiAgICAgIC8vIGNyZWF0ZSBhIGNvbXB1dGVkIG9ic2VydmFibGUgdG8gaW50ZXJjZXB0IHdyaXRlcyB0byBvdXIgb2JzZXJ2YWJsZVxyXG4gICAgICBsZXQgcmVzdWx0OiBhbnk7XHJcbiAgICAgIGlmICh0YXJnZXQuc3BsaWNlKSB7XHJcbiAgICAgICAgcmVzdWx0ID0ga28uY29tcHV0ZWQoe1xyXG4gICAgICAgICAgcmVhZDogdGFyZ2V0ICAvL2Fsd2F5cyByZXR1cm4gdGhlIG9yaWdpbmFsIG9ic2VydmFibGVzIHZhbHVlXHJcbiAgICAgICAgfSk7XHJcbiAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgcmVzdWx0ID0ga28uY29tcHV0ZWQoe1xyXG4gICAgICAgICAgcmVhZDogdGFyZ2V0LCAgLy9hbHdheXMgcmV0dXJuIHRoZSBvcmlnaW5hbCBvYnNlcnZhYmxlcyB2YWx1ZVxyXG4gICAgICAgICAgd3JpdGU6IGZ1bmN0aW9uIChuZXdWYWx1ZTogYW55KSB7XHJcbiAgICAgICAgICAgIGluc3RhbmNlLl8kaW50ZXJjZXB0b3IocHJvcGVydHksIG5ld1ZhbHVlLCB0YXJnZXQpO1xyXG4gICAgICAgICAgICByZXR1cm4gaW5zdGFuY2U7XHJcbiAgICAgICAgICB9XHJcbiAgICAgICAgfSk7XHJcbiAgICAgIH1cclxuICAgICAgLy9yZXR1cm4gdGhlIG5ldyBjb21wdXRlZCBvYnNlcnZhYmxlXHJcbiAgICAgIHJldHVybiByZXN1bHQ7XHJcbiAgICB9O1xyXG5cclxuICB9XHJcblxyXG4gIGdldFRyYWNrYWJsZVByb3BlcnR5TmFtZXMoZW50aXR5OiBhbnkpIHtcclxuICAgIGxldCBuYW1lczogc3RyaW5nW10gPSBbXTtcclxuICAgIGZvciAobGV0IHAgaW4gZW50aXR5KSB7XHJcbiAgICAgIGlmIChwID09PSBcImVudGl0eVR5cGVcIikgY29udGludWU7XHJcbiAgICAgIGlmIChwID09PSBcIl8kdHlwZU5hbWVcIikgY29udGludWU7XHJcblxyXG4gICAgICBsZXQgcHJvcERlc2NyID0gZ2V0RVM1UHJvcERlc2NyaXB0b3IoZW50aXR5LCBwKTtcclxuICAgICAgaWYgKHByb3BEZXNjciAmJiBwcm9wRGVzY3IuZ2V0KSB7XHJcbiAgICAgICAgbmFtZXMucHVzaChwKTtcclxuICAgICAgfSBlbHNlIHtcclxuICAgICAgICBsZXQgdmFsID0gZW50aXR5W3BdO1xyXG4gICAgICAgIGlmIChrby5pc09ic2VydmFibGUodmFsKSkge1xyXG4gICAgICAgICAgbmFtZXMucHVzaChwKTtcclxuICAgICAgICB9IGVsc2UgaWYgKCFjb3JlLmlzRnVuY3Rpb24odmFsKSkge1xyXG4gICAgICAgICAgbmFtZXMucHVzaChwKTtcclxuICAgICAgICB9XHJcbiAgICAgIH1cclxuICAgIH1cclxuICAgIHJldHVybiBuYW1lcztcclxuICB9XHJcblxyXG4gIGluaXRpYWxpemVFbnRpdHlQcm90b3R5cGUocHJvdG86IGFueSkge1xyXG5cclxuICAgIHByb3RvLmdldFByb3BlcnR5ID0gZnVuY3Rpb24gKHByb3BlcnR5TmFtZTogc3RyaW5nKSB7XHJcbiAgICAgIHJldHVybiB0aGlzW3Byb3BlcnR5TmFtZV0oKTtcclxuICAgIH07XHJcblxyXG4gICAgcHJvdG8uc2V0UHJvcGVydHkgPSBmdW5jdGlvbiAocHJvcGVydHlOYW1lOiBzdHJpbmcsIHZhbHVlOiBhbnkpIHtcclxuICAgICAgdGhpc1twcm9wZXJ0eU5hbWVdKHZhbHVlKTtcclxuICAgICAgLy8gYWxsb3cgc2V0IHByb3BlcnR5IGNoYWluaW5nLlxyXG4gICAgICByZXR1cm4gdGhpcztcclxuICAgIH07XHJcblxyXG4gICAgaWYgKGNhbklzb2xhdGVFUzVQcm9wcykge1xyXG4gICAgICBpc29sYXRlRVM1UHJvcHMocHJvdG8pO1xyXG4gICAgfVxyXG5cclxuICB9XHJcblxyXG4gIHN0YXJ0VHJhY2tpbmcoZW50aXR5OiBhbnksIHByb3RvOiBhbnkpIHtcclxuICAgIC8vIGNyZWF0ZSBrbydzIGZvciBlYWNoIHByb3BlcnR5IGFuZCBhc3NpZ24gZGVmYXVsdFZhbHVlc1xyXG5cclxuICAgIGxldCBzdHlwZSA9IChlbnRpdHkuZW50aXR5VHlwZSB8fCBlbnRpdHkuY29tcGxleFR5cGUpIGFzIGJyZWV6ZS5TdHJ1Y3R1cmFsVHlwZTtcclxuICAgIGxldCBlczVEZXNjcmlwdG9ycyA9IHN0eXBlLl9leHRyYS5lczVEZXNjcmlwdG9ycyB8fCB7fTtcclxuXHJcbiAgICAvLyBzb3J0IHVubWFwcGVkIHByb3BlcnRpZXMgdG8gdGhlIGVuZFxyXG4gICAgc3R5cGUuZ2V0UHJvcGVydGllcygpLnNvcnQoZnVuY3Rpb24gKHAxLCBwMikge1xyXG4gICAgICBsZXQgdjEgPSBwMS5pc1VubWFwcGVkID8gMSA6IDA7XHJcbiAgICAgIGxldCB2MiA9IHAyLmlzVW5tYXBwZWQgPyAxIDogMDtcclxuICAgICAgcmV0dXJuIHYxIC0gdjI7XHJcbiAgICB9KS5mb3JFYWNoKGZ1bmN0aW9uIChwcm9wKSB7XHJcbiAgICAgIGxldCBwcm9wTmFtZSA9IHByb3AubmFtZTtcclxuICAgICAgbGV0IHZhbCA9IGVudGl0eVtwcm9wTmFtZV07XHJcbiAgICAgIGxldCBwcm9wRGVzY3IgPSBlczVEZXNjcmlwdG9yc1twcm9wTmFtZV07XHJcbiAgICAgIGxldCBrb09iajogYW55O1xyXG5cclxuICAgICAgLy8gY2hlY2sgaWYgcHJvcGVydHkgaXMgYW4gRVM1IHByb3BlcnR5XHJcbiAgICAgIGlmIChwcm9wRGVzY3IpIHtcclxuICAgICAgICBsZXQgZ2V0Rm4gPSBwcm9wRGVzY3IuZ2V0LmJpbmQoZW50aXR5KTtcclxuICAgICAgICBpZiAocHJvcERlc2NyLnNldCkge1xyXG4gICAgICAgICAgbGV0IHNldEZuID0gcHJvcERlc2NyLnNldC5iaW5kKGVudGl0eSk7XHJcbiAgICAgICAgICBsZXQgcmF3QWNjZXNzb3JGbiA9IGZ1bmN0aW9uIChuZXdWYWx1ZTogYW55KSB7XHJcbiAgICAgICAgICAgIGlmIChhcmd1bWVudHMubGVuZ3RoID09PSAwKSB7XHJcbiAgICAgICAgICAgICAgZ2V0Rm4oKTtcclxuICAgICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgc2V0Rm4obmV3VmFsdWUpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICB9O1xyXG4gICAgICAgICAga29PYmogPSBrby5jb21wdXRlZCh7XHJcbiAgICAgICAgICAgIHJlYWQ6IGZ1bmN0aW9uICgpIHtcclxuICAgICAgICAgICAgICAoc3R5cGUgYXMgYW55KS5fa29EdW1teSgpO1xyXG4gICAgICAgICAgICAgIHJldHVybiBnZXRGbigpO1xyXG4gICAgICAgICAgICB9LFxyXG4gICAgICAgICAgICB3cml0ZTogZnVuY3Rpb24gKG5ld1ZhbHVlOiBhbnkpIHtcclxuICAgICAgICAgICAgICBlbnRpdHkuXyRpbnRlcmNlcHRvcihwcm9wLCBuZXdWYWx1ZSwgcmF3QWNjZXNzb3JGbik7XHJcbiAgICAgICAgICAgICAgKHN0eXBlIGFzIGFueSkuX2tvRHVtbXkudmFsdWVIYXNNdXRhdGVkKCk7XHJcbiAgICAgICAgICAgICAgcmV0dXJuIGVudGl0eTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgfSk7XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgIGtvT2JqID0ga28uY29tcHV0ZWQoe1xyXG4gICAgICAgICAgICByZWFkOiBnZXRGbixcclxuICAgICAgICAgICAgd3JpdGU6IGZ1bmN0aW9uICgpIHtcclxuICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgIH0pO1xyXG4gICAgICAgIH1cclxuICAgICAgICAvLyBjaGVjayBpZiBwcm9wZXJ0eSBpcyBhbHJlYWR5IGV4cG9zZWQgYXMgYSBrbyBvYmplY3RcclxuICAgICAgfSBlbHNlIGlmIChrby5pc09ic2VydmFibGUodmFsKSkge1xyXG4gICAgICAgIGlmIChwcm9wLmlzTmF2aWdhdGlvblByb3BlcnR5KSB7XHJcbiAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoXCJDYW5ub3QgYXNzaWduIGEgbmF2aWdhdGlvbiBwcm9wZXJ0eSBpbiBhbiBlbnRpdHkgY3Rvci46IFwiICsgcHJvcE5hbWUpO1xyXG4gICAgICAgIH1cclxuICAgICAgICBrb09iaiA9IHZhbDtcclxuICAgICAgICAvLyBvdGhlcndpc2VcclxuICAgICAgfSBlbHNlIHtcclxuICAgICAgICB2YWwgPSBpbml0aWFsaXplVmFsdWVGb3JQcm9wKGVudGl0eSwgcHJvcCwgdmFsKTtcclxuICAgICAgICBrb09iaiA9IHByb3AuaXNTY2FsYXIgPyBrby5vYnNlcnZhYmxlKHZhbCkgOiBrby5vYnNlcnZhYmxlQXJyYXkodmFsKTtcclxuICAgICAgfVxyXG5cclxuXHJcbiAgICAgIGlmIChwcm9wLmlzU2NhbGFyKSB7XHJcbiAgICAgICAgaWYgKHByb3BEZXNjcikge1xyXG4gICAgICAgICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGVudGl0eSwgcHJvcE5hbWUsIHtcclxuICAgICAgICAgICAgZW51bWVyYWJsZTogdHJ1ZSxcclxuICAgICAgICAgICAgY29uZmlndXJhYmxlOiB0cnVlLFxyXG4gICAgICAgICAgICB3cml0YWJsZTogdHJ1ZSxcclxuICAgICAgICAgICAgdmFsdWU6IGtvT2JqXHJcbiAgICAgICAgICB9KTtcclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgbGV0IGtvRXh0ID0ga29PYmouZXh0ZW5kKHsgaW50ZXJjZXB0OiB7IGluc3RhbmNlOiBlbnRpdHksIHByb3BlcnR5OiBwcm9wIH0gfSk7XHJcbiAgICAgICAgICBlbnRpdHlbcHJvcE5hbWVdID0ga29FeHQ7XHJcbiAgICAgICAgfVxyXG4gICAgICB9IGVsc2Uge1xyXG4gICAgICAgIHZhbC5fa29PYmogPSBrb09iajtcclxuICAgICAgICAvLyBjb2RlIHRvIHN1cHByZXNzIGV4dHJhIGJyZWV6ZSBub3RpZmljYXRpb24gd2hlblxyXG4gICAgICAgIC8vIGtvJ3MgYXJyYXkgbWV0aG9kcyBhcmUgY2FsbGVkLlxyXG4gICAgICAgIGtvT2JqLnN1YnNjcmliZShvbkJlZm9yZUNoYW5nZSwgbnVsbCwgXCJiZWZvcmVDaGFuZ2VcIik7XHJcbiAgICAgICAgLy8gY29kZSB0byBpbnN1cmUgdGhhdCBhbnkgZGlyZWN0IGJyZWV6ZSBjaGFuZ2VzIG5vdGlmeSBrb1xyXG4gICAgICAgIHZhbC5hcnJheUNoYW5nZWQuc3Vic2NyaWJlKG9uQXJyYXlDaGFuZ2VkKTtcclxuXHJcbiAgICAgICAga29PYmouZXF1YWxpdHlDb21wYXJlciA9IGZ1bmN0aW9uICgpIHtcclxuICAgICAgICAgIHRocm93IG5ldyBFcnJvcihcIkNvbGxlY3Rpb24gbmF2aWdhdGlvbiBwcm9wZXJ0aWVzIG1heSBOT1QgYmUgc2V0LlwiKTtcclxuICAgICAgICB9O1xyXG4gICAgICAgIGVudGl0eVtwcm9wTmFtZV0gPSBrb09iajtcclxuICAgICAgfVxyXG5cclxuICAgIH0pO1xyXG5cclxuICB9XHJcbn1cclxuXHJcbmJyZWV6ZS5jb25maWcucmVnaXN0ZXJBZGFwdGVyKFwibW9kZWxMaWJyYXJ5XCIsIE1vZGVsTGlicmFyeUtub2Nrb3V0QWRhcHRlcik7XHJcblxyXG5cclxuLy8gcHJpdmF0ZSBmbnNcclxuXHJcbmZ1bmN0aW9uIGdldEVTNVByb3BEZXNjcmlwdG9yKHByb3RvOiBhbnksIHByb3BOYW1lOiBzdHJpbmcpOiBhbnkge1xyXG4gIGlmICghY2FuSXNvbGF0ZUVTNVByb3BzKSB7XHJcbiAgICByZXR1cm4gbnVsbDtcclxuICB9XHJcbiAgaWYgKHByb3RvLmhhc093blByb3BlcnR5KHByb3BOYW1lKSkge1xyXG4gICAgcmV0dXJuIE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3IgJiYgT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcihwcm90bywgcHJvcE5hbWUpO1xyXG4gIH0gZWxzZSB7XHJcbiAgICBsZXQgbmV4dFByb3RvID0gT2JqZWN0LmdldFByb3RvdHlwZU9mKHByb3RvKTtcclxuICAgIHJldHVybiBuZXh0UHJvdG8gPyBnZXRFUzVQcm9wRGVzY3JpcHRvcihuZXh0UHJvdG8sIHByb3BOYW1lKSA6IG51bGw7XHJcbiAgfVxyXG59XHJcblxyXG5mdW5jdGlvbiBpbml0aWFsaXplVmFsdWVGb3JQcm9wKGVudGl0eTogYW55LCBwcm9wOiBicmVlemUuRW50aXR5UHJvcGVydHksIHZhbDogYW55KSB7XHJcbiAgaWYgKHByb3AgaW5zdGFuY2VvZiBicmVlemUuRGF0YVByb3BlcnR5KSB7XHJcbiAgICBpZiAocHJvcC5pc0NvbXBsZXhQcm9wZXJ0eSkge1xyXG4gICAgICAvLyBUT0RPOiByaWdodCBub3cgd2UgY3JlYXRlIEVtcHR5IGNvbXBsZXhPYmplY3RzIGhlcmUgLSB0aGVzZSBzaG91bGQgYWN0dWFsbHkgY29tZSBmcm9tIHRoZSBlbnRpdHlcclxuICAgICAgaWYgKHByb3AuaXNTY2FsYXIpIHtcclxuICAgICAgICB2YWwgPSAocHJvcC5kYXRhVHlwZSBhcyBicmVlemUuQ29tcGxleFR5cGUpLl9jcmVhdGVJbnN0YW5jZUNvcmUoZW50aXR5LCBwcm9wKTtcclxuICAgICAgfSBlbHNlIHtcclxuICAgICAgICB2YWwgPSBicmVlemUubWFrZUNvbXBsZXhBcnJheShbXSwgZW50aXR5LCBwcm9wKTtcclxuICAgICAgfVxyXG4gICAgfSBlbHNlIGlmICghcHJvcC5pc1NjYWxhcikge1xyXG4gICAgICB2YWwgPSBicmVlemUubWFrZVByaW1pdGl2ZUFycmF5KFtdLCBlbnRpdHksIHByb3ApO1xyXG4gICAgfSBlbHNlIGlmICh2YWwgPT09IHVuZGVmaW5lZCkge1xyXG4gICAgICB2YWwgPSBwcm9wLmRlZmF1bHRWYWx1ZTtcclxuICAgIH1cclxuXHJcbiAgfSBlbHNlIGlmIChwcm9wIGluc3RhbmNlb2YgYnJlZXplLk5hdmlnYXRpb25Qcm9wZXJ0eSkge1xyXG4gICAgaWYgKHZhbCAhPT0gdW5kZWZpbmVkKSB7XHJcbiAgICAgIHRocm93IG5ldyBFcnJvcihcIkNhbm5vdCBhc3NpZ24gYSBuYXZpZ2F0aW9uIHByb3BlcnR5IGluIGFuIGVudGl0eSBjdG9yLjogXCIgKyBwcm9wLm5hbWUpO1xyXG4gICAgfVxyXG4gICAgaWYgKHByb3AuaXNTY2FsYXIpIHtcclxuICAgICAgLy8gVE9ETzogY2hhbmdlIHRoaXMgdG8gbnVsbEVudGl0eSBsYXRlci5cclxuICAgICAgdmFsID0gbnVsbDtcclxuICAgIH0gZWxzZSB7XHJcbiAgICAgIHZhbCA9IGJyZWV6ZS5tYWtlUmVsYXRpb25BcnJheShbXSwgZW50aXR5LCBwcm9wKTtcclxuICAgIH1cclxuICB9IGVsc2Uge1xyXG4gICAgdGhyb3cgbmV3IEVycm9yKFwidW5rbm93biBwcm9wZXJ0eTogXCIgKyAocHJvcCBhcyBhbnkpLm5hbWUpO1xyXG4gIH1cclxuICByZXR1cm4gdmFsO1xyXG59XHJcblxyXG5cclxuZnVuY3Rpb24gb25CZWZvcmVDaGFuZ2UoYXJnczogYW55KSB7XHJcbiAgYXJncy5fa29PYmouX3N1cHByZXNzQnJlZXplID0gdHJ1ZTtcclxufVxyXG5cclxuZnVuY3Rpb24gb25BcnJheUNoYW5nZWQoYXJnczogYW55KSB7XHJcbiAgbGV0IGtvT2JqID0gYXJncy5hcnJheS5fa29PYmo7XHJcbiAgaWYgKGtvT2JqLl9zdXBwcmVzc0JyZWV6ZSkge1xyXG4gICAga29PYmouX3N1cHByZXNzQnJlZXplID0gZmFsc2U7XHJcbiAgfSBlbHNlIHtcclxuICAgIGtvT2JqLnZhbHVlSGFzTXV0YXRlZCgpO1xyXG4gIH1cclxufVxyXG5cclxuZnVuY3Rpb24gaXNvbGF0ZUVTNVByb3BzKHByb3RvOiBhbnkpIHtcclxuICBsZXQgc3R5cGUgPSAocHJvdG8uZW50aXR5VHlwZSB8fCBwcm90by5jb21wbGV4VHlwZSkgYXMgYnJlZXplLlN0cnVjdHVyYWxUeXBlO1xyXG4gIGxldCBlczVEZXNjcmlwdG9ycyA9IHt9O1xyXG4gIHN0eXBlLmdldFByb3BlcnRpZXMoKS5mb3JFYWNoKGZ1bmN0aW9uIChwcm9wKSB7XHJcbiAgICBsZXQgcHJvcERlc2NyID0gZ2V0RVM1UHJvcERlc2NyaXB0b3IocHJvdG8sIHByb3AubmFtZSk7XHJcbiAgICBpZiAocHJvcERlc2NyKSB7XHJcbiAgICAgIGVzNURlc2NyaXB0b3JzW3Byb3AubmFtZV0gPSBwcm9wRGVzY3I7XHJcbiAgICB9XHJcbiAgfSk7XHJcbiAgaWYgKCFjb3JlLmlzRW1wdHkoZXM1RGVzY3JpcHRvcnMpKSB7XHJcbiAgICBsZXQgZXh0cmEgPSBzdHlwZS5fZXh0cmE7XHJcbiAgICBleHRyYS5lczVEZXNjcmlwdG9ycyA9IGVzNURlc2NyaXB0b3JzO1xyXG4gICAgKHN0eXBlIGFzIGFueSkuX2tvRHVtbXkgPSBrby5vYnNlcnZhYmxlKG51bGwpO1xyXG4gIH1cclxufVxyXG5cclxuIl19