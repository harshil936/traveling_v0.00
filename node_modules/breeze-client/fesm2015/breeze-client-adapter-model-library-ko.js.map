{"version":3,"file":"breeze-client-adapter-model-library-ko.js","sources":["ng://breeze-client/adapter-model-library-ko/adapter-model-library-ko.ts","ng://breeze-client/adapter-model-library-ko/breeze-client-adapter-model-library-ko.ts"],"sourcesContent":["import * as breeze from 'breeze-client';\r\n\r\nlet core = breeze.core;\r\n\r\nlet canIsolateES5Props = core.isES5Supported;\r\nlet ko: any;\r\n\r\nexport class ModelLibraryKnockoutAdapter implements breeze.ModelLibraryAdapter {\r\n  name: string;\r\n  constructor() {\r\n    this.name = \"ko\";\r\n  }\r\n\r\n  static register(config?: breeze.BreezeConfig) {\r\n    config = config || breeze.config;\r\n    config.registerAdapter(\"modelLibrary\", ModelLibraryKnockoutAdapter);\r\n    return config.initializeAdapterInstance(\"modelLibrary\", \"ko\", true) as ModelLibraryKnockoutAdapter;\r\n  }\r\n\r\n  initialize() {\r\n    ko = core.requireLib(\"ko;knockout\", \"The Knockout library\");\r\n    ko.extenders.intercept = function (target: any, interceptorOptions: any) {\r\n      let instance = interceptorOptions.instance;\r\n      let property = interceptorOptions.property;\r\n\r\n      // create a computed observable to intercept writes to our observable\r\n      let result: any;\r\n      if (target.splice) {\r\n        result = ko.computed({\r\n          read: target  //always return the original observables value\r\n        });\r\n      } else {\r\n        result = ko.computed({\r\n          read: target,  //always return the original observables value\r\n          write: function (newValue: any) {\r\n            instance._$interceptor(property, newValue, target);\r\n            return instance;\r\n          }\r\n        });\r\n      }\r\n      //return the new computed observable\r\n      return result;\r\n    };\r\n\r\n  }\r\n\r\n  getTrackablePropertyNames(entity: any) {\r\n    let names: string[] = [];\r\n    for (let p in entity) {\r\n      if (p === \"entityType\") continue;\r\n      if (p === \"_$typeName\") continue;\r\n\r\n      let propDescr = getES5PropDescriptor(entity, p);\r\n      if (propDescr && propDescr.get) {\r\n        names.push(p);\r\n      } else {\r\n        let val = entity[p];\r\n        if (ko.isObservable(val)) {\r\n          names.push(p);\r\n        } else if (!core.isFunction(val)) {\r\n          names.push(p);\r\n        }\r\n      }\r\n    }\r\n    return names;\r\n  }\r\n\r\n  initializeEntityPrototype(proto: any) {\r\n\r\n    proto.getProperty = function (propertyName: string) {\r\n      return this[propertyName]();\r\n    };\r\n\r\n    proto.setProperty = function (propertyName: string, value: any) {\r\n      this[propertyName](value);\r\n      // allow set property chaining.\r\n      return this;\r\n    };\r\n\r\n    if (canIsolateES5Props) {\r\n      isolateES5Props(proto);\r\n    }\r\n\r\n  }\r\n\r\n  startTracking(entity: any, proto: any) {\r\n    // create ko's for each property and assign defaultValues\r\n\r\n    let stype = (entity.entityType || entity.complexType) as breeze.StructuralType;\r\n    let es5Descriptors = stype._extra.es5Descriptors || {};\r\n\r\n    // sort unmapped properties to the end\r\n    stype.getProperties().sort(function (p1, p2) {\r\n      let v1 = p1.isUnmapped ? 1 : 0;\r\n      let v2 = p2.isUnmapped ? 1 : 0;\r\n      return v1 - v2;\r\n    }).forEach(function (prop) {\r\n      let propName = prop.name;\r\n      let val = entity[propName];\r\n      let propDescr = es5Descriptors[propName];\r\n      let koObj: any;\r\n\r\n      // check if property is an ES5 property\r\n      if (propDescr) {\r\n        let getFn = propDescr.get.bind(entity);\r\n        if (propDescr.set) {\r\n          let setFn = propDescr.set.bind(entity);\r\n          let rawAccessorFn = function (newValue: any) {\r\n            if (arguments.length === 0) {\r\n              getFn();\r\n              return;\r\n            } else {\r\n              setFn(newValue);\r\n            }\r\n          };\r\n          koObj = ko.computed({\r\n            read: function () {\r\n              (stype as any)._koDummy();\r\n              return getFn();\r\n            },\r\n            write: function (newValue: any) {\r\n              entity._$interceptor(prop, newValue, rawAccessorFn);\r\n              (stype as any)._koDummy.valueHasMutated();\r\n              return entity;\r\n            }\r\n          });\r\n        } else {\r\n          koObj = ko.computed({\r\n            read: getFn,\r\n            write: function () {\r\n            }\r\n\r\n          });\r\n        }\r\n        // check if property is already exposed as a ko object\r\n      } else if (ko.isObservable(val)) {\r\n        if (prop.isNavigationProperty) {\r\n          throw new Error(\"Cannot assign a navigation property in an entity ctor.: \" + propName);\r\n        }\r\n        koObj = val;\r\n        // otherwise\r\n      } else {\r\n        val = initializeValueForProp(entity, prop, val);\r\n        koObj = prop.isScalar ? ko.observable(val) : ko.observableArray(val);\r\n      }\r\n\r\n\r\n      if (prop.isScalar) {\r\n        if (propDescr) {\r\n          Object.defineProperty(entity, propName, {\r\n            enumerable: true,\r\n            configurable: true,\r\n            writable: true,\r\n            value: koObj\r\n          });\r\n        } else {\r\n          let koExt = koObj.extend({ intercept: { instance: entity, property: prop } });\r\n          entity[propName] = koExt;\r\n        }\r\n      } else {\r\n        val._koObj = koObj;\r\n        // code to suppress extra breeze notification when\r\n        // ko's array methods are called.\r\n        koObj.subscribe(onBeforeChange, null, \"beforeChange\");\r\n        // code to insure that any direct breeze changes notify ko\r\n        val.arrayChanged.subscribe(onArrayChanged);\r\n\r\n        koObj.equalityComparer = function () {\r\n          throw new Error(\"Collection navigation properties may NOT be set.\");\r\n        };\r\n        entity[propName] = koObj;\r\n      }\r\n\r\n    });\r\n\r\n  }\r\n}\r\n\r\nbreeze.config.registerAdapter(\"modelLibrary\", ModelLibraryKnockoutAdapter);\r\n\r\n\r\n// private fns\r\n\r\nfunction getES5PropDescriptor(proto: any, propName: string): any {\r\n  if (!canIsolateES5Props) {\r\n    return null;\r\n  }\r\n  if (proto.hasOwnProperty(propName)) {\r\n    return Object.getOwnPropertyDescriptor && Object.getOwnPropertyDescriptor(proto, propName);\r\n  } else {\r\n    let nextProto = Object.getPrototypeOf(proto);\r\n    return nextProto ? getES5PropDescriptor(nextProto, propName) : null;\r\n  }\r\n}\r\n\r\nfunction initializeValueForProp(entity: any, prop: breeze.EntityProperty, val: any) {\r\n  if (prop instanceof breeze.DataProperty) {\r\n    if (prop.isComplexProperty) {\r\n      // TODO: right now we create Empty complexObjects here - these should actually come from the entity\r\n      if (prop.isScalar) {\r\n        val = (prop.dataType as breeze.ComplexType)._createInstanceCore(entity, prop);\r\n      } else {\r\n        val = breeze.makeComplexArray([], entity, prop);\r\n      }\r\n    } else if (!prop.isScalar) {\r\n      val = breeze.makePrimitiveArray([], entity, prop);\r\n    } else if (val === undefined) {\r\n      val = prop.defaultValue;\r\n    }\r\n\r\n  } else if (prop instanceof breeze.NavigationProperty) {\r\n    if (val !== undefined) {\r\n      throw new Error(\"Cannot assign a navigation property in an entity ctor.: \" + prop.name);\r\n    }\r\n    if (prop.isScalar) {\r\n      // TODO: change this to nullEntity later.\r\n      val = null;\r\n    } else {\r\n      val = breeze.makeRelationArray([], entity, prop);\r\n    }\r\n  } else {\r\n    throw new Error(\"unknown property: \" + (prop as any).name);\r\n  }\r\n  return val;\r\n}\r\n\r\n\r\nfunction onBeforeChange(args: any) {\r\n  args._koObj._suppressBreeze = true;\r\n}\r\n\r\nfunction onArrayChanged(args: any) {\r\n  let koObj = args.array._koObj;\r\n  if (koObj._suppressBreeze) {\r\n    koObj._suppressBreeze = false;\r\n  } else {\r\n    koObj.valueHasMutated();\r\n  }\r\n}\r\n\r\nfunction isolateES5Props(proto: any) {\r\n  let stype = (proto.entityType || proto.complexType) as breeze.StructuralType;\r\n  let es5Descriptors = {};\r\n  stype.getProperties().forEach(function (prop) {\r\n    let propDescr = getES5PropDescriptor(proto, prop.name);\r\n    if (propDescr) {\r\n      es5Descriptors[prop.name] = propDescr;\r\n    }\r\n  });\r\n  if (!core.isEmpty(es5Descriptors)) {\r\n    let extra = stype._extra;\r\n    extra.es5Descriptors = es5Descriptors;\r\n    (stype as any)._koDummy = ko.observable(null);\r\n  }\r\n}\r\n\r\n","/**\n * Generated bundle index. Do not edit.\n */\n\nexport * from './adapter-model-library-ko';\n"],"names":["breeze.core","config","breeze.config","breeze.DataProperty","breeze.makeComplexArray","breeze.makePrimitiveArray","breeze.NavigationProperty","breeze.makeRelationArray"],"mappings":"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"}